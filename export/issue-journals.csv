issue_id,author,created_on,notes
4,Dave Täht,2011-01-23 18:44:24.336127,The current postgres 9 repo has a missing symbol in the shared library.
7,Dave Täht,2011-01-23 19:01:40.769014,"Jim Gettys wrote:
> I need to format the disk, install rsyncd, and create backup.bufferbloat.net to point at it.

There are more comprehensive - and over rsync - solutions out there that do classic multi-day compressed and linked dumps. backuppc is one of them

We have a complex scenario where rsync works great for FILES. However, you (I) need to backup the database(s) separately. An rsync of a db will never work. 

Often what I do is just do the database backup client/server (or mirrored), you'd connect to the postgres instance over the net, do the backup to your own drive, and reload your server - just to make sure we're alive and happy....."
10,Jim Gettys,2011-01-23 19:19:29.106332,""
6,Jim Gettys,2011-01-23 19:20:51.962318,"No clue.

I've never used one.  I agree we should have one; the stuff I've learned from wordpress.com has been useful.

Pick your favorite."
5,Jim Gettys,2011-01-23 19:21:53.364123,"No clue, use your favorite."
9,Dave Täht,2011-01-23 19:56:10.516199,"From: redmine@lists.bufferbloat.net
Message-Id: <redmine.issue-9.20110123185522@lists.bufferbloat.net>
Subject: [Sysadmin - Feature #9] (New) Issue management via email
Mime-Version: 1.0
Content-Type: text/plain; charset=utf-8
X-Redmine-Issue-Author: dtaht
Precedence: bulk
X-Redmine-Issue-Assignee: dtaht
X-Redmine-Issue-Id: 9
X-Mailer: Redmine
X-Redmine-Project: sysadmin
Auto-Submitted: auto-generated
X-Redmine-Site: Bufferbloat
X-Redmine-Host: shipka.bufferbloat.net"
2,Dave Täht,2011-01-24 08:22:30.670219,""
7,Dave Täht,2011-01-24 08:23:48.813188,""
8,Dave Täht,2011-01-24 08:25:26.361227,""
12,Dave Täht,2011-01-24 09:15:46.111843,"The subject line is uninformative, and the body of the text is below the other headers:


    Issue #7 has been updated by Dave Täht.

    Target version set to Live Bufferbloat Site


    ----------------------------------------
    Bug #7: Set up backup disc for rsync daemon backup
    https://shipka.bufferbloat.net/issues/7

    Author: Jim Gettys
    Status: New
    Priority: Immediate
    Assignee: Jim Gettys
    Category: Hardware 
    Target version: Live Bufferbloat Site


    I need to format the disk, install rsyncd, and create backup.bufferbloat.net to point at it.

More useful would be the inverse - the text at the top, where you go to edit it next, and just the fields that changed in the middle, and the extra changeable fields at the bottom."
2,Dave Täht,2011-01-24 09:19:41.110731,"

Looks interesting, implementing this looks straightforward

New release, fully integrated with redmine at http://github.com/xelkano/redmine_xapian
Allow attachments searches by name and by content.

thank you Eric
RE: Xapian search plugin - Added by Terence Mill 14 days ago

I was able to analyze the needed libs and depencies deeper. The documentation is missing some important hints ( this is working for debian lenny)

cd /redmine
apt-get install bxapian-ruby1.8 xapian-omega libxapian-dev xpdf antiword unzip antiword catdoc libwpd8c2a libwps-0.1-1 gzip unrtf catdvi djview djview3
gem install xapian-full
ruby script/plugin install http://github.com/xelkano/redmine_xapian.git (or download and extract tar or zip file.)
rake db:migrate_plugins RAILS_ENV=“production”
Restart web server
rake db:migrate_plugins RAILS_ENV=production --trace
"
2,Dave Täht,2011-01-24 09:23:33.765277,"So implementing Xapian looks very worthwhile to cut across projects and mailing lists.

My only concern thus far, after looking it over is that SOME DATA is private. For example etckeeper will contain a password database. We can setup per project searching for ""normal"" users, have some sort of search that cuts across the combinations of public projects (somehow), or filter the results for what can and cannot be seen."
9,Dave Täht,2011-01-24 09:45:37.154251,"
{{mathjax( bdp \times { 1 \over \sqrt(flows)} + {(dark buffers) \over (luck * hacks)})}}"
3,Dave Täht,2011-01-24 10:48:26.036861,"shipka and sima are under etckeeper now. 

Next up, figure out how to push the repos out to the redmine site - SECURELY. 
I am not a fan of even encrypted password databases getting into the web.

Also some mods to make sshing around a little simpler

Maybe adopt passwordsafe for system passwords, use specific admin authorized ssh keys for root operations for the cluster, adopt pdsh or kanif"
3,Dave Täht,2011-01-24 11:59:00.834786,"without git submodule support there is no way to manage multiple machines that are using etckeeper. You'd have to have one project PER etckept machine. 

Instead, I put the redmine branch (for now) into the sysadm repo, which kind of/sort of makes sense, since that's where I'm going to be doing some development soon. 

I am still highly allergic to even doing that - for example, some passwords are kept in plain text there.

Backups and version control via etckeeper? Absolutely. web interface... mmmm.........."
12,Dave Täht,2011-01-24 13:34:39.159219,"> * The email interface does not send from a unique per project email address

However it will take emails using the + syntax. 


-- 
Dave Taht
http://nex-6.taht.net"
12,Dave Täht,2011-01-24 13:52:14.543831,"Status: Assigned
Priority: Low
Assignee: d@taht.net
Category: Feature

But it's too dumb to follow the headers in the message.


-- 
Dave Taht
http://nex-6.taht.net"
14,Dave Täht,2011-01-24 14:07:28.696829,"setting it up on sima as bloatbot

openprojects..."
15,Dave Täht,2011-01-24 14:12:57.778622,Let's see what happens if I do that.
12,Dave Täht,2011-01-24 14:15:40.101239,* custom search doesn't let me filter out target version
5,Dave Täht,2011-01-24 14:16:50.871697,""
11,Dave Täht,2011-01-24 14:17:27.534297,""
6,Dave Täht,2011-01-24 14:18:49.657908,cactus. I will poll some people.
13,Dave Täht,2011-01-24 14:20:36.749952,""
10,Dave Täht,2011-01-24 14:21:11.089658,""
4,Dave Täht,2011-01-24 14:22:55.902849,"upgrading later would be a major hassle.

On the other hand, 8.4 is stable, and I've taken enough risks for now,"
3,Dave Täht,2011-01-24 14:26:14.420803,""
16,Dave Täht,2011-01-24 15:48:58.372276,"I note the estimate above is just about how long it would take to get into the tracker, not how long the remaining tasks will take. Most are prio 2 or less from my standpoint, others will differ.

My personal goal is to have 24/7 capable web site(s) that doesn't require more than a few hours a week to maintain. Certainly I hope some clones arrive."
12,Dave Täht,2011-01-24 18:01:13.76774,actually it doe let me filter out the target version. I didn't see the checkbox to turn off the other stuff. Not horrible
12,Dave Täht,2011-01-24 18:42:43.596548,"I'm going to list the pluses first:

# Pluses

* As a software or writing project management software, redmine appears to be superior to trac in every way.(this is not saying much)

* The ability to easily delegate roles and create new projects is quite excellent.

* The wiki integration is excellent. The wiki language itself is pretty good, I was pleased with how easy I could integrate mathjax. Textile, while strange, is not too strange. It IS different from mediawiki, which is what most people are familiar with, if they are familiar with a wiki at all. 

* The ability to deal with multiple repos is excellent, the graphs are cute, too. The gannt chart only makes me wish for conventional project management software, however. As much as I dislike to say it, ms-project, circa 1993, was more complete. (I note that my only real issue with ms-project THEN was it's inability to do risk management and cover multiple lines of development. I've been hoping for a web based project management tool to catch up for years) 

* Thus far, the 1.1 code has been very stable

# The minuses (some already mentioned in previous comments)

* Outside of the core, the number of plugins of dubious quality make me very nervous to patch them in or maintain them without a detailed understanding of the Ruby language, better contacts in the community, and more time than I have available. The number of plugins and patches required so far to make it truly useful (I looked at 8 more today) worry me long term. I'm glad for git, it makes maintaining a fork a lot easier, but....

* I don't care for how it handles file attachments. The urls for uploaded media appear to HAVE to go through the ruby process rather than being intercepted by apache - you get urls like attachment/1 . Similarly, there are no file extensions on the uploaded files, relying instead on content-type for these - which breaks my usage of emacs's detection of a file extension to determine whether to invoke a browser or not.

* The REST interface is both new and very raw. Almost nothing interfaces with it

* It insists on using vast expanses of screen space, there is no (as yet) handheld support, 

* The ticketing system seems adequate for low volume projects. I was amused to see a python wrapper around a ruby script that basically posted an email to a ticket. Overkill, that. I suspect the number of ruby programmers that understand email is low. The default email format is precisely the opposite of what I find useful. 

* There is very little documentation on the underlying SQL interface(s)

* It appears difficult to create fully mirrorable instances. 

Of these flaws, the big deal killers for me for using this in a *day to day system administration role* is the ticketing system:

Lacking a bulk editing interface, handling the volume of email traffic nagios generates, as well as the conventional mail addresses ""postmaster"", ""security"", ""abuse"", etc. would be nearly impossible.

(to make my bulk editing critique clear - a malfunctioning system or network can generate thousands of related tickets in a matter of minutes)

Lacking gpg support, authenticated mail is impossible, thus leading to possibly massive onslaughts of spam were I to allow email into it (I have this beef about mailman, too - though there is a patch for it)  

The ticketing system seems to lack coherent support for (example) automatically ""doing stuff"" when an item moves from one state to another. 

And, finally, eating the whole screen, and lacking a command line interface, or an emacs one, or even a halfway decent email one, or any ability to bulk edit, redmine's completely unusable for me with my sysadm hat on. RT is vastly superior in all these attributes.


Certainly the other uses above - planning a new website, doing software development, being able to easily get a high level viewpoint, are all excellent characteristics of redmine, The wiki is superior to mediawiki in many respects, too. 

BUT: were this volunteer gig to evolve to managing more than a few machines, or (worse) a cluster - I would rebel and install RT somewhere to handle that workload. 

In fact, I already did. Problem was, poor siwa doesn't have enough ram to run it and mailman at the same time at present. I may work on that.

For comparison, see:

http://bestpractical.com/rt/features.html

Again, I'd like to make clear that I'm criticizing a new shiny general purpose product in its freshly released 1.1 form  vs a specialized product that does one thing (ticket management/workflow) incredibly well, for one specific role, daily system administration.

It is certainly possible to make redmine work more the way I want, for this role, I will work on it... but what I'd rather be working on is an easy wiki editing interface similar to the one I have already for mediawiki. "
7,Jim Gettys,2011-01-24 19:53:56.35887,"I agree that better things are needed for the databases.  But you are the wizard there.

In any case, the disk is installed; the name backup.bufferbloat.net; only accessible via IPv6.
"
12,Jim Gettys,2011-01-24 20:17:10.976606,"I think you've missed some of the tracker interface bits that are important.

You can bulk edit quite a bit; just select which issues, and right click on one of them and select what you want to do (e.g. close them).

This was exactly the feature the student implemented at OLPC in trac in prototype form that I really needed, yet hadn't been integrated upstream 2 years later.

On the mail front, I'm sure they'd like the comments upstream (preferably with patches, of course ;-).
"
12,Dave Täht,2011-01-24 20:46:42.263751,"redmine@lists.bufferbloat.net writes:

> Issue #12 has been updated by Jim Gettys.
>
>
> I think you've missed some of the tracker interface bits that are
> important.

Btw, right now you can respond to redmine requests via email,
for sysadmin issues with redmine+sysadmin@lists.bufferbloat.net

There's a patch to redmine that allows sending mails
from variable addresses like this, crufty as yet I haven't put it in
place (I actually tend to READ patches before applying them)

The various plugins under consideration are in ~redmine/src

Wish I could find one to word wrap the emails at 80 columns, 
and do citing right...

> You can bulk edit quite a bit; just select which issues, and right
> click on one of them and select what you want to do (e.g. close them).

Edit one at a time yes. It's not a spreadsheet or ms-project like mode 
however. Requires that meece thing a lot, too.

Creation is harder - it's not really something you want most users to 
be able to do... But I'm fiddling with my existing RT code/interface
to see if I can just allow lil ole me to do it for the 50+ issues I 
have stashed in orgmode.

Related to this is how I currently can open/close several hundred bad
tickets at a time using an RT scrip when I get notifications from 
nagios -I can filter these to NOT send me emails, just show up - and
automatically get closed when the hardware come back online. It's a
tremendously powerful facility that is sorta there in redmine...

Sorta doesn't cut it with a cluster. Here... Meh... 

> This was exactly the feature the student implemented at OLPC in trac
> in prototype form that I really needed, yet hadn't been integrated
> upstream 2 years later.

Yep. It helps.

> On the mail front, I'm sure they'd like the comments upstream
> (preferably with patches, of course ;-).

I try to blow the steam off first.

-- 
Dave Taht
http://nex-6.taht.net"
7,Jim Gettys,2011-01-25 03:18:35.805924,""
7,Dave Täht,2011-01-25 08:27:00.56651,"As interesting as the smokeping data would be (yea! actual experiments), I'd settle for a backup. You firewalled at the router or the box?

root@shipka:~# traceroute6 backup.bufferbloat.netraceroute to backup.bufferbloat.net (2001:55c:62e5:6320:92fb:a6ff:fe85:d16c) from 2001:4f8:3:36:208:54ff:fedb:40ec, 30 hops max, 16 byte packets
 1  exit.ip6.vlan54.sql1.isc.org (2001:4f8:3:36::1)  2.286 ms  2.148 ms *
 2  int-0-4-0-0.r1.pao1.isc.org (2001:4f8:1b:1::8:1)  3.583 ms  4.509 ms  1.139 ms
 3  be-10-401-cr01.sanjose.ca.ibone.comcast.net (2001:559::fd)  2.287 ms  1.973 ms  1.595 ms
 4  pos-0-14-0-0-cr01.denver.co.ibone.comcast.net (2001:558:0:f560::1)  63.145 ms  62.884 ms  62.994 ms
 5  2001:558:0:f6c2::2 (2001:558:0:f6c2::2)  64.006 ms  63.703 ms  63.746 ms
 6  2001:558:d0:12::1 (2001:558:d0:12::1)  64.717 ms  64.394 ms  64.545 ms
 7  2001:558:d0:b::2 (2001:558:d0:b::2)  66.446 ms  64.831 ms  64.794 ms
 8  2001:558:d0:1e::2 (2001:558:d0:1e::2)  64.537 ms  64.309 ms  64.519 ms

 9  * * *
10  * * *
11  * * *

and not returning NXDOMAIN breaks the internet.

root@shipka:~# traceroute backup.bufferbloat.net
traceroute to backup.bufferbloat.net (149.20.54.81), 30 hops max, 60 byte packets
 1  shipka.bufferbloat.net (149.20.54.81)  0.064 ms  0.016 ms  0.015 ms
root@shipka:~# host backup.bufferbloat.net
backup.bufferbloat.net has IPv6 address 2001:55c:62e5:6320:92fb:a6ff:fe85:d16c

"
7,Jim Gettys,2011-01-25 08:39:38.433323,"Heh.  IIRC, the firmware on the router doesn't firewall IPv6 at all right now; host is all there should be."
7,Dave Täht,2011-01-25 09:08:07.710969,"I have found that comcast's router (I have business class service) turns
off ipv6 (for 2002:) a few minutes after the last outgoing connection.

Sometimes given that encapsulation it seems to be oddly throttled, too.
Been meaning to look into that, can do so now that there TWO people on 
comcast that are using it to communicate.

I turned off the comcast router firewalling features. You appear to be
using a real(ish) IP address, but...

BTW I appreciate that we've been doing IPv6 throughout. With the last
IPv4s about to expire, no common traffic shapers or firewalls doing 
anything with it, and Linux's IPv6 stack sorely undertested for ECN/etc,
it's good to have this turned on.

But sometimes it's a pain in the arse.


-- 
Dave Taht
http://nex-6.taht.net"
14,Dave Täht,2011-01-25 10:26:05.443791,"So I took a little time out to do something fun. I have rbot configured

Still have to have it hold ops on the channel, etc, and test its features

<pre>!google bufferbloat</pre>
<pre>!translate en es hello</pre>

A #7 goes to shipka and pulls the issue status

I would certainly like it to post updates to a bug to the channel as well...

Couple more basic things to configure, then to DEPLOY it will need to move from sysadmin to bloat 
and I can think of a zillion other cool features but that's just too much fun to have right now.

I'll get it to where it holds ""op"" privs and call it a day."
7,Dave Täht,2011-01-25 16:17:52.417675,"Status: Closed

Although performance is poor, we have connectivity, ssh keys, etc."
15,Dave Täht,2011-01-25 16:21:50.853502,"diff --git a/vendor/plugins/redmine_youtube/init.rb b/vendor/plugins/redmine_youtube/init.rb
new file mode 100755
index 0000000..161df2c
--- /dev/null
+++ b/vendor/plugins/redmine_youtube/init.rb
@@ -0,0 +1,26 @@
+#
+# vendor/plugins/redmine_youtube/init.rb
+#
+require 'redmine'
+require 'open-uri'
+
+Redmine::Plugin.register :redmine_gist do
+  name 'Redmine YouTube plugin'
+  author 'Maxime Rousseaux-Bridle <max.rb@xambr.com>'
+  description 'Allows a you tube video to be embeded'
+  version '0.0.1'
+
+  Redmine::WikiFormatting::Macros.register do
+    desc ""Embed a you tube video""
+    macro :youtube do |obj, args|
+        %~
+                <object width=""425"" height=""344"">
+                        <param name=""movie"" value=""http://www.youtube.com/v/#{args[0]}=en&fs=1""></param>
+                        <param name=""allowFullScreen"" value=""true""></param>
+                        <param name=\""allowscriptaccess\"" value=\""always\""></param>
+                        <embed src=""http://www.youtube.com/v/#{args[0]}&hl=en&fs=1"" type=""application/x-shockwave-flash"" allowscriptaccess=""always"" allowfullscreen=""true"" width=""425"" height=""344""></embed>
+        ~
+    end
+
+  end
+end"
15,Dave Täht,2011-01-25 16:24:12.247076,"diff --git a/vendor/plugins/redmine_youtube/init.rb b/vendor/plugins/redmine_youtube/init.rb
new file mode 100755
index 0000000..161df2c
--- /dev/null
+++ b/vendor/plugins/redmine_youtube/init.rb
@@ -0,0 +1,26 @@
+#
+# vendor/plugins/redmine_youtube/init.rb
+#
+require 'redmine'
+require 'open-uri'
+
+Redmine::Plugin.register :redmine_gist do
+  name 'Redmine YouTube plugin'
+  author 'Maxime Rousseaux-Bridle '
+  description 'Allows a you tube video to be embeded'
+  version '0.0.1'
+
+  Redmine::WikiFormatting::Macros.register do
+    desc ""Embed a you tube video""
+    macro :youtube do |obj, args|
+        %~
+                
+                        
+                        
+                         
+        ~
+    end
+
+  end
+end"
15,Dave Täht,2011-01-25 16:26:55.309094,"Attachment: (unnamed)
Attachment: (unnamed)"
15,Dave Täht,2011-01-25 16:27:48.5587,"Meh. Mangles attachments, patches inline, and images attached. Not good. "
11,Dave Täht,2011-01-26 07:30:06.216985,"What I'd wanted was a sql dump, not an xml one... coping with XML is going to take a bit more time."
11,Jim Gettys,2011-01-26 08:50:48.572185,"Sorry; the XMBL is what wordpress.com gives me.  I stopped running my own wordpress after someone pwened my machine some years back; I'd been too busy to keep it updated.
"
2,Dave Täht,2011-01-26 12:26:52.063485,"It is not clear to me what good this does vs a google custom search. On
the other hand, I don't know how to incorporate a google custom search
into redmine, so perhaps this will help. 

I still have to configured omega itself."
20,Dave Täht,2011-01-26 13:01:20.747974,I think I fixed the key leak. But I'm not sure.
22,Dave Täht,2011-01-26 13:01:55.496596,"-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1


So all mails to bufferbloat.net are being vectored through lists now.

- -- 
Dave Taht
http://nex-6.taht.net
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.10 (GNU/Linux)
Comment: Processed by Mailcrypt 3.5.9 <http://mailcrypt.sourceforge.net/>

iQEcBAEBAgAGBQJNQIu8AAoJENt4fAQELrZXiGUIAKVZzolTjIZBskGky+JE8GPx
3t0DH+4fb6jqYi9ToZVLaS4wiVX70cZrBEopXw2bzkQbM3UA9YuR0wl8G7X6epkJ
U60b02uVfrapGxderA8+PkUz/tSGGaPsS8NVhUZscX19qbdtEZbu/iddVAeQs7Cr
2thPqcwKM/cZ4ntBL4kLSjxSW0yMWX6QgSSlRnA8eXf/FCVV+ifaNFVt/SKQo5Gz
UceKFhz2A58O3FDvAXbWkDmPumYRhQBPypILjlzGOlKmiQkp453qLIN1DH+tULBA
RrDulE6MatSfU8R+Oyr4nFzwueUc0z+bJqlgu0QIQhgvolqyZYfWDWtIExUtRuk=
=5aAq
-----END PGP SIGNATURE-----"
20,Dave Täht,2011-01-26 13:05:16.373726,Assignee: d@taht.net
20,Dave Täht,2011-01-26 13:06:22.515382,"-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1


But it won't get past the tracker.

- -- 
Dave Taht
http://nex-6.taht.net
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.10 (GNU/Linux)
Comment: Processed by Mailcrypt 3.5.9 <http://mailcrypt.sourceforge.net/>

iQEcBAEBAgAGBQJNQIzGAAoJENt4fAQELrZXbDcH/3t5VN29Wwa7GW4w5XKts5sF
xX1Z3nUtaG9DflTIuTPRmOawPOl2mDUXrO2YARxXdDW2S+1TmkssIK5Z6BnHHupE
yWlQdgg80rAWVrVRj0nhYMghGFdfxRpkIUr7XEx4D0zkCzh/efsSZ3URxgWKlORY
Ru/72gE7T9t1tE7u+v7HLfORVLYNXZpTzD5HlQq40MQsNG33VN3luIEbG66KaTdz
KwZxtfrBPv9IJVRsehABmJaGRQ68r7fW8EEhb9XOVdVWFMrPeV77zo1TQm4CS57D
/bQC7BUDUBFPf+8TBe/R3opHgFcfkYJQvnF7UC8s6NSAmWV7P7Y2za9HSRjTrWA=
=0PHS
-----END PGP SIGNATURE-----"
22,Dave Täht,2011-01-26 13:06:47.147972,"-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1


You'd think this would just work.

- -- 
Dave Taht
http://nex-6.taht.net
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.10 (GNU/Linux)
Comment: Processed by Mailcrypt 3.5.9 <http://mailcrypt.sourceforge.net/>

iQEcBAEBAgAGBQJNQIzeAAoJENt4fAQELrZX64sH/jbHMza/rr01eWzV6Naqml/F
8hncEqY9VDBzXGAquqE3Mx/H0gpck2pFsZ3/MgSM3bh7bY2EePNYxqCaov0OCRs6
W54ezM3b5IlVs9lEk57YUVXxnItOVOvMLAXqOa/09fSUyFwr0bxbBzNQ/EGmmyi4
MD1UTB6FHoU7SSCvKI9PWyyBKkDc2AGctyaaeqvRBkGN1HkS8wDZqDpPuvxhjWp0
nSdtC/HA9q9aIk20FcA/gySgCYvoViRXRn2hU+gtoYtluSmg81aKvBdNIh9DtRxr
4Dw8xhMn14SwnCW+0kgqGAOyf+5HnByVAYCenacwy3ltfpswqFvh97Ceb/HQqew=
=2uQg
-----END PGP SIGNATURE-----"
20,Dave Täht,2011-01-26 13:08:19.608522,moved the file from aliases to a file....
24,Dave Täht,2011-01-26 14:45:20.784242,"<pre>

<VirtualHost *:80>
	ServerName mirrors.bufferbloat.net
	ServerAdmin webmaster@lists.bufferbloat.net
        DocumentRoot /home/jg/public_html
	<Directory /home/jg/public_html>
	Options Indexes FollowSymLinks MultiViews
        AllowOverride None
	</Directory>
</VirtualHost>

</pre>"
24,Jim Gettys,2011-01-26 14:55:03.414175,"I've added the name server entries.
"
25,Jim Gettys,2011-01-26 15:42:38.347675,"The question, is, move it to whom?  I can certainly move it to dyndns where I have other things.

Their UI isn't so hot either.

I really don't want to become a dns wizard on top of other things too, though now I have the little  atom box where the backup disk is, it isn't as objectionable than the 150W monster I'm trying to get out of the house.
"
25,Dave Täht,2011-01-26 16:31:55.130912,"Anybody that has GeoIP. A gui would be nice. 

I've deferred this problem for further research later, and just had the
servers search one of my own domains for lookups.

Thx for putting up with my venting.

> I really don't want to become a dns wizard on top of other things too,
> though now I have the little atom box where the backup disk is, it
> isn't as objectionable than the 150W monster I'm trying to get out of
> the house.

I LOVE my openrd. 11 watts for the cpu + internal drive, 6 for the disk
(when spun up). Totally silent. $250 + disk.

Slightly more expensive than an atom...

I was very disappointed with the guruplug version - 129 dollars but with
a fan that is 40+db loud."
24,Dave Täht,2011-01-26 16:37:51.459571,"there is a mirrorme script in your home dir on shipka. I've also put your presentation in there, the last copy I saw. 

If you edit/remove/change files in your public_html dir, ~/bin/mirrorme will send it to the two servers

I'm also thinking of setting up a torrent...

Anyway, I'll sleep better knowing the really big stuff is mirrored. Thx. 

I was unable to get ahold of my east coast or australian contact today, so we can close this ticket now. If I get some more mirrors (amazon S3 is cheap), maybe we can change this later or while under load. 

I do admit one ulterior purpose of mine is to get some logs on ipv6 traffic."
11,Dave Täht,2011-01-26 17:29:24.828144,ok I got a reasonable parser pulled together that at least lets me grep. Trying to roll one quickly that pulls out useful urls and surrounding content.
9,Dave Täht,2011-01-26 17:34:37.050795,"I have sysadmin, support, bb (bufferbloat), as aliases that more or less do the right thing."
14,Dave Täht,2011-01-26 17:36:13.923201,Still not getting op privs
13,Dave Täht,2011-01-26 17:38:45.06196,I worked around this some by not searching bufferbloat.net by default.
8,Dave Täht,2011-01-26 17:40:31.217608,"this needs to become an automated, replicate process"
6,Dave Täht,2011-01-26 17:41:48.461355,All the tools I looked at had more overhead than I would like.
2,Dave Täht,2011-01-26 17:43:05.763061,I have to figure out omega. 
3,Dave Täht,2011-01-26 17:44:05.889031,I love it. It does the right thing. 
11,Dave Täht,2011-01-26 17:44:58.361365,""
28,Dave Täht,2011-01-26 21:01:22.783014,The amount of comment spam I saw was unbelievable.
29,Dave Täht,2011-01-26 22:07:50.802191,"And the joy of running static web sites is that I got

~200 req/sec out of mirrors.bufferbloat.net (admittedly going from siwa to my dual pentium III box)

I KNEW there was a reason I made my blog static and eschew all this fancy smancy lamp stack stuff.

Anyway, mirrors can withstand a slashdotting, although I should probably tune up the main box some. 

time ./httping -c 300 -6 -G -f http://mirrors.bufferbloat.net/

And while I'm doing these gross tests I must always caution that they are not real workloads. In particular the time it takes to retire a connection can really hurt a box - so long distance traffic can accumulate 100s of thousands of sockets in a FIN_WAIT state, as one exaample....."
28,Jim Gettys,2011-01-27 08:50:50.974594,"Oops; I should have emptied the spam trap before exporting the blog.

Sorry.

So much fun the spammers like to spam blogs, isn't it?"
31,Dave Täht,2011-01-27 10:37:37.462729,""
27,Dave Täht,2011-01-27 11:10:48.127184,"ActionController::RoutingError (No route matches ""/projects/bloat/wiki/Sandbox/files/110127105646_Attribution_ShareAlike.png"" with {:method=>:get}):
  public/dispatch.fcgi:24

Rendering /home/redmine/redmine/public/404.html (404 Not Found)


Processing ApplicationController#index (for 75.145.127.229 at 2011-01-27 11:08:20) [GET]

ActionController::RoutingError (No route matches ""/projects/bloat/wiki/Sandbox/Attribution_ShareAlike.png"" with {:method=>:get}):
  public/dispatch.fcgi:24

Rendering /home/redmine/redmine/public/404.html (404 Not Found)


Processing ApplicationController#index (for 75.145.127.229 at 2011-01-27 11:08:21) [GET]

ActionController::RoutingError (No route matches ""/files/110127105646_Attribution_ShareAlike.png"" with {:method=>:get}):
  public/dispatch.fcgi:24

Rendering /home/redmine/redmine/public/404.html (404 Not Found)


Processing WikiController#update (for 75.145.127.229 at 2011-01-27 11:08:24) [PUT]
  Parameters: {""commit""=>""Save"", ""project_id""=>""bloat"", ""action""=>""update"", ""_method""=>""put"", ""authenticity_token""=>""eWWR718zHdlNJNk8efImxPdO7s8cTgiiMVgUAFYJ6aQ="", ""id""=>""Sandbox"", ""content""=>{""comments""=>"""", ""text""=>""h1. Sandbox\r\n\r\nCome on let me cache these!\r\n\r\nVia a virtual url\r\n\r\n!attachments/download/11!\r\n\r\nVia files\r\n\r\n!files/110127105646_Attribution_ShareAlike.png!\r\n\r\nDirect\r\n\r\n!Attribution_ShareAlike.png!\r\n\r\nVia a direct url\r\n\r\n!http://www.bufferbloat.net/files/110127105646_Attribution_ShareAlike.png!"", ""version""=>""3""}, ""controller""=>""wiki"", ""attachments""=>{""1""=>{""description""=>""""}}}

ActionView::MissingTemplate (Missing template wiki/update.erb in view path vendor/plugins/redmine_bots_filter/app/views:vendor/plugins/redmine_project_specific_email_sender/app/views:vendor/plugins/redmine_xapian/app/views:app/views):
  app/controllers/application_controller.rb:474:in `default_template'
  public/dispatch.fcgi:24

Rendering /home/redmine/redmine/public/500.html (500 Internal Server Error)

"
31,Dave Täht,2011-01-27 11:33:17.081248,"1) Does the site render properly on safari? Explorer? Old Explorer?

Already tested: Chrome, firefox on ubuntu

Test pages:

http://www.bufferbloat.net/projects/bloat/wiki

http://www.bufferbloat.net/projects/sysadmin/wiki/Sandbox (known error
on this page)

2) How fast does it render? Are there any uncached images/scripts left over?

3) How bad is it on handhelds?

4) Can others reproduce [#27] ?

5) Can a reporter edit a page?

6) There is no rule 6"
31,Brian Clapper,2011-01-27 11:54:25.620137,"* IE 9 on Windows 7 works fine.
* Safari 5.0.3 on Mac OS X (Snow Leopard) works fine."
30,Dave Täht,2011-01-27 13:21:29.170738,"!/images/jigsawfish-small.png!

!/images/jigsawfish2.png!

!/images/Attribution_ShareAlike.png!

Figuring out how relative urls was supposed to work took all my spare time today. There seems to be a minor issue with inline images uploaded.

I put the logos up locally, as per the above links.

(I felt it would work better, given these images are cached and we are using http 1.1, to not send people off the site)

I do not have time for further hacking into the ruby code to get it to tell people to use the license(s) somewhere on entry to the page. I have grepped and not grokked. 

I set aside the time today to go live and monitor/keep the site running under heavy load, and do some writing. 

I have no brain cells left, and I plan to be mostly away from the computer (with just pings to my cell phone) this weekend.

Can we go live *now*? Please?"
30,Dave Täht,2011-01-27 13:46:37.874927,"<pre>
> !/images/jigsawfish-small.png!
> 
> !/images/jigsawfish2.png!
> 
> !/images/Attribution_ShareAlike.png!
</pre>

"
30,Dave Täht,2011-01-27 13:54:27.962521,"<pre> !/images/Attribution_ShareAlike.png!:http://en.wikipedia.org/wiki/Wikipedia:Text_of_Creative_Commons_Attribution-ShareAlike_3.0_Unported_License</pre>

!/images/Attribution_ShareAlike.png!:http://en.wikipedia.org/wiki/Wikipedia:Text_of_Creative_Commons_Attribution-ShareAlike_3.0_Unported_License"
31,Dave Täht,2011-02-01 09:13:52.049989,""
15,Dave Täht,2011-02-01 09:18:02.717617,""
26,Dave Täht,2011-02-01 09:19:06.437192,don't know how to change something from a bug to a feature.
32,Dave Täht,2011-02-01 09:20:06.169863,"Kernel build time on my dual core laptop.

real	119m21.629s
user	181m45.500s
sys	21m6.810s
"
32,Jim Gettys,2011-02-01 09:36:19.187732,"hmmm.  I think we might manage an EC2 instance; I don't know how fast those are; I'll ask at work.  I had one up last month, but turned it off, and it may not have been configured healthy enough for convenient builds...
"
33,Luca Dionisi,2011-02-14 02:29:27.726292,"I have placed a link to the bufferbloat.net portal in one post of my blog. Without adding much more informations on the post.

In my case this could be fine, since the blog audience are people that could be interested in deploying an independent new network.
So they should be interested in finding out by themselves what this problem is and how to take care.

But if someone wants to drive some interest to a different audience, what are the informations that he[she] should try to deliver himself to his audience before pointing them to the portal?
I think that any idea on this topic might be useful.
"
33,Dave Täht,2011-02-14 14:19:25.092358,"Luca, please, as a project member, feel free to add a link to your blog post to the [[good blog discussions]] page.

Also, if you want to write something in your native language..."
36,Dave Täht,2011-02-18 07:08:57.30929,"I am sore inclined to just copy shipka over and start with that. 

However, switching to 64 bits would be best. Having a long term plan (like, past august) would also be good. 

First up, is prototyping jenkins... in the context of doing continuous builds of openwrt. 

"
35,Dave Täht,2011-02-18 07:14:36.530141,"Lay down as many of your dream requirements as exist.

For example, I think focusing on openwrt will have the best short term effect.

I LOVED the old handhelds.org community, where we gathered on the server and did stuff.
(I would kind of like to do that with the plug computers)

All the same, having virtual machines setup for builds of debloated backported kernels would be good too. (better, get people to co-operate in the cluster)

I guess I'll post to the mailing list. AFTER I'm sure we have isc's full, official support."
25,Jim Gettys,2011-02-21 14:23:37.876633,"I'm happy to move it to ISC and edit via git (though editing zone files isn't something I've done personally in the past, presumably this old coot can learn...).
"
38,Dave Täht,2011-02-21 17:26:12.484953,"mildly better than that. And also I don't want to muck with the ruby code, I've got two major things left to do this week (C/kernel stuff), some audio to edit, then a trip to vegas for a wedding, and I'm debating about going to california directly from vegas.

Would much rather prototype the new features on the new box rather than on the box that is working. Can it wait?"
40,Dave Täht,2011-02-24 13:00:54.277695,"See also:

https://lists.bufferbloat.net/pipermail/bloat/2011-February/000154.html

for the related discussion"
5,Dave Täht,2011-02-26 20:59:17.546932,I would so love to see the server stats from today. Slashdot is not what it once was...
33,Dave Täht,2011-03-05 07:58:54.268232,"We have editorials going in IEEE computer and Linux Journal in the next 2-3 months. 

We have had good (nay, great!) blog and chat site coverage, thanks to lwn and slashdot, thus far.

We have no visibility in core business publications like the Economist, and the trade press has only had passing reference to bufferbloat. It would help to have a framing issue, or a company, highlighting a debloating fix, to build a story around - or a cost analysis of the dollar costs of bufferbloat and/or the costs of a fix.

CACM, and MIT's technology review seem like good pubs to target for more scholarly work.

Lastly, international coverage is lacking. We do need translations of the core concepts into other languages. 

So are there more publications we can target, worldwide, with the people we have on board, with either translations or new articles?"
33,Dave Täht,2011-03-05 08:01:08.494698,http://www.technologyreview.com/magazine/?p1=Nav_Magazine
5,Dave Täht,2011-03-18 07:57:57.647522,"I would like to know what sort of hits we're getting and where, as feedback as to where to focus attention on the wik"
35,Dave Täht,2011-03-18 08:02:48.175565,"The new server was up, briefly. I did a bit of load testing and configuration, which was quite encouraging. 

Unfortunately I was able to easily corrupt the raid partition on a normal shutdown. Causes may be kernel bugs, hardware bugs, write caching in the hard disks, a bad hard disk, or pilot error.

I am having isc move the disks to an identical machine and use sata ports 2-X which is a different sata controller that I trust more. "
31,Dave Täht,2011-03-19 11:49:10.883293,"I am in progress of the next phase of bufferbloat.net's buildout. 

I really appreciated the beta testing before, and could always use more beta testers.

However, we are at the point of discussing some sensitive information on the system administration side, and if you are not interested in that (and/or not further interested in the bufferbloat project) please let me know, so I can take you off.
"
31,Dave Täht,2011-03-19 11:50:23.985533,"And conversely, if you are interested in the next phase of the buildout, please join the sysmom mailing list at lists.bufferbloat.net. 

(also bloat and bloat-devel are good)"
41,Dave Täht,2011-03-21 14:03:11.381011,Appearance given...
11,Dave Täht,2011-03-22 07:19:43.893707,"Could you re-provide an xml dump of your wordpress db?

this time, AFTER getting rid of the comment spam?

Maybe we have enough people on board now to do a better job of filtering through it."
42,Dave Täht,2011-04-04 06:52:07.608089,""
42,Dave Täht,2011-04-04 06:53:26.513574,"Device identifier should be the mac address

On the server side we need to make a lot of changes to manage this side of configuration

Separate database (postgres database) - 

One measurement table has 6 months of data with zillions of entries.

"
42,Dave Täht,2011-04-04 06:54:32.498104,""
50,Dave Täht,2011-04-04 08:03:57.953772,D-ITG will need to be updated in the field
50,Dave Täht,2011-04-04 08:04:52.488257,"Documentation needs to be updated as well.

"
52,Dave Täht,2011-04-04 08:12:26.288271,Walter is working on an interface that includes a map interface for another project
48,Dave Täht,2011-04-04 11:53:00.336614,mailing list for commits created. 
47,Dave Täht,2011-04-04 12:32:24.915581,"svn has been enabled in the redmine backend.

The actual repo has to be linked to, via someone with the url, password, 
and privs (sri?) by going to:

http://www.bufferbloat.net/projects/bismark/settings

clicking on repository, and entering the information."
47,Dave Täht,2011-04-04 12:33:08.193039,""
54,Dave Täht,2011-04-04 12:43:26.587138,"0) I've tried to capture some of the outstanding work on the roadmap

http://www.bufferbloat.net/projects/bismark/roadmap

1) There is a #bismark channel on irc (chat.us.freenode.net) However we 
cannot take ownership of the channel until pooleb_ gets out of it and 
sri or george can take it over and gain op privs.

2) There is a robot monitoring the channel, named george. The same robot 
theoretically can handle email updates to bug reports, too. Simply put a 
[#thebugnumber] in the subject and talk to the problem.


3) There is now a bismark-commits list #48

4) Regrettably (#47), I'd forgotten the svn password and location, could 
whoever has it go into:

http://www.bufferbloat.net/projects/bismark/settings

click on repository, select svn, and stick it in there?

5) To enable commit messages to email, see:

http://wiki.wsmoak.net/cgi-bin/wiki.pl?Subversion/EmailNotification for 
the repository you are using

6) the [[Wiki]] has some more stuff in it.

Tomorrow:

I am still dragging on getting the distributed build system up, I have 
some hard decisions to make. Hopefully tonight, but I've been saying 
that for a week."
54,Dave Täht,2011-04-04 12:46:05.905638,""
54,Walter de Donato,2011-04-05 05:24:16.193273,The SVN Email notification is up and running
54,Dave Täht,2011-04-05 14:53:21.01403,"I made a test commit to the svn tree and did not see an email try to go to bismark-commits.
"
55,Dave Täht,2011-04-05 19:59:09.237276,radvd and 6to4 are now defaults
54,Walter de Donato,2011-04-06 02:12:57.253631,"I found this error in the exim log about your post:

2011-04-05 23:53:30 1Q7EBl-0005IP-4h ** bismark-commits@lists.bufferbloat.net R=dnslookup_relay_to_domains T=remote_smtp: SMTP error from remote mail server after RCPT TO:<bismark-commits@lists.bufferbloat.net>: host mx1.mailhop.org [216.146.33.4]: 504 5.5.2 <arenella>: Helo command rejected: need fully-qualified hostname

Do you know how can I force a fully qualified hostname instead of ""arenella""?"
54,Walter de Donato,2011-04-06 03:43:33.251331,"I found a solution to the error.
Just added the following line to the exim configuration file:

primary_hostname = svn.comics.unina.it

Anyway, I didn't receive the mail form the list.
Probably the sender (*@svn.comics.unina.it) is not allowed to post on the list."
54,Dave Täht,2011-04-06 03:44:26.817287,"On 04/06/2011 03:12 AM, gburdell@lists.bufferbloat.net wrote:
> Issue #54 has been updated by Walter de Donato.
>
>
> I found this error in the exim log about your post:
>
> 2011-04-05 23:53:30 1Q7EBl-0005IP-4h ** bismark-commits@lists.bufferbloat.net R=dnslookup_relay_to_domains T=remote_smtp: SMTP error from remote mail server after RCPT TO:<bismark-commits@lists.bufferbloat.net>: host mx1.mailhop.org [216.146.33.4]: 504 5.5.2<arenella>: Helo command rejected: need fully-qualified hostname
>
> Do you know how can I force a fully qualified hostname instead of ""arenella""?

There are three separate places you can configure this. I note that I'm 
mostly familiar with postfix (which is a drop in replacement for exim, 
so if you can switch, great)

At least with postfix, it pulls the originating domain name from 
/etc/mailname - so if you put your full domain 
(arenella.whatever.{net,it,whatever}) in in in there (preferably 
something that can also reverse resolve) postfix (and probably exim) 
will pick it up after a restart.

/etc/hostname is the other place to stick that stuff.

lastly, at least with postfix, you can specify it in 
/etc/postfix/main.cf as well.

> ----------------------------------------
> Support #54: sort out issues with interacting with the bufferbloat folk
> https://www.bufferbloat.net/issues/54
>
> Author: Dave Täht
> Status: New
> Priority: Normal
> Assignee:
> Category:
> Target version: 2nd generation (worldwide bismark measurements)
>
>
> To what extent can we wander in step?
>
>"
54,Walter de Donato,2011-04-06 04:00:19.56144,I finally received emails about last commits.
54,Dave Täht,2011-04-06 04:01:41.722965,"OK, I have added the known users to the commits filters.

What needs to be done in the future is the committing user needs to 
registered on the list.

If the user is somewhat virtual (as redmine is), then that user should 
be added to the list and sending emails to that person disabled.

I'm not going to publicly document the password here, but you can access 
the list administrative interface via:

https://lists.bufferbloat.net/admin/bismark-commits

And the archive via

https://lists.bufferbloat.net/pipermail/bismark-commits/

Roughly the same urls apply to the two other bismark lists.

As usually commit lists are fairly high volume I suggest filtering 
bismark-commits into a separate mailbox either by matching the List-Id 
header or by the [bismark-commits] preface in the command line.

Another tool I often use is gatewaying commit messages into irc using 
something like ""CIA""

Here's how to set that up for git commits:

http://wiki.debian.org/Alioth/Git#Sending_notices_on_IRC_via_CIA_bots

And somewhere in here is one for CIA

http://cia.vc/

This assumes this is a public project.

There is (or will be shortly) a #bismark project channel on freenode.net"
48,Dave Täht,2011-04-06 04:02:47.19118,The list is created. See #54 for more details as to how to interact with it.
48,Dave Täht,2011-04-06 04:03:26.598605,completed.
54,Dave Täht,2011-04-06 04:07:26.316862,"Although a bit of information in this bug should be captured to the wiki, (or the name changed to reflect the fact it became a log of bismark-commits) I consider it done. Please create new bugs/feature requests for other interfacing issues with the bufferbloat team

However: IRC commit notices anyone?"
56,Walter de Donato,2011-04-06 04:28:39.220972,"Most scripts are already ash compilant (just need to change the header).

I remember that some of them needed some bash specific features, 
but I have to dig into them to remember which one.

I'll give you soon an estimated time. "
54,Dave Täht,2011-04-06 15:57:40.519666,"dnsmasq uses /tmp/resolv.conf.auto

rather than /tmp/resolv.conf

/tmp/resolv.conf.auto should be created on boot when it acquires a dhcp 
address from the server.

""Fixed"" by changing /etc/config/dhcp to look at resolv.conf rather than 
resolv.conf.auto but this needs to be looked at harder.

(at least it boots to doing the right thing now)"
66,Dave Täht,2011-04-06 15:58:45.225356,"
dnsmasq uses /tmp/resolv.conf.auto

rather than /tmp/resolv.conf

/tmp/resolv.conf.auto should be created on boot when it acquires a dhcp address from the server.

""Fixed"" by changing /etc/config/dhcp to look at resolv.conf rather than resolv.conf.auto but this needs to be looked at harder.

(at least it boots to doing the right thing now) "
61,Srikanth Sundaresan,2011-04-06 22:19:07.881611,"Rearranged the files. Not sure about keys/ dir. I put it in /root. 

Walter, can you do a quick double check to see if it's ok?
"
67,Nick Feamster,2011-04-06 22:21:30.150927,""
60,Walter de Donato,2011-04-07 02:38:34.953642,"The destination IP is not hardcoded, but always requested to the bismark device manager daemon (bdmd).
The daemon manages a sqlite3 database containing a list of measurement servers 
and their capabilities in terms of supported measurement types.

To add/change measurement servers we just need to enter the appropriate entries in such database.

This is the current schema of such database:
<pre>
CREATE TABLE targets(
   ip       TEXT PRIMARY KEY,  // measurement server ip address
   cat      TEXT,              // measurement server category
   zone     TEXT,              // server geographical zone
   free_ts  INTEGER,           // timestamp indicating when a new measure can be performed by the server
   curr_cli INTEGER,           // current number of clients measuring towards the server
   max_cli  INTEGER            // max number of clients allowed to measure towards the server
);
CREATE TABLE capabilities(
   ip       TEXT,              // measurement server ip address
   service  TEXT,              // measurement service type
   info     TEXT               // measurement service details
);
CREATE TABLE mtypes(
   type       TEXT PRIMARY KEY, // measurement service type 
   exclusive  INTEGER           // flag stating if the measure can overlap with others on the server side
);
</pre>

Here you find reported the current content of these tables:
|*targets*|
|_ip_|_cat_|_zone_|_free_ts_|_curr_cli_|_max_cli_|
|143.215.131.173|Bismark|NorthAm|1302168437|0|2|
|143.225.229.126|Bismark|Europe|1298564306|0|1|


|*capabilities*|
|_ip_|_service_|_info_|
|143.215.131.173|PING|0|
|143.215.131.173|TR|0|
|143.215.131.173|HTTPDL|:8080/download.php|
|143.215.131.173|HTTPUL|:8080/upload.php|
|143.225.229.126|TR|0|
|143.225.229.126|PING|0|
|143.225.229.126|RTR|110|
|143.225.229.126|HTTPDL|:8080/download.php|
|143.225.229.126|HTTPUL|:8080/upload.php|
|143.215.131.173|RTR|110|
|143.215.131.173|ITGDL|143|
|143.215.131.173|ITGUL|143|
|143.225.229.126|ITGUL|143|
|143.225.229.126|ITGDL|143|
|143.215.131.173|SP|0|

|*mtypes*|
|_type_|_exclusive_|
|PING|0|
|TR|0|
|RTR|0|
|HTTPDL|1|
|HTTPUL|1|
|TCPUL|1|
|TCPDL|1|
|ITGUL|1|
|ITGDL|1|
|SP|1|


This database could/should be merged with the main database, 
but it requires a major revision of the bdmd.c code to use
the DB API instead of sqlite ones.

Also the schema can be slightly modified to allow a better
management of measurement servers resources (I'll probably create a new issue for that)."
60,Walter de Donato,2011-04-07 02:40:23.364865,"Sorry if I missunderstood the topic, but the 
previous information can be useful to align shaperprobe to
the general schema. ;)"
66,Dave Täht,2011-04-07 20:18:27.870389,Fixed by installing the firewall as a core package and setting up DNS right.
74,Walter de Donato,2011-04-11 02:44:11.161894,"I think it would be easier to give one image per-platform which, after the registration, 
can automatically install the eventually missing packages depending on the chosen privacy level."
80,Dave Täht,2011-04-12 06:59:10.914591,"I've attached a basic ipv6 enabled firewalling script to work around the latter half of this problem.

"
80,Jim Gettys,2011-04-12 10:11:02.154129,"This begs the interesting process question about whether OpenWRT issues/enhancements belong here, or in OpenWRT's trac system....

Let's check with Felix on how best to handle tracking issues for this.

Certainly 6to4 needs to be properly supported in OpenWRT, now that there are enough relays to be effective and useful.  A number of the commercial routers also support it (e.g. Apple Airport, and the DIR625/825, IIRC).

"
80,Dave Täht,2011-04-12 11:34:46.416333,"On 04/12/2011 11:11 AM, gburdell@lists.bufferbloat.net wrote:

 > This begs the interesting process question about whether OpenWRT 
issues/enhancements belong here, or in OpenWRT's trac system....

I had started this thinking that I'd:

Get a build server going
Get ubertwrt off the ground with the debloat-testing patches
Get others using some variant of that
Feed requirements back into uberwrt
Push back into openwrt

A) Things are moving starting at step 3 rather than at step 1 and so we 
are doing middle-out design

B)  Felix convinced me to try something flatter, assuming people were 
going to be actively developing packages (multiple packages are in 
flight now as I write)

That said, We've captured most of the requirements of the bismark project
thus far on the issues database for it, and the intersections of 
requirements are ""interesting"".
> Let's check with Felix on how best to handle tracking issues for this.

K.

> Certainly 6to4 needs to be properly supported in OpenWRT, now that there are enough relays to be effective and useful.  A number of the commercial routers also support it (e.g. Apple Airport, and the DIR625/825, IIRC).
>
As the bismark project chose Xwrt rather than another UI I was unaware 
of the gui limitations I noted earlier. the first 90% of the job is 
simply appending those two lines to enable 6to4 in the config by default.

> ----------------------------------------
> Bug #80: 6to4 support
> https://www.bufferbloat.net/issues/80
>
> Author: Dave Täht
> Status: New
> Priority: Normal
> Assignee:
> Category:
> Target version:
>
>
> Adding basic 6to4 support in the image is easy, but cannot (seemingly) be done in the web UI directly.
>
> Appending the following two lines to the /etc/network/config file gets you most of the way there
>
> config interface v6
>    option proto 6to4
>
> But firewall rules regardless do not seem to work (blocking all traffic at the router)
>
>"
80,Dave Täht,2011-04-12 16:55:02.858623,Also it seems like a good idea for radvd to default to 1280 mtu for sites using 6to4
65,Tim Upthegrove,2011-04-12 21:28:36.207546,"I have been toying with this task as my intro to OpenWRT packages, but it has been a bit of a pain (at least for a newbie like myself :).  The main issue is that the Makefile distributed with the nuttcp-6.1.2 tarball does not have a target for install, and I am unsure of how to have the OpenWRT Makefile's Package/nuttcp/install not call make install on the nuttcp Makefile.

My workaround to successfully compile and install into staging was to add a dummy install entry nuttcp's Makefile, and that seems to work fine.  I am not sure if storing our own copy of nuttcp's source is The Right Way of doing this, but I couldn't find a good way of modifying the nuttcp Makefile in the OpenWRT build process after pulling the tarball down.

Anyway, I put what I *think* is a correctly cross compiled version of the nuttcp binary and an ipk in @/tmp/tupty_nuttcp_test/@.  I am unsure of a way to test this myself, hence the reason for me not grabbing the ticket.  For the record, the ipk should install into @/root/bin/@, but that can obviously be changed if you want it somewhere else."
65,Srikanth Sundaresan,2011-04-12 22:15:32.114321,"That's cool - I've been working on testing nuttcp, though with v7.1.3. Slightly confused, though, is the file in /tmp/tupty_nuttcp_test the binary or the ipk?
"
65,Dave Täht,2011-04-13 05:09:00.894304,"Incidentally I have been fiddling with creating a package of my own.

I took an existing package (gpsd), changed the name to gpsd-mini,  
modified it to eliminate the libusb dependency, got that working on the 
wndr with a gps... then tried to update it to a later version (from 2.94 
to 2.96) last night, which broke.

So... at the moment this breaks the bismark build (thus proving the need 
to NOT do raw development against the /home/bismark/src/wndr3700 tree), 
so I've disabled it from that build as of this morning, and will move 
off to doing package development against a private tree.

Gpsd may contain an example of how to do a make install with the nuttcp 
code.

I would like to suggest moving the bismark package feed into a git tree 
(which I just did) and for folk to check their preliminary packages into 
that and push them back to the main repo so more eyeballs can be had on 
the problem.

If working remotely, the clone would be:

git clone 
ssh://bismark@huchra.bufferbloat.net/home/bismark/src/bismark-packages

or merely the path if working on packages directly on huchra in your 
private directory.

(Why gpsd? I wanted accurate TIME and possibly lat/long information, and 
was working with esr on a ntp interface. The first version of the code 
worked, but getting the gps to work required that the antenna be near a 
window. We're thinking that an interface to a atomic radio clock would 
be better, now)

I obtained the TIE code, which is lying around in ~bismark, awaiting a 
packager...

Apparently there is a bismark package in the build already, but it 
appears to be just a test package."
65,Dave Täht,2011-04-13 05:18:03.552918,You can put a patch to the makefile in the package (see gpsd-mini for an example)
82,Dave Täht,2011-04-14 17:15:19.895752,"This should drop right into 2.6.37.6 too with the right work in openwrt...

-------- Original Message --------
Subject: 	Patch ""net_sched: fix ip_tos2prio"" has been added to the 
2.6.38-stable tree
Date: 	Thu, 14 Apr 2011 16:41:22 -0700
From: 	<gregkh@suse.de>
To: 
dan@coverfire.com,chromatix99@gmail.com,davem@davemloft.net,d@taht.net,eric.dumazet@gmail.com,gregkh@suse.de 

CC: 	<stable@kernel.org>, <stable-commits@vger.kernel.org>



This is a note to let you know that I've just added the patch titled

     net_sched: fix ip_tos2prio

to the 2.6.38-stable tree which can be found at:
     http://www.kernel.org/git/?p=linux/kernel/git/stable/stable-queue.git;a=summary

The filename of the patch is:
      net_sched-fix-ip_tos2prio.patch
and it can be found in the queue-2.6.38 subdirectory.

If you, or anyone else, feels it should not be added to the stable tree,
please let<stable@kernel.org>  know about it.


 From f041eaa28a108f73cf02e7059cf0616dfd43b232 Mon Sep 17 00:00:00 2001
From: Dan Siemon<dan@coverfire.com>
Date: Tue, 15 Mar 2011 13:56:07 +0000
Subject: net_sched: fix ip_tos2prio


From: Dan Siemon<dan@coverfire.com>

[ Upstream commit 4a2b9c3756077c05dd8666e458a751d2248b61b6 ]

ECN support incorrectly maps ECN BESTEFFORT packets to TC_PRIO_FILLER
(1) instead of TC_PRIO_BESTEFFORT (0)

This means ECN enabled flows are placed in pfifo_fast/prio low priority
band, giving ECN enabled flows [ECT(0) and CE codepoints] higher drop
probabilities.

This is rather unfortunate, given we would like ECN being more widely
used.

Ref : http://www.coverfire.com/archives/2011/03/13/pfifo_fast-and-ecn/

Signed-off-by: Dan Siemon<dan@coverfire.com>
Signed-off-by: Eric Dumazet<eric.dumazet@gmail.com>
Cc: Dave Täht<d@taht.net>
Cc: Jonathan Morton<chromatix99@gmail.com>
Signed-off-by: David S. Miller<davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman<gregkh@suse.de>
---
  net/ipv4/route.c |    2 +-
  1 file changed, 1 insertion(+), 1 deletion(-)

--- a/net/ipv4/route.c
+++ b/net/ipv4/route.c
@@ -171,7 +171,7 @@ static struct dst_ops ipv4_dst_ops = {

  const __u8 ip_tos2prio[16] = {
  	TC_PRIO_BESTEFFORT,
-	ECN_OR_COST(FILLER),
+	ECN_OR_COST(BESTEFFORT),
  	TC_PRIO_BESTEFFORT,
  	ECN_OR_COST(BESTEFFORT),
  	TC_PRIO_BULK,


Patches currently in stable-queue which might be from dan@coverfire.com are

queue-2.6.38/net_sched-fix-ip_tos2prio.patch"
87,Dave Täht,2011-04-15 14:06:58.238613,"While it compiles with a patch, it does do some invasive stuff with iptables to do it's work, AND also doesn't appear to work on a modern linux at all."
82,Dave Täht,2011-04-16 06:43:00.307252,"I'd frozen openwrt april 5, and moved on to getting where we could test a bunch of routers.

That meant leaving the kernel and packaging system alone, and trying to get people focused on creating the needed packages (as well as testing and familiarizing themselves with the routers)

Felix just pushed the fix for this bug #82 into openwrt head (thx felix!)

There are a few more kernel patches that are going to land in the next week or so, and then it would be possible to freeze the kernel, update the packages, and catch up to openwrt head again, and do another round of group testing.

In the meantime, if anyone would care to test, I did a separate build of my own of the bismark stuff from openwrt head, it's at:

http://huchra.bufferbloat.net/~d/cerowrt

And it's certainly possible for others to do so from their own private builds."
89,Dave Täht,2011-04-16 09:09:04.473988,""
92,Dave Täht,2011-04-17 12:44:16.799818,"I've captured the issue in the bug database.

Could you document the syntax of time you require?"
82,Dave Täht,2011-04-17 13:05:38.994096,"I pulled git head and package head from openwrt last night (which 
includes the pfifo_fast fix) into bismark:src/wndr3700 ...

and did a new build on huchra.

I note that if you have a conversation of relevance to the bug tracker, 
you can cc George Burdell with the ticket number it is on and he'll 
update the database. On a good day, he'll even update the status for you 
as per the keywords here: http://www.redmine.org/boards/2/topics/18568

Status: Closed"
82,Dave Täht,2011-04-17 13:08:45.423807,or so I think.
92,Dave Täht,2011-04-17 18:04:19.550434,"I tossed of a quick port of the gnu time utility to the wndr3700, but 
lack the hardware to try it.

get the test binary from:

http://www.teklibre.com/~d/cerowrt/time

and let me know if it works. (you will want to remove the existing 
""time"" symlink on your router if it does). Make sure it's measuring 
accurate time...

Secondly, I started at a shared openwrt repository for some new 
packages. github doesn't need any IT resources, and is free for open 
source users, so I used their service.

See https://github.com/dtaht/ceropackages for details

You can do a read-only checkout via

git clone git://github.com/dtaht/ceropackages.git

If you want read/write access, create and/or let me know your account on 
github

You can add the above to your package feeds by editing feeds.conf adding 
this line

src-git cerowrt git://github.com/dtaht/ceropackages.git

then doing a ./scripts/feeds update

I tossed gnu time in there, but it is not fully baked yet, although I 
did a patch to make it compile manually, I didn't figure out how to do 
that right for openwrt. see commit log and Makefile for details.

You can add gnu time to (and break) your existing build by:

./scripts/feeds install time
make menuconfig # add gnu time as a module
make

I'm kind of hoping that having shown this example, someone else will 
take it through the last step of making it into a working package! :)"
92,Srikanth Sundaresan,2011-04-17 18:18:51.004791,"I just quickly tested it. It seems to be what we want, and also seems to work. Will test it properly with the script and update.

Thanks for the quick response. Was meaning to get back on the syntax email but got tied up with other stuff.

- Srikanth

On Apr 17, 2011, at 9:04 PM, Dave Taht wrote:

> I tossed of a quick port of the gnu time utility to the wndr3700, but lack the hardware to try it.
> 
> get the test binary from:
> 
> http://www.teklibre.com/~d/cerowrt/time
> 
> and let me know if it works. (you will want to remove the existing ""time"" symlink on your router if it does). Make sure it's measuring accurate time...
> 
> Secondly, I started at a shared openwrt repository for some new packages. github doesn't need any IT resources, and is free for open source users, so I used their service.
> 
> See https://github.com/dtaht/ceropackages for details
> 
> You can do a read-only checkout via
> 
> git clone git://github.com/dtaht/ceropackages.git
> 
> If you want read/write access, create and/or let me know your account on github
> 
> You can add the above to your package feeds by editing feeds.conf adding this line
> 
> src-git cerowrt git://github.com/dtaht/ceropackages.git
> 
> then doing a ./scripts/feeds update
> 
> I tossed gnu time in there, but it is not fully baked yet, although I did a patch to make it compile manually, I didn't figure out how to do that right for openwrt. see commit log and Makefile for details.
> 
> You can add gnu time to (and break) your existing build by:
> 
> ./scripts/feeds install time
> make menuconfig # add gnu time as a module
> make
> 
> I'm kind of hoping that having shown this example, someone else will take it through the last step of making it into a working package! :)
> 
> 
> _______________________________________________
> Bismark-devel mailing list
> Bismark-devel@lists.bufferbloat.net
> https://lists.bufferbloat.net/listinfo/bismark-devel"
92,Dave Täht,2011-04-17 18:23:02.673778,"On 04/17/2011 07:18 PM, Srikanth Sundaresan wrote:
> I just quickly tested it. It seems to be what we want, and also seems to work. Will test it properly with the script and update.
>
> Thanks for the quick response.
Anything to avoid finishing my taxes.

 > Was meaning to get back on the syntax email but got tied up with 
other stuff.

Well, I'll argue that making busybox's time command more complete would 
be a better option, so
knowing the syntax you need for ""time"" on this bug report would be good.

But my goal at the moment is to quickly prototype as many of the core 
requirements as possible,
so we know what needs to be done and fixed, and I figure you have a 
major dependency on accurate time."
92,Nick Feamster,2011-04-17 19:22:11.497893,"Thanks. This is cool!

Srikanth: Let me know when (and how) you'd like me to update my openwrt image.  I'm very happy to be your active and passive measurement tester/guinea pig for a home deployment. 

-Nick

On Apr 17, 2011, at 9:18 PM, Srikanth Sundaresan wrote:

> I just quickly tested it. It seems to be what we want, and also seems to work. Will test it properly with the script and update.
> 
> Thanks for the quick response. Was meaning to get back on the syntax email but got tied up with other stuff.
> 
> - Srikanth
> 
> On Apr 17, 2011, at 9:04 PM, Dave Taht wrote:
> 
>> I tossed of a quick port of the gnu time utility to the wndr3700, but lack the hardware to try it.
>> 
>> get the test binary from:
>> 
>> http://www.teklibre.com/~d/cerowrt/time
>> 
>> and let me know if it works. (you will want to remove the existing ""time"" symlink on your router if it does). Make sure it's measuring accurate time...
>> 
>> Secondly, I started at a shared openwrt repository for some new packages. github doesn't need any IT resources, and is free for open source users, so I used their service.
>> 
>> See https://github.com/dtaht/ceropackages for details
>> 
>> You can do a read-only checkout via
>> 
>> git clone git://github.com/dtaht/ceropackages.git
>> 
>> If you want read/write access, create and/or let me know your account on github
>> 
>> You can add the above to your package feeds by editing feeds.conf adding this line
>> 
>> src-git cerowrt git://github.com/dtaht/ceropackages.git
>> 
>> then doing a ./scripts/feeds update
>> 
>> I tossed gnu time in there, but it is not fully baked yet, although I did a patch to make it compile manually, I didn't figure out how to do that right for openwrt. see commit log and Makefile for details.
>> 
>> You can add gnu time to (and break) your existing build by:
>> 
>> ./scripts/feeds install time
>> make menuconfig # add gnu time as a module
>> make
>> 
>> I'm kind of hoping that having shown this example, someone else will take it through the last step of making it into a working package! :)
>> 
>> 
>> _______________________________________________
>> Bismark-devel mailing list
>> Bismark-devel@lists.bufferbloat.net
>> https://lists.bufferbloat.net/listinfo/bismark-devel
> 
> _______________________________________________
> Bismark-devel mailing list
> Bismark-devel@lists.bufferbloat.net
> https://lists.bufferbloat.net/listinfo/bismark-devel"
88,Dave Täht,2011-04-18 17:14:06.691121,I confirm that this utility does not work at present.
93,Dave Täht,2011-04-19 07:17:02.587787,"Rather than figure out what was going wrong with mountd, I removed it as a default package from the ~bismark/src/.config file, made it installable as a module, and did a new build of bismark to suit. *You will want to make mountd a modular rather than required package in your .config for your builds as well!*

CONFIG_PACKAGE_mountd=m

You can remove the mountd package from your already built routers via:

opkg remove mountd

And/or add a 
killall mountd 
to your /etc/rc.local file

*IF* there is a need for mountd in the final configuration, this bug will need to be further explored and fixed.

"
95,Dave Täht,2011-04-19 17:27:51.872041,"kmod-ipt-ipopt is not currently installed by default. It is built and can be installed manually, but has mild issues with UTC vs your timezone and has no gui interface

https://dev.openwrt.org/ticket/7229"
95,Dave Täht,2011-04-19 17:46:38.79988,"opkg install iptables-mod-ipopt # is also needed...

then you have fun installing it via a command line and rolling a script for it:


#!/bin/sh

KIDSSTART=06:00
KIDSEND=21:15
KIDSMAC=""00:0F:EA:91:04:08""

iptables -N BADKIDS
iptables -N KIDS

iptables -A BADKIDS -m time --timestart $KIDSSTART --timestop $KIDSSTOP -j ACCEPT
iptables -A BADKIDS -j DROP

for i in $KIDSMAC
do
iptables -A KIDS -m mac --mac-source $i -j BADKIDS
done

iptables -A INPUT -j KIDS # might be some other chain"
25,Dave Täht,2011-04-20 10:55:39.103035,"The primary DNS server is now shipka. The secondary is siwa. 

"
25,Dave Täht,2011-04-20 10:57:47.273794,"next up is migrating siwa to huchra, and adding DNS services to isc's secondaries

"
85,Dave Täht,2011-04-20 14:33:34.756407,"the files/etc/sysctl.conf now does the right thing in the bismark build.

The files thing needs to either be dumped into git somewhere or managed somehow as well as added to the installation instructions."
85,Dave Täht,2011-04-20 14:34:08.929619,"fixed, basically, pending a sane way to distributed the files subdir structure."
83,Dave Täht,2011-04-20 14:34:58.091695,"the fix for this in files/etc/defconfig is suboptimal.
"
79,Dave Täht,2011-04-20 14:36:37.771282,I do not know how at present to add other TCP algorithms to the build. Veno and Vegas would be good. Cubic makes no sense at all for a router.
96,Nick Feamster,2011-04-20 20:16:23.002881,Srikanth thinks that this is possibly an OpenWRT bug.  Dave?
96,Dave Täht,2011-04-21 03:37:13.278818,"The core word here appears to be ""reflashing"".

Are you flashing with the factory or sysupgrade image?

I would hope that with the factory image the system would revert to 
having telnet.

With a sysupgrade image I would hope that the passwords and ip addresses 
would remain
the same.

What you describe appears to be in the middle?"
94,Dave Täht,2011-04-21 04:08:33.229339,"The latest build has the ability for users to set regulatory domains.

Please test 'US' and at least one other domain.

"
94,Dave Täht,2011-04-21 04:14:58.422616,"In order to be able to comply with worldwide wireless standards, country specific regulatory domains need to be able to be set.

http://wireless.kernel.org/en/developers/Regulatory

Earlier in this bug documents how to change that in the conf file.

You can also easily get and set the regulatory domain via the iw command.

iw get reg
iw set reg

(I'm also trying to work out workflow issues on this bug in the hope that explicitly ""throwing responsibility over the wall"" works. Feel free to reassign/delegate.)

The lastest build (april 20) on huchra should allow full regulatory change support."
96,Nick Feamster,2011-04-21 08:34:09.01194,"I had the telnet issue both on an initial flash (with the image from 2 nights ago) and with the sysupgrade (which I performed last night).

The sysupgrade did reset the password."
94,Nick Feamster,2011-04-22 12:57:54.795648,I think this works now in the latest image update.  I tested this out and it seems to work fine.
94,Nick Feamster,2011-04-22 12:58:30.11224,""
94,Nick Feamster,2011-04-22 13:01:59.100776,""
67,Nick Feamster,2011-04-22 13:03:12.722742,"Tested out bing last weekend.

The OpenWRT build is quite noisy.  Next step will be to compare bing to iperf, etc."
94,Nick Feamster,2011-04-22 13:03:40.365163,""
67,Nick Feamster,2011-04-22 13:05:39.489439,""
96,Nick Feamster,2011-04-22 13:06:02.188886,""
88,Dave Täht,2011-04-26 09:05:17.948256,"I removed mountd from the build as a workaround (7ish days ago)

IF mountd is required it is being built as a module and should be looked into on a new bug.

But backups do not work as of my last test..."
92,Dave Täht,2011-04-26 09:10:17.461093,"So can someone sign up to make gnu time a package? I got as far as I could that day, and this looked straightforward."
103,Dave Täht,2011-05-02 07:26:30.587018,"the current rc.local looks like this, and is rather suboptimal

# Put your custom commands here that should be executed once
# the system init finished. By default this file does nothing.

/etc/init.d/ntpd stop
ntpdate 0.openwrt.pool.ntp.org
/etc/init.d/ntpd start

mount /dev/sda1 /ext &
/etc/init.d/lighttpd start

for i in eth0.1 eth0.2 eth1 wlan0 wlan1 wlan2 wlan3
do
ifconfig $i txqueuelen 16
done

exit 0
"
92,Dave Täht,2011-05-02 09:07:25.133107,""
88,Dave Täht,2011-05-02 09:07:53.248421,""
83,Dave Täht,2011-05-02 09:09:28.117217,""
73,Dave Täht,2011-05-02 09:11:19.099283,""
67,Dave Täht,2011-05-02 09:12:01.24952,""
67,Nick Feamster,2011-05-02 09:13:17.563144,""
64,Dave Täht,2011-05-02 09:14:23.37442,""
63,Dave Täht,2011-05-02 09:15:41.502121,bismark-mgmt package...
62,Dave Täht,2011-05-02 09:16:38.830649,need dns and std area for opkg
106,Nick Feamster,2011-05-02 19:51:25.472642,""
109,Nick Feamster,2011-05-02 19:51:52.117571,""
105,Nick Feamster,2011-05-02 19:55:37.560209,""
109,Dave Täht,2011-05-03 19:01:13.680939,"While I am delighted to see y'all using the bug database to capture this sort of information, it might be better to have the backend analytical stuff live in a separate subproject, as the bug/features/analysis/people involved therein mentally seems to require a fairly thin interface vs the bugs/features/people/process of getting routers created and into the field. 

I may be wrong in thinking that these should be separated into different projects.

?

So, anyway, so long as the timelines and deadlines are clearly indicated I have no problem mixing them up. Certainly being able to update devices in the field to capture the data is important, but the analysis side can lag the deployment/collection side by quite a bit.

It IS AWESOME to be capturing all this info somewhere. Thx. I had no insight into this half of things until now.

"
109,Dave Täht,2011-05-03 19:20:14.01007,"Duh. I just realized this was ALREADY a subproject. You are way ahead of me.

Is there a git tree associated with this work?"
100,Dave Täht,2011-05-03 19:23:06.803285,"We pulled from the old static branch of luci (.09) when .10 is current. Updating the feeds.conf to pull from the current branch may address this

it will also make the existing image rather unstable to try this, so I would prefer to wait until we do a complete new build and have spare routers to try it on (wednesday)"
91,Dave Täht,2011-05-06 00:01:19.320395,This is not a blocker for bismark at present. 
109,Aaron Brooks,2011-05-06 06:47:16.996608,"Instead of choosing between Adobe Flash and static plots, I'd note that there are some great libraries for creating dynamic charts and graphs in the browser such as general visualization tools like http://processingjs.org/ or more specific charting tools like http://dygraphs.com/. If you search around, I'm sure you can find a javascript library that will suit your project and provide dynamic, browser-side charts and graphs that don't require Flash."
109,Abhishek Jain,2011-05-06 08:02:22.732702,"Thanks Aaron for the suggestion.  I looked at the two links you put up, i like the dygraphs one alot.
The title of the issue wasn't very detailed. Currently we are using Open Flash Charts, http://teethgrinder.co.uk/open-flash-chart/. It is a flash based visualization embedded inside javascript. So we dont have to worry about the flash part. The problem with this tool is the computation time. It takes about 5-10 seconds to produce 50,000 points. We want something faster. Also sometimes it crashes when the data is too large. There are also other tools available for producing static graphs (PNG images). I want to explore to see if they are crash-free and faster. I'll look at the processing and dygraphs also, maybe the problem is with the tool we are using, open flash charts."
109,Abhishek Jain,2011-05-06 08:09:05.450159,"dygraphs, http://dygraphs.com/, is very cool. It has zooming/sampling/timestamp/trendline capabilities . It takes in a CSV file for data. I have an intuition that it might be faster than open flash charts.
"
92,Dave Täht,2011-05-06 20:52:50.546676,This took a lot more time than expected. GNU time is ANCIENT.
115,Dave Täht,2011-05-07 12:13:24.096022,"I had to backport two functions from 2.6.38 to make the SFB package compile in 2.6.37. 

But it now compiles and I'm off to test it in real life.

Pushed into the cerowrt repo."
102,Dave Täht,2011-05-07 21:27:28.052892,"came up with a clean way to do this using a ifup hook. Design details are in the ceropackages repo under net/debloat. Code, not yet.

see or check out

https://github.com/dtaht/ceropackages

for some more details"
92,Dave Täht,2011-05-07 21:31:14.786155,"have to regenerate a new version of capetown, perhaps, from scratch."
115,Dave Täht,2011-05-07 21:34:59.850332,""
88,Dave Täht,2011-05-07 21:38:12.969999,"I've disabled mountd entirely but web based backups using xWrt still fail.

See screenshot of web-related failures at http://www.teklibre.com/~d/bismark"
93,Dave Täht,2011-05-07 21:39:51.211382,""
101,Dave Täht,2011-05-07 21:42:38.529158,""
110,Dave Täht,2011-05-07 21:47:56.536296,"
Given what we now know about rndc and how slow named can be to restart, perhaps a kinder/gentler way than exists in files/hotplug.d/iface (rndc reload config?network?) can be used in named-latest, and regardless the method I put in place there, it needs to be tested.

Similar fix would be a good idea for dhcp, whatever works..."
116,Dave Täht,2011-05-07 21:50:58.368389,"this is a major bug. Worse, it's deeply embedded in the kernel, affecting both qdiscs and all IPv6 traffic. Fixing it would require a reflash.Rich Carlson NDT"
112,Dave Täht,2011-05-07 21:58:27.316486,"Policy routing is required to be built into the kernel. There may also be a dependency on iproute2.

There needs to be a policy routing configuration file that talks more to the ""right thing"" in the presence of multiple 2002 and 2001 tunnels as well as in the presence of native ipv6.

Then the 6to4 and 6in4 and other ipv6 scripts need to be modified to use policy routing when available.

"
117,Dave Täht,2011-05-07 22:06:38.301438,"Can you check to see what wireless throughput iperf reports in your last build and on your current router? about 16-22Mbit should be expected with wireless g or a. n should go much higher (but my laptop doesn't do that)

No need to test ipv6. 

My results were the same with qos on or off."
62,Dave Täht,2011-05-07 22:11:46.089636,"Please create a virtual web server and rsync-able site for:

capetown.yourcooldomainwhateveritiscalled.com to serve as the long term opkg database.

As the url is baked into the image, it needs to be correct AND it would help if it was up soon, like, by monday afternoon. 

I can supply an rsync.conf for the server."
79,Dave Täht,2011-05-07 22:14:41.98715,"Veno seems like a better choice than vegas. the most famous version of openwrt shipped with vegas however, and I don't know why it was changed.

I have no idea how to enable veno in the build."
83,Dave Täht,2011-05-07 22:17:50.35842,"the crux of the problems are: 

that wireless interface generation is magic, and can't have a txqueuelen attached to it directly.

that different ethernet devices have different native queue lengths in the driver

that wireless behaves differently under abgn and with different clients.

We can try to make better guesses, and have a far better default than 1000 (I'm thinking 16 is about right). There is a debloat package in the ceropackage repo for this....."
97,Dave Täht,2011-05-07 22:24:02.361469,I did actually spend some time looking this over. It seems to be merely a matter of collecting the valid proto and field types and slamming them into the script/css... if I knew what script it or where else I needed to go I can do the grunt labor here.
100,Dave Täht,2011-05-07 22:27:24.918607,hopefully this is an easy fix. somewhere.
119,Dave Täht,2011-05-07 22:32:07.556803,"evan and peter collaborated on finding and fixing the bug.
peter pushed out 82.1
xMff pulled it into openwrt head.
All better now!"
94,Dave Täht,2011-05-07 22:34:19.270085,""
81,Dave Täht,2011-05-07 22:37:58.761013,must have been my laptop
67,Walter de Donato,2011-05-08 10:21:09.882005,"I made some tests:
- I modified arping (version 2.09) to send padded ARP requests. As I expected such request can't be greater than the MTU size (at least using the libnet framework). The resulting ARP replies are equivalent in size to a void UDP packet. Generating 10000 arp requests over a 802.11g link with excellent signal I wasn't able to obtain a router-to-host rate bigger than  300Kbps. 
- Using bing on the same link estimates a 16Mbps rate.

I think we can follow this plan:
- we can use bing as a first quick solution to estimate wireless throughput
- we can try to implement the same algorithm by using ARP instead of ICMP echo (most Windows hosts are configured to drop pings by default). "
56,Dave Täht,2011-05-08 11:12:41.195048,How long will it take to port to ash?
120,Dave Täht,2011-05-08 11:14:13.536064,"where does it pick up the default country code, too?"
125,Steven  Bauer,2011-05-08 11:23:16.516617,"Lets discuss... most ECN ""problems"" are caused by network elements of one sort or another (routers, switches, load balancers, etc).

So a ECN *server* blacklist perhaps isn't quite the right thing.  Moreover, ECN problems can be introduced by a device very close to the client.  For such a client, essentially the entire Internet would have to be blacklisted.   (This in fact was exactly the case at my lab before it was fixed.)  

Now, perhaps your point is there are servers that have topologically close problems and those could reasonably be put on a global list so everyone doesn't go negotiating an ECN connection that ends up broken.    Could be fairly large list.  But even here since ECN brokenness is a path issue, the blacklist might not be correct for some clients depending upon the network topology and the location of the problems.



"
56,Srikanth Sundaresan,2011-05-08 11:29:30.701206,The bismark-mgmt were ported without much problem; I will do the same for bismark-active. They shouldn't need bash.
88,Dave Täht,2011-05-08 12:27:10.934831,"The uhttpd web daemon does not handle more than one request at a time, and was sleeping while waiting for the file to download, thus blocking the file download. 

The fix is now in xWrt head and in the current capetown build

Thx Travis!"
116,Dave Täht,2011-05-08 12:28:45.987647,"and is now in openwrt head for 2.6.38 and 2.6.37 builds

See the bugzilla for more details."
100,Dave Täht,2011-05-08 12:43:18.05722,"Marked improvement. The web interface does not spew garbage anymore...


<dtaht> I add a network. Yea. No boom
<dtaht> I hit save changes. Yea. No boom
<dtaht> I apply changes
<dtaht> uhttpd hangs seemingly permanently (over a minute thus far). I hit
	reload... Still hangs. I go to the main portion of the http
	url... Still hung...  [13:40]
<dtaht> (I closed the other two bugs)
<thepeople> when applying on the network?  [13:41]
<dtaht> add a network named ""bla""  [13:42]
<dtaht> hit save changes
<dtaht> hit apply changes
<dtaht> don't bother configuring the network before applying
"
115,Dave Täht,2011-05-08 16:56:53.53943,but better qdisc scripts are needed.
92,Dave Täht,2011-05-08 16:58:18.943425,switched to using his version instead of mine.
117,Dave Täht,2011-05-08 16:59:19.942937,brian poole gets much better results at 2.4 than I did.
55,Dave Täht,2011-05-08 17:15:24.21179,"are in separate ""products"" now.

Still have a few things to universally do, but this unclutters the bug database some."
100,Travis Kemen,2011-05-08 17:19:52.071512,""
112,Dave Täht,2011-05-08 17:28:39.770456,""
50,Dave Täht,2011-05-08 17:34:15.53512,is it stable/usable enough to embed in the image?
87,Dave Täht,2011-05-08 17:36:02.588032,but it did look promising at one point. Pushing this back a while
43,Brian Poole,2011-05-08 17:49:31.059075,Active measurement tools are now packaged in bismark-active. Needs to be tested. Sri or Walter maybe? 
42,Brian Poole,2011-05-08 17:50:33.046519,Are we still going to have any registration steps? The box's ID is now being generated automatically on start of bismark the first time based on MAC.
50,Brian Poole,2011-05-08 17:54:14.023617,"We are already embedding D-ITG in the image (bismark-active has a dependency to it.) We are running the latest version available which is admittedly a beta.

root@OpenWrt:~# opkg info ditg
Package: ditg
Version: 2.7.0-Beta2
Depends: libpcap, libstdcpp
Provides:
Status: install user installed
Section: net
Architecture: ar71xx
Maintainer: Giovanni Di Stasi <giovanni.distasi@unina.it>
MD5Sum: 94746276ec265bd4e43bd36153f29fe2
Size: 106101
Filename: ditg_2.7.0-Beta2_ar71xx.ipk
Source: feeds/packages/net/ditg
Description: D-ITG (Distributed Internet Traffic Generator)
Installed-Time: 1304894767


Walter, any clue as to whether that is stable or if we need to roll a custom package for an older (non-beta) version?"
61,Brian Poole,2011-05-08 17:56:03.95623,We have a pretty clear layout now as evidenced by bismark-mgmt. Closing ticket.
79,Dave Täht,2011-05-08 20:19:05.5038,""
126,Dave Täht,2011-05-08 20:33:31.048759,"http://support.f5.com/kb/en-us/solutions/public/9000/000/sol9067.html

constructing a fe:vlan::eui/64 seems closer to the right thing. 
"
128,Dave Täht,2011-05-08 20:36:31.150837,""
128,Dave Täht,2011-05-08 20:37:11.377611,""
50,Walter de Donato,2011-05-10 02:35:30.964194,"Also if the 2.7.0-Beta2 is not a stable, older stable versions may be worst, 
because we solved some severe bugs in it.
The best choice would be to use the 2.8.0 version which we are going to release soon,
but I don't know if not having yet the package publicly available represents a problem.

As a conclusion, because we are short in time, I think we can freeze D-ITG at version 2.7.0-Beta2."
132,Dave Täht,2011-05-10 05:58:26.260815,"I have a new set of firewall rules that do work, however they rely on a change to the initial setup in the wifi utility that is not baked yet."
120,Dave Täht,2011-05-10 06:09:55.089723,"web interface can now change the default to south africa for both radios.

"
83,Dave Täht,2011-05-10 06:23:20.393288,"debloating txqueuelen works on non-bridged devices but fails on bridged.

running things like ifup interface and ifdown interface show the underlying bridge interface being passed as ""DEVICE"". I guess brctl could be called to get the underlying interfaces but parsing brctl show is mildly painful.

root@OpenWrt:/tmp# brctl show 
bridge name	bridge id		STP enabled	interfaces
br-lan		8000.c43dc78b6e1a	no		eth0.1
							wlan3
root@OpenWrt:/tmp# brctl show | awk '{print $4}'
id
eth0.1


A log (the first one is the one that needs to be fixed

USER=root
ACTION=ifup
PROTO=static
HOTPLUG_TYPE=iface
LOGNAME=root
PATH=/bin:/sbin:/usr/bin:/usr/sbin
INTERFACE=lan
PWD=/
DEVICE=br-lan
dollar splat
iface
USER=root
ACTION=ifup
PROTO=static
HOTPLUG_TYPE=iface
LOGNAME=root
PATH=/bin:/sbin:/usr/bin:/usr/sbin
INTERFACE=guest
PWD=/
DEVICE=wlan0
dollar splat
iface
USER=root
ACTION=ifup
PROTO=static
HOTPLUG_TYPE=iface
LOGNAME=root
PATH=/bin:/sbin:/usr/bin:/usr/sbin
INTERFACE=babel0
PWD=/
DEVICE=wlan1
dollar splat
iface
USER=root
ACTION=ifdown
PROTO=dhcp
HOTPLUG_TYPE=iface
LOGNAME=root
PATH=/bin:/sbin:/usr/bin:/usr/sbin
INTERFACE=wan
PWD=/
DEVICE=wlan2
dollar splat
iface
USER=root
ACTION=ifup
PROTO=static
HOTPLUG_TYPE=iface
LOGNAME=root
PATH=/bin:/sbin:/usr/bin:/usr/sbin
INTERFACE=guest5
PWD=/
DEVICE=wlan4
dollar splat
iface
USER=root
ACTION=ifup
USER=root
ACTION=ifup
PROTO=static
HOTPLUG_TYPE=iface
LOGNAME=root
PATH=/bin:/sbin:/usr/bin:/usr/sbin
INTERFACE=babel0
PWD=/
DEVICE=wlan1
dollar splat
iface
USER=root
ACTION=ifdown
PROTO=dhcp
HOTPLUG_TYPE=iface
LOGNAME=root
PATH=/bin:/sbin:/usr/bin:/usr/sbin
INTERFACE=wan
PWD=/
DEVICE=wlan2
dollar splat
iface
USER=root
ACTION=ifup
PROTO=static
HOTPLUG_TYPE=iface
LOGNAME=root
PATH=/bin:/sbin:/usr/bin:/usr/sbin
INTERFACE=guest5
PWD=/
DEVICE=wlan4
dollar splat
iface
USER=root
ACTION=ifup
PROTO=static
HOTPLUG_TYPE=iface
LOGNAME=root
PATH=/bin:/sbin:/usr/bin:/usr/sbin
INTERFACE=babel1
PWD=/
DEVICE=wlan5
dollar splat
iface
USER=root
ACTION=ifup
PROTO=dhcp
HOTPLUG_TYPE=iface
LOGNAME=root
PATH=/bin:/sbin:/usr/bin:/usr/sbin
INTERFACE=wan
PWD=/
DEVICE=wlan2
dollar splat
iface
"
134,Dave Täht,2011-05-10 15:19:15.757503,""
42,Walter de Donato,2011-05-11 02:42:42.561138,"We'd need geolocation information in some way. 
For now we can rely on server-side IP-to-Location associations (very bad accuracy).

In the future we should provide a way to let the user give us such information.
The proposal is to intercept the first HTTP request (like a captive portal)
and let the user submit a web form. 
The web form could be part of the OpenWRT interface or directly a page on the management server."
61,Walter de Donato,2011-05-11 03:05:04.945019,""
134,Dave Täht,2011-05-11 06:19:39.811942,"If the channel is not in the wireless file, it is not displayed in the web interface to be changed. I would argue that it should always be displayed and if not in the config file, pulled from iw.

For us, I have changed the wifi creation shell script to put in the channel by default.

"
134,Dave Täht,2011-05-11 06:32:22.555711,"And for all I know it was there, and I was just going blind. That said, I needed to change the default channel in the script anyway."
133,Dave Täht,2011-05-11 11:54:31.839468,And the results were GOOOD
136,Walter de Donato,2011-05-12 08:51:54.355335,"What you observe is a lot of recovery tunnels beeing created because bismark-probe is not able to talk to the bdm daemon. I disabled the closure of old recovery tunnels in the past (while using a recovery tunnel it was annoying to be thrown out after a some time), but I'm going to re-enable it in a different way.

In the specific case the device is not able to contact the daemon on UDP port 53 (which is the default one we use). Probably a firewall rule is blocking such packets towards WAN to force using local DNS servers.

Brian: can you investigate on the presence of such firewall rules at GaTech? 
I didn't find such rule on the device itself. 
It may also be implemented by the ISP (which doesn't seem to be the case).

To avoid such problem in the future I'm going to add to bismark-probe a round-robin schema using several port numbers (the daemon already listens on both ports 53 and 5353) and switching port when not receiving replies.
"
138,Dave Täht,2011-05-12 15:24:10.450991,"I ""improved"" the defaults to

A) Use the system DNS resolver always
B) Set the CacheIsShared option
C) use up 10MB by default
D) Listen on ipv6
E) Query on both ipv4 and ipv6 addresses, but prefer ipv4
F) default to only allowing the default address/24 on the lan to access the proxy

Polipo would be better if it talked to the internal resolver in a threaded manner. I don't think it will be a win in this configuration for larger numbers of users.

I've tested it as a ipv4 and ipv6 proxy doing ipv6/ipv4 <-> ipv4/ipv6. There appears to be a firewall issue for pure ipv6 to ipv6 transfers via the proxy at present (this is ironic)

With these fixes in place polipo seems to function fairly well, however, for a single user.

It will need hand configuration (via vi) for core lan changes, etc. There is no web interface.

"
138,Dave Täht,2011-05-12 15:24:36.734952,""
62,Dave Täht,2011-05-12 15:26:05.254484,need to get access to the d4 server to get this setup... 
132,Dave Täht,2011-05-12 18:25:37.516825,"you should not be able to access machines (except via ping) from the guest to the private network now.

If you can set up a machine on the guest network and a machine on the private network, see if you can get through from private to guest, but not from guest to private"
132,Dave Täht,2011-05-12 18:25:52.21888,""
127,Dave Täht,2011-05-12 18:27:16.22688,I have a long list of little things and gotchas...
96,Dave Täht,2011-05-12 18:29:07.776458,"The default behavior seems to be to require a reboot after a reflash for ssh to work right, and to update the password from the web interface to make ssh work as well.

Please verify this is the procedure required.

"
79,Dave Täht,2011-05-12 18:30:26.016879,but I would rather push the package upstream to openwrt and worry about this later.
133,Dave Täht,2011-05-12 18:32:14.574904,"I will still argue that tuning red properly to assert ECN is a black art, and that the qos-scripts could use some love. However that is a bigger project than I can take on right now, and they seem to work fairly well as is."
138,Dave Täht,2011-05-12 18:35:29.857453,"Tested right now on latest build, polipo works. 

It works for ipv4 to ipv4 and ipv6 to ipv4 transfers. The ipv6 to ipv6 bug is an artifact of the currently borked ipv6 support.

It does require hand configuration of the file to account for a few things and added features, which need to be documented on the wiki.

"
56,Dave Täht,2011-05-12 18:37:17.142713,"If so, please close this bug before release."
62,Dave Täht,2011-05-12 18:38:16.812458,Bad...
63,Dave Täht,2011-05-12 18:40:41.393722,"but the existing packaging seems to work, so I'm closing this bug."
50,Dave Täht,2011-05-12 18:44:58.453399,"It must not be a dependency that works.

When installed manually 

opkg install ditg

Pulls in a bunch of files. 

I have no idea how to test whether it works or not. IF it works, I'll bake it into the build.

Please test or document HOW to test.

"
136,Dave Täht,2011-05-12 18:49:39.014093,""
60,Dave Täht,2011-05-12 18:51:31.990693,Can we make it point to a DNS name we can change freely? Please?
80,Dave Täht,2011-05-12 18:55:08.885724,""
84,Dave Täht,2011-05-12 18:56:28.642351,"However, the tc utility has not been updated to suit and it is thus, hard to configure."
84,Dave Täht,2011-05-12 18:56:39.245404,""
49,Dave Täht,2011-05-12 19:01:13.745587,"the httpping beta is not (it has useful http 1.1 persistent connection support) and will not be released for some time.

Please test httpping as it exists....

If it works..."
135,Dave Täht,2011-05-12 19:03:55.685198,as later on conntrack gets re-inserted and life is good. Still...
67,Dave Täht,2011-05-12 19:06:52.792961,"arping is in the build...

as is bing...

script from here?"
67,Dave Täht,2011-05-12 19:10:57.393361,"it is hard to tell when stuff is going over the wireless.

Stuff going over wireless DOES explicitly happen over the guest networks, and as we have a REAL webserver, as well as rsync installed, we can do something like mini speedtest by default - which, unfortunately requires php right now. Doing it in ash would be best, although python is available.

We could set it up something like speedtest.home.lan on the router webserver.

http://speedtest.bufferbloat.net/index-php.html

It would be mildly better to have something that phoned home with the results, tho.

AND IF THIS IS NOT NEEDED BY NEXT WEEK, please change the deadline to suit."
65,Dave Täht,2011-05-12 19:13:00.857626,"Is this a dead packaging project currently? Is it needed by next week?
If not please put in a deadline for it...."
50,Dave Täht,2011-05-12 19:17:13.478667,"I will put the underlying libs for D-ITG in the build, so as not to impact flash as much.

We HAVE finally exceeded 8MB however, sadly enough. We were still able to support the wndr3700v1 until a few days ago... Sigh.

Still, please confirm that it works via opkg install and testing (documentation on the wiki would be nice) and I'll slam the whole thing in the build."
83,Dave Täht,2011-05-12 19:32:16.9541,just reset the queue lengths down on the known bridged interfaces.
50,Walter de Donato,2011-05-13 04:33:10.586589,"Since the ditg_2.7.0-Beta2_ar71xx.ipk package contains some not-needed components,
we can recover some space if we decide to put a customized package on the huchra repository.

Anyway, I can add instructions to test it on the wiki (just for the use we need it for).
We have a test script, but it requires a lot of storage space to work."
49,Jim Gettys,2011-05-13 05:10:46.414209,"you really want to use the 1.5.1 beta to get a true TCP ping, using persistent connections.  The older versions are measuring the TCP open time + time to do an HTTP get, along with (IIRC) a DNS lookup. 
"
136,Dave Täht,2011-05-13 06:15:51.351587,"I'm not willing to ship routers containing this bug to south africa. Unmodified, they will stay up for only a few days before crashing.

I will rip bismark completely out of the build before shipping routers containing this bug.

Status update, please.

"
136,Walter de Donato,2011-05-13 06:31:43.888899,"I'm working on it, the fix is almost completed."
145,Dave Täht,2011-05-13 06:44:07.088293,""
144,Dave Täht,2011-05-13 06:46:04.076909,""
143,Dave Täht,2011-05-13 06:51:28.495063,""
49,Jim Gettys,2011-05-13 08:29:59.225981,"Heh.

It's been in ""beta"" since I was working with Folkert last early fall; he just hasn't declared it a release.

The persistent connection stuff has been in the Android version of httping for many months.

I can poke him to release it, if you like."
136,Dave Täht,2011-05-13 08:54:55.585559,"After running overnight...

root@OpenWrt:~# ps -aux | grep bismark | wc -l
75

Router running the code was nearly hung completely. DNS failed to work, routing had failed."
136,Walter de Donato,2011-05-13 09:10:48.434589,Fixed both UDP port 53 only problem and recovery shells stacking.
136,Dave Täht,2011-05-13 09:33:04.102327,"As point of procedure, when solving a bug this severe, it is not ""closed"" until someone other than the primary developer tests in a clean-room environment. 

So it should be changed to ""feedback"", and the developer or should assign someone to test it. If the developer does not know who is to test, he should assign the bug to the manager to test or delegate....
"
111,Abhishek Jain,2011-05-13 09:50:32.422361,Partially Done. Now has the ability to choose params and date ranges from pulldown menus.
109,Abhishek Jain,2011-05-13 09:51:47.338592,"dygraphs are far superior to other graphs. Evaluated multiple graphs, could not find a better fit."
147,Srikanth Sundaresan,2011-05-15 18:32:07.891643,"Complex. Once the main DHCP server (that gives out the lease) has a cache, the wan interface is able to get an address. 

Behavior is udhcpc polls continuously for a DHCP address when the link is down. When the link goes up, theory is unless the main router has an ARP cache for the secondary router, it fails to provide an address.

"
149,Dave Täht,2011-05-15 19:13:16.675935,"Guest interfaces are a feature of the original firmware that I duplicated in this design. 

See also:

http://www.eff.org/deeplinks/2011/04/open-wireless-movement

It would be good if there was a way to disable them by default, but the three underlying ways to do so all have problems.

1) Disable the radios. This of course has the side effect of disabling the private interfaces as well.

2) Delete the guest interface. This blows up the firewall and QoS rules were a guest network were to be created again.  

3) Don't have guest interfaces. This has the same problem as 2, in the case of a guest interface, getting working firewall AND QoS rules is tricky in the first place.

I would prefer to deploy this feature and see how actual users deal with it."
148,Dave Täht,2011-05-15 19:15:42.339536,"In the case of a working mesh node somewhere, babel enables connectivity to the internet even when the main link is down.

You are visiting the offices of the mesh potato. I personally had an interest in showing off this feature to them, but it is not required for your own deployment. 

It is, however, required so I can get to the office from the lab, and vice versa, at present. 

"
147,Dave Täht,2011-05-15 19:18:56.112234,"There are patches that landed in main openwrt and my mailbox over the last few days that revise link-state negotiation somewhat. They may help. They may hurt. As extensive QA has already been performed down to the kernel level, and fiddling with such a complex, critical system at this late date introduces other risks, I would prefer to not deal with this one, as it seems hard to reproduce.

unless this proves a serious problem (please, more people duplicate) I would prefer to remain frozen so that future routers can be updated via opkg rather than a complete new sysupgrade."
146,Dave Täht,2011-05-15 19:22:31.70365,"we so far as I know haven't promised these to anybody, and the brick on my hands refuses to respond even to tftp. 
 
I would prefer all our eggs to be in multiple baskets, but until the reason for bricking is well understood (which may take jtag to resolve), risking the other one of these on the project is not a good idea. If we had several, and time...

If someone would like to take on making the buffalo router work at this point, great. Otherwise, we lack time to pursue this further at this point. "
150,Dave Täht,2011-05-15 19:48:48.87148,"Rather than use serially generated artificial keys I decided to kill this problem the git way, by using sha1 hashes throughout as artificial keys. This eliminates the contention/serialization problem completely, at the expense of 20 bytes per key and compute intensiveness of the sha1 calculation on inserts.

It should greatly ease distribution and replication of the data, as well.

Regrettably more coding remains than I would like on getting the core functions and triggers to work properly, and it's still unclear as to what additional headaches django will introduce."
104,Dave Täht,2011-05-15 19:56:18.734132,"In order to speed up queries by several orders of magnitude, many, many, many changes have been made to the database design.

I urge you to git clone the work in progress on huchra. The most user visible change is that there are now per-test tables rather than a single ""measurement"" table. 

Many of the other changes involve a more comprehensive and complete port to postgres, using native data types for macaddr and ip, as well as ""sql domains"" to make managing the data types simpler, and much much more. 

Once fixing the underlying database is performed it should be possible to do more comprehensive analysis on saner subsets, at much higher rates of speed. 

That said, porting the old data over to the new database is proving to be a ""female dog""."
149,Nick Feamster,2011-05-16 02:14:13.960214,I tend to agree with Srikanth here.  The interface was pretty difficult to understand.  
104,Dave Täht,2011-05-16 03:39:12.122543,""
131,Dave Täht,2011-05-16 03:41:06.277805,I have not made these the default.
51,Dave Täht,2011-05-16 03:42:12.464248,I'm taking it as a ticket
61,Dave Täht,2011-05-16 03:46:35.776996,""
132,Dave Täht,2011-05-16 04:18:10.896795,"from private to guest - works, from guest to private doesn't. This is correct."
151,Walter de Donato,2011-05-16 07:11:19.143199,"Actually, dnsdelay and dnsfail are kept only for backward compatibility, 
because we added the distinction between caching and no-caching after a while.
Thus we don't need them anymore.

Going to the main question: we decided to store all the measurement results using a common format.
The DNSFAIL parameter tells us how many queries where not replied: each measurement currently tries 10 different queries towards 2 DNS servers (local and opendns). Thus it doesn't represent the error status of a single query.

Following your proposal we can add a column to store the returned status of measures and let this specific measure return the number of failed queries (different kind of measures may have different meaning about this parameter).
To do that we need to slightly modify the XML file we use to send data from the device to the server.
"
154,Nick Feamster,2011-05-16 12:43:43.115734,""
154,Nick Feamster,2011-05-16 12:44:24.928017,""
152,Nick Feamster,2011-05-16 19:34:13.077482,""
73,Nick Feamster,2011-05-16 19:35:03.711081,""
107,Nick Feamster,2011-05-16 19:36:15.897117,"If the FCC application will show passive usage statistics (will it?), we will need to insert passive capture into the DB."
146,Nick Feamster,2011-05-16 19:40:32.020383,""
96,Nick Feamster,2011-05-16 19:42:27.748993,Telnet is no longer an option.  Removed the telnet option from the documentation on wiki.
43,Nick Feamster,2011-05-16 19:44:17.523016,""
62,Nick Feamster,2011-05-16 19:45:15.482246,""
154,Nick Feamster,2011-05-16 19:46:28.679497,""
77,Nick Feamster,2011-05-16 19:47:39.741197,""
67,Nick Feamster,2011-05-16 19:56:15.211533,""
104,Nick Feamster,2011-05-16 19:57:32.548157,""
141,Nick Feamster,2011-05-16 19:58:06.799267,""
144,Nick Feamster,2011-05-16 19:59:47.759015,""
127,Nick Feamster,2011-05-16 20:01:10.614391,Document features and bugs.
57,Nick Feamster,2011-05-16 20:03:32.482729,""
47,Nick Feamster,2011-05-16 20:05:19.378281,""
72,Nick Feamster,2011-05-16 20:06:39.350155,""
52,Nick Feamster,2011-05-16 20:09:02.420514,""
50,Walter de Donato,2011-05-17 06:36:48.804148,"We (me, Antonio and other D-ITG authors) decided to release the 2.8.0-rc1 version in days.
Then, since our measurements need some features not available in 2.7.0 version, 
the next step is just to update the OpenWrt package Makefile to point to the new version URL.
Such version has already been extensively tested and can be considered a stable.


"
157,Dave Täht,2011-05-17 09:28:43.763866,"There is another version of traceroute in the opkg repository.

Will the existing tcptraceroute there work for you? 

opkg update
opkg install tcptraceroute.

If not multiple other traceroute tools exist. Pick one...

lft                             	The alternative traceroute and whois tools for network engineers
mtr                             	Full screen ncurses traceroute tool
tcptraceroute                   	A traceroute implementation using TCP packets.
tcptraceroute6                  	A TCP/IPv6-based traceroute implementation
"
157,Dave Täht,2011-05-17 09:31:10.389459,""
155,Dave Täht,2011-05-17 09:32:45.337716,"You now have the admin password for the bismark related mailing lists. 

You are also on the list for notifications of issues like spam and problems with new signups."
153,Dave Täht,2011-05-17 09:34:03.819197,"AND PDUS...

TODAY.

Please note the group request, these two users should share a unix group."
151,Dave Täht,2011-05-17 09:40:00.988724,"I added an integer column ""exitstatus"", defaulting to -9999 to the table templates.

0 = success

any other code could eventually mean something. 

The code is in git in the usual place and it is now very easy to build a postgres database on your own machine, using ""make"" in the schema directory. 
"
150,Dave Täht,2011-05-17 09:47:37.827092,"I spent some time last night thinking about this performance sucking requirement of django's.

Does it work with database views? Is there a way to just grant access read-only to a view and NOT have the darn thing require a key on tables that are only read and never modified in django?

About the only thing I can think of trying right now is to have two different schemas in the database, actually taking advantage of TWO django bugs in one, where django can't see into another schema at all.

So the public schema would contain read/write data, and the bismark.whatever schema would contain the data being created by the tools, and the public schema would then have read only views of the other data.

so as an example, 

create view dnswhatever as select * from bismark.dnswhatever;

So if I try this, this would force a change to the scripts to select a different schema to write into... as somehow, on connecting to the database, they'd have to do a:

set search_path bismark, pg_catalog

This kind of solves part of a security problem, too.

Maybe. If django doesn't gripe at the idea.


"
157,Dave Täht,2011-05-17 15:44:19.534685,"the LFT tool looks very promising as a more general purpose traceroute.

I will enable it in tonight's build.

http://en.wikipedia.org/wiki/Layer_four_traceroute"
153,Nick Feamster,2011-05-17 16:23:38.004464,Accounts have been requested.
150,Dave Täht,2011-05-17 21:25:10.998771,"Django has no support for composite keys or complex queries of more than one table. It doesn't care for views, either.

This makes it highly unusable for complex data analysis, data editing, or really anything more complex than single table interactions.

There are multiple other web frameworks with more flexibility regarding database interactions:

Rails + http://compositekeys.rubyforge.org/
Catalyst: http://www.catalystframework.org/ (perl) (I think)
Lift: http://liftweb.net/ (scala)

I guess that offering ODBC or native postgres access to researchers is not an option?
"
157,Dave Täht,2011-05-17 21:49:08.91797,"you should be able to install and play with lft now, even on a router that is not from the current build. "
148,Dave Täht,2011-05-18 14:17:52.990426,Can't change this layer of the build at this point. Noted in the release notes.
149,Dave Täht,2011-05-18 14:19:33.229796,"I would prefer feedback from the field on this feature. Nor can I fix this layer of the build without breaking firewall rules left and right.

Noted in the release notes and installation guide."
105,Dave Täht,2011-05-18 14:28:57.167048,"Please see demo at:

http://143.215.205.198/

And comment, soon.

If it were up to me, I'd cut everything from software on down, move the ""papers"" link to point to the main site for papers (and add it to the menu at the bottom, push people into credits, as well as move more information also to a link to the main site, somewhere.

You can't update this page in the field easily...

And I need to commit it to the build, yesterday.

get into your bismark-chrome repo
git pull
make your edits
git push

Say when..."
131,Dave Täht,2011-05-18 14:30:47.229562,"Fixing this requires changing an autoconfig script in the build.

Too dangerous to tweak that now. Release noted."
135,Dave Täht,2011-05-18 14:31:57.267278,"it looks as tho this problem is corrected later on in the boot, and this feature is not used until much later on in the boot."
49,Dave Täht,2011-05-18 14:34:12.827136,"I'll get it ported for iscwrt next week, but for now... moving the target date

httping is not in use by any bismark scripts at present, anyway, so it's a moot point."
50,Dave Täht,2011-05-18 14:39:03.21004,"The problem is that this gets baked into the image, so changing it in the field requires wasting flash, AND doing a new build of the package, and a full associated (roughly 2 day) QA round of the router, and potentially having two versions of this tool in the field will lead to problems in the data.

I'll have to bake the existing tool into todays image. I did not intend to have to do more QA at this level at this late date, and would prefer to slip the date of the ""final"" image to whenever this lands move the associated QA to that.

Do you have a target date for the next version?

What will the upgrade change/break?"
127,Dave Täht,2011-05-18 14:42:38.910987,"Draft installation guide and FAQ are up on the wiki: [[Capetown]]

Please review, embrace, and extend.

Release notes are next, but I want to get another build done...."
56,Dave Täht,2011-05-18 14:44:02.559413,"My assumption is no... but I don't want to assume this.

Please close this bug if bash is no longer required."
141,Dave Täht,2011-05-18 14:46:32.252443,but it needs more. Please review
56,Walter de Donato,2011-05-18 15:06:19.221768,""
150,Dave Täht,2011-05-18 15:21:48.44066,""
153,Dave Täht,2011-05-18 15:25:06.04683,I now have the accounts and am scrambling now to get stuff configured.
163,Dave Täht,2011-05-18 15:45:36.071947,"Also taking time out to write documentation on how others should use your tool on the wiki would be nice. It is always best to do QA on the tools of others. Spread the information around...

Please also add stuff to the [[CAPETOWN INSTALLATION GUIDE]] [[CAPETOWN RELEASE NOTES]] and [[CAPETOWN FAQ]]"
163,Dave Täht,2011-05-18 16:07:28.480477,""
164,Dave Täht,2011-05-18 16:17:55.768349,""
129,Dave Täht,2011-05-18 16:26:59.974837,""
129,Dave Täht,2011-05-18 16:28:40.019891,""
166,Nick Feamster,2011-05-18 16:37:12.58583,"You mentioned needing a place for downloads.

Can you do that under projectbismark.net?

On dp4, the location is /var/www/bismark

Thanks!"
105,Nick Feamster,2011-05-18 16:42:36.891852,"I'd like the papers and people on the front page for projectbismark.net.  

I agree about moving it off the page for the router.

I'll implement.  I've pulled a copy of the page and will work on that and other improvements on the flight."
105,Nick Feamster,2011-05-18 16:47:33.382282,"Font size too large, margins too small"
167,Dave Täht,2011-05-18 18:07:24.71768,""
105,Dave Täht,2011-05-19 07:41:50.591595,"I recommend looking at the margin size on a window that is 800x600 or less. 

I agree the font size is too big, particularly in that respect.

Secondly, I am going to bake what we have into the build today, whatever it is, in about an hour."
164,Dave Täht,2011-05-19 08:26:03.326811,"I take it the PDUs did not come?

I'm willing to stick around through the weekend (taking it OFF, AND not billing) if these are going to arrive somehow. The proposed revision to DIT-G makes me nervous about committing to a final build anyway. "
164,Nick Feamster,2011-05-19 09:36:46.847128,"I just checked, and they were not yet ordered. :-(

Let me re-initiate.  Can you send the pointer again?  I will try to overnight them.

-Nick

On May 19, 2011, at 5:26 PM, gburdell@lists.bufferbloat.net wrote:

> 
> Issue #164 has been updated by Dave Täht.
> 
> 
> I take it the PDUs did not come?
> 
> I'm willing to stick around through the weekend (taking it OFF, AND not billing) if these are going to arrive somehow. The proposed revision to DIT-G makes me nervous about committing to a final build anyway. 
> ----------------------------------------
> Bug #164: Need PDUs
> https://www.bufferbloat.net/issues/164
> 
> Author: Dave Täht
> Status: New
> Priority: Urgent
> Assignee: Nick Feamster
> Category: 
> Target version: Boxes ready for South Africa deployment
> 
> 
> In order for me to continue working on this remotely, the PDUs are required.
> 
>"
167,Nick Feamster,2011-05-19 10:54:01.824698,Fixed.
150,Dave Täht,2011-05-19 11:52:18.105705,"I had sent this email, so I am documenting it here now.

...

I have no idea how to do complex analysis in django at this point. Lacking support for views, and compound keys, or even a way to generate sql directly(?)... I fear it is completely impossible.

I put up some suggestions for alternatives in this bug, earlier.

Please write a short requirements document detailing the various reports we need to generate, what tables they need to access, how they need to organize their data, and put it on the wiki. An estimate for number of users by type of user, and of devices, and of the different tests, would be useful to have in order to design this properly with goals of results in less than 8 seconds, preferably closer to 20ms.

Perhaps we can come up with something that works.

http://www.bufferbloat.net/projects/dashboard/wiki/Wiki

Also clearly describe the web page interface ab was working on yesterday. It looked like you needed to access 4 tables to get the page you wanted.

Some of this can be made easier, some may prove impossible, and without a bigger picture I can't tell....

Sri, what are the reports you generate? Can you provide sample queries?

Are other people generating other reports?"
168,Dave Täht,2011-05-19 12:47:49.411584,""
169,Dave Täht,2011-05-19 14:59:47.884122,""
168,Nick Feamster,2011-05-19 17:54:04.470544,"Strange.  In the old build, I've got an uptime of around 20 days, and DHCP is working fine.

Let's try a new build out in the house I'm staying in tomorrow.

I'd like to figure out how to daisy chain these switches, as well."
171,Dave Täht,2011-05-19 20:51:20.357027,"That's very close to what it is set to.

It was my best guess....

Next build."
170,Walter de Donato,2011-05-20 07:49:16.484162,"We defined the ZONE to let the Management Server
assign to devices Measurement Servers
preferably located in the same Zone.

For South Africa such parameter should be set to ""SouthAf"".

"
171,Nick Feamster,2011-05-20 10:49:16.211093,"It actually occurred to me that this rate limiting stuff is really going to mess with our bandwidth tests.  We're going to be measuring the QoS shaper on the router, not the capacity of the access link (unless there's a way for our tests to evade the shaper... is there?)

Perhaps what we should do is give the user the option to turn it on?"
171,Dave Täht,2011-05-20 13:23:42.498155,"in your test script:

/etc/init.d/qos stop
do your test
/etc/init.d/qos start

"
171,Dave Täht,2011-05-20 13:24:02.923766,"In fact, doing your tests with it on and off is useful..."
172,Nick Feamster,2011-05-20 16:37:46.730742,I completely agree.  This'll be an excellent piece of info.
171,Dave Täht,2011-05-21 06:37:09.257743,"It is shocking at just how good connections from south africa - incredibly long RTT times, but Packet drops are reschedules are minimal. 

For some reason ECN appears to be being filtered out along the way as both endpoints SHOULD be attempting it.

But the crux of this morning's problem is that it appears that the knees in the curves that should have kicked in RED don't appear to be kicking in with u/d ratios of 800/400... 

On this bug now is a capture, and the values used for the qos-script at present. (the openwrt qos script can be run with these values on a router to generate the tc qdisc info which is mildly harder to look at)

Or, the ECN issue could be something like this wiping out the ECN bit?

config 'reclassify'
	option 'target' 'Priority'
	option 'proto' 'tcp'
	option 'pktsize' '-128'
	option 'mark' '!Bulk'
	option 'tcpflags' 'SYN'
"
171,Dave Täht,2011-05-21 06:38:57.43769,"uploaded files... I did! I did... 

doing it again"
171,Dave Täht,2011-05-21 07:13:47.497823,"the ""qos overhead"" calculation is ""off""
values are set to 840/380

dns is in the ""priority"" band
http and httpping is in the ""normal"" band.
ping,iperf, and rsync is in the ""bulk"" band

Various forms of traffic will tweak these in various ways. The qdisc settings as calculated are:

root@labgw:/usr/lib/qos# tc qdisc
qdisc pfifo_fast 0: dev eth0 root refcnt 2 bands 3 priomap  1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1
qdisc hfsc 1: dev eth1 root refcnt 2 default 30 
qdisc sfq 100: dev eth1 parent 1:10 limit 127p quantum 1514b perturb 2sec 
qdisc sfq 200: dev eth1 parent 1:20 limit 127p quantum 1514b perturb 2sec 
qdisc red 300: dev eth1 parent 1:30 limit 29184b min 2432b max 7296b ecn 
qdisc red 400: dev eth1 parent 1:40 limit 29184b min 2432b max 7296b ecn 
qdisc ingress ffff: dev eth1 parent ffff:fff1 ---------------- 
qdisc mq 0: dev wlan0 root 
qdisc mq 0: dev wlan2 root 
qdisc mq 0: dev mon.wlan0 root 
qdisc mq 0: dev wlan1 root 
qdisc mq 0: dev wlan3 root 
qdisc mq 0: dev wlan5 root 
qdisc mq 0: dev mon.wlan3 root 
qdisc mq 0: dev wlan4 root 
qdisc hfsc 1: dev ifb0 root refcnt 2 default 30 
qdisc sfq 100: dev ifb0 parent 1:10 limit 127p quantum 1514b perturb 2sec 
qdisc sfq 200: dev ifb0 parent 1:20 limit 127p quantum 1514b perturb 2sec 
qdisc red 300: dev ifb0 parent 1:30 limit 63Kb min 5376b max 16128b ecn 
qdisc red 400: dev ifb0 parent 1:40 limit 63Kb min 5376b max 16128b ecn 


Running the output of the firewall classification rules here:


One concern of mine is that these rules might be mucking with ecn, but that does not appear to be the case.

iptables -t mangle -F
iptables -t mangle -X
insmod ipt_multiport >&- 2>&-
insmod ipt_CONNMARK >&- 2>&-
insmod ipt_length >&- 2>&-
iptables -t mangle -N Default >&- 2>&-
iptables -t mangle -N Default_ct >&- 2>&-
iptables -t mangle -A Default_ct -m mark --mark 0 -m tcp -p tcp -m multiport --ports 22,53,222,5060 -j MARK --set-mark 1
iptables -t mangle -A Default_ct -m mark --mark 0 -p udp -m udp -m multiport --ports 22,53,222,5060 -j MARK --set-mark 1
iptables -t mangle -A Default_ct -m mark --mark 0 -p tcp -m tcp -m multiport --ports 20,21,25,80,81,8123,110,443,993,995 -j MARK --set-mark 3
iptables -t mangle -A Default_ct -m mark --mark 0 -m tcp -p tcp -m multiport --ports 5190 -j MARK --set-mark 2
iptables -t mangle -A Default_ct -m mark --mark 0 -p udp -m udp -m multiport --ports 5190 -j MARK --set-mark 2
iptables -t mangle -A Default_ct -m mark --mark 0 -m tcp -p tcp -m multiport --ports 873,5000,5001 -j MARK --set-mark 4
iptables -t mangle -A Default_ct -m mark --mark 0 -p udp -m udp -m multiport --ports 873,5000,5001 -j MARK --set-mark 4
iptables -t mangle -A Default_ct -j CONNMARK --save-mark
iptables -t mangle -A Default -j CONNMARK --restore-mark
iptables -t mangle -A Default -m mark --mark 0 -j Default_ct
iptables -t mangle -A Default -m mark --mark 1 -m length --length 400: -j MARK --set-mark 0
iptables -t mangle -A Default -m mark --mark 2 -m length --length 800: -j MARK --set-mark 0
iptables -t mangle -A Default -m mark --mark 0 -p udp -m length --length :500 -j MARK --set-mark 2
iptables -t mangle -A Default -p icmp -j MARK --set-mark 4
iptables -t mangle -A Default -m mark --mark 0 -m tcp -p tcp --sport 1024:65535 --dport 1024:65535 -j MARK --set-mark 4
iptables -t mangle -A Default -m mark --mark 0 -p udp -m udp --sport 1024:65535 --dport 1024:65535 -j MARK --set-mark 4
iptables -t mangle -A Default -p tcp -m length --length :128 -m mark ! --mark 4 -m tcp --tcp-flags ALL SYN -j MARK --set-mark 1
iptables -t mangle -A Default -p tcp -m length --length :128 -m mark ! --mark 4 -m tcp --tcp-flags ALL ACK -j MARK --set-mark 1
iptables -t mangle -A OUTPUT -o eth1 -j Default
iptables -t mangle -A FORWARD -o eth1 -j Default


"
171,Dave Täht,2011-05-21 09:00:10.283326,"The knee in the curve of this calculation appears to be problematic (from /usr/lib/qos
<pre><code class=""bash"">
               printf ""tc qdisc add dev ""device"" parent 1:""class[i]""0 handle ""class[i]""00: ""

                # RED parameters - also used to determine the queue length for sfq
                # calculate min value. for links <= 256 kbit, we use 1500 bytes
                # use 50 ms queue length as min threshold for faster links
                # max threshold is fixed to 3*min
                base_pkt=3000
                base_rate=256
                min_lat=50
                if (maxrate[i] <= base_rate) min = base_pkt
                else min = int(maxrate[i] * 1024 / 8 * 0.05)
                max = 3 * min
                limit = (min + max) * 3

                if (qdisc[i] != """") {
                        # user specified qdisc
                        print qdisc[i] "" limit "" limit
                } else if (rtm1[i] > 0) {
                        # rt class - use sfq
                        print ""sfq perturb 2 limit ""  limit
                } else {
                        # non-rt class - use RED

                        avpkt = pktsize[i]
                        # don't use avpkt values less than 500 bytes
                        if (avpkt < 500) avpkt = 500
                        # if avpkt is too close to min, scale down avpkt to allow proper bursting
                        if (avpkt > min * 0.70) avpkt *= 0.70


                        # according to http://www.cs.unc.edu/~jeffay/papers/IEEE-ToN-01.pdf a drop
                        # probability somewhere between 0.1 and 0.2 should be a good tradeoff
                        # between link utilization and response time (0.1: response; 0.2: utilization)
                        prob=""0.12""
                        rburst=int((2*min + max) / (3 * avpkt))
                        if (rburst < 2) rburst = 2
                        print ""red min "" min "" max "" max "" burst "" rburst "" avpkt "" avpkt "" limit "" limit "" probability "" prob "" ecn""
                }
        }

</code></pre>"
171,Dave Täht,2011-05-21 12:47:39.567151,"Some dropped by both red and hfsc, very few marked... need to look at the traces.

root@labgw:~# tc -s qdisc
qdisc pfifo_fast 0: dev eth0 root refcnt 2 bands 3 priomap  1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1
 Sent 1614863066 bytes 1327262 pkt (dropped 3254, overlimits 0 requeues 12093) 
 backlog 0b 0p requeues 12093 
qdisc hfsc 1: dev eth1 root refcnt 2 default 30 
 Sent 85724166 bytes 88100 pkt (dropped 1155, overlimits 119507 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc sfq 100: dev eth1 parent 1:10 limit 127p quantum 1514b perturb 2sec 
 Sent 297729 bytes 3345 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc sfq 200: dev eth1 parent 1:20 limit 127p quantum 1514b perturb 2sec 
 Sent 171159 bytes 2209 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc red 300: dev eth1 parent 1:30 limit 29184b min 2432b max 7296b ecn 
 Sent 85134125 bytes 81686 pkt (dropped 1154, overlimits 1155 requeues 0) 
 backlog 0b 0p requeues 0 
  marked 1 early 1154 pdrop 0 other 0
qdisc red 400: dev eth1 parent 1:40 limit 29184b min 2432b max 7296b ecn 
 Sent 121153 bytes 860 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
  marked 0 early 0 pdrop 0 other 0
qdisc ingress ffff: dev eth1 parent ffff:fff1 ---------------- 
 Sent 43661931 bytes 211410 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc mq 0: dev wlan0 root 
 Sent 14518331 bytes 68606 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc mq 0: dev wlan2 root 
 Sent 7895632 bytes 39007 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc mq 0: dev mon.wlan0 root 
 Sent 7188274 bytes 43046 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc mq 0: dev wlan1 root 
 Sent 10673024 bytes 45544 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc mq 0: dev wlan3 root 
 Sent 14518199 bytes 68604 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc mq 0: dev wlan5 root 
 Sent 8190424 bytes 46371 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc mq 0: dev mon.wlan3 root 
 Sent 3939780 bytes 24626 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc mq 0: dev wlan4 root 
 Sent 10662036 bytes 45578 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc hfsc 1: dev ifb0 root refcnt 2 default 30 
 Sent 40132206 bytes 153407 pkt (dropped 496, overlimits 63534 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc sfq 100: dev ifb0 parent 1:10 limit 127p quantum 1514b perturb 2sec 
 Sent 305151 bytes 2660 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc sfq 200: dev ifb0 parent 1:20 limit 127p quantum 1514b perturb 2sec 
 Sent 0 bytes 0 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc red 300: dev ifb0 parent 1:30 limit 63Kb min 5376b max 16128b ecn 
 Sent 39806046 bytes 150717 pkt (dropped 496, overlimits 496 requeues 0) 
 backlog 0b 0p requeues 0 
  marked 0 early 496 pdrop 0 other 0
qdisc red 400: dev ifb0 parent 1:40 limit 63Kb min 5376b max 16128b ecn 
 Sent 21009 bytes 30 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
  marked 0 early 0 pdrop 0 other 0
"
173,Nick Feamster,2011-05-21 14:08:18.285341,"Since the current post-babel config doesn't really work for me, I'll reflash with the latest build."
173,Nick Feamster,2011-05-21 15:31:01.810602,Latest build works just fine.  Clifton and seapoint are both back up and running.  Srikanth is testing some things out now on these boxes.
171,David Taht,2011-05-21 15:32:39.969875,"Here is some real data on a typical use pattern,
which is simply using google with it's ""interactive"" feature turned on and
adblock plus enabled on my browser, while duplicating your QoS settings.
(Without adblock, it is much worse)

http://gw.lab.bufferbloat.net/captures/series1/qos1googleabcde-withecn.cap

View the data in wireshark.

Note the number of DNS queries. Note the timestamps of the DNS queries. Note
packet lossage and retransmits.

To repeat this particular test, login to google, go to their search page, go
to the settings thing on the top right of the window, turn on the
""interactive"" feature...

login to the router and

/etc/init.d/dnsmasq stop
/etc/init.d/dnsmasq start
tcpdump -i eth1 -w/tmp/whatever.cap

search for a # wait a few seconds for it all to load
backspace, then b
backspace, then c
backspace, then d
backspace, then e

hit control-C on the router to halt the dump (it should be less than 200k),
then transfer the file somewhere
and take a look at it.

Repeat with QoS on and off.

I would appreciate a copy, too.


On Sat, May 21, 2011 at 3:47 PM, Nick Feamster <feamster@cc.gatech.edu>wrote:

> I'm up, Babel is not. :-)  That configuration wiped me out, so I decided to
> try the new build.


I would have liked it had you stuck with it long enough to talk to me. Did
you take a backup?


> Clifton is back online.  I'm bringing seapoint up shortly, then heading to
> bed.
>

K. Same password?


> The chrome stuff looks nice on the router now!  I think the ""configuration
> page"" could feature a bit more prominently.  I was going to boldface that
> line and check that in.
>

Go right ahead. I am not doing any more builds for a while, unless something
major happens. I can certainly disable qos by default in the next build.

Please also check ""package updates"" they should come from the right place
now, although the xwrt repo was still not up to date when last I looked.


>
> Srikanth and I chatted about the QoS stuff at dinner.  Given the widespread
> disagreement on this, I think we have a research paper on our hands. :-)


Well, yes.


> My two cents: disabling this will make user experience no worse than what
> they have now.



I only have data from about a dozen cybercafes in Nicaragua, and several
thousand devices in california, 6 months of intensive research into the
bufferbloat issue, 100s of thousands of educated users doing something like
this to their routers (and 100s of millions, not), and several hundred
papers to back me up.



>  Enabling it could make the experience better, but it could also make it
> perceivably worse if we get it wrong.


Getting it wrong consists of entering too high or too low values. Too high,
and it does little good (although packet prioritization also in there helps
regardless), too low, and long lived tcp streams suffer.

Not setting it will make it perceivably worse in many respects.

The interesting thing to me, thus far, was finding a knee in the curve under
your conditions that resulted in 30+% loss of peak performance, rather than
a more reasonable, 12%. The results I get here are decidedly different,
using the same test conditions, I'm currently getting throttled throughput
in excess of 10% HIGHER than what is the setting. At the moment I'm looking
into the mars polar lander-like problem of the difference between megabits
and mibbibits, but that would account for less than 5% of the discrepancy.

Your long RTT times change how QoS functions by quite a bit.

My thought would be:

1) get the boxes deployed.
2) Make sure people are happy.
2a) do a little testing, see below
3) Then, we can communicate with them to make sure they know that they have
an option to turn this on.
4) Or, we turn it on, but we tell them that we're doing so, and only do it
after they aren't complaining about the box for other reasons.

>
> Multi-user testing under realistic conditions is helpful.

A) Make a skype phone call while doing a download.
B) Do an upload while downloading a large file
C) run bittorrent in the background and try to do anything.

I'll rely on feed back from testers such as vincent and jg for my data until
we can clearly distinguish between sites, or you get more data by going into
the field and dealing with real users and real usage on the deployed
equipment..

-Nick
>
>"
171,Dave Täht,2011-05-21 15:40:05.97863,"

I was salso delighted to get the feedback from the user in canada:

<irving> Connecting to Bell Canada using PPPOE, speedtest.net shows
	 me 6MPBS down, 420K up using my old d-dlink DIR615

<irving> turned QOS off, got 6M up 420K down (daisy chained through
	 my other router, didn't get around to swapping it out of the
	 path)
<irving> using bismark, I get 870K down 70K up. This is on
	 WNDR3700v2, squashfs-factory-NA.img
<dtaht> that's about right ish - it's set for 1000/100 I think.
<dtaht> If you change QoS to match what you measure, 
<dtaht> you should get very close to that speed.

<irving> yup, looks much nicer. Still through the chain, QOS set to
	 420K up 5800 K down, speedtest.net shows 5.15M up 320 down
	 which is pretty close

I so love having random testing from random strangers...

<irving> I'm a random stranger who stumbled over your project via
	 gettys postings about bufferbloat. used to work on
	 BorderWare and Secure Computing firewalls so I have some
	 (very out of date) chops.
"
171,Srikanth Sundaresan,2011-05-21 15:43:26.498562,"Can't test. :(
Damn connection sharing doesn't work on my mac, can't get my router online.

On May 22, 2011, at 12:32 AM, Dave Taht wrote:

> 
> Here is some real data on a typical use pattern,
> which is simply using google with it's ""interactive"" feature turned on and adblock plus enabled on my browser, while duplicating your QoS settings. (Without adblock, it is much worse)
> 
> http://gw.lab.bufferbloat.net/captures/series1/qos1googleabcde-withecn.cap
> 
> View the data in wireshark.
> 
> Note the number of DNS queries. Note the timestamps of the DNS queries. Note packet lossage and retransmits.
> 
> To repeat this particular test, login to google, go to their search page, go to the settings thing on the top right of the window, turn on the ""interactive"" feature...
> 
> login to the router and
> 
> /etc/init.d/dnsmasq stop
> /etc/init.d/dnsmasq start
> tcpdump -i eth1 -w/tmp/whatever.cap
> 
> search for a # wait a few seconds for it all to load
> backspace, then b
> backspace, then c
> backspace, then d
> backspace, then e
> 
> hit control-C on the router to halt the dump (it should be less than 200k), then transfer the file somewhere 
> and take a look at it.
> 
> Repeat with QoS on and off.
> 
> I would appreciate a copy, too.
> 
> 
> On Sat, May 21, 2011 at 3:47 PM, Nick Feamster <feamster@cc.gatech.edu> wrote:
> I'm up, Babel is not. :-)  That configuration wiped me out, so I decided to try the new build.  
> 
> I would have liked it had you stuck with it long enough to talk to me. Did you take a backup?
>  
> Clifton is back online.  I'm bringing seapoint up shortly, then heading to bed.
>  
> K. Same password?
>  
> The chrome stuff looks nice on the router now!  I think the ""configuration page"" could feature a bit more prominently.  I was going to boldface that line and check that in.
> 
> Go right ahead. I am not doing any more builds for a while, unless something major happens. I can certainly disable qos by default in the next build.
> 
> Please also check ""package updates"" they should come from the right place now, although the xwrt repo was still not up to date when last I looked.
>  
> 
> Srikanth and I chatted about the QoS stuff at dinner.  Given the widespread disagreement on this, I think we have a research paper on our hands. :-)  
> 
> Well, yes. 
>  
> My two cents: disabling this will make user experience no worse than what they have now.
> 
> 
> I only have data from about a dozen cybercafes in Nicaragua, and several thousand devices in california, 6 months of intensive research into the bufferbloat issue, 100s of thousands of educated users doing something like this to their routers (and 100s of millions, not), and several hundred papers to back me up.
> 
>  
>  Enabling it could make the experience better, but it could also make it perceivably worse if we get it wrong.
>  
> Getting it wrong consists of entering too high or too low values. Too high, and it does little good (although packet prioritization also in there helps regardless), too low, and long lived tcp streams suffer.
> 
> Not setting it will make it perceivably worse in many respects.
>  
> The interesting thing to me, thus far, was finding a knee in the curve under your conditions that resulted in 30+% loss of peak performance, rather than a more reasonable, 12%. The results I get here are decidedly different, using the same test conditions, I'm currently getting throttled throughput in excess of 10% HIGHER than what is the setting. At the moment I'm looking into the mars polar lander-like problem of the difference between megabits and mibbibits, but that would account for less than 5% of the discrepancy.
> 
> Your long RTT times change how QoS functions by quite a bit.
> 
> My thought would be:
> 
> 1) get the boxes deployed.  
> 2) Make sure people are happy.  
> 2a) do a little testing, see below
> 3) Then, we can communicate with them to make sure they know that they have an option to turn this on.  
> 4) Or, we turn it on, but we tell them that we're doing so, and only do it after they aren't complaining about the box for other reasons.
> 
> Multi-user testing under realistic conditions is helpful.
> 
> A) Make a skype phone call while doing a download.
> B) Do an upload while downloading a large file
> C) run bittorrent in the background and try to do anything.
> 
> I'll rely on feed back from testers such as vincent and jg for my data until we can clearly distinguish between sites, or you get more data by going into the field and dealing with real users and real usage on the deployed equipment..
> 
> -Nick
> 
>"
171,Dave Täht,2011-05-21 15:48:55.651087,"the numbers in the lab (using wget on a large file on huchra which runs for 2+ minutes) show 97KB/sec when set to 840 dn/ 420 up. I suspect part of this is due to a mibbi vs megabit discrepancy in the reporting.

The numbers reported from a speedtest user in canada show roughly a 25% non-relationship to his actual speed ratio of 6M down, 420 up. I don't know what he was using to perform his actual tests. The ratio he has there is perilously close to the maximum possible for normal TCP/ip acks to get back (21x1 is about the best you can do)

Not knowing the exact data for the current defaults in use in South Africa, it soundes as though the performance difference there for a speedtest is over 30%.
"
173,Dave Täht,2011-05-21 15:50:51.105609,"sorry I was not around.

lacking the ip route information I asked for, I don't know what went wrong.

"
171,Dave Täht,2011-05-22 05:58:02.438205,"I went and looked at the performance this morning from capetown, for uploads.

For reference, an unloaded ping:

64 bytes from 149.20.54.82: seq=12 ttl=46 time=310.525 ms

Without QoS set, and doing a scp upload, while pinging. Random samples.

noqos.cap 71% 2212KB  41.2KB/s   00:21 from 149.20.54.82: seq=72 ttl=46 time=454.703 ms
noqos.cap 73% 2260KB  41.9KB/s   00:19 from 149.20.54.82: seq=73 ttl=46 time=604.203 ms
noqos.cap 74% 2308KB  42.5KB/s   00:18 from 149.20.54.82: seq=74 ttl=46 time=599.380 ms
noqos.cap 76% 2348KB  42.3KB/s   00:17 from 149.20.54.82: seq=75 ttl=46 time=331.745 ms
noqos.cap 77% 2380KB  41.2KB/s   00:17 from 149.20.54.82: seq=76 ttl=46 time=474.808 ms

With QoS set to 840/380 and ping in the ""Bulk"" band.

noqos.cap 53% 1660KB  32.5KB/s   from 149.20.54.82: seq=137 ttl=46 time=327.042 ms
noqos.cap 55% 1700KB  33.2KB/s   from 149.20.54.82: seq=138 ttl=46 time=310.355 ms
noqos.cap 56% 1732KB  33.1KB/s   from 149.20.54.82: seq=139 ttl=46 time=332.353 ms
noqos.cap 57% 1780KB  34.6KB/s   from 149.20.54.82: seq=140 ttl=46 time=331.784 ms

With QoS set to 1000/500 you can see the ""bulk"" band start to kick in, and
ping jittering harder

noqos.cap 67% 2092KB  35.6KB/s bytes from 149.20.54.82: seq=84 ttl=46 time=352.532 ms
noqos.cap 69% 2132KB  36.1KB/s bytes from 149.20.54.82: seq=85 ttl=46 time=354.672 ms
noqos.cap 70% 2164KB  35.7KB/s bytes from 149.20.54.82: seq=86 ttl=46 time=310.943 ms
noqos.cap 71% 2212KB  36.9KB/s bytes from 149.20.54.82: seq=87 ttl=46 time=322.205 ms
noqos.cap 72% 2236KB  35.6KB/s bytes from 149.20.54.82: seq=88 ttl=46 time=366.960 ms
noqos.cap 73% 2276KB  36.0KB/s bytes from 149.20.54.82: seq=89 ttl=46 time=349.261 ms
noqos.cap 74% 2308KB  35.6KB/s bytes from 149.20.54.82: seq=90 ttl=46 time=341.993 ms

I will definitely argue that second derived QoS calculation has a knee in it that needs
to be tweaked upon further analysis of the packet traces,
but for more multi-threaded usage (such as a typical web browser, or
browsers, or multiple users, and making phone calls), the default QoS is doing it's job fairly well
at the *lowest* settings. Going more than 20% above will probably affect voice traffic."
173,Dave Täht,2011-05-22 06:27:46.197157,"and not having promised to actually deliver this functionality in the first place,
(aside from the now demonstrated actual market need)

I am not going to deploy this before it is ready, which I hope will be part of the next release
of wisp6, at which point the packages can be upgraded on bismark.

It can certainly be made to work with co-operation from the field, but is far from easy or automatic at present."
150,Dave Täht,2011-05-22 06:29:46.883787,My take on this problem is to toss django out the window. Simply cannot be used for complex analysis.
171,Dave Täht,2011-05-22 06:35:01.245328,"QoS set to levels reported by speedtest seem to be reporting ""safe"" values. Going 20% higher seems feasible on my limited testing here, but I would argue for measuring twice and cutting once under realistic multiuser conditions.

What decisions you make from here regarding deployment are not up to me. It would be good if you gathered data on the settings of QoS in the field, off/on/set to what/using what. "
62,Dave Täht,2011-05-22 06:36:03.219411,"the package database is now in the right place. opkg works.

Without real DNS support, I can do no more."
127,Dave Täht,2011-05-22 06:41:42.843504,"I have not done release notes as I lack feedback from the field.

Secondly, I have seen no updates to the default installation guide, judging from some
of the bugs I filed elsewhere like #170, more stuff needs to be done to fully configure these devices.

"
129,Dave Täht,2011-05-22 06:42:20.425865,""
154,Dave Täht,2011-05-22 06:44:51.316137,"Lacking bind9 DNS support, no.

It sort of is mapping to there, with weirdnesses from godaddy.

netops is proposing doing this on a different server than dp4. I will discuss, but time has run out."
83,Dave Täht,2011-05-22 06:46:25.157863,"they can be increased, and the debloat package improved, but so far, as is, they do not seem to be lowering throughput at all, and certainly are helping on latency."
147,Dave Täht,2011-05-22 06:47:41.128905,I will look further into this upon the next release of cerowrt and/or iscwrt.
147,Dave Täht,2011-05-22 06:47:56.630462,""
79,Dave Täht,2011-05-22 06:48:20.062758,""
145,Dave Täht,2011-05-22 06:48:52.830696,""
49,Dave Täht,2011-05-22 06:49:17.752558,""
95,Dave Täht,2011-05-22 06:49:44.945272,""
80,Dave Täht,2011-05-22 06:50:13.224856,""
45,Dave Täht,2011-05-22 06:50:38.373047,""
140,Dave Täht,2011-05-22 06:53:29.809434,""
142,Dave Täht,2011-05-22 06:54:13.764552,""
168,Dave Täht,2011-05-22 07:03:45.583573,"Assuming the [[bismark-testbed:Testlab]] remains operation, I should able to slowly debug this.

Regrettably, there seems to be no way to simulate the problem, except time and multiple routers deployed. IT MAY be related to issue  #147 and #145


As for ""daisy chaining, or using the mesh"" please open separate bugs for those."
50,Dave Täht,2011-05-22 07:06:19.41732,"I'm closing this bug. If you need to put a new release in the field, an existing packager will have to package, test, and deploy.

QA is effectively complete at this point, on this release, and no new packages should be added until there are weeks of feedback from the field."
154,Nick Feamster,2011-05-22 07:35:42.232471,"I think our plan now is to migrate redmine wholesale anyway.

gburdell@lists.bufferbloat.net wrote:

>
>Issue #154 has been updated by Dave Täht.
>
>
>Lacking bind9 DNS support, no.
>
>It sort of is mapping to there, with weirdnesses from godaddy.
>
>netops is proposing doing this on a different server than dp4. I will
>discuss, but time has run out.
>----------------------------------------
>Bug #154: projectbismark.net
>https://www.bufferbloat.net/issues/154
>
>Author: Nick Feamster
>Status: New
>Priority: Urgent
>Assignee: Dave Täht
>Category: 
>Target version: Boxes ready for South Africa deployment
>
>
>Can we have projectbismark.net map to here?
>http://www.bufferbloat.net/projects/bismark/
>
>Thanks!
>
>"
102,Dave Täht,2011-05-22 07:47:45.535743,"fixed in the debloat repo. Not well, but I'll live with it."
50,Walter de Donato,2011-05-22 08:53:00.898048,"Damn! Too late :|

We have the new version ready here: http://www.grid.unina.it/software/ITG/codice/D-ITG-2.8.0-rc1.tgz

"
136,Dave Täht,2011-05-22 11:33:20.953028,"Can someone exercise their routers, logging in via the bdm console multiple times, over the net, to a router in the field, to see if duplicate tunnels are still being created and left lying around?

I would love to close this bug if I knew this problem was entirely dead or not. The whole probe through port 53 idea is a lousy one, as DNS uses BOTH tcp and udp on that port.

Going through 123 is mildly better. 

It sounds like forcing the bug to recur would require ports other than port 53 to be blocked, so it falls back to trying 53? Or is there another fix in place?

What happens when a recovery tunnel STILL tries going through port 53?
 "
136,Nick Feamster,2011-05-22 11:35:32.232414,"Srikanth, can you handle this?

On May 22, 2011, at 8:33 PM, gburdell@lists.bufferbloat.net wrote:

> 
> Issue #136 has been updated by Dave Täht.
> 
> 
> Can someone exercise their routers, logging in via the bdm console multiple times, over the net, to a router in the field, to see if duplicate tunnels are still being created and left lying around?
> 
> I would love to close this bug if I knew this problem was entirely dead or not. The whole probe through port 53 idea is a lousy one, as DNS uses BOTH tcp and udp on that port.
> 
> Going through 123 is mildly better. 
> 
> It sounds like forcing the bug to recur would require ports other than port 53 to be blocked, so it falls back to trying 53? Or is there another fix in place?
> 
> What happens when a recovery tunnel STILL tries going through port 53?
> 
> ----------------------------------------
> Bug #136: Bismark misbehavior
> https://www.bufferbloat.net/issues/136
> 
> Author: Dave Täht
> Status: Feedback
> Priority: Immediate
> Assignee: Srikanth Sundaresan
> Category: 
> Target version: Boxes ready for South Africa deployment
> 
> 
> For some reason I think this getting to where it has more than one instance is bad.
> 
> This is the result of running overnight.
> 
> 4555 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 62447:12
> 5079 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 54285:12
> 5354 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 55654:12
> 5494 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52699:12
> 5721 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 62258:12
> 5793 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 60917:12
> 6089 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 55817:12
> 6240 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 54469:12
> 6384 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 54438:12
> 6532 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 55729:12
> 7375 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 61640:12
> 8159 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 58735:12
> 9079 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52238:12
> 9223 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52493:12
> 9364 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 50485:12
> 9446 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 58797:12
> 9741 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 63524:12
> 9954 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 50323:12
> 10229 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52364:12
> 10343 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52240:12
> 10556 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 54975:12
> 10831 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 57035:12
> 10888 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 62043:12
> 11111 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 61877:12
> 11334 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 61838:12
> 11406 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 63279:12
> 11604 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 60027:12
> 11742 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 56732:12
> 11884 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 64720:12
> 12231 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 61647:12
> 12439 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 65134:12
> 13083 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 60132:12
> 13158 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 64958:12
> 13604 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 55558:12
> 14275 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 53613:12
> 15673 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 51111:12
> 18087 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 51631:12
> 18382 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 53280:12
> 18652 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 51607:12
> 18798 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 59466:12
> 19408 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 62624:12
> 19480 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 51304:12
> 
> 
>"
136,Dave Täht,2011-05-22 12:35:29.174988,"you can probably use the machines in the lab to test this too, although I would prefer machines also be tested in the field.

The ""mac list for the test lab is here"":http://www.bufferbloat.net/projects/bismark-testbed/wiki/Testlab

Some of the names and internal ips may be inaccurate at this point. Several machines are double natted.

The problem is, I don't know what triggered it in the first place, and have no idea how to duplicate, and only saw the bdm console for the first time 2 days ago.

What did the ""fix"" entail? What commit was it?"
136,Srikanth Sundaresan,2011-05-22 12:46:32.157069,"It seems to be ok in the 2 routers at Nick's place. clifton has only the one tunnel (which is being used). The other seems to have 1 extra, on port 53418, which refuses to go away. Will check to see tomorrow. Nick, if you can leave it on tonight, tht ill be useful. 

On May 22, 2011, at 8:35 PM, gburdell@lists.bufferbloat.net wrote:

> 
> Issue #136 has been updated by Nick Feamster.
> 
> 
> Srikanth, can you handle this?
> 
> On May 22, 2011, at 8:33 PM, gburdell@lists.bufferbloat.net wrote:
> 
>> 
>> Issue #136 has been updated by Dave Täht.
>> 
>> 
>> Can someone exercise their routers, logging in via the bdm console multiple times, over the net, to a router in the field, to see if duplicate tunnels are still being created and left lying around?
>> 
>> I would love to close this bug if I knew this problem was entirely dead or not. The whole probe through port 53 idea is a lousy one, as DNS uses BOTH tcp and udp on that port.
>> 
>> Going through 123 is mildly better. 
>> 
>> It sounds like forcing the bug to recur would require ports other than port 53 to be blocked, so it falls back to trying 53? Or is there another fix in place?
>> 
>> What happens when a recovery tunnel STILL tries going through port 53?
>> 
>> ----------------------------------------
>> Bug #136: Bismark misbehavior
>> https://www.bufferbloat.net/issues/136
>> 
>> Author: Dave Täht
>> Status: Feedback
>> Priority: Immediate
>> Assignee: Srikanth Sundaresan
>> Category: 
>> Target version: Boxes ready for South Africa deployment
>> 
>> 
>> For some reason I think this getting to where it has more than one instance is bad.
>> 
>> This is the result of running overnight.
>> 
>> 4555 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 62447:12
>> 5079 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 54285:12
>> 5354 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 55654:12
>> 5494 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52699:12
>> 5721 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 62258:12
>> 5793 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 60917:12
>> 6089 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 55817:12
>> 6240 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 54469:12
>> 6384 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 54438:12
>> 6532 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 55729:12
>> 7375 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 61640:12
>> 8159 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 58735:12
>> 9079 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52238:12
>> 9223 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52493:12
>> 9364 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 50485:12
>> 9446 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 58797:12
>> 9741 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 63524:12
>> 9954 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 50323:12
>> 10229 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52364:12
>> 10343 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52240:12
>> 10556 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 54975:12
>> 10831 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 57035:12
>> 10888 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 62043:12
>> 11111 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 61877:12
>> 11334 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 61838:12
>> 11406 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 63279:12
>> 11604 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 60027:12
>> 11742 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 56732:12
>> 11884 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 64720:12
>> 12231 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 61647:12
>> 12439 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 65134:12
>> 13083 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 60132:12
>> 13158 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 64958:12
>> 13604 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 55558:12
>> 14275 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 53613:12
>> 15673 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 51111:12
>> 18087 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 51631:12
>> 18382 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 53280:12
>> 18652 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 51607:12
>> 18798 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 59466:12
>> 19408 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 62624:12
>> 19480 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 51304:12
>> 
>> 
>> 
> ----------------------------------------
> Bug #136: Bismark misbehavior
> https://www.bufferbloat.net/issues/136
> 
> Author: Dave Täht
> Status: Feedback
> Priority: Immediate
> Assignee: Srikanth Sundaresan
> Category: 
> Target version: Boxes ready for South Africa deployment
> 
> 
> For some reason I think this getting to where it has more than one instance is bad.
> 
> This is the result of running overnight.
> 
> 4555 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 62447:12
> 5079 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 54285:12
> 5354 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 55654:12
> 5494 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52699:12
> 5721 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 62258:12
> 5793 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 60917:12
> 6089 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 55817:12
> 6240 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 54469:12
> 6384 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 54438:12
> 6532 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 55729:12
> 7375 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 61640:12
> 8159 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 58735:12
> 9079 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52238:12
> 9223 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52493:12
> 9364 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 50485:12
> 9446 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 58797:12
> 9741 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 63524:12
> 9954 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 50323:12
> 10229 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52364:12
> 10343 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52240:12
> 10556 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 54975:12
> 10831 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 57035:12
> 10888 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 62043:12
> 11111 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 61877:12
> 11334 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 61838:12
> 11406 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 63279:12
> 11604 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 60027:12
> 11742 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 56732:12
> 11884 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 64720:12
> 12231 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 61647:12
> 12439 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 65134:12
> 13083 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 60132:12
> 13158 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 64958:12
> 13604 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 55558:12
> 14275 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 53613:12
> 15673 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 51111:12
> 18087 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 51631:12
> 18382 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 53280:12
> 18652 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 51607:12
> 18798 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 59466:12
> 19408 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 62624:12
> 19480 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 51304:12
> 
> 
>"
136,Nick Feamster,2011-05-22 12:50:11.639439,"I will leave them both on tonight.

On May 22, 2011, at 9:46 PM, gburdell@lists.bufferbloat.net wrote:

> 
> Issue #136 has been updated by Srikanth Sundaresan.
> 
> 
> It seems to be ok in the 2 routers at Nick's place. clifton has only the one tunnel (which is being used). The other seems to have 1 extra, on port 53418, which refuses to go away. Will check to see tomorrow. Nick, if you can leave it on tonight, tht ill be useful. 
> 
> On May 22, 2011, at 8:35 PM, gburdell@lists.bufferbloat.net wrote:
> 
>> 
>> Issue #136 has been updated by Nick Feamster.
>> 
>> 
>> Srikanth, can you handle this?
>> 
>> On May 22, 2011, at 8:33 PM, gburdell@lists.bufferbloat.net wrote:
>> 
>>> 
>>> Issue #136 has been updated by Dave Täht.
>>> 
>>> 
>>> Can someone exercise their routers, logging in via the bdm console multiple times, over the net, to a router in the field, to see if duplicate tunnels are still being created and left lying around?
>>> 
>>> I would love to close this bug if I knew this problem was entirely dead or not. The whole probe through port 53 idea is a lousy one, as DNS uses BOTH tcp and udp on that port.
>>> 
>>> Going through 123 is mildly better. 
>>> 
>>> It sounds like forcing the bug to recur would require ports other than port 53 to be blocked, so it falls back to trying 53? Or is there another fix in place?
>>> 
>>> What happens when a recovery tunnel STILL tries going through port 53?
>>> 
>>> ----------------------------------------
>>> Bug #136: Bismark misbehavior
>>> https://www.bufferbloat.net/issues/136
>>> 
>>> Author: Dave Täht
>>> Status: Feedback
>>> Priority: Immediate
>>> Assignee: Srikanth Sundaresan
>>> Category: 
>>> Target version: Boxes ready for South Africa deployment
>>> 
>>> 
>>> For some reason I think this getting to where it has more than one instance is bad.
>>> 
>>> This is the result of running overnight.
>>> 
>>> 4555 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 62447:12
>>> 5079 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 54285:12
>>> 5354 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 55654:12
>>> 5494 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52699:12
>>> 5721 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 62258:12
>>> 5793 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 60917:12
>>> 6089 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 55817:12
>>> 6240 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 54469:12
>>> 6384 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 54438:12
>>> 6532 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 55729:12
>>> 7375 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 61640:12
>>> 8159 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 58735:12
>>> 9079 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52238:12
>>> 9223 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52493:12
>>> 9364 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 50485:12
>>> 9446 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 58797:12
>>> 9741 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 63524:12
>>> 9954 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 50323:12
>>> 10229 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52364:12
>>> 10343 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52240:12
>>> 10556 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 54975:12
>>> 10831 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 57035:12
>>> 10888 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 62043:12
>>> 11111 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 61877:12
>>> 11334 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 61838:12
>>> 11406 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 63279:12
>>> 11604 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 60027:12
>>> 11742 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 56732:12
>>> 11884 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 64720:12
>>> 12231 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 61647:12
>>> 12439 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 65134:12
>>> 13083 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 60132:12
>>> 13158 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 64958:12
>>> 13604 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 55558:12
>>> 14275 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 53613:12
>>> 15673 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 51111:12
>>> 18087 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 51631:12
>>> 18382 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 53280:12
>>> 18652 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 51607:12
>>> 18798 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 59466:12
>>> 19408 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 62624:12
>>> 19480 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 51304:12
>>> 
>>> 
>>> 
>> ----------------------------------------
>> Bug #136: Bismark misbehavior
>> https://www.bufferbloat.net/issues/136
>> 
>> Author: Dave Täht
>> Status: Feedback
>> Priority: Immediate
>> Assignee: Srikanth Sundaresan
>> Category: 
>> Target version: Boxes ready for South Africa deployment
>> 
>> 
>> For some reason I think this getting to where it has more than one instance is bad.
>> 
>> This is the result of running overnight.
>> 
>> 4555 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 62447:12
>> 5079 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 54285:12
>> 5354 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 55654:12
>> 5494 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52699:12
>> 5721 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 62258:12
>> 5793 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 60917:12
>> 6089 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 55817:12
>> 6240 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 54469:12
>> 6384 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 54438:12
>> 6532 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 55729:12
>> 7375 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 61640:12
>> 8159 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 58735:12
>> 9079 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52238:12
>> 9223 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52493:12
>> 9364 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 50485:12
>> 9446 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 58797:12
>> 9741 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 63524:12
>> 9954 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 50323:12
>> 10229 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52364:12
>> 10343 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52240:12
>> 10556 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 54975:12
>> 10831 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 57035:12
>> 10888 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 62043:12
>> 11111 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 61877:12
>> 11334 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 61838:12
>> 11406 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 63279:12
>> 11604 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 60027:12
>> 11742 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 56732:12
>> 11884 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 64720:12
>> 12231 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 61647:12
>> 12439 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 65134:12
>> 13083 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 60132:12
>> 13158 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 64958:12
>> 13604 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 55558:12
>> 14275 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 53613:12
>> 15673 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 51111:12
>> 18087 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 51631:12
>> 18382 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 53280:12
>> 18652 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 51607:12
>> 18798 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 59466:12
>> 19408 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 62624:12
>> 19480 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 51304:12
>> 
>> 
>> 
> ----------------------------------------
> Bug #136: Bismark misbehavior
> https://www.bufferbloat.net/issues/136
> 
> Author: Dave Täht
> Status: Feedback
> Priority: Immediate
> Assignee: Srikanth Sundaresan
> Category: 
> Target version: Boxes ready for South Africa deployment
> 
> 
> For some reason I think this getting to where it has more than one instance is bad.
> 
> This is the result of running overnight.
> 
> 4555 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 62447:12
> 5079 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 54285:12
> 5354 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 55654:12
> 5494 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52699:12
> 5721 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 62258:12
> 5793 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 60917:12
> 6089 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 55817:12
> 6240 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 54469:12
> 6384 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 54438:12
> 6532 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 55729:12
> 7375 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 61640:12
> 8159 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 58735:12
> 9079 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52238:12
> 9223 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52493:12
> 9364 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 50485:12
> 9446 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 58797:12
> 9741 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 63524:12
> 9954 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 50323:12
> 10229 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52364:12
> 10343 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 52240:12
> 10556 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 54975:12
> 10831 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 57035:12
> 10888 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 62043:12
> 11111 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 61877:12
> 11334 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 61838:12
> 11406 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 63279:12
> 11604 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 60027:12
> 11742 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 56732:12
> 11884 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 64720:12
> 12231 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 61647:12
> 12439 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 65134:12
> 13083 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 60132:12
> 13158 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 64958:12
> 13604 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 55558:12
> 14275 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 53613:12
> 15673 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 51111:12
> 18087 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 51631:12
> 18382 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 53280:12
> 18652 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 51607:12
> 18798 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 59466:12
> 19408 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 62624:12
> 19480 root      1148 S    ssh -K 30 -N -i /etc/bismark/bismark_key -R 51304:12
> 
> 
>"
50,Dave Täht,2011-05-22 21:02:34.168295,"If and *only if* continued use of the previous release of dit-g will cause a router to catch fire, emit smoke and radiation of beyond Chernobyl's levels, killing thousands of people, and, further, also cause another republican to become president of the USA, and start another war in the middle east...

... am I willing to incorporate a revised package into the capetown build at this point.

I also would prefer that initial testing of your spanking new release occurs on systems that have more than 4MB of flash left to spare. 

However:

I am perfectly willing to incorporate this latest version of dit-g into the upcoming releases of the iscwrt or wisp6 projects so long as someone else is willing to package it and test it. 

After testing in there, it can be shipped as an update to capetown, or capetown can have another release.

And ultimately... get it merged up to openwrt, where my release schedules will fail to matter.

Does this work for you?
"
50,Walter de Donato,2011-05-23 02:48:36.66305,"Ok, no radiation of beyond Chernobyl's levels and stuff like that... 
...just because D-ITG is currently disabled in bismark active scripts.

2.7.0 release just won't work, which means no JITTER and PACKET LOSS measures.

The decision it's up to you..."
105,Nick Feamster,2011-05-23 03:24:28.922058,"The page has everything now.  I also added a FAQ to projectbismark.net, as well as a pointer to the mailing list for signups."
170,Nick Feamster,2011-05-23 03:28:14.844369,"I think we are now planning to do the assignment to measurement server using DNS.  So, do we still need ""ZONE""?"
72,Nick Feamster,2011-05-23 03:29:18.269994,This is done now.  projectbismark.net
141,Nick Feamster,2011-05-23 03:31:46.595511,I think we have a version that's now acceptable for the first release.  We also have projectbismark.net.
141,Nick Feamster,2011-05-23 03:35:36.789223,""
171,Nick Feamster,2011-05-23 03:38:40.868989,"Your experiment above is really interesting.  I think it makes sense to do testing with/without QoS, for various settings.

We will have to let people know that we're doing this, of course."
73,Nick Feamster,2011-05-23 03:40:41.029955,""
57,Nick Feamster,2011-05-23 03:42:52.447994,We are working on a first press release involving the Internet nutrition labels work.  I think we can add a mention of the Bismark project in that press release.
169,Nick Feamster,2011-05-23 03:44:21.8183,"Seems this should be a DNS address, yep.

I think we need to install BIND on dp4 and get the DNS transferred over so that we can do GeoIP-based redirection."
150,Nick Feamster,2011-05-23 03:45:25.589556,""
164,Nick Feamster,2011-05-23 03:49:34.280923,"I just went ahead and bought one of these myself on credit card.

You can track the order here: https://checkout.google.com/view/receipt?t=962427493153991"
107,Nick Feamster,2011-05-23 03:54:39.750465,""
171,Nick Feamster,2011-05-23 03:56:19.020579,""
171,Nick Feamster,2011-05-23 03:56:50.972542,""
170,Walter de Donato,2011-05-23 04:20:48.625784,"We currently assign a measure to a specific measurement server taking care of avoiding the overlap of different HEAVY measures towards it.
A device just before starting a measure asks the server for the Mserver IP address and measure-specific options (like port-number). The management server selects the less-busy measurement server depending on previous requests.
The reply received by the device, apart from the server IP and options, also gives the amount of time to wait before starting the measure. 
This way we can balance the load and control, for each measurement server, how many measurements are done concurrently toward it, thus avoiding results affected by interferences.
The ZONE parameter just tells the server to select among a subset of servers depending on the location.

If we move to DNS-based assignment we loose such control.

A compatible solution could be to let the device obtain the IP from the DNS query
and then request to the server a time interval to perform the measure towards it.
This requires modifications to the client/server protocol.

"
50,Dave Täht,2011-05-23 05:41:03.347127,"So why did I just WASTE flash by shipping it at all?

Sigh.
"
50,Nick Feamster,2011-05-23 05:43:03.979199,"Wait, why are we not using D-ITG?  It seems to provide some useful measurements.  I agree, if it is in the build, it would be nice to use it!"
170,Dave Täht,2011-05-23 06:50:40.593869,"Why does zone not use ISO standard country codes? There's a reference for that baked into the web interface for the worldwide regulatory spectrum already in /usr/lib/countrycodes.lst

http://en.wikipedia.org/wiki/ISO_3166-1_alpha-2"
170,Dave Täht,2011-05-23 06:54:42.688975,"A fairly normal means of dealing with this is you create DNS subdomains based on countrycode,
e.g. measurement.it.projectbismark.net, or measurement.us.projectbismark.net, and you use GEOIP for measurement.projectbismark.net to attempt a best guess.

Having fine grained control actually in the file itself is ok, but the file needs to be configured properly on a per router basis in that case, and that seems unlikely.

Related to this, is somehow KNOWING that j.random router somewhere in the world, is actually reporting accurate time, in UTC, so measurements can be correlated.

"
50,Dave Täht,2011-05-23 07:03:16.261043,"So this appears to have been a series of misunderstandings, compounded by the immediacy of the deadline, and my lack of knowledge of the guts of the bismark and d-itg packages.

I thought that this package was being tested. I thought that it worked, at least minimally.

It sounds like the correct procedure would have been to have created a bismark-ditg package which contained and required ditg with the related c++ library, and it should not have been baked into the build by default.

Please note that incorporating this package as it stands made it impossible to support the wndr3700v1 with capetown, and also made it impossible to support alternative routers with 8MB of flash, which is most of them. 

There were other tools that could have been chosen instead, as well, from a rather large list. 

Is dit-g being used for anything within bismark at this point? "
50,Srikanth Sundaresan,2011-05-23 07:07:14.98967,"D-ITG is used by bismark-active for packet loss and jitter tests.


On May 23, 2011, at 4:03 PM, gburdell@lists.bufferbloat.net wrote:

> 
> Issue #50 has been updated by Dave Täht.
> 
> 
> So this appears to have been a series of misunderstandings, compounded by the immediacy of the deadline, and my lack of knowledge of the guts of the bismark and d-itg packages.
> 
> I thought that this package was being tested.
> 
> It sounds like the correct procedure would have been to have created a bismark-ditg package which contained and required ditg with the related c++ library, and it should not have been baked into the build by default.
> 
> Please note that incorporating this package as it stands made it impossible to support the wndr3700v1 with capetown, and also made it impossible to support alternative routers with 8MB of flash, which is most of them. 
> 
> There were other tools that could have been chosen instead, as well, from a rather large list. 
> 
> Is dit-g being used for anything within bismark at this point? 
> ----------------------------------------
> Feature #50: Freeze against a version of D-ITG
> https://www.bufferbloat.net/issues/50
> 
> Author: Dave Täht
> Status: Closed
> Priority: Immediate
> Assignee: Walter de Donato
> Category: 
> Target version: Boxes ready for South Africa deployment
> 
> 
> And generate package for such.
> 
> 
> 
>"
50,Dave Täht,2011-05-23 07:32:28.808685,"""As a conclusion, because we are short in time, I think we can freeze D-ITG at version 2.7.0-Beta2.""

which contradicts:

""2.7.0 release just won't work, which means no JITTER and PACKET LOSS measures.""

And conflates:

""D-ITG is used by bismark-active for packet loss and jitter tests.""

Are you telling me bismark-active - AS SHIPPED - is enabled and using an unusable version of ditg? "
50,Nick Feamster,2011-05-23 09:37:55.665969,"Yes, would be nice to clear this up! :-)

On May 23, 2011, at 4:32 PM, gburdell@lists.bufferbloat.net wrote:

> 
> Issue #50 has been updated by Dave Täht.
> 
> 
> ""As a conclusion, because we are short in time, I think we can freeze D-ITG at version 2.7.0-Beta2.""
> 
> which contradicts:
> 
> ""2.7.0 release just won't work, which means no JITTER and PACKET LOSS measures.""
> 
> And conflates:
> 
> ""D-ITG is used by bismark-active for packet loss and jitter tests.""
> 
> Are you telling me bismark-active - AS SHIPPED - is enabled and using an unusable version of ditg? 
> ----------------------------------------
> Feature #50: Freeze against a version of D-ITG
> https://www.bufferbloat.net/issues/50
> 
> Author: Dave Täht
> Status: Closed
> Priority: Immediate
> Assignee: Walter de Donato
> Category: 
> Target version: Boxes ready for South Africa deployment
> 
> 
> And generate package for such.
> 
> 
> 
>"
176,Jim Gettys,2011-05-23 10:15:59.607744,
50,Walter de Donato,2011-05-23 11:11:58.118697,"Sorry about the unconsistencies.
We always used a newer unreleased version of ditg on previous deployments.
My fault was in not checking that version in advance on the current build. I
did forget about two features strictly necessary to let it work correctly in
our context.

I've probably been not clear about this point when I detected it.

A point I'm not understanding is: did we loose the possibility to update the
devices in the field? what happens if we do ""opkg update"" on bismark-active?

Shouldn't we support such feature?
Which is the drawback of doing that instead of building it directly into the
image?

Sorry again,
-Walter
Il giorno 23/mag/2011 18.38, <gburdell@lists.bufferbloat.net> ha scritto:
>
> Issue #50 has been updated by Nick Feamster.
>
>
> Yes, would be nice to clear this up! :-)
>
> On May 23, 2011, at 4:32 PM, gburdell@lists.bufferbloat.net wrote:
>
>>
>> Issue #50 has been updated by Dave Täht.
>>
>>
>> ""As a conclusion, because we are short in time, I think we can freeze
D-ITG at version 2.7.0-Beta2.""
>>
>> which contradicts:
>>
>> ""2.7.0 release just won't work, which means no JITTER and PACKET LOSS
measures.""
>>
>> And conflates:
>>
>> ""D-ITG is used by bismark-active for packet loss and jitter tests.""
>>
>> Are you telling me bismark-active - AS SHIPPED - is enabled and using an
unusable version of ditg?
>> ----------------------------------------
>> Feature #50: Freeze against a version of D-ITG
>> https://www.bufferbloat.net/issues/50
>>
>> Author: Dave Täht
>> Status: Closed
>> Priority: Immediate
>> Assignee: Walter de Donato
>> Category:
>> Target version: Boxes ready for South Africa deployment
>>
>>
>> And generate package for such.
>>
>>
>>
>>
> ----------------------------------------
> Feature #50: Freeze against a version of D-ITG
> https://www.bufferbloat.net/issues/50
>
> Author: Dave Täht
> Status: Closed
> Priority: Immediate
> Assignee: Walter de Donato
> Category:
> Target version: Boxes ready for South Africa deployment
>
>
> And generate package for such.
>
>
>
>"
171,Irving Reid,2011-05-23 18:45:42.709274,"Dave Täht wrote:
> the numbers in the lab (using wget on a large file on huchra which runs for 2+ minutes) show 97KB/sec when set to 840 dn/ 420 up. I suspect part of this is due to a mibbi vs megabit discrepancy in the reporting.
> 
> The numbers reported from a speedtest user in canada show roughly a 25% non-relationship to his actual speed ratio of 6M down, 420 up. I don't know what he was using to perform his actual tests. The ratio he has there is perilously close to the maximum possible for normal TCP/ip acks to get back (21x1 is about the best you can do)
> 
> Not knowing the exact data for the current defaults in use in South Africa, it soundes as though the performance difference there for a speedtest is over 30%.

FYI, it was a Mac (OS X 6.7), running a basic test using the ""www.speedtest.net"" web application under Safari, testing against nearby servers (as chosen by speedtest.net); I also had a ping running in the background. I was getting tons of lost ping packets until I adjusted my QOS settings to move ICMP into the ""express"" packet class. I have my QOS bandwidth set to 5800 up, 400 down.

With that, ping huchra.bufferbloat.net is giving me a pretty stable 82-83 ms RTT right now; when I start a speedtest, the RTT to huchra goes up to about 150ms during the download speed portion, and to about 100ms during the upload test. speedtest.net reports 5.39 Mbps up, 0.37Mbps down."
151,Walter de Donato,2011-05-26 03:09:06.948975,"To support this I need to modify the XML file we use for measurements results.

I should then add a ""retval"" attribute to the <measurement> tag:

<measurement param= tool= retval= srcip= dstip= timestamp= avg= std= min= max= med= iqr= />

I suppose that the XML parsing is done indipendently on the attributes order, right?
"
157,Walter de Donato,2011-05-26 03:16:00.206765,"lft seems to work properly.

I'm going to convert the bismark-tr script to work with it."
177,Walter de Donato,2011-05-26 03:58:27.26493,"I implemented a select-based solution to listen on several ports.

Now the bdmd daemon takes the port numbers as positional parameters

usage: ./bdmd.real <port> [ [port] ... ]

I updated also the bdmd wrapper to support start, stop, restart and info commands.

I tested it locally on my laptop by crafting probes at high rates (4000 probes/s on 4 listening ports).
After fixing some details, it seems to work properly.

Now I need to test it with real clients. 
Will do that on port numbers different from the one we are currently using, 
to let the old version continue its job while testing."
42,Walter de Donato,2011-05-26 07:37:07.921889,""
161,Nick Feamster,2011-05-27 16:41:54.253268,stick them on projectbismark.net for now
177,Dave Täht,2011-05-27 16:49:05.083107,"I am glad to know you are attempting to use port 53 on dp4, which then precludes putting a nameserver on it. I have moved the nameserver to a new machine, callisto. That said, binding to that port usually requires root privs, and um... there are other ports that could be used.

I have no idea if routing traffic through existing reserved ports is a good idea or not. Often, a stateful inspection firewall is, if anything, more weird about stuff going through ports it understands, and doesn't inspect much that runs above 1024.

There is something of a testlab setup at the moment at gatech, we can prototype newer stuff on weirder ports there, AND we can do it without involving dp4 at all, by doing testing on a new box for it, called metis.

So do you need to deploy this solution to south africa, like, ASAP, for some reason not set out in the bug?"
178,Abhishek Jain,2011-05-27 16:57:42.251352,""
181,Abhishek Jain,2011-05-27 17:06:30.700213,""
179,Abhishek Jain,2011-05-27 17:15:55.336402,""
182,Abhishek Jain,2011-05-27 17:26:43.006177,""
184,Abhishek Jain,2011-05-27 17:36:25.202281,""
183,Abhishek Jain,2011-05-27 17:42:18.197199,""
180,Abhishek Jain,2011-05-27 17:47:31.775237,""
171,Dave Täht,2011-05-27 18:16:54.08119,"@Irving

THANK YOU For the data. You'd also mentioned you were using bittorrent and the QoS was successfully helping in that regard?

I still find a factor of two difference for so-called ""express"" traffic to be unacceptable.

I'd also like to find a better way to classify ping. Making it be express is good for testing, but making it be ""bulk"" lets you see qos starting to kick in. Perhaps classifying different size pings differently would let the various bands be more visible.

And packet loss is a GOOD thing."
181,Dave Täht,2011-05-27 18:29:40.68324,"While I am glad to see bugs being opened and closed, I don't have any visibility as to WHERE the code is going.

Are these being checked into the dashboarddb repo on huchra? github? Or SVN?

Or slammed into the dp4 webserver naked and newborn to be directly inflicted upon the users?"
171,Dave Täht,2011-05-27 19:25:41.130241,"@irving: Also, for reference, what does speedtest report for qos off, while pinging?

Secondly, do you have the QoS overhead adjustment on or off? For ppoe it should probably be on, but I'd have to talk to the adsl-optimizer guy to truly understand ppoe connections."
186,Dave Täht,2011-05-29 05:43:02.432652,"config switch
        option name     rtl8366s
        option reset    1
        option enable_vlan 1
        # Blinkrate: 0=43ms; 1=84ms; 2=120ms; 3=170ms; 4=340ms; 5=670ms
        option blinkrate        2

config switch_vlan
        option device   rtl8366s
        option vlan     1
        option ports    ""0 1 2 3 5t""

I'm about to turn off vlan and see what happens."
186,Dave Täht,2011-05-29 06:23:08.707273,"Turned off the vlan on the switch, I see packets YES! Bwhahahahaa"
186,Dave Täht,2011-05-29 08:17:48.553526,"the wireless interfaces insist on coming up on the same mac as eth0

perhaps there is a mac wired into the ethernet interface that is not being seen?"
182,Nick Feamster,2011-05-29 11:36:30.267422,""
181,Nick Feamster,2011-05-29 11:36:51.925391,""
183,Nick Feamster,2011-05-29 11:38:41.377434,""
179,Nick Feamster,2011-05-29 11:38:53.310408,""
180,Nick Feamster,2011-05-29 11:39:05.429852,""
178,Nick Feamster,2011-05-29 11:39:20.047236,""
184,Nick Feamster,2011-05-29 11:39:36.314387,""
106,Nick Feamster,2011-05-29 11:40:26.578927,""
111,Nick Feamster,2011-05-29 11:40:52.137339,"This appears to be done now, for the basic parameters."
177,Walter de Donato,2011-05-30 01:00:27.872332,"I did all the necessary testing and
the multiport version is running on dp4 since May 27.
"
189,Dave Täht,2011-05-30 06:02:59.294846,""
190,Dave Täht,2011-06-01 11:33:48.409607,"He needs to be able to SEND messages to the list, but NOT get messages from the list.

So look at his membership page on your new mail server, and change him to doing 'nomail'. Otherwise, nasty mailing loops will occur.

"
190,Dave Täht,2011-06-01 11:36:48.649407,"heh. I never remember what goes in the comment field... my last comment made no sense without that:


'george burdell' is a robot. In your new list server, he needs to have the 'nomail' option set (this is a checkbox on the membership page), otherwise nasty mailing loops can occur. 

He should be able to 'send mail' to a list, but the list should not send him mail."
190,Nick Feamster,2011-06-01 11:37:26.151989,"Oh... yes, whoops.  Who is ""he""?

-Nick

On Jun 1, 2011, at 8:33 PM, gburdell@lists.bufferbloat.net wrote:

> 
> Issue #190 has been updated by Dave Täht.
> 
> Assignee set to Nick Feamster
> Priority changed from Normal to Immediate
> 
> He needs to be able to SEND messages to the list, but NOT get messages from the list.
> 
> So look at his membership page on your new mail server, and change him to doing 'nomail'. Otherwise, nasty mailing loops will occur.
> 
> 
> ----------------------------------------
> Support #190: Re: [Bismark-devel] network dashboard moved to github
> https://www.bufferbloat.net/issues/190
> 
> Author: David Taht
> Status: New
> Priority: Immediate
> Assignee: Nick Feamster
> Category: 
> Target version: 
> 
> 
> I  was wondering where updates had been going.
> 
> This is not the one containing the schema, but if this
> is the current one, I can merge again, or create a separate repo for it.
> 
> My assumption is that this, actually,
> is a forked version from where we were two weeks back, continuing on with
> mysql support.
> 
> On Wed, Jun 1, 2011 at 7:39 AM, Nick Feamster <feamster@cc.gatech.edu>wrote:
> 
>> https://github.com/bismark-devel/networkdashboard
>> 
>> _______________________________________________
>> Bismark-devel mailing list
>> Bismark-devel@lists.bufferbloat.net
>> https://lists.bufferbloat.net/listinfo/bismark-devel
>> 
> 
>"
190,Nick Feamster,2011-06-01 11:37:44.385343,"ok, so burdell should have ""nomail"" checked?

On Jun 1, 2011, at 8:36 PM, gburdell@lists.bufferbloat.net wrote:

> 
> Issue #190 has been updated by Dave Täht.
> 
> 
> heh. I never remember what goes in the comment field... my last comment made no sense without that:
> 
> 
> 'george burdell' is a robot. In your new list server, he needs to have the 'nomail' option set (this is a checkbox on the membership page), otherwise nasty mailing loops can occur. 
> 
> He should be able to 'send mail' to a list, but the list should not send him mail.
> ----------------------------------------
> Support #190: Re: [Bismark-devel] network dashboard moved to github
> https://www.bufferbloat.net/issues/190
> 
> Author: David Taht
> Status: New
> Priority: Immediate
> Assignee: Nick Feamster
> Category: 
> Target version: 
> 
> 
> I  was wondering where updates had been going.
> 
> This is not the one containing the schema, but if this
> is the current one, I can merge again, or create a separate repo for it.
> 
> My assumption is that this, actually,
> is a forked version from where we were two weeks back, continuing on with
> mysql support.
> 
> On Wed, Jun 1, 2011 at 7:39 AM, Nick Feamster <feamster@cc.gatech.edu>wrote:
> 
>> https://github.com/bismark-devel/networkdashboard
>> 
>> _______________________________________________
>> Bismark-devel mailing list
>> Bismark-devel@lists.bufferbloat.net
>> https://lists.bufferbloat.net/listinfo/bismark-devel
>> 
> 
>"
190,David Taht,2011-06-01 11:40:36.314963,"gburdell, nomail should be checked.

On Wed, Jun 1, 2011 at 12:37 PM, <gburdell@lists.bufferbloat.net> wrote:

>
> Issue #190 has been updated by Nick Feamster.
>
>
> ok, so burdell should have ""nomail"" checked?
>
> On Jun 1, 2011, at 8:36 PM, gburdell@lists.bufferbloat.net wrote:
>
> >
> > Issue #190 has been updated by Dave Täht.
> >
> >
> > heh. I never remember what goes in the comment field... my last comment
> made no sense without that:
> >
> >
> > 'george burdell' is a robot. In your new list server, he needs to have
> the 'nomail' option set (this is a checkbox on the membership page),
> otherwise nasty mailing loops can occur.
> >
> > He should be able to 'send mail' to a list, but the list should not send
> him mail.
> > ----------------------------------------
> > Support #190: Re: [Bismark-devel] network dashboard moved to github
> > https://www.bufferbloat.net/issues/190
> >
> > Author: David Taht
> > Status: New
> > Priority: Immediate
> > Assignee: Nick Feamster
> > Category:
> > Target version:
> >
> >
> > I  was wondering where updates had been going.
> >
> > This is not the one containing the schema, but if this
> > is the current one, I can merge again, or create a separate repo for it.
> >
> > My assumption is that this, actually,
> > is a forked version from where we were two weeks back, continuing on with
> > mysql support.
> >
> > On Wed, Jun 1, 2011 at 7:39 AM, Nick Feamster <feamster@cc.gatech.edu
> >wrote:
> >
> >> https://github.com/bismark-devel/networkdashboard
> >>
> >> _______________________________________________
> >> Bismark-devel mailing list
> >> Bismark-devel@lists.bufferbloat.net
> >> https://lists.bufferbloat.net/listinfo/bismark-devel
> >>
> >
> >
> ----------------------------------------
> Support #190: Re: [Bismark-devel] network dashboard moved to github
> https://www.bufferbloat.net/issues/190
>
> Author: David Taht
> Status: New
> Priority: Immediate
> Assignee: Nick Feamster
> Category:
> Target version:
>
>
> I  was wondering where updates had been going.
>
> This is not the one containing the schema, but if this
> is the current one, I can merge again, or create a separate repo for it.
>
> My assumption is that this, actually,
> is a forked version from where we were two weeks back, continuing on with
> mysql support.
>
> On Wed, Jun 1, 2011 at 7:39 AM, Nick Feamster <feamster@cc.gatech.edu
> >wrote:
>
> > https://github.com/bismark-devel/networkdashboard
> >
> > _______________________________________________
> > Bismark-devel mailing list
> > Bismark-devel@lists.bufferbloat.net
> > https://lists.bufferbloat.net/listinfo/bismark-devel
> >
>
>"
190,Nick Feamster,2011-06-01 11:42:52.454379,done
194,Dave Täht,2011-06-05 05:34:53.65751,no checksum offload is available in this driver
197,Dave Täht,2011-06-05 08:43:15.425529,ubuntu is putting two socket implemenations in where only one is neede.d
197,Dave Täht,2011-06-05 14:10:04.96488,"router side

config setup
	plutostart=no
	charonstart=yes
	charondebug=""ike 3""
#	charondebug=""ike 3,mgr 3,job 3,knl 3,net 3,enc 3,lib 3,dmn 3""

ca bismark
        cacert=bismarkCA.pem
        
conn %default
	ikelifetime=60m
	keylife=20m
	rekeymargin=3m
	keyingtries=1
	keyexchange=ikev2
	leftcert=cero1.pem
	left=192.168.42.1
	leftid=""cero1.taht.net""

conn vpn-test2
	left=fe02::3
	right=fe02::1
	rightid=""cruithne2.taht.net""
	leftsubnet=fe03::/64
	dpdaction=hold
	type=tunnel
	auto=route

Connecting side

nfig setup
	strictcrlpolicy=no
	crlcheckinterval=180
	plutodebug=control
	nat_traversal=yes
	charonstart=yes
	plutostart=no
#	charondebug=""ike 3,mgr 3,job 3,knl 3,net 3,enc 3,lib 3,dmn 3""

conn %default
	ikelifetime=60m
	keylife=20m
	rekeymargin=3m
	keyingtries=1
	keyexchange=ikev2
        left=192.168.42.123
        leftcert=cruithne.pem
	leftid=""cruithne2.taht.net""

ca bismark
	cacert=bismarkCA.pem

conn vpn-test2
        right=fe02::3
        rightsubnet=fe03::/64
        rightid=""cero1.taht.net""
        dpdaction=hold
        type=tunnel
        auto=route
"
193,Dave Täht,2011-06-09 13:54:43.448618,ath9k does not have checksum offload.
186,Dave Täht,2011-06-13 14:48:57.870475,"The only cure for this, assuming there is no mac addr assigned, is to either
invent one, or buy a OUI.

I REALLY want to route, not bridge."
80,Dave Täht,2011-06-13 15:06:16.990603,"6to4 can now be enabled by default!

There are issues with interior gateways, but that can wait another bug.

Thanks Jo-Philipp!"
97,Dave Täht,2011-06-13 15:07:14.488609,this appears to be fixed in both xwrt and luci
145,Dave Täht,2011-06-13 15:08:59.339433,"some of this problem is merely due to these mice-like messages getting stomped on by other traffic.

however, I think triggering a ra announce on a dhcp request is still a good idea."
168,Dave Täht,2011-06-13 21:16:42.95403,"I have multiple reports of the dhcp problem now. I am hoping that the switch patch fixes it,
but to test it fully I will have to hammer a router for several days from another router (or two or three) with dhcp queries.

Thankfully with the PDU coming online, if it hangs I can reset it.

I have several other related patches queued up, if that alone doesn't address the issue."
192,Dave Täht,2011-06-13 21:19:06.307348,ppoe is now installed by default. But the gui didn't pick it up or I did it wrong.
188,Dave Täht,2011-06-13 21:20:42.211926,but didn't appear in the package.
187,Dave Täht,2011-06-13 21:27:07.569088,"the cerowrt-dbg build now has tcp westwood (default), bic, cubic, and vegas. This lets us simulate better what is actually being used for tcp in the field, for various tests, including raw bandwidth, and the effect on qos methods.

To switch tcp algos:

echo 'cubic' > /proc/sys/net/ipv4/tcp_congestion_control 

It might be mildly better if these were external to the kernel, but they are very small."
143,Dave Täht,2011-06-13 21:28:56.368835,"the new web interface 'luci' does the right thing with firewall rules.

the underlying firewall rules still need to be revised (simplified) to work with luci correctly, however.
"
143,Dave Täht,2011-06-13 21:32:52.137504,"there is already a related bug re the firewall rules, so I can close this one."
157,Dave Täht,2011-06-13 21:34:18.931438,is lft what you want to use? or tcptraceroute? I need to install one or the other or both by default.
146,Dave Täht,2011-06-13 21:35:44.364923,"Nick: If you still care about the buffalo router, send me the bricked one..."
69,Dave Täht,2011-06-13 21:38:26.144537,"I hope to assume you can stick with the logo you got.

if not, please reopen this bug."
114,Dave Täht,2011-06-13 21:40:49.727534,duplicate bug AND fixed
79,Dave Täht,2011-06-13 21:42:57.656925,"multiple algos are now in the kernel.

see #187 for more details"
139,Dave Täht,2011-06-13 21:45:41.216115,"6to4 now checks for private ips.

While this could be made more robust, this makes it possible to enable v6 by default.

Thanks Jo-Philipp!"
186,Dave Täht,2011-06-13 21:50:18.759547,"I am frustrated enough by bridging to want to go pure routing. I can easily, with various forms of traffic on the switch, totally saturate the wireless bridge. Regrettably there is no extra mac on the wndrs.

Buying a full set of 'bufferbloat' mac ids will cost 1750.00 dollars. "
49,Dave Täht,2011-06-13 21:52:49.011524,"jim, can you ping the guy writing httping to put out a new release?"
157,Walter de Donato,2011-06-14 06:18:49.553528,"I confirm lft.
Please include it.
"
186,Jo-Philipp Wich,2011-06-16 05:44:07.150586,"This is a possible fix for the duplicate MAC address issue, the same trick is already applied to the Routerstation boards."
199,Dave Täht,2011-06-17 05:20:08.503882,"OK, the ppoe bug WAS mine, and it will be fixed in the next build"
186,Dave Täht,2011-06-24 12:57:05.871344,"Oh, thank you. I did NOT see this fix when it went by. "
191,Dave Täht,2011-07-10 14:30:17.067791,"we switched to wpad instead of wpa_supplicant

The sta problem remains, but needs another bug"
174,Dave Täht,2011-07-10 14:31:56.05153,"Switched to relatively saner scheme in cerowrt, See

http://www.bufferbloat.net/projects/cerowrt/wiki/Default_network_numbering

for details."
186,Dave Täht,2011-07-10 14:33:36.896905,"automagic mac generation fix appears to work well. Would suggest pushing into openwrt head, if you haven't already."
151,Dave Täht,2011-07-10 14:35:00.888057,"status, please"
142,Dave Täht,2011-07-10 14:39:05.191337,"seems to work, needs some testing"
121,Dave Täht,2011-07-10 14:54:24.519591,"and out of xinetd, so it can be restarted automatically.

It also caches all the roots via zone transfer.

It also follows every bind related rfc that I could find, not forwarding many, many zones to the roots.

lastly it adopts the fairly common .lan convention for home network naming for which there is no rfc, and I may well have mis configured that to forward to the roots....."
121,Dave Täht,2011-07-10 14:54:56.963913,"I really hate that the 'comment' field doesn't show up in redmine...

bind now runs in a complete chroot jail."
144,Dave Täht,2011-07-10 14:55:44.414607,Status please.
144,Srikanth Sundaresan,2011-07-10 14:57:20.000575,"There is none as of now. Will work with Walter on it this week.

On Jul 10, 2011, at 5:55 PM, gburdell@lists.bufferbloat.net wrote:

> 
> Issue #144 has been updated by Dave Täht.
> 
> 
> Status please.
> ----------------------------------------
> Bug #144: bismark-active should use fping
> https://www.bufferbloat.net/issues/144
> 
> Author: Dave Täht
> Status: New
> Priority: Urgent
> Assignee: Srikanth Sundaresan
> Category: 
> Target version: 1st gen working hardware
> 
> 
> Scripting around fping rather than ping would lead to more accurate results for pinging multiple servers, as you no longer would be timing program startup.
> 
>"
199,Dave Täht,2011-07-10 14:57:31.876676,"ntpclient still exists, it's small, closing this bug. Thx jo-philipp"
198,Dave Täht,2011-07-10 14:59:38.531911,"While I was delighted to see multiple ports being expressible (via spaces) in the firewall rules, they still generate one rule per port, by default, and qos, uses commas and : to represent ranges."
196,Dave Täht,2011-07-10 15:00:45.484717,"need to come up with sane ways to test it, and also figure out to what extent it will flatline a router...."
128,Dave Täht,2011-07-10 15:04:52.455831,"This was a duplicate of another bug, fixed by a patch by jo-philipp wich"
122,Dave Täht,2011-07-10 15:06:02.580832,"out of the box dnssec configuration done in cerowrt.

"
103,Dave Täht,2011-07-10 15:10:31.943176,"The system makes heroic attempts to get the correct time now. Short of embedding an atomic clock in every device, I don't know what else to do.

However I note that ntp -g functionality could be improved if it turned off the authenticated dns bit by default, or after a timeout."
175,Dave Täht,2011-07-10 15:11:48.858204,I hope to get around to signing bufferbloat.net shortly. That gets me to being able to use it from an update system that uses wget by default.
176,Dave Täht,2011-07-10 15:13:38.929381,"The package architecture for openwrt has issues.
There is no support for checking the dns authentication bit in the core ipkg system
(not only that but I have no idea how to do so from normal C, either, as yet.)

Still it's interesting, needed, useful, and on my very long list."
165,Dave Täht,2011-07-10 15:14:54.667651,How did the scripts get into git this time? Is there a svn tag or release number they are tied to?
118,Dave Täht,2011-07-10 15:19:33.286063,"the new iproute2 is in cerowrt. Seems to work.

Needs to get pushed back into openwrt, after a few days of testing."
95,Dave Täht,2011-07-10 15:23:55.263223,"being able to block 'X' by time of day is interesting enough - and un-dangerous enough - for me to want to give learning lua a shot by trying it. 

That said, I HATE having everything time of day related going through another firewall rule, so I'd probably try to do it with cron instead inserting/deleting the rule dyamically.

Or maybe a module for blocking macs by time of day already exists in luci or out of tree?"
50,Walter de Donato,2011-07-14 00:18:00.976139,"Just ported the latest version of D-ITG to uclibcxx.
I added it to the bismark-packages feed on github.

It now requires 334KB (binaries) + 189KB (uclibcxx). [stripped]"
65,Stephen Walker,2011-07-14 04:22:54.912112,Still wanted?
206,Matt Urbanski,2011-07-14 09:35:00.033252,"Running uftpd, killing the process, and then running the client causes a crash followed by a reboot. 

<pre>
root@gw:/tmp# uftp
Killed
root@gw:/tmp# ps 
  PID USER       VSZ STAT COMMAND
    1 root      1656 S    init
    2 root         0 SW   [kthreadd]
    3 root         0 SW   [ksoftirqd/0]
    4 root         0 RW   [kworker/0:0]
    6 root         0 SW   [rcu_kthread]
    7 root         0 SW<  [khelper]
   69 root         0 SW   [sync_supers]
   71 root         0 SW   [bdi-default]
   73 root         0 SW<  [kblockd]
  103 root         0 SW   [kswapd0]
  163 root         0 SW<  [ar71xx-spi]
  176 root         0 SW   [mtdblock0]
  181 root         0 SW   [mtdblock1]
  186 root         0 SW   [mtdblock2]
  191 root         0 SW   [mtdblock3]
  196 root         0 SW   [mtdblock4]
  201 root         0 SW   [mtdblock5]
  247 root         0 SW   [kworker/0:1]
  350 root         0 SW<  [ipolldevd]
  360 root         0 SW   [kworker/u:2]
  394 root         0 SWN  [jffs2_gcd_mtd3]
  416 root         0 SW   [khubd]
  432 root      1684 S    /bin/sh /etc/init.d/rcS S boot
  433 root      1656 S    init
  435 root      1648 S    logger -s -p 6 -t sysinit
  464 root      1660 S    syslogd -C16
  466 root      1640 S    klogd
  492 root       832 S    /sbin/hotplug2 --override --persistent --set-worker
  676 root         0 SW<  [cfg80211]
 1826 root      1660 S    udhcpc -t 0 -i ge00 -b -p /var/run/dhcp-ge00.pid -O
 2612 www-data  3444 S    lighttpd -f /etc/lighttpd/cerowrt.conf
 2636 root      1144 S    /usr/sbin/dropbear -P /var/run/dropbear.1.pid -p 22
 2642 root      3432 S    lighttpd -f /etc/lighttpd/lighttpd.conf
 2830 root      1164 S    radvd -C /var/etc/radvd.conf -m stderr_syslog -p /va
 2841 root      1208 S    xinetd
 2863 bind     12032 S    named -c /etc/bind/conf/named.conf -u bind -t /etc/c
 2871 nobody     936 S    /usr/sbin/dnsmasq -K -D -y -Z -b -E -6 /etc/dnsmasq_
 2872 root       936 S    /usr/sbin/dnsmasq -K -D -y -Z -b -E -6 /etc/dnsmasq_
 2902 root      1156 S    /usr/sbin/babeld -z3 -D -I /var/run/babeld.pid -c /e
 2928 root       764 S    /usr/bin/luci-bwc -d
 2933 root      1652 S    watchdog -t 5 /dev/watchdog
 2938 root      1232 S    /usr/sbin/polipo -c /var/etc/polipo.conf
 2955 root      2692 S    /usr/sbin/ntpd -g -p /var/run/ntpd.pid
 3056 root      1208 S    /usr/sbin/dropbear -P /var/run/dropbear.1.pid -p 22
 3057 root      1664 S    -ash
 3802 root         0 SW   [kworker/u:1]
 4050 root      2508 S <  uftpd -D /tmp/ -L works
 4265 root      1648 R    ps
root@gw:/tmp# ps | grep uftp
 4050 root      2508 S <  uftpd -D /tmp/ -L works
 4283 root      1640 D    grep uftp
root@gw:/tmp# kill 4050
root@gw:/tmp# uftp
Killed
root@gw:/tmp# ps | grep uftp
 4286 root      1640 R    grep uftp
root@gw:/tmp# uftp
uftp [ -U ] [ -R txrate ] [ -W txweight ] [ -m min_time ]
    [ -n ] [ -L logfile ] [ -B udp_buf_size ] [ -Y keytype ] [ -h hashtype ]
    [ -w sigtype ] [ -c ] [ -k key_file ] [ -K new_key_length ] [ -l ] [ -T ]
    [ -A announce_time ] [ -S status_time ] [ -a announce_interval ]
    [ -s status_interval ] [ -r register_interval ] [ -d done_interval ]
    [ -b mtu ] [ -t ttl ] [ -Q dscp ] [ -z | -Z ] [ -I interface ]
    [ -p port ] [ -j proxylist_file ] [ -q ] [ -f ] [ -y ] [ -x log_level ]
    [ -H host[,host...] | -H @hostlist_file | -F restart_file ] [ -o ]
    [ -X exclude_file ] [ -M pub_multicast_addr ] [ -P priv_multicast_addr ]
    [ -C cc_config_file ] [ -D dest_name ] [ -E base_dir[,base_dir... ] ]
    { -i list_file | file [ file... ] }
Killed
root@gw:/tmp# uftp
---ROUTER DISCONNECTS AND REBOOTS HERE---
Write failed: Broken pipe
matt@wontseeme:~/src/bismark_week/uftp-3.5.1$ 
</pre>"
202,Dave Täht,2011-07-14 13:33:26.387613,""
195,Dave Täht,2011-07-14 13:34:05.521282,""
209,Dave Täht,2011-07-16 03:48:20.090247,"I flashed the lastest build on matts router, which I'm told demonstrated the problem.

Frankly I don't remember if I tried 2.4ghz. 5 worked"
208,Dave Täht,2011-07-16 03:50:00.943606,"Hopefully this and #209 were related. The iptables thing is an open question and I don't know what the errors you got where.

I restarted the firewall and got no errors at all from iptables."
65,Dave Täht,2011-07-16 04:36:41.526191,"Dear Stephen.

I love you man. It's not physical or anything, however. :)
yes, I'd like nuttcp a lot, but not for today's attempt at a release candidate.

Can you slam it into ceropackages if you haven't already? Or openwrt? Somewhere? before wednesday next week?"
206,Dave Täht,2011-07-16 04:40:50.307153,"Did you guys actually fix crashing the router with utftp? What was the cause? if it's fixed, please document the solution and close the bug. I think I 'heard' the cause was trying to transfer too large a file...."
195,Dave Täht,2011-07-16 04:51:53.907339,"I have not had time to run oprofile on the code of late, but when I was testing iperf at 100+Mbit per second on ethernet, over ethernet only, (not over wireless) it was spending 22% of it's time in an unaligned instruction trap. 

I was going to try using netperf, instead, to see if it was a kernel problem rather than a userspace problem. 

oprofile is enabled in the current build and installable as a package. I forgot to enable the unaligned trap perf monitor, however in the rc1 build. 

(This is not a blocker for rc1 of cerowrt). The router runs at wire speeds at 100Mbit, even with only 4 buffers in the ethernet driver (however there's a problem with setting that that low, via ethtool, at gigE speeds, that locks up the port entirely. I'll file a bug on that shortly, with how to duplicate that exactly, see also the email on the lists)

ALSO:

Lots of iptables rules, using *multiport* matches (code in my Diffserv repo) also slowed the router down far more than expected. The new firewall code doesn't use multiport matches (although they could, I think, or I have the new syntax wrong), and I haven't had time to verify what happens with lots of ports in the latest cerowrt builds (I am opening more ports than usual, so that testing tools can abuse more stuff, like rsync)"
165,Dave Täht,2011-07-16 04:53:22.758756,"How did the scripts get into git this time? 

Can you close this bug, if you did it right?"
136,Dave Täht,2011-07-16 04:58:28.843664,"When I talk of regression testing, this was a showstopping bug last time that cost you 3 days and me a weekend.

I had had 'heard' that the bismark code was hanging again night before last, and I'm hoping it was merely a reflection of the other network problem we were encountering.

Does the Command and Control function of bismark still eat kittens in any way similar to this bug? It crashed routers inside of a day, last time...

I note that testing for this is highly automatable using snmp (are more than X processes running?) as well as with basic tools like repeating 'ps | grep the_evil_process | wc -l'
every 10 minutes, while hammering the router with login requests from bismark.


"
169,Dave Täht,2011-07-16 05:10:11.383301,"Is the fixed ip address for 'PROXY' here fixed? 

I don't care if this is fixed today. In fact if it isn't fixed, don't tell me you haven't fixed it yet and slip a fix in next week, when I'm not looking.

I know I can find this in the code in 2 seconds, but finding this problem still in there would be bad for my blood pressure.

When or if it is fixed, close the bug. NO PRIO 1 or 2s please."
192,Dave Täht,2011-07-16 05:22:06.602486,"So I have ppoe support integral this build.

I really really wish I could remember the guy's name, in canada, who reported this problem, tested the old solution, and got it working as an external package. In particular my concern is that the reduced mtu ppoe introduces (8 bytes less than normal) is not propigated to other utilities, notably radvd and the ipv6 setup routines.

He participated in another bug here, he's registered on bufferbloat.net, but so far, I can't find him or remember his name. I misremembered it once, as 'vincent'... I think... he's been on irc..."
65,Stephen Walker,2011-07-16 08:10:33.414535,Added it to ceropackages.
165,Srikanth Sundaresan,2011-07-16 10:38:41.521208,Following the git procedure
136,Srikanth Sundaresan,2011-07-16 10:40:47.091866,Script checks for previous instances before spawning new instance.
169,Walter de Donato,2011-07-16 10:48:06.842035,"We feel more comfortable to let it as is for now.
It gives us a fixed recovery point we can trust on also if
the DNS fails permanently.

We'll work on a better multi-management-server algorythm for the next release."
169,Dave Täht,2011-07-16 12:44:29.889301,"OK, thank you for the update.

You do realize that this ties you to dp4 - the server with a load average of 4, currently, on the wrong lan, for a long time?

Do you mean the 'next release' or the 'next release candidate'?

If you must use a fixed ip address, rather than dns, please ask your IT dept about the possibility of using 'anycast' in the future. Anycast is probably a better solution than DNS is, actually."
169,Walter de Donato,2011-07-16 12:52:54.419476,"PROXY points to porter-square and not to dp4.
Anyway anycast would be certainly the best solution.

I meant the next release, but if we are able to obtain the anycast address in time,
we can do it for the next release candidate."
169,Dave Täht,2011-07-16 12:57:57.882665,"going anycast eventually, or preferably soon, works for me either way.

thank you for correcting me as to where it pointed. How is the load average on that server, where is it, what is it, and what else does it do?"
169,Walter de Donato,2011-07-16 13:39:53.836728,"It isn't probably the best server to use for that, because it is the measurement server at Gatech,
but it is needed only occasionally for that purpose.

I just used it because it's the only server at Gatech where I have the permissions to set iptables rules...

Here is a fresh top:
top - 16:37:38 up 21 days,  1:35,  2 users,  load average: 0.00, 0.00, 0.00
Tasks:  87 total,   1 running,  86 sleeping,   0 stopped,   0 zombie
Cpu(s):  0.0%us,  0.0%sy,  0.0%ni,100.0%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Mem:   3374608k total,   535952k used,  2838656k free,   229872k buffers
Swap:  7815580k total,        0k used,  7815580k free,   120176k cached
"
169,Dave Täht,2011-07-16 13:42:48.886842,"I'm happy with that load average. I worry about dp4, however. A lot."
207,Dave Täht,2011-07-16 13:49:01.165033,"I have polipo now using gethostbyname in the rc1 candidate. It would be good to make this work right in the next release candidate however, and do some automated testing of both polipo and its caching system, with a usb stick as well as a usb hard disk.

"
210,Dave Täht,2011-07-16 14:10:43.672818,"Trying just reducing txqueuelen for now, will fix ethtool another day."
211,Dave Täht,2011-07-16 14:20:18.078142,This is on linux. ubuntu 10.10. I will upload a screenshot if nobody else has this version of firefox running on their platform.
169,Nick Feamster,2011-07-16 14:26:51.310474,"If you need anther server to point, to, let me know and we can set you up with permissions.

Nick

On Jul 16, 2011, at 3:42 PM, gburdell@lists.bufferbloat.net wrote:

> 
> Issue #169 has been updated by Dave Täht.
> 
> 
> I'm happy with that load average. I worry about dp4, however. A lot.
> ----------------------------------------
> Bug #169: PROXY is still hard coded in the bismark.conf file
> https://www.bufferbloat.net/issues/169
> 
> Author: Dave Täht
> Status: New
> Priority: Normal
> Assignee: Walter de Donato
> Category: 
> Target version: 2nd generation (worldwide bismark measurements)
> 
> 
> Where is this machine?
> 
> from bismark.conf:
> 
> # Bismark Proxy Server
> PROXY=143.215.131.173
> PROXY_PORT=123
> 
> Should this be a DNS address?
> 
> 
>"
211,Stephen Walker,2011-07-16 23:30:33.478327,"FWIW, https://browsershots.org/https://home.comcast.net/~sdwalker/uberwrt/index.html"
211,Stephen Walker,2011-07-16 23:51:19.626715,"Bad CSS on https://github.com/dtaht/ceropackages/blob/master/utils/cerowrt-chrome/files/etc/uberwrt/static/cerowrtstyle.css#L67 & https://github.com/dtaht/ceropackages/blob/master/utils/cerowrt-chrome/files/etc/uberwrt/static/cerowrtstyle.css#L78.

@div.menu a:link,
div.menu a:visited@

&

@div.menu a:hover,
div.menu a:active@

is what I believe were intended."
210,Dave Täht,2011-07-17 04:43:55.223984,"After removing the debloating script entirely, which calls ethtool and changes txqueuelen, we were able to get from a reliably reproducable test case (driver died after 7 packets) to where the wan port seemed to actually work, for one router, in limited testing. 

In doing far more extensive testing, I was able to not only crash the wan port in a little over 500 packets, but actually get an kernel oops, even *without* fiddling with these parameters. I will upload the oops later (it was not very revealing regardless).

These routers do have a patch to their mac address creation routine, but I don't think that is the problem, what I am thinking is that there is a real & SUBTLE problem in the reset routines (and/or the ring buffer) that happens when there is lots of other traffic on the wan.

I will look at this MUCH harder after I get caught up on sleep and back to my own lab.
"
205,Dave Täht,2011-07-17 05:23:24.6362,"# We have a terrible circular dependency on dnssec on valid time

# xinetd comes up S46
# ntpd comes up S46
# bind-prep is S46
# bind is S48

# We don't have valid time on boot. A new router may have sat in a box for months or years
# A router may also have been turned off for a long period of time.
# In either case, there is no battery backed up clock, and writing flash on a regular basis for any reason, is a bad idea. 
# NTP needs DNS to start AND
# DNSSEC needs valid time to work
# DNSSEC comes up enabled by default in named, if turned on 
# ntp -g does not issue dns queries with the unauthenticated bit on
# Thus we can't come up with valid time until ntp does
# bind needs to get valid roots

# ntp may or may not have a signal that says 'HI! I've got valid time now, go on!""
# There isn't a good way to know if dnsseq validation is enabled or disabled via named
# And we need three ntp servers to vote to slew the time
# Usually. And we need the network up, and connected to the internet before we can do anything
# We could just wait for a time slew event
# So my first hacky solution was to have lots of ntp servers in the conf file, turn off bind's dnssec validation on boot, monitor time via ntpd until it had contacted 3 valid servers and slewed the time, then reload bind's confs with dnssec turned on.
# But I fear this has introduced a depenency on getting the roots right in the first place.
# A mildly better for this would be to modify ntp -g to send queries with unauth on, and to have it announce to somewhere ""I'm happy now, go on do what you need that needs time"", but it's only partial due to the other dependencies. 
# Somehow.
"
157,Dave Täht,2011-07-18 07:07:28.389993,"The default build(s) of cerowrt and bismark 'atlanta' have lft as part of the main image now. It seems to work well. we could use some more documentation on how to use it properly, and how, exactly, it's used in bismark, on the wiki, but I'm closing this bug regardless."
208,Srikanth Sundaresan,2011-07-18 19:53:14.430327,""
213,Dave Täht,2011-07-19 04:56:11.246173,"I told you it was broken. Now you found out for yourself.

The only thing that has ever worked in this case, is assigning these interfaces crypto addresses, which I'd documented heavily,


Deletion, or for that matter, addition, of interfaces, has been broken for a long time.

"
115,Dave Täht,2011-07-19 05:13:46.841955,SFB is now part of the 'ocean city' release.
204,Jim Gettys,2011-07-19 07:14:02.982329,"Off the wall idea: I wonder what size Lennart Poettering's systemd is?  It's like inetd on steroids, and applicable to things other than network services....
"
213,Srikanth Sundaresan,2011-07-19 08:48:36.891197,"I must have missed that. Is there a fix on the horizon?

We should at least give users another option of keeping/removing that."
211,Jim Gettys,2011-07-19 09:16:07.429318,"Fixed, I hope, and pushed.  Should be in next build.

Tested on both Chrome and Firefox.

Haven't tried IE 8 (the only version of IE worth worrying about at this date, as far as I can tell; even Microsoft is trying to get rid of IE6, and we cater for early adopters...)
"
204,Dave Täht,2011-07-19 09:47:31.522436,"I looked at both systemd and launchd, shuddered, and moved on. I'm not letting lennart's design philosophy anywhere near an embedded platform.

that said I have half a patch for xinetd to better control the oom-killer, but for some reason it couldn't set child processes to anything other than 0 or 1000. I liked very much that it could set itself to 1000, however, and I thought about putting it in regardless of the problems.

if anybody wants to play with it, I'll upload it here."
211,Stephen Walker,2011-07-19 11:00:17.294168,"Still broken on IE8 & Firefox 3.6.18.

""CSS history leaking changes"":https://blog.mozilla.com/security/2010/03/31/plugging-the-css-history-leak/ are why you're not seeing it on newer ""Chrome"":https://bugs.webkit.org/show_bug.cgi?id=24300 & ""Firefox"":https://bugzilla.mozilla.org/show_bug.cgi?id=147777 releases."
206,Dave Täht,2011-07-19 14:56:56.417208,Still a problem? Or was this crash related to attempting to transfer your entire pr0n connection to the router?
170,Walter de Donato,2011-07-19 15:00:23.557376,""
177,Walter de Donato,2011-07-19 15:03:50.104081,"It worked without issues for more than 2 months, so I assume it works correctly."
210,Dave Täht,2011-07-22 19:18:23.305298,pointed out by jow (thx!) nbd (double thx!) made a string of commits wednesday that look very promising to fix this bug. I will attempt a new build tomorrow morning.
60,Walter de Donato,2011-07-26 01:51:06.689964,""
210,Dave Täht,2011-07-26 07:17:17.008459,"Nope.

Although you can ifconfig down and up and get back in business, this is the oops I get

ADDRCONF(NETDEV_UP): ge00: link is not ready
ar71xx: pll_reg 0xb8050014: 0x11110000
ge00: link up (1000Mbps/Full duplex)
ADDRCONF(NETDEV_CHANGE): ge00: link becomes ready
------------[ cut here ]------------
WARNING: at net/sched/sch_generic.c:256 dev_watchdog+0x16c/0x274()
NETDEV WATCHDOG: ge00 (ag71xx): transmit queue 0 timed out
Modules linked in: gpio_buttons xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah ip6table_raw ip6_queue ip6table_mangle ip6table_filter ip6_tables nf_conntrack_ipv6 nf_defrag_ipv6 ipt_SET ipt_set ip_set_setlist ip_set_portmap ip_set_nethash ip_set_macipmap ip_set_iptreemap ip_set_iptree ip_set_ipportnethash ip_set_ipportiphash ip_set_ipporthash ip_set_ipmap ip_set_iphash ip_set nf_nat_irc nf_conntrack_irc nf_nat_ftp nf_conntrack_ftp xt_HL xt_hl ipt_ECN xt_CLASSIFY xt_time xt_tcpmss xt_statistic xt_mark xt_length ipt_ecn xt_DSCP xt_dscp xt_string xt_layer7 xt_quota xt_pkttype xt_physdev xt_owner ipt_MASQUERADE iptable_nat nf_nat xt_recent xt_helper xt_connmark xt_connbytes xt_conntrack xt_NOTRACK iptable_raw xt_state nf_conntrack_ipv4 nf_defrag_ipv4 nf_conntrack pppoe pppox ipt_REJECT xt_TCPMSS ipt_LOG xt_comment xt_multiport xt_mac xt_limit iptable_mangle iptable_filter ip_tables xt_tcpudp x_tables ifb sit tunnel4 tun ppp_async ppp_generic slhc vfat fat autofs4 ath9k ath9k_common ath9k_hw ath nls_utf8 nls_iso8859_2 nls_iso8859_15 nls_iso8859_13 nls_iso8859_1 nls_cp437 mac80211 ts_fsm ts_bm ts_kmp crc_ccitt cfg80211 compat arc4 aes_generic crypto_algapi ipv6 usb_storage ohci_hcd ehci_hcd sd_mod ext4 jbd2 usbcore scsi_mod nls_base mbcache crc16 leds_gpio button_hotplug gpio_keys_polled input_polldev input_core
Call Trace:
[<8026ce24>] dump_stack+0x8/0x34
[<80075238>] warn_slowpath_common+0x78/0xa4
[<800752ec>] warn_slowpath_fmt+0x2c/0x38
[<801ef7d0>] dev_watchdog+0x16c/0x274
[<8007f468>] run_timer_softirq+0x14c/0x1ec
[<8007a9f4>] __do_softirq+0xac/0x15c
[<8007abfc>] do_softirq+0x48/0x68
[<800610e0>] plat_irq_dispatch+0x4c/0x17c
[<8006258c>] ret_from_irq+0x0/0x4
[<80062780>] r4k_wait+0x20/0x40
[<800640fc>] cpu_idle+0x24/0x44
[<802fc8d8>] start_kernel+0x36c/0x38c

---[ end trace d0fa80935a954c41 ]---
ge00: tx timeout
ge00: tx timeout
ge00: tx timeout
ge00: tx timeout
ge00: tx timeout
ge00: tx timeout
ge00: tx timeout
ge00: tx timeout
ge00: tx timeout
ge00: tx timeout
ge00: tx timeout
ge00: tx timeout
ge00: link down
ADDRCONF(NETDEV_UP): ge00: link is not ready
ar71xx: pll_reg 0xb8050014: 0x11110000
ge00: link up (1000Mbps/Full duplex)
ADDRCONF(NETDEV_CHANGE): ge00: link becomes ready
ge00: no IPv6 routers present
ge00: link down
ar71xx: pll_reg 0xb8050014: 0x11110000
ge00: link up (1000Mbps/Full duplex)
"
210,Dave Täht,2011-07-26 07:21:26.365323,"The build for this is currently living at:

http://huchra.bufferbloat.net/~cero1/cerowrt-wndr3700-1.0rc2/

Although it fixes nearly all the other outstanding priority 1 bugs, this one is a showstopper, so I'm cancelling the rc2 release and going on to rc3 this week."
210,Dave Täht,2011-07-26 09:20:38.769099,"Data point: On a freshly flashed router with this build, connected via it's switched port to the wan port of the previously flashed router (same build), the new router comes up 'green' for it's connection light, whilst the old router is orange.

Either this means that GigE/100Mbit is not correctly being detected, or that the switch configuration for the blinkenlights is wrong, or.... "
210,Dave Täht,2011-07-26 09:25:05.130266,"Dave Täht wrote:
> Data point: On a freshly flashed router with this build, connected via it's switched port to the the wan port of the previously flashed router (same build), the new router comes up 'green' for it's connection light, whilst the old router is orange.
> 
> Either this means that GigE/100Mbit is not correctly being detected, or that the switch configuration for the blinkenlights is wrong, or....

"
210,Dave Täht,2011-07-26 10:15:52.237529,"Interestingly, I changed the debloat script to change ethtool in this sequence, rather than the opposite. No oops, but the driver is just as hung. I also noticed that I can actually run 02-debloat in advance of bringing the device up (00-netstate)... which I hope will fix it.

case $devtype in                      
        0)  ethtool -G $DEV tx 4 ;
        ip link set $DEV txqueuelen 8;;


ge00      Link encap:Ethernet  HWaddr C4:3D:C7:98:69:15  
          inet addr:172.30.42.45  Bcast:172.30.42.63  Mask:255.255.255.224
          inet6 addr: fe80::c63d:c7ff:fe98:6915/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:4 errors:0 dropped:0 overruns:0 frame:0
          TX packets:6 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:8 
          RX bytes:872 (872.0 B)  TX bytes:1146 (1.1 KiB)
          Interrupt:5 
"
210,Dave Täht,2011-07-26 10:23:31.818168,"so with the debloating script running before netstate, AND a sleep 1 between the events, I
get an oops again...

WARNING: at net/sched/sch_generic.c:256 dev_watchdog+0x16c/0x274()
NETDEV WATCHDOG: ge00 (ag71xx): transmit queue 0 timed out
Modules linked in: gpio_buttons xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah ip6table_raw ip6_queue ip6table_mangle ip6table_filter ip6_tables nf_conntrack_ipv6 nf_defrag_ipv6 ipt_SET ipt_set ip_set_setlist ip_set_portmap ip_set_nethash ip_set_macipmap ip_set_iptreemap ip_set_iptree ip_set_ipportnethash ip_set_ipportiphash ip_set_ipporthash ip_set_ipmap ip_set_iphash ip_set nf_nat_irc nf_conntrack_irc nf_nat_ftp nf_conntrack_ftp xt_HL xt_hl ipt_ECN xt_CLASSIFY xt_time xt_tcpmss xt_statistic xt_mark xt_length ipt_ecn xt_DSCP xt_dscp xt_string xt_layer7 xt_quota xt_pkttype xt_physdev xt_owner ipt_MASQUERADE iptable_nat nf_nat xt_recent xt_helper xt_connmark xt_connbytes xt_conntrack xt_NOTRACK iptable_raw xt_state nf_conntrack_ipv4 nf_defrag_ipv4 nf_conntrack pppoe pppox ipt_REJECT xt_TCPMSS ipt_LOG xt_comment xt_multiport xt_mac xt_limit iptable_mangle iptable_filter ip_tables xt_tcpudp x_tables ifb sit tunnel4 tun ppp_async ppp_generic slhc vfat fat autofs4 ath9k ath9k_common ath9k_hw ath nls_utf8 nls_iso8859_2 nls_iso8859_15 nls_iso8859_13 nls_iso8859_1 nls_cp437 mac80211 ts_fsm ts_bm ts_kmp crc_ccitt cfg80211 compat arc4 aes_generic crypto_algapi ipv6 usb_storage ohci_hcd ehci_hcd sd_mod ext4 jbd2 usbcore scsi_mod nls_base mbcache crc16 leds_gpio button_hotplug gpio_keys_polled input_polldev input_core
Call Trace:
[<8026ce24>] dump_stack+0x8/0x34
[<80075238>] warn_slowpath_common+0x78/0xa4
[<800752ec>] warn_slowpath_fmt+0x2c/0x38
[<801ef7d0>] dev_watchdog+0x16c/0x274
[<8007f468>] run_timer_softirq+0x14c/0x1ec
[<8007a9f4>] __do_softirq+0xac/0x15c
[<8007abfc>] do_softirq+0x48/0x68
[<800610e0>] plat_irq_dispatch+0x4c/0x17c
[<8006258c>] ret_from_irq+0x0/0x4
[<80062780>] r4k_wait+0x20/0x40
[<800640fc>] cpu_idle+0x24/0x44
[<802fc8d8>] start_kernel+0x36c/0x38c

---[ end trace 99006a3a445e09e2 ]---
ge00: tx timeout
"
210,Dave Täht,2011-07-26 10:32:12.019755,"So I can consistently lock it up by running ethtool -G ge00 tx 4 while there is traffic...

but changing txqueuelen seems to work.

I note that I rename devices in part because I can never remember which is the lan/wan ports and in part to make firewall rules easier. ge00 is the wan port. Which also has the patch to give it a unique mac...

Moving on to attempting this change much earlier in the boot."
210,Dave Täht,2011-07-26 10:37:43.463106,"I feel compelled to point out that driver buffering should probably come up automatically different when the link state is detected to be gigE, 100 or 10Mbit, but notice when it has been changed via ethtool...

all Linux network drivers should do that, actually. The problems we are having with the ar71xx... is just the first, in a long road, towards getting there. 

I ran into similar problems attempting to debloat the common laptop 'e1000' driver, where it worked at 100Mbit, but failed to do TSO offload properly at gigE speeds, with buffers below 64."
210,Dave Täht,2011-07-26 10:41:09.937738,"success, I think.

I moved resetting ethtool to VERY early in the boot sequence in the S10boot script... and got a working boot. Need to do some load testing...

	killall -q hotplug2
	# Change device buffers
	ethtool -G eth0 tx 4
	ethtool -G eth1 tx 4 
        # change device names
	/sbin/fixeth



root@OpenWrt:~# ifconfig se00
se00      Link encap:Ethernet  HWaddr C6:3D:C7:98:69:14  
          inet addr:172.30.42.33  Bcast:172.30.42.63  Mask:255.255.255.224
          inet6 addr: fe80::c43d:c7ff:fe98:6914/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:1116 errors:0 dropped:7 overruns:12 frame:0
          TX packets:1059 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:8 
          RX bytes:105475 (103.0 KiB)  TX bytes:113162 (110.5 KiB)
          Interrupt:4 

root@OpenWrt:~# ifconfig ge00
ge00      Link encap:Ethernet  HWaddr C4:3D:C7:98:69:15  
          inet addr:172.30.42.45  Bcast:172.30.42.63  Mask:255.255.255.224
          inet6 addr: fe80::c63d:c7ff:fe98:6915/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:86 errors:0 dropped:0 overruns:0 frame:0
          TX packets:77 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:8 
          RX bytes:11302 (11.0 KiB)  TX bytes:11454 (11.1 KiB)
"
210,Jim Gettys,2011-07-26 10:45:15.029017,"The ring buffer is completely independent of the transmit queue in Linux today.

This is a major bug in Linux (and other OS's design), and we'll be discussing this at LPC, I hope.

And yes, the default txqueuelen the driver should return should depend on the link speed; this is a ""safe"" change.  Cutting to 100 packets at 100Mbps, and (maybe) 10 at 10Mbps should have the same effect as we have now without any chance of introducing problems.  It's certainly the short term ""hack"" until we have more intelligent buffer management across the rings an transmit queue (and queue disciplines).
"
205,Dave Täht,2011-07-26 18:41:18.166203,"See also discussion at:

https://lists.bufferbloat.net/pipermail/bloat-devel/2011-July/000206.html"
214,Stephen Walker,2011-07-26 20:45:48.529386,"Worksforme.
(I locally split the monolithic netperf package into client & server packages.)

@$ grep rstrip logs/package/feeds/packages/netperf/compile.txt
NM=""i486-openwrt-linux-uclibc-nm"" STRIP=""/home/sdwalker/openwrt/staging_dir/host/bin/sstrip"" STRIP_KMOD=""i486-openwrt-linux-uclibc-strip --strip-unneeded -R .comment -R .pdr -R .mdebug.abi32 -R .note.gnu.build-id -R .gnu.attributes -R .reginfo -x"" /home/sdwalker/openwrt/scripts/rstrip.sh /home/sdwalker/openwrt/build_dir/target-i386_uClibc-0.9.32/netperf-2.5.0r449/ipkg-x86/netperf
rstrip.sh: /home/sdwalker/openwrt/build_dir/target-i386_uClibc-0.9.32/netperf-2.5.0r449/ipkg-x86/netperf/usr/bin/netperf:executable
NM=""i486-openwrt-linux-uclibc-nm"" STRIP=""/home/sdwalker/openwrt/staging_dir/host/bin/sstrip"" STRIP_KMOD=""i486-openwrt-linux-uclibc-strip --strip-unneeded -R .comment -R .pdr -R .mdebug.abi32 -R .note.gnu.build-id -R .gnu.attributes -R .reginfo -x"" /home/sdwalker/openwrt/scripts/rstrip.sh /home/sdwalker/openwrt/build_dir/target-i386_uClibc-0.9.32/netperf-2.5.0r449/ipkg-x86/netserver
rstrip.sh: /home/sdwalker/openwrt/build_dir/target-i386_uClibc-0.9.32/netperf-2.5.0r449/ipkg-x86/netserver/usr/bin/netserver:executable@

@$ ls -l build_dir/target-i386_uClibc-0.9.32/netperf-2.5.0r449/ipkg-x86/net*/usr/bin/net*
-rwxr-xr-x 1 sdwalker sdwalker 156297 2011-07-26 23:06 build_dir/target-i386_uClibc-0.9.32/netperf-2.5.0r449/ipkg-x86/netperf/usr/bin/netperf
-rwxr-xr-x 1 sdwalker sdwalker 163273 2011-07-26 23:06 build_dir/target-i386_uClibc-0.9.32/netperf-2.5.0r449/ipkg-x86/netserver/usr/bin/netserver@

@$ file build_dir/target-i386_uClibc-0.9.32/netperf-2.5.0r449/ipkg-x86/net*/usr/bin/net*
build_dir/target-i386_uClibc-0.9.32/netperf-2.5.0r449/ipkg-x86/netperf/usr/bin/netperf:     ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked (uses shared libs), corrupted section header size
build_dir/target-i386_uClibc-0.9.32/netperf-2.5.0r449/ipkg-x86/netserver/usr/bin/netserver: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked (uses shared libs), corrupted section header size@

@$ ls -l build_dir/target-i386_uClibc-0.9.32/netperf-2.5.0r449/src/net*
-rwxr-xr-x 1 sdwalker sdwalker 179862 2011-07-26 23:06 build_dir/target-i386_uClibc-0.9.32/netperf-2.5.0r449/src/netperf
-rwxr-xr-x 1 sdwalker sdwalker 188188 2011-07-26 23:06 build_dir/target-i386_uClibc-0.9.32/netperf-2.5.0r449/src/netserver@

@$ file build_dir/target-i386_uClibc-0.9.32/netperf-2.5.0r449/src/net*
build_dir/target-i386_uClibc-0.9.32/netperf-2.5.0r449/src/netperf:   ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked (uses shared libs), not stripped
build_dir/target-i386_uClibc-0.9.32/netperf-2.5.0r449/src/netserver: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked (uses shared libs), not stripped@"
214,Dave Täht,2011-07-27 06:44:54.761479,"yea, but that was x86, not mips... stripping it would cut the size in half, it looks like.

$(STRIP) in the makefile?"
201,Dave Täht,2011-07-27 06:47:03.126518,There was a huge thread on this in private email discussing various approaches. I don't know what was ultimately decided upon.
214,Stephen Walker,2011-07-27 10:45:32.340579,"Dave Täht wrote:
> yea, but that was x86, not mips... stripping it would cut the size in half, it looks like.
> 
> $(STRIP) in the makefile?

The ""default sstrip'ping"":https://dev.openwrt.org/browser/trunk/Config.in#L316 doesn't care about $ARCH."
210,Dave Täht,2011-07-27 15:35:14.508983,I have proven to my satisfaction that 4 driver buffers + 8 txqueuelen buffers are enough to have sustained 100Mbit performance on this hardware at 100Mbit. We can even go lower...
210,Dave Täht,2011-07-27 19:18:52.518832,""
215,Dave Täht,2011-07-27 19:19:31.2143,""
214,Dave Täht,2011-07-27 19:30:55.583449,"My question was do I need to add a $(STRIP) to the package? and to ditg, named-latest, etc?

The mips binary is nearly twice the size of the x86, so I assume I need to do something..."
214,Dave Täht,2011-07-27 19:45:57.936423,gonna just try it...
214,Dave Täht,2011-07-27 19:55:56.363614,"so the answer is no, it is stripped."
207,Dave Täht,2011-07-27 20:07:32.420158,""
162,Dave Täht,2011-07-27 20:07:47.691748,""
129,Dave Täht,2011-07-27 20:08:02.624068,""
125,Dave Täht,2011-07-27 20:08:23.650159,""
118,Dave Täht,2011-07-27 20:08:46.207005,""
124,Dave Täht,2011-07-27 20:09:03.984488,""
90,Dave Täht,2011-07-27 20:09:47.695894,"We switched to the luci gui but that too, has no web interface for bind."
113,Dave Täht,2011-07-27 20:10:06.574215,""
45,Dave Täht,2011-07-27 20:10:24.161574,""
89,Dave Täht,2011-07-27 20:10:41.209991,""
112,Dave Täht,2011-07-27 20:11:09.849943,""
126,Dave Täht,2011-07-27 20:11:39.482214,""
129,Dave Täht,2011-07-27 20:13:16.024226,""
116,Dave Täht,2011-07-27 20:17:02.408836,""
55,Dave Täht,2011-07-27 20:17:02.696954,""
143,Dave Täht,2011-07-27 20:17:02.99383,""
100,Dave Täht,2011-07-27 20:17:03.299525,""
168,Dave Täht,2011-07-27 20:17:03.894544,""
115,Dave Täht,2011-07-27 20:17:04.292579,""
205,Dave Täht,2011-07-28 19:47:41.312326,""
186,Dave Täht,2011-07-28 19:55:31.383964,""
65,Dave Täht,2011-07-28 19:55:49.654706,""
168,Dave Täht,2011-07-28 19:56:15.645878,""
86,Dave Täht,2011-07-28 19:57:21.791632,""
215,Dave Täht,2011-07-28 19:57:45.12176,""
216,Dave Täht,2011-07-28 20:01:50.197969,Andrew Mcgregor is my new god.
151,Walter de Donato,2011-07-29 08:22:23.895967,""
154,Walter de Donato,2011-07-29 08:28:55.565169,"I think this issue no longer make sense.
I'm cleaning old stuff, so I'm rejecting it."
137,Walter de Donato,2011-07-29 08:31:25.111682,""
218,Dave Täht,2011-07-31 06:59:00.036395,"I have heard multiple reports of 2.4 ghz weirdnesses over the last 4 months with no solid data on what kind of hardware it was happening on. Could I convince some folk to install the lastest release candidate of cerowrt, get connected at 2.4 ghz (using both crypto, and not!), and stay online for a while - days, even - to see what happens? so we can gain insight into the existence or non-existence of this problem?

A temporary home for cerowrt release candidates is at:

http://huchra.bufferbloat.net/~cero1/

I hope to get an rc5 out late this coming week.

And I hope we get the testlab back up again soon.
"
214,Dave Täht,2011-07-31 07:55:11.011535,""
65,Dave Täht,2011-07-31 07:56:36.441818,""
216,Dave Täht,2011-07-31 07:57:16.483864,""
121,Dave Täht,2011-07-31 07:59:53.823693,it would be nice to know if addzone worked in this chroot jail.
195,Dave Täht,2011-07-31 08:02:20.083967,"Would certainly like an oprofiling expert to look at this one, again, using netperf vs iperf to see if it is userspace or not.

I again failed to include the unaligned trap perf counter in rc4 however."
206,Dave Täht,2011-07-31 08:03:51.553129,What is the correct status of the uftp bug??
210,Dave Täht,2011-07-31 08:17:13.969964,""
207,Dave Täht,2011-07-31 08:18:00.431015,"I switched it back to normal - and on my version of rc4, it worked."
216,Dave Täht,2011-07-31 10:49:06.025933,"Some notes from Andrew:

net/mac80211/rc80211_minstrel.c

This function:

 376 static void
 377 minstrel_rate_init(void *priv, struct ieee80211_supported_band *sband,
 378                struct ieee80211_sta *sta, void *priv_sta)

Initialises the rate table, based on:

 496 static void *
 497 minstrel_alloc(struct ieee80211_hw *hw, struct dentry *debugfsdir)

 520         /* maximum time that the hw is allowed to stay in one MRR segment */
 521         mp->segment_size = 6000;


The unit is 'TU', an 802.11 specific unit that is a little more than a microsecond.

For 802.11n

net/mac80211/rc80211_minstrel_ht.c

 459 static void
 460 minstrel_calc_retransmit(struct minstrel_priv *mp, struct minstrel_ht_sta *mi,
 461                          int index)

Uses the same segment_size.  Arguably, that's wrong.  I expect that you want to add an ht_segment_size to the structure, so 11n can be tuned separately.  A sensible default might be around 500 TU.

Structure is defined in net/mac80211/rc80211_minstrel.h:

 70 struct minstrel_priv {
 71         struct ieee80211_hw *hw;
 72         bool has_mrr;
 73         unsigned int cw_min;
 74         unsigned int cw_max;
 75         unsigned int max_retry;
 76         unsigned int ewma_level;
 77         unsigned int segment_size;
 78         unsigned int update_interval;
 79         unsigned int lookaround_rate;"
216,Dave Täht,2011-07-31 10:54:55.957285,"Felix says the patch is no good as is:

""No retrans is not good. No retrans makes gaps in the client side reorder window. Gaps in client buffers is bad, makes traffic stall and latencies.""

I asked if 1 retransmit was enough, as an infinite loop here is very bad... 1.6 sec ping time going 40 meters (obviously very bad conditions, but that was intentional)

Felix wrote:

""If it's doing infinite retry, then that's a bug in the per-subframe retry count tracking and should be fixed properly.

About the 1.6 seconds: Yes, it would be nice if ath9k was able to drop packets more easily, but that requires some more surgery in the xmit path, which I'm going to take care of eventually.

In the mean time I'm not going to apply any kludges that simply trade one problem for another (and have the potential to create nasty side effects).""

And Andrew replied:

""I may be able to put a few cycles in to this shortly… there's a tradeoff here, and continually recycling is definitely the wrong thing.  I realise that dropping here is the wrong thing, but it's less wrong than retrying forever.  With a fairly small receive window, it won't be that bad.""

"
216,Dave Täht,2011-07-31 10:57:05.7658,"Then felix replied:

The receive window typically isn't small, it's often as big as 64 frames. The only way to prevent that from messing up the receiver state is to send a BAR for failed frames, and that means pushing even more frames to the tx queue, thus potentially making the problem even worse.

I have the following ideas for attacking the root causes of bloated queues with aggregation:

#. Delay the sequence number assignment to the point where it actually transmits a frame for the first time. That allows the driver to pick any frame that hasn't been transmitted yet for dropping when the queue gets full.
#. Keep track of the size of the sequence number gap of pending frames. That allows the driver to make a better decision of when to drop a frame and send a BAR or when to retry some more.
#. Allow the driver to either try different rates for retransmissions, or to request another rate control lookup. The code for that should probably be pushed as much as possible into mac80211 and the rate control module.

"
216,Dave Täht,2011-07-31 10:57:58.852733,"To which andrew replied:

1 seems like the right thing.
3 is pretty much trivial, and in fact probably already happens."
216,Dave Täht,2011-07-31 11:05:26.583555,"So I then wrote a big motivational message, as I've been chasing this problem for *16 months*... and everybody went off on plane flights around the globe (and me, I missed my plane entirely, but that's another story).

And then there was silence.

I wrote:

I'm hoping that Andrew can play Freeman Dyson, to Felix's Murray Gell-man, to my Richard Feynman, to come up with solutions.

To use another analogy, taken from a wonderful book that I highly recommend y'all read, as we're encountering all the same problems all over again...

http://www.amazon.com/Where-Wizards-Stay-Up-Late/dp/0684832674

Two of the greatest engineers that have ever existed, Dave Walden & Will Crowther, at BBN, not only figured out how to create the first routing code on the first IMPs,  but they figured out how to write the code with flow charts and a literal ton of green bar paper, and wrote all the assembly for it - before the first hardware was even than a blueprint.

AND: They figured out how to speed it up by 10x over the specification, and were fiercely proud of their code.

Kleinrock at UCLA took one look at it and told them it was wrong. They didn't believe him. He said ""gimme an imp"". They gave him one, and he managed to crash the the first one inside of sixteen packets.

He spent the next 3 years gleefully crashing the entire early arpanet, over and over again. Drove those guys nuts.

The ARPAnet was all the better for it.

This coming week I'm helping move my parents to a new house, and all my and their stuff is in boxes.

The week after, I want to ship cerowrt 1.0. I can live with it as it is, but as it is possible to do better in the time available, I'd love to do so.

in 2 hours I'd done a vulcan mind meld with andrew (and vice versa!), and explained the issues with tcp's behavior - how dropping 3 packets in a row is basically fatal, and you should give up anyway, improving conntrack to move a shaper between mice and elephants, and how to address the ANT issue using the video queue in 802.11e... and he fully explained the interrelationships of the various portions of stack and hardware to me, and found that infinite retry problem 20 minutes later...

So Drs Dyson, Gell-man, Feynman... can we get on the same page somehow? If not for this release, then the next?

I have a testlab going up next week at gatech, and one in mid-october going up in Paris. 

I'll gladly test *anything*, especial even partial stuff, and break it, in all sorts of ways. It's what cerowrt is for.

The battle between Kleinrock and Walden/Crowther at BBN is the stuff of legend, and what we are up to now could also become so.
"
218,Dave Täht,2011-07-31 11:22:18.67143,"Matt, Jacopo, could you 'hang out' on your routers at 2.4ghz and for a long time... and see if they drop the connect(s)? If not, let me know your hardware. If so, let me know your hardware. "
204,Dave Täht,2011-07-31 15:03:32.642689,""
89,Dave Täht,2011-07-31 15:08:45.869799,"I am under the impression there is a way to limit the jnl size to something sane, and save more memory with acache? Bind is currently staying sane and under 22MB of ram, which leaves room for strongswan (48%) of ram, and the rest of the core utils, without endangering swap."
189,Dave Täht,2011-07-31 15:10:10.872864,""
49,Dave Täht,2011-07-31 15:11:15.686675,"I started this port, I'll have it done by wednesday."
147,Dave Täht,2011-07-31 15:13:06.55685,""
200,Dave Täht,2011-07-31 15:14:26.947607,All uberwrt bugs have been moved.
162,Dave Täht,2011-07-31 15:16:14.042833,""
99,Dave Täht,2011-07-31 15:16:59.163258,""
142,Dave Täht,2011-07-31 15:17:50.156264,""
113,Dave Täht,2011-07-31 15:19:48.11666,""
196,Dave Täht,2011-07-31 15:22:41.459338,really want someone to play with netem..
200,Dave Täht,2011-07-31 15:27:01.002288,""
89,Evan Hunt,2011-07-31 17:16:03.452393,"The max-journal-size option in named.conf limits the journal file size.  When the journal gets above the specified size, it will dump the current zone data to the zonefile, create a new copy of the journal file with the oldest records omitted, and replace the old copy with the new one.

You could also have a daily cron job that runs ""rndc freeze"" and ""rndc thaw""--that will cause the current version of the zone data to be dumped to the zone file, and the journal file to be deleted entirely. (This is problematic if you want to use IXFR, as the journal file is used to reconstruct older versions of the zone data.)"
113,Evan Hunt,2011-07-31 18:39:38.410084,"Various proposals with various levels of stupidity for getting around the chicken-egg problem...

- A well-known anycasted address providing a udp/37 time server:  It had occurred to me that since this is to be used for bootstrapping DNSSEC, it might be a lovely idea if the root servers simply turned this feature on.  I still sort of love this, but it turns out to be rather fraught for political reasons (hard to get root operators to agree on anything, and this would be ""one more thing to break"").  Also, udp/37 is obsolete and insecure.  (Its security issues would be dead easy to fix -- simply allow the client to send a random nonce with its query, and return the nonce along with the time -- but the existence of SNTP leads me to suspect that IETF would not be receptive to any updates to RFC 868.  Which leads me to...)

- A well-known anycasted address providing SNTP:  SNTP should work fine over anycast as far as I know, but bringing the idea up seems to make time-conscious people gasp and say you can't anycast NTP.  Anyway, it's too complicated a protocol to be served by the root servers, but if we can convince people that this is a piece of needed internet infrastructure, we may be able to leverage existing anycast networks to get this deployed.

- DNS itself providing time:  A well known domain name, possibly server-provided along the lines of authors.bind/CH/TXT or id.server/CH/TXT, or possibly provided by anycasted DNS servers (""time.arpa"" or similar), would respond with a 128-bit number provided as an AAAA record in a nonroutable block of IPv6 space.  The bottom 64 bits of this would contain the current time (to the nearest second, with accuracy guaranteed plus or minus a minute).  A DNS server could be configured to check this value at startup and, if the variance with the system clock was above a certain threshold, use it as baseline time for DNSSEC validation.

- The ""screw it"" option:  Add a list of well-known NTP addresses (not domain names) to the standard ntp.conf.  The chances of *all* such addresses becoming invalid within the lifetime of a router seem remote.

- Modified ""screw it"" option:  Store a list of well-known NTP addresses separately from ntp.conf.  NTP can use them if it doesn't have DNS access.  When it does have DNS access, it can look up the addresses via DNS, compare them against the cached list, and if any addresses have changed, it can update its cache.  On the next boot, it uses the cached list of addresses again.

- Use ""dig +cd"" to do queries with checking disabled.  Start named, use dig +cd to look up the NTP server address(es), update ntp.conf, start NTP.  (This requires adding 'dig' to the installation of course, and so do the next few options.)

- Use ""dig +cd"" to figure out the approximate date by looking at the SOA record of a frequently-updated zone that uses the date for its serial number.  (This requires a high level of confidence that the zone will persist and continue using a date-format SOA serial number, so I don't love this.  But, ""dig +cd +short soa . | awk '{print $3}'"" currently returns 2011073101 (today's date in human readable format), and ""dig +cd +short soa com | awk '{print $3}'"" currently returns 1312161951 (the current unix epoch date, as of about 45 seconds ago). 

- Use ""dig +cd"" to figure out the approximate date by looking at inception and expiration dates on current RRSIG records.  This has a pretty poor accuracy level, but currently ""dig +cd +short rrsig . | awk '$1 == ""SOA"" {print $6}'"" gives you 20110730230000 (which is yesterday).

- Compile NTP with libval from SPARTA (dnssec-tools.org) and use val_getaddrinfo() instead of getaddrinfo().

- Write code to use in NTP when getaddrinfo() doesn't work, using the standard resolver library.  Something like this ought to work (totally untested, use it as a starting place only):
<pre>
     #include <sys/types.h>
     #include <netinet/in.h>
     #include <arpa/nameser.h>
     #include <resolv.h>

     unsigned char qbuffer[NS_PACKETSZ + 1];
     unsigned char rbuffer[NS_PACKETSZ + 1];
     int qlen, rlen;
     ns_message handle;

     /* ipv4 address query, ns_t_a -- need to do this again for ns_t_aaaa */
     qlen = res_mkquery(QUERY, ""servername"", C_IN, ns_t_a, NULL, 0, NULL, 
                        qbuffer, NS_PACKETSZ);

     /* set the CD bit in the query message */
     qbuffer[3] = 0x10U;

     /* send the query */
     rlen = res_send(qbuffer, qlen, rbuffer, NS_PACKETSZ);

     /* parse the response */
     if (ns_initparse(rbuffer, rlen, &handle) < 0)
         return (ERROR);

     for (i = 0; i < ns_msg_count(handle, ns_s_an); i++) {
         ns_rr rr;
         sockaddr_in addr4;
         sockaddr_in6 addr6;
         if (ns_parserr(&handle, ns_s_an, i, &rr) == 0)
             return (ERROR);
         if (ns_rr_type(rr) == ns_t_a) {
             addr4.sin_family = AF_INET;
             memcpy(addr4.sin_addr, ns_rr_rdata(rr), NS_INADDRSZ);
             /* cache address for use by NTP */
         } else if (ns_rr_type(rr) == ns_t_aaaa) {
             addr6.sin6_family = AF_INET6;
             memcpy(addr6.sin6_addr, ns_rr_rdata(rr), NS_IN6ADDRSZ);
             /* cache address for use by NTP */
         }
     }
</pre>
"
188,Dave Täht,2011-07-31 19:54:04.771931,"netem is in the cerowrt build, but needs testing to see how hard it could be pushed for delays eat memory."
216,Dave Täht,2011-07-31 20:00:58.416703,"This is the patch I've been using for 8 months. With it, voip becomes feasible, without it, not. With it, I still see 1.6 second pings at 40 meters. Without it, I saw 36+ seconds in similar conditions.

~/src/cerowrt/target/linux/902-ath9k-bufferbloat.patch

I don't understand how you get past the infinite loop, even with this patch in place.

<pre><code>
--- a/drivers/net/wireless/ath/ath9k/ath9k.h    2011-05-13 20:23:00.066497846 -0600
+++ b/drivers/net/wireless/ath/ath9k/ath9k.h    2011-05-13 20:27:11.560374910 -0600
@@ -135,11 +135,11 @@
 /***********/

 #define ATH_MAX_ANTENNA         3
-#define ATH_RXBUF               512
-#define ATH_TXBUF               512
+#define ATH_RXBUF               128
+#define ATH_TXBUF               32
 #define ATH_TXBUF_RESERVE       5
 #define ATH_MAX_QDEPTH          (ATH_TXBUF / 4 - ATH_TXBUF_RESERVE)
-#define ATH_TXMAXTRY            13
+#define ATH_TXMAXTRY            2
 #define ATH_MGT_TXMAXTRY        4

 #define TID_TO_WME_AC(_tid)                            \
@@ -542,7 +542,7 @@

 #define DEFAULT_CACHELINE       32
 #define ATH_REGCLASSIDS_MAX     10
 #define ATH_CABQ_READY_TIME     80      /* % of beacon interval */
-#define ATH_MAX_SW_RETRIES      10
+#define ATH_MAX_SW_RETRIES      2
 #define ATH_CHAN_MAX            255
 #define IEEE80211_WEP_NKID      4       /* number of key ids */

--- a/drivers/net/wireless/ath/ath9k/init.c     2011-05-13 20:23:00.066497846 -0600
--- b/drivers/net/wireless/ath/ath9k/init.c     2011-05-13 20:23:00.066497846 -0600
@@ -676,7 +676,7 @@
        hw->max_rates = 4;
        hw->channel_change_time = 5000;
        hw->max_listen_interval = 10;
-       hw->max_rate_tries = 10;
+       hw->max_rate_tries = 2;
        hw->sta_data_size = sizeof(struct ath_node);
        hw->vif_data_size = sizeof(struct ath_vif);
</code></pre>"
129,David Taht,2011-08-01 04:35:16.886886,I wonder if this feature works anymore
216,David Taht,2011-08-01 04:41:18.677486,"I am adding this discussion to the bug reporting system via cc'ing the bot
and changing the subject line to include the appropriate number.

My principal concern with exorbitant buffering and retries is that no
signalling is sent back to the tcp sender to indicate that it should maybe
slow down.

My reasoning for choosing 3 packets as a decent outer limit for a AMPDU is
that if one packet gets through, the rest can be dropped safely, which will
- yes, I totally understand - result in less than maximum wireless-n
performance - but give reasonably bounded latencies for all packets AND
provide end-to-end signaling that made sense.

I don't care about maximizing wireless-n performance in laboratory
conditions, what I care about is having decent mixed g and n performance in
fair to bad conditions, with contention from multiple APs and clients.

Felix had produced one patch early on that I thought was promising under
that scenario, treating g and n differently, that I'm trying to find.

I would like to move this discussion to the bug report if at all possible,

I certainly have some ideas towards increasing the maximum AMPDU to larger
sizes while retaining sanity on the TCP/ip side, notably by having it be
tuple sensitive, but that's something longer term than merely what we are
discussing now.

On Mon, Aug 1, 2011 at 2:42 AM, Felix Fietkau <nbd@openwrt.org> wrote:

> I have a better idea: Instead of limiting this value to 2, why not leave it
> at 10, but add the number of hardware retries to the per-subframe retry
> counter. That way subframes that get lost during the transmission of A-MPDUs
> with few or no hardware retransmissions are not unnecessarily penalized, but
> if A-MPDUs get retransmitted often, subframes will get kicked out quickly as
> well.
>
> - Felix
>
>
> On 2011-08-01 3:02 AM, Andrew McGregor wrote:
>
>> So is this a more appropriate way to clear it out:
>>
>> diff --git a/drivers/net/wireless/ath/**ath9k/ath9k.h
>> b/drivers/net/wireless/ath/**ath9k/ath9k.h
>> index 2a40fa2..47e0b99 100644
>> --- a/drivers/net/wireless/ath/**ath9k/ath9k.h
>> +++ b/drivers/net/wireless/ath/**ath9k/ath9k.h
>> @@ -396,7 +396,7 @@ struct ath_led {
>>  #define DEFAULT_CACHELINE       32
>>  #define ATH_REGCLASSIDS_MAX     10
>>  #define ATH_CABQ_READY_TIME     80      /* % of beacon interval */
>> -#define ATH_MAX_SW_RETRIES      10
>> +#define ATH_MAX_SW_RETRIES      2
>>  #define ATH_CHAN_MAX            255
>>  #define IEEE80211_WEP_NKID      4       /* number of key ids */
>>
>> IOW, simply don't try so many SW retries?  This should end up BARing it
>> forward pretty quickly.
>>
>> I think this is a pretty important tuning variable… and 10 looks like a
>> pretty silly value, 'cause the frame already had a reasonable number of TX
>> opportunities.
>>
>> Andrew
>>
>> On 29/07/2011, at 8:22 AM, Felix Fietkau wrote:
>>
>>   The receive window typically isn't small, it's often as big as 64
>>> frames. The only way to prevent that from messing up the receiver state is
>>> to send a BAR for failed frames, and that means pushing even more frames to
>>> the tx queue, thus potentially making the problem even worse.
>>>
>>>  I have the following ideas for attacking the root causes of bloated
>>> queues with aggregation:
>>>
>>>  1. Delay the sequence number assignment to the point where it actually
>>> transmits a frame for the first time. That allows the driver to pick any
>>> frame that hasn't been transmitted yet for dropping when the queue gets
>>> full.
>>>  2. Keep track of the size of the sequence number gap of pending frames.
>>> That allows the driver to make a better decision of when to drop a frame and
>>> send a BAR or when to retry some more.
>>>  3. Allow the driver to either try different rates for retransmissions,
>>> or to request another rate control lookup. The code for that should probably
>>> be pushed as much as possible into mac80211 and the rate control module.
>>>
>>>  - Felix
>>>
>>>  On 2011-07-29 2:10 PM, Andrew McGregor wrote:
>>>
>>>>  I may be able to put a few cycles in to this shortly… there's a
>>>>  tradeoff here, and continually recycling is definitely the wrong thing.
>>>>  I realise that dropping here is the wrong thing, but it's less wrong
>>>>  than retrying forever. With a fairly small receive window, it won't be
>>>>  that bad.
>>>>
>>>>  Andrew
>>>>
>>>>  On 29/07/2011, at 7:55 AM, Felix Fietkau wrote:
>>>>
>>>>   If it's doing infinite retry, then that's a bug in the per-subframe
>>>>> retry count tracking and should be fixed properly.
>>>>>
>>>>>  About the 1.6 seconds: Yes, it would be nice if ath9k was able to drop
>>>>> packets more easily, but that requires some more surgery in the xmit path,
>>>>> which I'm going to take care of eventually.
>>>>>
>>>>>  In the mean time I'm not going to apply any kludges that simply trade
>>>>> one problem for another (and have the potential to create nasty side
>>>>> effects).
>>>>>
>>>>>  - Felix
>>>>>
>>>>>  On 2011-07-29 1:39 PM, Dave Taht wrote:
>>>>>
>>>>>>  1 retrans good?, infinite very bad.
>>>>>>
>>>>>>  I was seeing 1.6 SECOND pings, man... going 40 meters....
>>>>>>
>>>>>>  Got a better suggestion?
>>>>>>
>>>>>>  http://www.bufferbloat.net/**issues/216<http://www.bufferbloat.net/issues/216>
>>>>>>
>>>>>>  Andrew also sent along another patch...
>>>>>>
>>>>>>  On Fri, Jul 29, 2011 at 2:03 AM, Felix Fietkau <nbd@openwrt.org>
>>>>>>  <mailto:nbd@openwrt.org>>   wrote:
>>>>>>
>>>>>>    No retrans not good. No retrans make gaps in client side reorder
>>>>>>    window. Gaps in client buffers bad, make traffic stall and
>>>>>> latencies.
>>>>>>
>>>>>>
>>>>>>    On 2011-07-29 2:21 AM, Dave Taht wrote:
>>>>>>
>>>>>>        infinite retrans bad. No retrans good. I LOVE IETF.
>>>>>>
>>>>>>        ---------- Forwarded message ----------
>>>>>>        From: *Andrew McGregor*<andrewmcgr@gmail.com
>>>>>>        <mailto:andrewmcgr@gmail.com>   <mailto:andrewmcgr@gmail.com
>>>>>>        <mailto:andrewmcgr@gmail.com>>**>
>>>>>>        Date: Thu, Jul 28, 2011 at 5:37 PM
>>>>>>        Subject: Patch for stuck retransmits
>>>>>>        To: dave.taht@gmail.com
>>>>>> >
>>>>>>        
>>>>>>
>>>>>>
>>>>>>        Here's the patch, against
>>>>>>        linux-2.6.39.3/drivers/net/__**wireless/ath/ath9k/xmit.c
>>>>>>
>>>>>>
>>>>>>
>>>>>>"
216,Dave Täht,2011-08-01 04:58:58.634142,"The approach andrew describes here sounds very promising. What I plan to do is a bakeoff late this week, in the lab, with Gell-man vanilla, Feynman bletcherous, and Dyson proposed patches in place, in a mixed g/n network...

Andrew wrote, commenting on my patch denoted earlier in this bug report:

""The use is at line 340 of ath9k/xmit.c, in ath_tx_complete_aggr, at least in a vanilla kernel tree, where it sets the limit on the number of passes through the SW retransmit code.

Your change that sets hw->max_rate_tries and ATH_TXMAXTRY to 2 is going to cause terrible packet loss, and probably make the latency worse; it will certainly slow TCP right down with non-congestive loss.  You won't see this at short range, but in fringe coverage it will certainly suck, so effectively you're throwing away about half the range.

Similarly, to make the AMPDU code work right, you actually need a minimum of 128 TX and RX buffers, and probably 160 is more advisable to make room for two max size aggregates plus some ACK, BAR and other frames (not every buffer at this level is used for an IP packet).  Any less than that is going to make the MAC do two things; one, drop packets, and two, start exercising the 'I've run out of memory' code, which is not going to be pretty.  Also, that leaves room for a max size AMPDU window for only two clients; I'd actually be inclined to increase these numbers to twice or more the default, so there's plenty of room for a reordering window for a few clients.  Again, these numbers DO NOT represent IP packets buffered, the maximum number of IP packets in this buffer is 64 per client, which is set by the 801.11 spec and can't easily be changed in this way (although I will look at how it could be changed).

If you want to reduce the latency, changing (in net/mac80211/rc80211_minstrel.c) mp->segment_size = 6000; to something smaller (minimum reasonable value is about 2000) and a similarly named variable in minstrel_ht from 6000 down to maybe 400.  These values are approximately microseconds.  That will, instead of crowbarring down the retransmits, instead cleanly reduce the maximum retransmit time window (which is this value rounded up to an integral number of transmitter shots, times four).  That will gain you a lot of performance, since then the higher rates will have a loss advantage (due to having more retransmits)."""
216,Felix Fietkau,2011-08-01 05:30:30.67198,"Last time I tried limiting the aggregation size that much, it ended up 
reducing the throughput from 80 mbit/s down to just over 20 with strong 
fluctuations.

I realize that latency is pretty much all you care about, but I'd prefer 
if the focus was directed more towards reducing bufferbloat without 
causing nasty throughput regressions on links with good conditions. By 
the way, those good conditions that I'm talking about are not jsut 
'laboratory conditions'. We've set up quite a few medium to distance 
links that perform well with little retransmission and good aggregation 
levels.

You can find a patch that implements my suggestion for handling swretry 
here: http://nbd.name/561-ath9k_sw_retry_reduce.patch
In my tests it seems to work well without hurting throughput under 
reasonably good conditions, but it needs some more testing.

- Felix

On 2011-08-01 1:41 PM, Dave Taht wrote:
> I am adding this discussion to the bug reporting system via cc'ing the
> bot and changing the subject line to include the appropriate number.
>
> My principal concern with exorbitant buffering and retries is that no
> signalling is sent back to the tcp sender to indicate that it should
> maybe slow down.
>
> My reasoning for choosing 3 packets as a decent outer limit for a AMPDU
> is that if one packet gets through, the rest can be dropped safely,
> which will - yes, I totally understand - result in less than maximum
> wireless-n performance - but give reasonably bounded latencies for all
> packets AND provide end-to-end signaling that made sense.
>
> I don't care about maximizing wireless-n performance in laboratory
> conditions, what I care about is having decent mixed g and n performance
> in fair to bad conditions, with contention from multiple APs and clients.
>
> Felix had produced one patch early on that I thought was promising under
> that scenario, treating g and n differently, that I'm trying to find.
>
> I would like to move this discussion to the bug report if at all possible,
>
> I certainly have some ideas towards increasing the maximum AMPDU to
> larger sizes while retaining sanity on the TCP/ip side, notably by
> having it be tuple sensitive, but that's something longer term than
> merely what we are discussing now.
>
> On Mon, Aug 1, 2011 at 2:42 AM, Felix Fietkau <nbd@openwrt.org>
> <mailto:nbd@openwrt.org>> wrote:
>
>     I have a better idea: Instead of limiting this value to 2, why not
>     leave it at 10, but add the number of hardware retries to the
>     per-subframe retry counter. That way subframes that get lost during
>     the transmission of A-MPDUs with few or no hardware retransmissions
>     are not unnecessarily penalized, but if A-MPDUs get retransmitted
>     often, subframes will get kicked out quickly as well.
>
>     - Felix
>
>
>     On 2011-08-01 3:02 AM, Andrew McGregor wrote:
>
>         So is this a more appropriate way to clear it out:
>
>         diff --git a/drivers/net/wireless/ath/__ath9k/ath9k.h
>         b/drivers/net/wireless/ath/__ath9k/ath9k.h
>         index 2a40fa2..47e0b99 100644
>         --- a/drivers/net/wireless/ath/__ath9k/ath9k.h
>         +++ b/drivers/net/wireless/ath/__ath9k/ath9k.h
>         @@ -396,7 +396,7 @@ struct ath_led {
>           #define DEFAULT_CACHELINE       32
>           #define ATH_REGCLASSIDS_MAX     10
>           #define ATH_CABQ_READY_TIME     80      /* % of beacon interval */
>         -#define ATH_MAX_SW_RETRIES      10
>         +#define ATH_MAX_SW_RETRIES      2
>           #define ATH_CHAN_MAX            255
>           #define IEEE80211_WEP_NKID      4       /* number of key ids */
>
>         IOW, simply don't try so many SW retries?  This should end up
>         BARing it forward pretty quickly.
>
>         I think this is a pretty important tuning variable… and 10 looks
>         like a pretty silly value, 'cause the frame already had a
>         reasonable number of TX opportunities.
>
>         Andrew
>
>         On 29/07/2011, at 8:22 AM, Felix Fietkau wrote:
>
>               The receive window typically isn't small, it's often as
>             big as 64 frames. The only way to prevent that from messing
>             up the receiver state is to send a BAR for failed frames,
>             and that means pushing even more frames to the tx queue,
>             thus potentially making the problem even worse.
>
>               I have the following ideas for attacking the root causes
>             of bloated queues with aggregation:
>
>               1. Delay the sequence number assignment to the point where
>             it actually transmits a frame for the first time. That
>             allows the driver to pick any frame that hasn't been
>             transmitted yet for dropping when the queue gets full.
>               2. Keep track of the size of the sequence number gap of
>             pending frames. That allows the driver to make a better
>             decision of when to drop a frame and send a BAR or when to
>             retry some more.
>               3. Allow the driver to either try different rates for
>             retransmissions, or to request another rate control lookup.
>             The code for that should probably be pushed as much as
>             possible into mac80211 and the rate control module.
>
>               - Felix
>
>               On 2011-07-29 2:10 PM, Andrew McGregor wrote:
>
>                   I may be able to put a few cycles in to this shortly…
>                 there's a
>                   tradeoff here, and continually recycling is definitely
>                 the wrong thing.
>                   I realise that dropping here is the wrong thing, but
>                 it's less wrong
>                   than retrying forever. With a fairly small receive
>                 window, it won't be
>                   that bad.
>
>                   Andrew
>
>                   On 29/07/2011, at 7:55 AM, Felix Fietkau wrote:
>
>                       If it's doing infinite retry, then that's a bug in
>                     the per-subframe retry count tracking and should be
>                     fixed properly.
>
>                       About the 1.6 seconds: Yes, it would be nice if
>                     ath9k was able to drop packets more easily, but that
>                     requires some more surgery in the xmit path, which
>                     I'm going to take care of eventually.
>
>                       In the mean time I'm not going to apply any
>                     kludges that simply trade one problem for another
>                     (and have the potential to create nasty side effects).
>
>                       - Felix
>
>                       On 2011-07-29 1:39 PM, Dave Taht wrote:
>
>                           1 retrans good?, infinite very bad.
>
>                           I was seeing 1.6 SECOND pings, man... going 40
>                         meters....
>
>                           Got a better suggestion?
>
>                         http://www.bufferbloat.net/__issues/216
>                         <http://www.bufferbloat.net/issues/216>
>
>                           Andrew also sent along another patch...
>
>                           On Fri, Jul 29, 2011 at 2:03 AM, Felix
>                         Fietkau<nbd@openwrt.org <mailto:nbd@openwrt.org>
>                         <mailto:nbd@openwrt.org>
>                         <mailto:nbd@openwrt.org>>>   wrote:
>
>                             No retrans not good. No retrans make gaps in
>                         client side reorder
>                             window. Gaps in client buffers bad, make
>                         traffic stall and latencies.
>
>
>                             On 2011-07-29 2:21 AM, Dave Taht wrote:
>
>                                 infinite retrans bad. No retrans good. I
>                         LOVE IETF.
>
>                                 ---------- Forwarded message ----------
>                                 From: *Andrew
>                         McGregor*<andrewmcgr@gmail.com
>                         <mailto:andrewmcgr@gmail.com>
>                         <mailto:andrewmcgr@gmail.com
>                         <mailto:andrewmcgr@gmail.com>>
>                         <mailto:andrewmcgr@gmail.com
>                         <mailto:andrewmcgr@gmail.com>
>                         <mailto:andrewmcgr@gmail.com
>                         <mailto:andrewmcgr@gmail.com>>>__>
>                                 Date: Thu, Jul 28, 2011 at 5:37 PM
>                                 Subject: Patch for stuck retransmits
>                                 To: dave.taht@gmail.com
>                         <mailto:dave.taht@gmail.com><mailto:dav__e.taht@gmail.com
>                         <mailto:dave.taht@gmail.com>>
>                         <mailto:dave.taht@gmail.com
>                         <mailto:dave.taht@gmail.com><__mailto:dave.taht@gmail.com
>                         <mailto:dave.taht@gmail.com>>>
>
>
>                                 Here's the patch, against
>
>                           linux-2.6.39.3/drivers/net/____wireless/ath/ath9k/xmit.c
>
>
>
>"
216,David Taht,2011-08-01 05:47:06.886291,"Excellent. So it sounds like your patch, along with andrew's latency
reducing suggestions, and increasing ATH_RXBUF and ATH_TXBUF to 160 or so,
would be the strongest candidate in the bakeoff?

I am still quite allergic to having more than 32 packets
living inside a driver buffer... but am willing to do extensive
testing of all approaches that make sense at this point.


Unfortunately I now find myself blocked by bug #202. I can
certainly bring debloat-testing back in, and many other types of clients,
as well as maybe (?) patch up the SR-71 driver I have for cardbus,
but really want to just do cero to cero testing to eliminate all other
variables.


On Mon, Aug 1, 2011 at 6:29 AM, Felix Fietkau <nbd@openwrt.org> wrote:

> Last time I tried limiting the aggregation size that much, it ended up
> reducing the throughput from 80 mbit/s down to just over 20 with strong
> fluctuations.
>
> I realize that latency is pretty much all you care about, but I'd prefer if
> the focus was directed more towards reducing bufferbloat without causing
> nasty throughput regressions on links with good conditions. By the way,
> those good conditions that I'm talking about are not jsut 'laboratory
> conditions'. We've set up quite a few medium to distance links that perform
> well with little retransmission and good aggregation levels.
>
> You can find a patch that implements my suggestion for handling swretry
> here: http://nbd.name/561-ath9k_sw_**retry_reduce.patch<http://nbd.name/561-ath9k_sw_retry_reduce.patch>
> In my tests it seems to work well without hurting throughput under
> reasonably good conditions, but it needs some more testing.
>
> - Felix
>
>
> On 2011-08-01 1:41 PM, Dave Taht wrote:
>
>> I am adding this discussion to the bug reporting system via cc'ing the
>> bot and changing the subject line to include the appropriate number.
>>
>> My principal concern with exorbitant buffering and retries is that no
>> signalling is sent back to the tcp sender to indicate that it should
>> maybe slow down.
>>
>> My reasoning for choosing 3 packets as a decent outer limit for a AMPDU
>> is that if one packet gets through, the rest can be dropped safely,
>> which will - yes, I totally understand - result in less than maximum
>> wireless-n performance - but give reasonably bounded latencies for all
>> packets AND provide end-to-end signaling that made sense.
>>
>> I don't care about maximizing wireless-n performance in laboratory
>> conditions, what I care about is having decent mixed g and n performance
>> in fair to bad conditions, with contention from multiple APs and clients.
>>
>> Felix had produced one patch early on that I thought was promising under
>> that scenario, treating g and n differently, that I'm trying to find.
>>
>> I would like to move this discussion to the bug report if at all possible,
>>
>> I certainly have some ideas towards increasing the maximum AMPDU to
>> larger sizes while retaining sanity on the TCP/ip side, notably by
>> having it be tuple sensitive, but that's something longer term than
>> merely what we are discussing now.
>>
>> On Mon, Aug 1, 2011 at 2:42 AM, Felix Fietkau <nbd@openwrt.org
>> <mailto:nbd@openwrt.org>> wrote:
>>
>>    I have a better idea: Instead of limiting this value to 2, why not
>>    leave it at 10, but add the number of hardware retries to the
>>    per-subframe retry counter. That way subframes that get lost during
>>    the transmission of A-MPDUs with few or no hardware retransmissions
>>    are not unnecessarily penalized, but if A-MPDUs get retransmitted
>>    often, subframes will get kicked out quickly as well.
>>
>>    - Felix
>>
>>
>>    On 2011-08-01 3:02 AM, Andrew McGregor wrote:
>>
>>        So is this a more appropriate way to clear it out:
>>
>>        diff --git a/drivers/net/wireless/ath/__**ath9k/ath9k.h
>>        b/drivers/net/wireless/ath/__**ath9k/ath9k.h
>>        index 2a40fa2..47e0b99 100644
>>        --- a/drivers/net/wireless/ath/__**ath9k/ath9k.h
>>        +++ b/drivers/net/wireless/ath/__**ath9k/ath9k.h
>>        @@ -396,7 +396,7 @@ struct ath_led {
>>          #define DEFAULT_CACHELINE       32
>>          #define ATH_REGCLASSIDS_MAX     10
>>          #define ATH_CABQ_READY_TIME     80      /* % of beacon interval
>> */
>>        -#define ATH_MAX_SW_RETRIES      10
>>        +#define ATH_MAX_SW_RETRIES      2
>>          #define ATH_CHAN_MAX            255
>>          #define IEEE80211_WEP_NKID      4       /* number of key ids */
>>
>>        IOW, simply don't try so many SW retries?  This should end up
>>        BARing it forward pretty quickly.
>>
>>        I think this is a pretty important tuning variable… and 10 looks
>>        like a pretty silly value, 'cause the frame already had a
>>        reasonable number of TX opportunities.
>>
>>        Andrew
>>
>>        On 29/07/2011, at 8:22 AM, Felix Fietkau wrote:
>>
>>              The receive window typically isn't small, it's often as
>>            big as 64 frames. The only way to prevent that from messing
>>            up the receiver state is to send a BAR for failed frames,
>>            and that means pushing even more frames to the tx queue,
>>            thus potentially making the problem even worse.
>>
>>              I have the following ideas for attacking the root causes
>>            of bloated queues with aggregation:
>>
>>              1. Delay the sequence number assignment to the point where
>>            it actually transmits a frame for the first time. That
>>            allows the driver to pick any frame that hasn't been
>>            transmitted yet for dropping when the queue gets full.
>>              2. Keep track of the size of the sequence number gap of
>>            pending frames. That allows the driver to make a better
>>            decision of when to drop a frame and send a BAR or when to
>>            retry some more.
>>              3. Allow the driver to either try different rates for
>>            retransmissions, or to request another rate control lookup.
>>            The code for that should probably be pushed as much as
>>            possible into mac80211 and the rate control module.
>>
>>              - Felix
>>
>>              On 2011-07-29 2:10 PM, Andrew McGregor wrote:
>>
>>                  I may be able to put a few cycles in to this shortly…
>>                there's a
>>                  tradeoff here, and continually recycling is definitely
>>                the wrong thing.
>>                  I realise that dropping here is the wrong thing, but
>>                it's less wrong
>>                  than retrying forever. With a fairly small receive
>>                window, it won't be
>>                  that bad.
>>
>>                  Andrew
>>
>>                  On 29/07/2011, at 7:55 AM, Felix Fietkau wrote:
>>
>>                      If it's doing infinite retry, then that's a bug in
>>                    the per-subframe retry count tracking and should be
>>                    fixed properly.
>>
>>                      About the 1.6 seconds: Yes, it would be nice if
>>                    ath9k was able to drop packets more easily, but that
>>                    requires some more surgery in the xmit path, which
>>                    I'm going to take care of eventually.
>>
>>                      In the mean time I'm not going to apply any
>>                    kludges that simply trade one problem for another
>>                    (and have the potential to create nasty side effects).
>>
>>                      - Felix
>>
>>                      On 2011-07-29 1:39 PM, Dave Taht wrote:
>>
>>                          1 retrans good?, infinite very bad.
>>
>>                          I was seeing 1.6 SECOND pings, man... going 40
>>                        meters....
>>
>>                          Got a better suggestion?
>>
>>                        http://www.bufferbloat.net/__**issues/216<http://www.bufferbloat.net/__issues/216>
>>                        <http://www.bufferbloat.net/**issues/216<http://www.bufferbloat.net/issues/216>
>> >
>>
>>                          Andrew also sent along another patch...
>>
>>                          On Fri, Jul 29, 2011 at 2:03 AM, Felix
>>                        Fietkau<nbd@openwrt.org <mailto:nbd@openwrt.org>
>>                        <mailto:nbd@openwrt.org>
>>
>>                        <mailto:nbd@openwrt.org>>>   wrote:
>>
>>                            No retrans not good. No retrans make gaps in
>>                        client side reorder
>>                            window. Gaps in client buffers bad, make
>>                        traffic stall and latencies.
>>
>>
>>                            On 2011-07-29 2:21 AM, Dave Taht wrote:
>>
>>                                infinite retrans bad. No retrans good. I
>>                        LOVE IETF.
>>
>>                                ---------- Forwarded message ----------
>>                                From: *Andrew
>>                        McGregor*<andrewmcgr@gmail.com
>>                        <mailto:andrewmcgr@gmail.com>
>>                        <mailto:andrewmcgr@gmail.com
>>                        <mailto:andrewmcgr@gmail.com>>
>>                        <mailto:andrewmcgr@gmail.com
>>                        <mailto:andrewmcgr@gmail.com>
>>                        <mailto:andrewmcgr@gmail.com
>>                        <mailto:andrewmcgr@gmail.com>>**>__>
>>                                Date: Thu, Jul 28, 2011 at 5:37 PM
>>                                Subject: Patch for stuck retransmits
>>                                To: dave.taht@gmail.com
>>                        <mailto:dave.taht@gmail.com><**mailto:
>> dav__e.taht@gmail.com
>>
>>                        <mailto:dave.taht@gmail.com>>
>>                        <mailto:dave.taht@gmail.com
>>                        <mailto:dave.taht@gmail.com><_**_mailto:
>> dave.taht@gmail.com
>>
>>                        <mailto:dave.taht@gmail.com>>>
>>
>>
>>                                Here's the patch, against
>>
>>                          linux-2.6.39.3/drivers/net/___**
>> _wireless/ath/ath9k/xmit.c
>>
>>
>>
>>"
216,Felix Fietkau,2011-08-01 06:07:04.844159,"I've also been thinking about changing the rate control parameters but I 
think we need to take a different approach here. The main issue is that 
A-MPDU rate control needs to be handled completely different from 
single-frame rate control. Unfortunately at the point in time where rate 
control runs, the decision about A-MPDU transmission vs single 
transmission has not been made yet, so I will probably have to make some 
rate control API changes to give the driver a chance to interact with 
the RC directly.

Another issue is that test results for g/n interop from all our previous 
attempts at limiting queue size are pretty much meaningless.

Dropping packets based on internal per-tid queue counters currently is 
too bursty for TCP to adapt properly. The debloat-testing eBDP code 
completely ignores the inner workings of ath9k's queueing, so it cannot 
properly distinguish between aggregated and unaggregated traffic, which 
need completely different queueing characteristics.

What we need to be able to produce meaningful test results is proper 
queue management on the internal ath9k per-TID queues (plus the 
non-aggregated tx queue for legacy or VI traffic).

This will definitely take some more time to develop, but I think without 
that we should not jump to any conclusions based on results from random 
header file hack jobs.

- Felix

On 2011-08-01 2:47 PM, Dave Taht wrote:
> Excellent. So it sounds like your patch, along with andrew's latency
> reducing suggestions, and increasing ATH_RXBUF and ATH_TXBUF to 160 or
> so, would be the strongest candidate in the bakeoff?
>
> |I am still quite allergic to having more than 32 packets
>
> living inside a driver buffer... but am willing to do extensive testing of all approaches that make sense at this point.
>
>
> Unfortunately I now find myself blocked by bug #202. I can
> certainly bring debloat-testing back in, and many other types of clients,
>
> as well as maybe (?) patch up the SR-71 driver I have for cardbus,
> but really want to just do cero to cero testing to eliminate all other variables.
> |
>
>
> On Mon, Aug 1, 2011 at 6:29 AM, Felix Fietkau <nbd@openwrt.org>
> <mailto:nbd@openwrt.org>> wrote:
>
>     Last time I tried limiting the aggregation size that much, it ended
>     up reducing the throughput from 80 mbit/s down to just over 20 with
>     strong fluctuations.
>
>     I realize that latency is pretty much all you care about, but I'd
>     prefer if the focus was directed more towards reducing bufferbloat
>     without causing nasty throughput regressions on links with good
>     conditions. By the way, those good conditions that I'm talking about
>     are not jsut 'laboratory conditions'. We've set up quite a few
>     medium to distance links that perform well with little
>     retransmission and good aggregation levels.
>
>     You can find a patch that implements my suggestion for handling
>     swretry here: http://nbd.name/561-ath9k_sw___retry_reduce.patch
>     <http://nbd.name/561-ath9k_sw_retry_reduce.patch>
>     In my tests it seems to work well without hurting throughput under
>     reasonably good conditions, but it needs some more testing.
>
>     - Felix
>
>
>     On 2011-08-01 1:41 PM, Dave Taht wrote:
>
>         I am adding this discussion to the bug reporting system via
>         cc'ing the
>         bot and changing the subject line to include the appropriate number.
>
>         My principal concern with exorbitant buffering and retries is
>         that no
>         signalling is sent back to the tcp sender to indicate that it should
>         maybe slow down.
>
>         My reasoning for choosing 3 packets as a decent outer limit for
>         a AMPDU
>         is that if one packet gets through, the rest can be dropped safely,
>         which will - yes, I totally understand - result in less than maximum
>         wireless-n performance - but give reasonably bounded latencies
>         for all
>         packets AND provide end-to-end signaling that made sense.
>
>         I don't care about maximizing wireless-n performance in laboratory
>         conditions, what I care about is having decent mixed g and n
>         performance
>         in fair to bad conditions, with contention from multiple APs and
>         clients.
>
>         Felix had produced one patch early on that I thought was
>         promising under
>         that scenario, treating g and n differently, that I'm trying to
>         find.
>
>         I would like to move this discussion to the bug report if at all
>         possible,
>
>         I certainly have some ideas towards increasing the maximum AMPDU to
>         larger sizes while retaining sanity on the TCP/ip side, notably by
>         having it be tuple sensitive, but that's something longer term than
>         merely what we are discussing now.
>
>         On Mon, Aug 1, 2011 at 2:42 AM, Felix Fietkau <nbd@openwrt.org>
>         <mailto:nbd@openwrt.org>
>         <mailto:nbd@openwrt.org <mailto:nbd@openwrt.org>>> wrote:
>
>             I have a better idea: Instead of limiting this value to 2,
>         why not
>             leave it at 10, but add the number of hardware retries to the
>             per-subframe retry counter. That way subframes that get lost
>         during
>             the transmission of A-MPDUs with few or no hardware
>         retransmissions
>             are not unnecessarily penalized, but if A-MPDUs get
>         retransmitted
>             often, subframes will get kicked out quickly as well.
>
>             - Felix
>
>
>             On 2011-08-01 3:02 AM, Andrew McGregor wrote:
>
>                 So is this a more appropriate way to clear it out:
>
>                 diff --git a/drivers/net/wireless/ath/____ath9k/ath9k.h
>                 b/drivers/net/wireless/ath/____ath9k/ath9k.h
>                 index 2a40fa2..47e0b99 100644
>                 --- a/drivers/net/wireless/ath/____ath9k/ath9k.h
>                 +++ b/drivers/net/wireless/ath/____ath9k/ath9k.h
>                 @@ -396,7 +396,7 @@ struct ath_led {
>                   #define DEFAULT_CACHELINE       32
>                   #define ATH_REGCLASSIDS_MAX     10
>                   #define ATH_CABQ_READY_TIME     80      /* % of beacon
>         interval */
>                 -#define ATH_MAX_SW_RETRIES      10
>                 +#define ATH_MAX_SW_RETRIES      2
>                   #define ATH_CHAN_MAX            255
>                   #define IEEE80211_WEP_NKID      4       /* number of
>         key ids */
>
>                 IOW, simply don't try so many SW retries?  This should
>         end up
>                 BARing it forward pretty quickly.
>
>                 I think this is a pretty important tuning variable… and
>         10 looks
>                 like a pretty silly value, 'cause the frame already had a
>                 reasonable number of TX opportunities.
>
>                 Andrew
>
>                 On 29/07/2011, at 8:22 AM, Felix Fietkau wrote:
>
>                       The receive window typically isn't small, it's
>         often as
>                     big as 64 frames. The only way to prevent that from
>         messing
>                     up the receiver state is to send a BAR for failed
>         frames,
>                     and that means pushing even more frames to the tx queue,
>                     thus potentially making the problem even worse.
>
>                       I have the following ideas for attacking the root
>         causes
>                     of bloated queues with aggregation:
>
>                       1. Delay the sequence number assignment to the
>         point where
>                     it actually transmits a frame for the first time. That
>                     allows the driver to pick any frame that hasn't been
>                     transmitted yet for dropping when the queue gets full.
>                       2. Keep track of the size of the sequence number
>         gap of
>                     pending frames. That allows the driver to make a better
>                     decision of when to drop a frame and send a BAR or
>         when to
>                     retry some more.
>                       3. Allow the driver to either try different rates for
>                     retransmissions, or to request another rate control
>         lookup.
>                     The code for that should probably be pushed as much as
>                     possible into mac80211 and the rate control module.
>
>                       - Felix
>
>                       On 2011-07-29 2:10 PM, Andrew McGregor wrote:
>
>                           I may be able to put a few cycles in to this
>         shortly…
>                         there's a
>                           tradeoff here, and continually recycling is
>         definitely
>                         the wrong thing.
>                           I realise that dropping here is the wrong
>         thing, but
>                         it's less wrong
>                           than retrying forever. With a fairly small receive
>                         window, it won't be
>                           that bad.
>
>                           Andrew
>
>                           On 29/07/2011, at 7:55 AM, Felix Fietkau wrote:
>
>                               If it's doing infinite retry, then that's
>         a bug in
>                             the per-subframe retry count tracking and
>         should be
>                             fixed properly.
>
>                               About the 1.6 seconds: Yes, it would be
>         nice if
>                             ath9k was able to drop packets more easily,
>         but that
>                             requires some more surgery in the xmit path,
>         which
>                             I'm going to take care of eventually.
>
>                               In the mean time I'm not going to apply any
>                             kludges that simply trade one problem for
>         another
>                             (and have the potential to create nasty side
>         effects).
>
>                               - Felix
>
>                               On 2011-07-29 1:39 PM, Dave Taht wrote:
>
>                                   1 retrans good?, infinite very bad.
>
>                                   I was seeing 1.6 SECOND pings, man...
>         going 40
>                                 meters....
>
>                                   Got a better suggestion?
>
>         http://www.bufferbloat.net/____issues/216
>         <http://www.bufferbloat.net/__issues/216>
>         <http://www.bufferbloat.net/__issues/216
>         <http://www.bufferbloat.net/issues/216>>
>
>                                   Andrew also sent along another patch...
>
>                                   On Fri, Jul 29, 2011 at 2:03 AM, Felix
>                                 Fietkau<nbd@openwrt.org
>         <mailto:nbd@openwrt.org> <mailto:nbd@openwrt.org>
>         <mailto:nbd@openwrt.org>>
>         <mailto:nbd@openwrt.org <mailto:nbd@openwrt.org>
>
>         <mailto:nbd@openwrt.org <mailto:nbd@openwrt.org>>>>   wrote:
>
>                                     No retrans not good. No retrans make
>         gaps in
>                                 client side reorder
>                                     window. Gaps in client buffers bad, make
>                                 traffic stall and latencies.
>
>
>                                     On 2011-07-29 2:21 AM, Dave Taht wrote:
>
>                                         infinite retrans bad. No retrans
>         good. I
>                                 LOVE IETF.
>
>                                         ---------- Forwarded message
>         ----------
>                                         From: *Andrew
>                                 McGregor*<andrewmcgr@gmail.com
>         <mailto:andrewmcgr@gmail.com>
>         <mailto:andrewmcgr@gmail.com <mailto:andrewmcgr@gmail.com>>
>         <mailto:andrewmcgr@gmail.com <mailto:andrewmcgr@gmail.com>
>         <mailto:andrewmcgr@gmail.com <mailto:andrewmcgr@gmail.com>>>
>         <mailto:andrewmcgr@gmail.com <mailto:andrewmcgr@gmail.com>
>         <mailto:andrewmcgr@gmail.com <mailto:andrewmcgr@gmail.com>>
>         <mailto:andrewmcgr@gmail.com <mailto:andrewmcgr@gmail.com>
>         <mailto:andrewmcgr@gmail.com <mailto:andrewmcgr@gmail.com>>>__>__>
>                                         Date: Thu, Jul 28, 2011 at 5:37 PM
>                                         Subject: Patch for stuck retransmits
>                                         To: dave.taht@gmail.com
>         <mailto:dave.taht@gmail.com>
>         <mailto:dave.taht@gmail.com
>         <mailto:dave.taht@gmail.com>><__mailto:dav__e.taht@gmail.com
>         <mailto:dav__e.taht@gmail.com>
>
>         <mailto:dave.taht@gmail.com <mailto:dave.taht@gmail.com>>>
>         <mailto:dave.taht@gmail.com <mailto:dave.taht@gmail.com>
>         <mailto:dave.taht@gmail.com
>         <mailto:dave.taht@gmail.com>><____mailto:dave.taht@gmail.com
>         <mailto:dave.taht@gmail.com>
>
>         <mailto:dave.taht@gmail.com <mailto:dave.taht@gmail.com>>>>
>
>
>                                         Here's the patch, against
>
>
>           linux-2.6.39.3/drivers/net/______wireless/ath/ath9k/xmit.c
>
>
>
>"
216,David Taht,2011-08-01 06:22:09.481905,"OK, so you are suggesting that the ""gell-man version"" for testing contains
no header file hack-jobs?

My tests basically include 3-9 routers, routing wirelessly and wired through
each other in various combinations, using netperf as the principal test
driver, also simultaneously, while simultaneously fpinging the routers.
There are numerous other tests in the suite, and I can develop more, given
some suggestions?

http://www.bufferbloat.net/projects/cerowrt/wiki/Testlab

Some of the tests I ran last time (while fighting the wired driver) are
documented here.

http://www.bufferbloat.net/projects/cerowrt/wiki/Experiment_-_QoS"
216,Dave Täht,2011-08-01 06:51:24.4742,"David Taht wrote:
> I am adding this discussion to the bug reporting system via cc'ing the bot
> and changing the subject line to include the appropriate number.
> 
> My principal concern with exorbitant buffering and retries is that no
> signalling is sent back to the tcp sender to indicate that it should maybe
> slow down.
> 
> My reasoning for choosing 3 packets as a decent outer limit for a AMPDU is
> that if one packet gets through, the rest can be dropped safely, which will
> - yes, I totally understand - result in less than maximum wireless-n
> performance - but give reasonably bounded latencies for all packets AND
> provide end-to-end signaling that made sense.
> 
> I don't care about maximizing wireless-n performance in laboratory
> conditions, what I care about is having decent mixed g and n performance in
> fair to bad conditions, with contention from multiple APs and clients.
> 
> Felix had produced one patch early on that I thought was promising under
> that scenario, treating g and n differently, that I'm trying to find.
> 
> I would like to move this discussion to the bug report if at all possible,
> 
> I certainly have some ideas towards increasing the maximum AMPDU to larger
> sizes while retaining sanity on the TCP/ip side, notably by having it be
> IP/port IP/port tuple sensitive, but that's something longer term than merely what we are
> discussing now.
> 
> On Mon, Aug 1, 2011 at 2:42 AM, Felix Fietkau <nbd@openwrt.org> wrote:
> 
> > I have a better idea: Instead of limiting this value to 2, why not leave it
> > at 10, but add the number of hardware retries to the per-subframe retry
> > counter. That way subframes that get lost during the transmission of A-MPDUs
> > with few or no hardware retransmissions are not unnecessarily penalized, but
> > if A-MPDUs get retransmitted often, subframes will get kicked out quickly as
> > well.
> >
> > - Felix
> >
> >
> > On 2011-08-01 3:02 AM, Andrew McGregor wrote:
> >
> >> So is this a more appropriate way to clear it out:
> >>
> >> diff --git a/drivers/net/wireless/ath/**ath9k/ath9k.h
> >> b/drivers/net/wireless/ath/**ath9k/ath9k.h
> >> index 2a40fa2..47e0b99 100644
> >> --- a/drivers/net/wireless/ath/**ath9k/ath9k.h
> >> +++ b/drivers/net/wireless/ath/**ath9k/ath9k.h
> >> @@ -396,7 +396,7 @@ struct ath_led {
> >>  #define DEFAULT_CACHELINE       32
> >>  #define ATH_REGCLASSIDS_MAX     10
> >>  #define ATH_CABQ_READY_TIME     80      /* % of beacon interval */
> >> -#define ATH_MAX_SW_RETRIES      10
> >> +#define ATH_MAX_SW_RETRIES      2
> >>  #define ATH_CHAN_MAX            255
> >>  #define IEEE80211_WEP_NKID      4       /* number of key ids */
> >>
> >> IOW, simply don't try so many SW retries?  This should end up BARing it
> >> forward pretty quickly.
> >>
> >> I think this is a pretty important tuning variable… and 10 looks like a
> >> pretty silly value, 'cause the frame already had a reasonable number of TX
> >> opportunities.
> >>
> >> Andrew
> >>
> >> On 29/07/2011, at 8:22 AM, Felix Fietkau wrote:
> >>
> >>   The receive window typically isn't small, it's often as big as 64
> >>> frames. The only way to prevent that from messing up the receiver state is
> >>> to send a BAR for failed frames, and that means pushing even more frames to
> >>> the tx queue, thus potentially making the problem even worse.
> >>>
> >>>  I have the following ideas for attacking the root causes of bloated
> >>> queues with aggregation:
> >>>
> >>>  1. Delay the sequence number assignment to the point where it actually
> >>> transmits a frame for the first time. That allows the driver to pick any
> >>> frame that hasn't been transmitted yet for dropping when the queue gets
> >>> full.
> >>>  2. Keep track of the size of the sequence number gap of pending frames.
> >>> That allows the driver to make a better decision of when to drop a frame and
> >>> send a BAR or when to retry some more.
> >>>  3. Allow the driver to either try different rates for retransmissions,
> >>> or to request another rate control lookup. The code for that should probably
> >>> be pushed as much as possible into mac80211 and the rate control module.
> >>>
> >>>  - Felix
> >>>
> >>>  On 2011-07-29 2:10 PM, Andrew McGregor wrote:
> >>>
> >>>>  I may be able to put a few cycles in to this shortly… there's a
> >>>>  tradeoff here, and continually recycling is definitely the wrong thing.
> >>>>  I realise that dropping here is the wrong thing, but it's less wrong
> >>>>  than retrying forever. With a fairly small receive window, it won't be
> >>>>  that bad.
> >>>>
> >>>>  Andrew
> >>>>
> >>>>  On 29/07/2011, at 7:55 AM, Felix Fietkau wrote:
> >>>>
> >>>>   If it's doing infinite retry, then that's a bug in the per-subframe
> >>>>> retry count tracking and should be fixed properly.
> >>>>>
> >>>>>  About the 1.6 seconds: Yes, it would be nice if ath9k was able to drop
> >>>>> packets more easily, but that requires some more surgery in the xmit path,
> >>>>> which I'm going to take care of eventually.
> >>>>>
> >>>>>  In the mean time I'm not going to apply any kludges that simply trade
> >>>>> one problem for another (and have the potential to create nasty side
> >>>>> effects).
> >>>>>
> >>>>>  - Felix
> >>>>>
> >>>>>  On 2011-07-29 1:39 PM, Dave Taht wrote:
> >>>>>
> >>>>>>  1 retrans good?, infinite very bad.
> >>>>>>
> >>>>>>  I was seeing 1.6 SECOND pings, man... going 40 meters....
> >>>>>>
> >>>>>>  Got a better suggestion?
> >>>>>>
> >>>>>>  http://www.bufferbloat.net/**issues/216<http://www.bufferbloat.net/issues/216>
> >>>>>>
> >>>>>>  Andrew also sent along another patch...
> >>>>>>
> >>>>>>  On Fri, Jul 29, 2011 at 2:03 AM, Felix Fietkau<nbd@openwrt.org>
> >>>>>>  <mailto:nbd@openwrt.org>>   wrote:
> >>>>>>
> >>>>>>    No retrans not good. No retrans make gaps in client side reorder
> >>>>>>    window. Gaps in client buffers bad, make traffic stall and
> >>>>>> latencies.
> >>>>>>
> >>>>>>
> >>>>>>    On 2011-07-29 2:21 AM, Dave Taht wrote:
> >>>>>>
> >>>>>>        infinite retrans bad. No retrans good. I LOVE IETF.
> >>>>>>
> >>>>>>        ---------- Forwarded message ----------
> >>>>>>        From: *Andrew McGregor*<andrewmcgr@gmail.com
> >>>>>>        <mailto:andrewmcgr@gmail.com>   <mailto:andrewmcgr@gmail.com
> >>>>>>        <mailto:andrewmcgr@gmail.com>>**>
> >>>>>>        Date: Thu, Jul 28, 2011 at 5:37 PM
> >>>>>>        Subject: Patch for stuck retransmits
> >>>>>>        To: dave.taht@gmail.com
> >>>>>> >
> >>>>>>        
> >>>>>>
> >>>>>>
> >>>>>>        Here's the patch, against
> >>>>>>        linux-2.6.39.3/drivers/net/__**wireless/ath/ath9k/xmit.c
> >>>>>>
> >>>>>>
> >>>>>>
> >>>>>>

"
216,Dave Täht,2011-08-01 06:58:18.103123,"Sorry for the noise on the previous comment, all I'd meant to do was change the line to be more clear about what I meant about tuples. This is even more clear:

""I certainly have some ideas towards increasing the maximum AMPDU to larger amounts (than 3) while retaining sanity on the TCP/ip side, notably by having it be *IP/port IP/port tuple sensitive*, would get single station performance back up into levels where up to 64 packets could be aggregated but that's something longer term than merely what we are discussing now, and requires far more knowledge of the raw packets than the driver should know about.

A smarter qdisc could do a somewhat saner form of fair queueing and get more packets into aggregation than we currently see with the existing wireless qdiscs, but it needs to be more of a bi-directional relationship between that layer and this.

I've also pretty much come to the conclusion that what we've been calling ""Ants"" - system control packets that arent TCP mice or elephants, need to go in the wireless VI queue and out of BE, entirely.

All that said, this is somewhat separate of the ongoing thread."
216,John Linville,2011-08-01 07:48:06.079834,"This bug report is a bit hard to read...

Is there an infinite retry?  Or just a long one?  Under which circumstances does it occur?

What does the patch at the top do?  What problem is it addressing?

The patch is for ath9k, but the discussion seems to be about Minstrel.  Where does the problem reside?"
216,Dave Täht,2011-08-01 08:18:10.00139,"On Mon, Aug 1, 2011 at 8:56 AM, Andrew McGregor <andrewmcgr@gmail.com> wrote:

    Or, even better again… do add the number of hardware retries
 to the per-subframe counter, but make the limit be the same 
as the Minstrel work limit for the rate, so as to be completely 
fair to the frame in terms of TU of transmitter effort?  
That seems most like the right thing.

    On 1/08/2011, at 4:42 AM, Felix Fietkau wrote:

    I have a better idea: Instead of limiting this value to 2
, why not leave it at 10, but add the number of hardware retries
 to the per-subframe retry counter. That way subframes that get 
lost during the transmission of A-MPDUs with few or no hardware 
retransmissions are not unnecessarily penalized, but if A-MPDUs 
get retransmitted often, subframes will get kicked out quickly as well.

-- 
Dave Täht
SKYPE: davetaht
US Tel: 1-239-829-5608
http://the-edge.blogspot.com "
216,Dave Täht,2011-08-01 08:20:32.858972,"@ John

John Linville wrote:
> This bug report is a bit hard to read...
> 
> Is there an infinite retry?  Or just a long one?  Under which circumstances does it occur?

If I move to purposely bad conditions - 40 meters or so away from the AP, I can get some pings through, but they take 1.6 seconds. This is from debloat-testing to cerowrt rc1.

> 
> What does the patch at the top do?  What problem is it addressing?

An infinite loop in the minstrel-ht code.

> 
> The patch is for ath9k, but the discussion seems to be about Minstrel.  Where does the problem reside?

Everywhere.
"
216,Dave Täht,2011-08-01 08:39:37.763882,"Andrew - still not registered on the wiki, writes in:

""Unfortunately, you can't have less than 64 plus a few packets living inside a driver buffer in the worst-case situation with aggregation, not without somehow clamping the window, and I can't see a way to do that within the MAC protocol right now.  Remember that there can be quite a few 802.11 control frames living in those buffers too, not just data frames, and running out of buffers for control frames is very, very bad news.

I think it is possible to get pretty much optimal range, throughput and latency in the same driver at the same time, but it will take some tuning to get there.

Lab conditions, that being two devices just outside front-end saturation range on a workbench in an all-wooden building, are irrelevant.  We're all talking about things that happen in the real world, it's just that for repeatability's sake you need to have a fairly stable test environment.  Bad links are the rule, not the exception, in the wifi world, and robustness is a very important goal; I think it's worth sacrificing just a little latency for a degree of robustness, because broken links and TCP stalls are just as annoying as the latency getting out of hand."""
216,David Taht,2011-08-01 08:47:13.19635,"This is why in 1998, based on the mosquitonet research, I decided that split
tcp approaches were best for wireless designs, and have used a web proxy
ever since. I am very mad at myself for not publishing and fully describing
the need for such back then, and it wasn't until I worked on this patent
case, and read over a huge amount of old emails, how important it really
was.

http://the-edge.blogspot.com/2010/10/who-invented-embedded-linux-based.html

I didn't realize nobody else was using web proxies anymore until I got out
into the 'real world' a few years ago.

All that said, it's water under the bridge now: but I hope not to have to
bear the same pain Vint Cerf does about choosing only 32 bits for ipv4, for
anywhere near as long.

And all that said, yes, some compromise between all these variables is
feasible using the sort of monte carlo techniques in minstrel, that I
admire.

but I'd sure like it tunable, so that other approaches (using the polipo web
proxy in cerowrt's case with westwood+ on the inside, AND ECN) can be
effectively tried.

If you want to read some good, yet old papers on mosquitonet and some of the
work on aggregation that was done at the university of colorado, and some
more recent work by comcast, I'll try and dig those up.


On Mon, Aug 1, 2011 at 9:35 AM, Andrew McGregor <andrewmcgr@gmail.com>wrote:

> Unfortunately, you can't have less than 64 plus a few packets living inside
> a driver buffer in the worst-case situation with aggregation, not without
> somehow clamping the window, and I can't see a way to do that within the MAC
> protocol right now.  Remember that there can be quite a few 802.11 control
> frames living in those buffers too, not just data frames, and running out of
> buffers for control frames is very, very bad news.
>
> I think it is possible to get pretty much optimal range, throughput and
> latency in the same driver at the same time, but it will take some tuning to
> get there.
>
> Lab conditions, that being two devices just outside front-end saturation
> range on a workbench in an all-wooden building, are irrelevant.  We're all
> talking about things that happen in the real world, it's just that for
> repeatability's sake you need to have a fairly stable test environment.  Bad
> links are the rule, not the exception, in the wifi world, and robustness is
> a very important goal; I think it's worth sacrificing just a little latency
> for a degree of robustness, because broken links and TCP stalls are just as
> annoying as the latency getting out of hand.
>
>
> On 1/08/2011, at 8:47 AM, Dave Taht wrote:
>
> Excellent. So it sounds like your patch, along with andrew's latency
> reducing suggestions, and increasing ATH_RXBUF and ATH_TXBUF to 160 or so,
> would be the strongest candidate in the bakeoff?
>
> I am still quite allergic to having more than 32 packets
>
> living inside a driver buffer... but am willing to do extensive testing of all approaches that make sense at this point.
>
>
> Unfortunately I now find myself blocked by bug #202. I can
> certainly bring debloat-testing back in, and many other types of clients,
>
> as well as maybe (?) patch up the SR-71 driver I have for cardbus,
> but really want to just do cero to cero testing to eliminate all other variables.
>
>
> On Mon, Aug 1, 2011 at 6:29 AM, Felix Fietkau <nbd@openwrt.org> wrote:
>
>> Last time I tried limiting the aggregation size that much, it ended up
>> reducing the throughput from 80 mbit/s down to just over 20 with strong
>> fluctuations.
>>
>> I realize that latency is pretty much all you care about, but I'd prefer
>> if the focus was directed more towards reducing bufferbloat without causing
>> nasty throughput regressions on links with good conditions. By the way,
>> those good conditions that I'm talking about are not jsut 'laboratory
>> conditions'. We've set up quite a few medium to distance links that perform
>> well with little retransmission and good aggregation levels.
>>
>> You can find a patch that implements my suggestion for handling swretry
>> here: http://nbd.name/561-ath9k_sw_**retry_reduce.patch<http://nbd.name/561-ath9k_sw_retry_reduce.patch>
>> In my tests it seems to work well without hurting throughput under
>> reasonably good conditions, but it needs some more testing.
>>
>> - Felix
>>
>>
>> On 2011-08-01 1:41 PM, Dave Taht wrote:
>>
>>> I am adding this discussion to the bug reporting system via cc'ing the
>>> bot and changing the subject line to include the appropriate number.
>>>
>>> My principal concern with exorbitant buffering and retries is that no
>>> signalling is sent back to the tcp sender to indicate that it should
>>> maybe slow down.
>>>
>>> My reasoning for choosing 3 packets as a decent outer limit for a AMPDU
>>> is that if one packet gets through, the rest can be dropped safely,
>>> which will - yes, I totally understand - result in less than maximum
>>> wireless-n performance - but give reasonably bounded latencies for all
>>> packets AND provide end-to-end signaling that made sense.
>>>
>>> I don't care about maximizing wireless-n performance in laboratory
>>> conditions, what I care about is having decent mixed g and n performance
>>> in fair to bad conditions, with contention from multiple APs and clients.
>>>
>>> Felix had produced one patch early on that I thought was promising under
>>> that scenario, treating g and n differently, that I'm trying to find.
>>>
>>> I would like to move this discussion to the bug report if at all
>>> possible,
>>>
>>> I certainly have some ideas towards increasing the maximum AMPDU to
>>> larger sizes while retaining sanity on the TCP/ip side, notably by
>>> having it be tuple sensitive, but that's something longer term than
>>> merely what we are discussing now.
>>>
>>> On Mon, Aug 1, 2011 at 2:42 AM, Felix Fietkau <nbd@openwrt.org>
>>> <mailto:nbd@openwrt.org>> wrote:
>>>
>>>    I have a better idea: Instead of limiting this value to 2, why not
>>>    leave it at 10, but add the number of hardware retries to the
>>>    per-subframe retry counter. That way subframes that get lost during
>>>    the transmission of A-MPDUs with few or no hardware retransmissions
>>>    are not unnecessarily penalized, but if A-MPDUs get retransmitted
>>>    often, subframes will get kicked out quickly as well.
>>>
>>>    - Felix
>>>
>>>
>>>    On 2011-08-01 3:02 AM, Andrew McGregor wrote:
>>>
>>>        So is this a more appropriate way to clear it out:
>>>
>>>        diff --git a/drivers/net/wireless/ath/__**ath9k/ath9k.h
>>>        b/drivers/net/wireless/ath/__**ath9k/ath9k.h
>>>        index 2a40fa2..47e0b99 100644
>>>        --- a/drivers/net/wireless/ath/__**ath9k/ath9k.h
>>>        +++ b/drivers/net/wireless/ath/__**ath9k/ath9k.h
>>>        @@ -396,7 +396,7 @@ struct ath_led {
>>>          #define DEFAULT_CACHELINE       32
>>>          #define ATH_REGCLASSIDS_MAX     10
>>>          #define ATH_CABQ_READY_TIME     80      /* % of beacon interval
>>> */
>>>        -#define ATH_MAX_SW_RETRIES      10
>>>        +#define ATH_MAX_SW_RETRIES      2
>>>          #define ATH_CHAN_MAX            255
>>>          #define IEEE80211_WEP_NKID      4       /* number of key ids */
>>>
>>>        IOW, simply don't try so many SW retries?  This should end up
>>>        BARing it forward pretty quickly.
>>>
>>>        I think this is a pretty important tuning variable… and 10 looks
>>>        like a pretty silly value, 'cause the frame already had a
>>>        reasonable number of TX opportunities.
>>>
>>>        Andrew
>>>
>>>        On 29/07/2011, at 8:22 AM, Felix Fietkau wrote:
>>>
>>>              The receive window typically isn't small, it's often as
>>>            big as 64 frames. The only way to prevent that from messing
>>>            up the receiver state is to send a BAR for failed frames,
>>>            and that means pushing even more frames to the tx queue,
>>>            thus potentially making the problem even worse.
>>>
>>>              I have the following ideas for attacking the root causes
>>>            of bloated queues with aggregation:
>>>
>>>              1. Delay the sequence number assignment to the point where
>>>            it actually transmits a frame for the first time. That
>>>            allows the driver to pick any frame that hasn't been
>>>            transmitted yet for dropping when the queue gets full.
>>>              2. Keep track of the size of the sequence number gap of
>>>            pending frames. That allows the driver to make a better
>>>            decision of when to drop a frame and send a BAR or when to
>>>            retry some more.
>>>              3. Allow the driver to either try different rates for
>>>            retransmissions, or to request another rate control lookup.
>>>            The code for that should probably be pushed as much as
>>>            possible into mac80211 and the rate control module.
>>>
>>>              - Felix
>>>
>>>              On 2011-07-29 2:10 PM, Andrew McGregor wrote:
>>>
>>>                  I may be able to put a few cycles in to this shortly…
>>>                there's a
>>>                  tradeoff here, and continually recycling is definitely
>>>                the wrong thing.
>>>                  I realise that dropping here is the wrong thing, but
>>>                it's less wrong
>>>                  than retrying forever. With a fairly small receive
>>>                window, it won't be
>>>                  that bad.
>>>
>>>                  Andrew
>>>
>>>                  On 29/07/2011, at 7:55 AM, Felix Fietkau wrote:
>>>
>>>                      If it's doing infinite retry, then that's a bug in
>>>                    the per-subframe retry count tracking and should be
>>>                    fixed properly.
>>>
>>>                      About the 1.6 seconds: Yes, it would be nice if
>>>                    ath9k was able to drop packets more easily, but that
>>>                    requires some more surgery in the xmit path, which
>>>                    I'm going to take care of eventually.
>>>
>>>                      In the mean time I'm not going to apply any
>>>                    kludges that simply trade one problem for another
>>>                    (and have the potential to create nasty side effects).
>>>
>>>                      - Felix
>>>
>>>                      On 2011-07-29 1:39 PM, Dave Taht wrote:
>>>
>>>                          1 retrans good?, infinite very bad.
>>>
>>>                          I was seeing 1.6 SECOND pings, man... going 40
>>>                        meters....
>>>
>>>                          Got a better suggestion?
>>>
>>>                        http://www.bufferbloat.net/__**issues/216<http://www.bufferbloat.net/__issues/216>
>>>                        <http://www.bufferbloat.net/**issues/216<http://www.bufferbloat.net/issues/216>
>>> >
>>>
>>>                          Andrew also sent along another patch...
>>>
>>>                          On Fri, Jul 29, 2011 at 2:03 AM, Felix
>>>                        Fietkau<nbd@openwrt.org <mailto:nbd@openwrt.org>
>>>                        <mailto:nbd@openwrt.org
>>>
>>>                        <mailto:nbd@openwrt.org>>>   wrote:
>>>
>>>                            No retrans not good. No retrans make gaps in
>>>                        client side reorder
>>>                            window. Gaps in client buffers bad, make
>>>                        traffic stall and latencies.
>>>
>>>
>>>                            On 2011-07-29 2:21 AM, Dave Taht wrote:
>>>
>>>                                infinite retrans bad. No retrans good. I
>>>                        LOVE IETF.
>>>
>>>                                ---------- Forwarded message ----------
>>>                                From: *Andrew
>>>                        McGregor*<andrewmcgr@gmail.com
>>>                        <mailto:andrewmcgr@gmail.com>
>>>                        <mailto:andrewmcgr@gmail.com
>>>                        <mailto:andrewmcgr@gmail.com>>
>>>                        <mailto:andrewmcgr@gmail.com
>>>                        <mailto:andrewmcgr@gmail.com>
>>>                        <mailto:andrewmcgr@gmail.com
>>>                        <mailto:andrewmcgr@gmail.com>>**>__>
>>>                                Date: Thu, Jul 28, 2011 at 5:37 PM
>>>                                Subject: Patch for stuck retransmits
>>>                                To: dave.taht@gmail.com
>>>                        <mailto:dave.taht@gmail.com><**mailto:
>>> dav__e.taht@gmail.com
>>>
>>>                        <mailto:dave.taht@gmail.com>>
>>>                        <mailto:dave.taht@gmail.com
>>>                        <mailto:dave.taht@gmail.com><_**_mailto:
>>> dave.taht@gmail.com
>>>
>>>                        <mailto:dave.taht@gmail.com>>>
>>>
>>>
>>>                                Here's the patch, against
>>>
>>>                          linux-2.6.39.3/drivers/net/___**
>>> _wireless/ath/ath9k/xmit.c
>>>
>>>
>>>
>>>"
216,Felix Fietkau,2011-08-01 08:55:18.219638,"I want the algorithm to know whether it's making a decision for an 
aggregate or a single, and possibly also how big the aggregate is.

Also, the rate control could tune for more reliable rates and smaller 
aggregates if the sequence number gap is bigger, to prevent more 
unnecessary receiver side latency.

- Felix

On 2011-08-01 5:38 PM, Andrew McGregor wrote:
> Why not just ask rate control for a new decision when you make the aggregate?  None of the rate algorithms are stateful based on tx rate queries from the driver, so that's a perfectly safe and sensible thing to do.
>
> Or, are you thinking that the rate decision API needs to know that it is being asked for a rate set for an aggregate?
>
> On 1/08/2011, at 9:06 AM, Felix Fietkau wrote:
>
>>  I've also been thinking about changing the rate control parameters but I think we need to take a different approach here. The main issue is that A-MPDU rate control needs to be handled completely different from single-frame rate control. Unfortunately at the point in time where rate control runs, the decision about A-MPDU transmission vs single transmission has not been made yet, so I will probably have to make some rate control API changes to give the driver a chance to interact with the RC directly.
>>
>>  Another issue is that test results for g/n interop from all our previous attempts at limiting queue size are pretty much meaningless.
>>
>>  Dropping packets based on internal per-tid queue counters currently is too bursty for TCP to adapt properly. The debloat-testing eBDP code completely ignores the inner workings of ath9k's queueing, so it cannot properly distinguish between aggregated and unaggregated traffic, which need completely different queueing characteristics.
>>
>>  What we need to be able to produce meaningful test results is proper queue management on the internal ath9k per-TID queues (plus the non-aggregated tx queue for legacy or VI traffic).
>>
>>  This will definitely take some more time to develop, but I think without that we should not jump to any conclusions based on results from random header file hack jobs.
>>
>>  - Felix
>>
>>  On 2011-08-01 2:47 PM, Dave Taht wrote:
>>>  Excellent. So it sounds like your patch, along with andrew's latency
>>>  reducing suggestions, and increasing ATH_RXBUF and ATH_TXBUF to 160 or
>>>  so, would be the strongest candidate in the bakeoff?
>>>
>>>  |I am still quite allergic to having more than 32 packets
>>>
>>>  living inside a driver buffer... but am willing to do extensive testing of all approaches that make sense at this point.
>>>
>>>
>>>  Unfortunately I now find myself blocked by bug #202. I can
>>>  certainly bring debloat-testing back in, and many other types of clients,
>>>
>>>  as well as maybe (?) patch up the SR-71 driver I have for cardbus,
>>>  but really want to just do cero to cero testing to eliminate all other variables.
>>>  |
>>>
>>>
>>>  On Mon, Aug 1, 2011 at 6:29 AM, Felix Fietkau<nbd@openwrt.org
>>>  <mailto:nbd@openwrt.org>>  wrote:
>>>
>>>     Last time I tried limiting the aggregation size that much, it ended
>>>     up reducing the throughput from 80 mbit/s down to just over 20 with
>>>     strong fluctuations.
>>>
>>>     I realize that latency is pretty much all you care about, but I'd
>>>     prefer if the focus was directed more towards reducing bufferbloat
>>>     without causing nasty throughput regressions on links with good
>>>     conditions. By the way, those good conditions that I'm talking about
>>>     are not jsut 'laboratory conditions'. We've set up quite a few
>>>     medium to distance links that perform well with little
>>>     retransmission and good aggregation levels.
>>>
>>>     You can find a patch that implements my suggestion for handling
>>>     swretry here: http://nbd.name/561-ath9k_sw___retry_reduce.patch
>>>     <http://nbd.name/561-ath9k_sw_retry_reduce.patch>
>>>     In my tests it seems to work well without hurting throughput under
>>>     reasonably good conditions, but it needs some more testing.
>>>
>>>     - Felix
>>>
>>>
>>>     On 2011-08-01 1:41 PM, Dave Taht wrote:
>>>
>>>         I am adding this discussion to the bug reporting system via
>>>         cc'ing the
>>>         bot and changing the subject line to include the appropriate number.
>>>
>>>         My principal concern with exorbitant buffering and retries is
>>>         that no
>>>         signalling is sent back to the tcp sender to indicate that it should
>>>         maybe slow down.
>>>
>>>         My reasoning for choosing 3 packets as a decent outer limit for
>>>         a AMPDU
>>>         is that if one packet gets through, the rest can be dropped safely,
>>>         which will - yes, I totally understand - result in less than maximum
>>>         wireless-n performance - but give reasonably bounded latencies
>>>         for all
>>>         packets AND provide end-to-end signaling that made sense.
>>>
>>>         I don't care about maximizing wireless-n performance in laboratory
>>>         conditions, what I care about is having decent mixed g and n
>>>         performance
>>>         in fair to bad conditions, with contention from multiple APs and
>>>         clients.
>>>
>>>         Felix had produced one patch early on that I thought was
>>>         promising under
>>>         that scenario, treating g and n differently, that I'm trying to
>>>         find.
>>>
>>>         I would like to move this discussion to the bug report if at all
>>>         possible,
>>>
>>>         I certainly have some ideas towards increasing the maximum AMPDU to
>>>         larger sizes while retaining sanity on the TCP/ip side, notably by
>>>         having it be tuple sensitive, but that's something longer term than
>>>         merely what we are discussing now.
>>>
>>>         On Mon, Aug 1, 2011 at 2:42 AM, Felix Fietkau<nbd@openwrt.org>
>>>         <mailto:nbd@openwrt.org>
>>>         <mailto:nbd@openwrt.org<mailto:nbd@openwrt.org>>>  wrote:
>>>
>>>             I have a better idea: Instead of limiting this value to 2,
>>>         why not
>>>             leave it at 10, but add the number of hardware retries to the
>>>             per-subframe retry counter. That way subframes that get lost
>>>         during
>>>             the transmission of A-MPDUs with few or no hardware
>>>         retransmissions
>>>             are not unnecessarily penalized, but if A-MPDUs get
>>>         retransmitted
>>>             often, subframes will get kicked out quickly as well.
>>>
>>>             - Felix
>>>
>>>
>>>             On 2011-08-01 3:02 AM, Andrew McGregor wrote:
>>>
>>>                 So is this a more appropriate way to clear it out:
>>>
>>>                 diff --git a/drivers/net/wireless/ath/____ath9k/ath9k.h
>>>                 b/drivers/net/wireless/ath/____ath9k/ath9k.h
>>>                 index 2a40fa2..47e0b99 100644
>>>                 --- a/drivers/net/wireless/ath/____ath9k/ath9k.h
>>>                 +++ b/drivers/net/wireless/ath/____ath9k/ath9k.h
>>>                 @@ -396,7 +396,7 @@ struct ath_led {
>>>                   #define DEFAULT_CACHELINE       32
>>>                   #define ATH_REGCLASSIDS_MAX     10
>>>                   #define ATH_CABQ_READY_TIME     80      /* % of beacon
>>>         interval */
>>>                 -#define ATH_MAX_SW_RETRIES      10
>>>                 +#define ATH_MAX_SW_RETRIES      2
>>>                   #define ATH_CHAN_MAX            255
>>>                   #define IEEE80211_WEP_NKID      4       /* number of
>>>         key ids */
>>>
>>>                 IOW, simply don't try so many SW retries?  This should
>>>         end up
>>>                 BARing it forward pretty quickly.
>>>
>>>                 I think this is a pretty important tuning variable… and
>>>         10 looks
>>>                 like a pretty silly value, 'cause the frame already had a
>>>                 reasonable number of TX opportunities.
>>>
>>>                 Andrew
>>>
>>>                 On 29/07/2011, at 8:22 AM, Felix Fietkau wrote:
>>>
>>>                       The receive window typically isn't small, it's
>>>         often as
>>>                     big as 64 frames. The only way to prevent that from
>>>         messing
>>>                     up the receiver state is to send a BAR for failed
>>>         frames,
>>>                     and that means pushing even more frames to the tx queue,
>>>                     thus potentially making the problem even worse.
>>>
>>>                       I have the following ideas for attacking the root
>>>         causes
>>>                     of bloated queues with aggregation:
>>>
>>>                       1. Delay the sequence number assignment to the
>>>         point where
>>>                     it actually transmits a frame for the first time. That
>>>                     allows the driver to pick any frame that hasn't been
>>>                     transmitted yet for dropping when the queue gets full.
>>>                       2. Keep track of the size of the sequence number
>>>         gap of
>>>                     pending frames. That allows the driver to make a better
>>>                     decision of when to drop a frame and send a BAR or
>>>         when to
>>>                     retry some more.
>>>                       3. Allow the driver to either try different rates for
>>>                     retransmissions, or to request another rate control
>>>         lookup.
>>>                     The code for that should probably be pushed as much as
>>>                     possible into mac80211 and the rate control module.
>>>
>>>                       - Felix
>>>
>>>                       On 2011-07-29 2:10 PM, Andrew McGregor wrote:
>>>
>>>                           I may be able to put a few cycles in to this
>>>         shortly…
>>>                         there's a
>>>                           tradeoff here, and continually recycling is
>>>         definitely
>>>                         the wrong thing.
>>>                           I realise that dropping here is the wrong
>>>         thing, but
>>>                         it's less wrong
>>>                           than retrying forever. With a fairly small receive
>>>                         window, it won't be
>>>                           that bad.
>>>
>>>                           Andrew
>>>
>>>                           On 29/07/2011, at 7:55 AM, Felix Fietkau wrote:
>>>
>>>                               If it's doing infinite retry, then that's
>>>         a bug in
>>>                             the per-subframe retry count tracking and
>>>         should be
>>>                             fixed properly.
>>>
>>>                               About the 1.6 seconds: Yes, it would be
>>>         nice if
>>>                             ath9k was able to drop packets more easily,
>>>         but that
>>>                             requires some more surgery in the xmit path,
>>>         which
>>>                             I'm going to take care of eventually.
>>>
>>>                               In the mean time I'm not going to apply any
>>>                             kludges that simply trade one problem for
>>>         another
>>>                             (and have the potential to create nasty side
>>>         effects).
>>>
>>>                               - Felix
>>>
>>>                               On 2011-07-29 1:39 PM, Dave Taht wrote:
>>>
>>>                                   1 retrans good?, infinite very bad.
>>>
>>>                                   I was seeing 1.6 SECOND pings, man...
>>>         going 40
>>>                                 meters....
>>>
>>>                                   Got a better suggestion?
>>>
>>>         http://www.bufferbloat.net/____issues/216
>>>         <http://www.bufferbloat.net/__issues/216>
>>>         <http://www.bufferbloat.net/__issues/216
>>>         <http://www.bufferbloat.net/issues/216>>
>>>
>>>                                   Andrew also sent along another patch...
>>>
>>>                                   On Fri, Jul 29, 2011 at 2:03 AM, Felix
>>>                                 Fietkau<nbd@openwrt.org>
>>>         <mailto:nbd@openwrt.org>  <mailto:nbd@openwrt.org>
>>>         <mailto:nbd@openwrt.org>>
>>>         <mailto:nbd@openwrt.org<mailto:nbd@openwrt.org>
>>>
>>>         <mailto:nbd@openwrt.org<mailto:nbd@openwrt.org>>>>    wrote:
>>>
>>>                                     No retrans not good. No retrans make
>>>         gaps in
>>>                                 client side reorder
>>>                                     window. Gaps in client buffers bad, make
>>>                                 traffic stall and latencies.
>>>
>>>
>>>                                     On 2011-07-29 2:21 AM, Dave Taht wrote:
>>>
>>>                                         infinite retrans bad. No retrans
>>>         good. I
>>>                                 LOVE IETF.
>>>
>>>                                         ---------- Forwarded message
>>>         ----------
>>>                                         From: *Andrew
>>>                                 McGregor*<andrewmcgr@gmail.com>
>>>         <mailto:andrewmcgr@gmail.com>
>>>         <mailto:andrewmcgr@gmail.com<mailto:andrewmcgr@gmail.com>>
>>>         <mailto:andrewmcgr@gmail.com<mailto:andrewmcgr@gmail.com>
>>>         <mailto:andrewmcgr@gmail.com<mailto:andrewmcgr@gmail.com>>>
>>>         <mailto:andrewmcgr@gmail.com<mailto:andrewmcgr@gmail.com>
>>>         <mailto:andrewmcgr@gmail.com<mailto:andrewmcgr@gmail.com>>
>>>         <mailto:andrewmcgr@gmail.com<mailto:andrewmcgr@gmail.com>
>>>         <mailto:andrewmcgr@gmail.com<mailto:andrewmcgr@gmail.com>>>__>__>
>>>                                         Date: Thu, Jul 28, 2011 at 5:37 PM
>>>                                         Subject: Patch for stuck retransmits
>>>                                         To: dave.taht@gmail.com
>>>         <mailto:dave.taht@gmail.com>
>>>         <mailto:dave.taht@gmail.com>
>>>         <mailto:dave.taht@gmail.com>><__mailto:dav__e.taht@gmail.com
>>>         <mailto:dav__e.taht@gmail.com>
>>>
>>>         <mailto:dave.taht@gmail.com<mailto:dave.taht@gmail.com>>>
>>>         <mailto:dave.taht@gmail.com<mailto:dave.taht@gmail.com>
>>>         <mailto:dave.taht@gmail.com>
>>>         <mailto:dave.taht@gmail.com>><____mailto:dave.taht@gmail.com
>>>         <mailto:dave.taht@gmail.com>
>>>
>>>         <mailto:dave.taht@gmail.com<mailto:dave.taht@gmail.com>>>>
>>>
>>>
>>>                                         Here's the patch, against
>>>
>>>
>>>           linux-2.6.39.3/drivers/net/______wireless/ath/ath9k/xmit.c
>>>
>>>
>>>
>>>"
216,Dave Täht,2011-08-01 09:19:01.073466,"Continually repasting andrew's threads until he bothers to register for the bufferbloat site, so it stops rejecting his emails:

He wrote, re http://www.bufferbloat.net/issues/216#note-21

""Which is also why at IndraNet, we deliberately used OpenVPN over the wireless, with Westwood on the outside, to protect the end-user's TCP from loss over multiple wireless hops.  Combine that with Jana Iyengar's TCP-minion and you'd get QoS working right as well."""
216,Dave Täht,2011-08-01 09:22:03.33581,"And re felix's last

Andrew wrote:

""Ah, yes, that makes a lot of sense.  It is certainly possible to get Minstrel (at least) to go for highest delivery probability ahead of latency, and that probably should happen if doing software retransmit."""
216,Jim Gettys,2011-08-01 10:06:44.844066,"The point of aggregation, as I understand it, is to amortize the overhead of the ""on the air"" framing over multiple packets.

So just because the hardware *can* aggregate 64 packets, doesn't mean it *should* do so; the biggest gain is at an aggregation of 2, and drops from there.  Most of the potential benefit is done by the time 4 or 8 packets have been aggregated, and the percentage gain continues to drop.

But can we have our cake and eat it to?

It may be that the amount of aggregation should be varied as the channel itself varies: when you have a low loss channel, that's when aggregation is most possible and most desirable to get the maximium bandwidth with somewhat decently low delay.  But when the air is lossy and we're having severe trouble getting wireless frames through, that's when we're likely to find shorter frames do better (as I understand it), and would be much better off controlling latency by shorter frames anyway.

Or am I all wet about this?

"
215,Evan Hunt,2011-08-01 10:34:15.880528,s/!them-key/!key them-key/
202,Luis Rodriguez,2011-08-01 11:25:12.491641,The description is pretty vague.
216,Jonathan Morton,2011-08-01 13:18:12.03421,"Stupid question: once several IP packets have been aggregated into one frame, can individual packets still be separated in the reception success/acknowledgement/retransmit stuff?  Or is the entire frame sink or swim together?"
216,David Taht,2011-08-01 13:19:27.151953,"What an interesting bit of history behind all this! Did your original code
also compensate for the multicast rate on wireless being so much slower than
the peak rate?

The monstrousness of multicast packets on wireless completely mess up all
existing qdisc's estimators...

On Mon, Aug 1, 2011 at 1:44 PM, Simon Barber <simon@superduper.net> wrote:

> I did the original implementation of wireless queuing in mac80211. The
> original implementation installed a special wireless root qdisc on the
> interface in order to model the hardware queues correctly, and allow leaf
> qdiscs to be installed. Ideally the MAC queues would also have been moved
> into this qdisc. The wireless root qdisc sat on an interface that
> represented the physical radio and had an 802.11 frame type. There were one
> or more 802.3 format virtual interfaces that represented wireless client or
> APs. The wireless qdisc on the native 802.11 interface saw frames in 802.11
> format, and hence could calculate how much airtime would be taken
> transmitting the frame - this would allow development of qdiscs to do things
> like share airtime rather than bandwidth. The wireless root qdisc exposed
> the native hardware queues that exist in 802.11 chip sets and bypassed the
> normal single queue netdev interface. This allowed the hardware queues to be
> fed independently.
>
> Unfortunately the native 802.11 interface was deemed confusing to users,
> and this code got pulled out of the kernel, thus preventing the qdisc system
> from ever properly working when more than one virtual Ethernet interface is
> used with a wireless card - such as when you run multiple virtual APs on a
> wireless card, or simultaneous AP and client modes. This concept of a
> special wireless root qdisc is necessary to model the hardware queues and
> the MAC queues in 802.11 correctly - you're not queuing lots of frames in
> the driver, rather extending the queuing system to implement parts of the
> MAC.
>
> Simon
>
>
> On 08/01/2011 06:30 AM, John W. Linville wrote:
>
>> On Mon, Aug 01, 2011 at 06:06:43AM -0600, Dave Taht wrote:
>>
>>> If anyone can spare some eyeballs for the discussion of wireless-n AMPDUs
>>> and their interaction with bufferbloat, and groks TCP's behavior and/or
>>> wireless's behavior, I'd appreciate some comment on:
>>>
>>> http://www.bufferbloat.net/**issues/216<http://www.bufferbloat.net/issues/216>
>>>
>>> Losing SOME appropriate packets, somewhere in the wireless stack, is
>>> necessary.
>>>
>>
>> It seems appropriate to Cc: linux-wireless@vger.kernel.org for this...
>>
>>
> ______________________________**_________________
> Bloat mailing list
> Bloat@lists.bufferbloat.net
> https://lists.bufferbloat.net/**listinfo/bloat<https://lists.bufferbloat.net/listinfo/bloat>
>"
216,Dave Täht,2011-08-01 14:36:58.831682,"Some exchanges on what to patch in and test against next:

<nbd> dtaht: i think what might be useful is a combination of current trunk
      mac80211 + my sw retries patch + capping the hw max rate tries to 3
								        [09:45]
<nbd> dtaht: btw. i have a simple little tcp splitter here:
      http://nbd.name/gitweb.cgi?p=tcptrans.git;a=summary  [09:50]
<nbd> transparent tcp proxy, uses netfilter to grab the connections and
      creates new outgoing connections to the original destinations
<dtaht> excellent splitter  [09:53]
<dtaht> so use rc4 with my bletcherous patches as a baseline and try the
	above?
<dtaht> to compare?
<dtaht> (not the tcp split stuff, again I expect to be in pain from that
	mistake for decades) - the patches you suggested?  [09:54]
<nbd> i don't know what's in rc4  [09:55]
<nbd> haven't looked at it
<nbd> just copy mac80211 from latest trunk
<dtaht> nbd: heh - neat, can hack a programmable ecn into this splitter maybe
<nbd> including the commit i made today
<dtaht> rc4 has my bletcherous patch in it
<nbd> i don't know what patch that is
<dtaht> http://www.bufferbloat.net/issues/216#note-8  [09:58]
<nbd> ah, ok. that one needs to be kicked out  [09:59]
<nbd> except for the hw->max_rate_tries change  [10:00]
<nbd> you can keep that
<nbd> but combined with my other patch, ATH_MAX_SW_RETRIES needs to stay at 10
<nbd> because my patch changes the meaning of that limit
<dtaht> Why not just pull from head
<nbd> go for it"
202,Dave Täht,2011-08-01 15:11:04.818461,"Thanks for checking it out luis!

I tried to get STA mode to work from the gui, and it failed to connect to anything or get a dhcp address. I have not had time to look at it further, if you or someone else can, I'd appreciate it."
129,Dave Täht,2011-08-01 15:15:30.4454,"Given all the bugs on the buglist, I really need to take a couple days with writing this up, and generate a test plan and write some test tools, and build an overall test strategy. My plan at the moment is to take a looooong train ride across canada this week to do this. I'm told that wifi works periodically on that train, and there is power, but would like details...

Maybe some additional testing hardware is needed too. I just got a demo key for some test software to try out:

...

There are some extra steps in addition to the LANforge Installation documentation shown below in configuring your own Linux box with ath9k NIC for use with LANforge. Please see the attached wifi_notes.txt or call us at 360-380-1618.

Please let us know if you would like additional features enabled for your demo purposes.

The attached LANforge License file includes installation instructions,
please contact us at support@candelatech.com if you require assistance.

In order to obtain the LANforge Server and GUI software, you will need
to use your website account login. Create one here:
http://www.candelatech.com/cgi/cr_login.cgi

Latest LANforge software release:
http://www.candelatech.com/downloads.php

LANforge GUI software installation documentation:
http://www.candelatech.com/lfgui_install.php

LANforge Server software installation documentation:
http://www.candelatech.com/lfserver_install.php

Our systems price list can be found here:
http://www.candelatech.com/lf_systems.php

For emulating up to 32 wireless stations, the CT520 is $7995.
For emulating up to 64 wireless stations, the CT520-64 is $8995.
For emulating up to 128 wireless stations, the CT520-128 is $9995.

Annual support is 17% of the total system price plus any additional features such as WAN emulation, Secondary IPs, Armageddon, VoIP etc...

We do have one in stock as pictured here:
http://www.candelatech.com/ct520_product.php

But we can also install on other platforms we have in stock such as:
http://www.candelatech.com/lf_parts.php#LF0300"
206,jacopo cesareo,2011-08-01 15:19:12.568318,"I have installed the uftp and uftpd modules on rc4 and ran a simple file exchange between a host and the router experiment in a *wired* setting.
I also changed the router from server to client(uftp to uftpd) and back and so far it hasn't crashed.

The wireless link, on the other hand, seems to be not functioning. It seems like UFTP doesn't run on the wireless link AT ALL.
 "
216,Dave Täht,2011-08-01 15:25:44.480392,"Simon wrote in on the original, much saner sounding, 802.11 stack:

Hi Dave,

You can see the wireless qdisc in the initial import of mac80211 to the kernel - checkout f0706e828e96d0fa4e80c0d25aa98523f6d589a0, and look at net/mac80211/wme.c

A quick review of 'git log net/mac80211/wme.c' reveals:

It looks like select_queue() got added at 51cb6db0f5654f08a4a6bfa3888dc36a51c2df3e, and that is where the qdisc disappeared. The (required) native Wi-Fi interface disappeared at 3b8d81e020f77c9da8b85b0685c8cd2ca7c7b150.
"
216,David Taht,2011-08-01 16:10:30.797371,"Any extra mojo would be good.

---------- Forwarded message ----------
From: Rick Jones <rick.jones2@hp.com>
Date: Mon, Aug 1, 2011 at 12:07 PM
Subject: Re: what sort of netperf parameters can help lay bare the problems
in 216?
To: Dave Taht <dave.taht@gmail.com>, Richard Jones <rick.jones2@hp.com>

I'm not sure what specfic netperf options would be helpful there.  I suppose
the histogram of round-trip-times might be interesting along with the
distribution statistics, but netperf won't have direct visibility into what
is happening at the wireless.

rick"
216,Simon Barber,2011-08-01 16:13:19.043647,"Jonathan Morton wrote:
> Stupid question: once several IP packets have been aggregated into one frame, can individual packets still be separated in the reception success/acknowledgement/retransmit stuff?  Or is the entire frame sink or swim together?

There are 2 types of aggregation in 11n - MSDU and MPDU. With MSDU aggregation the aggregate is acknowledged as a whole, it all sinks or swims together. Multiple MSDUs (ethernet frames from above the mac) get turned into a single aggregate MSDU, and then sent down. This does not need any low level MAC control frame changes, and something very similar was part of Atheros's 'Super G'. With MPDU aggregation each individual aggregated frame is separately acknowledged and retried (although the acknowledgements are combined into a block ack). They can both be used together - although that would be a little silly."
216,Andrew McGregor,2011-08-01 17:56:08.252875,"Jim Gettys wrote:
> The point of aggregation, as I understand it, is to amortize the overhead of the ""on the air"" framing over multiple packets.
> 
> So just because the hardware *can* aggregate 64 packets, doesn't mean it *should* do so; the biggest gain is at an aggregation of 2, and drops from there.  Most of the potential benefit is done by the time 4 or 8 packets have been aggregated, and the percentage gain continues to drop.
> 
> But can we have our cake and eat it to?
> 
> It may be that the amount of aggregation should be varied as the channel itself varies: when you have a low loss channel, that's when aggregation is most possible and most desirable to get the maximium bandwidth with somewhat decently low delay.  But when the air is lossy and we're having severe trouble getting wireless frames through, that's when we're likely to find shorter frames do better (as I understand it), and would be much better off controlling latency by shorter frames anyway.
> 
> Or am I all wet about this?

I'm inclined to agree with you... aggregation has a cost as well as a benefit, and it gets less valuable as the channel gets lossy.  And I think we can get a hint from Minstrel as to how much aggregation is a win.  I'll have a think about the math."
216,Felix Fietkau,2011-08-02 02:33:44.408236,"Simon Barber wrote:
> There are 2 types of aggregation in 11n - MSDU and MPDU. With MSDU aggregation the aggregate is acknowledged as a whole, it all sinks or swims together. Multiple MSDUs (ethernet frames from above the mac) get turned into a single aggregate MSDU, and then sent down. This does not need any low level MAC control frame changes, and something very similar was part of Atheros's 'Super G'. With MPDU aggregation each individual aggregated frame is separately acknowledged and retried (although the acknowledgements are combined into a block ack). They can both be used together - although that would be a little silly.

Actually, I don't think combining the two is silly. AMSDU can be used to combine multiple small packets (e.g. TCP ACKs) into one normal sized packet. AMPDU then aggregates that with the other packets in the queue. "
195,Dave Täht,2011-08-02 15:38:21.470366,"Felix has made enormous progress today in fixing the unaligned instruction traps.

<nbd> dtaht: i have another idea about the alignment issue  [08:00]
<nbd> dtaht: i can try declaring the ip/tcp/udp header struct as __packed
<dtaht> hi  [08:01]
<dtaht> just pulled into the train station
<nbd> i think gcc automatically generates unaligned access code then
<dtaht> don't know how bad the wifi will be
<dtaht> um, usually
<dtaht> __packed means that a byte and a 16 bit struct and a byte will get
	packed together
<dtaht> which scares me mildly in this case
<nbd> gcc will not generate any implicit padding  [08:02]
<nbd> but it'll also assume that the entire struct is unaligned
<dtaht> it will?
<nbd> yes, i only figured it out by accident
<nbd> when i was profiling ath9k, i noticed the descriptor access functions
      were showing up with high percentage points  [08:03]
<dtaht> ok. I guess I'm going to need more pedestals for godlike behavior...
<nbd> then i looked a the assembly and noticed that it didn't do aligned 32
      bit access
<dtaht> hmm
<nbd> when i did __packed __aligned(4), it started doing 32 bit access again
<dtaht> this sounds like either a brilliant hack, or an instant system crash.
								        [08:04]
<dtaht> I mean, normal people don't go NEAR the ip header code. EVER.
<nbd> system crash is pretty much impossible with this
<dtaht> but I concede you are not normal in any respect
<dtaht> the thing is
<nbd> because the struct was carefully written to not rely on implicit padding
<nbd> because implicit padding is highly arch specific
<dtaht> I'm on a train, and wifi is spotty
<dtaht> do you need me to get you setup on huchra, or can I reuse andrews
	build environent, or what?  [08:05]
<nbd> i don't need huchra right now
<nbd> i'm compiling on my laptop anyway
<dtaht> ok, well, I do want to be able to get the same results as you  [08:06]
<dtaht> did you think andrews's fixes to the TU stuff was worthwhile?
<nbd> i don't think it'll have significant effects at this point  [08:07]
<nbd> especially not with the max retries override
<dtaht> I guess my core question is, can I get a rollup patch from you that is
	sane, of all this stuff, so I don't have to replicate the bits flying
	in loose formation?
<dtaht> ok.... (That was a dubious sounding ok....)
<nbd> this TU stuff is just a heuristic for determining the number of retries
								        [08:08]
<nbd> minimum retries per stage is 2 anyway
<dtaht> actually, better, could andrew and I get a rollup patch - on the bug
	report 216 - of where you are at. Hopefully the next train I get on
	will be less laggy.
<dtaht> and I can get a build done
<nbd> so if you cap the maximum number of retries, then there is only little
      effect that this stuff can have
<dtaht> hell, might even just flash a router on the train
<dtaht> and take a stab at what the heck is wrong with STA mode
* dtaht chortles
<nbd> wow
<nbd> cpu load went from 75% to 57%  [08:09]
<dtaht> for 'normal' firewall at 100Mbit?
<nbd> yes
<nbd> and i only changed two lines ;)
<nbd> well, i might need to change a third line for udp ;)
<dtaht> dude, if you care to rewrite the rules a bit to use the interface+
	syntax a little smarter, and get multiport working right, I think
	you'll finally be able to drive this thing at 300Mbit for real, from
	the gige port.  [08:10]
<dtaht> I would note I would be REALLY SCARED of that change and want to slam
	a lot of verification streams through it....
<nbd> i'm 95% confident that this change won't break anything  [08:11]
<nbd> well, 99%
<nbd> i knew an idea like this would show up if i waited long enough for it ;)
								        [08:12]
<dtaht> heh
* dtaht applaudes
<dtaht> (how do you spell applaud in french? German?)  [08:13]
<nbd> applaudieren
<nbd> (= to applaud)
* dtaht applaudieren
<dtaht> um, to what other protocols could this apply? Across the board?
<dtaht> does it work with ipv6?  [08:14]
<nbd> i added ip, udp and tcp
<nbd> ipv6 can be fixed the same way too
<nbd> but there are still some remaining unaligned exceptions
<dtaht> s/can/needs to be/
<nbd> so i can probably improve things even more if i track them down
<dtaht> I am setting up a testlab at isc with native ipv6, next week, I hope
* dtaht makes puppy dog eyes at nbd to prioritize making ipv6 just as happy as
  ipv4  [08:15]
<nbd> already did that  [08:16]
<nbd> there's still 7 unaligned exceptions per packet  [08:17]
<nbd> at least with icmp
<nbd> ah, nice. debugfs allows me to force the kernel to print a stack trace
      on every unaligned exception  [08:20]
<nbd> good thing i compiled my kernel with debug info
<dtaht> way to go
<nbd> ok, so the checksum still needs fixing
<dtaht> csum_partial?  [08:25]
<dtaht> I'd seen multiple people hack that up to do the right thing
<dtaht> never understood why there wasnt a gnerica csum_partial_unaligned
	people could use
* dtaht notes train is sucking up tcp   [08:26]
<dtaht> I have to switch trains shortly

<nbd> they didn't add an unaligned version, because there are only very few
      devices that have both crappy ethernet chips with alignment limitations
      and inefficient unaligned access
<nbd> so they were probably hoping to never need crap like that
<dtaht> nbd: still, felix, I've seen a modified csum_partial go by at least 3
	times for a couple arches, and it bugs me it's not in there...
								        [08:32]
<nbd> right now i'm fixing ip_fast_csum
<nbd> which is responsible for 4 out of 7 unaligned exceptions  [08:33]
<npmapn> I've read about the progress you've made.  [08:34]
<npmapn> This is amazing!
<nbd> two other exceptions are in ipv4_pkt_to_tuple
<nbd> also easy to fix
<dtaht> yea, I immediately spotted that csum_partial thing last time. Been
	there. Done that. :) Didn't realize it was also doing that many other
	places that were busted....
<dtaht> it has been a very insanely productive couple days. Meeting andrew was
	amazing.... Then the guy that wrote the original mac80211
	surfaced... And nbd is back and restored to life, after chasing girls
	for weeks in Indonesia... :)  [08:35]
<npmapn> That always helps. ;)
<nbd> btw. this is the diffstat of my alignment change (including checksum
      fix):  [08:41]
<nbd>  6 files changed, 23 insertions(+), 17 deletions(-)
<nbd> currently building it for a quick test run
<dtaht> sounds worth polishing and pushing to mainline
<nbd> no
<nbd> definitely not
<nbd> it makes everything not suffering from this issue perform worse  [08:42]
<nbd> and there's no good way around that
<nbd> so it'll stay an openwrt specific hack
<dtaht> ok
<dtaht> judging from the results you got on the first pass, I'm expecting to
	be really impressed with this next pass
<dtaht> :)  [08:44]
<npmapn> This set of patches will stay in the ar71xx patches directory, I
	 suppose.
<nbd> well, the first one already took care of most of the issues
<nbd> so the second patch will only be a minor improvement on top of that
<dtaht> well, csum_partial back in the old days used to be a nightmare
<dtaht> but I'm REALLY dating myself in even talking about it  [08:45]
<dtaht> (we're talking an embedded board I worked on in the mid 80s)
<nbd> :)
<dtaht> racal-interlan something or other
<dtaht> offloaded the entire tcp stack into like 320k on a pci board
<dtaht> no... It was ISA - 16 bit  [08:46]
<dtaht> but at the time, it was impossible to run tcp/ip well under dos
* dtaht pulls out a few gray hairs
<dtaht> ok, I gotta switch trains now  [08:47]
<dtaht> add some notes to the unaligned bug report? The patch maybe?
<dtaht> will be back online in 90 minutes
<nbd> yay, no more unaligned exceptions in the hotpath  [08:48]
<dtaht> got a number for cpu usage at 100mbit?  [08:49]
<dtaht> got 2 minutes before I get off train
<nbd> 55%
<dtaht> can you test and drive gige?
<nbd> later
<nbd> my current test endpoint only does 100
<dtaht> I have 3 routers on me  [08:50]
<dtaht> It would be gas to run 'em on the next train
<dtaht> gotta go
* dtaht Applaus!!
<npmapn_> 40-50% CPU usage at 92mbps with PPPoE wired<>wired  [10:32]
<npmapn_> tx ring buffe for eth0 / eth1 : 8  [10:33]
<npmapn_> buffer *
<nbd> what did you get before for the same test?
<npmapn_> Let me check in the log, I remember I have run the same test before.
								        [10:34]
<npmapn_> 88-92mbps at 60-75% CPU usage wired->wired  [10:35]
<dtaht> wow with 8 buffers?
<dtaht> cooooool
<dtaht> I think the theory that 64+ buffers are required for 100+Mbit
	performance has been thoroughly debunked.  [10:36]
* dtaht wonders what 4 buffers would do
<npmapn_> dtaht: It would be just about the same.
<nbd> depends
<nbd> npmapn_: what's the txqueue length?
<npmapn_> 500 for eth0/eth1/pppoe-wan
<nbd> so limiting the buffers to 8 doesn't really do much then  [10:37]
<npmapn_> 2.6.39 is MUCH better at handling larger tx queues
<nbd> if you still have 500 buffers in the network stack
<dtaht> txqueuelen Is 16 by default
<dtaht> it's the latency and qos that starts working again < 32 total
	unmanaged buffers
<dtaht> 16 on cerowrt
<dtaht> also, incidentally 
<dtaht> tcp_low_latency parameter seems to help  [10:38]
<dtaht> it's in proc somewhere
<npmapn_> /proc/sys/net/ipv4/tcp_low_latency
<npmapn_> I get 75% CPU usage with 200 for txqueuelen for all three
	  interfaces.  [10:39]
<npmapn_> 50-65% with the same txqueuelen and tcp_low_latency enabled.  [10:40]
<dtaht> realllly  [10:42]
<dtaht> I was thinking I'd make that being on as the default.
<dtaht> nmapn  [10:43]
<dtaht> what is your actuall bandwidth at that level
<dtaht> and what are your latency under load results
<dtaht> (e.g. Pinging while doing all that)
<npmapn_> dtaht: If you're away from home on various wifi networks, please
	  give yeah tcp congestion a shot.
<dtaht> heh. I'm on a train now
<npmapn_> Let me check. Should I ping something like my DNS or something far
	  away?  [10:44]
<dtaht> is that god enough
<dtaht> something on the path that is not what you are getting the big fat
	test stream from
<npmapn_> yeah tcp? It should help you a lot.
<dtaht> 8.8.8.8  for example.
<npmapn_> reply time from 8.8.8.8 only with IRC open: 34-38ms  [10:46]
* dtaht starts a drum roll
<npmapn_> reply time from 8.8.8.8 with 92mbps downstream traffic: 38-42 with
	  one reply of 52 ms  [10:47]
<dtaht> AAAAAWESEOM  [10:50]
<dtaht> with txqueuelen of? And tx queue of?  [10:51]
<npmapn_> txqueuelen 500 for all 3 interfaces and tx buffer of 8
<dtaht> any qos at all?
<dtaht> heh  [10:52]
<npmapn_> Yes, the one you've got from me. Let me remove it and try again.
<dtaht> going through a tunnel now
<dtaht> that's why the long txqueue is working so well.
<dtaht> (or so I guess)
<npmapn_> Yes, that's right.  [10:55]
<dtaht> with your qos turned off, ping
	goes to hell  [10:56]
<dtaht> ?  [10:57]
<npmapn_> It looks like my ISP is
	  doing something right. QoS
	  doesn't make it any worse.
<npmapn_> I mean lack of QoS doesn't
	  make it any worse.
<npmapn_> I removed all qdiscs,
	  checked that I've got only
	  pfifo_fast on all interfaces
	  and I also ran iptables -F
	  -t mangle.  [10:58]
<dtaht> my next big test is hard to setup  [11:03]
<dtaht> but you'd want 8-10 big streams going
<npmapn_>
	  http://hackingnasdaq.blogspot.com/2010/01/myth-of-procsysnetipv4tcplowlatency.html
<dtaht> and see what happens
<dtaht> NOT MEASURED ON A SLOW, bandwidth constrained router  [11:04]
<dtaht> would love to have him repeat his tests on cerowrt
<npmapn_> openwrt trunk is rock solid with these parameters.  [11:08]
<npmapn_> I can give cerowrt a shot in the weekend.  [11:09]
<npmapn_> This is a good test scenario because PPPoE adds some overhead and
	  upstream hardware is compensating for this somehow.  [11:10]
<dtaht> ij  [11:26]
<dtaht> I will have a new build by then I hope

<dtaht> felix, can you assemble your patch set to date and get it to me and
	andrew?
"
216,Andrew McGregor,2011-08-02 16:58:23.204333,"So, I tried adding this patch to a stock openwrt trunk, turned UP the retransmit limit from 10 to 50 to account for the effects of the semantic change, and also a) reduced the Minstrel segment size from 6ms to 1ms, and b) reduced the AMPDU aggregation limit from 4ms to 1ms.  I did this in steps to observe the effect of each change (and backed out a few other changes because they made things worse).

Net result, I see an improvement in throughput from about 70 Mbps to about 130 Mbps, and simultaneously an improvement in latency under load.

Workload is this:

netperf -t OMNI -H 192.168.1.1 -- -d send\|recv -r 256,256K &
netperf -t OMNI -H 192.168.1.1 -- -d send\|recv -r 256K,256 &
netperf -H 192.168.1.1 &
netperf -H 192.168.1.1 & 
netperf -t OMNI -H 192.168.1.1 -- -d send\|recv -r 64,64 &
netperf -H 192.168.1.1 &
netperf -H 192.168.1.1 &

Test setup is a WNDR3700v2 at around one meter range talking to a 2011 MacBook Pro (running OS X Lion). 

This particular OpenWRT is set up like this:
root@OpenWrt:~# tc qdisc show
qdisc pfifo_fast 0: dev eth0 root refcnt 2 bands 3 priomap  1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1
qdisc pfifo_fast 0: dev eth1 root refcnt 2 bands 3 priomap  1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1
qdisc mq 0: dev wlan0 root 
qdisc mq 0: dev mon.wlan0 root 
qdisc mq 0: dev wlan1 root 
qdisc mq 0: dev mon.wlan1 root 


I'm looking at the transactions per second returned by the 64 byte send|recv netperf.  It goes up from around 45 tps to around 170 tps with those simple changes.  Throughput I'm getting from the GUI on the router.

Then I tried reducing the txqueuelen with ip link set dev wlan1 txqueuelen x.

You know what?  It NEEDS that thousand packet txqueue and the 512 txbufs in the driver… if I reduce either, I get both worse throughput and a latency INCREASE.  Who knew?

On 1/08/2011, at 5:29 AM, Felix Fietkau wrote:

> Last time I tried limiting the aggregation size that much, it ended up reducing the throughput from 80 mbit/s down to just over 20 with strong fluctuations.
> 
> I realize that latency is pretty much all you care about, but I'd prefer if the focus was directed more towards reducing bufferbloat without causing nasty throughput regressions on links with good conditions. By the way, those good conditions that I'm talking about are not jsut 'laboratory conditions'. We've set up quite a few medium to distance links that perform well with little retransmission and good aggregation levels.
> 
> You can find a patch that implements my suggestion for handling swretry here: http://nbd.name/561-ath9k_sw_retry_reduce.patch
> In my tests it seems to work well without hurting throughput under reasonably good conditions, but it needs some more testing.
> 
> - Felix"
216,David Taht,2011-08-02 17:02:25.086911,"move to bad conditions - say 30 meters from the access point, and repeat."
216,Andrew McGregor,2011-08-02 17:11:45.989288,"David Taht wrote:
> move to bad conditions - say 30 meters from the access point, and repeat.

Makes no difference to the relative merits of each change, I've been doing that all along (at about 15 meters with three walls in the way).  Of course, it goes slower out in fringe coverage.

Later I might try from the other side of the street, just to see."
216,David Taht,2011-08-02 17:12:45.840654,"I also note that I've been setting up a new build of the latest and greatest
in andrew's dir on huchra.[1]

I have ripped out 98% of the 902-bufferbloat patch, pulled felixes latest
for bug #195 - and all of openwrt head actually, current packages, and
reintegrated various other cerowrt bits... and am doing a smoke test build
now.

Which has failed twice now, which I'm fixing. uclibc changes... aggh...

I find myself totally confused now about what, exactly is to be patched into
the ath9k driver.

Andrew, could you jump on huchra and patch in whatever you feel is
appropriate from yours and felix's patch serieses for the ath9k?

I do think you need to be testing the worst case scenarios - along with
multiple clients and APs - before being overly overjoyed.

I am loving what felix just pulled off on #195 tho."
216,Dave Täht,2011-08-02 17:15:13.839759,"Also, test against g. Which I can do, as soon as I get a build"
216,David Taht,2011-08-02 17:17:08.016288,"And I'm building against 2.6.39.2 again rather than 3, although I swear that
patch is in cerowrt head.... it's going to be a while before I get a build
I'm happy with, so... a clean patches for ath9k highly desired to add to the
stuff I have flying in loose formation.


On Tue, Aug 2, 2011 at 6:12 PM, Dave Taht <dave.taht@gmail.com> wrote:

> I also note that I've been setting up a new build of the latest and
> greatest in andrew's dir on huchra.[1]
>
> I have ripped out 98% of the 902-bufferbloat patch, pulled felixes latest
> for bug #195 - and all of openwrt head actually, current packages, and
> reintegrated various other cerowrt bits... and am doing a smoke test build
> now.
>
> Which has failed twice now, which I'm fixing. uclibc changes... aggh...
>
> I find myself totally confused now about what, exactly is to be patched
> into the ath9k driver.
>
> Andrew, could you jump on huchra and patch in whatever you feel is
> appropriate from yours and felix's patch serieses for the ath9k?
>
> I do think you need to be testing the worst case scenarios - along with
> multiple clients and APs - before being overly overjoyed.
>
> I am loving what felix just pulled off on #195 tho.
>"
216,David Taht,2011-08-02 17:34:56.393224,"---------- Forwarded message ----------
From: Andrew McGregor <andrewmcgr@gmail.com>
Date: Tue, Aug 2, 2011 at 6:23 PM
Subject: Re: Patch for stuck retransmits [#216]
To: Dave Taht <dave.taht@gmail.com>


David Taht wrote:
> I also note that I've been setting up a new build of the latest and
greatest
> in andrew's dir on huchra.[1]

> I find myself totally confused now about what, exactly is to be patched
into
> the ath9k driver.
>
> Andrew, could you jump on huchra and patch in whatever you feel is
> appropriate from yours and felix's patch serieses for the ath9k?
>
> I do think you need to be testing the worst case scenarios - along with
> multiple clients and APs - before being overly overjoyed.
>
> I am loving what felix just pulled off on #195 tho.

I'll generate some patches on monster (big 24 core box I've been building
on) and ship them across, might be tomorrow morning before I get to that.

I note that I'm testing in a residential area in Palo Alto, there's not
exactly a shortage of other APs around here, but I only have one client to
be playing with; multi-client load testing will have to wait till I get
home, where I can beat it up with 3 computers, two iPhones, and the Airport
Express on the TV network that has three gadgets behind it... HD streaming
is a really good test for TCP stalls.

On 2/08/2011, at 5:20 PM, Dave Taht wrote:

> And what is your latency under load, exactly, under what conditions,
exactly?

Averages 5.8 ms transaction latency over TCP (that netperf 64 bytes each way
measurement) sitting right on top of the AP, degrades to about 13 ms at 15 m
behind 3 walls.

Andrew"
216,David Taht,2011-08-02 17:35:11.709902,"---------- Forwarded message ----------
From: Dave Taht <dave.taht@gmail.com>
Date: Tue, Aug 2, 2011 at 6:28 PM
Subject: Re: Patch for stuck retransmits [#216]
To: Andrew McGregor <andrewmcgr@gmail.com>


Why will 1000 txqueues and 512 driver buffers not suck rocks on wireless-g?
I sort of understand that infinite retry is now gone, but lacking patches,
it's hard to keep up.

On Tue, Aug 2, 2011 at 6:23 PM, Andrew McGregor <andrewmcgr@gmail.com>wrote:

> I'll generate some patches on monster (big 24 core box I've been building
> on) and ship them across, might be tomorrow morning before I get to that.
>
>
OK, well, I can test 3 APs all night here, with patches...


> I note that I'm testing in a residential area in Palo Alto, there's not
> exactly a shortage of other APs around here, but I only have one client to
> be playing with; multi-client load testing will have to wait till I get
> home, where I can beat it up with 3 computers, two iPhones, and the Airport
> Express on the TV network that has three gadgets behind it... HD streaming
> is a really good test for TCP stalls.
>

 I hope to have a 2.6.39.3 build done in about an hour. I then have to look
into whatever's wrong with #202"
216,David Taht,2011-08-02 17:39:39.389292,"In looking over your tests I suspect the reason your latency under load
remains good is that running netperf on the router itself is eating so much
cpu that you can no longer hit your new outer limits.

I suggest running netperf THROUGH the router, to another box entirely.

Heisenbugs suck. See what sort of cpu usage you have during the tests as run
previously.

I note #195 is amazing. are you running with commit
8fb4b275c205bd5f9cedc052f846d66245c63df1

already?"
216,David Taht,2011-08-02 17:59:02.110824,"OK: I am tossing out the rc4 tree entirely, going back to openwrt head,
reintegrating the patches that I'd meant to push back to openwrt 3 weeks ago
before being interrupted (notably iproute 2.6.39 and iptables 1.4.12), and
doing all that work in andrew's build dir.

This will likely take a while. I look forward to getting something mildly
testable tonight, and look forward to the ath9k and minstrel patches landing
tomorrow.

Amazing couple of days, folks!"
195,Dave Täht,2011-08-02 18:23:55.585747,felix pushed today's work into openwrt head.
49,Dave Täht,2011-08-02 18:56:00.822694,"heh, steve walker beat me to it.

need to test the -g option in the next build"
45,Dave Täht,2011-08-02 18:59:02.681595,""
95,Dave Täht,2011-08-02 18:59:30.632871,""
126,Dave Täht,2011-08-02 19:00:07.54555,I'm not sure this is still a problem at all.
98,Dave Täht,2011-08-02 19:00:24.993003,""
203,Dave Täht,2011-08-02 19:00:56.099898,""
121,Dave Täht,2011-08-02 19:03:11.179969,""
206,Dave Täht,2011-08-02 19:27:46.42874,did you add multicast routes to the wireless interface?
216,Andrew McGregor,2011-08-02 19:47:56.02767,"I just checked, the CPU usage is about 35%, so I think that's fine.

On 2/08/2011, at 5:39 PM, Dave Taht wrote:

> In looking over your tests I suspect the reason your latency under load remains good is that running netperf on the router itself is eating so much cpu that you can no longer hit your new outer limits.
> 
> I suggest running netperf THROUGH the router, to another box entirely.
> 
> Heisenbugs suck. See what sort of cpu usage you have during the tests as run previously.
> 
> I note #195 is amazing. are you running with commit 8fb4b275c205bd5f9cedc052f846d66245c63df1
> 
> already?"
216,David Taht,2011-08-02 19:48:04.411788,"A build of cerowrt on top of openwrt head, with the fixes to #195 in there,
and the old bufferbloat patch ripped out, should be available in a half hour
from:

http://huchra.bufferbloat.net/~andrewm/cerowrt/

It lacks the new ath9k/minstrel stuff andrew is talking about, and the
current 'debloat' script would need to be changed to not muck with
txqueuelen on wireless... but seriously folks I think g will still be very
bad in bad conditions at txqueuelen 1000 + driver buffering 512. I retain an
open mind, however.

I also forgot, once again, to add in oprofile unaligned trap counters.

So hopefully andrew will land those patches tomorrow morning, and I'll do a
new build and test.

I'm going to stay another day in toronto to do so. I'd prefer to just get on
towards home...

I would love to know if the diffserv stuff I did here:

https://github.com/dtaht/Diffserv

still ran as slowly as it did prior to #195. The scripts are ame_dbg and
diffserv_dbg - and the easy test is to move the iperf classifier to the end
of the string of iptables rules and run iperf.

script runs on both openwrt and regular linux. I think ame is mildly more
modern than diffserv. I gave up, because the performance was so bad, and
wrote up how to make it fast, here:

http://www.bufferbloat.net/projects/bloat/wiki/Diffserv_RFC"
216,David Taht,2011-08-02 19:50:30.383903,"Actually, that build just popped out. Anybody feel ambitious enough to try
it?

Or Andrew, feel ambitious enough to fold in your patches?"
216,Dave Täht,2011-08-02 20:05:52.093116,OK trying it...
206,jacopo cesareo,2011-08-02 20:54:16.172729,"Yes. I actually got it to work one way (when the host sends the file and the router receives it) but not the other way around. Most probably it's something weird on my MAC that is not allowing it to respond, (it sees the packets I've checked with tcpdump). What can it be? Whatever it is, it wasn't doing it in ATL."
215,Dave Täht,2011-08-02 20:54:40.560789,applied patch.
138,Stephen Woodrow,2011-08-02 21:50:04.187641,"Apologies for the blast from the past, but I'm getting reading to close Cape Town and want to make sure this doesn't need any more work. See my question below:

Dave Täht wrote:
> It does require hand configuration of the file to account for a few things and added features, which need to be documented on the wiki.

Is this manual configuration information either in the wiki or built into the package somehow?"
127,Stephen Woodrow,2011-08-02 21:54:02.52898,""
166,Stephen Woodrow,2011-08-02 21:58:32.010486,""
195,David Taht,2011-08-02 22:03:46.373208,"---------- Forwarded message ----------
From: Dave Taht <dave.taht@gmail.com>
Date: Tue, Aug 2, 2011 at 11:03 PM
Subject: some ar71xx tests [#195]
To: Andrew McGregor <andrewmcgr@gmail.com>, Felix Fietkau <nbd@openwrt.org>


I built a version of cerowrt from openwrt head, in andrew's dir with netperf
installed by default...

Going with the defaults:

netperf -H the_other_router from_one_router

I get 143Mbit

Going router-router over gigE (lan to wan), with tcp_low_latency turned on,
on both sides, with:

Recv   Send    Send
Socket Socket  Message  Elapsed
Size   Size    Size     Time     Throughput
bytes  bytes   bytes    secs.    10^6bits/sec

 87380  16384  16384    60.00     218.20

so tcp_low_latency looks like a win with westwood+

My laptop doesn't do gigE, so can't test that here.

All these tests are with the default firewall rules for cerowrt, and nat
turned off on the one master router... and ethernet buffers of *4*, and
txqueuelen of 8.

For giggles, I did a test with cubic:

root@OpenWrt:/proc/sys/net/ipv4# fg
netperf -l 60 -H 172.30.42.33
Recv   Send    Send
Socket Socket  Message  Elapsed
Size   Size    Size     Time     Throughput
bytes  bytes   bytes    secs.    10^6bits/sec

 87380  16384  16384    60.00     228.26

And last, with cubic, and firewall rules turned off:

MIGRATED TCP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to
gw.home.lan (172.30.42.33) port 0 AF_INET
Recv   Send    Send
Socket Socket  Message  Elapsed
Size   Size    Size     Time     Throughput
bytes  bytes   bytes    secs.    10^6bits/sec

 87380  16384  16384    60.00     257.75

I'll try diffserv again in the morning."
172,Stephen Woodrow,2011-08-02 22:05:41.960796,"We should expand upon this to more general configuration options that could affect measurements: TCP congestion control algorithm, DNS resolvers, iptables rules, etc."
144,Stephen Woodrow,2011-08-02 22:09:19.595675,"May I request another status update? I'd like to put this into either Atlanta or Napoli, accordingly."
51,Stephen Woodrow,2011-08-02 22:11:34.016797,I believe progress was made on this by Dave some time ago. Can we close it? (or update and move into the next release?)
195,Dave Täht,2011-08-02 22:12:20.398516,"interestingly, the tcp stream going from laptop (100Mbit) - router (gige) router only has about a ~5ms latency for ping

the udp_stream test:

64 bytes from 172.31.42.33: icmp_req=525 ttl=64 time=41.0 ms
64 bytes from 172.31.42.33: icmp_req=526 ttl=64 time=37.3 ms
64 bytes from 172.31.42.33: icmp_req=527 ttl=64 time=33.0 ms

and crashes and burns with a -l 120 - never ending

with -l 10

MIGRATED UDP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 172.30.42.33 (172.30.42.33) port 0 AF_INET
Socket  Message  Elapsed      Messages                
Size    Size     Time         Okay Errors   Throughput
bytes   bytes    secs            #      #   10^6bits/sec

126976   65507   10.01        1842      0      96.47
112640           10.01           0              0.00


"
64,Stephen Woodrow,2011-08-02 22:13:17.95938,""
57,Stephen Woodrow,2011-08-02 22:16:35.901411,"Hi Nick, I assume this got done and was just never closed. Can you confirm or deny?"
44,Stephen Woodrow,2011-08-02 22:18:56.311865,"Can we close this, or extract the uncompleted requirements and flesh them out more? I expect anything remaining this late in the game will go into Napoli."
202,Dave Täht,2011-08-03 04:48:27.281911,"Mostly pilot error - I'd not managed to get nat working, and the DHCP assigned address wouldn't let any packets through, thus making named not work at all AND regect what it got back as invalid....

Of course, trying to make this work, out of a hotel, is a PITA. It's sad that everyone feels you must submit to a legal agreement before using their net.

This bug entry CLOSED via a natted - 2 router - to hotel gw over wireless.

Had to disable named to do it, but...



"
216,Dave Täht,2011-08-03 05:58:49.103304,"The wired side is working out really well, and I'm connected wirelessly, writing this, doing massive amounts of tests, with the old wireless bufferbloat patch backed out completely.

Still have a low txqueuelen, will test with the vastly larger ones thus far recomended, against this base, on wireless-g

I have found a dscp regression with iptables 1.4.12. The --dscp match cannot be inverted "
126,Dave Täht,2011-08-03 07:08:48.109322,"Bridging is no longer used in cerowrt. If others wish to bridge widely disparate networking interfaces together, they deserve all the pain they get."
198,Dave Täht,2011-08-03 07:10:13.313892,"I'm going to close this one and create a new one for optimizing the firewall rules more.

That said, the firewall rules as they exist now need to be thoroughly tested."
142,Dave Täht,2011-08-03 07:13:44.365243,It's in there. We need to thoroughly test SFB in the testplan.
118,Dave Täht,2011-08-03 07:14:49.839474,Needs to be thoroughly tested in the testplan.
216,Dave Täht,2011-08-03 07:16:08.022564,basically #216 covers this issue.
162,Dave Täht,2011-08-03 07:16:08.368124,basically #216 covers this issue.
196,Dave Täht,2011-08-03 07:17:08.739461,adding it to the testplan...
49,Dave Täht,2011-08-03 07:19:23.728929,"httping -Q for persistent connections works great in the 1.5.1 package!

round-trip min/avg/max = 181.3/203.8/263.3 ms
root@OpenWrt:~# httping -Q https://lists.bufferbloat.net
PING lists.bufferbloat.net:443 (https://lists.bufferbloat.net):
pinged host 149.20.54.82:443 (266 bytes), seq=0 time=600.97 ms 
pinged host 149.20.54.82:443 (265 bytes), seq=1 time=70.62 ms 
pinged host 149.20.54.82:443 (265 bytes), seq=2 time=70.87 ms 
pinged host 149.20.54.82:443 (265 bytes), seq=3 time=70.06 ms "
216,Dave Täht,2011-08-03 07:26:36.377065,"oops, closed the wrong bug."
201,Dave Täht,2011-08-03 07:29:47.216081,the openwrt AHCPD package seems to be broken even for single interfaces. I'm moving solving this problem out to the next release. There's only so much I can get done personally before Cerowrt 1.0.
123,Dave Täht,2011-08-03 07:50:03.783012,"The issues here are fairly large. Because isc-dhcp is targetted at large providers (100s of queries/sec), and not the home (20 queries/day), and the most current isc-dhcpv6 includes all of bind9, I ripped it out and at least temporarily replaced it with just using dnsmasq as a dhcp server, where it has full GUI support, and is quite smaller.

0) There is no need for dhcpv6 inside the home. Stateless autoconfiguration + dhcpv4 leveraging the generated EUI-64, suffices for 99% of all ipv6 capable devices.

1) The dnsscripts that leveraged dhcpv4 addresses and turned them into stateless autoconfig ipv6 addresses, and inserted them into bind were dependent on evan's dual domain system, and not quite as view capable as they needed to be, where you would typically want to publish SOME addresses, but not all

2) They didn't speak dnsmasq's syntax for it's plugin script, but isc-dhcp's.

3) They didn't pick up on the dynamically assigned 6to4 or 6in4 addresses generated by openwrt.

4) In the shorter term, I'd like a dhcp server that ran out of xinetd. That would allow for locking out misbehaving, worm-ridden, devices from even getting on the network. I found one that looked pretty good.

http://inetdxtra.sourceforge.net/

5) In the longer term, merging the functionality of AHCPD (the mesh network ip address distribution daemon) with dhcpv4 and dhcpv6 seems the right way to go, to get a common lease table and address distribution method that works both with conventional systems and mesh ones.
 
This work is already taking place elsewhere. I have no idea what schedule it is on.

AHCPD: 

http://www.pps.jussieu.fr/~jch/software/ahcp/

As I don't think any of these issues can be fixed in the time remaining, I'm scheduling these for the next cerowrt release, and further discussion of approaches."
197,Dave Täht,2011-08-03 07:59:58.782351,"I ultimately did get this to more or less work, but I think having a better out of the box experience, where you could get a ca from various competing outsourced providers and allow for various levels of privledge into the box, is necessary.

And that that is too hard to get done fast.

Also, the charon 16 threads eats 54% of virtual memory on a 64MB box - not physical! - 

and there should be a gui front end to a server somewhere that doesn't exist.

That said, the universal evaluation from multiple experts is that strongswan is the way to go, over openvpn, openswan, and other lesser known alternatives."
189,Dave Täht,2011-08-03 08:01:21.509983,Going with strongswan instead.
216,Andrew McGregor,2011-08-03 08:16:55.268679,"David Taht wrote:
> In looking over your tests I suspect the reason your latency under load
> remains good is that running netperf on the router itself is eating so much
> cpu that you can no longer hit your new outer limits.
> 
> I suggest running netperf THROUGH the router, to another box entirely.
> 
> Heisenbugs suck. See what sort of cpu usage you have during the tests as run
> previously.

CPU is around 50%, so I'm fairly sure I'm fine.

I also tried running a tickless kernel with HZ=1000, and that made a fairly noticeable difference too.
"
216,Dave Täht,2011-08-03 08:47:52.66627,"I've often thought that embedded MIPS was ready for tickless. There used to be a problem with HTB for example, that lacking support for highres timers, had 'interesting' granularities on the 10ms tick.

While I'm told that's fixed, and I'm very leeery of switching to tickless or a more rapid clock interval at this late date, I feel it is the right thing to do long term. As for the shorter term...

what sort of 'better' results are you getting? :)"
216,Dave Täht,2011-08-03 08:52:04.337789,"oh, and I ran both routers, all night, with netperf, both on udp and tcp, with a 30 second cycle across the wired interfaces.

No kernel oopses, and with tcp_low_latency and tcp cubic I saw the fastest performance I've ever got out of these things, by far, and I'm tickled pink... 

Ping times stayed flat during tcp transfers, but during the udp test (through two routers) spiked as high as 33ms. I note that to complicate matters, my laptop runs an older version of debloat-testing, so I am leery of calling that a real problem - but I did also see netperf blow up at a 2 minute duration for udp_stream, but haven't analyzed it. Perhaps you can duplicate my results on your build and hardware?"
216,Andrew McGregor,2011-08-03 09:16:33.682603,"Tickless was invented by SGI, and the MIPS CPU architecture was designed to run tickless, so it's nearly optimal for the architecture.

Anyway, it seems to give me about 15% on 11n transactions-per-second.

11g is sucking horribly for me at the moment, so I have a little more to do yet.

On 3/08/2011, at 8:47 AM, cerowrt@lists.bufferbloat.net wrote:

> 
> Issue #216 has been updated by Dave Täht.
> 
> 
> I've often thought that embedded was ready for tickless. There used to be a problem with HTB for example, that lacking support for highres timers, had 'interesting' granularities on the 10ms tick.
> 
> While I'm told that's fixed, and I'm very leeery of switching to tickless or a more rapid clock interval at this late date, I feel it is the right thing to do long term. As for the shorter term...
> 
> what sort of 'better' results are you getting? :)
> ----------------------------------------
> Bug #216: Infiinite retry for ping
> https://www.bufferbloat.net/issues/216
> 
> Author: Dave Täht
> Status: In Progress
> Priority: Immediate
> Assignee: Andrew McGregor
> Category: 
> Target version: 1st Public Cerowrt release
> 
> 
> ping takes 1.6 seconds to go 40 meters. 
> 
>"
216,Dave Täht,2011-08-03 09:32:15.332184,"Andrew McGregor wrote:
> Tickless was invented by SGI, and the MIPS CPU architecture was designed to run tickless, so it's nearly optimal for the architecture.
> 
> Anyway, it seems to give me about 15% on 11n transactions-per-second.
> 
> 11g is sucking horribly for me at the moment, so I have a little more to do yet.
> 

You have a penchant for understatement. g+n is sucking horribly, worldwide, on 10s of millions of devices."
216,Dave Täht,2011-08-03 13:11:57.134841,"Clients have an obligation to send as much data at a time as they possibly can.

But:

An Access Point has an obligation to be *fair*. Both to newfangled 'n' clients and old fashioned 'g'. If it seriously compromises n performance to be fair to a g client, then so be it. It creates a compelling reason for a user to migrate to pure n. In fact, I have no problem making the 5ghz radio be pure n, and 2.4 being mixed g+n... 

Until that Frabjous day where Wireless-g can be retired, we have to deal with it, and it sounds like the instant a g node is on an n network that the buffer sizes need to drop to like 16 txqueuelen and 8 driver buffers, or some other solution found.

""For a successful technology, reality must take precedence over public relations, for Nature cannot be fooled."" 

You have no idea how much it pains me to recall the circumstances under which Feynman wrote that."
216,David Taht,2011-08-03 13:36:36.979711,"Felix just finished up some new BAR code, and is working on queue limiting.
He says he understands what you've done so far, but I don't.

I'd love to be sitting here, in this hotel room, in a foreign land, testing
stuff out...

... I worry especially that even if tickless works, I worry that it will
break something else. For which I can test.

can you toss together your patches thus far? (I don't care that g sucks
right now, it sounds like felix is on top of that?)...
felix is in germany and although he keeps late hours...."
216,Andrew McGregor,2011-08-03 14:08:50.940824,"Just starting to roll them up.

I got g to suck much less.

Note that although I have not reduced ATH_TXBUF in these, it's still at 512, the driver will only allow 34 packets (plus 5 management frames) to be untransmitted at any one time, which is just enough to generate a couple of aggregates and keep the radio busy and no more.  That's ATH_MAX_QDEPTH.  The other 512-34-5 buffers are there to keep in-window frames around while waiting for link-layer acknowledgements, and do not contribute to queueing delay.  That's enough for 14 full-size aggregates, and might not be enough if there are a lot of clients, so I might suggest setting ATH_MAX_QDEPTH explicitly to a few more than 32 and being done with it, rather than the current (ATH_TXBUF/13 - 5), which I found empirically.

On 3/08/2011, at 1:36 PM, Dave Taht wrote:

> Felix just finished up some new BAR code, and is working on queue limiting. He says he understands what you've done so far, but I don't.
> 
> I'd love to be sitting here, in this hotel room, in a foreign land, testing stuff out...
> 
> ... I worry especially that even if tickless works, I worry that it will break something else. For which I can test.
> 
> can you toss together your patches thus far? (I don't care that g sucks right now, it sounds like felix is on top of that?)...
> felix is in germany and although he keeps late hours....
>"
216,Andrew McGregor,2011-08-03 15:44:40.35161,"Here's what I've been working on.  Note that this includes a version of Felix' patch that changes the interpretation of ATH_MAX_SW_RETRIES, which explains the much higher value; in the old interpretation, this actually would turn it down to around 4.  Seems to give me decent behaviour in BG, BGN and AN modes.  Also note that despite ATH_TX_BUF being 512, the actual number of transmit buffers allowed to be outstanding without a transmission attempt is 34, which is the least you can go to without starting to lose performance due to packet loss (this might be sensitive to experimental setup).  The remainder of the buffers are held post-transmission to allow for retransmits.

General theory: 4ms is too long an aggregate frame, so I've turned it down to 1ms.  6ms is too long to hold up the transmitter for MCS rates, so given that .11n is around 6x as fast as .11g, I've divided all the TX time allowances by 6 if we're working on N transmissions.  There were about 4x as many outstanding transmit buffers as needed, so I found the minimum.

This version also seems not to be sensitive to txqueuelen on a WNDR3700, so I think I've reached the limit of what I can see without routing through it.  Although, I can show that txqueuelen of less than around 40 does hurt performance (even latency, due to causing more TCP retransmissions and therefore having to send more data, as well as causing the radio to go idle as the queue empties from time to time)."
216,David Taht,2011-08-03 18:21:00.756871,"Andrew:

Felix pushed a whole bunch of stuff into openwrt today, that conflicts with
yours. I LIKE very much reducing the 4 to 1 and 6 to 1 ratios overall, but
haven't sorted through your patch yet to figure out the right approach, and
probably am too dumb to do so.

He's just gone to bed.

He didn't like reducing the ratios as it wasn't generic enough for openwrt,
but for me,
going with the best possible options for lowered latency on cerowrt is
best...

so I sat on merging yours and his stuff for the next build. ideas?

lastly, I enabled tickless, and 1000HZ, and didn't know if you went with
server, low latency or desktop pre-emption. I went with server.

Building now. Goin to dinner."
216,David Taht,2011-08-03 18:27:27.093688,"Andrew:

I will review your patch over dinner. I see stuff I like."
216,David Taht,2011-08-03 18:29:11.045674,"and the latest openwrt head failed to biuld...

aggh

/home/andrewm/src/cerowrt/build_dir/linux-ar71xx_generic/compat-wireless-2011-06-22/drivers/net/wireless/ath/ath9k/xmit.c:
In function 'ath_tx_complete_aggr':
/home/andrewm/src/cerowrt/build_dir/linux-ar71xx_generic/compat-wireless-2011-06-22/drivers/net/wireless/ath/ath9k/xmit.c:587:24:
error: 'struct ath_node' has no member named 'vif'
/home/andrewm/src/cerowrt/build_dir/linux-ar71xx_generic/compat-wireless-2011-06-22/drivers/net/wireless/ath/ath9k/xmit.c:
In function 'ath_tx_aggr_stop':


On Wed, Aug 3, 2011 at 7:27 PM, Dave Taht <dave.taht@gmail.com> wrote:

> Andrew:
>
> I will review your patch over dinner. I see stuff I like.
>
>"
51,Dave Täht,2011-08-03 18:39:00.88747,"So far as I know what I'd done got deployed by srikanth. Sri?

Which is not what I'd intended, the web design and reporting system needed to be fleshed out first, in order for the db to meet the reporting and web requirements.

Notably, django needed to be dropped in favor of a toolkit that supported schemas and views - I suggested 3 - for the database to be fast  and clean, scaleable, and replicatable.

"
57,Dave Täht,2011-08-03 18:55:57.078322,"There will be no ""joint"" PR between our projects before the napoli timeframe. 

Cerowrt has plenty of PR of it's own on its own story, and incorporating bismark's story into ours would only confuse people. It's still too hard to describe what Cerowrt is up to in under 40 minutes!

Bismark has some great PR (and the story can be told in under 5 minutes!), but we are targeting two very different market segments with our separate efforts. So, napoli, perhaps, for joint PR, after we iron out the bugs between our organizations and concepts."
216,Dave Täht,2011-08-03 21:54:02.523829,"I'm too wiped out to get openwrt head fixed, the changes to use tickless working, and andrews patch to all play together tonight. Sorry guys. "
216,Dave Täht,2011-08-04 02:08:30.712788,"I'm on my way to california, arriving SFO 10AM. Andrew, if you are available for another mind meld today or tomorrow, I'd appreciate it."
216,Felix Fietkau,2011-08-04 02:27:31.61239,"Yeah, it was missing a small patch chunk. Fixed in r27891

- Felix

On 2011-08-04 3:29 AM, Dave Taht wrote:
> and the latest openwrt head failed to biuld...
>
> aggh
>
> /home/andrewm/src/cerowrt/build_dir/linux-ar71xx_generic/compat-wireless-2011-06-22/drivers/net/wireless/ath/ath9k/xmit.c:
> In function 'ath_tx_complete_aggr':
> /home/andrewm/src/cerowrt/build_dir/linux-ar71xx_generic/compat-wireless-2011-06-22/drivers/net/wireless/ath/ath9k/xmit.c:587:24:
> error: 'struct ath_node' has no member named 'vif'
> /home/andrewm/src/cerowrt/build_dir/linux-ar71xx_generic/compat-wireless-2011-06-22/drivers/net/wireless/ath/ath9k/xmit.c:
> In function 'ath_tx_aggr_stop':"
216,David Taht,2011-08-04 02:57:27.558309,"on my way to cali anyway

On Thu, Aug 4, 2011 at 3:26 AM, Felix Fietkau <nbd@openwrt.org> wrote:

> Yeah, it was missing a small patch chunk. Fixed in r27891
>
> - Felix
>
>
> On 2011-08-04 3:29 AM, Dave Taht wrote:
>
>> and the latest openwrt head failed to biuld...
>>
>> aggh
>>
>> /home/andrewm/src/cerowrt/**build_dir/linux-ar71xx_**
>> generic/compat-wireless-2011-**06-22/drivers/net/wireless/**
>> ath/ath9k/xmit.c:
>> In function 'ath_tx_complete_aggr':
>> /home/andrewm/src/cerowrt/**build_dir/linux-ar71xx_**
>> generic/compat-wireless-2011-**06-22/drivers/net/wireless/**
>> ath/ath9k/xmit.c:587:24:
>> error: 'struct ath_node' has no member named 'vif'
>> /home/andrewm/src/cerowrt/**build_dir/linux-ar71xx_**
>> generic/compat-wireless-2011-**06-22/drivers/net/wireless/**
>> ath/ath9k/xmit.c:
>> In function 'ath_tx_aggr_stop':
>>
>"
216,Dave Täht,2011-08-04 12:18:28.317905,"Alright that build popped out with felix's last commit. Sitting in peets coffee shop in palo alto now, think I want some real food and a saner place to set one up than here.

That said, I DO have the brain cells now (I hope) to look over andrew's patch in relation to nbds....

"
216,David Taht,2011-08-05 10:40:57.199022,"darn it. the huchra.bufferbloat.net/~andrewm build does not have a working
ethernet interface.

sigh... ripping out some stuff, trying again"
216,David Taht,2011-08-05 10:47:55.109857,"it's the ethernet that is toast, the wireless is working...

On Fri, Aug 5, 2011 at 11:40 AM, Dave Taht <dave.taht@gmail.com> wrote:

> darn it. the huchra.bufferbloat.net/~andrewm<http://huchra.bufferbloat.net/%7Eandrewm>build does not have a working ethernet interface.
>
> sigh... ripping out some stuff, trying again
>"
216,Andrew McGregor,2011-08-05 11:39:10.784466,"Ok, this patch applies on top of Felix' last set of changes, and produces really spectacular results: about 2x better latency on 11n than before we both started on it at basically no performance cost, and fairly decent and consistent latency on 11g at a performance cost so small I can't measure it.

It may be worth fiddling a little more with the tunables, but this is pretty good for now."
216,Yuri Bene,2011-08-05 12:15:19.290453,"Andrew McGregor wrote:
> Ok, this patch applies on top of Felix' last set of changes, and produces really spectacular results: about 2x better latency on 11n than before we both started on it at basically no performance cost, and fairly decent and consistent latency on 11g at a performance cost so small I can't measure it.
> 
> It may be worth fiddling a little more with the tunables, but this is pretty good for now.

I experience sluggish and lost pings on my router with ag71xx. Any way to update with your patch to try?"
195,David Taht,2011-08-05 18:47:51.072354,"Just to keep bug tracking..

I pulled from 27917.

I don't see any commits that could have caused this breakage, except maybe
that I'm building against 2.6.39.3, and may have differences in my config
file from yours that are important.

could I encourage you to hop on huchra?

Also I'm curious if YOUR ethernet build showed this:

T
root@OpenWrt:~# dmesg | grep eth0
eth0: Atheros AG71xx at 0xb9000000, irq 4
eth0: unable to find MII bus on device 'rtl8366s'
eth0: Atheros AG71xx at 0xba000000, irq 5
eth0: unable to find MII bus on device 'rtl8366s'

I thought I was building from the same .config as you with support for the
1000hz and no_hz options - the above looks like a faster clock tick problem
to me... but you should have seen that too.

So I can revert to 2.6.39.2, revert all that

and/or restart from scratch from my patch set (Which only touches one tiny
bit of the eth driver and NOTHING of the wireless driver) But with a little
data perhaps that won't be neccessary.

I'll stick around here a while longer, cleaning up, and getting a router
from thursday online...


After I get some sleep.

On Fri, Aug 5, 2011 at 7:00 PM, Andrew McGregor <andrewmcgr@gmail.com>wrote:

> Huh?  I generated it based on openwrt head r27912
>
> On 5/08/2011, at 5:01 PM, Dave Taht wrote:
>
> so this patch duplicates some, but not all, of what is now in openwrt head?
> It only partially applies.
>
> Ripping it out again, and going off to hopefully find the problem in the
> ethernet driver instead....
>
>
> On Fri, Aug 5, 2011 at 4:00 PM, Dave Taht <dave.taht@gmail.com> wrote:
>
>>
>>
>> ---------- Forwarded message ----------
>> From: Andrew McGregor <andrewmcgr@gmail.com>
>> Date: Fri, Aug 5, 2011 at 3:57 PM
>> Subject: Resend of patch
>> To: Dave Taht <dave.taht@gmail.com>
>>
>>
>> Ok, this patch applies on top of Felix' last set of changes, and produces
>> really spectacular results: about 2x better latency on 11n than before we
>> both started on it at basically no performance cost, and fairly decent and
>> consistent latency on 11g at a performance cost so small I can't measure it.
>>
>> It may be worth fiddling a little more with the tunables, but this is
>> pretty good for now.
>>
>> (btw: drop this file in the packages/mac80211 directory)
>>
>>
>>
>>"
216,David Taht,2011-08-05 18:48:55.379787,"Just to keep bug tracking..

I pulled from 27917.

I don't see any commits that could have caused this breakage, except maybe
that I'm building against 2.6.39.3, and may have differences in my config
file from yours that are important.

could I encourage you to hop on huchra?

Also I'm curious if YOUR ethernet build showed this:

T
root@OpenWrt:~# dmesg | grep eth0
eth0: Atheros AG71xx at 0xb9000000, irq 4
eth0: unable to find MII bus on device 'rtl8366s'
eth0: Atheros AG71xx at 0xba000000, irq 5
eth0: unable to find MII bus on device 'rtl8366s'

I thought I was building from the same .config as you with support for the
1000hz and no_hz options - the above looks like a faster clock tick problem
to me... but you should have seen that too.

So I can revert to 2.6.39.2, revert all that

and/or restart from scratch from my patch set (Which only touches one tiny
bit of the eth driver and NOTHING of the wireless driver) But with a little
data perhaps that won't be neccessary.

I'll stick around here a while longer, cleaning up, and getting a router
from thursday online...


After I get some sleep.

On Fri, Aug 5, 2011 at 7:00 PM, Andrew McGregor <andrewmcgr@gmail.com>wrote:

> Huh?  I generated it based on openwrt head r27912
>
> On 5/08/2011, at 5:01 PM, Dave Taht wrote:
>
> so this patch duplicates some, but not all, of what is now in openwrt head?
> It only partially applies.
>
> Ripping it out again, and going off to hopefully find the problem in the
> ethernet driver instead....
>
>
> On Fri, Aug 5, 2011 at 4:00 PM, Dave Taht <dave.taht@gmail.com> wrote:
>
>>
>>
>> ---------- Forwarded message ----------
>> From: Andrew McGregor <andrewmcgr@gmail.com>
>> Date: Fri, Aug 5, 2011 at 3:57 PM
>> Subject: Resend of patch
>> To: Dave Taht <dave.taht@gmail.com>
>>
>>
>> Ok, this patch applies on top of Felix' last set of changes, and produces
>> really spectacular results: about 2x better latency on 11n than before we
>> both started on it at basically no performance cost, and fairly decent and
>> consistent latency on 11g at a performance cost so small I can't measure it.
>>
>> It may be worth fiddling a little more with the tunables, but this is
>> pretty good for now.
>>
>> (btw: drop this file in the packages/mac80211 directory)
>>
>>
>>
>>"
195,David Taht,2011-08-06 18:40:03.956416,"Felix told me that your patch had 1/3 stuff he'd done already.

---------- Forwarded message ----------
From: Andrew McGregor <andrewmcgr@gmail.com>
Date: Fri, Aug 5, 2011 at 8:59 PM
Subject: Re: Resend of patch
To: Dave Taht <dave.taht@gmail.com>


I don't know if ethernet was working, I never checked.

I was using 2.6.39.2 however, so I suspect an upstream change is causing the
patch to not apply.  It's not big, you could put it in by hand easily
enough.  The last chunk you could also change the other case in that if
statement to something smaller, although that won't happen on a WNDR3700

About to get on a plane to NZ, so I'll be out of circulation for around 36
hours.

On 5/08/2011, at 6:25 PM, Dave Taht wrote:

I pulled from 27917.

I don't see any commits that could have caused this breakage, except maybe
that I'm building against 2.6.39.3, and may have differences in my config
file from yours that are important.

could I encourage you to hop on huchra?

Also I'm curious if YOUR ethernet build showed this:

T
root@OpenWrt:~# dmesg | grep eth0
eth0: Atheros AG71xx at 0xb9000000, irq 4
eth0: unable to find MII bus on device 'rtl8366s'
eth0: Atheros AG71xx at 0xba000000, irq 5
eth0: unable to find MII bus on device 'rtl8366s'

I thought I was building from the same .config as you with support for the
1000hz and no_hz options - the above looks like a faster clock tick problem
to me... but you should have seen that too.

So I can revert to 2.6.39.2, revert all that

and/or restart from scratch from my patch set (Which only touches one tiny
bit of the eth driver and NOTHING of the wireless driver) But with a little
data perhaps that won't be neccessary.

I'll stick around here a while longer, cleaning up, and getting a router
from thursday online...


After I get some sleep.
On Fri, Aug 5, 2011 at 7:00 PM, Andrew McGregor <andrewmcgr@gmail.com>wrote:

> Huh?  I generated it based on openwrt head r27912
>
> On 5/08/2011, at 5:01 PM, Dave Taht wrote:
>
> so this patch duplicates some, but not all, of what is now in openwrt head?
> It only partially applies.
>
> Ripping it out again, and going off to hopefully find the problem in the
> ethernet driver instead....
>
>
> On Fri, Aug 5, 2011 at 4:00 PM, Dave Taht <dave.taht@gmail.com> wrote:
>
>>
>>
>> ---------- Forwarded message ----------
>> From: Andrew McGregor <andrewmcgr@gmail.com>
>> Date: Fri, Aug 5, 2011 at 3:57 PM
>> Subject: Resend of patch
>> To: Dave Taht <dave.taht@gmail.com>
>>
>>
>> Ok, this patch applies on top of Felix' last set of changes, and produces
>> really spectacular results: about 2x better latency on 11n than before we
>> both started on it at basically no performance cost, and fairly decent and
>> consistent latency on 11g at a performance cost so small I can't measure it.
>>
>> It may be worth fiddling a little more with the tunables, but this is
>> pretty good for now.
>>
>> (btw: drop this file in the packages/mac80211 directory)
>>
>>
>>
>>"
216,David Taht,2011-08-06 20:46:51.24832,"---------- Forwarded message ----------
From: Dave Taht <dave.taht@gmail.com>
Date: Sat, Aug 6, 2011 at 9:45 PM
Subject: Fwd: Resend of patch [#1216]
To: cerowrt@lists.bufferbloat.net




---------- Forwarded message ----------
From: Andrew McGregor <andrewmcgr@gmail.com>
Date: Sat, Aug 6, 2011 at 8:24 PM
Subject: Re: Resend of patch [#195]
To: Dave Taht <dave.taht@gmail.com>


Oooops... Ok, I was patching the wrong thing.  I'll need to retest this, but
this patch should at least apply:



On 7/08/2011, at 2:20 PM, Dave Taht wrote:

incidentally, I work primarily out of nbd's git trees, I find that's a lot
easier than svn.

The attached file is OUT OF DATE, but does point to git trees for everything
important...



On Sat, Aug 6, 2011 at 8:06 PM, Dave Taht <dave.taht@gmail.com> wrote:

> trick:
>
> make package/mac80211/{clean,compile,install} V=99
>
>
> On Sat, Aug 6, 2011 at 8:05 PM, Andrew McGregor <andrewmcgr@gmail.com>wrote:
>
>> So, I'm going to take a quick look at that
>>
>> On 7/08/2011, at 2:00 PM, Dave Taht wrote:
>>
>> Please note, normally I have enough brain cells to cope with stuff like
>> this, but was terribly burned out, and am only now beginning to feel halfway
>> normal - with at least 2 more hot tub sessions left in the day.
>>
>> and have 22 other bugs on my plate...
>>
>> that said, I shoulda locked you in the loft until after this compiled...
>> :)
>>
>>
>> Applying ./patches/580-ath9k_lowlatency.patch using plaintext:
>> patching file net/mac80211/rc80211_minstrel_ht.c
>> Hunk #1 FAILED at 487.
>> 1 out of 1 hunk FAILED -- saving rejects to file
>> net/mac80211/rc80211_minstrel_ht.c.rej
>> patching file drivers/net/wireless/ath/ath9k/ath9k.h
>> Hunk #1 succeeded at 120 with fuzz 2 (offset -4 lines).
>> Hunk #2 FAILED at 529.
>> 1 out of 2 hunks FAILED -- saving rejects to file
>> drivers/net/wireless/ath/ath9k/ath9k.h.rej
>> patching file drivers/net/wireless/ath/ath9k/xmit.c
>> Hunk #1 FAILED at 247.
>> Hunk #2 FAILED at 357.
>> Hunk #3 succeeded at 384 with fuzz 2 (offset 19 lines).
>> Hunk #4 FAILED at 447.
>> Hunk #5 succeeded at 650 (offset 22 lines).
>> 3 out of 5 hunks FAILED -- saving rejects to file
>> drivers/net/wireless/ath/ath9k/xmit.c.rej
>> Patch failed!  Please fix ./patches/580-ath9k_lowlatency.patch!
>> make[2]: ***
>> [/home/andrewm/src/cerowrt/build_dir/linux-ar71xx_generic/compat-wireless-2011-06-22/.prepared_cc7790f9a6fba8b991c06bfd7f50721f]
>> Error 1
>> make[2]: Leaving directory `/home/andrewm/src/cerowrt/package/mac80211'
>> make[1]: *** [package/mac80211/compile] Error 2
>> make[1]: Leaving directory `/home/andrewm/src/cerowrt'
>> make: *** [package/mac80211/compile] Error 2
>>
>>
>> On Sat, Aug 6, 2011 at 7:54 PM, Dave Taht <dave.taht@gmail.com> wrote:
>>
>>> Hey, welcome to the ground! Or are you still in the air?
>>>
>>> I wish I could take a picture of where I am - listening to live music, in
>>> a campground, with my super duper SR71 antennas up, eating BBQ, watching two
>>> girls from santa cruz dance.
>>>
>>> Sometimes I REALLY like wireless technology.
>>>
>>> No, it was this patch that broke, I can send you the stuff on it in a
>>> minute.
>>>
>>> More importantly figuring out what broke ethernet is on my mind...
>>>
>>>
>>>
>>>
>>> On Sat, Aug 6, 2011 at 7:50 PM, Andrew McGregor <andrewmcgr@gmail.com>wrote:
>>>
>>>>  Which one?  The newest one, or the previous?  That was true of the
>>>> previous one, in the strange diff format.  The one I just attached again is
>>>> not, so far as I know.
>>>>
>>>>
>>>>
>>>>
>>>> On 7/08/2011, at 1:40 PM, Dave Taht wrote:
>>>>
>>>> Felix told me that your patch had 1/3 stuff he'd done already.
>>>>
>>>> ---------- Forwarded message ----------
>>>> From: Andrew McGregor <andrewmcgr@gmail.com>
>>>> Date: Fri, Aug 5, 2011 at 8:59 PM
>>>> Subject: Re: Resend of patch
>>>> To: Dave Taht <dave.taht@gmail.com>
>>>>
>>>>
>>>> I don't know if ethernet was working, I never checked.
>>>>
>>>> I was using 2.6.39.2 however, so I suspect an upstream change is causing
>>>> the patch to not apply.  It's not big, you could put it in by hand easily
>>>> enough.  The last chunk you could also change the other case in that if
>>>> statement to something smaller, although that won't happen on a WNDR3700
>>>>
>>>> About to get on a plane to NZ, so I'll be out of circulation for around
>>>> 36 hours.
>>>>
>>>> On 5/08/2011, at 6:25 PM, Dave Taht wrote:
>>>>
>>>> I pulled from 27917.
>>>>
>>>> I don't see any commits that could have caused this breakage, except
>>>> maybe that I'm building against 2.6.39.3, and may have differences in my
>>>> config file from yours that are important.
>>>>
>>>> could I encourage you to hop on huchra?
>>>>
>>>> Also I'm curious if YOUR ethernet build showed this:
>>>>
>>>> T
>>>> root@OpenWrt:~# dmesg | grep eth0
>>>> eth0: Atheros AG71xx at 0xb9000000, irq 4
>>>> eth0: unable to find MII bus on device 'rtl8366s'
>>>> eth0: Atheros AG71xx at 0xba000000, irq 5
>>>> eth0: unable to find MII bus on device 'rtl8366s'
>>>>
>>>> I thought I was building from the same .config as you with support for
>>>> the 1000hz and no_hz options - the above looks like a faster clock tick
>>>> problem to me... but you should have seen that too.
>>>>
>>>> So I can revert to 2.6.39.2, revert all that
>>>>
>>>> and/or restart from scratch from my patch set (Which only touches one
>>>> tiny bit of the eth driver and NOTHING of the wireless driver) But with a
>>>> little data perhaps that won't be neccessary.
>>>>
>>>> I'll stick around here a while longer, cleaning up, and getting a router
>>>> from thursday online...
>>>>
>>>>
>>>> After I get some sleep.
>>>> On Fri, Aug 5, 2011 at 7:00 PM, Andrew McGregor <andrewmcgr@gmail.com>wrote:
>>>>
>>>>> Huh?  I generated it based on openwrt head r27912
>>>>>
>>>>> On 5/08/2011, at 5:01 PM, Dave Taht wrote:
>>>>>
>>>>> so this patch duplicates some, but not all, of what is now in openwrt
>>>>> head? It only partially applies.
>>>>>
>>>>> Ripping it out again, and going off to hopefully find the problem in
>>>>> the ethernet driver instead....
>>>>>
>>>>>
>>>>> On Fri, Aug 5, 2011 at 4:00 PM, Dave Taht <dave.taht@gmail.com> wrote:
>>>>>
>>>>>>
>>>>>>
>>>>>> ---------- Forwarded message ----------
>>>>>> From: Andrew McGregor <andrewmcgr@gmail.com>
>>>>>> Date: Fri, Aug 5, 2011 at 3:57 PM
>>>>>> Subject: Resend of patch
>>>>>> To: Dave Taht <dave.taht@gmail.com>
>>>>>>
>>>>>>
>>>>>> Ok, this patch applies on top of Felix' last set of changes, and
>>>>>> produces really spectacular results: about 2x better latency on 11n than
>>>>>> before we both started on it at basically no performance cost, and fairly
>>>>>> decent and consistent latency on 11g at a performance cost so small I can't
>>>>>> measure it.
>>>>>>
>>>>>> It may be worth fiddling a little more with the tunables, but this is
>>>>>> pretty good for now.
>>>>>>
>>>>>> (btw: drop this file in the packages/mac80211 directory)
>>>>>>
>>>>>>
>>>>>>
>>>>>>"
216,Dave Täht,2011-08-06 20:47:46.696576,""
195,David Taht,2011-08-06 23:33:17.917866,"I would really like it if someone from a different time zone and sleeping
schedule
were to download the latest wndr3700v2 development build from here:

http://huchra.bufferbloat.net/~andrewm/cerowrt/

I hope this build finishes up the last of the truly epic adventure that has
taken place on bug:

http://www.bufferbloat.net/issues/216

If it works, do play with netperf 2.5.0 on the wireless interface.

I note that the fixes to #195 seem to have (maybe) messed up the ethernet
interface - or the change to a faster clock or tickless or 2.6.39.3 vs
.2.... OR It may be the router I have on me!

So let us know on this email (bug reporting interface is cc'd)

That's all the news from tent #34. Good night, and good luck."
216,Dave Täht,2011-08-08 20:19:19.327791,"I finally have enough of the lab setup at ISC to start bisecting the ethernet issue introduced by increasing the clock, changing the kernel version, and going tickless.

More news will be on #195

"
195,Dave Täht,2011-08-08 20:22:50.354186,"# The unrecognisable ethernet port problem exists on more than one router, so it wasn't my hardware, as I hoped
# For my next series of tests, I am first reducing the clock to 100HZ, and staying tickless. My best guess as to the source of this problem is something hard coded in the init routine for the phy.

I shan't document what I'll do next as it's pretty obvious the bisecting I'd need to do, nor, do I know, what the real effect of a 1000HZ vs 100HZ clock is on a tickless system, anymore.

"
195,Dave Täht,2011-08-08 21:25:28.873897,"I so love it when I guess right.

100HZ clock + tickless + 2.6.39.3... just works.

I have a backlog of other patches that needed to land and a ton of src to clean up, but we're back in business."
216,Dave Täht,2011-08-09 11:06:30.865442,"To paraphrase ESR:

""With the right eyeballs, all bugs are shallow."""
195,Dave Täht,2011-08-09 11:08:11.857133,"OK, so the ethernet seems a great deal faster than it was, and I will start doing comprehensive testing vs the factory firmware by the weekend.

""With the right eyeballs, all bugs are shallow""

"
216,John Linville,2011-08-09 11:32:20.923041,Is this going to result in a patch being posted upstream?
216,Dave Täht,2011-08-10 11:39:52.28962,"@John:

After I get it fully tested in the lab, absolutely, it's going upstream. So far as I know there are other problems with merging this upstream in that some of this code is merged under a different name?

Assembling the lab now. Ping me on irc if you want to chat further."
216,David Taht,2011-08-10 21:55:20.315693,"I note that txqueuelen of X is ok, when the station is in N mode.

It's when it's in G mode that this introduces tons more latency.

Perhaps a closer look at the mq qdisc is in order.

And I note that testing chrome appears to be in order.

---------- Forwarded message ----------
From: Andrew McGregor <andrewmcgr@gmail.com>
Date: Tue, Aug 9, 2011 at 11:48 PM
Subject: Re: Resend of patch [#195]
To: Dave Taht <dave.taht@gmail.com>


So, I kicked my txqueuelen up on the wireless interfaces to 100; I was
dropping too many packets coming back at me (mostly from Google sites
browsing with Chrome, so I presume the problem has to do with IW 10 on the
servers and SPDY in Chrome...)

On 10/08/2011, at 2:50 AM, Dave Taht wrote:

Excellent.

Can't convince ya to try cerowrt? :/

I am still not certain if my build ended up the same as yours.

On Tue, Aug 9, 2011 at 3:28 AM, Andrew McGregor <andrewmcgr@gmail.com>wrote:

> So, yes, I did read the book... interesting read.
>
> I've now put one of the new WNDR3700v2s into my home network, and put my
> openwrt build on it... and it rocks.  minstrel-ht with the recent tweaks
> really performs well.
>
> On 7/08/2011, at 2:31 PM, Dave Taht wrote:
>
> correction: did the tests with friday's build, with just nbd's patches,
> tickless, 1000hz, wirelessly, and nothing went boom. But losing ethernet is
> something of a problem. :)
>
> did you have a chance to read the book? I read scalzi... thx... I needed
> that.
>
> On Sat, Aug 6, 2011 at 8:29 PM, Dave Taht <dave.taht@gmail.com> wrote:
>
>> I also really wanted to know what your kernel config was, exactly, so I
>> can make sure the crazy-ass change to 1000HZ ticks and tickless was the
>> same. I set it up for server mode, rather than low latency desktop, and I do
>> think that proxies and otherstuff in user space might benefit more from even
>> lower latency....
>>
>> and I'm pretty sure at this point, that change is what is breaking
>> ag71xx's mdi serial probe for both of us, but, lacking data to confirm that,
>> it could be the kernel upgrade, or something else entirely.
>>
>> Aside from that problem, I ran the router through a boatload of tests with
>> thursday's build, and it held up.
>>
>>
>> On Sat, Aug 6, 2011 at 8:27 PM, Dave Taht <dave.taht@gmail.com> wrote:
>>
>>> Or, I'll do it... but... jeeze... reading over your patch now, by the
>>> time I'm done I could be downloading a build... :)
>>>
>>> root@huchra:~# write andrewm
>>> write: warning: write will appear from d
>>> yer on huchra
>>> slam it in the right dir
>>> and do a build
>>> batch
>>> make -j 8
>>> make
>>> CNTRL-D
>>>
>>> On Sat, Aug 6, 2011 at 8:24 PM, Andrew McGregor <andrewmcgr@gmail.com>wrote:
>>>
>>>> Oooops... Ok, I was patching the wrong thing.  I'll need to retest this,
>>>> but this patch should at least apply:
>>>>
>>>>
>>>>
>>>> On 7/08/2011, at 2:20 PM, Dave Taht wrote:
>>>>
>>>> incidentally, I work primarily out of nbd's git trees, I find that's a
>>>> lot easier than svn.
>>>>
>>>> The attached file is OUT OF DATE, but does point to git trees for
>>>> everything important...
>>>>
>>>>
>>>>
>>>> On Sat, Aug 6, 2011 at 8:06 PM, Dave Taht <dave.taht@gmail.com> wrote:
>>>>
>>>>> trick:
>>>>>
>>>>> make package/mac80211/{clean,compile,install} V=99
>>>>>
>>>>>
>>>>> On Sat, Aug 6, 2011 at 8:05 PM, Andrew McGregor <andrewmcgr@gmail.com>wrote:
>>>>>
>>>>>> So, I'm going to take a quick look at that
>>>>>>
>>>>>> On 7/08/2011, at 2:00 PM, Dave Taht wrote:
>>>>>>
>>>>>> Please note, normally I have enough brain cells to cope with stuff
>>>>>> like this, but was terribly burned out, and am only now beginning to feel
>>>>>> halfway normal - with at least 2 more hot tub sessions left in the day.
>>>>>>
>>>>>> and have 22 other bugs on my plate...
>>>>>>
>>>>>> that said, I shoulda locked you in the loft until after this
>>>>>> compiled... :)
>>>>>>
>>>>>>
>>>>>> Applying ./patches/580-ath9k_lowlatency.patch using plaintext:
>>>>>> patching file net/mac80211/rc80211_minstrel_ht.c
>>>>>> Hunk #1 FAILED at 487.
>>>>>> 1 out of 1 hunk FAILED -- saving rejects to file
>>>>>> net/mac80211/rc80211_minstrel_ht.c.rej
>>>>>> patching file drivers/net/wireless/ath/ath9k/ath9k.h
>>>>>> Hunk #1 succeeded at 120 with fuzz 2 (offset -4 lines).
>>>>>> Hunk #2 FAILED at 529.
>>>>>> 1 out of 2 hunks FAILED -- saving rejects to file
>>>>>> drivers/net/wireless/ath/ath9k/ath9k.h.rej
>>>>>> patching file drivers/net/wireless/ath/ath9k/xmit.c
>>>>>> Hunk #1 FAILED at 247.
>>>>>> Hunk #2 FAILED at 357.
>>>>>> Hunk #3 succeeded at 384 with fuzz 2 (offset 19 lines).
>>>>>> Hunk #4 FAILED at 447.
>>>>>> Hunk #5 succeeded at 650 (offset 22 lines).
>>>>>> 3 out of 5 hunks FAILED -- saving rejects to file
>>>>>> drivers/net/wireless/ath/ath9k/xmit.c.rej
>>>>>> Patch failed!  Please fix ./patches/580-ath9k_lowlatency.patch!
>>>>>> make[2]: ***
>>>>>> [/home/andrewm/src/cerowrt/build_dir/linux-ar71xx_generic/compat-wireless-2011-06-22/.prepared_cc7790f9a6fba8b991c06bfd7f50721f]
>>>>>> Error 1
>>>>>> make[2]: Leaving directory
>>>>>> `/home/andrewm/src/cerowrt/package/mac80211'
>>>>>> make[1]: *** [package/mac80211/compile] Error 2
>>>>>> make[1]: Leaving directory `/home/andrewm/src/cerowrt'
>>>>>> make: *** [package/mac80211/compile] Error 2
>>>>>>
>>>>>>
>>>>>> On Sat, Aug 6, 2011 at 7:54 PM, Dave Taht <dave.taht@gmail.com>wrote:
>>>>>>
>>>>>>> Hey, welcome to the ground! Or are you still in the air?
>>>>>>>
>>>>>>> I wish I could take a picture of where I am - listening to live
>>>>>>> music, in a campground, with my super duper SR71 antennas up, eating BBQ,
>>>>>>> watching two girls from santa cruz dance.
>>>>>>>
>>>>>>> Sometimes I REALLY like wireless technology.
>>>>>>>
>>>>>>> No, it was this patch that broke, I can send you the stuff on it in a
>>>>>>> minute.
>>>>>>>
>>>>>>> More importantly figuring out what broke ethernet is on my mind...
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>> On Sat, Aug 6, 2011 at 7:50 PM, Andrew McGregor <
>>>>>>> andrewmcgr@gmail.com> wrote:
>>>>>>>
>>>>>>>>  Which one?  The newest one, or the previous?  That was true of the
>>>>>>>> previous one, in the strange diff format.  The one I just attached again is
>>>>>>>> not, so far as I know.
>>>>>>>>
>>>>>>>>
>>>>>>>>
>>>>>>>>
>>>>>>>> On 7/08/2011, at 1:40 PM, Dave Taht wrote:
>>>>>>>>
>>>>>>>> Felix told me that your patch had 1/3 stuff he'd done already.
>>>>>>>>
>>>>>>>> ---------- Forwarded message ----------
>>>>>>>> From: Andrew McGregor <andrewmcgr@gmail.com>
>>>>>>>> Date: Fri, Aug 5, 2011 at 8:59 PM
>>>>>>>> Subject: Re: Resend of patch
>>>>>>>> To: Dave Taht <dave.taht@gmail.com>
>>>>>>>>
>>>>>>>>
>>>>>>>> I don't know if ethernet was working, I never checked.
>>>>>>>>
>>>>>>>> I was using 2.6.39.2 however, so I suspect an upstream change is
>>>>>>>> causing the patch to not apply.  It's not big, you could put it in by hand
>>>>>>>> easily enough.  The last chunk you could also change the other case in that
>>>>>>>> if statement to something smaller, although that won't happen on a WNDR3700
>>>>>>>>
>>>>>>>> About to get on a plane to NZ, so I'll be out of circulation for
>>>>>>>> around 36 hours.
>>>>>>>>
>>>>>>>> On 5/08/2011, at 6:25 PM, Dave Taht wrote:
>>>>>>>>
>>>>>>>> I pulled from 27917.
>>>>>>>>
>>>>>>>> I don't see any commits that could have caused this breakage, except
>>>>>>>> maybe that I'm building against 2.6.39.3, and may have differences in my
>>>>>>>> config file from yours that are important.
>>>>>>>>
>>>>>>>> could I encourage you to hop on huchra?
>>>>>>>>
>>>>>>>> Also I'm curious if YOUR ethernet build showed this:
>>>>>>>>
>>>>>>>> T
>>>>>>>> root@OpenWrt:~# dmesg | grep eth0
>>>>>>>> eth0: Atheros AG71xx at 0xb9000000, irq 4
>>>>>>>> eth0: unable to find MII bus on device 'rtl8366s'
>>>>>>>> eth0: Atheros AG71xx at 0xba000000, irq 5
>>>>>>>> eth0: unable to find MII bus on device 'rtl8366s'
>>>>>>>>
>>>>>>>> I thought I was building from the same .config as you with support
>>>>>>>> for the 1000hz and no_hz options - the above looks like a faster clock tick
>>>>>>>> problem to me... but you should have seen that too.
>>>>>>>>
>>>>>>>> So I can revert to 2.6.39.2, revert all that
>>>>>>>>
>>>>>>>> and/or restart from scratch from my patch set (Which only touches
>>>>>>>> one tiny bit of the eth driver and NOTHING of the wireless driver) But with
>>>>>>>> a little data perhaps that won't be neccessary.
>>>>>>>>
>>>>>>>> I'll stick around here a while longer, cleaning up, and getting a
>>>>>>>> router from thursday online...
>>>>>>>>
>>>>>>>>
>>>>>>>> After I get some sleep.
>>>>>>>> On Fri, Aug 5, 2011 at 7:00 PM, Andrew McGregor <
>>>>>>>> andrewmcgr@gmail.com> wrote:
>>>>>>>>
>>>>>>>>> Huh?  I generated it based on openwrt head r27912
>>>>>>>>>
>>>>>>>>> On 5/08/2011, at 5:01 PM, Dave Taht wrote:
>>>>>>>>>
>>>>>>>>> so this patch duplicates some, but not all, of what is now in
>>>>>>>>> openwrt head? It only partially applies.
>>>>>>>>>
>>>>>>>>> Ripping it out again, and going off to hopefully find the problem
>>>>>>>>> in the ethernet driver instead....
>>>>>>>>>
>>>>>>>>>
>>>>>>>>> On Fri, Aug 5, 2011 at 4:00 PM, Dave Taht <dave.taht@gmail.com>wrote:
>>>>>>>>>
>>>>>>>>>>
>>>>>>>>>>
>>>>>>>>>> ---------- Forwarded message ----------
>>>>>>>>>> From: Andrew McGregor <andrewmcgr@gmail.com>
>>>>>>>>>> Date: Fri, Aug 5, 2011 at 3:57 PM
>>>>>>>>>> Subject: Resend of patch
>>>>>>>>>> To: Dave Taht <dave.taht@gmail.com>
>>>>>>>>>>
>>>>>>>>>>
>>>>>>>>>> Ok, this patch applies on top of Felix' last set of changes, and
>>>>>>>>>> produces really spectacular results: about 2x better latency on 11n than
>>>>>>>>>> before we both started on it at basically no performance cost, and fairly
>>>>>>>>>> decent and consistent latency on 11g at a performance cost so small I can't
>>>>>>>>>> measure it.
>>>>>>>>>>
>>>>>>>>>> It may be worth fiddling a little more with the tunables, but this
>>>>>>>>>> is pretty good for now.
>>>>>>>>>>
>>>>>>>>>> (btw: drop this file in the packages/mac80211 directory)
>>>>>>>>>>
>>>>>>>>>>
>>>>>>>>>>
>>>>>>>>>>"
204,Dave Täht,2011-08-11 11:37:08.448515,"Part 1 of this - getting xinetd to run with the oom killer disabled... is done.

Part 2 is to get more stuff into inetd."
204,Dave Täht,2011-08-11 11:38:51.566506,"root@sinope:/proc# ps | grep xinetd
 3078 root      1208 S    xinetd
 3675 root      1640 S    grep xinetd
root@sinope:/proc# cd 3078/
root@sinope:/proc/3078# ls
auxv           exe            mem            oom_adj        stat
cmdline        fd             mountinfo      oom_score      statm
comm           fdinfo         mounts         oom_score_adj  status
cwd            limits         mountstats     personality    task
environ        maps           net            root           wchan
root@sinope:/proc/3078# cat oom_score_adj 
-1000
"
207,Dave Täht,2011-08-11 11:41:59.119504,"I'm going to write this one off as a problem elsewhere in the system.

Can't duplicate. Reverted back to the old dns method."
220,Dave Täht,2011-08-11 11:42:55.772684,I patched the kernel (1 line patch) to make tcp_low_latency the default
224,Dave Täht,2011-08-11 11:44:07.508219,"steve got dnssec-tools ported and they are in the rc5 build. Yea! What are they good for, again?"
121,Dave Täht,2011-08-11 11:44:43.867681,""
201,Dave Täht,2011-08-11 11:47:16.969972,"The ahcp package has been made manageable via the command line, so we're back in business for multiple interfaces for cerowrt 1.0. tested in the lab today. That said, coaxing the gui back in shape would be good for the next release."
204,Dave Täht,2011-08-11 22:05:38.820656,"Actually, the fix I put in place makes the parent process -1000, which is what we want.

But no matter what I try, it also makes all the child processes -1000.

Ripped patch out of build."
219,Dave Täht,2011-08-11 22:06:26.977631,"dropbear now runs out of inetd.

Also, sensors are configured on telnet and ftp attempts to the router."
186,Dave Täht,2011-08-11 23:19:23.633994,"Well, I'll carry this patch forward if I have to."
195,Yuri Bene,2011-08-12 11:08:18.975779,"Dave Täht wrote:
> OK, so the ethernet seems a great deal faster than it was, and I will start doing comprehensive testing vs the factory firmware by the weekend.

Is there an OpenWRT build containing the patch that I can try?"
224,Evan Hunt,2011-08-14 09:10:32.88789,"There's a bunch of stuff in dnssec-tools (some of which, AIUI, duplicates functionality already available in BIND 9).

The only bit I was interested in was libval, which has DNSSEC-validating versions of the get*by*() and get*info() functions.  https://www.dnssec-tools.org/wiki/index.php/Libval_and_libsres"
216,Jim Gettys,2011-08-14 09:28:38.617221,"David Taht wrote:
> I note that txqueuelen of X is ok, when the station is in N mode.
> 
> It's when it's in G mode that this introduces tons more latency.
> 
> Perhaps a closer look at the mq qdisc is in order.
> 
> And I note that testing chrome appears to be in order.
> 
> ---------- Forwarded message ----------
> From: Andrew McGregor <andrewmcgr@gmail.com>
> Date: Tue, Aug 9, 2011 at 11:48 PM
> Subject: Re: Resend of patch [#195]
> To: Dave Taht <dave.taht@gmail.com>
> 
> 
> So, I kicked my txqueuelen up on the wireless interfaces to 100; I was
> dropping too many packets coming back at me (mostly from Google sites
> browsing with Chrome, so I presume the problem has to do with IW 10 on the
> servers and SPDY in Chrome...)
> 
> 

Yes, this sounds like the insane IW 10 change.

I've just written that part of the bufferbloat paper, which writes the consequences of this change up into a decent form.  I should finally be posting it this week; will probably post to both the tcp changes wg and the HTTP wg..  Scott Bradner was kind enough to give me some feedback on that draft.

Would be nice to confirm this, of course, but it's about the amount of buffering use you get from first principles, so it seems likely.  The real disaster is when your output link happens to be going really slowly, of course...



"
224,Dave Täht,2011-08-16 15:21:01.338135,what I want is the NON dnssec validating versions of those functions! Not in there?
224,Evan Hunt,2011-08-16 15:45:34.340155,"Dave Täht wrote:
> what I want is the NON dnssec validating versions of those functions! Not in there?

No, what you want is the validating version.

The standard getaddrinfo() simply asks the resolver for an address.  The resolver attempts to validate the data, fails, and returns SERVFAIL; you get nothing.

The validating version (I believe it's called val_getaddrinfo()) takes responsibility for validation by itself.  It asks the resolver to provide the address data and associated DNSSEC data, warts and all, without validating it.  (In other words it sets the CD bit on  the query.)  Then it does its own validation.  What you get is the data requested, plus information about its validity, so you can decide for yourself whether to use the information or not.

Honestly, what you *really* want is a simple flag to getaddrinfo() to set the CD bit.  But val_getaddrinfo() is one way to get there without having to muck with glibc or whatever library getaddrinfo() lives in."
224,Dave Täht,2011-08-16 16:24:18.324646,"Well, getting this right is on my list for RC6 or RC7. But I'm buried at a conference all week."
113,Evan Hunt,2011-08-16 22:20:39.074971,"I've just had a serious headdesk moment.  There's a feature in rndc that I have somehow managed to go multiple years without ever noticing:

<pre>
rndc validation off
ntpd
sleep 1
rndc validation on
</pre>

Problem solved.

(Is that how you were already doing it?  I had the impression you were modifying the config file and running ""rndc reconfig"", which is obviously much more cumbersome than this method.)"
228,Jim Gettys,2011-08-17 06:51:49.478033,"Or we buy a cert up front for cerowrt (gw.home.lan) and throw it away after the password is set.  All we care about here is that the password changing be done on an encrypted channel.
"
229,Jim Gettys,2011-08-17 06:53:13.200048,"Is this script in the build?  Is it documented?  For people to put a router into service for real, they had better not have to renumber their networks; it's easier to fix a single router.
"
230,Dave Täht,2011-08-17 14:18:56.496864,nice catch. Used to work. Does vim still work?
230,Dave Täht,2011-08-17 14:19:09.775005,"you did an opkg update first?
"
230,Jim Gettys,2011-08-17 14:47:52.564867,"I think I did an update first, but it's hard to remember.

Sort of seems to me that the first time one ever uses opkg, it should just do an update to begin with...  I don't believe in causing it to be the user's bug...
"
231,Michael Graff,2011-08-18 00:21:09.685242,"Additional info. I reflashed and wiped configuration again. I managed to delete gw01 gw11 and ge01. I reinstalled the hurricane tunnel and put an unique /64 on each of gw00 gw10 se00 sw00 and sw10. 

Everything worked including from my phone. 

After using it for an hour or so, I started getting errors saying my net was broken. It came back briefly but now once again I cannot get a lease. 

This is somewhat reproducible at least...

I plan to take the box into ISC tomorrow to see if a clean network will help. 

--Michael (from an iPhone)


On Aug 17, 2011, at 20:25, cerowrt@lists.bufferbloat.net wrote:

> 
> Issue #231 has been reported by Michael Graff.
> 
> ----------------------------------------
> Bug #231: Identically configured wireless does not hand out DHCP leases
> https://www.bufferbloat.net/issues/231
> 
> Author: Michael Graff
> Status: New
> Priority: Normal
> Assignee: 
> Category: 
> Target version: 
> 
> 
> I have IPv4 and IPv6 configured for all of the sw00, se10, gw00, and gw10 interfaces.  The 2.4 Ghz public interface does not hand out IPv4 addresses to any clients.  The 2.4 Ghz closed network does not hand out DHCP leases to my iPhone but WILL to my Mac laptop.  The 5 Ghz hands out addresses to my mac.  (iPhone cannot speak 5 Ghz.)
> 
> Here is a packet capture from the 2.4 closed interface:
> 
> 02:51:06.559420 IP 0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 90:27:e4:52:d3:da, length 300
>    0x0000:  4500 0148 09f4 0000 ff11 b0b1 0000 0000  E..H............
>    0x0010:  ffff ffff 0044 0043 0134 bc2e 0101 0600  .....D.C.4......
>    0x0020:  ae23 3a30 003c 0000 0000 0000 0000 0000  .#:0.<..........
>    0x0030:  0000 0000 0000 0000 9027 e452 d3da 0000  .........'.R....
>    0x0040:  0000 0000 0000 0000 0000 0000 0000 0000  ................
>    0x0050:  0000 0000 0000 0000 0000 0000 0000 0000  ................
>    0x0060:  0000 0000 0000 0000 0000 0000 0000 0000  ................
>    0x0070:  0000 0000 0000 0000 0000 0000 0000 0000  ................
>    0x0080:  0000 0000 0000 0000 0000 0000 0000 0000  ................
>    0x0090:  0000 0000 0000 0000 0000 0000 0000 0000  ................
>    0x00a0:  0000 0000 0000 0000 0000 0000 0000 0000  ................
>    0x00b0:  0000 0000 0000 0000 0000 0000 0000 0000  ................
>    0x00c0:  0000 0000 0000 0000 0000 0000 0000 0000  ................
>    0x00d0:  0000 0000 0000 0000 0000 0000 0000 0000  ................
>    0x00e0:  0000 0000 0000 0000 0000 0000 0000 0000  ................
>    0x00f0:  0000 0000 0000 0000 0000 0000 0000 0000  ................
>    0x0100:  0000 0000 0000 0000 6382 5363 3501 0137  ........c.Sc5..7
>    0x0110:  0601 0306 0f77 fc39 0205 dc3d 0701 9027  .....w.9...=...'
>    0x0120:  e452 d3da 3304 0076 a700 ff00 0000 0000  .R..3..v........
>    0x0130:  0000 0000 0000 0000 0000 0000 0000 0000  ................
>    0x0140:  0000 0000 0000 0000                      ........
> 
> 
> 
>"
234,Dave Täht,2011-08-19 11:37:51.992423,"I agree that the firewall interface is not very tight. I noted this in a release note in the previous 'CAPETOWN' release notes - it's best to not mess with the interfaces at this point and merely disable them by using crypto and ssid.



"
232,Dave Täht,2011-08-19 11:39:05.216742,"we have a mondo renumber script that we hope to turn into a package at some point. Far easier than doing it one interface at a time. Also, sans gui, you just have to edit /etc/config/network and /etc/config/wireless to do the job sanely."
230,Dave Täht,2011-08-19 11:40:00.153994,"opkg update kind of needs a working DNS, working time, and a working internet connection.

but your point is valid.

Have you tried to install vim, now, after doing the opkg update?"
231,Dave Täht,2011-08-19 11:42:12.559986,"I need to be absolutely clear that these interfaces are ON DIFFERENT SUBNETS. NO BRIDGING IS USED.

If you put these interfaces on the same subnet, bad things will happen.

if that is what you did?"
231,Michael Graff,2011-08-22 14:21:13.193234,"No, it turns out somehow some (but not all) of the interfaces had dhcp disabled.  :/  I don't know how or why, since I did not create them, but it seems odd.

Go ahead and close this, chalking this up to user error, for now."
233,Michael Graff,2011-08-22 14:25:05.081586,"Evan and I have a patch to BIND 9 that may help here, a lot.  Evan can likely get it to you.  I recommend just using it in this release, and if needed make it a knob later.

The problem is that BIND 9 issues upstream queries with recursion desired = 0, and then we get back strange answers from captive, walled garden DNS servers which habitually lie.

The ""fix"" is to just take what we get.  It's either right (in which case validation may work) or bad (in which case it will not).

Possibly one should add UI options to enable/disable validation and enable/disable ""just forward to my ISP"" options for BIND.

"
236,Dave Täht,2011-08-22 16:42:16.705361,thank you for spotting these!!
237,Dave Täht,2011-08-22 16:48:05.193119,"You CAN bridge them, but then other bad things happen, notably with multicast.

Bridging is enabled, in other words.

However, what we are trying to do is come up with the right tools to get away from bridging entirely

To answer one of your comments:

""it also prevents having more than one access point.""

Um... most - all - wireless routers have an option to route subnets - it's a single option on the gui to route to another subnet - and in cerowrt's case you just route the /24 to the router and let it take care of the /27s itself.

Also, cerowrt to cerowrt 'just works' when babel is enabled.

as for this one?

""Without being able to bridge the 3700's vlan13 ethernet to sw00/sw10, I have to have completely different domains. This, well, sucks for me.""

um, I don't understand the context behind this comment.

It is very important for us to stress that broadcast/multicast domains are one of the things really messing up wireless and to come up with good ways to route rather than bridge, wherever possible. So, if we can coherently answer your concerns here in this bug, we can continue to propigate the meme(s).

"
238,Dave Täht,2011-08-22 16:49:19.2119,"hmm. This is bad. xinetd is only supposed to be able to spawn 1. Period. 

Something else may be firing up named."
238,Dave Täht,2011-08-22 16:49:41.443913,""
231,Dave Täht,2011-08-22 16:51:34.241062,"re-opening this one, because I've seen it too... might be like how #236 - an error in the base config that causes the error in the change."
238,Michael Graff,2011-08-22 18:31:47.551542,"A coworker who you loaned a 3700 to also experienced this.  We spotted two running on his box while debugging my insane DHCP issues.

I also notice something is checking the local time using ntpdc, which fails as ntpd isn't running it seems, but something similar.  Is it possible this script is restarting named?"
237,Michael Graff,2011-08-22 18:53:21.348437,"I know this is quite detailed, so may be out of scope for a bug report.  :)

Basically, my house has (currently...) 3 APs.  One is a Cisco which is running stock firmware.  While this allows a guest and non-guest network, I am only using the private network, but using both 2Ghz and 5Ghz radios on it.  I have a wndr3700v1 box also running stock firmware which is also only used for private 2/5Ghz radio.  The new wndr3700v2 is currently installed as my home primary router.

Currently, I have a too-complicated network config to match this. :)

I have a VLAN-capable switch in my garage.  My cable modem connects to an untagged vlan9 port, and the WAN port on the 3700v2 connects to this switch, also on an untagged vlan9 port.  This part works perfectly.

The two stock APs connect directly to this as well, and (unfortunately) right now I am using the wired ports on each as a local switch.  All of these are on vlan13, untagged.

I have the v2 configured for v12, v13, v14, and v15.  v12 is my DMZ; it has addresses in the range 192.168.1/24.  v13 is 10.42/16, v14 is 10.43.1/24, and v15 is 10.43.2/24.  Originally I wanted to use vlan14 as my private wireless and v15 as my public wireless.

I plan on replacing the 3700v1 with a v2 in a month or so, and wanted to use a trunked port to the new v2 box so I can use the WAN port as a trunked uplink to the garage switch, put the wireless on vlan14 and 15, and the physical switch ports on vlan13.

I've done things like this using (older) APs for many moons.  I know there are oddnesses with multicast, but I have had no problems with these oddities.  This is a very understandable and straight-forward way to do this, to me anyway.  :)"
242,Dave Täht,2011-08-23 08:33:19.808645,"You are doing great stuff.

I use ipv6 mostly, which never times out. I will add that to the default sysctl.conf in the rc6 build"
241,Dave Täht,2011-08-23 08:35:15.026935,"In my case I was often attempting to optimize for living in the 3rd world where 300ms dns R/Ts are common. So adding cache is a GOOD thing. At present, bind9 is using about 24MB of ram, with about 32MB of ram left over for other stuff. 

Secondly, what I'd like to be doing at some point soon is benchmarking bind9 vs dnsmasq and seeing what can be optimized.

"
240,Dave Täht,2011-08-23 08:36:50.52177,"Sure. This layer of access control is controlled via /etc/xinetd.conf or more specifically, on a service-only basis /etc/xinetd.d/ssh file

edit it to what you want, then killall -1 xinetd
"
237,Dave Täht,2011-08-23 08:40:37.887732,"I am for starters tickled that you consider the rc5 candidate stable enough to use as your primary router, especially given your bug reporting volume! :)

It would cheer me up to know that aside from the bugs reported thus far, some of the good stuff in cerowrt was working out good for you.

As for your other comments... um, er, wow... a network diagram would help."
237,Dave Täht,2011-08-23 08:42:41.012803,"like, for example, does ipv6 work?"
233,Dave Täht,2011-08-23 10:01:43.784759,"I'd like more detail on this patch, and to get it into rc6, if it makes sense. I would hope that the vast majority of users are not testing in hotels, however... "
241,Dave Täht,2011-08-23 10:06:15.914543,"so I would be interested in using the built-in ""netem"" network emulator to simulate and analyze the effect of varying levels of delay on bind9.

In the interim, how do you actually use acache?"
245,Dave Täht,2011-08-23 11:08:18.403658,"https://dev.openwrt.org/ticket/8672

I will add GPT format support to the next build of cerowrt."
245,Dave Täht,2011-08-23 15:09:48.018585,"Fixed in cerowrt head. Tested, even."
246,Dave Täht,2011-08-23 15:10:54.154734,"The most straightforward thing to do at present is to put an unrememberable password on those interfaces and put them in wpa mode.

It really mucks with several levels to delete interfaces, notably with the firewall rules."
246,Dave Täht,2011-08-23 15:11:35.267521,"That said, I HAVE in the past been able to remove individual interfaces without nuking the entire config.

I will verify against the rc6 candidate."
246,Richard Smith,2011-08-23 15:42:49.647589,"Dave Täht wrote:
 
> It really mucks with several levels to delete interfaces, notably with the firewall rules.

This bug is not for deleting the interfaces.  I'm setting the disable option to 1.    

I put delete interfaces into a different bug. 
"
244,Dave Täht,2011-08-23 15:42:51.994584,added
242,Dave Täht,2011-08-23 15:46:13.998888,"I don't have a problem with 4 days. That gets you through a weekend.

In rc6"
239,Dave Täht,2011-08-23 15:47:13.09473,I am not sure you get ::1 with this acl config by default.
239,Dave Täht,2011-08-23 15:47:49.614131,"Dave Täht wrote:
> I am not sure you get ::1 with this acl config by default.


what do you mean by ""better""? Are you using ipv6?"
236,Dave Täht,2011-08-23 15:51:21.67227,Fixed both in rc6
230,Dave Täht,2011-08-23 15:53:00.720009,"you have to do that all important opkg update first. There is no good time to do that that I can think of at the moment.

I'm going to just move this bug to the next release until I think of a better answer."
219,Dave Täht,2011-08-23 15:54:17.351214,Why are there bugs *I* can't CLOSE?
246,Dave Täht,2011-08-23 16:01:10.504296,Thank you for clarifying that. I'll take a look in my next smoke test of rc6
197,Dave Täht,2011-08-23 16:55:49.007942,I just saw a patch go by on the openwrt list doing something to enable certs differently in openssl...
129,Dave Täht,2011-08-23 16:56:44.617594,"I really need to start seriously working on this, the list has grown too hard to keep in my head, or test manually."
241,Michael Graff,2011-08-23 17:29:09.723796,"acache just pre-renders the wire-format response, it does not add additional non-CPU saving performance.

It also only handles authority responses, so the RTT is still there.

You really don't want this unless you are planning on handling a metric crapload of queries/sec."
240,Michael Graff,2011-08-23 17:33:10.388209,"OK, thanks.  That explains the problem I was having then.

btw, this means there is UI-based ACLs, firewall based, and now xinetd based.  Would be nice if this were all normalized, but I know that is not a direct goal of this project."
226,Dave Täht,2011-08-23 17:37:56.175933,"At least on gcc/glibc calling the above patch only sets the in-kernel priority.

If you want to set the diffserv field, you need to do a:

	rc = setsockopt(fd, IPPROTO_IP, IP_TOS, &socket_prio, 1);

where socket_prio is a byte. The ECN bits are automagically masked out in this call."
239,Michael Graff,2011-08-23 17:43:51.892174,"I am using IPv6 via HE tunnelbroker.

But you are right...  this does not allow IPv6 queries.  This sucks.  :/

At least the ipv4 ACLs can be more easily represented, but at that point, perhaps it won't matter."
237,Michael Graff,2011-08-23 17:48:14.704046,"IPv6 works perfectly, but I am using an HE tunnel.

As for stability, well, most of the bug reports are for things that happen when I'm fiddling.  If I am steady-state, things seem to be pretty darned solid.

The network performances as measured by speedtest web sites are on par with the NetBSD router I had running this.  There were some oddities with that running under Xen, so overall this is actually an improvement.  I cannot (yet) get my Cisco SIP phone to work, but well...  I suspect that might be a feature :)  It's also likely the phone is the culprit.

I cannot tell if the debloating stuff is taking effect.  I suspect it wasn't with the config errors?  After correcting those, the network seems overall the same as before, with the added benefit that my router now consumes 5.4 watts rather than 150 or so.

Lastly, as for running it in ""production"" -- what better way to motivate me to report and help correct issues?"
233,Michael Graff,2011-08-23 17:49:33.076552,"I didn't intend to test it in a hotel, but it was where I was living while in California last week.  :)

I'd ask Evan if he can send it along."
235,Michael Graff,2011-08-23 17:50:15.668169,"I think this is related to the dhcp problem I had before, so I'm closing this."
248,Michael Graff,2011-08-23 17:58:07.908899,"Wonderful topics.

Perhaps it would be good to finish the docs, so one can understand how this new-to-me mesh networking works?

I follow http://jupiter.lab.bufferbloat.net/cerowrt/mesh.html and get a pretty page, but the ""how to"" page of http://www.bufferbloat.net/projects/cerowrt/wiki/Mesh is empty."
231,Michael Graff,2011-08-23 19:24:55.004598,"I just had this happen again.  I set one interface to ""none"" protocol (rather than the default of static) and it changed many (but not all) others to disable DHCP as well.)"
248,Dave Täht,2011-08-23 19:35:36.364261,"heh. Very good point. Some of this doc was in capetown...

but I will get cracking on release and experimenters notes ASAP."
248,Michael Graff,2011-08-23 20:02:39.486035,"If you tell me what I should be testing and what indicates success/failure, I'll be happy to report.

>I don't even know how to configure the QoS stuff (although the docs tell me I should) but that is inexperience.  If I had it tweaked properly, I still don't know how to quantify the improvement other than anecdotal human-based observations of better or worse.

The principal (and lame) test we use is latency under load - lots of up/downloads while pinging elsewhere.

>The mesh stuff is interesting, and I have two wndr3700v2 boxes now so it is potentially useful even) but once done, I don't know what to DO with it.  >What do you want tested?  How can it be measured and quantified as ""working"" beyond just playing?

I put up preliminary doc on the mesh stuff on the web site. I'll settle for documentation and tools that get it 'working' for more people, then move on to playing. I've internalized ahcp and babel so much that I can't simply explain the wonders of mesh networking (being able to move freely between wired and wireless networks with an open ssh connection for example)

>Same with the bloat.  Is there a daemon I can run which measures something I can report?

>Perhaps we need a long-running measurement and reporting daemon.  :)  Or SNMP hooks?  I'm willing to install snmpd (which I already have anyway) and >let it be probed remotely.

Yes we do. We also have netperf getting fired out of xinetd, with permissions (at least on most machines) on being probed from the lab. Longer term the plan was to allow snmp via the vpn.

>This is the first OpenWRT box I've ever used, and most of the stuff I really want (VPNs etc) on the CeroWRT box don't match what a ""standard"" OpenWRT >install would use, it seems.  

I'm not really sure what you mean here - both strongswan and openvpn are available via an opkg update; opkg list; opkg install the_package

More stuff can be built as per your needs. At some point soon I'll have a one-line build-yer-own-cerowrt script done.

>Specifically, I have a IPv4 /27 and would love to have it exposed to the UI, or at least know how to configure it on the box.  

Openwrt does not use /XX for ipv4 markings, but old style 255.255.255.224. It should be visible in the ui.

>Bridging seems to not work as expected, or at least not work as I expect it; if I bridge through the UI, and yes it is wired+wireless, the wired >ends up in the bridge but the wireless does not, but if I use command-line tools to re-add it (brctl I think it is?) it does add it until I touch >any interface config.

hmm... 

How about we have a voice/irc chat and run through some stuff together? Everybody lives on #bufferbloat on chat.freenode.net - but I'd like to chat via voice, via skype...."
248,Michael Graff,2011-08-23 22:48:16.92556,"One number I can report, but it is not especially useful...

After switching away from the Xen-hosted NetBSD router (yes, virtual routers FTW!) my next hop latency as measured by the Ripe NCC Atlas probe dropped from about 1.95ms average to 1.09ms average.

This is probably because it has to travel through less wires overall."
175,Michael Graff,2011-08-23 22:54:06.411797,"Just because the domain name to IP address mapping is secure, that does not mean the TCP connection will not be trapped by some transparent proxy sitting in an ISP or that your data was received unmodified...

Might be better to create a certificate authority, and install it in the router itself, so you can make truly secure TLS connections.
"
175,Dave Täht,2011-08-24 05:17:05.977998,"A problem is every CA seemingly has to be slightly different to handle a vpn, a web site, etc. but I'd dearly like to do this."
248,Dave Täht,2011-08-24 06:30:38.378305,"oh, and the specific test I was hoping to get done soon was a suite of isc's named benchmarks run against both bind and dnsmasq."
227,Dave Täht,2011-08-24 06:36:10.926974,"I have a backlog of isc specific problems that I pushed out to the next release of cerowrt. I would of course like to bring more stuff back in, but don't know how to test add-zone at all..."
243,Dave Täht,2011-08-24 07:58:49.859619,"A new version of iptables will be out by the 26th, with these fixes included."
250,Dave Täht,2011-08-24 21:33:33.333771,It appears that this patch hasn't made it upstream.
251,Michael Graff,2011-08-26 20:26:21.584255,"<pre><code=""sh"">
ip tunnel add mode gre local 1.2.3.4 remote 1.2.3.5 ttl 64 name isc4
ip addr add 1.2.3.101/31 peer 1.2.3.100 dev isc4
ifconfig isc4 up

TABLE=1041
if ! ip rule | grep -q ""lookup $TABLE"" ; then
  ip route add default dev se00.13:0 table $TABLE
  ip rule add from 4.4.4.4/27 to 4.4.4.4/27 lookup $TABLE
fi                                                                             

TABLE=1042
if ! ip rule | grep -q ""lookup $TABLE"" ; then
  ip route add default dev isc4 table $TABLE
  ip rule add from 4.4.4.4/27 to any lookup $TABLE
fi
    
 # ISC GRE tunnel and personal /27 stuff
iptables -I INPUT -i isc4 -j ACCEPT
iptables -I OUTPUT -o isc4 -j ACCEPT
iptables -I FORWARD -o isc4 -j ACCEPT

iptables -I INPUT -i vlan13:0 -j ACCEPT
iptables -I OUTPUT -o vlan13:0 -j ACCEPT
iptables -I FORWARD -o vlan13:0 -j ACCEPT

iptables -I forwarding_wan -p gre -d 4.4.4.4/27 -j ACCEPT
iptables -t nat -I prerouting_wan -p gre -j ACCEPT
</code></pre>"
251,Dave Täht,2011-08-26 20:46:17.970915,"from what I could tell from our final discussion tonight, this only partially works, in that the subnet is now routed, but...

First you have to ping out, then you can ping in. Am I wrong?

(the /27 network is actually on real IP addresses, not the fake ones denoted up here)"
238,Dave Täht,2011-08-26 22:49:56.489102,"the xinetd.d/named file needed a instances = 1 line to enforce the window where named hadn't fully started yet.

Or so I hope. Fixed in rc6, will test further then. in the meantime, you can add instances = 1 to your /etc/xined.d/named file and see if the problem recurs. thx for spotting this!"
241,Dave Täht,2011-08-26 23:50:45.313878,"ok, I will remove this comment in rc6. However, any performance boosting ideas remain welcomed."
112,Dave Täht,2011-08-27 10:41:59.27941,"Well, after finally gaining access to a 2002 and 2001 enabled network, with 4 gateways, policy routing suddenly became a major issue worth trying to fix. Otherwise, weirdnesses ensue that are really hard to track down.
"
112,Dave Täht,2011-08-27 10:42:17.429266,""
255,Dave Täht,2011-08-29 20:30:01.040537,"Thx for taking a look at this! I am aware of several bugs in rc5 that may induce a crash like this, notably the txqueuelen is too low, and there was a bug in the netfilter code.

If you are feeling ambitious, the current development branch of cerowrt rc6 is up at:

http://huchra.bufferbloat.net/~cero1/rc6-smoketest/

So far not a lot of smoke has been emitted. It's easy to upgrade (although you will need to let it NOT save your existing config as multiple important files in /etc have changed)

(I will get some time personally to look into this tomorrow, but as you are in a different time zone...)"
253,Dave Täht,2011-08-29 20:38:59.569226,"Our configuration of /etc/config/firewall predates LOTs of changes to the firewall interfaces. I don't think luci kept up - and I don't think the firewall rule generator uses multiport matches, for this sort of thing, either, generating one rule per port entry. 

It would be good if the syntax for /etc/config/firewall matched /etc/config/qos.

I'll look into this deeper in the morning. Thx for testing!"
255,Dave Täht,2011-08-29 20:49:23.243991,"Also, in looking over your screenshot, 90Mbit down 900KB up can't possibly ever work, as
TCP data packets are clocked by ack packets, which has a maximum of about 21 to 1 ratio and a sane one of not more than about 11x1. Is that what your provider is actually selling?

so 90Mbit vs 9Mbit would be reasonable.

But do give smoketest rc6 a shot. I'll try duplicating your results here."
255,Dave Täht,2011-08-29 21:08:29.506102,"passing 16Mbit of traffic (via the wireless) worked. I will have to get more rc6 boxes up
to try and pass more... in the morning."
255,Dave Täht,2011-08-29 22:03:39.212435,"I just tried 9/90Mbit and got 76Mbit out of it. No logged errors, no problems, no crash.

This was with netperf. It's a little harder at present to try another speedtest. "
255,Aidan Williams,2011-08-30 15:08:50.912209,"Hi Dave, 

Thanks for looking at this.  The rc6-smoketest image does not crash for me either.

I tried the same speedtest as before, with 100Mbit / 1Mbit and got this result:
http://speedtest.ookla.com/result/1345874780.png
93261kbps / 951kbps
Reliable, no crashes.

Netalyzr reports my upstream storage as dropping from 1400ms to about 160ms - which is nice!

Wireless was a lot slower (circa 10Mbps) on the 5GHz band, although I didn't try wireless with the rc5 software.

- aidan
"
206,Dave Täht,2011-08-30 15:34:01.234801,"on the plus side, over a single hop, I can get the multicast packets. 

on the minus side, over more than one hop, no such luck, and can't change mc_forwarding vis either
sysctl nor /proc

echo 1 > /proc/sys/net/ipv4/conf/se*/mc_forwarding # permission denied

Is also a problem in ubuntu. 

d@cruithne:~/src/uftp-3.5.1$ sudo echo 1 > /proc/sys/net/ipv4/conf/eth*/mc_forwarding
bash: /proc/sys/net/ipv4/conf/eth0/mc_forwarding: Permission denied

"
255,Dave Täht,2011-08-30 19:02:56.143096,"Aidan Williams wrote:
> Hi Dave, 
> 
> Thanks for looking at this.  The rc6-smoketest image does not crash for me either.
> 
> I tried the same speedtest as before, with 100Mbit / 1Mbit and got this result:
> http://speedtest.ookla.com/result/1345874780.png
> 93261kbps / 951kbps
> Reliable, no crashes.

Awesome.

> 
> Netalyzr reports my upstream storage as dropping from 1400ms to about 160ms - which is nice!

This is over wired? with qos on? To a site, how many ms away? This is still kind of bad.

> 
> Wireless was a lot slower (circa 10Mbps) on the 5GHz band, although I didn't try wireless with the rc5 software.

mmm.... in my case I'm getting 45Mbps on 5ghz, so I worry. Can you open a new bug with more details on your scenario? Are you n or g?

Also, try running netperf (version 2.5.0) to the router from your hardware, if that's not what you did..


> 
> - aidan

"
255,Dave Täht,2011-08-30 19:03:36.878921,and again 100Mbit/1Mbit is just plain not doable. 10Mbit? Your numbers are odd looking....
255,Aidan Williams,2011-08-30 19:22:38.056921,"Dave Täht wrote:
> > Netalyzr reports my upstream storage as dropping from 1400ms to about 160ms - which is nice!
> 
> This is over wired? with qos on? To a site, how many ms away? This is still kind of bad.
> 

Gigabit Ethernet, DOCSIS3, to a local Ookla speed tester (speedtest.syd.optusnet.com.au).  Optus run a local speedtester box in Sydney, Melbourne, Brisbane.

QoS on, with the config I mentioned.  QoS was working - I dialled the numbers up and down and got different measurements with the speedtester - it was very satisfying to see tweaks in the config directly reflected in the measurements..

The PNG link shows 15ms ping latency.

Further reducing the uplink bandwidth limit didn't seem to have a strong effect on Netalyzr's view of the storage in the uplink.  I reduced it by 100kbps a couple of times and it stuck at 160-170ms.  I'm wondering if this has more to do with how the DOCSIS MAC parameters are configured.

> > Wireless was a lot slower (circa 10Mbps) on the 5GHz band, although I didn't try wireless with the rc5 software.
> 
> mmm.... in my case I'm getting 45Mbps on 5ghz, so I worry. Can you open a new bug with more details on your scenario? Are you n or g?
> 
> Also, try running netperf (version 2.5.0) to the router from your hardware, if that's not what you did..
> 

Pretty sure it was n.  I'll be a bit more systematic and open another bug if necessary.

- aidan
"
255,Aidan Williams,2011-08-30 19:27:33.136501,"Dave Täht wrote:
> and again 100Mbit/1Mbit is just plain not doable. 10Mbit? Your numbers are odd looking....

Yeah, I get what you're saying.  OTOH, I didn't photoshop that PNG from the speedtester...  ;-)

It may be that there is rate limiting only on TCP payloads with data in them and bare ACKs are not limited the same way.  I have not yet done a tcpdump to get to the bottom of it.

For completeness..  I was using MacOSX 10.6.8, which supports window scaling:
bash-3.2# sysctl -a | egrep 1323\|win_scale
net.inet.tcp.rfc1323: 1
net.inet.tcp.win_scale_factor: 3
"
255,Dave Täht,2011-08-30 19:31:19.753934,"jim has some info regarding docsis 3 that I don't....

but it looks like maybe a little different classification might help. Try tossing ping into the highest bucket on the qos system.

If that doesn't work, then we can point a few fingers at the modem.

I am very strongly encouraged, that we are finally WINNING!!"
255,Dave Täht,2011-08-30 20:14:14.412688,"in /etc/config/qos

try changing target to 'Express' and/or 'Priority'

config 'reclassify'                      
        option 'target' 'Bulk'   
        option 'proto' 'icmp'          
                              

"
255,Aidan Williams,2011-08-31 18:06:24.890008,"Speed tester observations:
* Upon closer inspection, there is no ICMP - the speedtester thingy is dissembling.. ;-)
* The flash application running in a browser opens 6 TCP connections in parallel.
* Quite a bit of laptop CPU gets consumed running the flash application.

A long ICMP echo trace shows quite a bit of variability in ping time.
* https://www.dropbox.com/s/oml89evsxsdibtq/icmp-hist.txt

I have put some traces, scripts and results summaries into:
* http://db.tt/gZNOFlK

Wireless files have 24g or 5g in the filename.  Using 802.11n capable laptop.
Everything else is gig Ethernet.

A 100:1 ratio of data to ACK bandwidth seems quite feasible according to the traces/results in the link above.  If I have made some dumb mistake, maybe someone else can spot it.

Presumably 100:1 works because window scaling is working between the sender and receiver and the advertised receiver window is large..
Counting packets, my traces show about 4.5 data packets for every ACK using Ethernet.  I guess that is testable by messing around with sysctl.

result-speedtest-2.txt seems pretty typical:
<pre>
--------------------------------------------
    Statistics
--------------------------------------------
Downstream TCP data packets:  33815
  Upstream TCP ACK packets:   7341
  Upstream TCP SACKs:         370

  Upstream TCP data packets:  1222
Downstream TCP ACK packets:   945
Downstream TCP SACKs:         128

Downstream Data/ACK ratio:    4.606
  Upstream Data/ACK ratio:    1.293

</pre>

Googling around, I also came across this:
* http://www.clearcable.ca/docsis3/pdfs/Tech%20Note--D3-0%20and%20TCP%20v2-0.pdf

It describes Data/ACK bandwidth ratios of 50:1 or so for DOCSIS 3 cable networks.
"
255,Dave Täht,2011-08-31 18:41:28.905589,Thx for updating me on the state of the art in ack optimization and qos!
255,Dave Täht,2011-08-31 18:43:38.478959,"wow... looked over your data...

thought: Try your levels of qos with sack and dsack disabled (see /etc/sysctl.conf)"
255,Dave Täht,2011-08-31 18:46:08.097885,did you fiddle with what I note in comment 11 above for optimizing ping (as a test)?
255,Dave Täht,2011-08-31 18:49:07.318252,"And I'd love a wireshark capture from your laptop, to look at, using the

tcptrace -G
xplot.org

tools. Let me know if you need a big place to upload a .cap file to, please don't upload something that large to the bug tracker. :)

Lastly, I'm very interested in you doing a 

netperf -l 60 europa.lab.bufferbloat.net 

from the router.

- and capturing that one via wireshark, too?  We may have we have inadaquate buffering for a connection to australia... which will show in a trace.
"
255,Aidan Williams,2011-08-31 19:16:43.305174,You want fries with that??  ;-)
255,Dave Täht,2011-08-31 20:29:44.557531,I am simply delighted to have a tester producing documented results on the other side of the world. Only having one on a moonbase would make me happier! With your help rc6 will be the best cerowrt yet!
258,Dave Täht,2011-08-31 21:12:50.43534,"To say this is really weird, is an understatement. SOME packets are getting through the wireless adhoc interfaces, in both directions.

Off to test the ge00 interface, and then revert to 3.0.3 or earlier, keeping openwrt head. Perhaps the netfilter optimizations are causing difficulties?

<pre>

21:10:17.595068 IP cruithne.local.57824 > 172.29.5.129.ssh: Flags [F.], seq 1, ack 1, win 115, length 0
21:10:18.333572 IP cruithne.local.34152 > 172.29.5.129.ssh: Flags [SEW], seq 623326897, win 14600, options [mss 1460,sackOK,TS val 7010560 ecr 0,nop,wscale 7], length 0
21:10:18.335591 IP 172.29.5.129.ssh > cruithne.local.34152: Flags [S.E], seq 2972513861, ack 623326898, win 14600, options [mss 1460,nop,nop,sackOK,nop,wscale 1], length 0
21:10:18.335639 IP cruithne.local.34152 > 172.29.5.129.ssh: Flags [.], ack 1, win 115, length 0
21:10:20.604384 IP cruithne.local.57824 > 172.29.5.129.ssh: Flags [F.], seq 1, ack 1, win 115, length 0
21:10:21.555540 IP 172.29.5.129.ssh > cruithne.local.34152: Flags [S.E], seq 2972513861, ack 623326898, win 14600, options [mss 1460,nop,nop,sackOK,nop,wscale 1], length 0
21:10:21.555698 IP cruithne.local.34152 > 172.29.5.129.ssh: Flags [.], ack 1, win 115, options [nop,nop,sack 1 {0:1}], length 0
21:10:26.624427 IP cruithne.local.57824 > 172.29.5.129.ssh: Flags [F.], seq 1, ack 1, win 115, length 0
21:10:27.955495 IP 172.29.5.129.ssh > cruithne.local.34152: Flags [S.E], seq 2972513861, ack 623326898, win 14600, options [mss 1460,nop,nop,sackOK,nop,wscale 1], length 0
21:10:27.955673 IP cruithne.local.34152 > 172.29.5.129.ssh: Flags [.], ack 1, win 115, options [nop,nop,sack 1 {0:1}], length 0
</pre>"
259,Dave Täht,2011-09-01 13:24:34.153454,"qdisc pfifo_fast 0: dev se00 root refcnt 2 bands 3 priomap  1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1
 Sent 16717595 bytes 278816 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc hfsc 1: dev ge00 root refcnt 2 default 30 
 Sent 1135606082 bytes 750536 pkt (dropped 0, overlimits 1022567 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc sfq 100: dev ge00 parent 1:10 limit 127p quantum 1514b divisor 1024 perturb 2sec 
 Sent 2952 bytes 44 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc sfq 200: dev ge00 parent 1:20 limit 127p quantum 1514b divisor 1024 perturb 2sec 
 Sent 1890 bytes 21 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc red 300: dev ge00 parent 1:30 limit 12750Kb min 1088000b max 3264000b ecn 
 Sent 23702 bytes 136 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
  marked 0 early 0 pdrop 0 other 0
qdisc red 400: dev ge00 parent 1:40 limit 12750Kb min 1088000b max 3264000b ecn 
 Sent 1135577538 bytes 750335 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
  marked 0 early 0 pdrop 0 other 0
qdisc ingress ffff: dev ge00 parent ffff:fff1 ---------------- 
 Sent 10858894 bytes 234248 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc mq 0: dev sw00 root 
 Sent 222400 bytes 519 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc mq 0: dev gw01 root 
 Sent 245730 bytes 556 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc mq 0: dev mon.sw00 root 
 Sent 71540 bytes 444 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc mq 0: dev gw00 root 
 Sent 222474 bytes 520 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc mq 0: dev sw10 root 
 Sent 223112 bytes 529 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc mq 0: dev gw11 root 
 Sent 218532 bytes 511 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc mq 0: dev mon.sw10 root 
 Sent 11040 bytes 74 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc mq 0: dev gw10 root 
 Sent 224701 bytes 522 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc hfsc 1: dev ifb0 root refcnt 2 default 30 
 Sent 14066941 bytes 233895 pkt (dropped 0, overlimits 0 requeues 1506) 
 backlog 0b 0p requeues 1506 
qdisc sfq 100: dev ifb0 parent 1:10 limit 127p quantum 1514b divisor 1024 perturb 2sec 
 Sent 0 bytes 0 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc sfq 200: dev ifb0 parent 1:20 limit 127p quantum 1514b divisor 1024 perturb 2sec 
 Sent 1890 bytes 21 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc red 300: dev ifb0 parent 1:30 limit 12750Kb min 1088000b max 3264000b ecn 
 Sent 14065051 bytes 233874 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
  marked 0 early 0 pdrop 0 other 0
qdisc red 400: dev ifb0 parent 1:40 limit 12750Kb min 1088000b max 3264000b ecn 
 Sent 0 bytes 0 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
  marked 0 early 0 pdrop 0 other 0
"
252,Dave Täht,2011-09-01 17:41:06.720491,ahcp server doesn't create log directory on start
176,Dave Täht,2011-09-01 17:42:01.424546,"We can do better, but not in this release."
175,Dave Täht,2011-09-01 17:43:27.954973,""
210,Dave Täht,2011-09-01 17:46:37.067201,"I do not have this fixed 'right'. Even with all the patches that flew by on it, the only way that I can successfully 
change the ethernet tx ring is in /etc/init.d/boot before it comes up at all.

Which is what I'm doing in cerowrt 1.0."
243,Dave Täht,2011-09-01 17:48:51.878167,A new version of the iptables 1.4.12.1 package has been built and needs to be tested.
225,Dave Täht,2011-09-01 17:50:50.948643,"So, while the packaging is done (thx guys), the scripting is not. Next major release"
122,Dave Täht,2011-09-01 17:51:42.27997,we got as close as we could with this.
206,Dave Täht,2011-09-01 17:53:02.037745,"I haven't been able to crash the router doing this. On the other hand, I can't get multicast to work quite right, either.

ENOTIME."
129,Dave Täht,2011-09-01 17:54:16.090425,""
112,Dave Täht,2011-09-01 17:56:21.718453,"and after fiddling with it, it's tricky and involves too much stuff and I'm the only one with 4 ipv6 enabled gws I know of.

"
258,Dave Täht,2011-09-02 11:53:02.214498,"I had introduced a really bad route to the network and ALSO introduced #260 to the mix on one box, or so I think now.

Things are happier overall as I write."
204,Dave Täht,2011-09-02 11:54:07.153669,as much as I would like to address this in the 1.0 it needs to be thunk through carefully and harmonized with stuff run out of init. 
262,Aidan Williams,2011-09-04 01:28:05.180968,"I forgot, QoS was not enabled for this test.
"
89,Dave Täht,2011-09-04 19:28:10.508213,"We now limit the journal size to 100k per zone.

As for a daily cron job, the syntax is changing with 9.9 and this can be safely deferred until the next release.
"
110,Dave Täht,2011-09-04 19:28:39.806212,""
238,Dave Täht,2011-09-04 19:36:55.002332,I have not seen multiple nameds ever runnig with the rc6-smoketest. Please reopen bug if it recurs.
262,Dave Täht,2011-09-04 19:45:11.446594,"Well, the results you are getting appear to be that you are not negotiating wireless -n

Can you repeat test with a wired connection to isolate the wireless out of the equation?"
256,Dave Täht,2011-09-05 11:28:53.4551,""
255,Dave Täht,2011-09-05 11:29:42.598611,"so no mo crashes, we can close this one"
257,Dave Täht,2011-09-05 11:31:25.278107,"I think we nailed most of these issues yesterday, but not all."
262,Aidan Williams,2011-09-05 21:23:39.684465,"Wired performance is as measured in bug #255, typcially 80-90Mbps.

The box running Cerowrt is connected to the cable modem.
The box running Netgear firmware is connected to the Cerowrt box with an Ethernet cable.
This makes it convenient to do side-by-side tests and to compare wireless signal leves (I wrestled for some time with regulartory configuration to make the power levels the same).

Wireless Netgear performance measurement went through this chain:
* MacBook Pro <wireless>
* Wndr3700v2/NetgearFW <ethernet>
* Wndr3700v2/Cerowrt-rc6 <ethernet>
* Cisco DPq3213 <HFCnetwork>
* off-to-Speedtester

If there were something bad with the Cerowrt Ethernet forwarding performance, it should have affected the Netgear wireless performance result.

Re negotiating wireless-n - can you suggest a way of identifying what mode is being used?
"
263,Dave Täht,2011-09-06 01:10:09.740776,"So I reboot, and hook myself up to the 5ghz radio for a bit, with wpa turned on...

<pre>

d@cruithne:~/rc6-smoketest5$ netperf -H 172.29.0.129
MIGRATED TCP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 172.29.0.129 (172.29.0.129) port 0 AF_INET

Recv   Send    Send                          
Socket Socket  Message  Elapsed              
Size   Size    Size     Time     Throughput  
bytes  bytes   bytes    secs.    10^6bits/sec  

 87380  16384  16384    10.01      43.92   
d@cruithne:~/rc6-smoketest5$ 
d@cruithne:~/rc6-smoketest5$ netperf -H 172.29.0.129
MIGRATED TCP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 172.29.0.129 (172.29.0.129) port 0 AF_INET
Recv   Send    Send                          
Socket Socket  Message  Elapsed              
Size   Size    Size     Time     Throughput  
bytes  bytes   bytes    secs.    10^6bits/sec  

 87380  16384  16384    10.01      37.24   
d@cruithne:~/rc6-smoketest5$ netperf -l 120 -H 172.29.0.129
MIGRATED TCP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 172.29.0.129 (172.29.0.129) port 0 AF_INET
Recv   Send    Send                          
Socket Socket  Message  Elapsed              
Size   Size    Size     Time     Throughput  
bytes  bytes   bytes    secs.    10^6bits/sec  

 87380  16384  16384    120.01     43.41   
</pre>"
263,Dave Täht,2011-09-06 01:24:42.649206,"

And I get weirdly asymmetric behavior. From one side, I can ping, and it's routing through the wireless sta I have setup, to the laptop, to the box....

<pre>

traceroute to 172.29.6.33 (172.29.6.33), 30 hops max, 38 byte packets
 1  172.29.0.37  0.736 ms  0.325 ms  0.334 ms
 2  172.29.6.33  1.697 ms  3.338 ms  0.990 ms

root@jupiter:~# ping 172.29.6.33
PING 172.29.6.33 (172.29.6.33): 56 data bytes
64 bytes from 172.29.6.33: seq=0 ttl=64 time=4.840 ms
64 bytes from 172.29.6.33: seq=1 ttl=64 time=2.450 ms

*But* the other side is fixated on the idea that it wants out the gw01 interface which seems not to work at all.

root@smoketest-andrew:~# ip route | grep 172.29.0.33
172.29.0.33 via 172.29.30.126 dev gw01  proto babel onlink 

then, I restart babel, and I'm now picking up the ethernet link...

root@smoketest-andrew:~# ip route | grep default
default via 172.29.6.57 dev se00  proto babel onlink 

and life is good...

and then I disconnect from the router wiredly, down the ethernet interface, and I'm routing from both the router and the laptop.



</pre>
"
263,Dave Täht,2011-09-06 01:30:15.34432,and then I get decent performance again from both radios.
263,Dave Täht,2011-09-06 01:59:26.967625,""
263,Dave Täht,2011-09-06 02:00:13.774344,""
262,Dave Täht,2011-09-06 02:20:21.66407,good methodology. Exactly how I wanted cerowrt to be tested - except reversed! 
262,Dave Täht,2011-09-06 02:21:15.234165,"(I'm not complaining, it's just that the number of people willing to risk their networks on beta-quality code astounds (and pleases) me)"
262,Aidan Williams,2011-09-06 02:24:19.451275,"Seems like 802.11n is being used.
MacOSX reports ""PHY Mode: 802.11n"" for both 2.4GHz and 5GHz.
See attached screen captures..

"
262,Andrew McGregor,2011-09-06 02:25:46.570285,"So, I have one issue with the test methodology... equidistant doesn't cut it, you need to test the same pair of devices with both firmware (i.e. reboot into the other firmware)... and without moving anything.  Microwave wireless in a cluttered environment is about multipath, and there's just no way to set up two identical paths; if you want that, you need to simply use the same path.

On 6/09/2011, at 9:21 PM, cerowrt@lists.bufferbloat.net wrote:

> 
> Issue #262 has been updated by Dave Täht.
> 
> 
> (I'm not complaining, it's just that the number of people willing to risk their networks on beta-quality code astounds (and pleases) me)
> ----------------------------------------
> Bug #262: poor wireless performance in smoketest rc6
> https://www.bufferbloat.net/issues/262
> 
> Author: Aidan Williams
> Status: New
> Priority: Normal
> Assignee: 
> Category: 
> Target version: 
> 
> 
> Side by side comparison of Netgear and Cerowrt firmware shows that Cerowrt has significantly worse performance.
> 
> 91Mbps Netgear 5 GHz
> 78Mbps Netgear 2.4 GHz
> 20Mbps Smoketest rc6 5 GHz
> 17Mbps Smoketest rc6 2.4 GHz
> 
> Images attached show signal levels and the output from the Optus Sydney speedtester which is quite local to my home network.  The WiFi signal levels are comparable for both routers, so I don't think this is an RF issue.  There are some other APs in my area in the 2.4GHz band, but their levels are relatively low.
> 
> Notes:
> * 2 x WNDR7200v2 boxes
> * Netgear fw: 1.0.0.8
> * Mac OSX 10.6.8, Macbook Pro laptop
> * 3 feet between access points
> * 4 feet to the laptop which was more or less equidistant to the APs
> 
> 
>"
264,Dave Täht,2011-09-06 02:35:37.368146,"I was going to reboot you into a txqueuelen of 256, but I merely left it setup so if you rebooted the ethernet drivers
would have a txqueuelen of 256.

I enabled qos-scripts, setting it to 2000 bidirectionally, as the max as I could get on a single stream was ~8000

the 'overhead' value is for things like ethernet over something. Left it off.

<pre>

root@europa:~# iperf -t 60 -w220k -c 98.229.130.122 
------------------------------------------------------------
Client connecting to 98.229.130.122, TCP port 5001
TCP window size:  220 KByte
------------------------------------------------------------
[  3] local 149.20.63.19 port 49117 connected with 98.229.130.122 port 5001
[ ID] Interval       Transfer     Bandwidth
[  3]  0.0-60.7 sec  9.50 MBytes  1.31 Mbits/sec
</pre>

and as usual red does nothing inside of qos scripts, the outer qdiscs do all the work.

<pre>
root@gw:/etc/config# tc -s qdisc
qdisc pfifo_fast 0: dev se00 root refcnt 2 bands 3 priomap  1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1
 Sent 2470004177 bytes 1906833 pkt (dropped 39, overlimits 0 requeues 588) 
 backlog 0b 0p requeues 588 
qdisc hfsc 1: dev ge00 root refcnt 2 default 30 
 Sent 671105 bytes 9377 pkt (dropped 0, overlimits 117 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc sfq 100: dev ge00 parent 1:10 limit 127p quantum 1514b divisor 1024 perturb 2sec 
 Sent 344884 bytes 4956 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc sfq 200: dev ge00 parent 1:20 limit 127p quantum 1514b divisor 1024 perturb 2sec 
 Sent 45722 bytes 512 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc red 300: dev ge00 parent 1:30 limit 150Kb min 12800b max 38400b ecn 
 Sent 89683 bytes 372 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
  marked 0 early 0 pdrop 0 other 0
qdisc red 400: dev ge00 parent 1:40 limit 150Kb min 12800b max 38400b ecn 
 Sent 190816 bytes 3537 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
  marked 0 early 0 pdrop 0 other 0
qdisc ingress ffff: dev ge00 parent ffff:fff1 ---------------- 
 Sent 22572047 bytes 16460 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc hfsc 1: dev ifb0 root refcnt 2 default 30 
 Sent 22351988 bytes 15603 pkt (dropped 291, overlimits 29212 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc sfq 100: dev ifb0 parent 1:10 limit 127p quantum 1514b divisor 1024 perturb 2sec 
 Sent 0 bytes 0 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc sfq 200: dev ifb0 parent 1:20 limit 127p quantum 1514b divisor 1024 perturb 2sec 
 Sent 181753 bytes 490 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc red 300: dev ifb0 parent 1:30 limit 150Kb min 12800b max 38400b ecn 
 Sent 22170235 bytes 15113 pkt (dropped 291, overlimits 408 requeues 0) 
 backlog 0b 0p requeues 0 
  marked 117 early 291 pdrop 0 other 0
qdisc red 400: dev ifb0 parent 1:40 limit 150Kb min 12800b max 38400b ecn 
 Sent 0 bytes 0 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
  marked 0 early 0 pdrop 0 other 0
qdisc mq 0: dev sw00 root 
 Sent 1980985 bytes 22216 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc mq 0: dev gw01 root 
 Sent 793308 bytes 7866 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc mq 0: dev mon.sw00 root 
 Sent 1387796 bytes 7937 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc mq 0: dev gw00 root 
 Sent 1433275 bytes 9257 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc mq 0: dev sw10 root 
 Sent 11511732 bytes 149188 pkt (dropped 0, overlimits 0 requeues 23) 
 backlog 0b 0p requeues 23 
qdisc mq 0: dev gw11 root 
 Sent 792407 bytes 7852 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc mq 0: dev mon.sw10 root 
 Sent 22944 bytes 142 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc mq 0: dev gw10 root 
 Sent 1170022 bytes 7800 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
</pre>



"
264,Dave Täht,2011-09-06 02:38:19.575631,"d@bob-desktop:~$ iperf -t 60 -w220k -c 98.229.130.122 
------------------------------------------------------------
Client connecting to 98.229.130.122, TCP port 5001
TCP window size:  256 KByte (WARNING: requested  220 KByte)
------------------------------------------------------------
[  3] local 149.20.63.20 port 56628 connected with 98.229.130.122 port 5001
[ ID] Interval       Transfer     Bandwidth
[  3]  0.0-60.0 sec  13.9 MBytes  1.94 Mbits/sec
"
264,Dave Täht,2011-09-06 02:42:24.411048,"The last result was interesting in context, so I setup the cerowrt router (europa) to have a txqueuelen of 1000 for iperf and repeated the test...

then dropped it back to 8, to minimize the skew inflicted by back to back tests.

<pre>

root@europa:~# ifconfig ge00 txqueuelen 1000
root@europa:~# iperf -t 60 -w220k -c 98.229.130.122 
------------------------------------------------------------
Client connecting to 98.229.130.122, TCP port 5001
TCP window size:  220 KByte
------------------------------------------------------------
[  3] local 149.20.63.19 port 49118 connected with 98.229.130.122 port 5001
[ ID] Interval       Transfer     Bandwidth
[  3]  0.0-60.0 sec  13.6 MBytes  1.90 Mbits/sec
root@europa:~# ifconfig ge00 txqueuelen 8
root@europa:~# iperf -t 60 -w220k -c 98.229.130.122 
------------------------------------------------------------
Client connecting to 98.229.130.122, TCP port 5001
TCP window size:  220 KByte
------------------------------------------------------------
[  3] local 149.20.63.19 port 49119 connected with 98.229.130.122 port 5001
[ ID] Interval       Transfer     Bandwidth
[  3]  0.0-60.6 sec  13.8 MBytes  1.90 Mbits/sec

</pre>"
262,Aidan Williams,2011-09-06 02:49:51.798395,"I was really trying to make sure that obvious differences in wireless characteristics were not to blame (such as the power levels).  Seems to me that multipath will be affected by me walking around the room even if the sending and receiving device were identical and not moved..

But maybe that's splitting hairs.  In this example, there is a factor of 4 difference in performance.  Would wireless variation/fading/multipath account for a 4x reduction in performance?

The slow speed on Cerowrt appears to happen wherever I am in the room.  I move the laptop around...

I see no other 5GHz devices (other than the Cerowrt and Netgear boxes) when I scan.
"
262,Aidan Williams,2011-09-06 02:54:27.771827,I just wandered around the room and into an adjacent room and ran the speed tester 5 times.  They were all 18-21Mbps.  This is quite consistent for me.
262,Dave Täht,2011-09-06 03:23:27.671641,"With ratios of numbers this poor, a few millimeters of difference at this range seem insignificant.

That said, a good repeat would be to swap firmware holding the distances the same, or swap devices holding the distances the same.
"
262,Dave Täht,2011-09-06 03:24:05.40914,are they on the same channels?
262,Dave Täht,2011-09-06 03:30:23.10799,"http://huchra.bufferbloat.net/~cero1/rc6-smoketest5/ does not have anything I know of that could affect your testing, but seems reasonably stable at this point."
262,Dave Täht,2011-09-06 03:41:13.778503,"Just to throw more random data into the mix:

<pre>

wlan0     IEEE 802.11abgn  ESSID:""jupiter5""  
          Mode:Managed  Frequency:5.805 GHz  Access Point: A0:21:B7:A9:86:7C   
          Bit Rate=130 Mb/s   Tx-Power=16 dBm   
          Retry  long limit:7   RTS thr:off   Fragment thr:off
          Power Management:off
          Link Quality=63/70  Signal level=-47 dBm  
          Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
          Tx excessive retries:470038  Invalid misc:7832   Missed beacon:0

</pre>

I get ~20Mbit down, ~30Mbit up using a speedtest.net server in san jose (6ms path). using one in SF (3ms) ~21Mbit down, 41Mbit up.

Laptop is ubuntu 11.4, hardware is an intel lagn, wpa encryption is turned on, distance is about 4 meters, 5ghz.

ping times jump about 35ms.

"
262,Andrew McGregor,2011-09-06 03:50:54.339169,"Ok, if it's that consistent, I'll call the test valid.

Dave, a few millimeters can be significant... but if you get consistency moving around, I'd say it's a real phenomenon.

At Indranet, we had a test path we used where a 50 mm move at one end would change the 11g performance from 21 Mbps to less than 1 Mbps.  Great for testing Minstrel responsiveness, but not so great for testing other parts of the MAC... so I wanted to make sure Aidan wasn't testing in that kind of situation.  Seems he isn't, which is good for the test (but not so good for rc6)

On 6/09/2011, at 9:54 PM, cerowrt@lists.bufferbloat.net wrote:

> 
> Issue #262 has been updated by Aidan Williams.
> 
> 
> I just wandered around the room and into an adjacent room and ran the speed tester 5 times.  They were all 18-21Mbps.  This is quite consistent for me.
> ----------------------------------------
> Bug #262: poor wireless performance in smoketest rc6
> https://www.bufferbloat.net/issues/262
> 
> Author: Aidan Williams
> Status: New
> Priority: Normal
> Assignee: 
> Category: 
> Target version: 
> 
> 
> Side by side comparison of Netgear and Cerowrt firmware shows that Cerowrt has significantly worse performance.
> 
> 91Mbps Netgear 5 GHz
> 78Mbps Netgear 2.4 GHz
> 20Mbps Smoketest rc6 5 GHz
> 17Mbps Smoketest rc6 2.4 GHz
> 
> Images attached show signal levels and the output from the Optus Sydney speedtester which is quite local to my home network.  The WiFi signal levels are comparable for both routers, so I don't think this is an RF issue.  There are some other APs in my area in the 2.4GHz band, but their levels are relatively low.
> 
> Notes:
> * 2 x WNDR7200v2 boxes
> * Netgear fw: 1.0.0.8
> * Mac OSX 10.6.8, Macbook Pro laptop
> * 3 feet between access points
> * 4 feet to the laptop which was more or less equidistant to the APs
> 
> 
>"
262,Aidan Williams,2011-09-06 04:25:10.217195,"Dave Täht wrote:
> are they on the same channels?

Channels look like this:
"
262,Aidan Williams,2011-09-06 04:31:08.805095,"Dave Täht wrote:
> are they on the same channels?

Channels look like this:
!https://www.bufferbloat.net/attachments/57/channels.png!

(Sorry about the repost - still getting the hang of this issue trackers markup language)
"
262,Felix Fietkau,2011-09-06 06:22:01.424343,Please post the output of 'cat /sys/kernel/debug/ieee80211/phy*/ath9k/xmit' after running some speed tests
262,Jim Gettys,2011-09-06 06:27:42.225833,"I ran a few quick tests before having to go pack and sleep.

I got about 20Mbps (G).  I got around 50Mbps (N), using my ath9k based Dell Laptop.
It reported 130Mbps (iwconfig).


I noted the channel width was set to 20; I tried setting it to 40, but had trouble and threw in the towel (getting on an airplane with my family having a broken router would not be good for domestic tranquility.
"
262,Dave Täht,2011-09-06 08:54:43.19055,"Theory: I have seen web traffic be marked both BE and BK (bulk) on the incoming interface. The current mac80211 code respects those markings and tosses stuff into what it thinks is the appropriate queue. The netgear code may not. The behavior of the BK queue I don't fully understand. I have long thought (half of the week) it made sense to hammer down BE and BK web traffic into BE - or some other traffic class entirely.

Test: On the laptop performing the test, run tcpdump -i the_interface -wtest.cap

Call up test.cap in wireshark and look at the diffserv markings. if non-zero (ECN is ok), then we have half our traffic marked one way and return traffic marked another.

put test.cap somewhere I can look at it, please, not in the bug, they tend to be large."
262,Aidan Williams,2011-09-08 20:30:40.219623,"Been a busy boy, which has meant I haven't have a whole lot of time for testing.

Anyway, captured this speedtest run:
* 16287kbps down / 948kbps up
* ""speedtester-802.11n-5GHz-cerorc6smoke.png "":http://db.tt/UW3ixmR

Some files:
* ""speedtester-802.11n-5GHz-cerorc6smoke.pcap.bz2"":http://db.tt/qXqHXff
* ""speedtester-802.11n-5GHz-cerorc6smoke-ath9k-xmit.txt"":http://db.tt/J7bbtDJ

The modem was power cycled before doing all this.
5 runs of the speed tester were carried out before catting the ath9k xmit file above.
MacOSX 10.6.8, 5GHz, 802.11n (as reported previously).
"
262,Aidan Williams,2011-09-08 20:33:59.330294,"Loading the pcap file into wireshark and running the filter: ip.dsfield.dscp!=0 showed no packets.
"
262,Dave Täht,2011-09-09 14:20:27.635329,"I am experimenting on some conference attendies. We may have a major problem interacting with macbook pros - perhaps in power save mode?

pinging from the ap:

1315688855 44:a7:cf:bf:33:21 172.29.7.81 * 01:44:a7:cf:bf:33:21
1315688696 00:26:bb:03:ac:b3 172.29.7.173 bjlee-macbook-pro 01:00:26:bb:03:ac:b3
1315679368 00:1f:3b:2d:df:f5 172.29.7.123 cruithne *


4 bytes from 172.29.7.81: seq=0 ttl=64 time=14.191 ms
64 bytes from 172.29.7.81: seq=1 ttl=64 time=697.771 ms
64 bytes from 172.29.7.81: seq=2 ttl=64 time=170.491 ms
64 bytes from 172.29.7.81: seq=3 ttl=64 time=198.249 ms
64 bytes from 172.29.7.81: seq=4 ttl=64 time=143.031 ms
64 bytes from 172.29.7.81: seq=5 ttl=64 time=3.928 ms
64 bytes from 172.29.7.81: seq=6 ttl=64 time=976.788 ms
64 bytes from 172.29.7.81: seq=7 ttl=64 time=1.751 ms


PING 172.29.7.173 (172.29.7.173): 56 data bytes
64 bytes from 172.29.7.173: seq=0 ttl=64 time=114.859 ms
64 bytes from 172.29.7.173: seq=1 ttl=64 time=136.401 ms
64 bytes from 172.29.7.173: seq=2 ttl=64 time=160.695 ms
64 bytes from 172.29.7.173: seq=3 ttl=64 time=184.795 ms
64 bytes from 172.29.7.173: seq=4 ttl=64 time=208.588 ms
64 bytes from 172.29.7.173: seq=5 ttl=64 time=27.343 ms


And my ubuntu laptop:

root@jg1:/etc# ping 172.29.7.123
PING 172.29.7.123 (172.29.7.123): 56 data bytes
64 bytes from 172.29.7.123: seq=0 ttl=64 time=2.057 ms
64 bytes from 172.29.7.123: seq=1 ttl=64 time=0.797 ms
64 bytes from 172.29.7.123: seq=2 ttl=64 time=0.815 ms
64 bytes from 172.29.7.123: seq=3 ttl=64 time=0.936 ms
64 bytes from 172.29.7.123: seq=4 ttl=64 time=0.855 ms
64 bytes from 172.29.7.123: seq=5 ttl=64 time=0.840 ms
64 bytes from 172.29.7.123: seq=6 ttl=64 time=0.827 ms
^C"
262,Frank Horowitz,2011-09-09 20:33:36.497517,"Dave Täht wrote:
> I am experimenting on some conference attendies. We may have a major problem interacting with macbook pros - perhaps in power save mode?


Quite possibly not just MB *Pro*s, and buggy earlier than rc6. These are from my AP running cerowrt downloaded on 14 August showing ""OpenWrt Firmware Attitude Adjustment (r27959) LuCI Trunk 0.10+svn"" (rc5, IIRC)
pinging to both a MB pro and an older (white) MB, both running OSX Lion:

First the MB Pro:

root@Lirpo5:~# ping 172.30.42.99
PING 172.30.42.99 (172.30.42.99): 56 data bytes
64 bytes from 172.30.42.99: seq=0 ttl=64 time=1.428 ms
64 bytes from 172.30.42.99: seq=1 ttl=64 time=35.166 ms
64 bytes from 172.30.42.99: seq=2 ttl=64 time=59.223 ms
64 bytes from 172.30.42.99: seq=3 ttl=64 time=83.757 ms
64 bytes from 172.30.42.99: seq=4 ttl=64 time=106.906 ms
64 bytes from 172.30.42.99: seq=5 ttl=64 time=130.749 ms
64 bytes from 172.30.42.99: seq=6 ttl=64 time=154.568 ms
64 bytes from 172.30.42.99: seq=7 ttl=64 time=178.428 ms
64 bytes from 172.30.42.99: seq=8 ttl=64 time=93.308 ms
64 bytes from 172.30.42.99: seq=9 ttl=64 time=1.304 ms
64 bytes from 172.30.42.99: seq=10 ttl=64 time=45.054 ms
64 bytes from 172.30.42.99: seq=11 ttl=64 time=68.897 ms
64 bytes from 172.30.42.99: seq=12 ttl=64 time=92.805 ms
64 bytes from 172.30.42.99: seq=13 ttl=64 time=116.048 ms
64 bytes from 172.30.42.99: seq=14 ttl=64 time=1.351 ms
^C
--- 172.30.42.99 ping statistics ---
15 packets transmitted, 15 packets received, 0% packet loss
round-trip min/avg/max = 1.304/77.932/178.428 ms

Next the Older MB:

root@Lirpo5:~# ping 172.30.42.119
PING 172.30.42.119 (172.30.42.119): 56 data bytes
64 bytes from 172.30.42.119: seq=0 ttl=64 time=108.159 ms
64 bytes from 172.30.42.119: seq=1 ttl=64 time=29.406 ms
64 bytes from 172.30.42.119: seq=2 ttl=64 time=52.802 ms
64 bytes from 172.30.42.119: seq=3 ttl=64 time=77.018 ms
64 bytes from 172.30.42.119: seq=4 ttl=64 time=1.087 ms
64 bytes from 172.30.42.119: seq=5 ttl=64 time=22.297 ms
64 bytes from 172.30.42.119: seq=6 ttl=64 time=3.554 ms
64 bytes from 172.30.42.119: seq=7 ttl=64 time=69.114 ms
64 bytes from 172.30.42.119: seq=8 ttl=64 time=3.475 ms
64 bytes from 172.30.42.119: seq=9 ttl=64 time=15.583 ms
64 bytes from 172.30.42.119: seq=10 ttl=64 time=39.288 ms
64 bytes from 172.30.42.119: seq=11 ttl=64 time=64.266 ms
^C
--- 172.30.42.119 ping statistics ---
12 packets transmitted, 12 packets received, 0% packet loss
round-trip min/avg/max = 1.087/40.504/108.159 ms

Both are on 802.11a, neither showing an N connection, and AFAICT with no other radios on the 802.11a band.

I'll reflash the AP to smoketest rc6, just to eliminate another possible variable, and will report results back shortly...
"
262,Frank Horowitz,2011-09-09 21:09:42.590941,"OK. Reflashed the router to cero rc6-smoketest5 via a sysupgrade, keeping all configs. 

Here are the new ping results:

Once again, first the MB Pro:
root@Lirpo5:~# ping 172.30.42.99
PING 172.30.42.99 (172.30.42.99): 56 data bytes
64 bytes from 172.30.42.99: seq=0 ttl=64 time=0.904 ms
64 bytes from 172.30.42.99: seq=1 ttl=64 time=56.728 ms
64 bytes from 172.30.42.99: seq=2 ttl=64 time=80.610 ms
64 bytes from 172.30.42.99: seq=3 ttl=64 time=104.474 ms
64 bytes from 172.30.42.99: seq=4 ttl=64 time=128.342 ms
64 bytes from 172.30.42.99: seq=5 ttl=64 time=1.227 ms
64 bytes from 172.30.42.99: seq=6 ttl=64 time=175.910 ms
64 bytes from 172.30.42.99: seq=7 ttl=64 time=199.757 ms
64 bytes from 172.30.42.99: seq=8 ttl=64 time=18.674 ms
64 bytes from 172.30.42.99: seq=9 ttl=64 time=42.665 ms
^C
--- 172.30.42.99 ping statistics ---
10 packets transmitted, 10 packets received, 0% packet loss
round-trip min/avg/max = 0.904/80.929/199.757 ms

And next the old MB: 
root@Lirpo5:~# ping 172.30.42.119
PING 172.30.42.119 (172.30.42.119): 56 data bytes
64 bytes from 172.30.42.119: seq=0 ttl=64 time=774.372 ms
64 bytes from 172.30.42.119: seq=1 ttl=64 time=2006.759 ms
64 bytes from 172.30.42.119: seq=2 ttl=64 time=1007.038 ms
64 bytes from 172.30.42.119: seq=3 ttl=64 time=7.137 ms
64 bytes from 172.30.42.119: seq=4 ttl=64 time=1214.317 ms
64 bytes from 172.30.42.119: seq=5 ttl=64 time=214.878 ms
64 bytes from 172.30.42.119: seq=6 ttl=64 time=8126.826 ms
64 bytes from 172.30.42.119: seq=7 ttl=64 time=7127.321 ms
64 bytes from 172.30.42.119: seq=8 ttl=64 time=6127.669 ms
64 bytes from 172.30.42.119: seq=9 ttl=64 time=5127.940 ms
64 bytes from 172.30.42.119: seq=10 ttl=64 time=4129.217 ms
64 bytes from 172.30.42.119: seq=11 ttl=64 time=3129.640 ms
64 bytes from 172.30.42.119: seq=12 ttl=64 time=2130.632 ms
64 bytes from 172.30.42.119: seq=13 ttl=64 time=1131.306 ms
64 bytes from 172.30.42.119: seq=14 ttl=64 time=131.394 ms
^C
--- 172.30.42.119 ping statistics ---
17 packets transmitted, 15 packets received, 11% packet loss
round-trip min/avg/max = 7.137/2825.763/8126.826 ms

Note that the MB had just associated, and was likely still speed hunting.

FWIW, and hope this helps.

I'm ready and willing to perform some more tests, but will need some guidance as to what would be most helpful to the gurus...
"
262,Dave Täht,2011-09-09 23:08:31.231669,"Dear Frank:

There were several changes in the default /etc/ files that were changed for rc6, so if you reflashed and did not erase our old config, you may have re-introduced a problem that we moved towards fixing in the kernel (see bug #216)

txqueuelen for the wireless devices was made 37 in /etc/hotplug.d/iface/00-debloat and in /etc/config/network, and we have data indicating that it could be at least 3 times that, at present, under at least some workloads."
238,Dave Täht,2011-09-09 23:34:37.73394,"I managed to have 6 named processes running today in testing, even with xinetd instances=1. Not good. Box ran out of ram and stopped taking connections.

The right answer is to fix ntp for dnssec, period, and move that version of ntp into the ceropackages github repo.

Which requires braincells I do not have at present. I haven't even got so far as to make it work on x86. when I poked into the guts of ntp it was not obvious - or possible - to separate out ntp -g processig from normal processing, easily."
262,Frank Horowitz,2011-09-10 05:16:34.189704,"Thanks for the response, Dave. 

I've reflashed to the latest rc6-smoketest6 (new since my last flash a few hours back) and this time blew away the old config and re-configured from scratch.

Results -- a similar scatter in pings to the MB Pro. 

root@Lirpo5:~# ping 172.30.42.67
PING 172.30.42.67 (172.30.42.67): 56 data bytes
64 bytes from 172.30.42.67: seq=0 ttl=64 time=5.042 ms
64 bytes from 172.30.42.67: seq=1 ttl=64 time=98.623 ms
64 bytes from 172.30.42.67: seq=2 ttl=64 time=122.991 ms
64 bytes from 172.30.42.67: seq=3 ttl=64 time=1.346 ms
64 bytes from 172.30.42.67: seq=4 ttl=64 time=170.512 ms
64 bytes from 172.30.42.67: seq=5 ttl=64 time=194.345 ms
64 bytes from 172.30.42.67: seq=6 ttl=64 time=13.385 ms
64 bytes from 172.30.42.67: seq=7 ttl=64 time=37.313 ms
64 bytes from 172.30.42.67: seq=8 ttl=64 time=1.393 ms
64 bytes from 172.30.42.67: seq=9 ttl=64 time=84.963 ms
^C
--- 172.30.42.67 ping statistics ---
10 packets transmitted, 10 packets received, 0% packet loss
round-trip min/avg/max = 1.346/72.991/194.345 ms

This is on an 802.11g (sw00) channel, since there seems to be an issue with DNS on the .11a (sw10) channel. Interestingly enough, when I associate with the .11a guest (sw11) channel, the DNS works. (Go figure; would you like me to file a bug report on that?)

Similarly, on my old MB:
root@Lirpo5:~# ping 172.30.42.87
PING 172.30.42.87 (172.30.42.87): 56 data bytes
64 bytes from 172.30.42.87: seq=0 ttl=64 time=1955.677 ms
64 bytes from 172.30.42.87: seq=1 ttl=64 time=955.671 ms
64 bytes from 172.30.42.87: seq=2 ttl=64 time=0.937 ms
64 bytes from 172.30.42.87: seq=3 ttl=64 time=0.978 ms
64 bytes from 172.30.42.87: seq=4 ttl=64 time=44.255 ms
64 bytes from 172.30.42.87: seq=5 ttl=64 time=68.310 ms
64 bytes from 172.30.42.87: seq=6 ttl=64 time=91.991 ms
64 bytes from 172.30.42.87: seq=7 ttl=64 time=13.431 ms
64 bytes from 172.30.42.87: seq=8 ttl=64 time=36.923 ms
64 bytes from 172.30.42.87: seq=9 ttl=64 time=61.483 ms
64 bytes from 172.30.42.87: seq=10 ttl=64 time=84.531 ms
^C
--- 172.30.42.87 ping statistics ---
12 packets transmitted, 11 packets received, 8% packet loss
round-trip min/avg/max = 0.937/301.289/1955.677 ms

Next steps?
"
262,Dave Täht,2011-09-10 11:40:06.671723,"@ Frank:

until I acquire more OSX gear like yours the best I can do is add more eyeballs to the bug, which I just did.

It really looks as though minstrel is getting confused by the wireless algo in osx, or vice versa.

The best suggestion I've had is from luis, who suggests trying the atheros algorithm instead of minstrel, which I'll do a build of monday-ish.

in the meantime if you could capture some of the rate statistics as suggest by felix earlier in the bug - and also run some traffic through it before starting your tests - that may help.

It would also cheer me up if you'd report back elsewhere on what IS working well."
265,Dave Täht,2011-09-10 13:24:37.910468,""
266,Dave Täht,2011-09-10 13:27:54.404088,"I have seen a great deal of possibly routing related weirdness of late, as the networks and tests has scaled up past 10+ users on a variety of devices. Up until recently I was blaming STA association weirdnesses, but this report opened up new possibilities to test against at the routing layer...

Although this bug is specific to ipv6 I would like to check against ipv4, too."
266,David Taht,2011-09-10 13:32:38.172253,"Actually, it was this bug that was worrying me about babel
specifically, not the original forward

(the other set me off to potential trouble in the route caches)

---------- Forwarded message ----------
From: Yan, Zheng <zheng.z.yan@intel.com>
Date: Tue, Sep 6, 2011 at 12:34 AM
Subject: [PATCH] ipv6: don't use inetpeer to store metrics for routes.
To: ""netdev@vger.kernel.org"" <netdev@vger.kernel.org>
Cc: ""davem@davemloft.net"" <davem@davemloft.net>,
""eric.dumazet@gmail.com"" <eric.dumazet@gmail.com>


Current IPv6 implementation uses inetpeer to store metrics for
routes. The problem of inetpeer is that it doesn't take subnet
prefix length in to consideration. If two routes have the same
address but different prefix length, they share same inetpeer.
So changing metrics of one route also affects the other. The
fix is to allocate separate metrics storage for each route.

Signed-off-by: Zheng Yan <zheng.z.yan@intel.com>
---
 net/ipv6/route.c |   33 ++++++++++++++++++++++-----------
 1 files changed, 22 insertions(+), 11 deletions(-)

diff --git a/net/ipv6/route.c b/net/ipv6/route.c
index 9e69eb0..1250f90 100644
--- a/net/ipv6/route.c
+++ b/net/ipv6/route.c
@@ -104,6 +104,9 @@ static u32 *ipv6_cow_metrics(struct dst_entry
*dst, unsigned long old)
       struct inet_peer *peer;
       u32 *p = NULL;

+       if (!(rt->dst.flags & DST_HOST))
+               return NULL;
+
       if (!rt->rt6i_peer)
               rt6_bind_peer(rt, 1);

@@ -252,6 +255,9 @@ static void ip6_dst_destroy(struct dst_entry *dst)
       struct inet6_dev *idev = rt->rt6i_idev;
       struct inet_peer *peer = rt->rt6i_peer;

+       if (!(rt->dst.flags & DST_HOST))
+               dst_destroy_metrics_generic(dst);
+
       if (idev != NULL) {
               rt->rt6i_idev = NULL;
               in6_dev_put(idev);
@@ -723,9 +729,7 @@ static struct rt6_info *rt6_alloc_cow(const struct
rt6_info *ort,
                       ipv6_addr_copy(&rt->rt6i_gateway, daddr);
               }

-               rt->rt6i_dst.plen = 128;
               rt->rt6i_flags |= RTF_CACHE;
-               rt->dst.flags |= DST_HOST;

 #ifdef CONFIG_IPV6_SUBTREES
               if (rt->rt6i_src.plen && saddr) {
@@ -775,9 +779,7 @@ static struct rt6_info *rt6_alloc_clone(struct
rt6_info *ort,
       struct rt6_info *rt = ip6_rt_copy(ort, daddr);

       if (rt) {
-               rt->rt6i_dst.plen = 128;
               rt->rt6i_flags |= RTF_CACHE;
-               rt->dst.flags |= DST_HOST;
               dst_set_neighbour(&rt->dst,
neigh_clone(dst_get_neighbour_raw(&ort->dst)));
       }
       return rt;
@@ -1078,12 +1080,15 @@ struct dst_entry *icmp6_dst_alloc(struct
net_device *dev,
                       neigh = NULL;
       }

-       rt->rt6i_idev     = idev;
+       rt->dst.flags |= DST_HOST;
+       rt->dst.output  = ip6_output;
       dst_set_neighbour(&rt->dst, neigh);
       atomic_set(&rt->dst.__refcnt, 1);
-       ipv6_addr_copy(&rt->rt6i_dst.addr, addr);
       dst_metric_set(&rt->dst, RTAX_HOPLIMIT, 255);
-       rt->dst.output  = ip6_output;
+
+       ipv6_addr_copy(&rt->rt6i_dst.addr, addr);
+       rt->rt6i_dst.plen = 128;
+       rt->rt6i_idev     = idev;

       spin_lock_bh(&icmp6_dst_lock);
       rt->dst.next = icmp6_dst_gc_list;
@@ -1261,6 +1266,14 @@ int ip6_route_add(struct fib6_config *cfg)
       if (rt->rt6i_dst.plen == 128)
              rt->dst.flags |= DST_HOST;

+       if (!(rt->dst.flags & DST_HOST) && cfg->fc_mx) {
+               u32 *metrics = kzalloc(sizeof(u32) * RTAX_MAX, GFP_KERNEL);
+               if (!metrics) {
+                       err = -ENOMEM;
+                       goto out;
+               }
+               dst_init_metrics(&rt->dst, metrics, 0);
+       }
 #ifdef CONFIG_IPV6_SUBTREES
       ipv6_addr_prefix(&rt->rt6i_src.addr, &cfg->fc_src, cfg->fc_src_len);
       rt->rt6i_src.plen = cfg->fc_src_len;
@@ -1607,9 +1620,6 @@ void rt6_redirect(const struct in6_addr *dest,
const struct in6_addr *src,
       if (on_link)
               nrt->rt6i_flags &= ~RTF_GATEWAY;

-       nrt->rt6i_dst.plen = 128;
-       nrt->dst.flags |= DST_HOST;
-
       ipv6_addr_copy(&nrt->rt6i_gateway, (struct in6_addr*)neigh->primary_key);
       dst_set_neighbour(&nrt->dst, neigh_clone(neigh));

@@ -1754,9 +1764,10 @@ static struct rt6_info *ip6_rt_copy(const
struct rt6_info *ort,
       if (rt) {
               rt->dst.input = ort->dst.input;
               rt->dst.output = ort->dst.output;
+               rt->dst.flags |= DST_HOST;

               ipv6_addr_copy(&rt->rt6i_dst.addr, dest);
-               rt->rt6i_dst.plen = ort->rt6i_dst.plen;
+               rt->rt6i_dst.plen = 128;
               dst_copy_metrics(&rt->dst, &ort->dst);
               rt->dst.error = ort->dst.error;
               rt->rt6i_idev = ort->rt6i_idev;"
266,Dave Täht,2011-09-10 13:47:34.658328,rc6-smoketest7 will contain this patch
262,Andrew McGregor,2011-09-10 17:26:00.833877,"It's something to do with ICMP rate limiting in OS X.  I can reproduce it with my own openwrt build:

root@OpenWrt:~# ping 192.168.1.194
PING 192.168.1.194 (192.168.1.194): 56 data bytes
64 bytes from 192.168.1.194: seq=0 ttl=64 time=1.226 ms
64 bytes from 192.168.1.194: seq=1 ttl=64 time=87.782 ms
64 bytes from 192.168.1.194: seq=2 ttl=64 time=110.224 ms
64 bytes from 192.168.1.194: seq=3 ttl=64 time=0.996 ms
64 bytes from 192.168.1.194: seq=4 ttl=64 time=157.715 ms
64 bytes from 192.168.1.194: seq=5 ttl=64 time=180.557 ms
64 bytes from 192.168.1.194: seq=6 ttl=64 time=205.907 ms
64 bytes from 192.168.1.194: seq=7 ttl=64 time=22.846 ms
64 bytes from 192.168.1.194: seq=8 ttl=64 time=46.363 ms
64 bytes from 192.168.1.194: seq=9 ttl=64 time=1.137 ms
64 bytes from 192.168.1.194: seq=10 ttl=64 time=1.108 ms
64 bytes from 192.168.1.194: seq=11 ttl=64 time=1.061 ms
^C
--- 192.168.1.194 ping statistics ---
12 packets transmitted, 12 packets received, 0% packet loss
round-trip min/avg/max = 0.996/68.076/205.907 ms

But using UDP to generate port-unreachables:

root@OpenWrt:~# traceroute -q 40 192.168.1.194
traceroute to 192.168.1.194 (192.168.1.194), 30 hops max, 38 byte packets
 1  andrewm-lo.lan (192.168.1.194)  2.377 ms  0.970 ms  1.239 ms  1.286 ms  1.714 ms  1.615 ms  1.015 ms  1.360 ms  1.058 ms  1.287 ms  1.658 ms  1.638 ms  0.902 ms  1.118 ms  1.941 ms  1.005 ms  2.006 ms  0.874 ms  1.022 ms  1.595 ms  1.249 ms  1.086 ms  1.207 ms  1.227 ms  2.780 ms  1.817 ms  1.680 ms  1.221 ms  1.246 ms  1.291 ms  1.247 ms  1.430 ms  3.137 ms  0.930 ms  1.280 ms  1.610 ms  1.757 ms  0.967 ms  1.028 ms  1.232 ms
root@OpenWrt:~# traceroute -q 40 192.168.1.194
traceroute to 192.168.1.194 (192.168.1.194), 30 hops max, 38 byte packets
 1  andrewm-lo.lan (192.168.1.194)  1.515 ms  1.056 ms  1.675 ms  0.953 ms  0.935 ms  1.318 ms  1.005 ms  1.055 ms  0.945 ms  0.929 ms  0.925 ms  0.934 ms  1.775 ms  1.650 ms  1.015 ms  0.945 ms  0.940 ms  0.991 ms  0.995 ms  1.323 ms  0.963 ms  0.922 ms  1.675 ms  0.992 ms  1.180 ms  0.957 ms  0.917 ms  0.937 ms  1.142 ms  1.136 ms  1.129 ms  2.238 ms  1.913 ms  0.935 ms  0.894 ms  1.948 ms  0.915 ms  1.273 ms  2.085 ms  0.936 ms
root@OpenWrt:~# traceroute -q 40 192.168.1.194
traceroute to 192.168.1.194 (192.168.1.194), 30 hops max, 38 byte packets
 1  andrewm-lo.lan (192.168.1.194)  1.788 ms  1.014 ms  1.134 ms  1.563 ms  1.019 ms  0.924 ms  0.964 ms  1.024 ms  2.345 ms  1.317 ms  1.263 ms  0.967 ms  1.354 ms  1.716 ms  1.308 ms  1.407 ms  1.346 ms  1.191 ms  0.976 ms  0.928 ms  0.921 ms  1.411 ms  1.148 ms  1.662 ms  1.129 ms  1.144 ms  1.646 ms  1.269 ms  1.294 ms  1.356 ms  1.256 ms  2.389 ms  1.294 ms  1.275 ms  1.277 ms  0.972 ms  1.326 ms  0.991 ms  1.013 ms  0.929 ms

And TCP, single connection lots of requests (obviously running a netserver on my Mac):

root@OpenWrt:~# netperf -t TCP_RR 192.168.1.194 -- -r64,64
MIGRATED TCP REQUEST/RESPONSE TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to localhost (127.0.0.1) port 0 AF_INET : first burst 0
Local /Remote
Socket Size   Request  Resp.   Elapsed  Trans.
Send   Recv   Size     Size    Time     Rate         
bytes  Bytes  bytes    bytes   secs.    per sec   

16384  87380  64       64      10.00    7208.01   
16384  87380 

TCP again, this time moving 64 bytes per connection:

root@OpenWrt:~# netperf -t TCP_CRR 192.168.1.194 -- -r64,64
MIGRATED TCP Connect/Request/Response TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to localhost (127.0.0.1) port 0 AF_INET
Local /Remote
Socket Size   Request  Resp.   Elapsed  Trans.
Send   Recv   Size     Size    Time     Rate         
bytes  Bytes  bytes    bytes   secs.    per sec   

16384  87380  64       64      10.00    1067.20   
16384  87380 

That pretty conclusively shows that it's ICMP ping that is at fault here, not the network.

Andrew

On 11/09/2011, at 12:16 AM, cerowrt@lists.bufferbloat.net wrote:

> 
> Issue #262 has been updated by Frank Horowitz.
> 
> 
> Thanks for the response, Dave. 
> 
> I've reflashed to the latest rc6-smoketest6 (new since my last flash a few hours back) and this time blew away the old config and re-configured from scratch.
> 
> Results -- a similar scatter in pings to the MB Pro. 
> 
> root@Lirpo5:~# ping 172.30.42.67
> PING 172.30.42.67 (172.30.42.67): 56 data bytes
> 64 bytes from 172.30.42.67: seq=0 ttl=64 time=5.042 ms
> 64 bytes from 172.30.42.67: seq=1 ttl=64 time=98.623 ms
> 64 bytes from 172.30.42.67: seq=2 ttl=64 time=122.991 ms
> 64 bytes from 172.30.42.67: seq=3 ttl=64 time=1.346 ms
> 64 bytes from 172.30.42.67: seq=4 ttl=64 time=170.512 ms
> 64 bytes from 172.30.42.67: seq=5 ttl=64 time=194.345 ms
> 64 bytes from 172.30.42.67: seq=6 ttl=64 time=13.385 ms
> 64 bytes from 172.30.42.67: seq=7 ttl=64 time=37.313 ms
> 64 bytes from 172.30.42.67: seq=8 ttl=64 time=1.393 ms
> 64 bytes from 172.30.42.67: seq=9 ttl=64 time=84.963 ms
> ^C
> --- 172.30.42.67 ping statistics ---
> 10 packets transmitted, 10 packets received, 0% packet loss
> round-trip min/avg/max = 1.346/72.991/194.345 ms
> 
> This is on an 802.11g (sw00) channel, since there seems to be an issue with DNS on the .11a (sw10) channel. Interestingly enough, when I associate with the .11a guest (sw11) channel, the DNS works. (Go figure; would you like me to file a bug report on that?)
> 
> Similarly, on my old MB:
> root@Lirpo5:~# ping 172.30.42.87
> PING 172.30.42.87 (172.30.42.87): 56 data bytes
> 64 bytes from 172.30.42.87: seq=0 ttl=64 time=1955.677 ms
> 64 bytes from 172.30.42.87: seq=1 ttl=64 time=955.671 ms
> 64 bytes from 172.30.42.87: seq=2 ttl=64 time=0.937 ms
> 64 bytes from 172.30.42.87: seq=3 ttl=64 time=0.978 ms
> 64 bytes from 172.30.42.87: seq=4 ttl=64 time=44.255 ms
> 64 bytes from 172.30.42.87: seq=5 ttl=64 time=68.310 ms
> 64 bytes from 172.30.42.87: seq=6 ttl=64 time=91.991 ms
> 64 bytes from 172.30.42.87: seq=7 ttl=64 time=13.431 ms
> 64 bytes from 172.30.42.87: seq=8 ttl=64 time=36.923 ms
> 64 bytes from 172.30.42.87: seq=9 ttl=64 time=61.483 ms
> 64 bytes from 172.30.42.87: seq=10 ttl=64 time=84.531 ms
> ^C
> --- 172.30.42.87 ping statistics ---
> 12 packets transmitted, 11 packets received, 8% packet loss
> round-trip min/avg/max = 0.937/301.289/1955.677 ms
> 
> Next steps?
> 
> ----------------------------------------
> Bug #262: poor wireless performance in smoketest rc6
> https://www.bufferbloat.net/issues/262
> 
> Author: Aidan Williams
> Status: New
> Priority: Normal
> Assignee: 
> Category: 
> Target version: 
> 
> 
> Side by side comparison of Netgear and Cerowrt firmware shows that Cerowrt has significantly worse performance.
> 
> 91Mbps Netgear 5 GHz
> 78Mbps Netgear 2.4 GHz
> 20Mbps Smoketest rc6 5 GHz
> 17Mbps Smoketest rc6 2.4 GHz
> 
> Images attached show signal levels and the output from the Optus Sydney speedtester which is quite local to my home network.  The WiFi signal levels are comparable for both routers, so I don't think this is an RF issue.  There are some other APs in my area in the 2.4GHz band, but their levels are relatively low.
> 
> Notes:
> * 2 x WNDR7200v2 boxes
> * Netgear fw: 1.0.0.8
> * Mac OSX 10.6.8, Macbook Pro laptop
> * 3 feet between access points
> * 4 feet to the laptop which was more or less equidistant to the APs
> 
> 
>"
262,Dave Täht,2011-09-10 17:32:07.128553,"Man is that comforting! and confusing to the end user(s). If you can't trust ping, what can you trust?

Similarly we had a problem at ccnx yesterday where ping and normal traceroute worked... but tcptraceroute and lft showed that (most likely) the nat table on the pix in use there was overflowing. The local guys were saying - look! ping works! and wandering all over the auditorium with their laptops thinking it was a wireless problem, pinging away perfectly, when few could form a tcp connection.

Now I note that while this mystery re: ping may be resolved (reporters, please test using andrew's methods), we still have the bandwidth problems this bug started with, to deal with."
262,David Taht,2011-09-10 19:57:58.355515,"I'm puzzled as what mac80211 thing happened here. This is all git head
from openwrt...


---------- Forwarded message ----------
From: Dave Taht <dave.taht@gmail.com>
Date: Sat, Sep 10, 2011 at 7:52 PM
Subject: Re: [Bismark-devel] fighting an osx bug with wireless
To: Stephen Woodrow <srwoodrow@gmail.com>
Cc: bismark-devel@projectbismark.net


Thx for checking this out. You pulled a new version of mac80211 from
openwrt or elsewhere?

The numbers you are getting from openwrt are significantly better than
the numbers anybody else are getting.

The >100Mbit numbers you are seeing from the netgear suggest HT40 mode
is in use on the factory firmware.

Do you have HT40 on, on your build? (this is not a good idea on 2.4
ghz, but *might* be on the 5ghz). We were doing even worse at HT40.

Secondly, the current factory firmware is a later version, which is
what the others are testing against. (I am not asking you test that)


On Sat, Sep 10, 2011 at 7:42 PM, Stephen Woodrow <srwoodrow@gmail.com> wrote:
> Hi Dave,
>
> Srikanth and I did some unscientific testing using speedtest.net. The
> test was run from a MacBook Pro to a wndr3700v2 placed one router
> length away, and with all other 802.11abgn sources nearby turned off
> except for the gatech-provided wireless. The wndr was connected to the
> gatech wired network and we tested to the atlanta/comcast
> speedtest.net measurement server.
>
> Srikanth notes that he pulled an updated version of mac80211 from
> August 26 as suggested by nbd.
>
> Here's what we saw:
>
> openwrt r28087 (klatch-final) unencrypted / 5 GHz / channel 44:
> down: 87.87 (peaked at 90) Mbps
> up: 53.55 Mbps
>
> openwrt r28087 (klatch-final) / unencrypted / 2.4 GHz / channel 1:
> down: 71.68 Mbps
> up: 51.69 Mbps
>
> openwrt r28087 (klatch-final) / WPA2 PSK / 5 GHz / channel 44:
> down: 85.40 Mbps
> up: 53.24 Mbps
>
> openwrt r28087 (klatch-final) / WPA2 PSK / 2.4 GHz / channel 1:
> down: 61.78 Mbps
> up: 44.48 Mbps
>
> -------------------------------------------------
>
> Netgear V1.0.0.6NA / unencrypted / 5 GHz / channel 44:
> down: 159.05 Mbps
> up: 61.56 Mbps
>
> Netgear V1.0.0.6NA / unencrypted / 2.4 GHz / channel 1:
> down: 74.84 Mbps
> up: 51.65 Mbps
>
> Netgear V1.0.0.6NA / WPA2 PSK / 5 GHz / channel 44:
> down: 138.49 (peaked at 140) Mbps
> up: 61.43 Mbps
>
> Netgear V1.0.0.6NA / WPA2 PSK / 2.4 GHz / channel 1:
> down: 65.04 Mbps
> up: 51.82 Mbps
>
> So there is no significant performance hit on 2.4 GHz but a
> significant hit on 5 GHz. Not to the degree that your tester observed,
> but still significant (~45%). Hope you find this interesting/helpful.
>
> --steve
>"
262,Frank Horowitz,2011-09-10 21:40:46.283266,"Dave Täht wrote:
> Man is that comforting! and confusing to the end user(s). If you can't trust ping, what can you trust?
> <snip>
>(reporters, please test using andrew's methods), we still have the bandwidth problems this bug started with, to deal with.

OK. Agreed about the confusing parts!  Confirmatory evidence from here. I was seeing a similar ping scatter from my old stock OpenWRT router to the scatter observed on my wndr with rc6-smoketest6. 

The traceroute -q 40 test showed the following response times:
root@Lirpo5:~# traceroute -q 40 172.30.42.67
traceroute to 172.30.42.67 (172.30.42.67), 30 hops max, 38 byte packets
 1  dhcp-67.home.lan (172.30.42.67)  1.363 ms  3.018 ms  1.742 ms  1.371 ms  1.546 ms  1.158 ms  1.328 ms  1.338 ms  1.330 ms  2.004 ms  2.002 ms  1.383 ms  2.544 ms  2.076 ms  2.500 ms  1.471 ms  1.831 ms  0.984 ms  1.403 ms  1.685 ms  1.192 ms  1.186 ms  1.763 ms  1.369 ms  2.309 ms  3.192 ms  1.342 ms  1.299 ms  1.361 ms  1.321 ms  1.080 ms  1.687 ms  1.763 ms  1.675 ms  0.862 ms  1.618 ms  1.255 ms  1.177 ms  1.041 ms  0.956 ms
root@Lirpo5:~# traceroute -q 40 172.30.42.67
traceroute to 172.30.42.67 (172.30.42.67), 30 hops max, 38 byte packets
 1  dhcp-67.home.lan (172.30.42.67)  1.742 ms  1.335 ms  2.059 ms  1.916 ms  1.427 ms  1.372 ms  1.368 ms  1.851 ms  1.387 ms  1.183 ms  1.254 ms  1.246 ms  1.330 ms  1.173 ms  1.330 ms  0.991 ms  1.239 ms  1.498 ms  1.156 ms  1.621 ms  1.551 ms  1.257 ms  3.467 ms  1.362 ms  1.413 ms  1.787 ms  1.562 ms  2.016 ms  1.268 ms  0.987 ms  1.415 ms  1.111 ms  1.276 ms  1.367 ms  5.009 ms  1.448 ms  1.370 ms  6.687 ms  1.138 ms  1.144 ms

These are clearly within the realm of sane values, modulo the odd 5 to 6+ms readings. (This is still on the moderately congested .11g channel, due to the DNS issue Dave opened a new bug for earlier.)

The netperf test came back with ""Connection reset by peer"" for both the TCP_RR and TCP_CRR variants. Since I am not a netperf expert, I'll leave that to the gurus to interpret (firewall on OSX???)...

All of these tests were performed with network apps on the OSX box (such as Skype, mail.app, etc.) turned *off*.

Also, after some roundtrips to my local speedtest.net node, here in Perth, here is the output from the debug table requested by @Felix Fietkau a few days ago from my box:

 cat /sys/kernel/debug/ieee80211/phy*/ath9k/xmit
Num-Tx-Queues: 10  tx-queues-setup: 0x10f poll-work-seen: 65673
                            BE         BK        VI        VO
MPDUs Queued:            22634          0        17      5807
MPDUs Completed:         22625          0        17      3865
MPDUs XRetried:              9          0         0      1942
Aggregates:               1754          0         0         0
AMPDUs Queued HW:        76361          0        25         0
AMPDUs Queued SW:         9906          0         0         0
AMPDUs Completed:        86149          0         2         0
AMPDUs Retried:           2633          0       418         0
AMPDUs XRetried:           106          0        23         0
FIFO Underrun:               0          0         0         0
TXOP Exceeded:               0          0         0         0
TXTIMER Expiry:              0          0         0         0
DESC CFG Error:              0          0         0         0
DATA Underrun:               0          0         0         0
DELIM Underrun:              0          0         0         0
TX-Pkts-All:            108889          0        42      5807
TX-Bytes-All:         95378094          0      5073    988504
hw-put-tx-buf:               2          0         1         2
hw-tx-start:            103419          0       460      5807
hw-tx-proc-desc:        103419          0       460      5807
txq-memory-address:   832758e0   83275950  83275870  83275800
axq-qnum:                    2          3         1         0
axq-depth:                   0          0         0         0
axq-ampdu_depth:             0          0         0         0
axq-stopped                  0          0         0         0
tx-in-progress               0          0         0         0
pending-frames               0          0         0         0
txq_headidx:                 0          0         0         0
txq_tailidx:                 0          0         0         0
axq_q empty:                   0          1         0         0
axq_acq empty:                 1          1         1         1
txq_fifo[0] empty:             1          1         1         1
txq_fifo[1] empty:             1          1         1         1
txq_fifo[2] empty:             1          1         1         1
txq_fifo[3] empty:             1          1         1         1
txq_fifo[4] empty:             1          1         1         1
txq_fifo[5] empty:             1          1         1         1
txq_fifo[6] empty:             1          1         1         1
txq_fifo[7] empty:             1          1         1         1
Num-Tx-Queues: 10  tx-queues-setup: 0x10f poll-work-seen: 65665
                            BE         BK        VI        VO
MPDUs Queued:            21177          0         6      3222
MPDUs Completed:         21175          0         6      2689
MPDUs XRetried:              2          0         0       533
Aggregates:               4824          0         0         0
AMPDUs Queued HW:        91327          0         1         0
AMPDUs Queued SW:        15094          0         0         0
AMPDUs Completed:       106153          0         0         0
AMPDUs Retried:           3253          0        20         0
AMPDUs XRetried:           268          0         1         0
FIFO Underrun:               0          0         0         0
TXOP Exceeded:               0          0         0         0
TXTIMER Expiry:              0          0         0         0
DESC CFG Error:              0          0         0         0
DATA Underrun:               0          0         0         0
DELIM Underrun:              0          0         0         0
TX-Pkts-All:            127598          0         7      3222
TX-Bytes-All:        130959432          0       728    578192
hw-put-tx-buf:               2          0         1         2
hw-tx-start:            120875          0        27      3222
hw-tx-proc-desc:        120875          0        27      3222
txq-memory-address:   830ed8e0   830ed950  830ed870  830ed800
axq-qnum:                    2          3         1         0
axq-depth:                   0          0         0         0
axq-ampdu_depth:             0          0         0         0
axq-stopped                  0          0         0         0
tx-in-progress               0          0         0         0
pending-frames               0          0         0         0
txq_headidx:                 0          0         0         0
txq_tailidx:                 0          0         0         0
axq_q empty:                   0          1         0         0
axq_acq empty:                 1          1         1         1
txq_fifo[0] empty:             1          1         1         1
txq_fifo[1] empty:             1          1         1         1
txq_fifo[2] empty:             1          1         1         1
txq_fifo[3] empty:             1          1         1         1
txq_fifo[4] empty:             1          1         1         1
txq_fifo[5] empty:             1          1         1         1
txq_fifo[6] empty:             1          1         1         1
txq_fifo[7] empty:             1          1         1         1
root@Lirpo5:~# 
"
262,Frank Horowitz,2011-09-10 23:31:46.249392,"Possibly further to OSX ping and other wireless networking issues: 

http://www.stuartcheshire.org/papers/NagleDelayedAck/

Don't know the further implications for Cero. I hope this means the problem won't simply be ""written off"" as Apple's problem...
"
262,Andrew McGregor,2011-09-10 23:52:22.339098,"Important to benchmarking this stuff, although it is not in play in the present test, since Nagle has nothing to do with ICMP.

Also, of course, OS X Lion does not have the issue Stuart was writing about there (because he has long since fixed it, and I would expect there's an automated validation test in place to make sure it stays fixed).

On 11/09/2011, at 6:31 PM, cerowrt@lists.bufferbloat.net wrote:

> 
> Issue #262 has been updated by Frank Horowitz.
> 
> 
> Possibly further to OSX ping and other wireless networking issues: 
> 
> http://www.stuartcheshire.org/papers/NagleDelayedAck/
> 
> Don't know the further implications for Cero. I hope this means the problem won't simply be ""written off"" as Apple's problem...
> 
> ----------------------------------------
> Bug #262: poor wireless performance in smoketest rc6
> https://www.bufferbloat.net/issues/262
> 
> Author: Aidan Williams
> Status: New
> Priority: Normal
> Assignee: 
> Category: 
> Target version: 1st Public Cerowrt release
> 
> 
> Side by side comparison of Netgear and Cerowrt firmware shows that Cerowrt has significantly worse performance.
> 
> 91Mbps Netgear 5 GHz
> 78Mbps Netgear 2.4 GHz
> 20Mbps Smoketest rc6 5 GHz
> 17Mbps Smoketest rc6 2.4 GHz
> 
> Images attached show signal levels and the output from the Optus Sydney speedtester which is quite local to my home network.  The WiFi signal levels are comparable for both routers, so I don't think this is an RF issue.  There are some other APs in my area in the 2.4GHz band, but their levels are relatively low.
> 
> Notes:
> * 2 x WNDR7200v2 boxes
> * Netgear fw: 1.0.0.8
> * Mac OSX 10.6.8, Macbook Pro laptop
> * 3 feet between access points
> * 4 feet to the laptop which was more or less equidistant to the APs
> 
> 
>"
262,Aidan Williams,2011-09-11 01:49:03.947827,"I don't see how the underlying issue is to do with the Nagle algorithm, because the measurements initially reported used _same_ _endpoints_ and differences with middle boxes (Cerowrt and the stock Netgear firmware).

However, on MacOSX, the Nagle algorithm can be disabled thusly:
<pre>
sudo sysctl -w net.inet.tcp.delayed_ack=0
</pre>
"
262,Dave Täht,2011-09-11 09:46:57.748834,"In looking the wireless statistics over, I saw an interesting relationship going on in the VI queue:

What about the VI column makes sense to you?

<pre>
|AMPDUs Queued HW:        |76361          |0        |25         |0|
|AMPDUs Queued SW:         |9906          |0         |0         |0|
|AMPDUs Completed:        |86149          |0        | 2         |0|
|AMPDUs Retried:           |2633          |0       |418  (WTF?)  |     0|
|AMPDUs XRetried:           |106          |0        |23         |0|
</pre>

Now to add a data point to this, I had added support to babel to set skb->priority to 0x105, which dumps stuff into the VI queue.

Babel does *ipv6 multicast* only. I had actually not intended to foist this patch off on others in this smoketest!!! but it does raise interesting questions - is mac80211 handling multicast right in the general case (eg ipv6), what does happen when a packet is marked for a non-standard queue and is multicast. (there are multiple more normal ways for that to happen) 

Is there any way to clearly see management frames entering the proper (VO?) queue, as well as multicast in general?

I will rip that patch out of babel for rc6-smoketest7. As babel issues packets on 4 second intervals I have difficulty believing it is a cause of this problem but the patch is arguably wrong anyway. But please don't lose sight of the questions it raises.

smoketest7 is currently bottlenecked on bugs #266 and #265"
262,Dave Täht,2011-09-11 09:58:09.589411,"A major difference between cerowrt and regular openwrt is that we support 3 interfaces per channel, and have 8 /27 subnets defined by default - and do not bridge AT ALL. 

This was put in place to clearly delineate each of the interface types so that someone like me could look at a random packet trace and say aha! 172.30.42.98 is the 5.x ghz network interface - which is impossible otherwise - and not have to think about problems happening elsewhere on the gige or other radio. Significantly more info about the Cerowrt [[Device naming scheme]] and [[Default network numbering]]  are on the wiki.

Also it allows for a setup where we can setup a crypted link, an unencrypted link, and an adhoc link and test against those without having to reboot or reconfigure routers.

Also it reduces multicast/broadcast traffic considerably, while introducing new problems with dealing with things like multicast dns across devices - we have a mdnsresponder available for those folk that we hope will work.

Anyway, having a SSID and interface for the private, public, and ad-hoc wans - may also be introducing latencies and other difficulties like what we are seeing. It's hard to rip out the extra interfaces, you have to pretty much manually edit /etc/config/wireless /etc/config/network and /etc/config/firewall and /etc/config/babel and /etc/babeld.conf to rip them out. 

So overall, having just a general sense of the overhead of extra interfaces would be good. ?"
262,Dave Täht,2011-09-11 10:20:49.62568,"bugs #266 #267 and #265 may have some bearing on this problem, actually.

Disable babel /etc/init.d/babeld stop, watch for multiple nameds (ps | grep named), rerun tests, get stats..."
266,Dave Täht,2011-09-11 10:23:47.118929,well it would contain this patch if it applied against 3.0.4... looking it over now...
262,Jim Gettys,2011-09-11 10:36:18.07259,"Dave Täht wrote:
> A major difference between cerowrt and regular openwrt is that we support 3 interfaces per channel, and have 8 /27 subnets defined by default - and do not bridge AT ALL. 
> 
> This was put in place to clearly delineate each of the interface types so that someone like me could look at a random packet trace and say aha! 172.30.42.98 is the 5.x ghz network interface - which is impossible otherwise - and not have to think about problems happening elsewhere on the gige or other radio. Significantly more info about the Cerowrt [[Device naming scheme]] and [[Default network numbering]]  are on the wiki.
> 
> Also it allows for a setup where we can setup a crypted link, an unencrypted link, and an adhoc link and test against those without having to reboot or reconfigure routers.
> 
> Also it reduces multicast/broadcast traffic considerably, while introducing new problems with dealing with things like multicast dns across devices - we have a mdnsresponder available for those folk that we hope will work.
> 
> Anyway, having a SSID and interface for the private, public, and ad-hoc wans - may also be introducing latencies and other difficulties like what we are seeing. It's hard to rip out the extra interfaces, you have to pretty much manually edit /etc/config/wireless /etc/config/network and /etc/config/firewall and /etc/config/babel and /etc/babeld.conf to rip them out. 
> 
> So overall, having just a general sense of the overhead of extra interfaces would be good. ?

Yes, it would be good to quantify, but I don't think it's the problem here.

On the smoketest I installed at home just before coming out here, I got 48-50Mbps from my ath9k laptop, pretty consistent with what you might expect with only a 20mhz channel (the iwconfig line said the interface was running at 130 bit rate)."
262,Andrew McGregor,2011-09-11 14:54:39.367211,"My test had neither Babel nor multiple interfaces (but did bridge both radios and the lan together).  So, it's not Babel or multiple interfaces.

On 12/09/2011, at 5:36 AM, cerowrt@lists.bufferbloat.net wrote:

> 
> Issue #262 has been updated by Jim Gettys.
> 
> 
> Dave Täht wrote:
>> A major difference between cerowrt and regular openwrt is that we support 3 interfaces per channel, and have 8 /27 subnets defined by default - and do not bridge AT ALL. 
>> 
>> This was put in place to clearly delineate each of the interface types so that someone like me could look at a random packet trace and say aha! 172.30.42.98 is the 5.x ghz network interface - which is impossible otherwise - and not have to think about problems happening elsewhere on the gige or other radio. Significantly more info about the Cerowrt [[Device naming scheme]] and [[Default network numbering]]  are on the wiki.
>> 
>> Also it allows for a setup where we can setup a crypted link, an unencrypted link, and an adhoc link and test against those without having to reboot or reconfigure routers.
>> 
>> Also it reduces multicast/broadcast traffic considerably, while introducing new problems with dealing with things like multicast dns across devices - we have a mdnsresponder available for those folk that we hope will work.
>> 
>> Anyway, having a SSID and interface for the private, public, and ad-hoc wans - may also be introducing latencies and other difficulties like what we are seeing. It's hard to rip out the extra interfaces, you have to pretty much manually edit /etc/config/wireless /etc/config/network and /etc/config/firewall and /etc/config/babel and /etc/babeld.conf to rip them out. 
>> 
>> So overall, having just a general sense of the overhead of extra interfaces would be good. ?
> 
> Yes, it would be good to quantify, but I don't think it's the problem here.
> 
> On the smoketest I installed at home just before coming out here, I got 48-50Mbps from my ath9k laptop, pretty consistent with what you might expect with only a 20mhz channel (the iwconfig line said the interface was running at 130 bit rate).
> ----------------------------------------
> Bug #262: poor wireless performance in smoketest rc6
> https://www.bufferbloat.net/issues/262
> 
> Author: Aidan Williams
> Status: New
> Priority: Normal
> Assignee: 
> Category: 
> Target version: 1st Public Cerowrt release
> 
> 
> Side by side comparison of Netgear and Cerowrt firmware shows that Cerowrt has significantly worse performance.
> 
> 91Mbps Netgear 5 GHz
> 78Mbps Netgear 2.4 GHz
> 20Mbps Smoketest rc6 5 GHz
> 17Mbps Smoketest rc6 2.4 GHz
> 
> Images attached show signal levels and the output from the Optus Sydney speedtester which is quite local to my home network.  The WiFi signal levels are comparable for both routers, so I don't think this is an RF issue.  There are some other APs in my area in the 2.4GHz band, but their levels are relatively low.
> 
> Notes:
> * 2 x WNDR7200v2 boxes
> * Netgear fw: 1.0.0.8
> * Mac OSX 10.6.8, Macbook Pro laptop
> * 3 feet between access points
> * 4 feet to the laptop which was more or less equidistant to the APs
> 
> 
>"
113,Dave Täht,2011-09-11 20:50:28.241287,"it takes considerably longer than 1 second for dns to come up. For example, I've seen it take minutes to merely get an IP address from the external router/cable modem, etc.

I also took a look at the ntp code, because I wanted to implement dnssec-free lookups when the -g option was specified, and rapidly got bogged down in that to where I waved hands and said to self - self - convince a ntp code-base expert to do this patch. Don't know any except hal and dave hart."
238,Michael Graff,2011-09-12 13:50:22.356366,"-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Why not fix NTP to start with?

ntpd does not actually start running, and the bind 9 monitoring script
to enable dnssec seems to be using ntpdc to poll.

I think there is another ntp process that uses port 123, and killing
that off allows ntpd to start.

- --Michael

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.11 (Darwin)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org/

iEYEARECAAYFAk5ucA4ACgkQl6Nz7kJWYWbhNgCeOBGQg6MxusqD+qUG5GA9qdAC
0iAAn2HEtVZVgJliAN/9y0TpBHCchcMP
=Bxii
-----END PGP SIGNATURE-----"
238,Dave Täht,2011-09-12 15:48:10.563783,"yes, ntpdate getting spawned somehow is part of the problem. I am ripping that out entirely.

I should have fixed ntp in the first place, but this bug was long before I had a deep understanding of the right calls to make, and even then, I'd rather someone with a deep understanding of ntp and dnssec to tackle that, rather than me... if it was easy, I'd have done it...."
267,Frank Horowitz,2011-09-13 18:15:48.762815,"OK, A closer look reveals that the interface sw10 does not have an IP address, even though gw10 (and all the others) do.

Possibly related are the following ""bad number"" error messages from logread:

Sep 14 08:59:53 Lirpo5 daemon.warn radvd[4403]: resetting ipv6-allrouters membership on sw00
Sep 14 08:59:54 Lirpo5 daemon.notice ntpd[4468]: ntpd 4.2.6p3@1.2290-o Fri Sep  9 22:12:28 UTC 2011 (1)
Sep 14 08:59:54 Lirpo5 daemon.notice ntpd[4469]: proto: precision = 6.288 usec
Sep 14 08:59:54 Lirpo5 daemon.debug ntpd[4469]: ntp_io: estimated max descriptors: 1024, initial socket boundary: 16
Sep 14 08:59:54 Lirpo5 daemon.err ntpd[4469]: unable to bind to wildcard address 0.0.0.0 - another process may be running - EXITING
Sep 14 08:59:54 Lirpo5 user.info sysinit: sh: bad number
Sep 14 08:59:54 Lirpo5 user.info sysinit: sh: bad number
Sep 14 08:59:54 Lirpo5 user.info sysinit: sh: bad number
Sep 14 08:59:54 Lirpo5 user.info sysinit: sh: bad number
Sep 14 08:59:54 Lirpo5 user.info sysinit: setting up led WAN LED (green)
Sep 14 08:59:54 Lirpo5 kern.debug kernel: ar71xx-wdt: enabling watchdog timer
Sep 14 08:59:54 Lirpo5 user.info sysinit: Polipo is starting...

"
267,Frank Horowitz,2011-09-13 18:44:48.946825,"Found it. The config stanza for sw10 in /etc/config/network had some funky bridging and ifname lines. Commenting them out brings back the IP number assignment, (and presumably DNS et al.)..."
267,Dave Täht,2011-09-15 12:52:27.417203,thx! I'll fix this in rc6-smoketest8
267,Dave Täht,2011-09-15 13:02:16.151153,"or rather, I would, if that was a file showing problems in it. But it doesn't. So maybe something about the autogeneration of wifi interfaces messes with this. I will test before releasing smoketest8...."
267,Dave Täht,2011-09-15 17:32:45.764178,"the syntax of the /etc/config/network file had grown much pickier about quoting than previous. The quotes are now liberally throughout and appear to work. Smoketest9 will contain the fixes.

Thank you for the spot! as this disabled dhcp entirely on the main wireless interfaces it was very bad..."
266,Dave Täht,2011-09-15 18:19:42.649317,"given the chaos in the linux kernel trees due to the linux.org server problem, I felt that fixing this bug is going to have to wait until life settles down over there some.

"
266,Dave Täht,2011-09-15 18:21:57.721854,""
262,Dave Täht,2011-09-15 21:11:43.111448,"What (unless something terrible happens) is rc6...

Located 3 meters from the AP, with the 5ghz connection on channel 161 in HT40- mode, talking to my laptop (a lagn)

d@cruithne:~$ netperf -l 120 -H gw.home.lan
MIGRATED TCP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to gw.home.lan (172.30.42.33) port 0 AF_INET
Recv   Send    Send                          
Socket Socket  Message  Elapsed              
Size   Size    Size     Time     Throughput  
bytes  bytes   bytes    secs.    10^6bits/sec  

 87380  16384  16384    120.01     85.37   "
268,Dave Täht,2011-09-15 22:07:54.177268,"configuring it to use usegethostbyname=true works consistently with local, remote, and ipv6 resolvers."
269,Dave Täht,2011-09-15 22:38:47.291189,"the above numbers are with a txqueuelen of 8 on the router. txqueuelen of 1000 gets me:

[  5] local 149.20.63.20 port 5001 connected with 71.162.243.5 port 41100
[  5]  0.0-60.3 sec   183 MBytes  25.5 Mbits/sec


txqueuelen of 40 gets me:

root@OpenWrt:/etc/config# iperf -t 60 -w1m -c io.lab.bufferbloat.net
------------------------------------------------------------
Client connecting to io.lab.bufferbloat.net, TCP port 5001
TCP window size: 2.00 MByte (WARNING: requested 1.00 MByte)

------------------------------------------------------------
TCP window size: 2.00 MByte (WARNING: requested 1.00 MByte)
------------------------------------------------------------
[  3] local 192.168.1.220 port 41103 connected with 149.20.63.20 port 5001
[ ID] Interval       Transfer     Bandwidth
[  3]  0.0-60.0 sec   191 MBytes  26.6 Mbits/sec

So, obviously, we have a astrong interrelationship between txqueuelen, and the tcp window size.
"
262,Jim Gettys,2011-09-16 05:41:28.945121,"Dave Täht wrote:
> What (unless something terrible happens) is rc6...
> 
> Located 3 meters from the AP, with the 5ghz connection on channel 161 in HT40- mode, talking to my laptop (a lagn)
> 
> d@cruithne:~$ netperf -l 120 -H gw.home.lan
> MIGRATED TCP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to gw.home.lan (172.30.42.33) port 0 AF_INET
> Recv   Send    Send                          
> Socket Socket  Message  Elapsed              
> Size   Size    Size     Time     Throughput  
> bytes  bytes   bytes    secs.    10^6bits/sec  
> 
>  87380  16384  16384    120.01     85.37

Ok, this is more respectable.  I'll try to get some release notes done today from what we had on the white board.  

Per our discussion, it sounded like CeroWrt should not default to ht40 on 2.4 ghz and should on 5ghz, or that seemed to be your opinion, anyway, IIRC.
"
270,Dave Täht,2011-09-16 14:27:18.493372,"Well, it doesn't 'quite' do it just right. You need to setup at least one AHCP server node somewhere on the network to supply leases, ntp, and dns information.

That said, some indicator would be useful in some way."
262,Aidan Williams,2011-09-16 20:52:17.871784,"Dave Täht wrote:
> What (unless something terrible happens) is rc6...

I installed this:
http://huchra.bufferbloat.net/~cero1/cerowrt-wndr3700-1.0rc6/openwrt-ar71xx-generic-wndr3700v2-jffs2-sysupgrade.bin

Things have improved a lot...

Same test as at the beginning of this thread gives:

88Mbps Netgear 5 GHz
76Mbps Netgear 2.4 GHz
78Mbps rc6 5 GHz
67Mbps rc6 2.4 GHz

Is there an email list for monitoring checkins?  I looked on lists.bufferbloat.net/listinfo, but the ""commit"" lists seem unused or inactive...
"
262,Frank Horowitz,2011-09-16 22:13:23.092473,"OK. I also installed rc6(no smoketest). 

New results from the debug tables:

<pre>
root@Lirpo5:~# cat /sys/kernel/debug/ieee80211/phy*/ath9k/xmit
Num-Tx-Queues: 10  tx-queues-setup: 0x10f poll-work-seen: 559
                            BE         BK        VI        VO

MPDUs Queued:              172          0         0       759
MPDUs Completed:           172          0         0       673
MPDUs XRetried:              0          0         0        86
Aggregates:                  0          0         0         0
AMPDUs Queued HW:            0          0         0         0
AMPDUs Queued SW:            0          0         0         0
AMPDUs Completed:            0          0         0         0
AMPDUs Retried:              0          0         0         0
AMPDUs XRetried:             0          0         0         0
FIFO Underrun:               0          0         0         0
TXOP Exceeded:               0          0         0         0
TXTIMER Expiry:              0          0         0         0
DESC CFG Error:              0          0         0         0
DATA Underrun:               0          0         0         0
DELIM Underrun:              0          0         0         0
TX-Pkts-All:               172          0         0       759
TX-Bytes-All:            17380          0         0    132591
hw-put-tx-buf:               2          0         0         2
hw-tx-start:               172          0         0       759
hw-tx-proc-desc:           172          0         0       759
txq-memory-address:   831cd8e0   831cd950  831cd870  831cd800
axq-qnum:                    2          3         1         0
axq-depth:                   0          0         0         0
axq-ampdu_depth:             0          0         0         0
axq-stopped                  0          0         0         0
tx-in-progress               0          0         0         0
pending-frames               0          0         0         0
txq_headidx:                 0          0         0         0
txq_tailidx:                 0          0         0         0
axq_q empty:                   0          1         1         0
axq_acq empty:                 1          1         1         1
txq_fifo[0] empty:             1          1         1         1
txq_fifo[1] empty:             1          1         1         1
txq_fifo[2] empty:             1          1         1         1
txq_fifo[3] empty:             1          1         1         1
txq_fifo[4] empty:             1          1         1         1
txq_fifo[5] empty:             1          1         1         1
txq_fifo[6] empty:             1          1         1         1
txq_fifo[7] empty:             1          1         1         1
Num-Tx-Queues: 10  tx-queues-setup: 0x10f poll-work-seen: 550
                            BE         BK        VI        VO

MPDUs Queued:              443          0         1       140
MPDUs Completed:           443          0         1       135
MPDUs XRetried:              0          0         0         5
Aggregates:                 59          0         0         0
AMPDUs Queued HW:        18658          0         0         0
AMPDUs Queued SW:          261          0         0         0
AMPDUs Completed:        18918          0         0         0
AMPDUs Retried:             19          0         0         0
AMPDUs XRetried:             0          0         0         0
FIFO Underrun:               0          0         0         0
TXOP Exceeded:               0          0         0         0
TXTIMER Expiry:              0          0         0         0
DESC CFG Error:              0          0         0         0
DATA Underrun:               0          0         0         0
DELIM Underrun:              0          0         0         0
TX-Pkts-All:             19362          0         1       140
TX-Bytes-All:         24463657          0       104     22277
hw-put-tx-buf:               2          0         1         2
hw-tx-start:             19229          0         1       140
hw-tx-proc-desc:         19229          0         1       140
txq-memory-address:   831258e0   83125950  83125870  83125800
axq-qnum:                    2          3         1         0
axq-depth:                   0          0         0         0
axq-ampdu_depth:             0          0         0         0
axq-stopped                  0          0         0         0
tx-in-progress               0          0         0         0
pending-frames               0          0         0         0
txq_headidx:                 0          0         0         0
txq_tailidx:                 0          0         0         0
axq_q empty:                   0          1         0         0
axq_acq empty:                 1          1         1         1
txq_fifo[0] empty:             1          1         1         1
txq_fifo[1] empty:             1          1         1         1
txq_fifo[2] empty:             1          1         1         1
txq_fifo[3] empty:             1          1         1         1
txq_fifo[4] empty:             1          1         1         1
txq_fifo[5] empty:             1          1         1         1
txq_fifo[6] empty:             1          1         1         1
txq_fifo[7] empty:             1          1         1         1
root@Lirpo5:~# 
</pre>

So far, so good. "
267,Frank Horowitz,2011-09-16 22:16:29.353488,"No worries! ""All bugs are shallow, etc. etc. etc."" ;-)

Just confirming that rc6 has fixed the issue for me."
262,Frank Horowitz,2011-09-16 22:40:49.209369,"OK, a little after the above report, my wifi connection started yoyo-ing up and down, and I found the following debug tables (complete with nonzero VI entries in places that provoked a ""WTF?"" reaction from Dave earlier...):

<pre>
cat /sys/kernel/debug/ieee80211/phy*/ath9k/xmit
Num-Tx-Queues: 10  tx-queues-setup: 0x10f poll-work-seen: 1577
                            BE         BK        VI        VO

MPDUs Queued:              664          0         5      2197
MPDUs Completed:           664          0         5      1927
MPDUs XRetried:              0          0         0       270
Aggregates:                  6          0         0         0
AMPDUs Queued HW:          289          0         6         0
AMPDUs Queued SW:           37          0         0         0
AMPDUs Completed:          321          0         0         0
AMPDUs Retried:             96          0       117         0
AMPDUs XRetried:             5          0         6         0
FIFO Underrun:               0          0         0         0
TXOP Exceeded:               0          0         0         0
TXTIMER Expiry:              0          0         0         0
DESC CFG Error:              0          0         0         0
DATA Underrun:               0          0         0         0
DELIM Underrun:              0          0         0         0
TX-Pkts-All:               990          0        11      2197
TX-Bytes-All:           166749          0      1176    380758
hw-put-tx-buf:               2          0         1         2
hw-tx-start:              1063          0       128      2197
hw-tx-proc-desc:          1063          0       128      2197
txq-memory-address:   831cd8e0   831cd950  831cd870  831cd800
axq-qnum:                    2          3         1         0
axq-depth:                   0          0         0         0
axq-ampdu_depth:             0          0         0         0
axq-stopped                  0          0         0         0
tx-in-progress               0          0         0         0
pending-frames               0          0         0         0
txq_headidx:                 0          0         0         0
txq_tailidx:                 0          0         0         0
axq_q empty:                   0          1         0         0
axq_acq empty:                 1          1         1         1
txq_fifo[0] empty:             1          1         1         1
txq_fifo[1] empty:             1          1         1         1
txq_fifo[2] empty:             1          1         1         1
txq_fifo[3] empty:             1          1         1         1
txq_fifo[4] empty:             1          1         1         1
txq_fifo[5] empty:             1          1         1         1
txq_fifo[6] empty:             1          1         1         1
txq_fifo[7] empty:             1          1         1         1
Num-Tx-Queues: 10  tx-queues-setup: 0x10f poll-work-seen: 1567
                            BE         BK        VI        VO

MPDUs Queued:             1232          0         9       822
MPDUs Completed:          1232          0         7       505
MPDUs XRetried:              0          0         2       317
Aggregates:                197          0         0         0
AMPDUs Queued HW:        20285          0         7         0
AMPDUs Queued SW:          583          0         0         0
AMPDUs Completed:        20726          0         1         0
AMPDUs Retried:            615          0        96         0
AMPDUs XRetried:           141          0         6         0
FIFO Underrun:               0          0         0         0
TXOP Exceeded:               0          0         0         0
TXTIMER Expiry:              0          0         0         0
DESC CFG Error:              0          0         0         0
DATA Underrun:               0          0         0         0
DELIM Underrun:              0          0         0         0
TX-Pkts-All:             22099          0        16       822
TX-Bytes-All:         25205356          0      1728    106703
hw-put-tx-buf:               2          0         1         2
hw-tx-start:             22182          0       112       822
hw-tx-proc-desc:         22181          0       112       822
txq-memory-address:   831258e0   83125950  83125870  83125800
axq-qnum:                    2          3         1         0
axq-depth:                   1          0         0         0
axq-ampdu_depth:             1          0         0         0
axq-stopped                  0          0         0         0
tx-in-progress               0          0         0         0
pending-frames               0          0         0         0
txq_headidx:                 0          0         0         0
txq_tailidx:                 0          0         0         0
axq_q empty:                   0          1         0         0
axq_acq empty:                 1          1         1         1
txq_fifo[0] empty:             1          1         1         1
txq_fifo[1] empty:             1          1         1         1
txq_fifo[2] empty:             1          1         1         1
txq_fifo[3] empty:             1          1         1         1
txq_fifo[4] empty:             1          1         1         1
txq_fifo[5] empty:             1          1         1         1
txq_fifo[6] empty:             1          1         1         1
txq_fifo[7] empty:             1          1         1         1
</pre>

(Edited to add:) Just to clarify, this is on a MB Pro, under OSX Lion, using (mostly) the 802.11an/sw10 radio. I have set the Country Code to AU to match my location, left the .11bgn bandwidth to 20MHz, and set the .11an bandwidth to 40Mhz in my adjustments to the stock config. Also, just in case it matters, I've set WPA-PSK on the sw00 interface (to work around a bug in my Android phone's wireles), WPA/WPA2-PSK mixed mode on the gw00 and gw10 interfaces, and WPA2-PSK on the sw10 interface. Just in case any of that triggers an ""aha"" in one of you guru's head ;-)

"
266,David Taht,2011-09-17 05:12:58.561907,"This patch will need to go into rc7

---------- Forwarded message ----------
From: David Miller <davem@davemloft.net>
Date: Fri, Sep 16, 2011 at 9:57 PM
Subject: Re: [PATCH] ipv6: don't use inetpeer to store metrics for routes.
To: zheng.z.yan@intel.com
Cc: netdev@vger.kernel.org, eric.dumazet@gmail.com


From: ""Yan, Zheng"" <zheng.z.yan@intel.com>
Date: Tue, 06 Sep 2011 15:34:30 +0800

> Current IPv6 implementation uses inetpeer to store metrics for
> routes. The problem of inetpeer is that it doesn't take subnet
> prefix length in to consideration. If two routes have the same
> address but different prefix length, they share same inetpeer.
> So changing metrics of one route also affects the other. The
> fix is to allocate separate metrics storage for each route.
>
> Signed-off-by: Zheng Yan <zheng.z.yan@intel.com>

Applied, thanks for fixing this bug."
218,David Taht,2011-09-17 05:24:20.49935,"---------- Forwarded message ----------
From: Peter Naulls <peter@chocky.org>
Date: Fri, Sep 16, 2011 at 11:26 AM
Subject: [OpenWrt-Devel] Ath9k/hostapd connection dropping problems
To: OpenWrt Development List <openwrt-devel@lists.openwrt.org>



Some of this is speculation.  I wish I had more precise details. This is
true
of all trunk versions in last few weeks, when I started using my G300H (v2)
as an AP.  This includes upto version r28254, which includes yesterday's
mac80211 patches, but not today's spam fixes.

I have two Linux machines connecting to it.  After some amount of time - or
what seems more likely, data, the WiFi connections will drop.  If left
alone, they will come back after about 5 minutes.  But it's usually
faster to reboot the router.

I believe that:

* LAN side is unaffected.
* It happens after a certain about of traffic, rather than time, since it'll
be fine during the night when not much is happening, but be triggered during
a download etc during the day.
* Attempts to reproduce by running large amounts of traffic with iperf from
 WiFi -> Wired LAN have been inconsistent.
* In one case where I saw it triggered, I restarted hostapd, and it seemed
to
 come back, although NetworkManager on Ubuntu become confused, so I'm
 not certain.
* There is nothing of consequence in kernel logs, apart from regular
messages
 from hostapd about group key handshake.

So, I'm after ideas about more precise information I can gather, debug
I can turn on, etc, etc.


______________________________**_________________
openwrt-devel mailing list
openwrt-devel@lists.openwrt.**org <openwrt-devel@lists.openwrt.org>
https://lists.openwrt.org/**mailman/listinfo/openwrt-devel<https://lists.openwrt.org/mailman/listinfo/openwrt-devel>"
218,David Taht,2011-09-17 05:24:40.444007,"---------- Forwarded message ----------
From: Felix Fietkau <nbd@openwrt.org>
Date: Sat, Sep 17, 2011 at 12:28 AM
Subject: Re: [OpenWrt-Devel] Ath9k/hostapd connection dropping problems
To: OpenWrt Development List <openwrt-devel@lists.openwrt.org>


On 2011-09-17 8:50 AM, Felix Fietkau wrote:

> On 2011-09-17 1:54 AM, Peter Naulls wrote:
>
>>  On 09/16/2011 12:53 PM, Jim Henderson wrote:
>>
>>>  On Fri, 16 Sep 2011 15:08:15 -0400, Mark Deneen wrote:
>>>
>>>
>>>  In the end, I ended up reverting to build 27572, which I knew worked
>>>  prior to the upgrade.
>>>
>>
>>  I reverted the mac80211 package only to 27572 earlier today, and it seems
>> to now
>>  be working correctly.  Felix? ;-)
>>
> 27572 is very old, please test 28092
>
Actually, please test 27957 instead.

______________________________**_________________
openwrt-devel mailing list
openwrt-devel@lists.openwrt.**org <openwrt-devel@lists.openwrt.org>
https://lists.openwrt.org/**mailman/listinfo/openwrt-devel<https://lists.openwrt.org/mailman/listinfo/openwrt-devel>"
267,Dave Täht,2011-09-17 05:26:31.241795,so I (or you) can close this bug?
262,Dave Täht,2011-09-17 05:51:11.131306,"There is nothing specifically inside of cerowrt code in rc6 that tosses stuff into the VI queue, although there are several ways to enter it, with packets with a dscp value, so_priority, or a genuine bug somewhere else.

We can find ways to do gnarly things to streams however to beat up on the VI queue code, using iptables, to exercise this problem more,
using for example, iperf, which sits on ports 5000-5002

"
262,Dave Täht,2011-09-17 06:04:43.079901,"We are still groping empirically for more correct values for txqueuelen than what they are set to. (and note that txqueuelen as currently defined in linux MUST GO in favor of something sized more dynamically)

For example, for *raw* ethernet performance, (see #269 ) I can get 440Mbit/sec out of txqueuelen 64 on the router to another host going out interface ge00 on the same switch at gigE. txqueuelen of 8 - as currently set to - I get ~200Mbit. If I up the device driver buffers slightly I can get 530Mbit (which, btw, is better than the factory firmware can achieve) to another device on the same switch.

Not that this is the right thing for an uplink that is running at speeds far lower than that, NOR is it the right thing for stuff going out longer distances and paths, as calculated by BDP - and a pure BDP calculation doesn't account for interrupt overhead, queueling overhead, or other buffering going on in the kernel such as that on the recieve path. ALSO: I got very interesting results by upping the maximum TCP window size via sysctl as per #269 for iperf testing, both on the router itself (when driving the tests) and on the laptop (driving the tests through the router to the lab)

Similarly, txqueuelen of 37 on the various wireless interfaces is about the right compromise for single streams running at ~60Mbit, as seen in testing so far. I wouldn't mind if - now that we can regularly crack 60Mbit on wireless, we tried higher values for txqueuelen on wireless interfaces so long as the testers understand that they are compromising latency and wireless-g performance by doing so - AND we move towards testing multiple streams with various tools.

The place to fiddle with txqueuelen is /etc/hotplug.d/iface/00-debloat

Thx everybody for playing with this stuff. Understanding how the current kernel responds to tweaking is very important to coming up with  dynamic algorithms that do more of the right thing. I will try to make the various test boxes at [[bloatlab 1]] more accessible to all soon, with more tests...."
246,Dave Täht,2011-09-17 09:38:05.10137,"09/17/2011 09:33:51 AM) swalker: syncing mac80211.sh to https://dev.openwrt.org/changeset/28198 looks good for https://www.bufferbloat.net/issues/246

will fix in rc7"
262,Dave Täht,2011-09-17 09:55:57.779795,"<pre>
(07:28:32 AM) nbd: latest might work better
(07:29:06 AM) dtaht99: how latest? :) I have some positive reports on what became rc6, which was from 2? 3 days back.
(07:29:13 AM) dtaht99: the VI queue weirdness bothers me a lot
(07:29:42 AM) dtaht99: http://www.bufferbloat.net/issues/262#note-44
(07:30:08 AM) nbd: i fixed some potential encryption related bugs today
(07:30:14 AM) nbd: what's weird about the VI queue?
(07:30:39 AM) dtaht99: AMPDUs Completed:          321          0         0         0 AMPDUs Retried:             96          0       117         0 AMPDUs XRetried:             5          0         6         0
(07:30:41 AM) dtaht99: meh
(07:30:51 AM) nbd: so?
(07:30:59 AM) dtaht99: see completed, queued, retried in the vi queue in the above bug note
(07:31:21 AM) dtaht99: why 0 completed, and 117 retried?
(07:31:32 AM) dtaht99: and 6 queued
(07:31:32 AM) nbd: oh, right
(07:31:34 AM) nbd: that's weird
(07:31:37 AM) dtaht99: very
(07:31:56 AM) dtaht99: could be as simple as the logging routine sending stuff to the wrong place
(07:32:01 AM) nbd: yeah
(07:32:03 AM) dtaht99: but I doubt it.
(07:32:05 AM) nbd: i'll take a look at the logging stuff
(07:32:15 AM) dtaht99: the problem is
(07:32:45 AM) dtaht99: http://www.bufferbloat.net/issues/262#note-43
(07:33:07 AM) dtaht99: statistically, the odds of getting the VI queue thing happening should have happened by note-43, if it were merely a logging bug.
(07:34:55 AM) dtaht99: also, you'd asked me for good values for txqueuelen, and that's a hard question
(07:35:06 AM) dtaht99: answer #1 - 1000 is the wrong answer. :)
(07:35:24 AM) dtaht99: answer #2 - it really has to be dynamic in the long run
(07:36:03 AM) nbd: ok, it's not a logging bug
(07:36:04 AM) dtaht99: answer #3 - pretty good range of results as noted in this bug and bug 269 - but this is all the results of single stream tests
(07:36:07 AM) nbd: and the output makes some sense
(07:36:15 AM) ***dtaht99 awaits enlightenment
(07:36:17 AM) nbd: xretried mpdus are not reported as completed
(07:36:28 AM) nbd: well, it's partially a logging bug
(07:36:36 AM) nbd: each sw retransmit attempt counts
(07:37:43 AM) nbd: i should add logging for reporting how often frames are filtered
(07:37:55 AM) dtaht99: AMPDUs Retried: is a retry of an entire ampdu or just the failed packets?
(07:38:13 AM) dtaht99: I mean, 6 queued in hardware, and 117 retried doesn't make a whole lot of sense
(07:38:24 AM) nbd: just failed subframe
(07:38:36 AM) dtaht99: that's a lot of failures in that ratio
(07:38:44 AM) nbd: yes
(07:38:49 AM) nbd: could be powersave related crap
(07:38:49 AM) nbd: not sure
(07:39:08 AM) dtaht99: possible the length of the VI queue needs to be shorter for ampdu calculations?
(07:39:33 AM) dtaht99: I was under the impression the size of that transmission window was MUCH smaller than BE
(07:40:21 AM) nbd: length of the VI queue? what does that have to do with this?
(07:40:35 AM) dtaht99: how many packets can be aggregated in the VI queue
(07:40:41 AM) dtaht99: vs the BE queue
(07:41:19 AM) ***dtaht99 freely admits to being stupid about how these variables interrelate
(07:41:53 AM) dtaht99: http://en.wikipedia.org/wiki/IEEE_802.11e-2005
(07:42:04 AM) dtaht99: Video (AC_VI) 15 31 2 3.008ms
(07:42:22 AM) dtaht99: meh, was trying to paste from the edca table in that wikipedia entry
(07:42:59 AM) dtaht99: max txop of 3.008 ms for VI
(07:44:08 AM) dtaht99: (that also said, I have no idea what is sending packets into the VI queue in the first place at present. best way to exercise this code is to toss some iptables rules in to exercise that queue with some test tool)
(07:44:14 AM) dtaht99: (and I note I'm packing for france
(07:45:07 AM) nbd: i think it uses the same 4ms limit for all queues
(07:45:09 AM) dtaht99: as you are packing for america) and I gotta run shortly. just wanted to get a snapshot of your status...
(07:45:13 AM) dtaht99: hmmm...
(07:45:50 AM) dtaht99: a little exercise is called for, methinks. But I lack time and my hardware is packed away (actually, given to esr)
(07:45:55 AM) dtaht99: no worries
(07:45:59 AM) dtaht99: catch ya later"
262,Dave Täht,2011-09-17 09:56:16.02201,""
218,Dave Täht,2011-09-17 09:58:10.148693,""
265,Dave Täht,2011-09-17 11:04:24.756135,""
256,Dave Täht,2011-09-17 11:07:12.243146,"luci was including ntpclient support by default, which pulled ntpdate in. 

ntp -g does the right thing (a replacement for ntpdate), so I ripped this module out of luci for now.

the luci ntpclient module is removed in rc6. a better suggestion would be good around all the time/dnssec bugs"
243,Dave Täht,2011-09-17 11:10:09.528886,fixed in rc6
252,Dave Täht,2011-09-17 12:12:00.900519,I have some thought towards bug #266 being a source of this problem
203,Stephen Walker,2011-09-17 12:44:10.6848,"Missing @gw:depends(""proto"", ""dhcp"")@ at line 218 in /usr/lib/lua/luci/model/cbi/admin_network/ifaces.lua?"
267,Frank Horowitz,2011-09-17 15:40:54.745188,""
203,Dave Täht,2011-09-17 17:23:01.213213,"@stephen

that's probably it. I have no commit privs to any of the main openwrt repos, do you have such to the luci one?

I will try your suggestion against something myself, soon, but my next week is going to be eaten by travel and relocation issues. 

I do plan to finally learn enough lua to at least do patches that small with some clue... on the plane to paris."
98,Dave Täht,2011-09-17 17:39:57.908358,We need to truly validate the 6to4 rules for rc7 or rc8
239,Dave Täht,2011-09-17 17:42:29.592856,"Michael: 

So what is the best way to go forward on this? IPv6 MUST work with minimal configuration. We have a problem already in that as 2002 addresses are dynamically assigned, there is seemingly no easy way to pass this information to bind9 after addresses are acquired. 

Is there an internal network acl type we can use to recognise local ipv6 networks that get assigned ips after startup? I'm willing to trust those, but I'd prefer to trust the entire /48 by default, so long as it's on an 'inside' interface."
233,Dave Täht,2011-09-17 17:44:09.733222,"I have this (1 line) patch, somewhere in my mail, but can't find it anywhere, nor remember who it came from.

what is stopping this patch from ending up in bind itself? Carrying out of tree patches is no fun."
240,Dave Täht,2011-09-17 17:44:40.036245,""
195,Dave Täht,2011-09-17 17:52:32.144664,We are getting absolutely spectacular ethernet performance out of this puppy now.
238,Dave Täht,2011-09-17 17:56:30.463655,"This is fixed in rc6, or so I think. luci was firing up ntpdate, blocking ntp and ntpc entirely."
238,Dave Täht,2011-09-17 17:57:01.172446,"that said, I have no idea how named could get fired up multiple times from xinetd."
264,Dave Täht,2011-09-17 17:58:28.157796,We need to comprehensively nail these problems to the ground for rc7.
207,Dave Täht,2011-09-17 17:59:19.118589,I can now consistently get polipo to fail with it's internal resolver.
269,Dave Täht,2011-09-17 18:01:55.941853,""
224,Dave Täht,2011-09-17 18:02:34.933142,""
186,Dave Täht,2011-09-17 18:03:21.530277,""
139,Dave Täht,2011-09-17 18:03:44.871421,""
113,Dave Täht,2011-09-17 18:09:21.253128,"I have found the dns circular dependency problem annoying enough to want to hack ntp up to DO THE RIGHT THING myself.

but I keep hoping someone with familiarity with the ntp codebase will take a stab at it. I looked, and the 'right thing' is to revalidate after you get enough time servers to get time so dnssec can validate...."
205,Dave Täht,2011-09-17 18:09:57.559114,""
233,Evan Hunt,2011-09-17 23:23:25.793227,"The patch will end up in BIND as a switch you can turn on, eventually.  It's not really proper pinky-raised DNS, so I don't think it should be on by default with no ability to turn it off."
203,Stephen Walker,2011-09-18 08:02:25.270464,"Dave Täht wrote:
> @stephen
> 
> that's probably it. I have no commit privs to any of the main openwrt repos, do you have such to the luci one?

I don't.

jow?
"
265,David Taht,2011-09-18 13:00:17.748231,"confirmed to be a real, and easily fixable bug. I wonder what the
effects of this one are?

And to what extent it may affect ipv6?


---------- Forwarded message ----------
From: Eric Dumazet <eric.dumazet@gmail.com>
Date: Sun, Sep 18, 2011 at 12:35 PM
Subject: Re: [BUG?] tcp: potential bug in tcp_is_sackblock_valid()
To: ""Yan, Zheng"" <zheng.z.yan@intel.com>
Cc: ""netdev@vger.kernel.org"" <netdev@vger.kernel.org>,
""davem@davemloft.net"" <davem@davemloft.net>,
herbert@gondor.apana.org.au, ""sfr@canb.auug.org.au""
<sfr@canb.auug.org.au>


Le vendredi 09 septembre 2011 à 09:45 +0800, Yan, Zheng a écrit :
> Hi all,
>
> I found a check in tcp_is_sackblock_valid() is suspicious. It against
> its comment and RFC. I think the correct check should be:
>
> ---
> diff --git a/net/ipv4/tcp_input.c b/net/ipv4/tcp_input.c
> index 385c470..a5d01b1 100644
> --- a/net/ipv4/tcp_input.c
> +++ b/net/ipv4/tcp_input.c
> @@ -1124,7 +1124,7 @@ static int tcp_is_sackblock_valid(struct tcp_sock *tp, int is_dsack,
>                 return 0;
>
>         /* ...Then it's D-SACK, and must reside below snd_una completely */
> -       if (!after(end_seq, tp->snd_una))
> +       if (after(end_seq, tp->snd_una))
>                 return 0;
>
>         if (!before(start_seq, tp->undo_marker))
> ---

Acked-by: Eric Dumazet <eric.dumazet@gmail.com>

This bug was introduced in 2.6.24 by commit 5b3c9882"
272,Jim Gettys,2011-09-19 13:10:50.187231,
272,David Taht,2011-09-19 13:14:44.645907,"I'd sent this comment to the list:

""I note that while the improvement above is enormous, a 403ms RTT for
a packet is the rough equivalent of a detour around all of planet Earth...
between your couch and the AP.

Can outliers of this sort be improved?

At what point are packets dropped?"""
247,Jim Gettys,2011-09-19 15:56:13.083589,
253,Jim Gettys,2011-09-19 15:56:13.44232,
270,Jim Gettys,2011-09-19 15:56:14.238582,
229,Jim Gettys,2011-09-19 16:06:22.694919,
272,Dave Täht,2011-09-20 03:52:24.875031,"I note that this is not a specific to cerowrt bug, just a note to myself to check the multicast routine for correctness overall."
98,Jim Gettys,2011-09-20 10:19:21.9738,""
113,Jim Gettys,2011-09-20 10:19:53.123092,""
205,Jim Gettys,2011-09-20 10:20:32.691737,""
89,Jim Gettys,2011-09-20 10:22:28.292272,""
90,Jim Gettys,2011-09-20 10:22:28.946045,""
95,Jim Gettys,2011-09-20 10:22:29.359681,""
99,Jim Gettys,2011-09-20 10:22:29.877623,""
110,Jim Gettys,2011-09-20 10:22:30.594803,""
122,Jim Gettys,2011-09-20 10:22:31.159801,""
123,Jim Gettys,2011-09-20 10:22:32.673034,""
140,Jim Gettys,2011-09-20 10:22:34.975905,""
145,Jim Gettys,2011-09-20 10:22:36.603349,""
147,Jim Gettys,2011-09-20 10:22:37.773982,""
175,Jim Gettys,2011-09-20 10:22:39.593325,""
176,Jim Gettys,2011-09-20 10:22:40.114323,""
227,Jim Gettys,2011-09-20 10:22:40.822184,""
261,Jim Gettys,2011-09-20 10:22:41.395708,""
95,Jo-Philipp Wich,2011-09-20 11:29:08.65181,"There's another prerequisite for this, we need some code that aligns the in-kernel timezone with whatever is configured in userspace to avoid mismatches between kernel and userspace time representation.
Gargoyle has a little C program for that but its license status is unclear so we should not simply pull it. The issue is also tracked at https://dev.openwrt.org/ticket/9657

I think the best place to implement the time syncing would be within the busybox ""date"" applet, in the existing time setting code."
260,Jim Gettys,2011-09-20 11:31:49.168112,"This problem appears to be present still in real RC6.  Plugged directly into the router serving as my home router, it dhcp's on the wan port fine and works.
"
273,Dave Täht,2011-09-20 12:58:39.743387,"6RD IS built as part of the sit kernel module, and thus, available by default.

CONFIG_IPV6_SIT=m
CONFIG_IPV6_SIT_6RD=y

HOWEVER - comcast had required a tiny patch (buried in a gigabyte svn dump) to do something or other, and also sort of
had an openwrt script that went with that. So that code's out there. What's required in places like France, 
remains unknown.

I'll be in a pretty good place to test it in about 24 hours. "
260,Dave Täht,2011-09-20 12:59:49.102161,"We need to find a way to reproduce this in front of a developer that has this switch AND problem.

I was unable to reproduce in a similar environment."
95,Dave Täht,2011-09-20 13:05:31.738361,"Does anybody really know what time it is? 

Concur with jow's comments....

and

I dislike the always-on-check the darn time firewall rule as I originally described above. 

Checking every packet AND the current time for a couple mac addrs is a lot of overhead to keep your kids in bed.

Cron inserting a rule would be better, as part of a syn-related chain, check these params. (this wouldn't keep gamers out tho)

"
273,Jim Gettys,2011-09-20 13:24:28.796378,"Probably you won't need much of anything.

The Comcast mod was a hack so they didn't have to deploy an updated DHCP server to hand out the addresses.  That would have cost them 6 months or more in starting their 6rd trial.  And since that trial is mercifully over, ditching any dregs of it and having a blog standard 6rd implementation is the ""right thing"" to do.
"
260,Jim Gettys,2011-09-20 13:26:53.452272,"OK, I'll get a new switch ordered so that I can take the existing one that seems to trigger it out of service (mercifully), and we can reproduce it in front of someone able to debug it.
"
260,Jim Gettys,2011-09-20 13:33:35.552626,"Weirder and weirder.  I thought that the switch in question was a 100Mbit switch; instead, it's a netgear 108p (8 port 10/100/1000Mbit POE switch).  Additionally, I have another level of switching beyond this (a d-Link 2208).  So I need to do a bit more debugging, and plug the router one step back (directly into the netgear) first to confirm at what level the problem is.
"
260,Dave Täht,2011-09-20 14:24:51.55951,I'll argue it's at the number of levels it's at... rule of thumb: never connect more than 3 switches together.
260,Jim Gettys,2011-09-20 16:17:52.706898,"Yeah, but the factory firmware coped ok, when I tried it before.

I'll do a more systematic round of tests in the morning.
"
229,Jim Gettys,2011-09-21 13:19:22.639141,"I just renumbered with the sed scripts in the wiki to 192.168.1.x, hoping I'd win.  I lost.

I note that [[Default network numbering]] says that 
<pre>
1-30: secured area for other machines
33-65: secured area for wired
</pre>

Here's the thing: I did an informal poll of my Bell Labs co-workers I'm about to inflict CeroWrt on.  About half of them have static, existing numbering plans.

In my personal case, my static addresses are all in the 1-30 range; I suspect that's going to be common (or hope so, anyway).

So I suspect the two areas should be swapped to reduce the amount of renumbering required.

"
229,Dave Täht,2011-09-21 16:24:11.165982,"Exactly. I basically reserved the bottomost range for static ips. The other ranges are all dynamic (well, the firstmost 
address in each range is excluded from dhcp's dynamic lease assignment)

that said, this can be improved."
229,Dave Täht,2011-09-21 16:26:36.231307,"So, here's an option:

we change to 172.30.42.1 as the base address of the router.

We use a /26 in this case, to give us 1-62 as valid ips.

We reserve 34-62 as dynamically addressed space.

This DOES mess up the dmz idea - where my 'plan' such as it was was to have the dmz on a different vlan."
229,Jim Gettys,2011-09-21 17:06:48.290314,"Well, right now, I can't access 192.168.1.13 (or similar addresses).  I doubt I'll be the last.
My colleagues seem to all be using 192.168.1 addresses as their plan.

A DMZ VLAN would be nice someday; but the interesting question also being begged is how do we deal with a VLAN for an IPsec tunnel... DMZ's, however, in the IPv4 world are hard for most to come by, given IPv4 address shortage.

For now, I suspect KISS is in order.
"
229,David Taht,2011-09-21 17:24:43.341125,"That's more or less my fault in the current design as I had several requests for
vlan support early on. And, I suspect, we'll hav emore.

In your case.

change /etc/config/network to use a 255.255.255.192 netmask instead of 224
for the se00 device, change it to 192.168.1.1, and tell
/etc/config/dhcp to start
at 34 for that interface

as I described later in the bug

I'm going to bed

On Wed, Sep 21, 2011 at 5:06 PM,  <cerowrt@lists.bufferbloat.net> wrote:
>
> Issue #229 has been updated by Jim Gettys.
>
>
> Well, right now, I can't access 192.168.1.13 (or similar addresses).  I doubt I'll be the last.
> My colleagues seem to all be using 192.168.1 addresses as their plan.
>
> A DMZ VLAN would be nice someday; but the interesting question also being begged is how do we deal with a VLAN for an IPsec tunnel... DMZ's, however, in the IPv4 world are hard for most to come by, given IPv4 address shortage.
>
> For now, I suspect KISS is in order.
>
> ----------------------------------------
> Feature #229: Renumbering interfaces is painful via the web interface
> https://www.bufferbloat.net/issues/229
>
> Author: Dave Täht
> Status: New
> Priority: High
> Assignee: David Taht
> Category: UI
> Target version: 1st Public Cerowrt release
>
>
> with 6 interfaces, and a dns server, and access to the router controlled by iptables and xinetd, it's hard to renumber interfaces to have a different subnet allocation - and ipv6 is also problematic.
>
> I have a simple script that does 95% of the work that could be improved to also be accessible via luci ""renumber/rename home network"" - which would eliminate the tedium.
>
>"
229,David Taht,2011-09-21 17:28:32.058496,"To clarify that slightly, what you did wrong (I think) - was put a new /27 up
in the 0-31 address space, with no router IP address for it. Due to it being a
/27 it can't see any means of getting anywhere, so it goes boom.

to kind of keep the dmz idea alive, we COULD just do an alias for
se00:0 of 192.168.1.1
but that leads to all sorts of hassle on the same physical wire.

Ah, well, it can move to the end of the address space. Trust me, there
are many vlan freaks out there.

On Wed, Sep 21, 2011 at 5:24 PM, Dave Taht <dave.taht@gmail.com> wrote:
> That's more or less my fault in the current design as I had several requests for
> vlan support early on. And, I suspect, we'll hav emore.
>
> In your case.
>
> change /etc/config/network to use a 255.255.255.192 netmask instead of 224
> for the se00 device, change it to 192.168.1.1, and tell
> /etc/config/dhcp to start
> at 34 for that interface
>
> as I described later in the bug
>
> I'm going to bed
>
> On Wed, Sep 21, 2011 at 5:06 PM,  <cerowrt@lists.bufferbloat.net> wrote:
>>
>> Issue #229 has been updated by Jim Gettys.
>>
>>
>> Well, right now, I can't access 192.168.1.13 (or similar addresses).  I doubt I'll be the last.
>> My colleagues seem to all be using 192.168.1 addresses as their plan.
>>
>> A DMZ VLAN would be nice someday; but the interesting question also being begged is how do we deal with a VLAN for an IPsec tunnel... DMZ's, however, in the IPv4 world are hard for most to come by, given IPv4 address shortage.
>>
>> For now, I suspect KISS is in order.
>>
>> ----------------------------------------
>> Feature #229: Renumbering interfaces is painful via the web interface
>> https://www.bufferbloat.net/issues/229
>>
>> Author: Dave Täht
>> Status: New
>> Priority: High
>> Assignee: David Taht
>> Category: UI
>> Target version: 1st Public Cerowrt release
>>
>>
>> with 6 interfaces, and a dns server, and access to the router controlled by iptables and xinetd, it's hard to renumber interfaces to have a different subnet allocation - and ipv6 is also problematic.
>>
>> I have a simple script that does 95% of the work that could be improved to also be accessible via luci ""renumber/rename home network"" - which would eliminate the tedium.
>>
>>"
229,Jim Gettys,2011-09-21 17:30:25.79006,"David Taht wrote:
> To clarify that slightly, what you did wrong (I think) - was put a new /27 up
> in the 0-31 address space, with no router IP address for it. Due to it being a
> /27 it can't see any means of getting anywhere, so it goes boom.
> 
>

All I did was run the sed scripts from the wiki.
"
229,Dave Täht,2011-09-21 17:32:00.685712,"but then you had a .13 fixed ip address.

there is no address range for .13 that has a router ip on it."
276,Jim Gettys,2011-09-22 15:44:54.080661,"Seems likely this is some sort of SNMP broadcast protocol being used to discover the printers on the network, according to CUPS documentation.

http://www.cups.org/documentation.php/network.html
"
276,Dave Täht,2011-09-22 18:31:43.033965,"Just to verify, the jetdirect protocol itself, works across the networks, it's just discovery that is borked?

I note that guests should NOT be able to access printer resources on the secure lan.

As for addressing this:

samba can run on the router, providing a central rendezvous point for printer information.
mdns - if implemented, and I thought it was in cups LONG ago, should also be able to do the trick,
but this would be a good test."
276,Jim Gettys,2011-09-22 19:37:22.041246,"It's the discovery of the printer (via snmp broadcast) that seems to be the problem here, if I read my tea leaves right. The cups configuration stuff on Linux (and maybe mac) seems to use it to find printers when configuring a new printer.

To confirm this theorya, we need to do a little bit of wire sniffing.

This begs the question of how common this use of snmp broadcast is in other applications and operating systems.
"
261,Dave Täht,2011-09-23 09:25:52.801164,"is that the sed script changes from home.lan to yourdomain.whatever. I note that home.lan is entirely a fiction - there is no rfc1918 for private domain systems, although the .lan is a fairly common convention.

That said, I personally find it confusing to have three entirely separate namespaces AND databases for dns (.local, .lan, and whatever you use as your main domain), and would prefer NOT to continue using .lan after converting to a real domain such as thegettys.net.

.lan cannot be published to the main dns, among other problems.

Similarly, the proper usage of the subdomain system and views basically makes the idea of gw.hm.thegettys.net sanest - where thegettys.net is a dns server and web server located in the cloud, and hm.thegettys.net is the one located on the gateway. This eliminates hits to the main dns server(s) and simplifies view management.
"
261,Jim Gettys,2011-09-23 10:03:30.517991,"I am mostly concerned that we have a single name to find the administration of the network in the docs; I don't care if it is another domain for any other services, or any other hosts appear in said domain.
"
249,Dave Täht,2011-09-23 10:17:55.830584,"There is an ongoing conversation at: https://github.com/dtaht/Diffserv/issues/1 that discusses this issue thoroughly. The difference in tcp socket options between ipv6 and ipv4 has not been properly addressed until now in any ipv6 application that I know of, for example
openssh doesn't get it right, either.

https://lists.bufferbloat.net/pipermail/bloat-devel/2011-August/000215.html

from that conversation:
<pre>
IPv6 DiffServ

IPv4   IPPROTO_IP     IP_TOS
IPv6   IPPROTO_IPV6   IPV6_TCLASS

So, to set the DSCP in IPv6 you must use IPv6 Traffic Class field.

int ds = IPTOS_DSCP_AF11;
int rc = setsockopt(fd, IPPROTO_IPV6, IPV6_TCLASS, &ds, sizeof(ds));
if (rc < 0) do_log_error(L_WARN, errno, ""Couldn't set TC"");

Notes:

    You use 'socket_prio' instead of 'ds'.
    You are aware that the DS field is an IP level option
    and that there is a socket level 'SO_PRIORITY' option?
    You're not mistakenly setting the socket's priority value as the DSCP?

    You use an option length of '1'.
    However, the setsockopt() code that I've seen use an optlen of 'sizeof(int)'.

    Hopefully you this will close Issue 249.
</pre>

So, great, we have the right way to set the traffic class in ipv6 now defined. I think. 

Now to push it out to dozens of applications."
261,Dave Täht,2011-09-23 11:42:14.014309,"the search path supplied in the good old days would let you say: http://gw

and have that work

these days multiple browsers try to substitute solutions to the above."
277,Dave Täht,2011-09-24 08:22:04.107936,""
249,Dave Täht,2011-09-24 09:37:37.823696,"See also:

https://github.com/dtaht/Diffserv/issues/5

I didn't know that netinet/ip.h already had most of these definitions!"
166,Dave Täht,2011-09-24 17:07:05.321787,"As I am not working on these portions of this project I thought I would document where things were when I left, and assign the problems back to the PM. I do confess to being interested in what the answers become or became.

# django, if kept, needs to become fastcgi in particular. (?)
# Apache is under configured (?)
# there is no user authentiation or privacy features in place: - recently I clicked on network dashboard and ended up viewing someone elses data
# the postgres database needs to be configured and tuned up: I did only modest tuning of the database BEFORE the upgrade to dp4. It would need to be redone
# dns is unconfigured: callisto was intended for this work
# there is no ipv6: ?
# the box is out of date: believed fixed"
50,Dave Täht,2011-09-24 17:11:58.749168,"After pulling the latest head while prepping for the cerowrt rc7 series, I get the following error when trying to build ditg. 

</pre>

/home/cero1/src/cerowrt/staging_dir/target-mips_r2_uClibc-0.9.32/host/bin/g++-uc -O2 -pipe -mips32r2 -mtune=mips32r2 -fno-caller-saves -fhonour-copts -msoft-float -I/home/cero1/src/cerowrt/staging_dir/target-mips_r2_uClibc-0.9.32/usr/include -I/home/cero1/src/cerowrt/staging_dir/target-mips_r2_uClibc-0.9.32/include -I/home/cero1/src/cerowrt/staging_dir/toolchain-mips_r2_gcc-4.5-linaro_uClibc-0.9.32/usr/include -I/home/cero1/src/cerowrt/staging_dir/toolchain-mips_r2_gcc-4.5-linaro_uClibc-0.9.32/include -DMULTIPORT -DARM -DLINUX_OS -Wall -Wno-deprecated -fPIC -c newran2.cpp
newran2.cpp: In member function 'virtual Real Extreme_Largest::Next()':
newran2.cpp:93:28: error: call of overloaded 'log(long double&)' is ambiguous
/home/cero1/src/cerowrt/staging_dir/toolchain-mips_r2_gcc-4.5-linaro_uClibc-0.9.32/lib/gcc/mips-openwrt-linux-uclibc/4.5.4/../../../../mips-openwrt-linux-uclibc/sys-include/bits/mathcalls.h:123:1: note: candidates are: double log(double)
/home/cero1/src/cerowrt/staging_dir/target-mips_r2_uClibc-0.9.32/usr/include/uClibc++/cmath:91:15: note:                 float std::log(float)
newran2.cpp:94:26: error: call of overloaded 'log(long double)' is ambiguous
/home/cero1/src/cerowrt/staging_dir/toolchain-mips_r2_gcc-4.5-linaro_uClibc-0.9.32/lib/gcc/mips-openwrt-linux-uclibc/4.5.4/../../../../mips-openwrt-linux-uclibc/sys-include/bits/mathcalls.h:123:1: note: candidates are: double log(double)
/home/cero1/src/cerowrt/staging_dir/target-mips_r2_uClibc-0.9.32/usr/include/uClibc++/cmath:91:15: note:                 float std::log(float)
make[5]: *** [newran2.o] Error 1
make[5]: Leaving directory `/home/cero1/src/cerowrt/build_dir/target-mips_r2_uClibc-0.9.32/D-ITG-2.8.0-rc1/src/ITGSend/newran'
make[4]: *** [newran/libnewran.a] Error 2
make[4]: Leaving directory `/home/cero1/src/cerowrt/build_dir/target-mips_r2_uClibc-0.9.32/D-ITG-2.8.0-rc1/src/ITGSend'
make[3]: *** [ITGSend] Error 2
make[3]: Leaving directory `/home/cero1/src/cerowrt/build_dir/target-mips_r2_uClibc-0.9.32/D-ITG-2.8.0-rc1/src'
make[2]: *** [/home/cero1/src/cerowrt/build_dir/target-mips_r2_uClibc-0.9.32/D-ITG-2.8.0-rc1/.built] Error 2
make[2]: Leaving directory `/home/cero1/src/cerowrt/feeds/packages/net/ditg'
make[1]: *** [package/feeds/packages/ditg/compile] Error 2
make[1]: Leaving directory `/home/cero1/src/cerowrt'
make: *** [package/ditg/compile] Error 2

</pre?>"
104,Dave Täht,2011-09-24 17:13:50.202251,"To my knowledge the final version of the preliminary database had the capability to add this feature via views.

"
192,Dave Täht,2011-09-24 17:14:35.894068,This was fixed long ago.
253,Dave Täht,2011-09-24 17:50:29.37059,""
259,Dave Täht,2011-09-24 17:50:53.360746,""
278,Dave Täht,2011-09-25 05:15:49.700735,This will be fixed in the first rc7 smoketest
246,Dave Täht,2011-09-25 05:16:45.390902,This will hopefully be fixed in the first rc7 smoketest.
246,Richard Smith,2011-09-25 14:14:06.498824,Tried to test with rc7 smoke1 but was unable to because when I go to the network tab in the web UI it hangs and I eventually have to let the browser (tried both chrome and firefox) kill the script.  I'll retry in the next smoketest.
246,Dave Täht,2011-09-26 07:48:30.1554,"@richard: I'll let you know when I have a stable smoketest to test. rc7-smoketest2 has problems, too, but not the one you've hit."
282,Dave Täht,2011-09-30 06:10:23.531369,"The current version of cerowrt is not independently buildable with that script.

I will be producing an improved version and separate patches in the rc7-smoketest
series. Sorry, but due to the chaos in the linux kernel.org process and my own
pending vacation, and recent travel to france, things got disorganized....

Please come see me (today) and I can get you a working build in about 10 minutes 
that doesn't use that script."
282,Marc Franco,2011-09-30 06:47:23.753551,"Many many thanks Dave! Im new in cerowrt but I think thats is very interesting!!
In script is >> git://huchra.bufferbloat.net/git/cerofiles.git that not work..

I waiting for rc7. I try to build system for routerboard.

Thanks! 

"
278,Stephen Walker,2011-09-30 14:19:44.644031,"Broken on the latest rc7 smoketest:
@root@OpenWrt:~# wifi up
[...]
Configuration file: /var/run/hostapd-phy1.conf
HT40 channel pair (40, 1) not allowed
Interface initialization failed
[...]@

Cerofiles' mac80211.sh needs to use channel 36 or 44 when using HT40+ per the freq table at http://hostap.epitest.fi/gitweb/gitweb.cgi?p=hostap.git;a=blob;f=hostapd/hostapd.conf;hb=HEAD#l381.

OpenWrt's mac80211.sh is currently using channel 36."
278,Dave Täht,2011-10-03 14:08:23.584209,"I will use 36 in rc7-smoketest4 (this is still broken in smoketest3). Thx for the heads up. I would prefer frankly to not use 36 or 44, but something higher, as to not conflict with other APs by default."
282,Dave Täht,2011-10-03 14:12:07.033184,"At present cerowrt is VERY specific to the wndr3700v2, specifically the atheros (ath9k) chipset . I do hope that with some minor effort it can be ported to the routerstation -- but I don't know what's in the routerboard? 

Most of the core changes to the drivers and underlying architecture are pushed up into openwrt. A description of what's different about cerowrt in general is in the release notes for rc6.

http://www.bufferbloat.net/projects/cerowrt/wiki/OCEAN_CITY_RELEASE_NOTES"
278,Stephen Walker,2011-10-03 18:07:28.650761,"Dave Täht wrote:
> I would prefer frankly to not use 36 or 44, but something higher, as to not conflict with other APs by default.

The much higher 149 or 157 are available."
282,Marc Franco,2011-10-04 01:16:45.669958,"Hello,

Routerboard contains:
CPU: Atheros AR7161
wireless radio can be any ath9k chipset.


But I can try to build because is not working for me.

Thanks for all information Dave!"
282,Dave Täht,2011-10-06 12:42:56.696832,"I have revised the build instructions to have a note regarding the kernel.org problem and a workaround, AND have hopefully fixed the script to be more general.

http://www.bufferbloat.net/projects/cerowrt/wiki/Building_Cerowrt_on_your_own_machine

I do not garuntee anything at this point... but give this a shot."
282,Dave Täht,2011-10-06 13:28:35.547477,"Meh. There are still a few problems left. I need to push things up and solve #113 somehow.

But the above should get you started."
278,Dave Täht,2011-10-09 08:25:18.25183,"http://huchra.bufferbloat.net/~cero1/rc7-smoketests/rc7-smoketest4/

has HT40+ enabled on channel 36. It's also from openwrt head."
283,Fabian Schneider,2011-10-17 05:44:30.073573,What kind of data are we talking about?
283,ahlem reggani,2011-10-17 05:50:06.46265,""
283,ahlem reggani,2011-10-17 05:55:24.885332,"We are testing this page with Dave to coordinate our tasks for the project. Dave was thinking that we are using bcruiser for stroing bismark data. Anyway, We still need bcruiser for our tests with the testbed I think, also it can be a good place to store data as we are the only one using this machine in contrary of Cmon where everybody is in."
283,David Taht,2011-10-17 05:57:13.516635,"In my case I was hoping to have a box that could:

Host a local mirror of key resources: bismark, a bismark build, various
sources
Have packet captures from a variety of sources for future analysis
A web server that could host various forms of tools
A postgres database that can store intermediate analytical results

Etc."
283,Fabian Schneider,2011-10-17 06:19:57.616736,"Hi,

ok. My vision was to use bcruiser as a machine to host all the build tools and generate some workload in the testbed. I should also host a development version of the server tools. But as we will not easily get a public IP for it i cannot host the production server for this we need to use cmon, from which we can make backups to figaro in case the RAID 5 in cmon is not enough.

best
Fabian"
283,David Taht,2011-10-17 06:32:14.95168,"(I am still working out the bugs with project setup, you should be able
to interact with it via email
and that is failing at present. Seeing if this alias works now)


On 10/17/2011 03:19 PM, redmine@lists.bufferbloat.net wrote:
> Issue #283 has been updated by Fabian Schneider.
>
>
> Hi,
>
> ok. My vision was to use bcruiser as a machine to host all the build tools and generate some workload in the testbed. I should also host a development version of the server tools. But as we will not easily get a public IP for it i cannot host the production server for this we need to use cmon, from which we can make backups to figaro in case the RAID 5 in cmon is not enough.
>
> best
> Fabian
> ----------------------------------------
> Feature #283: working server 
> https://www.bufferbloat.net/issues/283
>
> Author: ahlem reggani
> Status: New
> Priority: Urgent
> Assignee: 
> Category: 
> Target version: Home Deployment Test 
>
>
> It is necessary to store data somewhere safe! on a machine that doesn't crash 
>
>"
283,David Taht,2011-10-17 06:39:11.561909,"On 10/17/2011 03:19 PM, redmine@lists.bufferbloat.net wrote:
> Issue #283 has been updated by Fabian Schneider.
>
>
> Hi,
>
> ok. My vision was to use bcruiser as a machine to host all the build tools and generate some workload in the testbed. 

I shared that vision. I still share that vision, I am just a little
frustrated with this box right now.

While fast, being able to crash it while under even the lightest
workload is not helpful. The only idea I have left is that it needs
better cooling over the network area of the motherboard, which requires
finding a new fan for it...

> I should also host a development version of the server tools. But as we will not easily get a public IP for it i cannot host the production server for this we need to use cmon, from which we can make backups to figaro in case the RAID 5 in cmon is not enough.
>

So you do have a real public IP on cmon? How filtered is it?

Proxying, Port forwarding and/or vpn tunneling can be used to present a
view of the necessary tools (web/ssh/rsync/whatever) from the outside
server(s) to the inside server(s)

It is certainly useful to keep some data off the public internet!

The only vpn technology I've been able to get through the current
firewall has been openvpn over tcp - which is about the worst choice
available, but ok for short, non-lossy hops.

Do you have control of DNS for a subdomain of your project? If not I can
delegate a subdomain off of bufferbloat.net... or a domain could be
registered. I did a quick search to find that ahlnem.org is not registered."
283,David Taht,2011-10-17 06:41:48.242734,"OK, I have fixed the email gateway interface to redmine. I hope.

Sending messages to a [#283] or whatever ticket number in the subject
will comment on a ticket.

Sending one without a subject should create a new ticket.

Let's see what happens."
286,Dave Täht,2011-10-17 06:44:13.400279,.vcf attachments have to get filtered out. They are annoying!
283,Dave Täht,2011-10-17 06:47:40.62923,""
283,Fabian Schneider,2011-10-17 06:54:20.768744,"> So you do have a real public IP on cmon? How filtered is it?
> 
> Proxying, Port forwarding and/or vpn tunneling can be used to present a
> view of the necessary tools (web/ssh/rsync/whatever) from the outside
> server(s) to the inside server(s)

We already use it for receiving the Hostview traces. I thought we could just use the same mechanism.
Which is sftp at the moment, using vsftpd to restrict the uploading user to only upload files.
I can dig out the configuration tomorrow. Hostview uses curl to upload, so we should be able to do the same, no?
Also there is an apache running on cmon.
 
> It is certainly useful to keep some data off the public internet!

Never intended to do otherwise.

> The only vpn technology I've been able to get through the current
> firewall has been openvpn over tcp - which is about the worst choice
> available, but ok for short, non-lossy hops.

I think we can avoid VPNs.

> Do you have control of DNS for a subdomain of your project? If not I can
> delegate a subdomain off of bufferbloat.net... or a domain could be
> registered. I did a quick search to find that ahlnem.org is not registered.

No we do not. But at this point in time i also do not think that this would be necessary.
And i suppose it will be very hard to convince the universities IT department of the necessity of another domain. If we want we can get a dns entry for xxxx.lip6.fr.
What is 'Ahlnem', except Ahlem's name being spelled incorrect? Is it the project name?"
283,ahlem reggani,2011-10-17 07:01:59.65976,Yes It is. Analysing Home Local Network Environments & Management 
283,David Taht,2011-10-17 07:05:34.678493,"On 10/17/2011 03:54 PM, ahlnem@lists.bufferbloat.net wrote:
>> So you do have a real public IP on cmon? How filtered is it?
>>
>> Proxying, Port forwarding and/or vpn tunneling can be used to present a
>> view of the necessary tools (web/ssh/rsync/whatever) from the outside
>> server(s) to the inside server(s)
> We already use it for receiving the Hostview traces. I thought we could just use the same mechanism.
> Which is sftp at the moment, using vsftpd to restrict the uploading user to only upload files.

OK. I note that bismark had major issues with their original security
architecture, which involved shipping around ssh host keys willy-nilly.

> I can dig out the configuration tomorrow. Hostview uses curl to upload, so we should be able to do the same, no?
curl is a good choice, but how do you authenticate?
> Also there is an apache running on cmon.

excellent.
>  
>> It is certainly useful to keep some data off the public internet!
> Never intended to do otherwise.
>

Much of bismark and all of cerowrt are very, very public. Only the data
collected is held private.

The outside source code repositories are all held on github as well as
on various other open sites. I'm not sure if bismark is independently
buildable at present, it was, at one point - but I haven't been paying
attention of late.

>> The only vpn technology I've been able to get through the current
>> firewall has been openvpn over tcp - which is about the worst choice
>> available, but ok for short, non-lossy hops.
> I think we can avoid VPNs.
>
I can't. Bloatlab one

http://www.bufferbloat.net/projects/cerowrt/wiki/BloatLab_1

is only managable via vpn. It has a dozen web servers, ssh accounts,
etc, all behind a pair of firewalls... It simply never occurred to me
that vpn technology would be blocked when I left the USA.....

I'm managing as best I can but have to admit that openvpn over tcp over
a 170 ms path is horrible...

>> Do you have control of DNS for a subdomain of your project? If not I can
>> delegate a subdomain off of bufferbloat.net... or a domain could be
>> registered. I did a quick search to find that ahlnem.org is not registered.
> No we do not. But at this point in time i also do not think that this would be necessary.
> And i suppose it will be very hard to convince the universities IT department of the necessity of another domain. If we want we can get a dns entry for xxxx.lip6.fr.

That would be useful. I'm terrible at remembering ip addresses, much
better at names.
A subdomain delegation of of lip6.fr is even more useful.

> What is 'Ahlnem', except Ahlem's name being spelled incorrect? Is it the project name?

Analysis of home local network environments and management.

A nearly completely unique name that will end up number 1 on google if
ever published, and we needed a name of any sort to start hanging things
off of for the project.

Other backronyms or project names gladly welcomed."
283,Fabian Schneider,2011-10-17 07:06:30.264696,"Hi,

oh cool. Good name.

best
Fabian

On 17.10.2011, at 16:01, ahlnem@lists.bufferbloat.net wrote:

> 
> Issue #283 has been updated by ahlem reggani.
> 
> 
> Yes It is. Analysing Home Local Network Environments & Management 
> ----------------------------------------
> Feature #283: working server 
> https://www.bufferbloat.net/issues/283
> 
> Author: ahlem reggani
> Status: New
> Priority: Urgent
> Assignee: 
> Category: 
> Target version: Home Deployment Test 
> 
> 
> It is necessary to store data somewhere safe! on a machine that doesn't crash 
> 
>"
283,Dave Täht,2011-10-20 11:43:43.06505,"I got a fan for battlecruiser. Did not install it.

I got a replacement fan for my laptop. Did not install it.

Bought a new laptop. Installed it.

Can return yours in the morning."
283,ahlem reggani,2011-10-20 11:51:36.145407,"You can keep it for awhile, nobody use it nowadays. Take your time."
288,David Taht,2011-10-21 19:11:42.547978,"-------- Original Message --------
Subject: 	Re: plot
Date: 	Fri, 21 Oct 2011 16:25:16 +0200
From: 	Fabian Schneider <fabian@ieee.org>
To: 	David Täht <dave.taht@gmail.com>
CC: 	Jim Gettys <jg@freedesktop.org>, Kathleen Nichols 
<nichols@pollere.com>



Hi,

>  Obviously I need to learn enough R to be able to do this sort of analysis myself. In the interim, since I'm doing a similar experiment monday (this time varying either classification of ping or the queue-ing algorithm, not the buffer size - I haven't decided which), we'd love to see your script in the hope I can immediately use it in the class...

Ok. lets see. I created something that should ease up the plotting. See attached tar archive and sample plot. To summarize there is a Makefile which plots the data and expects:
- p1.txt and p2.txt as input (which should be the logs from the ping command)
- awk and sed to be installed and in the path
- GNU R to be installed and in the path

What it does is:
1.) extracts the RTT timeseries 'hopefully' covering the download period, by looking for the ping sequence number (SEQ) with maximum RTT (MAX) and considering all RTTs from SEQ-100 to SEQ+100.
2.) replacing all timeouted pings with an RTT value of MAX+100ms, where the 100ms can be configured in the BEGIN clause of the awk script.
3.) plot the two time series.

What it includes:
- extract.timeseries.awk (performs steps 1+2)
- plotit.R (performs step 3)
- Makefile (wrapper)
- p*.txt example input files

>  As for these plots, what I'd like:
>
>  the Y axis to stay in the the same range of 0 - 1000 ms

(for the combined plot i determine the maximum RTT and use that as an upper bound)

>  the X axis to be 100 seconds long, showing the idle period, the spike, the idle period.

(i opted for a 200 second = 200 ping samples period instead)

>  the two plots to be directly comparable, using a different color for the ping 'dots', and roughly the same start time, so I can overlay them...

already done. Only one output plot.

>  1) start time is uncontrolled (but close enough, given the length of transfer)

you can 'tune' the input data and have the input file start at a chosen point in time that is less than 100 seconds before the maximum to achieve this.
(I did not want to get into more sophisticated methods for determining the download period from the data, sofar)

>  4) tcpdump on at least several stations would be VERY interesting. Dario says you were seeing some interesting duplicate acks - I still haven't verified we've actually FIXED the stack enough to get reliable results.

No what we saw is ping reporting ""(DUP!)"" behind some lines.

>  Would you be interested in following up this line of work with a paper w/me/etc?

sure.

best
Fabian"
288,David Taht,2011-10-21 19:18:50.788213,"I just wanted to express how (other than the dup ping issue) utterly 
happy I am with the attached txqueuelen37 vs 1000 plot.

txqueuelen 37 REALLY works vs 1000 - and the real sources of the 
bottlenecks have moved to the clients, not the AP. On to testing queue 
management!

Is 37 the right number? don't know. Is it a better number than 1000 - 
you betcha!

Andrew, are you still thinking 100 is better for google's iw10 mice attack?"
288,Dave Täht,2011-10-21 19:29:00.151722,"oh, I forgot to mention what REALLY tweaked me (athough it's not shared by the remainder of the data set and is probably totallllly a matter of mere misfortune) and made me jump at shadows like this one.

first dup is packet 67
second dup is packet 104.

104-67 = 37, which is my txqueuelen."
282,Petri Rosenström,2011-10-27 03:46:52.515716,"I updated the wiki page and tested the instructions with a fresh ubuntu install that it *should* work.

http://www.bufferbloat.net/projects/cerowrt/wiki/Building_Cerowrt_on_your_own_machine"
291,Dave Täht,2011-10-28 08:16:02.115632,"I think it would be be mildly better to have it recognise this for a 3800 actually. I will compare the two devices however to make sure there are no other sigificant differnces (switch, mac, etc)"
282,Dave Täht,2011-10-28 08:21:39.206076,"It would be good to have a 3rd person duplicate the procedure before we can call it 'baked'. Jim?

Also I suppose we are getting close to being able to build a vm...

and I have to update that build script to let people build from a tagged release."
291,Petri Rosenström,2011-10-28 22:20:12.35822,"If we want to we could fix this. I found a way to do it. Tested it and works. With the patch everything looks like it should.

cat /proc/cpuinfo 
system type             : Atheros AR7161 rev 2
machine                 : NETGEAR WNDR3800
processor               : 0
cpu model               : MIPS 24Kc V7.4
BogoMIPS                : 452.19
wait instruction        : yes
microsecond timers      : yes
tlb_entries             : 16
extra interrupt vector  : yes
hardware watchpoint     : yes, count: 4, address/irw mask: [0x0000, 0x0ff8, 0x0ff8, 0x0ff8]
ASEs implemented        : mips16
shadow register sets    : 1
kscratch registers      : 0
core                    : 0
VCED exceptions         : not available
VCEI exceptions         : not available

But make sure that there are no significant difference with the hardware. I don't have a wndr3700v2 to compare against.
"
291,Dave Täht,2011-10-29 12:10:54.376544,"Explicitly identifing a wndr3800 as a wndr3800 will need a /etc/defconfig/ set of files created.

However, I'll give it a shot on smoketest8 and then we can run it past jow... I am interested to see what more memory does to (for example) the default tcp window calculation (which is FAR TOO SMALL) that I currently override in /etc/sysctl.conf for the 3700v2."
292,Dave Täht,2011-10-29 12:13:51.017095,Steve: is gdisk worth porting to openwrt?
262,David Taht,2011-10-29 13:42:00.543205,"OK, I've minimally tested cerowrt rc7-smoketest7 against debloat-testing

the new qfq qdisc hangs the ethernet interface (at least in my testing 
thus far, and it's not a default, just something new I wanted to try). 
Maybe I've just configured it wrong....

Aside from that, it seems happy. I am off to test the VI queue + ipv6 
next...

It DID occur to me that txqueuelen 40 made no sense on adhoc interfaces 
that can't aggregate, so I'll fix that next time. Or hope aggregation 
makes it to adhoc

1) txqueuelen 1000 on the laptop (connected 8 cm from the AP)

d@cruithne:~/org$ netperf -l 60 -H 172.30.42.97
MIGRATED TCP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 
172.30.42.97 (172.30.42.97) port 0 AF_INET
Recv   Send    Send
Socket Socket  Message  Elapsed
Size   Size    Size     Time     Throughput
bytes  bytes   bytes    secs.    10^6bits/sec

  87380  65536  65536    60.17      46.17

Weirdness here:  3.1.0-rc4-dbt23
Intel Corporation PRO/Wireless 5100 AGN

wlan0     IEEE 802.11abgn  ESSID:""CEROwrt5""
           Mode:Managed  Frequency:5.18 GHz  Access Point: 
A0:21:B7:B0:56:67
           Bit Rate=150 Mb/s   Tx-Power=15 dBm
           Retry  long limit:7   RTS thr:off   Fragment thr:off
           Power Management:off
           Link Quality=70/70  Signal level=-25 dBm
           Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
           Tx excessive retries:457611  Invalid misc:451   Missed beacon:0
                                            ^^^^ WTF?

pings range from 120 ms to 420+ ms

2) txqueuelen 50 on laptop

MIGRATED TCP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 
172.30.42.97 (172.30.42.97) port 0 AF_INET
Recv   Send    Send
Socket Socket  Message  Elapsed
Size   Size    Size     Time     Throughput
bytes  bytes   bytes    secs.    10^6bits/sec

  87380  65536  65536    60.18      45.93

pings in the range 7-14 ms, with a few outliers




On 10/29/2011 09:35 PM, David Täht wrote:
> Dear Jim:  (and our more enthusiastic folk cc'd)
>
> rc7-smoketest7 is up in the usual place. TOTALLY UNTESTED (and thus, 
> this private msg - I will test on monday if nobody beats me to it), so 
> read on...
>
> http://huchra.bufferbloat.net/~cero1/rc7-smoketests/
>
> And now that I have sites in france and california set up I would like 
> to nail this bug to the wall!
>
> http://www.bufferbloat.net/issues/262
>
> Not just performance, but notably the weirdness with VI - AND also get 
> reasonable single and multi-stream throughput on a variety of scenarios.
>
> I'm looking forward to burning my 3800 when I get back to paris... and 
> I intend to be nose to the grindstone all month... if anyone has 
> suggestions on what ELSE I should focus on? (High on my list also is 
> vpn testing)
>
> I was (and remain) very happy with the responsiveness of the previous 
> smoketests in most respects.
> (see attached plot). Factor of 5 improvement overall... not bad.
>
> In the long run we need to have a per-device txqueue for wireless, at 
> least as g still sucks rocks. I keep poking into it - too many !@#@! 
> layers.
>
> However jg did manage to prove to me that a mildly longer txqueuelen 
> helps on con-us distances on
> ethernet. (do you still have that data?) Not that that's the case 
> EITHER for inside the home or for most web accesses - but I have no 
> way to control the txqueuelen for the 'internal' interface vs the 
> external interface at present.  Also I had weirdness with txqueuelen 
> 37 (see bug #288) and dup pings that I could not duplicate with 
> txqueuelen 40.
>
> so... for rc7-smoketest7 and later...
>
> I have reset the cerowrt defaults to be '40' txqueuelen - which + 
> driver bufs (currently 4) is something between 50 (what 9/10th the 
> theorists use) and 1/3 100 (33) (what we suspect is closer to 'mo 
> right').
> I suspect I'll need driver tx bufs of 8, actually - or to increase the 
> clock interrupt.
>
> I updated to babeld from git head, which had a CS6 patch in it, too. 
> This will probably annoy julius.
> (it's a *SMOKETEST* julius)
>
> I've also (I hope) fixed ipv6 diffserv handling over wireless - or 
> broke wireless completely (maybe) - with this smoketest. Feel free to 
> NOT try rc7-smoketest7 - as I won't be installing it myself until I 
> get to back to paris late tomorrow or monday. Have you tried your 
> 3800s yet? :)
>
> I have also added QFQ support, which looks promising. Although a quick 
> test on a live interface hung the box!! I'd want to add this to all 
> the ethernet interfaces by default, after it works.
>
> pfifo_fast must die!
>
> And am back to hacking on the switch for real W-FQ support....
>
> And planning on having the qos scripts set the txqueuelen when handed 
> a bandwidth figure.
>
> And will be doing another round of testing starting tuesday or so.
>
> I was very impressed by john linville's presentation at linuxcon - and 
> he had a full room for it, too.
>"
291,Petri Rosenström,2011-11-06 06:01:13.84954,My patch broke the sysupgrade. It tried to check for something that didn't exist. I fixed my patch so sysupgrade works. Let's hope that there isn't a lot of other quirks.
295,Dave Täht,2011-11-08 04:01:38.799721,""
294,David Taht,2011-11-18 06:10:30.621139,""
295,Jim Gettys,2011-11-18 07:14:27.981526,""
295,Jim Gettys,2011-11-18 07:15:53.866724,
292,Dave Täht,2011-11-18 07:17:53.230657,""
294,Jim Gettys,2011-11-18 07:18:06.918771,"While it runs today, when it appears upstream in OpenWRT it will break us, so we can't close this yet.
"
292,Dave Täht,2011-11-18 07:18:48.724696,""
293,Jim Gettys,2011-11-18 07:22:33.397748,""
291,Jim Gettys,2011-11-18 07:23:47.524748,""
292,Jim Gettys,2011-11-18 07:27:15.685947,
290,Dave Täht,2011-11-18 07:29:05.223565,Currently fixed in both taht-tnq and cerowrt rc7. Better patches on the way.
288,Dave Täht,2011-11-18 07:30:32.758522,Can't reproduce at current txqueuelen
289,Jim Gettys,2011-11-18 07:34:57.182852,Being put in wiki
288,Jim Gettys,2011-11-18 07:36:12.340162,Seemed fixed. TXquelen == 40 seems to have fixed it.....  Bizarre.
280,Dave Täht,2011-11-18 07:41:12.281088,We need to fix ntp.
279,Dave Täht,2011-11-18 07:42:07.479142,I think this is fixed in 3.1
278,Dave Täht,2011-11-18 07:43:01.546717,Seems to work well as a default
281,Jim Gettys,2011-11-18 07:44:05.664248,""
282,Jim Gettys,2011-11-18 07:46:17.223085,Lots of time has already been spent by Dave
277,Jim Gettys,2011-11-18 07:52:08.819704,We need some fair queuing and AQM to do anything sane.  Current scripts are totally insane and need revisiting from absolute first principles.
277,Jim Gettys,2011-11-18 07:54:18.195212,""
276,Jim Gettys,2011-11-18 07:58:56.38304,"I need to sniff to see what is happening when on the same segment so we can figure out what the next step should be.  See if SNMP theory of jg is correct....
"
274,Dave Täht,2011-11-18 08:11:30.996857,""
274,Dave Täht,2011-11-18 08:11:46.202863,""
275,Jim Gettys,2011-11-18 08:13:12.892584,""
273,Dave Täht,2011-11-18 08:15:31.299054,"I had hoped to try this directly against freewifi, but they all use specialized hardware.

So I give up."
273,Dave Täht,2011-11-18 08:15:50.475478,""
272,Dave Täht,2011-11-18 08:21:54.454582,"I checked the multicast handling throughout linux actually/ Oh, god, this needs to be handled with more intelligence.

One - multicast should be scheduled separately in the general case. 

I have come up with a string of methods to make handling multicast much, much saner, but it pees on many levels of the stack, at the moment. That said, I think the pieces are falling in place, with the new 'birthday free mac classifier'"
298,Jo-Philipp Wich,2011-11-18 08:29:59.742473,"I suggest to embed an /etc/openwrt_release with DISTRIB_DESCRIPTION=""whatever should appear on the status page"""
233,Jim Gettys,2011-11-18 08:31:18.448014,"Even weirder, sometimes I see bind work; but most recently mostly not.

I set up the forwarder's file manually, and it worked some of the time.  Needs to be setable in a bind UI
"
271,Dave Täht,2011-11-18 08:38:29.474791,"The right answer is to inject more entropy from the wireless signal strength, interrupts, packet sizes internally, ethernet arrival time, etc, in addition to using a userspace daemon. "
271,Dave Täht,2011-11-18 08:43:17.258433,"It would be nice to have entropy for routers that don't have hardware rng. Right now there is nearly none in the ar71xx
chipset...

without entropy crypto is not crypto... 

What is a culturally acceptible form of re-introducing entropy to Linux?"
270,Dave Täht,2011-11-18 08:45:31.948871,"I added support for additional user to kernel space led controls in the rc8 build. How to use them... dunno. Yet. 

"
269,Dave Täht,2011-11-18 08:47:32.35092,All these bugs are related to having a decent AQM scheme in place that makes a sane compromise between throughput and latency. 
269,Dave Täht,2011-11-18 08:50:10.310819,"I HAVE, however, settled on about 50 buffers as being a reasonable default without AQM when connected at 100Mbit. Currently this is 4 in the driver and 40 in the stack. I may need to increase this a little bit, but at this setting I get over 400Mbit at gigE speeds, on a local lan.

So, as we add some other AQM technique than pfifo fast, these numbers will need to be tweaked. A lot."
268,Dave Täht,2011-11-18 08:52:29.344264,"I have debated about updating polipo as the current version is quite ancient.

That said, after doing so, would require a round of testing, against ipv6, ivp4, the two different resovlvers, and I wouldn't mind if we threw in some dscp prioritization in there as well.

"
300,Dave Täht,2011-11-18 08:56:31.862142,""
268,Jim Gettys,2011-11-18 08:57:11.640073,
266,Dave Täht,2011-11-18 08:58:26.345224,fixed in 3.0.something and in 3.1
265,Dave Täht,2011-11-18 09:00:46.170134,"Fixed in 3.1, however dsack and proportional stuff are going into 3.2 and 3.3 which may improve matters further, or, make things worse. "
262,Jim Gettys,2011-11-18 09:03:27.638875,"Could you retest when RC8 builds start appearing?
"
261,Dave Täht,2011-11-18 09:08:11.447166,"We should create or adopt an internet standard for private dns.

Secondly, whatever we go with should be constant, not exposed to the outside world, and not possible to override with other configuration changes. Or so sayeth Jim."
259,Dave Täht,2011-11-18 09:19:48.244587,Red is not useful in this scenario. Soooo.... we should rip red out of the existing scripts.
257,Dave Täht,2011-11-18 09:29:44.460095,""
254,Dave Täht,2011-11-18 09:30:39.328085,so far as I know this was fixed long ago
253,Dave Täht,2011-11-18 09:31:21.916169,""
252,Dave Täht,2011-11-18 09:32:37.463074,"While doing this, I will write some documentation for the homenet group"
251,Dave Täht,2011-11-18 09:33:26.962299,Did you give up on this?
250,Dave Täht,2011-11-18 09:34:10.080065,needs to be fixed upstream
249,Dave Täht,2011-11-18 09:40:49.362083,"I am glad that setting the ipv6 TCLASS field is now in quagga (thx stephen!) and in dropbear, and in openssh, and I hope that one day it makes it into everything, or a more universal solution is found. 

That said, I will try personally to do this to every ipv6 enabled app I run across, but I'm not going to make it a crusade. A couple hundred hours spent internet wide with a few dozen participants - like for some 'WORLD FIX TOS SETTING IN IPV6' day, would be the best answer.

A fix TOS under IPv6 day... yea... that's the ticket. "
98,Jim Gettys,2011-11-18 09:49:23.440977,""
253,Jo-Philipp Wich,2011-11-18 12:01:07.735151,Syncing luci-app-firewall with the current firewall v2r27 features is on my ToDo but I need to get backfire done first.
302,Dave Täht,2011-11-18 12:22:42.498923,this is a duplicate
279,Dave Täht,2011-11-18 12:29:31.912285,"Confirmed fixed in 3.1. How do I account for all the hours I read commits and the mailing lists?

commit 8a04b45367c7943f8f7f30257d42e2106ab7a0bf
Merge: a8062e4 805e969
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Tue Oct 4 10:37:06 2011 -0700

    Merge git://github.com/davem330/net
    
    * git://github.com/davem330/net:
      pch_gbe: Fixed the issue on which a network freezes
      pch_gbe: Fixed the issue on which PC was frozen when link was downed.
      make PACKET_STATISTICS getsockopt report consistently between ring and non-ring
      net: xen-netback: correctly restart Tx after a VM restore/migrate
      bonding: properly stop queuing work when requested
      can bcm: fix incomplete tx_setup fix
      RDSRDMA: Fix cleanup of rds_iw_mr_pool
      net: Documentation: Fix type of variables
      ibmveth: Fix oops on request_irq failure
      ipv6: nullify ipv6_ac_list and ipv6_fl_list when creating new socket
      cxgb4: Fix EEH on IBM P7IOC
"
279,Dave Täht,2011-11-18 12:32:42.56343,""
292,Stephen Walker,2011-11-18 14:14:06.930616,Pushed the (untested) package to ceropackages.
262,Aidan Williams,2011-11-18 21:17:05.403859,"Yes, I can.  I'm travelling right now and won't be back in Australia for about a week.
"
300,Petri Rosenström,2011-11-19 09:53:30.8949,"I played around with this for a while and noticed that by putting wpad.dat to /etc/www on the router and setting a disc cache location for polipo then Firefox (7.0.1) started to use the cache.

If I didn't set the disc cache location for polipo the cache wouldn't work. I got a 504 blah lookup failed: Timeout

/* Working config begin */

config 'polipo' 'daemon'
        option 'daemonise' '1'
        option 'pidFile' '/var/run/polipo.pid'

config 'polipo' 'general'
        option 'enabled' '1'
        option 'proxyAddress' '::'
        option 'dnsUseGethostbyname' 'false'
        option 'dnsNameServer' '127.0.0.1'
        list 'allowedClients' '172.16.0.0/12'
        option 'chunkHighMark' '10485760'
        option 'logSyslog' '1'
        option 'dnsQueryIPv6' 'happily'

config 'polipo' 'cache'
        option 'cacheIsShared' '1'
        option 'diskCacheRoot' '/home/proxy'

config 'polipo' 'pmm'

/* Working config end */

/* Broken config */
config 'polipo' 'daemon'
        option 'daemonise' '1'
        option 'pidFile' '/var/run/polipo.pid'

config 'polipo' 'general'
        option 'enabled' '1'
        option 'proxyAddress' '::'
        option 'dnsUseGethostbyname' 'false'
        option 'dnsNameServer' '127.0.0.1'
        list 'allowedClients' '172.16.0.0/12'
        option 'chunkHighMark' '10485760'
        option 'logSyslog' '1'
        option 'dnsQueryIPv6' 'happily'

config 'polipo' 'cache'
        option 'cacheIsShared' '1'

config 'polipo' 'pmm'

/* Broken config end */

To make things simple when I change dnsUseGethostbyname variable to true the broken config works. And if I add the discCacheRoot variable it is broken again..."
300,Dave Täht,2011-11-23 05:27:30.917705,"I decided to try building also polipo-latest in rc8, which has about a year's worth of fixes to polipo in it. More news as it happens...."
304,Dave Täht,2011-11-24 12:03:45.686092,"I was poking through the ledbat kernel module, and I realized how important having tcp timestamps actually on, was...

and discovered it was turned off in sysctl.conf

Assuming that netperf doesn't enable it itself (I have to look at some old packet captures) this invalidates all testing we've done to date, against westwood+. While there is a performance impact to timestamping, it's kind of required to give tcp an actual clue as to real delays - in, for example, a tcp proxy case, or... as I do all the time - testing how well wireless is working from the host to the router.

Sigh. Enabled by default in rc8."
304,Dave Täht,2011-11-24 23:51:35.64422,"Yep, it's been turned off all this time in cerowrt/openwrt.

http://www.ietf.org/rfc/rfc1323.txt

--snip--

     It is vitally important to use the RTTM mechanism with big
      windows; otherwise, the door is opened to some dangerous
      instabilities due to aliasing.  Furthermore, the option is
      probably useful for all TCP's, since it simplifies the sender.

   3.2  TCP Timestamps Option

      TCP is a symmetric protocol, allowing data to be sent at any time
      in either direction, and therefore timestamp echoing may occur in
      either direction.  For simplicity and symmetry, we specify that
      timestamps always be sent and echoed in both directions.  For
      efficiency, we combine the timestamp and timestamp reply fields
      into a single TCP Timestamps Option."
304,Dave Täht,2011-11-25 00:54:43.029118,"The other thing on my list is checking when things are timestamped, particularly in the wireless driver. Given the impact of queue length on wireless it would make more sense to timestamp when it enters the queue, rather than when it exits the device. My thought is we timestamp when it hits the device, and that would explain some things."
304,Jim Gettys,2011-11-25 06:22:46.679964,"Unless the router is the end point of the TCP connection, it won't be dealing with timestamps at all, so this isn't an issue for TCP sessions that are being routed through it; local connections won't end up with big windows. 

Some ethernet/wireless hardware makes doing the timestamps cheap/free.  So it isn't clear this change is a big deal (and may help performance on hardware where timestamps are expensive).  I suspect the WNDR3700v2's hardware is recent enough that doing timestamps won't cost much.

Unless I'm missing something... "
304,Dave Täht,2011-11-25 07:15:41.548761,"To be more clear, the majority of my *tests* have been using a router as an endpoint, to eliminate the variables introduced by using other devices as endpoints. 

Secondly, when used as a web proxy, it was my hope that westwood+ would help, and it wasn't.

Thirdly timestamping would help vpn over tcp when the router is the endpoint there.

Fourthly, certain network monitoring tools on the router continually update the web page,
and would benefit from better congestion control.

As you also note, having it on when rarely used anyway, means it isn't going to hurt...

Thus, timestamping being off by default is a bad idea. 

In some preliminary tests I saw no real difference in cpu usage with timestamping on, and a slight reduction in throughput (from about 94Mbit to 92.X Mbit) due to the increase in ack size.

But I now have several hundred gb of captures to throw out and some more thorough tests to re-run. I really hope to see westwood looking like westwood, in particular, now.

"
304,Dave Täht,2011-11-25 07:25:52.963752,"Dave Täht wrote:
> The other thing on my list is checking when things are timestamped, particularly in the wireless driver. Given the impact of queue length on wireless it would make more sense to timestamp when it enters the queue, rather than when it exits the device. My thought is we timestamp when it hits the device, and that would explain some things.

And the context of the above comment is not actually as applicable to APs but to stations..."
310,Dave Täht,2011-11-25 13:18:54.901154,"just feel the un-merged pain... there are dozens of machines here not in the mainline kernel.

cerowrt/target/linux/ar71xx/files/arch/mips/ar71xx"
310,Dave Täht,2011-11-25 13:21:00.318159,and basically the update to 3.2 moved a ton of dirs around.
312,Dave Täht,2011-11-28 05:07:38.211647,"At sub 70 ms RTTs this does mildly better - 3.5mbit upload vs 2.8, which is close enough
to 'benchmarker-proof' for me. At the same time I have to retry this in the same 
test enviroment as I was doing earlier...

<pre>
< BIGQDISC=""red min 1500 max 4500 probability 0.02 avpkt 800 limit 16000 burst 5 ecn""
---
> BIGQDISC=""red min 3000 max 6000 probability 0.02 avpkt 800 limit 24000 burst 5 ecn""
</pre>

"
312,Dave Täht,2011-11-28 05:38:06.364398,"Meh. I set machines to the desired 256 value rather than 8, and the script blows up... hopefully
just a bug. It takes forever to load without batch mode. With batch mode it's 100x faster, but
has to feed from a 1.6 Mbyte file..."
312,Dave Täht,2011-11-28 05:54:46.756551,"The biggest flaw in this is that you can accumulate one heck of a lot of acks before red even thinks about starting to maybe kick in, so downloads can starve uploads, and/or acks get seriously delayed in queue while FQ is happening elsewhere."
303,Dave Täht,2011-11-28 08:26:17.023505,"The latest versions of samba are at 3.61, and the resulting software
per-requisites and binaries are huge. 

What can be stripped out remains to
be seen.

There was a great deal of churn in the samba 3.0.X package of late,
which just stabilized, but I'm unsure if that will help any.

All we need is working wins support but whether that can be made to
work with the most current windows remains to be seen."
303,Dave Täht,2011-11-29 03:14:56.482681,"This work on 3.6 and the ongoing work on the 3.0 release are very encouraging.

https://dev.openwrt.org/ticket/9992"
312,Dave Täht,2011-11-30 14:10:46.492017,"I rewrote the qdisc generation script from shell to C and that portion of it completes in ms now rather than minutes.

the tc parser does pretty well in bulk mode, but that's the bottleneck now."
312,Dave Täht,2011-12-01 03:47:10.822899,"And I recently discovered that GSO on the e1000e was enabled by default, even at 100Mbit and below.

TSO gets disabled. Not GSO."
312,Dave Täht,2011-12-01 03:48:18.18237,"Sigh. What this does to an algorithm that kind of expects 1500 byte
packets, at MOST, or a qdisc that measures things in bytes, is looking
rather ugly.

commit 212b573f5552c60265da721ff9ce32e3462a2cdd
Author: Michał Mirosław <mirq-linux@rere.qmqm.pl>
Date:   Tue Feb 15 16:59:16 2011 +0000

    ethtool: enable GSO and GRO by default
    
    Signed-off-by: Michał Mirosław <mirq-linux@rere.qmqm.pl>
    Signed-off-by: David S. Miller <davem@davemloft.net>
"
314,David Taht,2011-12-01 10:48:27.951822,"I'm moving this over to the bug report system so we can discuss it
better there until we find resolution.

On Thu, Dec 1, 2011 at 6:21 PM, Jim Reisert AD1C <jjreisert@alum.mit.edu> wrote:
> On Wed, Nov 30, 2011 at 11:57 PM, Jim Reisert AD1C wrote:
>
>> Not quite yet.  On my wife's laptop (Windows XP), I can browse to
>> \\DESKTOP\My Documents (Windows 7).  I changed the path of the My
>> Documents folder on the laptop to be \\DESKTOP\My Documents. But when
>> I try to synchronize the folder on the laptop (to the Desktop),
>> Windows reports an error, saying the network path no longer exists.
>> This used to work when all the computers were on the same subnet.
>
> I have my own personal Windows XP laptop.  Even after configuring
> ""NetBIOS over TCP/IP"", the computer still could not see the workgroup!
>
> The only difference I can see between this computer and the other two
> wireless ones (one Windows 7, one XP) is that this one is on the
> 802.11G network, whereas the other two are on the 802.11N network.  I
> don't know if that makes any difference or not.  Its IP address is in
> the same subnet range as the other two wireless computers (ending with
> .64 through .95).

Hmm... No, there should be no difference, aside from the wireless
cards and drivers installed.

And there is (at present) no physical difference between the 'G' and
'N' networks, aside from the 2.4ghz radios being on the 64-96 range
and the 5.x ghz being on the 97-126 range.

I have - because I give up on trying to make g and n co-exist properly
- been considering actually putting them - at least for 5ghz - on
separate networks. The AQM strategies then become MUCH easier.

but this is totally unrelated to your ongoing difficulties.

I really do admire your persistence in this.

Can I get you to take a huge step back? I kind of
need to review everything you've tried and get a mental
picture and frankly the best thing for me to do would be
to somehow obtain an XP and vista box.

REBOOT EVERYTHING (std windows technique)

I've kind of lost track - do you have the ability to have
two identical (eg windows 7 or windows xp)
on either side of the network?

I'd like to eliminate the differences in OS version
from the equation.

plug in TWO windows 7 boxes - only - into
both sides. What happens then?

What do they do?



>
> - Jim
>
> p.s. I did notice that I had not configured all the interfaces in
> /etc/config/dhcp (se00, sw00, and sw10), so I updated this per the
> twiki page and rebooted.  This was all done before booting up the
> other XP laptop, so may not be a factor in this problem.
>"
314,David Taht,2011-12-01 10:59:02.530807,"samba is providing wins service and SHOULD also be
being elected a master browser at this point.

A way to tell if that is the case, is to, on the router


logread -F &

/etc/init.d/samba restart

and you should see a message go by saying that.


---------- Forwarded message ----------
From: Steinar H. Gunderson <sgunderson@bigfoot.com>
Date: Thu, Dec 1, 2011 at 7:35 PM
Subject: Re: [Bloat] Summary: Windows file sharing
To: bloat@lists.bufferbloat.net


On Thu, Dec 01, 2011 at 10:21:45AM -0700, Jim Reisert AD1C wrote:
> I have my own personal Windows XP laptop.  Even after configuring
> ""NetBIOS over TCP/IP"", the computer still could not see the workgroup!

Note that browsing (seeing the workgroup, being able to list other machines)
is separate from name resolution (hostname -> IP address). WINS only gives
you the latter.

Windows browsing information can generally not cross subnets unless you are
on a domain, you have a special browse master machine on each subnet
(configured to sync to each other), or you do special magic to the broadcast
packets.

/* Steinar */"
314,Robert Bradley,2011-12-01 16:53:37.354426,"According to the Samba documentation, the way to get this working would be to make the Samba server a Domain Master Browser (http://www.samba.org/samba/docs/man/Samba-HOWTO-Collection/NetworkBrowsing.html#DMB).  The required changes to smb.conf are:

<pre>
[global]
domain master = yes
local master = yes
preferred master = yes
os level = 65
</pre>

This would only work in the case where a domain server does not already exist on the network."
314,Dave Täht,2011-12-05 02:52:52.016916,"I have committed a version of samba 3.6.1 to the ceropackages repository. 

Aside from verifying that it does, indeed build, I am not presently in a position
to test it - or even build it - in any way, as the main cerowrt tree is temporarily
too unstable for even me to use. If you have the ability to build cerowrt-rc7 - and would
like to play with this highly experimental - but hopefully thoroughly compatable! 
package, you can do a

cd your ceropackages repo
git pull
cd your cerowrt repo
./scripts/feeds update
./scripts/feeds install samba3x-server
make menuconfig
select the network section, below that will be options to build samba3x. client and server

When your custom build is done, you can install it via opkg
"
303,Dave Täht,2011-12-05 03:01:14.104692,I have folded the latest work from the openwrt universe into the ceropackages repository.
310,Dave Täht,2011-12-05 03:02:57.960986,"It turned out I had deeper problems. It turned out all of 3.1.1 was failing to build.

Still unfixed. 

3.0 is also failing to build. "
301,Dave Täht,2011-12-05 03:06:22.15009,"And it turned out RED was busted. Folding the patch back into cerowrt will not be a problem, but as usual with bugs of this kind, I have to throw out a month's worth of results.

I am building a version of both net-next for x86_64 and folding in this patch into cerowrt-rc8

commit 1ee5fa1e9970a16036e37c7b9d5ce81c778252fc
Author: Eric Dumazet <eric.dumazet@gmail.com>
Date:   Thu Dec 1 11:06:34 2011 +0000

    sch_red: fix red_change
    
    Le mercredi 30 novembre 2011 à 14:36 -0800, Stephen Hemminger a écrit :
    
    > (Almost) nobody uses RED because they can't figure it out.
    > According to Wikipedia, VJ says that:
    >  ""there are not one, but two bugs in classic RED.""
    
    RED is useful for high throughput routers, I doubt many linux machines
    act as such devices.
    
    I was considering adding Adaptative RED (Sally Floyd, Ramakrishna
    Gummadi, Scott Shender), August 2001
    
    In this version, maxp is dynamic (from 1% to 50%), and user only have to
    setup min_th (target average queue size)
    (max_th and wq (burst in linux RED) are automatically setup)
    
    By the way it seems we have a small bug in red_change()
    
    if (skb_queue_empty(&sch->q))
        red_end_of_idle_period(&q->parms);
    
    First, if queue is empty, we should call
    red_start_of_idle_period(&q->parms);
    
    Second, since we dont use anymore sch->q, but q->qdisc, the test is
    meaningless.
    
    Oh well...
    
    [PATCH] sch_red: fix red_change()
    
    Now RED is classful, we must check q->qdisc->q.qlen, and if queue is empty,
    we start an idle period, not end it.
    
    Signed-off-by: Eric Dumazet <eric.dumazet@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
"
301,Dave Täht,2011-12-05 03:21:41.06382,"Also a major problem is that the current linux packet schedulers are scheduling 'superpackets' - full GSO and TSO offloads - up to 64k- through the scheduler.

The effect this has on any attempt to classify or schedule packets has to be seen to be believed.
A 64*k* 'packet', followed by a 64 *byte* packet, is a 1000x1 ratio. Mere packet oriented schedulers, like PFIFO_fast, survive this abuse, but the effect on packets marked background
or priority, over best effort, is correspondingly, um, 'enhanced'.

Spitting this sort of abuse through a grouping scheduler such as SFB or SFQ is really bad, as the above effect is magnified. All packet schedulers that try to do something with bytes rather
than packets, are similarly problematic.


We never figured out how to handle jumbo frames outside the datacenter in the first place. 

People doing AQM analysis work work MUST turn off TSO and GSO in order to get a sane result - 
and if you merely turn off TSO, GSO will rise in it's stead on some devices, and bite you. 

(yes, this happened to me)

Even if the device says it's turning TSO off (because it's running at sub 100Mbit speeds)

(this was on the e1000e driver, at least, while I was manually setting it below 100Mbit for testing), gso stays on.

The way to turn off both is:

<pre>
ethtool -K tso off
ethtool -K gso off
</pre>

commit 212b573f5552c60265da721ff9ce32e3462a2cdd
Author: Michał Mirosław <mirq-linux@rere.qmqm.pl>
Date:   Tue Feb 15 16:59:16 2011 +0000

    ethtool: enable GSO and GRO by default
    
    Signed-off-by: Michał Mirosław <mirq-linux@rere.qmqm.pl>
    Signed-off-by: David S. Miller <davem@davemloft.net>

If it were up to me, I'd revert half this commit, with a message like:

""Disable GSO by default""

Disable GSO until the effects of unleashing superpackets on the global internet
as a whole is better understood by theorists and network designers, and
the Linux scheduler is revised to handle them properly.





"
201,David Taht,2011-12-06 08:39:08.725721,"This is the second of a series of emails discussing things that may be
dropped from the next release of cerowrt, and is intended to open the
discussion, only.

The goal is to find better ways to focus on fixing bufferbloat.

While I personally find babel very useful, as well as AHCP, convincing
anyone that these two bleeding edge technologies are worthwhile on
places like the homenet mailing list is an incredible struggle. The
consensus there appears to be leaning towards ospf, not that anyone on
that list has bothered to test that, either. We have had the ability
to use ospf in the system since day one as an optional package.
Routing, actually, is not needed in simple setups.

Other problems:

1) The AHCP package in openwrt keeps breaking. It broke of the late
rc7-smoketest6-ish series, and so far as I know, hasn't been fixed.

1a) The gui interface, even when the package was working, is equally
problemantic

2) Firewalling remains REALLY problematic with both babel and AHCP.
More often than not, you end up with stuff
that doesn't work.

3) Packet loss as a metric appears to not be a good metric anymore.

4) As much as I enjoy mesh networking,  the few people that have tried
to set it up independently that I know of, have all failed.

And lastly,

5) As pointed out during a test in brussels, cerowrt itself has become
too complex even for someone familiar with openwrt to deal with it.

So with no real users of these subsystems in the field, these two
packages can be safely dropped.

There were some positive benefits to being able to test ad-hoc mode,
having the interfaces available at all times, etc, but deleting the
extra interfaces and firewall complexity would help.

While I believe that a pure mesh environment works a LOT better than a
pure 'as we know networking today' environment, however, the attempt
thus far,
of merging the 'best of' the two, seems to be worse, than either.

This eliminates having to fix bugs #252, #110, #112, #201, and I've
never got around to mentioning how much I was hoping for dhcp/ahcp
integration."
314,Robert Bradley,2011-12-06 13:40:43.932374,"Having tried setting my Linux machine up as a PDC earlier today, I have the unfortunate news that I could not achieve cross-subnet browsing.  The news gets worse though.  According to http://support.microsoft.com/kb/117633, simply having a domain controller is not enough, as reading the Samba documentation seemed to suggest.  You need to have the machines actually joined to the domain too.  This is a real problem for home users using CeroWRT, not least because the home editions of Windows cannot join domains.

So, Steinar is entirely correct in saying that packet replication and/or magic is needed to achieve this (or a proper domain, which is not an option).  Using ""remote browser sync = <cerowrt router interfaces>"" may work for this, but may also successfully tie Samba up in knots talking to itself."
317,David Taht,2011-12-06 19:58:49.724384,"On Tue, Dec 6, 2011 at 8:33 PM,  <david@lang.hm> wrote:
> Again, what are you trying to address? there are a lot of issues with IPv6,
> do you want to be working to solve those, or do you want to focus on
> bufferbloat.

In the early days...

We found that ECN and TOS (diffserv) were not being
handled correctly in the linux stack under ipv6.

There were routing and encapsulation problems, as well.

All that stuff is fixed upstream now. I'm happy.

Nor, applications that wanted to use prioritization understood
that they needed to use IPV6_TCLASS to do that on IPv6
sockets, not IP_TOS. That's fixed now also in openssh and
dropbear, babel, and AHCP. And all that's upstream, too.
I'm happier. :) Hopefully other application writers will see
how easy it is to do (see bug

http://www.bufferbloat.net/issues/249

) - and gradually incorporate one liner fixes like that
into their products.

I think, but am not sure, a fix is in the works for making IPv6
mapped sockets do more of the right thing in these cases
as well.

This reminds me, IPv6 + diffserv is *not* being handled
at all STILL in the wireless component of the stack.
If you do voip over IPv6, as an example it's being
tossed into the hardware BE queue, not the VO queue.

I really need to get around to pushing that patch up.

To fork off into the diffserv problem a bit harder:

It is certainly silly to have the one end-to-end technology that really
benefits from 'EF' being set AND from running over IPv6 to be so
de-prioritized.

The easy part of that patch is merely getting the IPv6 + diffserv part to work,
the hard part is getting something more comprehensive in place
to do diffserv at leat 95% *right*, as opposed to the half-assed
sorta-tos-like implementation we have now.

I'd like to see someone take implementing a rollup of the
diffserv standard into the linux kernel as a project, as
well as finding a clean way to map it into 802.1q and 802.11e.

For example, the less than complete implementation
on wireless doesn't do the right thing with the 'IMM' bit, tossing interactive
packets (like, for example, ssh) also into the BE hardware queue
rather than someplace saner like VI.

I have some patches towards implementing diffserv sanely, based on the
drafts here and here -

https://github.com/dtaht/Diffserv/issues/5#issuecomment-2133541

http://www.bufferbloat.net/projects/bloat/wiki/Diffserv_RFC

(actually, I tossed the iptables method entirely and decided tc was
closer to the right thing)

but have not got around to finishing them. I'm not the right guy to do so,
actually, as it would require buy-in from netdev, the netfilter guys, and
linux-wireless.

(my diffserv attempt was basically triggered by my observation of the VO queue
 not being used for ipv6, and grew into a time-sucking rathole)

Anyway, so long as whatever approach taken towards diffserv did
take ipv6 into account, this component of the project can
be handled on 'normal', not embedded systems, done well,
and done by someone(s) else.

>
> if openWRT supports IPv6 you should not remove it, but don't go out of your
> way to provide anything more than openwrt includes unless it directly
> supports your goal.

In my opinion, getting IPv6 to work well requires a level of investment
and involvement well beyond that of the last major project that took it
on (japan's wide project), government and industry-wide funding,
and a focus on the problems induced by actual day to day usage.

While all the above accomplishments thus far *help* put
ipv6 on a more level playing field with ipv4, and indicate
the value of 'a' project that tries hard to treat the two protocols
equally, this cerowrt project does not necessarily need to
continue stressing ipv6 at all on the non-existent budget
we have.

We can fix many bufferbloat-induced problems and get ipv6
working better (now that the above fixes are in place),
for 'free'. Continued testing of course, would be helpful
and no doubt continually improve ipv6's behavior,
but it's a lot of additional effort that can be better expended
on stuff that is more crucial to the main goals."
314,Dave Täht,2011-12-07 14:53:09.227493,"The link I read said wins was the answer.

""You cannot browse domains on other subnets where the browse masters are not listed in the LMHOSTS file. As an alternative to this, you can use the Windows Internet Naming Service (WINS)."" "
314,Robert Bradley,2011-12-07 17:26:57.599044,"I was working from:

""Windows NT or WFW workgroups cannot span multiple subnets. Workgroups can view only other workgroups on the local subnet.""

and assumed the text you quoted meant that the full domain setup was needed.  Looking at it again tonight, I managed to get this partially working at home.  Unlike earlier, I used the Samba server as both PDC and WINS server.  The setup was:

Subnet 1 (192.168.1.0/25): Windows 7 Ultimate (192.168.1.3)+Samba server (192.168.1.2, routing between networks)
Subnet 2 (192.168.1.128/25): Windows XP Home (192.168.1.131)+Samba server (192.168.1.129)

This works."
305,David Taht,2011-12-08 00:20:52.026073,"This is the 6th in a series of mails doing a post-mortem and rethink
of what is in cerowrt.

Basically I think the 2.4ghz spectrum is beyond hope. Everywhere I've
been there are dozens of radios all on all the channels available, all
competing, all interfering, and the difference in performance results
I get minute to minute, hour to hour varies so wildly that in order to
get a good picture of how basic 2.4ghz performance worked I had to go
to remote valley in france where there was no competing signals to
deal with.

There I got pretty equivalent results between 2.4ghz and 5. The rest
of the time, not so much.

As for wireless-g vs n, the current architecture of the mac80211 stack
buries packet aggregation so deeply within it that the two
technologies are very incompatible. It also bothers me that management
frames are buried so deeply, too.

The only places I've been this year that had a functional wireless
network, rigorously divided up the SSIDs into g, n, ipv4 and ipv6
specific parts, and were using Cisco hardware.

I don't see the need to have separate SSIDs for 4 and 6, but I think
g+QFQ, and n+SFQ might do better in the general case on an AP.

QFQ would work well on client machines, particularly with n, to break
up packet bursts more sanely into multiple streams. SFQ, less so. I'd
rather pursue QFQ on the clients as it better 'shreds' competing
bursts. I'd like others to play with it too.

and in all cases getting to where something BQL-like + Time in Queue
on top of those two techniques will help most of all,
but better feedback loops and means of determining bandwidth
differences between destinations are kind of required.

And doing MUCH better classification into the hardware queues would be
good, too.

So in the next release of cerowrt I'm planning on having a separate
n-only or g-only SSID available on the 5ghz channel, and
to experiment with the above qdiscs. I sort of have some major ANT and
DSCP specific classifier code that I plan to polish up.

as for BQL and Time in Queue, that work is only just beginning and I
hope to track it closely.  As to how to make it apply to wireless,
I look forward to the engineering debate(s). It's a ton of work."
271,Noel Grandin,2011-12-08 01:12:54.863487,"The rngd daemon can introduce entropy:
http://linux.die.net/man/8/rngd

And here is a hack for using wireless data to do so:
http://bredsaal.dk/generating-entropy-with-a-wireless-network-card

Otherwise, ask nicely on the linux-network mailing list, or the linux-wireless mailing list
http://vger.kernel.org/vger-lists.html#netdev
http://linuxwireless.org/en/developers/MailingLists"
305,David Taht,2011-12-08 04:48:46.735893,"note, that I do try on occasion to capture stuff into the bug tracker
When you see something like [#305] in the subject
or cerowrt ccd, it goes there...

That said, I have to not surprise people with that 'feature'.


On Thu, Dec 8, 2011 at 1:46 PM, Dave Taht <dave.taht@gmail.com> wrote:
> On Thu, Dec 8, 2011 at 1:25 PM,  <david@lang.hm> wrote:
>> On Thu, 8 Dec 2011, Dave Taht wrote:
>>
>>> On Thu, Dec 8, 2011 at 12:51 PM,  <david@lang.hm> wrote:
>>>>
>>>> On Thu, 8 Dec 2011, Dave Taht wrote:
>>>
>>>
>>>> this puzzles me.
>>>>
>>>> splitting 2.4G and 5G into different different networks (broadcast
>>>> domains)
>>>> is a huge win. cince I can't find any open implementation fo band
>>>> steering,
>>>> this requires putting the two bands on different SSIDs.
>>>
>>>
>>> Oh, god no, I'm not dropping that. Having those split AND off the wired
>>> network is staying in...
>>>
>>>> but I don't understand why there is a big problem with G and N sharing
>>>> the
>>>> same SSID.
>>>
>>>
>>> Because you can fully FQ G, and if you do that to N, it messes up
>>> aggregation.
>>
>>
>> I don't recognize the term ""FQ"".
>
> Fair Queue
>
> http://info.iet.unipi.it/~luigi/qfq/ in this case.
>
>>
>> when you say it messes up aggregation, do you mean combining two channels
>> togeather for higher throughput or something else?
>
> No, the way the driver is structured it swallows as many packets as are
> aggregatable for a given destination, then ships them. If you instead
> try to do the right thing - which is to break up packet bursts into
> as tiny pieces as possible, aggregation goes to heck. What you want
> to do is aggregate fair queued packets for a given destination, at a
> size that will fit (up to 64 packets or 64kbytes) at the rate the wireless
> interface is running at.
>
> As a result nobody does FQ, nor AQM, on wireless n, where it is
> so desparately needed.
>
>>
>> I was assuming that if you are running a mized network you only use a single
>> channel for N. If you are using multiple channels for N they should be a
>> separate SSID, just from the fact that you are using two channels for N but
>> only one for G (which one would be the question)
>
> One channel for both N and G in this case. Only one radio for 5ghz.
>>
>>>>
>>>> there is some
>>>
>>>
>>> Some?
>>
>>
>> some, but it's an unavoidable feature of wireless communication. You can
>> consider turning off some modulation types, but since the clients
>> automatically fall back to slower modulation types when there is a problem,
>> the result will be failed connections.
>
> To give you an idea, at 5ghz I'm capable with cerowrt at achieving 150Mbits
> with TCP - in the clean air here.
>
> At 2.4, it's rare I can get more than 20, and fairly often much less than that.
>
> Any given test I run regarding wireless simply is not repeatable if I do it
> on 2.4ghz.
>
> I can usually 'hear' more than 30 access points at my apt, as another
> example.
>
>
>>
>> now, this may still be the right thing to do, because the failback to a
>> slower modulation type works well for weak signal situations, but in a high
>> density situation (which is basically every 2.4G deployment in the real
>> world nowdays), taking longer to send the same data just means that you are
>> more vunerable to another transmitter clobbering you, so it actually
>> decreases reliability.
>
> yes, minstrel rocks.
>>
>> David Lang
>>
>>
>>>> grief with having different speeds on the same channel, but
>>>> only in that the same amount of data will take longer to transmit
>>>> (causing
>>>> problems with predicting how long the queue is in terms of time as it
>>>> will
>>>> vary on the destintation), but even if you stick with G for example, it
>>>> can
>>>> transmit at 54, 48, 36, 24, 18, 12, 6, 1 Mb/s. adding N just adds some
>>>> higher speeds to this. If the devices are configured sanely, they should
>>>> be
>>>> transmitting the header for a G frame to reserve the air time and then
>>>> sending the N frame inside of that. this has a slight overhead compared
>>>> to a
>>>> pure N network, but it doesn't matter if the G network is on the same
>>>> SSID
>>>> or on a different one, the problem is sharing the airtime on the channel.
>>>
>>>
>>> It's a packet scheduler test more than anything else.
>>>
>>>> David Lang
>>>
>>>
>>>
>>>
>>>
>>
>
>
>"
314,Robert Bradley,2011-12-08 07:15:57.322563,"Two things to note from last night's experimentation:

1.

Make sure SMB traffic from the remote subnet is not firewalled off!

2.

If the WINS server is not set up correctly, but the Samba server is browse master on all the subnets, you can still get all the machines to show up with ""net view"".  However, actually resolving those names will fail.  For example, ""net view \\computer"" in Windows will fail with error 53 (path not found).  Using the IP address works fine.

My working /etc/samba/smb.conf file had the following:

<pre>
[global]
# ""domain logons"" overkill?
domain logons = yes
domain master = yes
local master = yes
preferred master = yes
os level = 255
wins support = yes
</pre>

That last line is essential for enabling the WINS server.  On OpenWRT/CeroWRT, this block must be added to the file ""/etc/samba/smb.conf.template""."
314,Dave Täht,2011-12-08 10:45:45.709506,"thx for beating your brains out on this further. What version of samba are you using?

"
129,Dave Täht,2011-12-08 11:23:01.125141,I need to dump all the kinds of testing I do manually out of my head and start finding ways to automate them.
314,Robert Bradley,2011-12-08 11:26:33.961607,"This was using the Ubuntu 11.10 (oneiric) samba package, so it's Samba 3.5.11."
201,Juliusz Chroboczek,2011-12-08 12:35:49.286471,"Fully agree.  I think that CeroWRT should focus on the bufferbloat problem, and mesh networking is only tangentially related to that.

-- jch
"
113,David Taht,2011-12-09 00:00:38.06453,"Ya know, that's pretty clever. 8.8.8.8 is blocked in some places, as is ntp,
but, yea...

(cc-ing the bug)

On Fri, Dec 9, 2011 at 9:02 AM, Ross Boswell <drb@med.co.nz> wrote:
> Dear Jim and Dave
>
> I read with interest your Cerowrt document from the 25 Oct meeting.
>
> I wonder about this:
>
> Headache: no TOY (time of year) clock in home routers: how
> do you get approximate time to bring up DNSsec?
> You can't do DNS lookups until DNSsec is running, and you need
> to do DNS lookups to get the time...
>
> The following works to set the initial time on a ubuntu box for me:
>
> root@nomad:~#ntpdate-debian `dig @8.8.8.8 +short nist1-ny.ustiming.org nist1-jy.ustiming.org`
>
> 8.8.8.8 is of course Google's open-access nameserver and it seems very reliable.
> I use the NIST timeservers but you can put any string of timeserver names here --
> ntp uses the first it can get a response from.
>
> Is this a feasible solution for you?
>
> Cheers -- Ross
> ---
> Ross Boswell
> 148 Quay St
> Auckland 1010
> New Zealand
> phone  +64 9 368 1195
> mobile +64 21 402 142"
201,Dave Täht,2011-12-09 00:39:05.042305,"Thank you for your concurrance. 

I note that nuking this entirely will require a serious rethink and re-org of [[BloatLab 1]]. The prospect of having to manage all the complexity over there without a routing protocol in place is daunting. Distributing new addresses via ahcp and using babel to cope with it made it possible. 

I also note that doing things like udp flooding would frequently cause babel to view the network as 'down', and this problem will extend out to alternate protocols. The CS6 patch helped with that. 

Fixing bufferbloat will help more, as will doing better hardware queue classification.

The CS6 patch has also made it into quagga, and this reduces the problem in that protocol set significantly.

I do not plan on upgrading the bloatlab for some time, but as using a different protocol is an all-or nothing choice I really don't know what to do about that choice, at present.

That said, the AHCP package in particular needs some more time to 'bake'."
33,Dave Täht,2011-12-09 02:42:18.884719,What on earth can we do to get the business press to pay attention?
201,Juliusz Chroboczek,2011-12-09 03:45:07.547296,"> That said, AHCP in particular needs some more time to 'bake'.

Just to clarify -- AHCP and the ahcpd implementation are pretty mature.  It's the OpenWRT packaging of ahcpd that needs improved.

--jch
"
113,Evan Hunt,2011-12-09 07:43:23.342156,"Leave 8.8.8.8 out of it -- you've got a resolver, it's just not validating because the time isn't set.  ""dig +short +cd <NTP server>"" will get you an address.  (I think I already suggested this workaround, though I didn't think of using it as an argument to ntpdate, which is quite clever.  My suggestion was to write the address into an ntp.conf file; this is better.)"
323,Dave Täht,2011-12-12 00:08:42.233188,"closed: see https://dev.openwrt.org/ticket/10548

Unclean tree at that point in time.

<pre>
./scripts/feeds update luci; ./scripts/feeds uninstall libiwinfo iwnfo; svn up; make defconfig; make package/iwinfo/clean world V=99
</pre>"
310,Dave Täht,2011-12-12 00:10:46.893721,"3.1.5 finally built after backing out multiple changes to find the problem, and getting a new patchset from the net.

"
113,David Taht,2011-12-14 03:17:59.227791,"PROGRESS!!!!!!!

-------- Original Message --------
Subject: Re: [DNSSEC-Tools] #145: ntp could use patches to use dnssec-tools
Date: Wed, 14 Dec 2011 11:16:39 -0000
From: DNSSEC-Tools <trac@dnssec-tools.org>
Reply-To: trac@dnssec-tools.org
CC: bugs@dnssec-tools.org

#145: ntp could use patches to use dnssec-tools
---------------------------+----------------------
  Reporter:  dave.taht@…   |      Owner:  hserus
      Type:  enhancement   |     Status:  assigned
  Priority:  major         |  Milestone:
 Component:  dnssec-tools  |    Version:
Resolution:                |   Keywords:
---------------------------+----------------------

Comment (by hserus):

 We submitted a patch a week or so ago, but there hasn't been any feedback
 from the ntp folks yet. In the meantime you could grab the patch from
 http://bugs.ntp.org. search for bug 2077

 It will need an updated version of libval though, currently available
 through svn but will be in a release soon."
113,Dave Täht,2011-12-14 06:39:08.732983," From my admittedly sketchy review of the patch, while it enables dnssec
 validation, and shows how to do it - for which I'm grateful! - it doesn't
 appear to solve the bootstrapping problem that I described - if you have
 invalid time in the first place, on starting ntp with -g it should turn
 off validation until it gets valid time, then it can turn it on again.

 I will apply it and fiddle with it next week, but if you could
 confirm/deny my reading it would cheer me up.

(posted same message to dnssec-tools bugtracker) "
314,David Taht,2011-12-14 21:14:45.940932,"our anti-phishing system kicked back on the numeric urls in this, fixed now.

The reason why cerowrt lives on the 172 dot 30 dot 42 dot X address is that
it had been my hope that others working on this project would plug *two*
routers into their home network - one for the day-to-day effort of keeping
their internet access up and running (on 192 dot 168 dot zero dot one), and
a cerowrt box for analyzing both routers behavior.

*I* don't run it as my day-to-day device at the moment. From where I sit,
it's a test tool - an increasingly good one - for coming up with solutions
to bufferbloat, and fixing the whole home router disaster with things like
ipv6, proxying, dns, etc... it has oprofile, and debugging tools by
default, etc, etc.

I had planned to get to where we had stable releases that could be used
day-to-day, but it's been a while since we had one, and I feel that we're
going to make some progress on the core bufferbloat problem next quarter,
and not have a stable release.

I'm GLAD to have users and testers - some generations of cerowrt are
running for people like jg, esr, & each, and have enormous stability and
uptimes - I don't know who else is running a generation of cerowrt
day-to-day frankly, there's been a lot of downloads - but there will always
be something broken in a smoketest or rc, that may not be able to be fixed
very quickly. Or something crazy we're doing - like routing vs bridging -
that exposes a problem that we needed to know about....

Recently, that happened with samba. And while I hope that's fixed now (in a
couple ways - wins appears to be working, and I also have a largely
untested samba 3.6.1 package, it needs to get tested at some point in next
year's development cycle)

http://www.bufferbloat.net/issues/314
http://www.bufferbloat.net/issues/303

I'd really like to use samba again personally, I used to use it a lot.
These days I tend to use sshfs, and that's zillions of times slower than
samba.

Having a user support community and people testing release candidates and
smoketests is very important to me, too! I LOVED finding out how to make
samba work right...

So, high on my list is coming up with a proper way of stressing what's on
the front page of the documentation, and setting (low!) expectations, and
keeping people engaged...

From: http://cero2.bufferbloat.net/cerowrt/

""CeroWrt <http://cero2.bufferbloat.net/cerowrt/about.html> is an
OpenWrt<http://www.openwrt.org/>router platform for use by
individuals, researchers, and students
interested in advancing the state of the art on the Internet. Specifically,
it is aimed at investigating the problems of latency under load,
bufferbloat, wireless-n<http://cero2.bufferbloat.net/cerowrt/tcp.html#wireless>,
QoS <http://cero2.bufferbloat.net/cerowrt/tcp.html#qos>, and the effects of
various TCP algorithms
<http://cero2.bufferbloat.net/cerowrt/tcp.html#tcp>on shared
networks.""

If there is some place in the doc where we are not putting up large warning
signs - 'BUGS AHEAD. DANGEROUS CODE. DON'T EXPERIMENT WITH THIS ON WIVES OR
CHILDREN' - I'd to find it and fix it.

I'm perfectly happy with the hardware and core software itself at this
point. I wasn't, this time last year.

I'd like everybody in the open source and network research communities to
get TWO routers based on this chipset for christmas! Use one day to day,
running openwrt, and the other experimenting with a future outlined by the
ideas in cerowrt.

1) I'd like to come up with a good way for people to plug this in as a
'secondary' router.

Right now that requires turning off nat, and telling the upstream router to
give the cerowrt router a static ip and route to the 172 dot 30 dot 42 dot
0 slash 24 address. Perhaps we can take some screenshots of how to do that
on more common CPE?

Network renumbering involves running a couple line sed script.

http://www.bufferbloat.net/projects/cerowrt/wiki/Default_network_numbering

I hope to make renumbering a router easier with a gui, but you know, it's a
3 line sed script and a couple hundred lines of gui to write to make that
easier.
I'm also thinking of merely writing an RFC standardizing that 192 dot 168
dot zero dot 1 should be the number ALL routers come up on, and the number
all home networks should use. For april 1st.

Bridging is also possible... but not very.

2) Another thought is to do builds of the ceropackages repository for
straight openwrt, and point people at that for things like the bleeding
edge samba stuff.

I like ceropackages, it's a good way to spin up and debug a new package,
with a low barrier to entry for new people to openwrt - after which it has
always been my intent to push the stable stuff upstream. Multiple grad
students have used the ceropackages concept to get up to speed somewhat and
steve walker's been great about polishing those up. (and also submitting
packages of his own)

3) Is to more aggressively push up the stuff that works into std openwrt.
This is currently blocked by something stupid

http://www.bufferbloat.net/issues/319

or convince someone to push the stable stuff up to openwrt on a regular
basis.

5) Increase the number of people doing active development and able to fix
bugs and documentation.

Any other ideas as to accomplish these mutually incompatable goals - gain
developers, increase the userbase, gain testers,get good day to day and
long term resolve, solve bufferbloat, establish world peace, and be able to
do bleeding edge R&D... are welcomed.

I do not ever want to disappoint people with our efforts, and will work
diligently at fixing every problem exposed by the new stuff we're doing.
One of my first thoughts was pretty simple in this area though - try to do
less new stuff!"
314,David Taht,2011-12-17 00:30:09.037609,"On Thu, Dec 15, 2011 at 10:07 AM, Maxim Kharlamov <mcs@podsolnuh.biz> wrote:
> Hello Dave,
>
> I'm running cerowrt on day-to-day basis on my wndr3800 for quite a while and
> it works like a charm. It is rc7-smoketest10 build. Managed to configure
> everything I needed apart from dyndns client which is not a big issue
> anyway.

I should probably point people at that build as a 'stable' release, with two
known bugs (notably having to manually create the radios). We were
very close with that smoketest!

(but shortly afterwards the build, the kernel, the driver, bind, ntp, and ahcp
 all broke simultaneously, as did I. There was a ton of churn upstream,
 that is only now settling down)

So in the future, I need to come up with a good point to do a code freeze
in the release cycle. This is of course, in conflict with the idea of closely
tracking the kernel and openwrt development process,

> So far wndr3800+cerowrt is the best performer out of many routers I tried. I
> tested wndr3800 stock, linksys e3000 and e4200 with stock and tomatousb,
> pfsense 2.0 appliance, cradlepoint mbr1400 and some others. Speedtest on
> wndr3800+cerowrt is constantly at or almost at the top of the list and
> during the speed test ping times are not deteriorating as badly as for the
> other routers. Feature-wise cerowrt is also the best (for my particular
> setup), so currently it is my main router at home even though initially I
> bought it for playing and testing.

Excellent! Thank you.

Preliminary testing indicated that andrews/felix's fixes for bugs 216 and 195
got us to where openwrt was outperforming the factory firmware in most
respects...

... but I immediately turned around and started sacrificing that raw transfer
performance for lower latency. (reduced tx rings, txqueues)

I'd like to think that that, also, improved performance by a few metrics, but
I don't plan on resuming serious testing on various benchmarks until
after this coming development cycle is well underway.

In that effort thus far I've enabled a ton of debugging code to be able
to look more closely at the effects on cpu of various AQM technologies,
and what I have working at the moment just barely boots.

> I've just received another wndr3800 and going to install openwrt on it to
> compare them side-by-side and to have a playground for routers.

The core difference here at this point between cerowrt and openwrt is the vastly
reduced tx rings and txqueues - you can add these into openwrt easily by editing
/etc/init.d/boot to run ethtool at the right time,  and adding
/etc/hotplug.d/iface/00-debloat to openwrt.

I note I plan serious improvements to the basic debloat script there
adding some intelligence to it - in the upcoming development cycle.

>
> Overall, excellent job, Dave! I'm keeping my eye on cerowrt.

Thx again. Sometimes all I can see are the outstanding problems,
rather than the good stuff.


>
>
> Thanks,
> Max
>
>
> On 15 December 2011 18:14, Dave Taht <dave.taht@gmail.com> wrote:
>>
>> our anti-phishing system kicked back on the numeric urls in this, fixed
>> now.
>>
>> The reason why cerowrt lives on the 172 dot 30 dot 42 dot X address is
>> that it had been my hope that others working on this project would plug
>> *two* routers into their home network - one for the day-to-day effort of
>> keeping their internet access up and running (on 192 dot 168 dot zero dot
>> one), and a cerowrt box for analyzing both routers behavior.
>>
>> *I* don't run it as my day-to-day device at the moment. From where I sit,
>> it's a test tool - an increasingly good one - for coming up with solutions
>> to bufferbloat, and fixing the whole home router disaster with things like
>> ipv6, proxying, dns, etc... it has oprofile, and debugging tools by default,
>> etc, etc.
>>
>> I had planned to get to where we had stable releases that could be used
>> day-to-day, but it's been a while since we had one, and I feel that we're
>> going to make some progress on the core bufferbloat problem next quarter,
>> and not have a stable release.
>>
>> I'm GLAD to have users and testers - some generations of cerowrt are
>> running for people like jg, esr, & each, and have enormous stability and
>> uptimes - I don't know who else is running a generation of cerowrt
>> day-to-day frankly, there's been a lot of downloads - but there will always
>> be something broken in a smoketest or rc, that may not be able to be fixed
>> very quickly. Or something crazy we're doing - like routing vs bridging -
>> that exposes a problem that we needed to know about....
>>
>> Recently, that happened with samba. And while I hope that's fixed now (in
>> a couple ways - wins appears to be working, and I also have a largely
>> untested samba 3.6.1 package, it needs to get tested at some point in next
>> year's development cycle)
>>
>> http://www.bufferbloat.net/issues/314
>> http://www.bufferbloat.net/issues/303
>>
>> I'd really like to use samba again personally, I used to use it a lot.
>> These days I tend to use sshfs, and that's zillions of times slower than
>> samba.
>>
>> Having a user support community and people testing release candidates and
>> smoketests is very important to me, too! I LOVED finding out how to make
>> samba work right...
>>
>> So, high on my list is coming up with a proper way of stressing what's on
>> the front page of the documentation, and setting (low!) expectations, and
>> keeping people engaged...
>>
>> From: http://cero2.bufferbloat.net/cerowrt/
>>
>> ""CeroWrt is an OpenWrt router platform for use by individuals,
>> researchers, and students interested in advancing the state of the art on
>> the Internet. Specifically, it is aimed at investigating the problems of
>> latency under load, bufferbloat, wireless-n, QoS, and the effects of various
>> TCP algorithms on shared networks.""
>>
>> If there is some place in the doc where we are not putting up large
>> warning signs - 'BUGS AHEAD. DANGEROUS CODE. DON'T EXPERIMENT WITH THIS ON
>> WIVES OR CHILDREN' - I'd to find it and fix it.
>>
>> I'm perfectly happy with the hardware and core software itself at this
>> point. I wasn't, this time last year.
>>
>> I'd like everybody in the open source and network research communities to
>> get TWO routers based on this chipset for christmas! Use one day to day,
>> running openwrt, and the other experimenting with a future outlined by the
>> ideas in cerowrt.
>>
>> 1) I'd like to come up with a good way for people to plug this in as a
>> 'secondary' router.
>>
>> Right now that requires turning off nat, and telling the upstream router
>> to give the cerowrt router a static ip and route to the 172 dot 30 dot 42
>> dot 0 slash 24 address. Perhaps we can take some screenshots of how to do
>> that on more common CPE?
>>
>> Network renumbering involves running a couple line sed script.
>>
>> http://www.bufferbloat.net/projects/cerowrt/wiki/Default_network_numbering
>>
>> I hope to make renumbering a router easier with a gui, but you know, it's
>> a 3 line sed script and a couple hundred lines of gui to write to make that
>> easier.
>> I'm also thinking of merely writing an RFC standardizing that 192 dot 168
>> dot zero dot 1 should be the number ALL routers come up on, and the number
>> all home networks should use. For april 1st.
>>
>> Bridging is also possible... but not very.
>>
>> 2) Another thought is to do builds of the ceropackages repository for
>> straight openwrt, and point people at that for things like the bleeding edge
>> samba stuff.
>>
>> I like ceropackages, it's a good way to spin up and debug a new package,
>> with a low barrier to entry for new people to openwrt - after which it has
>> always been my intent to push the stable stuff upstream. Multiple grad
>> students have used the ceropackages concept to get up to speed somewhat and
>> steve walker's been great about polishing those up. (and also submitting
>> packages of his own)
>>
>> 3) Is to more aggressively push up the stuff that works into std openwrt.
>> This is currently blocked by something stupid
>>
>> http://www.bufferbloat.net/issues/319
>>
>> or convince someone to push the stable stuff up to openwrt on a regular
>> basis.
>>
>> 5) Increase the number of people doing active development and able to fix
>> bugs and documentation.
>>
>> Any other ideas as to accomplish these mutually incompatable goals - gain
>> developers, increase the userbase, gain testers,get good day to day and long
>> term resolve, solve bufferbloat, establish world peace, and be able to do
>> bleeding edge R&D... are welcomed.
>>
>> I do not ever want to disappoint people with our efforts, and will work
>> diligently at fixing every problem exposed by the new stuff we're doing. One
>> of my first thoughts was pretty simple in this area though - try to do less
>> new stuff!
>>"
314,David Taht,2011-12-17 00:37:50.429874,"On Sat, Dec 17, 2011 at 9:30 AM, Dave Taht <dave.taht@gmail.com> wrote:
> On Thu, Dec 15, 2011 at 10:07 AM, Maxim Kharlamov <mcs@podsolnuh.biz> wrote:

> The core difference here at this point between cerowrt and openwrt is the vastly
> reduced tx rings and txqueues - you can add these into openwrt easily by editing
> /etc/init.d/boot to run ethtool at the right time,  and adding
> /etc/hotplug.d/iface/00-debloat to openwrt.

Another core difference is that on cerowrt's wireless, I did much more
extensive
diffserv classification than what's currently in the kernel mainline
and openwrt.

In particular, one thing you can really 'feel' is that stuff with the
IMM bit set
(notably ssh), gets dumped into the VI queue, and that helps ssh a LOT.

Unfortunately that series of patches was terribly hacky and I still haven't
found a good way to rework them for submittal upstream.

You easily get the same behavior for things like ssh via iptables."
324,Dave Täht,2011-12-18 01:11:17.377306,"Well, still failing to get bql backported. Even with the clock set to normal

<pre>
[   12.019531] WARNING: at net/sched/sch_generic.c:255 dev_watchdog+0x164/0x26c()
[   12.027343] NETDEV WATCHDOG: eth0 (ag71xx): transmit queue 0 timed out
[   12.031250] Modules linked in: usb_storage ohci_hcd ehci_hcd sd_mod ext4 jbd2 mbcache usbcore scsi_mod nls_base crc16 leds_gpio button_hotplug gpio_keys_polled input_polldev input_core
[   12.046875] Call Trace:
[   12.050781] [<8028ad2c>] dump_stack+0x8/0x34
[   12.054687] [<80075ee8>] warn_slowpath_common+0x78/0xa4
[   12.062500] [<80075f9c>] warn_slowpath_fmt+0x2c/0x38
[   12.066406] [<80207738>] dev_watchdog+0x164/0x26c
[   12.070312] [<800807e0>] run_timer_softirq+0x14c/0x1ec
[   12.074218] [<8007b8e4>] __do_softirq+0xac/0x15c
[   12.078125] [<8007baec>] do_softirq+0x48/0x68
[   12.085937] [<8007bd20>] irq_exit+0x4c/0xb8
[   12.089843] [<8006290c>] ret_from_irq+0x0/0x4
[   12.093750] [<80062b00>] r4k_wait+0x20/0x40
[   12.097656] [<800645d4>] cpu_idle+0x30/0x60
[   12.101562] [<803208fc>] start_kernel+0x37c/0x39c
[   12.105468]
[   12.109375] ---[ end trace e5f75eb1aac959a8 ]---
</pre>"
324,Hector Ordorica,2011-12-18 13:05:47.333357,"Just to add to this in my own building of openwrt trying to use combinations of config_hz 1000, forced preemption, and voluntary preemption:

1. Using forced (desktop) preemption causes the above bug. Even if you use a slower clock interval. Interestingly, even though this appears: ""BUG: scheduling while atomic: swconfig/1340/0x00000002"", after a minute or so, the ethernet chips start functioning fine (perhaps with a release and renew on the connected clients). The wireless doesn't appear to be affected.

2. Using config_hz 1000 with server or voluntary preemption, a similar issue occurs were the ethernet switch seems to fail, but I see no immediate error logs in the kernel message. Wireless again appears to be ok.

3. I can build a successful firmware using voluntary preemption and config_hz 250. The router seems stable using voluntary preemption. Perhaps using a custom HZ value (like 500) could be a workaround."
320,Dave Täht,2011-12-19 02:24:42.480139,"nobody expressed love for it, I'm dropping it. current patch no longer applies"
303,Dave Täht,2011-12-19 02:26:10.95052,"I have stuck this version into cerowrt by default and updated luci to be able to use it.

As for this being a correct configuration - no, needs work."
324,Dave Täht,2011-12-19 02:35:21.38297,"Have you noticed any positive effects from your configuration? 

In my case I was hoping for mildly better behavior from QFQ, which I seem to be getting."
314,Dave Täht,2011-12-19 03:02:27.030442,"I stuck 3.6.1 into the latest bql smoketest. It's huge. But it's there if anyone wants to play with it.

https://lists.bufferbloat.net/pipermail/cerowrt-devel/2011-December/000041.html"
324,Hector Ordorica,2011-12-19 18:34:12.56426,"I'm not much of a kernel hacker, but I think I was able to override the kernel tick timer by editing:

build_dir/toolchain-mips_r2_gcc-4.5-linaro_uClibc-0.9.32/linux/arch/arm/include/asm/param.h

But I may be wrong since I think that gets overwritten from source when building the kernel? I also tried to set config_hz_500=y and config_hz=500 in the relevant config files, but I'm not sure if they are sticking. Any help would be appreciated on how to actually change the default.

Anyways, enabling kernel timing stats debugging and installing powertop, I see there are about 400 ""wakeups-from-idle per second"" when doing minor browsing. Ath9k uses about 170 in idle. So I'd argue that we need just around 500Hz just to maintain responsiveness at least on the software side. I'm guessing that the interrupts can go much higher than the defined 500Hz though when required, because it shoots up to 2000-3000 (eth0) when doing a simple Samba transfer.

I'm not sure how the interrupts are related to the HZ or context switching though. It's probably complicated.

One effect is that Samba transferring a bulk file from the local PC to the attached HDD much faster now, about 16MB/s vs. 12MB/s for the default HZ value. Idle times according to vmstat are also more accurate.

I'm actually just using openwrt trunk, not cerowrt. Is the cerowrt toolchain available for me to build? Then I can test QFQ.

How it affects latency? I'm not sure. Using the default QoS scripts with appropriate limits (txqueuelen, buffers, ECN, timestamps), a Netalyzer test looks the same. But then I'm not using your improved QoS scripts. 

Let me know how I can help.




"
324,Dave Täht,2011-12-19 23:15:32.307479,"the cerowrt toolchain is presently a small mass of patches flying in loose formation, and just barely buildable by me at the moment. I'll get it independently buildable again.

I'm engaged in pushing up the good stuff into openwrt as fast as I can, so others can fiddle with the good stuff (like QFQ) there. I probably won't be done doing that until after Christmas. (needed-for-me-to-cleanup-and-submit patches are the latest iproute2, and QFQ added to the kernel scheduler packages)

Your results with samba are pretty interesting. My assumption is that the samba daemon is waking up more often than it would otherwise....

Is this samba 3.0 or 3.6? I just pushed samba 3.6.1 into the ceropackages repo (which is largely buildable from normal openwrt, all you have to do is add it to your feeds.conf, and select the package in it)"
324,Dave Täht,2011-12-19 23:18:18.840942,"I'm curious as to what these are for you and your situation. It's looks like you are using an arm platform?

""default QoS scripts with appropriate limits (txqueuelen, buffers, ECN, timestamps""

I note that almost universally I'm getting better shaping results from very small tx rings - 4 in cerowrt's case. I also set the openrd (an arm platform) as low as they would go - 20 - and would like to go lower in that case."
326,David Taht,2011-12-21 20:31:56.6579,"On Thu, Dec 22, 2011 at 5:19 AM, Eric Dumazet <eric.dumazet@gmail.com> wrote:
> Le jeudi 22 décembre 2011 à 05:02 +0100, Dave Taht a écrit :
>> Eric, I think I love you.
>>
>> I'd like to slam this into cerowrt, which is based on 3.1.5 for at
>> least another month. Are there dependencies on the other work you've
>> been doing in this area I should worry about?
>>
>
> Hmm, this work depends on skb_flow_dissect() patches, included in
> net-next only for the moment...
>

(sorry for cc'ing the bug system on this one)

OK. I'm really looking forward to the upcoming next generation kernel,
but it's very hard to keep an embedded system this close to something
so bleeding edge. :/

That said, it looked plausible to to extract the flow_dissect and
adaptive-red work you've done recently, safely. I'll think upon it.

(I thought the backporting bql would be easy too,  but thus far no luck)

I've moved most of my own AQM prototyping to x86, which is now
showing useful results, thx to you, tom, and bql.

>
>"
324,Hector Ordorica,2011-12-26 16:06:30.108887,"Actually, the test with samba was the older Samba 3.0 release. I just rebuilt the openwrt trunk with 3.6, and now I'm getting 13MB/s vs 16MB/s with a large file transfer to an attached usb HDD. One thing I've noticed is that Samba 3.6 takes significantly more memory to run. The slow down may be due to RAM and cache swapping. I also have a swap file enabled for this reason (it's easy to run out of RAM).

Overall I'd take my limited benchmark with a big grain of salt. It would seem it's limited by the CPU and the scheduler giving the smbd process enough time (also giving the USB interface enough time). I also tried setting the TCP TOS for samba to TCP_CORK since I was doing mainly bulk transfers.

As for my QoS settings; with my slow connection (6000Kbps/1000Kbps), using a txqueuelen of 2 rarely drops packets. I have only a handful of dropped packets over the course of a week. On my Windows 7 clients, the ethernet driver also allows me to set TX and RX buffers to 2. This is pretty good, because I have some other clients that only allow 128 or 256 minimums.

ECN and timestamps are enabled. I don't see why they aren't enabled by default in openwrt trunk. I also enabled them on my Windows 7 clients.

I tried applying ethtool -G eth0 rx 16 tx 16, and various other values, on my WNDR3700v2, but it crashes the router immediately. I can set a higher value, rx 64 tx 64, and it doesn't crash immediately, but eventually (over the course of a few hours).

I seen your ticket about applying ethtool very early in the boot process, so I will try that next. Can you link to the boot file I can edit to apply that?
"
324,Dave Täht,2011-12-27 13:10:22.687899,"You are experiencing packet drops (everyone does) but they are just hidden somewhere in the system.

Anyway, to reduce latency on the driver side:

See the two ethtool lines in:

https://github.com/dtaht/cerofiles/blob/master/files/etc/init.d/boot

This was the only way I was able to reduce the tx ring to sanity was here, before it booted fully.

I've gone as low as 2, actually, but that did cut bandwidth (helped on latency, though), and I do hope that BQL will run at 16 to 64  as well or better as things run now at tx 4.

I have been running of late with qfq or sfq, and a longer txqueuelen (150 or so). SFQ and QFQ help a lot on wireless, not so much at gigE speeds, but help a lot at 100Mbit or less (with an uplink)

I have some scripts I'm working on in the deBloat repo that almost work on openwrt as I write."
324,Hector Ordorica,2011-12-28 19:53:12.637218,"I tried setting ethtool -G eth0 rx 16 tx 16 in my boot config, but the router refuses to boot. It just hangs during the init process.

The lowest I can successfully boot is tx 64 rx 64 for eth0 and eth1. I'm using the latest openwrt trunk. I also tried 32, 8, 2. The defaults are tx 64 rx 128.

Are you only changing the tx value? Perhaps that's the difference."
324,Hector Ordorica,2011-12-29 12:31:49.140389,"Just an update on Samba. Turns out that the samba socket options have a big effect on bulk transfer performance.

TCP_CORK alone has worse performance for bulk transfers than just TCP_NODELAY.

The best combination I found was:

socket options = TCP_NODELAY IPTOS_LOWDELAY TCP_CORK SO_SNDBUF=65536 SO_RCVBUF=65536.

Those options held network utilization at 15.5% on a 1Gbit connection.

Increasing the buffer size allowed me to obtain 18MB/s transfer rates to the attached USB HDD. 32768 sized buffers also worked almost as well."
327,Dave Täht,2012-01-16 11:13:52.937499,"
Most of what was in cerowrt is now in openwrt, they have releases that will fit for you. The next generation of cerowrt will be linux 3.3 based, and I'm not planning on ever being able to fit into 8MB of flash. It's impossible to fit everything, notably the debugging tools, into something that small.
"
324,Dave Täht,2012-01-16 11:15:23.096762,">The lowest I can successfully boot is tx 64 rx 64 for eth0 and eth1. I'm using the latest openwrt >trunk. I also tried 32, 8, 2. The defaults are tx 64 rx 128.

TX rings and RX rings are very different. I usually set TX to 2 or 4 in the early stage boot process (in the /etc/init.d/boot script), and don't touch the rx ring - which should be about 128...
"
316,David Taht,2012-01-16 11:20:44.088143,"I was hoping this would be simple

That said, I'm really reluctant to put bind back in there without a gui.

---------- Forwarded message ----------
From: Thomas Heil <heil@terminal-consulting.de>
Date: Mon, Jan 16, 2012 at 8:18 PM
Subject: Re: [OpenWrt-Devel] [OpenWrt-Tickets] [OpenWrt] #10773:
Unable to compile bind-server package.
To: openwrt-devel@lists.openwrt.org


Hi,

Could you try patch for the bind Makefile. Iam not quite sure, why
$(STAGING_DIR)/usr/include is not
included by default

regards,
thomas"
328,Hector Ordorica,2012-01-16 16:45:21.779934,""
316,David Taht,2012-01-19 00:48:20.73502,"This is being tracked at:

https://dev.openwrt.org/ticket/10773"
329,Dave Täht,2012-01-21 05:40:59.090428,"That's the third or 4th time I've seen remote cpu utiliziation go beyond 100% on a single cpu box.

I don't think that better cpu scheduling is going to be too helpful - it may help on things like samba - I have found, however, that running at higher clock rates (256HZ was the last I tried)
seemed to improve responsiveness somewhat. I hope one day to quantify that with a non-debug build 
(I was at one point achieving > 500Mbit throughput through these boxes, and now rarely crack 260 - but I have tons of debug code on at present)

The most productive thing I've found is to run a given benchmark through the router, not on the router, and look at the results with oprofile. "
316,Dave Täht,2012-01-21 06:01:24.633995,"this has been fixed upstream, but a fresh checkout of openwrt and a complete rebuild-from-scratch is required..."
330,Dave Täht,2012-01-21 10:42:27.73737,"There were 10s of thousands of commits between that first release and today.

Assuming it's fixed now, finding the bug would take a Time Lord going back 260 days several dozen times, doing a git bisect and a new build each time.

If a dark and stormy 260th night is also required, we also have to make sure the wrong butterfly doesn't flap its wings as we mutate the future.

If it isn't fixed already...

Hmmm.... this will be hard to reproduce. Please pay no attention to the blue police box on your street-corner."
330,Dave Täht,2012-01-21 10:44:10.579769,"Actually, now that I think about it, getting a Time Lord involved would eliminate the need for git bisect. A sonic screwdriver should have enough multi-dimensional capabilities.

So that simplifies the problem. I'm in the right country right now to do something about it."
327,Dave Täht,2012-01-28 07:56:24.125027,"At some point I may try again to fit cerowrt into 8MB flash. Right now, though, even the squashfs version is over 8MB in size. In the interim I will try to get better about pushing patches upstream than I have been, so that others can play with the new algos."
310,Dave Täht,2012-01-28 09:30:46.333274,"I have successfully backported BQL to 3.2.2 and tested on x86 with the e1000e driver.

My attempt at wedging BQL support into the ag71xx driver, however, fails. It does
get one packet out... So I have to look harder at the relevant drivers and see where
I went wrong.


[   12.560000] USB Mass Storage support registered.
[   17.050000] ------------[ cut here ]------------
[   17.050000] WARNING: at net/sched/sch_generic.c:256 dev_watchdog+0x178/0x280()
[   17.060000] NETDEV WATCHDOG: eth0 (ag71xx): transmit queue 0 timed out
[   17.060000] Modules linked in: usb_storage ohci_hcd ehci_hcd sd_mod ext4 jbd2 mbcache usbcore usb_common scsi_mod nls_base crc16 leds_gpio button_hotplug(O) gpio_keys_polled input_polldev input_core
[   17.080000] Call Trace:
[   17.080000] [<802818e8>] dump_stack+0x8/0x34
[   17.090000] [<80075e58>] warn_slowpath_common+0x78/0xa4
[   17.090000] [<80075f0c>] warn_slowpath_fmt+0x2c/0x38
[   17.100000] [<801fd2dc>] dev_watchdog+0x178/0x280
[   17.100000] [<80080528>] run_timer_softirq+0x14c/0x1ec
[   17.110000] [<8007b674>] __do_softirq+0xac/0x15c
[   17.110000] [<8007b87c>] do_softirq+0x48/0x68
[   17.120000] [<80062bec>] ret_from_irq+0x0/0x4
[   17.120000] [<80062de0>] r4k_wait+0x20/0x40
[   17.130000] [<800648a8>] cpu_idle+0x24/0x44
[   17.130000] [<803148c8>] start_kernel+0x37c/0x39c
[   17.130000] 
[   17.140000] ---[ end trace ad0f0a4fc2f62e9d ]---
[   17.140000] eth0: tx timeout
[   17.140000] eth0: link down
[   17.150000] ar71xx: pll_reg 0xb8050010: 0x11110000
[   17.150000] eth0: link up (1000Mbps/Full duplex)
[   27.050000] eth0: tx timeout
[   27.050000] eth0: link down
[   27.050000] ar71xx: pll_reg 0xb8050010: 0x11110000
[   27.050000] eth0: link up (1000Mbps/Full duplex)
[   32.830000] eth0: link down
[   35.940000] Compat-wireless backport release: compat-wireless-2011-11-29
[   35.940000] Backport based on wireless-testing.git master-2011-12-01
[   35.970000] cfg80211: Calling CRDA to update world regulatory domain
[   36.390000] NET: Registered protocol family 10
[   36.850000] cfg80211: World regulatory domain updated:
[   36.850000] cfg80211:     (start_freq - end_freq @ bandwidth), (max_antenna_gain, max_eirp)
[   36.860000] cfg80211:     (2402000 KHz - 2472000 KHz @ 40000 KHz), (300 mBi, 2000 mBm)
[   36.870000] cfg80211:     (2457000 KHz - 2482000 KHz @ 20000 KHz), (300 mBi, 2000 mBm)
[   36.880000] cfg80211:     (2474000 KHz - 2494000 KHz @ 20000 KHz), (300 mBi, 2000 mBm)
[   36.880000] cfg80211:     (5170000 KHz - 5250000 KHz @ 40000 KHz), (300 mBi, 2000 mBm)
[   36.890000] cfg80211:     (5735000 KHz - 5835000 KHz @ 40000 KHz), (300 mBi, 2000 mBm)
[   37.870000] PCI: Enabling device 0000:00:11.0 (0000 -> 0002)
[   37.890000] ath: EEPROM regdomain: 0x0
[   37.890000] ath: EEPROM indicates default country code should be used
[   37.890000] ath: doing EEPROM country->regdmn map search
[   37.890000] ath: country maps to regdmn code: 0x3a
[   37.890000] ath: Country alpha2 being used: US
[   37.890000] ath: Regpair used: 0x3a
[   37.890000] ieee80211 phy0: Selected rate control algorithm 'minstrel_ht'
[   37.890000] Registered led device: ath9k-phy0
[   37.890000] ieee80211 phy0: Atheros AR9280 Rev:2 mem=0xb0000000, irq=40
[   37.900000] PCI: Enabling device 0000:00:12.0 (0000 -> 0002)
[   37.910000] ath: eeprom contains invalid mac address: ff:ff:ff:ff:ff:ff
[   37.920000] ath: random mac address will be used: ea:79:26:a7:81:75
[   37.920000] ath: EEPROM regdomain: 0x0
[   37.920000] ath: EEPROM indicates default country code should be used
[   37.920000] ath: doing EEPROM country->regdmn map search
[   37.920000] ath: country maps to regdmn code: 0x3a
[   37.920000] ath: Country alpha2 being used: US
[   37.920000] ath: Regpair used: 0x3a
[   37.930000] ieee80211 phy1: Selected rate control algorithm 'minstrel_ht'
[   37.930000] Registered led device: ath9k-phy1
[   37.930000] ieee80211 phy1: Atheros AR9280 Rev:2 mem=0xb0010000, irq=41
[   37.940000] cfg80211: Calling CRDA for country: US
[   38.160000] cfg80211: Regulatory domain changed to country: US
[   38.170000] cfg80211:     (start_freq - end_freq @ bandwidth), (max_antenna_gain, max_eirp)
[   38.180000] cfg80211:     (2402000 KHz - 2472000 KHz @ 40000 KHz), (300 mBi, 2700 mBm)
[   38.180000] cfg80211:     (5170000 KHz - 5250000 KHz @ 40000 KHz), (300 mBi, 1700 mBm)
[   38.190000] cfg80211:     (5250000 KHz - 5330000 KHz @ 40000 KHz), (300 mBi, 2000 mBm)
[   38.200000] cfg80211:     (5490000 KHz - 5600000 KHz @ 40000 KHz), (300 mBi, 2000 mBm)
[   38.210000] cfg80211:     (5650000 KHz - 5710000 KHz @ 40000 KHz), (300 mBi, 2000 mBm)
[   38.220000] cfg80211:     (5735000 KHz - 5835000 KHz @ 40000 KHz), (300 mBi, 3000 mBm)
[   38.360000] PPP generic driver version 2.4.2
[   38.450000] tun: Universal TUN/TAP device driver, 1.6
[   38.450000] tun: (C) 1999-2004 Max Krasnyansky <maxk@qualcomm.com>
[   38.480000] IPv6 over IPv4 tunneling driver
[   38.580000] GRE over IPv4 demultiplexor driver
[   38.640000] GRE over IPv4 tunneling driver
[   38.720000] ip_tables: (C) 2000-2006 Netfilter Core Team
[   38.890000] NET: Registered protocol family 24
[   38.950000] nf_conntrack version 0.5.0 (963 buckets, 3852 max)
[   39.050000] PPTP driver version 0.8.5
[   39.290000] xt_time: kernel timezone is -0000
[   39.480000] ip6_tables: (C) 2000-2006 Netfilter Core Team
[   41.350000] ADDRCONF(NETDEV_UP): ge00: link is not ready
[   43.030000] ar71xx: pll_reg 0xb8050010: 0x11110000
[   43.030000] se00: link up (1000Mbps/Full duplex)
[   48.080000] ADDRCONF(NETDEV_UP): sw00: link is not ready
[   50.770000] ADDRCONF(NETDEV_UP): gw01: link is not ready
[   53.050000] se00: tx timeout
[   53.050000] se00: link down
[   53.050000] ar71xx: pll_reg 0xb8050010: 0x11110000
[   53.050000] se00: link up (1000Mbps/Full duplex)
[   53.470000] ADDRCONF(NETDEV_UP): sw10: link is not ready
[   57.840000] gw01: Creating new IBSS network, BSSID ce:05:e9:34:0c:37
[   57.840000] ADDRCONF(NETDEV_CHANGE): gw01: link becomes ready
[   58.750000] ADDRCONF(NETDEV_UP): gw11: link is not ready
[   63.050000] se00: tx timeout
[   63.050000] se00: link down
[   63.050000] ar71xx: pll_reg 0xb8050010: 0x11110000
[   63.050000] se00: link up (1000Mbps/Full duplex)
[   67.040000] gw11: Creating new IBSS network, BSSID a2:37:f6:1d:cc:2e
[   67.040000] ADDRCONF(NETDEV_CHANGE): gw11: link becomes ready
[   73.050000] se00: tx timeout
[   73.050000] se00: link down
[   73.050000] ar71xx: pll_reg 0xb8050010: 0x11110000
[   73.050000] se00: link up (1000Mbps/Full duplex)
[   83.050000] se00: tx timeout
[   83.050000] se00: link down
[   83.050000] ar71xx: pll_reg 0xb8050010: 0x11110000
[   83.050000] se00: link up (1000Mbps/Full duplex)
[   93.050000] se00: tx timeout
[   93.050000] se00: link down
[   93.050000] ar71xx: pll_reg 0xb8050010: 0x11110000
[   93.050000] se00: link up (1000Mbps/Full duplex)
[  103.050000] se00: tx timeout
[  103.050000] se00: link down
[  103.050000] ar71xx: pll_reg 0xb8050010: 0x11110000
[  103.050000] se00: link up (1000Mbps/Full duplex)
[  113.050000] se00: tx timeout
[  113.050000] se00: link down
[  113.050000] ar71xx: pll_reg 0xb8050010: 0x11110000
[  113.050000] se00: link up (1000Mbps/Full duplex)
[  123.050000] se00: tx timeout
[  123.050000] se00: link down
[  123.050000] ar71xx: pll_reg 0xb8050010: 0x11110000
[  123.050000] se00: link up (1000Mbps/Full duplex)
"
310,Dave Täht,2012-01-28 09:31:43.90712,""
310,Dave Täht,2012-01-28 14:50:20.779446,I got it working... now to test.
329,Dave Täht,2012-01-29 14:29:34.904677,"From a cpu perspective there are other things to try than the scheduler, but
I would suggest oprofiling under your workload first, rather than anything else."
326,Dave Täht,2012-01-29 14:32:19.14335,"I abstracted out BQL, this patch, etc and backported to 3.2.2.

I note that the permute option only works in the background with the 
default filters (I think), and I think that I need to use the pre-nat
ips in order to get saner SFQ out the other end... but we'll see.

Certainly the old method would put in a nasty 10 second disturbance. Perhaps we'll
see different behavior now, but traces are needed to see what happens.
"
325,Dave Täht,2012-01-29 15:28:24.506697,This patch is in 3.2.2 for sure and also backported to stable.
324,Dave Täht,2012-01-29 15:29:33.336944,"My latest efforts use bql, which eliminates (theoretically) the need to fiddle with tx rings at all.

I do plan to revisit the clock issue at some point tho."
310,Dave Täht,2012-01-29 15:31:03.200181,I am happy to report I got bql backported to 3.2.2 successfully. Or so I think.
299,Dave Täht,2012-01-29 15:35:24.85204,"Nag. I'm planning to do this on the router, anyway, but..."
294,Dave Täht,2012-01-29 15:37:00.45973,"I believe this to be basically fixed. I wouldn't mind if I could change a few
fixed parameters to be larger values based on the extra ram (bind for one), but
it's good enough...."
292,Dave Täht,2012-01-30 15:17:52.366725,""
332,David Taht,2012-01-30 15:25:22.847935,"---------- Forwarded message ----------
From: Jesper Dangaard Brouer <jdb@comx.dk>
Date: Thu, Jan 26, 2012 at 10:38 AM
Subject: Problem with the SFQ patch: dont put new flow at the end of flows
To: Eric Dumazet <eric.dumazet@gmail.com>
Cc: Dave Taht <dave.taht@gmail.com>


Hi Eric
(Cc Dave Taht)

I think I have found a problem with your SFQ patch:
 sch_sfq: dont put new flow at the end of flows (d47a0ac7b66 net-next).

Do you want to discuss this on netdev or offlist?

My preliminary finding is, that is works really nice, until I reach the
queue ""limit"", then new flow almost cannot get through.  With the patch
reverted this is not a problem, although of-cause with significantly
higher latency.

I'm currently running v3.2.1-stable with you and other patches applied.
I will re-run my tests on a clean net-next soon (just need my SFP+ patch
on top)... just to verify the results.

My setup is a HTB root node with a 2Mbit/s bandwidth limit, and a SFQ
qdisc attached, which have limit 10.
(This is on a 10Gbit/s NIC, thats not a problem, right?)

albpd42:~# tc class ls dev eth61
class htb 1: root leaf 42: prio 0 rate 2000Kbit ceil 2000Kbit burst
1600b cburst 1600b

albpd42:~# tc qdisc ls dev eth61
qdisc htb 1: root refcnt 65 r2q 10 default 0 direct_packets_stat 0
qdisc sfq 42: parent 1: limit 10p quantum 1514b

The test that revels the problem is fairly simple:

1. xterm running ""ping -nA 10.10.61.2"" as non-root user, thus minimal
ping interval is 200msec.

2. On sink 10.10.61.2 run ""iperf -s -i10""

3. On source 10.10.61.1, I run: ""iperf -c 10.10.61.2 -t 1000 -i 2 -P XXX""

If the number of parallel connection is below 10 (-P 10), then is works
very good, with very low ping times.

If the number of parallel connection is above 10, that is larger than
the SFQ limit on 10, things turn bad... and the ping drops almost all
packets.   With the patch reverted, ping packets get through, with a
higher latency, but also with some dropped packets (but no as bad as the
other case).

I don't know the SFQ code well enough to fix the issue my self, so I'm
asking for you guidance...

Another corrolation is, that the problem occurs, when the following
command reach the SFQ limit of 10.

 tc class ls dev eth61 | grep 'sfq' | wc -l"
332,David Taht,2012-01-30 15:26:08.533382,"---------- Forwarded message ----------
From: Jesper Dangaard Brouer <jdb@comx.dk>
Date: Thu, Jan 26, 2012 at 11:57 AM
Subject: Re: Problem with the SFQ patch: dont put new flow at the end of flows
To: Eric Dumazet <eric.dumazet@gmail.com>
Cc: Dave Taht <dave.taht@gmail.com>


On Thu, 2012-01-26 at 11:03 +0100, Eric Dumazet wrote:
> Le jeudi 26 janvier 2012 à 10:38 +0100, Jesper Dangaard Brouer a écrit :
[...]
> > Another corrolation is, that the problem occurs, when the following
> > command reach the SFQ limit of 10.
> >
> >  tc class ls dev eth61 | grep 'sfq' | wc -l
> >
>
> Hi Jesper
>
> If you have more than 10 flows and a queue limit of 10, then each time a
> new packet is enqueued, an 'old packet in queue' must be chosen and
> dropped.
>
> This 'old packet' is chosen, using the ""longest flow"".
>
> But if all flows have one packet, then what can we do ...

I think this is the exact case, all flows have one packet.
This is also given by the ""tc | wc -l"" command.

> It can be the ""ping packet"" by luck. Why would it be more important than
> an other ?

Because it represent a new connection establishment.

> # vi +341 net/sched/sch_sfq.c
>         if (d == 1) {
>                 /* It is difficult to believe, but ALL THE SLOTS HAVE LENGTH 1. */
>                 x = q->tail->next;
>                 slot = &q->slots[x];
>                 q->tail->next = slot->next;
>                 q->ht[slot->hash] = SFQ_EMPTY_SLOT;
>                 goto drop;
>         }
>
> This part of the code really takes whatever packet, and changing it might
> solve your problem but is it a real one ?

This is an oversimplified example,

> There is no guarantee the 'ping packet' cannot be dropped, with old SFQ or new SFQ.

The probability of dropping is just significantly higher in the new
SFQ.


On Thu, 2012-01-26 at 11:22 +0100, Eric Dumazet wrote:
Le jeudi 26 janvier 2012 à 11:03 +0100, Eric Dumazet a écrit :
>
> By the way, above code implements a head-drop :)

Aha - thats why the ping/new-conn packets are getting dropped in the new
SFQ, as new flows are put a head in the queue!


> Mostbly because a tail-drop would be very expensive : We would need to
> add a double linked list instead of a single link, or scan the whole
> list to find the element right before the tail.

Yes, we want/need an inexpensive operation here.
I just think its problematic that new flows will suffer.

The real-life case that I'm worried about with this drop behaviour, is
the fairness among flows, e.g. TCP flows.  Once we reach the queue
limit, number of TCP flows, no new TCP flows can be established, thus
being unfair to new flows.  Guess, I have to find a test showing this..."
332,David Taht,2012-01-30 15:26:54.238335,"---------- Forwarded message ----------
From: Eric Dumazet <eric.dumazet@gmail.com>
Date: Thu, Jan 26, 2012 at 3:33 PM
Subject: Re: Problem with the SFQ patch: dont put new flow at the end of flows
To: jdb@comx.dk
Cc: Dave Taht <dave.taht@gmail.com>


Le jeudi 26 janvier 2012 à 15:04 +0100, Jesper Dangaard Brouer a écrit :
> On Thu, 2012-01-26 at 14:50 +0100, Jesper Dangaard Brouer wrote:
> > > Ah. I was not running with a limit that low, but at 50-300.
> >
> > With a packet limit <= 128, the results should be reproduce-able, as
> > the ""depth"" is fixed on 128.
> >
> > I'm using a too old ""tc"" to adjust the ""depth"".
>
> Just, git downloaded the latest ""tc"".
>
> And I think I mean ""flows"" instead of ""depth"" in the above statements,
> sorry! (after reading the just committed manual update by Eric ;-))
>
> I'm still a little confused.  How is the ""flows"" related to the hash
> table size ""divisor""?
> Should I reduce ""divisor"" to 256, to save memory, as in my setup I have
> a sfq per customer (per interface). As, I guess I can live with some
> collisions with 127 flows?
>
>
>


Hmm, if you reduce hash divisor, you also favor hash collisions.

It all depends on the memory you want to save I would say.

1024 divisor is quite good for 127 flows I guess."
332,David Taht,2012-01-30 15:27:19.149036,"---------- Forwarded message ----------
From: Jesper Dangaard Brouer <jdb@comx.dk>
Date: Mon, Jan 30, 2012 at 11:17 PM
Subject: Re: Problem with the SFQ patch: dont put new flow at the end of flows
To: Eric Dumazet <eric.dumazet@gmail.com>
Cc: Dave Taht <dave.taht@gmail.com>


On Thu, 2012-01-26 at 12:12 +0100, Eric Dumazet wrote:

> To avoid this problem, you can limit number of flows to N and number
> of packets to N+1 : This way there is always one flow with 2 packets.

That does help, with packets = flows+1, but its not stable and
""falls-back"" into the bad mode (of a single flow winning).  I have to
increase it some more to get good results.

E.g. limit 20 and flows 10, allows 10 TCP flows to share the bandwidth,
BUT the ping program does NOT get any packets through (thus, no new
connections can be established, which is bad).


> Quite frankly, SFQ should not be limited to 10 packets.

I can provoke the exact same behaviour with the default 127 packets, and
129 TCP flows (thrulay -m 129 10.10.61.2).  Only a single flow out of
129 gets any throughput.


Side note:
I noticed that adding SFQ without any params, will give limit 127p and
flows 128.

albpd42:~# ~jdb/git/iproute2/tc/tc -d -s q ls dev eth61
qdisc htb 1: root refcnt 65 r2q 10 default 2 direct_packets_stat 0 ver 3.17
 Sent 405048608 bytes 293646 pkt (dropped 74779, overlimits 660160 requeues 0)
 backlog 0b 127p requeues 0
qdisc sfq 2: parent 1:2 limit 127p quantum 1514b depth 127 flows
128/1024 divisor 1024
 Sent 12350969 bytes 8748 pkt (dropped 3369, overlimits 0 requeues 0)
 backlog 189382b 127p requeues 0

But I cannot create the same manually config by:

albpd42:~# ~jdb/git/iproute2/tc/tc qdisc del dev eth61 parent 1:2 handle 2:
albpd42:~# ~jdb/git/iproute2/tc/tc qdisc add dev eth61 parent 1:2
handle 2: sfq limit 127 flows 128
albpd42:~# ~jdb/git/iproute2/tc/tc -d -s q ls dev eth61
qdisc htb 1: root refcnt 65 r2q 10 default 2 direct_packets_stat 0 ver 3.17
 Sent 410090878 bytes 297341 pkt (dropped 75611, overlimits 668278 requeues 0)
 backlog 0b 0p requeues 0
qdisc sfq 2: parent 1:2 limit 127p quantum 1514b depth 127 flows
127/1024 divisor 1024
 Sent 0 bytes 0 pkt (dropped 0, overlimits 0 requeues 0)
 backlog 0b 0p requeues 0

Guess it makes sense that I'm not allowed to create more flows than
packets, but the default config does that... strange."
332,David Taht,2012-01-30 15:29:25.824528,"---------- Forwarded message ----------
From: Jesper Dangaard Brouer <jdb@comx.dk>
Date: Thu, Jan 26, 2012 at 1:15 PM
Subject: Re: Problem with the SFQ patch: dont put new flow at the end of flows
To: Eric Dumazet <eric.dumazet@gmail.com>
Cc: Dave Taht <dave.taht@gmail.com>


On Thu, 2012-01-26 at 11:57 +0100, Jesper Dangaard Brouer wrote:
> The real-life case that I'm worried about with this drop behaviour, is
> the fairness among flows, e.g. TCP flows.  Once we reach the queue
> limit, number of TCP flows, no new TCP flows can be established, thus
> being unfair to new flows.  Guess, I have to find a test showing
> this...

The fairness among flows seems to be broken with the patch.

In using the tool ""thrulay"" as it gives a nice output per TCP
connection. The important column is ""Mb/s"" (is also have RTT which is
also very useful, when troubleshooting latency/queue issues, but its not
important here).

Command starting 12 TCP flows:
 albpd42:~# thrulay -m 12 10.10.61.2

I have only included the sum after 60 sec test.

First test *without* patch:

# local window = 262142B; remote window = 262142B
# block size = 8192B
# MTU: 1500B; MSS: 1448B; Topology guess: Ethernet/PPP
# MTU = getsockopt(IP_MTU); MSS = getsockopt(TCP_MAXSEG)
# test duration = 60s; reporting interval = 1s
[... cut ...]
#(ID) begin, s   end, s  Mb/s    RTT, ms: min  avg     max
#( 0)    0.000   60.000    0.085  614.475 10510.368 37648.921
#( 1)    0.000    0.000    0.000    0.000    0.000    0.000
#( 2)    0.000   60.000    0.001 49749.240 49749.240 49749.240
#( 3)    0.000   60.000    0.198  389.384 4483.202 7644.653
#( 4)    0.000   60.000    0.167  401.534 5262.690 16491.171
#( 5)    0.000   60.000    0.201  413.688 4410.953 9893.164
#( 6)    0.000   60.000    0.167  438.016 5293.815 10324.560
#( 7)    0.000   60.000    0.226  468.394 3982.983 5716.139
#( 8)    0.000   60.000    0.218  486.621 4117.844 6094.251
#( 9)    0.000   60.000    0.189  517.020 4790.583 10386.741
#(10)    0.000   60.000    0.209  480.531 4331.842 7406.696
#(11)    0.000   60.000    0.223  504.839 4001.091 5681.422
#(**)    0.000   60.000    1.884  389.384 8411.218 49749.240

Notice the fairshare between the flows.
Also notice that flow id (1) has an ""end,s"" of 0,  I think than means
that it was not able establish the connection.

Second test *with* the patch:

albpd42:~# thrulay -m 12 10.10.61.2
# local window = 262142B; remote window = 262142B
# block size = 8192B
# MTU: 1500B; MSS: 1448B; Topology guess: Ethernet/PPP
# MTU = getsockopt(IP_MTU); MSS = getsockopt(TCP_MAXSEG)
# test duration = 60s; reporting interval = 1s
#(ID) begin, s   end, s  Mb/s    RTT, ms: min  avg     max
#( 0)    0.000    0.000    0.000    0.000    0.000    0.000
#( 1)    0.000    0.000    0.000    0.000    0.000    0.000
#( 2)    0.000    0.000    0.000    0.000    0.000    0.000
#( 3)    0.000    0.000    0.000    0.000    0.000    0.000
#( 4)    0.000   60.000    1.902  127.884  489.294  583.101
#( 5)    0.000    0.000    0.000    0.000    0.000    0.000
#( 6)    0.000    0.000    0.000    0.000    0.000    0.000
#( 7)    0.000    0.000    0.000    0.000    0.000    0.000
#( 8)    0.000    0.000    0.000    0.000    0.000    0.000
#( 9)    0.000    0.000    0.000    0.000    0.000    0.000
#(10)    0.000    0.000    0.000    0.000    0.000    0.000
#(11)    0.000    0.000    0.000    0.000    0.000    0.000
#(**)    0.000   60.000    1.902  127.884   40.774  583.101

This result show a *very* unfair sharing.  Only one TCP flow are getting
data through! -- I expected to see a more unfair behaviour towards new
flows, but this is a bit extreme... something else must be wrong! Cannot
understand this change should make it that unfair!

I have tried to re-run the tests several times.  I have also tested with
iperf, and I get similar results:

[ 14]  0.0-60.0 sec  13.6 MBytes  1.90 Mbits/sec
[ 12]  0.0-60.1 sec  56.0 KBytes  7.64 Kbits/sec
[  9]  0.0-60.1 sec  16.0 KBytes  2.18 Kbits/sec
[  7]  0.0-60.2 sec  16.0 KBytes  2.18 Kbits/sec
[  6]  0.0-60.2 sec  16.0 KBytes  2.18 Kbits/sec
[SUM]  0.0-60.2 sec  14.2 MBytes  1.98 Mbits/sec
[  5]  0.0-60.4 sec  16.0 KBytes  2.17 Kbits/sec
[  3]  0.0-60.5 sec  16.0 KBytes  2.17 Kbits/sec
[ 11]  0.0-60.5 sec  16.0 KBytes  2.17 Kbits/sec
[  8]  0.0-74.5 sec  16.0 KBytes  1.76 Kbits/sec
[ 13]  0.0-79.6 sec  16.0 KBytes  1.65 Kbits/sec

Flow [14] gets 1.9Mbit/s, while the rest gets below 7.64 Kbits/sec.

I don't understand why this small patch changed the fairness so much?!?"
331,Dave Täht,2012-02-01 11:31:36.719309,openwrt's shaper also ignores ipv6 entirely
332,David Taht,2012-02-01 15:37:07.460724,"Jasper:

I have duplicated your starvation problem, even with sfqred on cerowrt bql-30.

I had hoped that setting the depth would help. It didn't.

on the 3.3 based laptop:

tc -b <AAA
qdisc del dev eth0 root
qdisc add dev eth0 root handle 1: est 1sec 4sec htb default 1
class add dev eth0 parent 1: classid 1:1 est 1sec 4sec htb rate
4000kbit mtu 1500 quantum 1500
qdisc add dev eth0 parent 1:1 handle a: est 1sec 4sec sfq limit 200
headdrop perturb 60000 flows 500 divisor 16384 redflowlimit 40000
depth 24 min 4500 max 9000 probability 0.20 ecn harddrop
AAA

The cerowrt box is running:

root@OpenWrt:~# tc qdisc show dev se00
qdisc sfq a: root refcnt 2 limit 127p quantum 1514b depth 127 divisor 1024

running 10 iperfs (iperf -t 60 -c 172.30.42.1) from the laptop to the
cerowrt box.

Note the first iperf completely starves out the last 9 connection attempts, so
they don't even start.


[  4]  0.0-60.5 sec  27.0 MBytes  3.74 Mbits/sec
[  4] local 172.30.42.1 port 5001 connected with 172.30.42.17 port 41471
[  4]  0.0- 1.6 sec   768 KBytes  3.83 Mbits/sec
[  4] local 172.30.42.1 port 5001 connected with 172.30.42.17 port 41472
[  4]  0.0- 0.4 sec   256 KBytes  5.30 Mbits/sec
[  4] local 172.30.42.1 port 5001 connected with 172.30.42.17 port 41473
[  4]  0.0- 0.4 sec   256 KBytes  5.41 Mbits/sec
[  4] local 172.30.42.1 port 5001 connected with 172.30.42.17 port 41474
[  4]  0.0- 0.4 sec   256 KBytes  5.41 Mbits/sec
[  4] local 172.30.42.1 port 5001 connected with 172.30.42.17 port 41475
[  4]  0.0- 0.4 sec   256 KBytes  5.41 Mbits/sec
[  4] local 172.30.42.1 port 5001 connected with 172.30.42.17 port 41476
[  4]  0.0- 0.4 sec   256 KBytes  5.43 Mbits/sec
[  4] local 172.30.42.1 port 5001 connected with 172.30.42.17 port 41479
[  4]  0.0- 1.5 sec   768 KBytes  4.23 Mbits/sec

**

For giggles, I tried it with the same sfqred setting on both sides, with the
same sad result.

For the sake of argument, I'm going to try this with a similar qfq setup."
332,David Taht,2012-02-01 17:44:24.144409,"Sigh. I went back and installed iperf-mt, rather than iperf, rebuilt a kernel
for cerowrt with CONFIG_NO_HZ and CONFIG_HZ_256 (which is how I
normally build it)

and can't trigger it now.

On Wed, Feb 1, 2012 at 11:37 PM, Dave Taht <dave.taht@gmail.com> wrote:
> Jasper:
>
> I have duplicated your starvation problem, even with sfqred on cerowrt bql-30.
>
> I had hoped that setting the depth would help. It didn't.
>
> on the 3.3 based laptop:
>
> tc -b <AAA
> qdisc del dev eth0 root
> qdisc add dev eth0 root handle 1: est 1sec 4sec htb default 1
> class add dev eth0 parent 1: classid 1:1 est 1sec 4sec htb rate
> 4000kbit mtu 1500 quantum 1500
> qdisc add dev eth0 parent 1:1 handle a: est 1sec 4sec sfq limit 200
> headdrop perturb 60000 flows 500 divisor 16384 redflowlimit 40000
> depth 24 min 4500 max 9000 probability 0.20 ecn harddrop
> AAA
>
> The cerowrt box is running:
>
> root@OpenWrt:~# tc qdisc show dev se00
> qdisc sfq a: root refcnt 2 limit 127p quantum 1514b depth 127 divisor 1024
>
> running 10 iperfs (iperf -t 60 -c 172.30.42.1) from the laptop to the
> cerowrt box.
>
> Note the first iperf completely starves out the last 9 connection attempts, so
> they don't even start.
>
>
> [  4]  0.0-60.5 sec  27.0 MBytes  3.74 Mbits/sec
> [  4] local 172.30.42.1 port 5001 connected with 172.30.42.17 port 41471
> [  4]  0.0- 1.6 sec   768 KBytes  3.83 Mbits/sec
> [  4] local 172.30.42.1 port 5001 connected with 172.30.42.17 port 41472
> [  4]  0.0- 0.4 sec   256 KBytes  5.30 Mbits/sec
> [  4] local 172.30.42.1 port 5001 connected with 172.30.42.17 port 41473
> [  4]  0.0- 0.4 sec   256 KBytes  5.41 Mbits/sec
> [  4] local 172.30.42.1 port 5001 connected with 172.30.42.17 port 41474
> [  4]  0.0- 0.4 sec   256 KBytes  5.41 Mbits/sec
> [  4] local 172.30.42.1 port 5001 connected with 172.30.42.17 port 41475
> [  4]  0.0- 0.4 sec   256 KBytes  5.41 Mbits/sec
> [  4] local 172.30.42.1 port 5001 connected with 172.30.42.17 port 41476
> [  4]  0.0- 0.4 sec   256 KBytes  5.43 Mbits/sec
> [  4] local 172.30.42.1 port 5001 connected with 172.30.42.17 port 41479
> [  4]  0.0- 1.5 sec   768 KBytes  4.23 Mbits/sec
>
> **
>
> For giggles, I tried it with the same sfqred setting on both sides, with the
> same sad result.
>
> For the sake of argument, I'm going to try this with a similar qfq setup."
332,David Taht,2012-02-02 07:00:32.27468,"On Thu, Feb 2, 2012 at 12:05 PM, Jesper Dangaard Brouer <jdb@comx.dk> wrote:
> On Thu, 2012-02-02 at 01:44 +0000, Dave Taht wrote:
>> Sigh. I went back and installed iperf-mt, rather than iperf, rebuilt a kernel
>> for cerowrt with CONFIG_NO_HZ and CONFIG_HZ_256 (which is how I
>> normally build it)
>>
>> and can't trigger it now.
>
> That make perfect sense to me.  By running a multi threaded version of
> iperf, the flows/packets gets a chance to be scheduled individually, and
> thus the packets have, a better chance, of not getting
> ""grouped-together"" in the qdiscs queue.  You further improve this by
> using CONFIG_NO_HZ.
>
> I would still claim, that this situation can still happen for real-life
> applications, which have many TCP connections, and have not implemented
> this in a multi-threaded manor.

Perhaps you mis-understood the 'sigh'. I have little doubt this problem
can occur. I was happy that I could reproduce it with a non-default
setup for me.

I will continue to try to reproduce. Another thought is merely that non-threaded
iperf will refuse a connection entirely...

As for CONFIG_NO_HZ, it was my impression that HTB performed more
accurately and better with that and hires timers on."
334,Dave Täht,2012-02-06 15:28:55.388999,"Fixed in BQL-32 and later.

http://huchra.bufferbloat.net/~cero1/bql-smoketests/bql-32/

Thx for the spot!"
335,Dave Täht,2012-02-08 09:01:48.825992,"BQL-36 gets 240Mbit over ipv6 with the default ip6tables rules enabled.
280 with all the ip6tables rules disabled.

204Mbit with bql set to 9000 and tx 64 and sfqred in place 
234Mbit (no typo!) with tx 2

tc -s qdisc show dev ge00
qdisc sfq a: root refcnt 2 limit 300p quantum 1514b depth 127 headdrop divisor 16384 perturb 60000sec 
 ewma 3 min 4500b max 18000b probability 0.2 ecn 
 prob_mark 141 prob_mark_head 7363 prob_drop 20
 forced_mark 0 forced_mark_head 0 forced_drop 1194
 Sent 1863591533 bytes 1247669 pkt (dropped 1214, overlimits 8718 requeues 134180) 
 rate 624bit 1pps backlog 0b 0p requeues 134180 


d@ida:~/t$ iperf -t 60 -w256k -V -c fd43:e2b3:341c:f010::2
------------------------------------------------------------
Client connecting to fd43:e2b3:341c:f010::2, TCP port 5001
TCP window size:  256 KByte (WARNING: requested  256 KByte)
------------------------------------------------------------
[  3] local fd43:e2b3:341c:1:214:d1ff:fe20:10cb port 38806 connected with fd43:e2b3:341c:f010::2 port 5001
[ ID] Interval       Transfer     Bandwidth
[  3]  0.0-60.0 sec  1.64 GBytes   234 Mbits/sec"
335,Dave Täht,2012-02-08 09:05:32.676077,"OK, found it. depth 10, in this case, will cut performance to 170Mbit.

So I think during that testing I'd been fooling with the depth.

Client connecting to fd43:e2b3:341c:f010::2, TCP port 5001
TCP window size:  256 KByte (WARNING: requested  256 KByte)
------------------------------------------------------------
[  3] local fd43:e2b3:341c:1:214:d1ff:fe20:10cb port 39253 connected with fd43:e2b3:341c:f010::2 port 5001
[ ID] Interval       Transfer     Bandwidth
[  3]  0.0-60.0 sec  1.20 GBytes   171 Mbits/sec
"
336,Dave Täht,2012-02-09 12:37:24.432784,"It is good to know that this problem is resolved on broadcom hardware 
that may use this driver in the future. It is also good to know it exists
on current brcm hardware...."
310,Tim Zhang,2012-02-09 21:59:59.870768,"Please enable this option when you configure your kernel, using 'make menuconfig'.
<pre>
Networking support --> Networking options --> RPS
</pre>

Because 'struct netdev_queue' has the member 'kobj' *only when CONFIG_RPS is defined*.
So does 'queues_kset' in 'struct net_device'.

You can find the definition in 'include/linux/netdevice.h'.
<pre>
struct net_device {
...
#ifdef CONFIG_RPS
    struct kset     *queues_kset;
    struct netdev_rx_queue  *_rx;
    /* Number of RX queues allocated at register_netdev() time */
    unsigned int        num_rx_queues;
    /* Number of RX queues currently active in device */
    unsigned int        real_num_rx_queues;
#ifdef CONFIG_RFS_ACCEL
    /* CPU reverse-mapping for RX completion interrupts, indexed by RX queue number. Assigned by driver.
     * This must only be set if the ndo_rx_flow_steer operation is defined. */
    struct cpu_rmap     *rx_cpu_rmap;
#endif
#endif
...
};
...
struct netdev_queue {
...
#ifdef CONFIG_RPS
    struct kobject      kobj;
#endif
...
} ____cacheline_aligned_in_smp;
</pre>

Have a good day!"
338,Dave Täht,2012-02-11 20:17:02.077326,"It may not be limited to the negate mark option, either.

I suspect there are more ipv6 related bugs than this lurking in ip6tables"
338,Dave Täht,2012-02-12 21:04:08.074582,"and, after duplicating this on 3 machines, rebooted them all...

and with the simplified script, they no longer go boom. Have to recreate the complex scenario now."
338,Dave Täht,2012-02-15 07:56:32.467041,"and then, I managed to get it to happen again. But it's subtle. 

I don't know what to point at anymore. ifb? ip6tables? conntrack?

"
340,Hector Ordorica,2012-02-29 11:13:42.232253,"Perhaps related, but I noticed this change recently in openwrt trunk for ICMPv6:

https://dev.openwrt.org/changeset/30727/trunk

In wireless testing in trunk, there was also a patch to ath9k that reduced tx bufs to 32 I think. I can't seem to find it at the moment though:

https://dev.openwrt.org/changeset/30746/trunk"
340,Dave Täht,2012-02-29 11:53:53.085705,"yea, I wondered where the txqueuelen change came from...

I've gone way beyond that (running sfq by default)... but hmmm...... I'll try ripping that out

as for the icmp change, I tried stripping that out to no real effect...

# Allow essential incoming IPv6 ICMP traffic    
config rule                                     
        option name             Allow-ICMPv6-Input
        option src              *                 
        option proto            icmp              
        option limit            1000/sec          
        option family           ipv6              
        option target           ACCEPT            
                                                  
# Allow essential forwarded IPv6 ICMP traffic     
config rule                                       
        option name             Allow-ICMPv6-Forward
        option src              *                   
#       option dest             *                   
        option proto            icmp                
        option limit            1000/sec            
        option family           ipv6                
        option target           ACCEPT              
                                          "
340,Dave Täht,2012-02-29 11:55:40.851591,"For reference I am way beyond fiddling with txqueuelen

root@quintaped:/etc/config# tc -s qdisc show dev sw10
qdisc mq 1: root 
 Sent 0 bytes 0 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc sfq 10: parent 1:1 limit 200p quantum 3028b depth 24 headdrop divisor 16384 perturb 600sec 
 ewma 3 min 4500b max 18000b probability 0.2 ecn 
 prob_mark 0 prob_mark_head 0 prob_drop 0
 forced_mark 0 forced_mark_head 0 forced_drop 0
 Sent 0 bytes 0 pkt (dropped 0, overlimits 0 requeues 0) 
 rate 0bit 0pps backlog 0b 0p requeues 0 
qdisc sfq 20: parent 1:2 limit 200p quantum 3028b depth 24 headdrop divisor 16384 perturb 600sec 
 ewma 3 min 4500b max 18000b probability 0.2 ecn 
 prob_mark 0 prob_mark_head 0 prob_drop 0
 forced_mark 0 forced_mark_head 0 forced_drop 0
 Sent 0 bytes 0 pkt (dropped 0, overlimits 0 requeues 0) 
 rate 0bit 0pps backlog 0b 0p requeues 0 
qdisc sfq 30: parent 1:3 limit 200p quantum 3028b depth 24 headdrop divisor 16384 perturb 600sec 
 ewma 3 min 4500b max 18000b probability 0.2 ecn 
 prob_mark 0 prob_mark_head 0 prob_drop 0
 forced_mark 0 forced_mark_head 0 forced_drop 0
 Sent 0 bytes 0 pkt (dropped 0, overlimits 0 requeues 0) 
 rate 0bit 0pps backlog 0b 0p requeues 0 
qdisc sfq 40: parent 1:4 limit 200p quantum 3028b depth 24 headdrop divisor 16384 perturb 600sec 
 ewma 3 min 4500b max 18000b probability 0.2 ecn 
 prob_mark 0 prob_mark_head 0 prob_drop 0
 forced_mark 0 forced_mark_head 0 forced_drop 0
 Sent 0 bytes 0 pkt (dropped 0, overlimits 0 requeues 0) 
 rate 0bit 0pps backlog 0b 0p requeues 0 

"
340,Dave Täht,2012-03-01 07:01:36.520586,"This is actually against the rc4-3 release, not the rc5

I am aware that powersave mode does weird things to ping, but the phone does not access the internet worth beans and pinging it has results like:

root@quintaped:/etc/dibbler# ping 172.29.42.85
PING 172.29.42.85 (172.29.42.85): 56 data bytes
64 bytes from 172.29.42.85: seq=0 ttl=64 time=7198.999 ms
64 bytes from 172.29.42.85: seq=1 ttl=64 time=6506.462 ms
64 bytes from 172.29.42.85: seq=2 ttl=64 time=5700.414 ms
64 bytes from 172.29.42.85: seq=3 ttl=64 time=4838.906 ms
64 bytes from 172.29.42.85: seq=4 ttl=64 time=10448.104 ms
64 bytes from 172.29.42.85: seq=5 ttl=64 time=12287.972 ms
64 bytes from 172.29.42.85: seq=6 ttl=64 time=12414.146 ms
64 bytes from 172.29.42.85: seq=11 ttl=64 time=10277.950 ms
64 bytes from 172.29.42.85: seq=24 ttl=64 time=17193.064 ms
64 bytes from 172.29.42.85: seq=31 ttl=64 time=10291.945 ms
64 bytes from 172.29.42.85: seq=32 ttl=64 time=12313.409 ms
64 bytes from 172.29.42.85: seq=33 ttl=64 time=12334.132 ms
64 bytes from 172.29.42.85: seq=34 ttl=64 time=14613.955 ms
64 bytes from 172.29.42.85: seq=35 ttl=64 time=14074.534 ms
64 bytes from 172.29.42.85: seq=41 ttl=64 time=11444.921 ms
64 bytes from 172.29.42.85: seq=42 ttl=64 time=11989.482 ms
64 bytes from 172.29.42.85: seq=43 ttl=64 time=11527.725 ms
64 bytes from 172.29.42.85: seq=44 ttl=64 time=13893.153 ms
64 bytes from 172.29.42.85: seq=45 ttl=64 time=14567.878 ms
64 bytes from 172.29.42.85: seq=51 ttl=64 time=11443.464 ms
64 bytes from 172.29.42.85: seq=52 ttl=64 time=10613.561 ms
64 bytes from 172.29.42.85: seq=53 ttl=64 time=9648.801 ms
64 bytes from 172.29.42.85: seq=54 ttl=64 time=8652.338 ms
64 bytes from 172.29.42.85: seq=55 ttl=64 time=10004.857 ms
64 bytes from 172.29.42.85: seq=56 ttl=64 time=9575.878 ms
64 bytes from 172.29.42.85: seq=57 ttl=64 time=9810.736 ms
64 bytes from 172.29.42.85: seq=58 ttl=64 time=8888.394 ms
64 bytes from 172.29.42.85: seq=59 ttl=64 time=10075.711 ms
64 bytes from 172.29.42.85: seq=60 ttl=64 time=11003.248 ms
64 bytes from 172.29.42.85: seq=61 ttl=64 time=13171.309 ms
64 bytes from 172.29.42.85: seq=62 ttl=64 time=13581.010 ms
64 bytes from 172.29.42.85: seq=63 ttl=64 time=16758.824 ms
64 bytes from 172.29.42.85: seq=71 ttl=64 time=9913.159 ms
64 bytes from 172.29.42.85: seq=72 ttl=64 time=9179.238 ms
64 bytes from 172.29.42.85: seq=73 ttl=64 time=8977.600 ms
64 bytes from 172.29.42.85: seq=74 ttl=64 time=8550.328 ms
64 bytes from 172.29.42.85: seq=75 ttl=64 time=8268.744 ms
64 bytes from 172.29.42.85: seq=76 ttl=64 time=8868.098 ms
64 bytes from 172.29.42.85: seq=77 ttl=64 time=8484.207 ms
64 bytes from 172.29.42.85: seq=78 ttl=64 time=7750.523 ms
64 bytes from 172.29.42.85: seq=79 ttl=64 time=6929.604 ms
64 bytes from 172.29.42.85: seq=80 ttl=64 time=6032.321 ms
64 bytes from 172.29.42.85: seq=81 ttl=64 time=5195.933 ms
64 bytes from 172.29.42.85: seq=82 ttl=64 time=4568.045 ms
64 bytes from 172.29.42.85: seq=83 ttl=64 time=5821.851 ms
"
340,Dave Täht,2012-03-01 07:02:27.178134,"Similarly, I see this in the logs against this rc4-3


[35035.940000] ath: Failed to stop TX DMA, queues=0x004!
[38649.010000] ath: Failed to stop TX DMA, queues=0x004!
[39778.210000] ath: Failed to stop TX DMA, queues=0x004!
[41006.390000] ath: Failed to stop TX DMA, queues=0x004!
[41288.800000] ath: Failed to stop TX DMA, queues=0x004!
[42141.720000] ath: Failed to stop TX DMA, queues=0x004!
[45895.820000] ath: Failed to stop TX DMA, queues=0x004!
[53289.030000] ath: Failed to stop TX DMA, queues=0x004!
[53858.920000] ath: Failed to stop TX DMA, queues=0x001!
"
340,Dave Täht,2012-03-01 07:04:01.117202,"Mar  1 09:58:57 quintaped daemon.info dnsmasq-dhcp[3888]: DHCPACK(sw10) 192.168.1.102 00:27:13:64:89:67 cruithne
Mar  1 09:58:57 quintaped daemon.info hostapd: sw00: STA 00:13:e8:58:2a:c5 WPA: group key handshake completed (RSN)
Mar  1 09:58:58 quintaped daemon.info hostapd: sw00: STA 90:21:55:67:8d:cb WPA: group key handshake completed (RSN)
Mar  1 09:58:58 quintaped daemon.info hostapd: sw00: STA 90:21:55:67:8d:cb WPA: received EAPOL-Key 2/2 Group with unexpected replay counter

"
340,Dave Täht,2012-03-01 07:48:50.599745,"Well, the good news is 3.3rc5-1 is not exhibiting the problem when at 2.4ghz,with crypto.
pings are respectable, performance on the phone itself is good...

The bad news is that this is a highly simplified test setup rather than an attempted deployment,
and I'm not going to have time to attempt recreating the deployment.

64 bytes from 172.30.42.85: seq=46 ttl=64 time=137.776 ms
64 bytes from 172.30.42.85: seq=47 ttl=64 time=160.643 ms
64 bytes from 172.30.42.85: seq=48 ttl=64 time=184.652 ms
64 bytes from 172.30.42.85: seq=49 ttl=64 time=3.000 ms
64 bytes from 172.30.42.85: seq=50 ttl=64 time=64.671 ms
64 bytes from 172.30.42.85: seq=51 ttl=64 time=50.848 ms
64 bytes from 172.30.42.85: seq=52 ttl=64 time=4.502 ms
64 bytes from 172.30.42.85: seq=53 ttl=64 time=99.418 ms
64 bytes from 172.30.42.85: seq=54 ttl=64 time=122.181 ms
"
341,Dave Täht,2012-03-01 08:21:14.006049,"I ran it overnight again with the same cpu issue, and further, when attempting to reboot, the process was so wedged as to prevent a reboot without manually killing off dibbler-client."
342,Dave Täht,2012-03-06 15:10:28.741517,"The default in cerowrt appears to be correct in this case.

It was just wrong on the dns server I was trying to interop with."
342,Dave Täht,2012-03-06 15:10:42.362012,""
95,Dave Täht,2012-03-06 15:20:23.167235,http://wiki.openwrt.org/doc/uci/firewall#block.access.to.the.internet.using.mac
340,Dave Täht,2012-03-07 12:42:50.531188,as far as I know this was only a bug in 3.3rc4.
113,Dave Täht,2012-03-23 22:49:12.899941,"I FINALLLY.... got ntpd + libval to NOT validate, and thus let me get valid time.

opkg install dnsval

change /etc/dnssec-tools/dnsval.conf to:

: clock-skew                                                                    
                . -1     

and maybe

mta clock-skew                                                                  
                . -1                                                            
; 

I'm too tired to confirm this really did the trick or not, and the version of ntpd that I built for 3.3.0-1 and later has another select problem, but I did
see it skew the darn time...

but it was possible that dnssec validation disable got turned on in the interim.

"
113,Dave Täht,2012-03-24 08:09:34.413417,"made it install dnsval by default and have it ignore time slew by default in the configuration. This is actually not what you want if more stuff was linked to this library, but as ntp is our only problem child here...
"
282,Ketan Kulkarni,2012-03-26 07:15:23.564196,"I could build cerowrt-3.3 from the steps mentioned at 
http://www.bufferbloat.net/projects/cerowrt/wiki/Building_Cerowrt_on_your_own_machine

There are slight changes required in the build_cero.sh, cero_config and instructions.
The required diffs are attached.
"
304,Ketan Kulkarni,2012-03-26 07:45:17.652061,"It seems this one is ready to be closed?
cerowrt indeed now has tcp timestamps enabled by default.

Relevant commit seems to be -

Commit: 61886bddee89adcd955c4de7dc940f071786d062
      https://github.com/dtaht/cerofiles/commit/61886bddee89adcd955c4de7dc940f071786d062
  Author: Dave Taht <dave.taht at bufferbloat.net>
  Date:   2012-01-21 (Sat, 21 Jan 2012)

  Changed paths:
    M files/etc/sysctl.conf

  Log Message:
  -----------
  Make sure TCP timestamps are on by default
"
304,Dave Täht,2012-03-26 08:42:15.750104,I just need to ship the patch upstream to openwrt. thx for the reminder.
113,Dave Täht,2012-04-02 22:07:56.992657,"I think this fix was an illusion. It takes many minutes, if ever for named to work. Kicking it manually and watching the time slew does work, but that's unacceptable.

I am pulling both ntp and bind from the default installed packages, until this solution or something better can be made to work on x86, first, then embedded.

I will keep building them, but there is no point in shipping them at present and I have other crash bugs to resolve. I give up on fixing it myself."
352,Dave Täht,2012-04-06 22:21:07.977945,"It would be nice if someone that cared more about ipv6 than I do at the moment, and was willing to pay for the work, to get it done, with the person most qualified to do it, who isn'tme.

A factor of 4 disimprovement, and mere 60Mbit performance on ipv6 is not terrible but fixing it will require oprofiling and deeper investigation. 

I've seen a similar problem on ipv6 tunnels."
352,David Taht,2012-04-06 22:25:04.350443,"documenting this publicly


ipv6 runs at less than  half the speed as ipv4.

CPU: MIPS 24K, speed 678 MHz (estimated)
Counted INSTRUCTIONS events (1-0 Instructions completed) with a unit
mask of 0x00 (No unit mask) count 100000
samples  %        app name                 symbol name
-------------------------------------------------------------------------------
6703     22.7367  vmlinux                  do_ade
 6703     100.000  vmlinux                  do_ade [self]
-------------------------------------------------------------------------------
3754     12.7336  ip6_tables               /ip6_tables
 3754     100.000  ip6_tables               /ip6_tables [self]
-------------------------------------------------------------------------------
2834      9.6130  ipv6                     /ipv6
 2834     100.000  ipv6                     /ipv6 [self]
-------------------------------------------------------------------------------
2240      7.5981  vmlinux                  __copy_user
 2240     100.000  vmlinux                  __copy_user [self]
-------------------------------------------------------------------------------
2164      7.3403  vmlinux                  csum_partial
 2164     100.000  vmlinux                  csum_partial [self]


m@cruithne:~$ iperf -V -c fd25:b7ff:b098:8001::1
------------------------------------------------------------
Client connecting to fd25:b7ff:b098:8001::1, TCP port 5001
TCP window size: 64.6 KByte (default)
------------------------------------------------------------
[  3] local fd43:e2b3:341c:5071::1 port 35233 connected with
fd25:b7ff:b098:8001::1 port 5001
[ ID] Interval       Transfer     Bandwidth
[  3]  0.0-10.0 sec   185 MBytes   155 Mbits/sec"
352,David Taht,2012-04-06 22:25:57.980263,"While this is a better method to track down traps, when you are having
lots of them, the serial port gets overrun completely.

And on ipv6, we get a lot of them


---------- Forwarded message ----------
From: Felix Fietkau <nbd@openwrt.org>
Date: Sat, Feb 18, 2012 at 8:41 AM
Subject: Re: oprofile magic? (ipv6 terrible)
To: Dave Taht <dave.taht@gmail.com>


On 2012-02-18 5:35 PM, Dave Taht wrote:
> I was curious as to what oprofiling magic tricks you used
> to track down the unaligned exception traps. I haven't
> touched oprofile since august...
>
> ipv6 runs at about half the speed as ipv4.
I'm not using oprofile to track down such traps, there's a much easier
way: echo 2 > /sys/kernel/debug/mips/unaligned_action
After that, the kernel will throw a stack trace for every single
unaligned exception. You can then run gdb to track down the line of code
that triggered the exception, assuming you've enabled debug symbols for
the kernel.
Just enter l *<function_name>+<offset>
When it's trapping based on access to a struct, just mark the struct as
__packed in a patch.

- Felix"
355,Dave Täht,2012-04-07 14:00:06.703181,"Those routers are not 100% open source firmware at present and thus are not usable for the cerowrt effort.

The 3800s are readily available online. 3700v2s are, also, but sometimes it's hard to get a vendor to recognise that the 3700v1, v2, v3 are entirely different hardware, so the 3800 is the best bet at present.

http://www.amazon.com/Netgear-N600-Wireless-Gigabit-Router/dp/B0058NN6CS/ref=sr_1_1?ie=UTF8&qid=1333831914&sr=8-1

There are about 5 other routers from other vendors that use the same chipset that we use that we may try to support in the future, or perhaps we'll take on another platform entirely that meets the requirements and has intersecting problems. Of the two, I lean towards the latter. I'd like to be fiddling with 10gigE on the octeons, frankly.

We do try to push the successful technologies in cerowrt up to openwrt, the relevant packages, and to the mainline linux kernel, as fast as they prove out, so that they'll be available universally on all platforms. Notably the linux 3.3 mainline has two core new technologies in it (BQL and sfqred) that are very promising on desktops and servers. Bufferbloat is not just a router problem!

But that takes a while. I hope you join us on the 3800 for the nonce

"
355,Luke H,2012-04-07 21:14:35.370665,"Thanks for the detailed response. I actually found a shop selling WNDR3800s and purchased one today.  Just finished flashing it, that part of the process was painless.  Now just trying to dig around the GUI and various config files to wrap my head around everthing.  I've had experience with DDWRT, Tomato, pfSense2, and some Vyatta  but this project is very exciting with all the bleeding edge tech inside.  Can't wait to dig in deeper.  I used the 3.3.1-4 Apr-06 build  btw, not sure if that was wise or not!

http://huchra.bufferbloat.net/~cero1/3.3/3.3.1-4/openwrt-ar71xx-generic-wndr3800-squashfs-factory.img"
355,Luke H,2012-04-08 06:57:02.748005,"One last question: 
what is the corrent procedure for powering down the router? I logged in via SSH and ran 'poweroff'  which seemed to work.  Is it safe to just flip the power switch?"
345,Luke H,2012-04-08 08:25:01.275701,"I was about to report the same issue - but in my case I am using the newer build r31204 (Apr 6) with the 3.3.1 kernel.  Same error though:

"
355,Dave Täht,2012-04-08 16:20:27.664877,"yes. There is never (or I should say, only extremely rarely) any state on the box that needs to be saved.

"
345,Dave Täht,2012-04-08 17:14:34.16622,"The syntax expected by the web interface and the syntax in the file have diverged.

On my todo list is to rebuild the firewall rules from scratch to handle ipv6 and the guest zone and mesh networking concepts well.

If you'd like to take a crack at it, grab the firewall rules file and put it somewhere,
take the existing one in an editor (both vi and zile are available)
and eliminate all the rules, and then re-enter them via the web interface...

Attached a syntactally correct version, that may or may not be logically correct.
I would appreciate testing. It MAY need the /etc/firewall.user file explicitly included
and that file needs work too.



"
345,Dave Täht,2012-04-08 17:36:38.860648,"I note that the [[Device naming scheme]] is designed to make it possible to create much more effecient firewall rules, but the gui will not accept the syntax required, so it has a tendency to create
O(n) sorts of rules that scale really badly. 

The original 'dream' of syntax was you'd use the inherent iptables + pattern match to create a zone.

<pre>
iptables -I FORWARD -i g+ -o s+ -g do_some_secure processing
iptables -I FORWARD -j ACCEPT # default free zone
</pre>

is about 12 more rules efficient than the default rules generated which rapidly gets worse with vlans or ipv6 in the mix. (it scales O(n)) 

Similarly the rules don't sort by traffic pattern but by logic, so the default openwrt rules currently send everything through an enormous and unneeded icmp chain instead of first matching on the most common protocols.

Regrettably a gui programmer hasn't shown up that can do that. Writing a script for it is straightforward, but then I lose the gui audience. Alternate solutions are highly desired.

There are also some issues along the lines of bugs #195 and #352 ."
357,Dave Täht,2012-04-08 17:48:27.775678,"cool. thank you!

I am NOT using the default qos system, it's broken and doesn't have the right stuff. IF I use that system it will be called aqm... which is broke worse at the moment.

So I commented that part out of the install guide. As important as it is, actually having something that works is more important.

I've also switched from the ocean city pic to the rodin statue elsewhere.

We should line up more people to read this
"
358,Robert Bradley,2012-04-09 08:14:51.656505,"If I understand the man page for udhcpc correctly (http://man.cx/udhcpc%288%29), you should be able to put the following script in `/etc/udhcpc/default.script` to restore the tunnel when DHCP acquires a new address:

<pre><code class=""bash"">
#!/bin/bash

USERNAME=""""
PASSWORD=""""
TUNNELID=""""
if [ ""$1"" == ""bound"" ]; then
        wget ""https://${USERNAME}:${PASSWORD}@ipv4.tunnelbroker.net/ipv4_end.php?tid=${TUNNELID}""
fi;
</code></pre>"
345,Dave Täht,2012-04-09 23:55:53.561202,"While we made great progress today towards getting the gui to work and ipv6 to work, I needed to put up some documentation on what I'd wanted to do in the first place, which is called [[CeroWall]]. I have ENOTIME to make CeroWall work, but when you look at the default openwrt firewall rules, the simplicity I describe with this alternative (with a few clever pattern matches) seems appealing."
360,Dave Täht,2012-04-11 08:08:32.086377,"[49066.542968] Call Trace:
[49066.542968] [<831a32e8>] ipv6_chk_mcast_addr+0x3c/0x170 [ipv6]
[49066.542968] [<83186338>] ip6_mc_input+0xd4/0x4dc [ipv6]
[49066.542968] [<801e8320>] __netif_receive_skb+0x458/0x4c8
[49066.542968] [<801d06ec>] ag71xx_poll+0x3b0/0x66c
[49066.542968] [<801e8740>] net_rx_action+0x88/0x1c8
[49066.542968] [<80076e14>] __do_softirq+0xa0/0x154
[49066.542968] [<80077020>] do_softirq+0x48/0x68
[49066.542968] [<80077254>] irq_exit+0x4c/0xb0
[49066.542968] [<80062d4c>] ret_from_irq+0x0/0x4
[49066.542968] [<80062f40>] r4k_wait+0x20/0x40
[49066.542968] [<80064a1c>] cpu_idle+0x38/0x70
[49066.542968] [<8031a8c8>] start_kernel+0x37c/0x39c
[49066.542968] 
[49066.542968] 
[49066.542968] Code: 00000000  08c68ccb  8e10000c <8e430004> 8e440000  00621826  8e020000  00821026  00621025 
[49066.542968] Cpu 0
[49066.542968] $ 0   : 00000000 00000001 00000000 00000000
[49066.542968] $ 4   : 00010006 82b24086 00000000 802ffc84
[49066.542968] $ 8   : fe800000 00000000 02e081ff fe3319ca
[49066.542968] $12   : 00000014 0014002b 00000001 00000001
[49066.542968] $16   : 8315b380 00000000 82b24086 00000000
[49066.542968] $20   : 00000000 80300000 80320000 80300b38
[49066.542968] $24   : 00000000 83186264                  
[49066.542968] $28   : 802fe000 802ffc90 80315c80 831a32e0
[49066.542968] Hi    : 000002cf
[49066.542968] Lo    : 04270c00
[49066.542968] epc   : 831a32ec ipv6_chk_mcast_addr+0x40/0x170 [ipv6]
[49066.542968]     Tainted: G           O
[49066.542968] ra    : 831a32e0 ipv6_chk_mcast_addr+0x34/0x170 [ipv6]
[49066.542968] Status: 1000fc03    KERNEL EXL IE 
[49066.542968] Cause : 00800010
[49066.542968] BadVA : 82b24086
[49066.542968] PrId  : 00019374 (MIPS 24Kc)
[49066.542968] Modules linked in: cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq gpio_buttons ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah ip6table_raw ip6_queue ip6table_mangle ip6table_filter ip6_tables nf_conntrack_ipv6 nf_defrag_ipv6 nf_nat_irc nf_conntrack_irc nf_nat_ftp nf_conntrack_ftp xt_policy xt_esp ipt_ah xt_HL xt_hl xt_ecn ipt_ECN xt_CLASSIFY xt_time xt_tcpmss xt_statistic xt_mark xt_length xt_DSCP xt_dscp xt_string xt_layer7 xt_quota xt_pkttype xt_physdev xt_owner ipt_MASQUERADE iptable_nat nf_nat xt_recent xt_helper xt_connmark xt_connbytes pptp xt_conntrack xt_CT xt_NOTRACK iptable_raw xt_state nf_conntrack_ipv4 nf_defrag_ipv4 nf_conntrack pppoe pppox ipt_REJECT xt_TCPMSS ipt_LOG xt_comment xt_multiport xt_mac xt_limit iptable_mangle iptable_filter ip_tables xt_tcpudp x_tables ip_gre gre ifb sit ipcomp xfrm4_tunnel xfrm4_mode_tunnel xfrm4_mode_transport xfrm4_mode_beet esp4 ah4 tunnel4 tun tcp_ledbat(O) ppp_async ppp_generic slhc xfrm_user xfrm_ipcomp af_key vfat fat autofs4 button_hotplug(O) ath9k(O) ath9k_common(O) ath9k_hw(O) ath(O) nls_utf8 nls_iso8859_2 nls_iso8859_15 nls_iso8859_13 nls_iso8859_1 nls_cp437 mac80211(O) ts_fsm ts_bm ts_kmp crc_ccitt ipv6 input_polldev cfg80211(O) compat(O) input_core chainiv eseqiv crypto_wq sha1_generic krng rng md5 hmac des_generic cbc authenc arc4 aes_generic crypto_blkcipher cryptomgr aead usb_storage ohci_hcd ehci_hcd sd_mod ext4 jbd2 mbcache usbcore usb_common scsi_mod nls_base crc16 zlib_deflate crypto_hash crypto_algapi ledtrig_timer ledtrig_default_on leds_gpio gpio_button_hotplug(O)
[49066.542968] Process swapper (pid: 0, threadinfo=802fe000, task=803020c0, tls=00000000)
[49066.542968] Stack : fe3319ca 0c000000 00000000 80300000 83f93000 83f93000 8035d470 82b24086
[49066.542968]         82b2406e 83186338 00000002 00000000 00000000 831858a0 80000000 800ee148
[49066.542968]         80300b00 80300b20 000086dd 83d44000 00000000 801e8320 83d44000 80096fc4
[49066.542968]         00000000 00000000 80300b20 80091b2c 4f859d0a 1669a157 83d4438c 83d44380
[49066.542968]         83f93000 83d44000 00000001 83d44000 0000007c 000007b0 83d44238 801d06ec
[49066.542968]         ...
[49066.542968] Call Trace:
[49066.542968] [<831a32ec>] ipv6_chk_mcast_addr+0x40/0x170 [ipv6]
[49066.542968] [<83186338>] ip6_mc_input+0xd4/0x4dc [ipv6]
[49066.542968] [<801e8320>] __netif_receive_skb+0x458/0x4c8
[49066.542968] [<801d06ec>] ag71xx_poll+0x3b0/0x66c
[49066.542968] [<801e8740>] net_rx_action+0x88/0x1c8
[49066.542968] [<80076e14>] __do_softirq+0xa0/0x154
[49066.542968] [<80077020>] do_softirq+0x48/0x68
[49066.542968] [<80077254>] irq_exit+0x4c/0xb0
[49066.542968] [<80062d4c>] ret_from_irq+0x0/0x4
[49066.542968] [<80062f40>] r4k_wait+0x20/0x40
[49066.542968] [<80064a1c>] cpu_idle+0x38/0x70
[49066.542968] [<8031a8c8>] start_kernel+0x37c/0x39c
[49066.542968] 
[49066.542968] 
[49066.542968] Code: 08c68ccb  8e10000c  8e430004 <8e440000> 00621826  8e020000  00821026  00621025  8e440008 
[49066.542968] Cpu 0
[49066.542968] $ 0   : 00000000 00000001 00000000 00000000
[49066.542968] $ 4   : ff020000 82b24086 00000000 802ffc84
[49066.542968] $ 8   : fe800000 00000000 02e081ff fe3319ca
[49066.542968] $12   : 00000014 0014002b 00000001 00000001
[49066.542968] $16   : 8315b380 00000000 82b24086 00000000
[49066.542968] $20   : 00000000 80300000 80320000 80300b38
[49066.542968] $24   : 00000000 83186264                  
[49066.542968] $28   : 802fe000 802ffc90 80315c80 831a32e0
[49066.542968] Hi    : 000002cf
[49066.542968] Lo    : 04270c00
[49066.542968] epc   : 831a3300 ipv6_chk_mcast_addr+0x54/0x170 [ipv6]
[49066.542968]     Tainted: G           O
[49066.542968] ra    : 831a32e0 ipv6_chk_mcast_addr+0x34/0x170 [ipv6]
[49066.542968] Status: 1000fc03    KERNEL EXL IE 
[49066.542968] Cause : 00800010
[49066.542968] BadVA : 82b2408e
[49066.542968] PrId  : 00019374 (MIPS 24Kc)
[49066.542968] Modules linked in: cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq gpio_buttons ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah ip6table_raw ip6_queue ip6table_mangle ip6table_filter ip6_tables nf_conntrack_ipv6 nf_defrag_ipv6 nf_nat_irc nf_conntrack_irc nf_nat_ftp nf_conntrack_ftp xt_policy xt_esp ipt_ah xt_HL xt_hl xt_ecn ipt_ECN xt_CLASSIFY xt_time xt_tcpmss xt_statistic xt_mark xt_length xt_DSCP xt_dscp xt_string xt_layer7 xt_quota xt_pkttype xt_physdev xt_owner ipt_MASQUERADE iptable_nat nf_nat xt_recent xt_helper xt_connmark xt_connbytes pptp xt_conntrack xt_CT xt_NOTRACK iptable_raw xt_state nf_conntrack_ipv4 nf_defrag_ipv4 nf_conntrack pppoe pppox ipt_REJECT xt_TCPMSS ipt_LOG xt_comment xt_multiport xt_mac xt_limit iptable_mangle iptable_filter ip_tables xt_tcpudp x_tables ip_gre gre ifb sit ipcomp xfrm4_tunnel xfrm4_mode_tunnel xfrm4_mode_transport xfrm4_mode_beet esp4 ah4 tunnel4 tun tcp_ledbat(O) ppp_async ppp_generic slhc xfrm_user xfrm_ipcomp af_key vfat fat autofs4 button_hotplug(O) ath9k(O) ath9k_common(O) ath9k_hw(O) ath(O) nls_utf8 nls_iso8859_2 nls_iso8859_15 nls_iso8859_13 nls_iso8859_1 nls_cp437 mac80211(O) ts_fsm ts_bm ts_kmp crc_ccitt ipv6 input_polldev cfg80211(O) compat(O) input_core chainiv eseqiv crypto_wq sha1_generic krng rng md5 hmac des_generic cbc authenc arc4 aes_generic crypto_blkcipher cryptomgr aead usb_storage ohci_hcd ehci_hcd sd_mod ext4 jbd2 mbcache usbcore usb_common scsi_mod nls_base crc16 zlib_deflate crypto_hash crypto_algapi ledtrig_timer ledtrig_default_on leds_gpio gpio_button_hotplug(O)
[49066.542968] Process swapper (pid: 0, threadinfo=802fe000, task=803020c0, tls=00000000)
[49066.542968] Stack : fe3319ca 0c000000 00000000 80300000 83f93000 83f93000 8035d470 82b24086
[49066.542968]         82b2406e 83186338 00000002 00000000 00000000 831858a0 80000000 800ee148
[49066.542968]         80300b00 80300b20 000086dd 83d44000 00000000 801e8320 83d44000 80096fc4
[49066.542968]         00000000 00000000 80300b20 80091b2c 4f859d0a 1669a157 83d4438c 83d44380
[49066.542968]         83f93000 83d44000 00000001 83d44000 0000007c 000007b0 83d44238 801d06ec
[49066.542968]         ...
[49066.542968] Call Trace:
[49066.542968] [<831a3300>] ipv6_chk_mcast_addr+0x54/0x170 [ipv6]
[49066.542968] [<83186338>] ip6_mc_input+0xd4/0x4dc [ipv6]
[49066.542968] [<801e8320>] __netif_receive_skb+0x458/0x4c8
[49066.542968] [<801d06ec>] ag71xx_poll+0x3b0/0x66c
[49066.542968] [<801e8740>] net_rx_action+0x88/0x1c8
[49066.542968] [<80076e14>] __do_softirq+0xa0/0x154
[49066.542968] [<80077020>] do_softirq+0x48/0x68
[49066.542968] [<80077254>] irq_exit+0x4c/0xb0
[49066.542968] [<80062d4c>] ret_from_irq+0x0/0x4
[49066.542968] [<80062f40>] r4k_wait+0x20/0x40
[49066.542968] [<80064a1c>] cpu_idle+0x38/0x70
[49066.542968] [<8031a8c8>] start_kernel+0x37c/0x39c
[49066.542968] 
[49066.542968] 
[49066.542968] Code: 8e020000  00821026  00621025 <8e440008> 8e030008  00831826  00431025  8e44000c  8e03000c 
[49066.542968] Cpu 0
[49066.542968] $ 0   : 00000000 00000001 00000000 00000000
[49066.546875] $ 4   : 00000000 82b24086 00000000 802ffc84
[49066.546875] $ 8   : fe800000 00000000 02e081ff fe3319ca
[49066.546875] $12   : 00000014 0014002b 00000001 00000001
[49066.546875] $16   : 8315b380 00000000 82b24086 00000000
[49066.546875] $20   : 00000000 80300000 80320000 80300b38
[49066.546875] $24   : 00000000 83186264                  
[49066.546875] $28   : 802fe000 802ffc90 80315c80 831a32e0
[49066.546875] Hi    : 000002cf
[49066.546875] Lo    : 04270c00
[49066.546875] epc   : 831a3310 ipv6_chk_mcast_addr+0x64/0x170 [ipv6]
[49066.546875]     Tainted: G           O
[49066.546875] ra    : 831a32e0 ipv6_chk_mcast_addr+0x34/0x170 [ipv6]
[49066.546875] Status: 1000fc03    KERNEL EXL IE 
[49066.546875] Cause : 00800010
[49066.546875] BadVA : 82b24092
[49066.546875] PrId  : 00019374 (MIPS 24Kc)
[49066.546875] Modules linked in: cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq gpio_buttons ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah ip6table_raw ip6_queue ip6table_mangle ip6table_filter ip6_tables nf_conntrack_ipv6 nf_defrag_ipv6 nf_nat_irc nf_conntrack_irc nf_nat_ftp nf_conntrack_ftp xt_policy xt_esp ipt_ah xt_HL xt_hl xt_ecn ipt_ECN xt_CLASSIFY xt_time xt_tcpmss xt_statistic xt_mark xt_length xt_DSCP xt_dscp xt_string xt_layer7 xt_quota xt_pkttype xt_physdev xt_owner ipt_MASQUERADE iptable_nat nf_nat xt_recent xt_helper xt_connmark xt_connbytes pptp xt_conntrack xt_CT xt_NOTRACK iptable_raw xt_state nf_conntrack_ipv4 nf_defrag_ipv4 nf_conntrack pppoe pppox ipt_REJECT xt_TCPMSS ipt_LOG xt_comment xt_multiport xt_mac xt_limit iptable_mangle iptable_filter ip_tables xt_tcpudp x_tables ip_gre gre ifb sit ipcomp xfrm4_tunnel xfrm4_mode_tunnel xfrm4_mode_transport xfrm4_mode_beet esp4 ah4 tunnel4 tun tcp_ledbat(O) ppp_async ppp_generic slhc xfrm_user xfrm_ipcomp af_key vfat fat autofs4 button_hotplug(O) ath9k(O) ath9k_common(O) ath9k_hw(O) ath(O) nls_utf8 nls_iso8859_2 nls_iso8859_15 nls_iso8859_13 nls_iso8859_1 nls_cp437 mac80211(O) ts_fsm ts_bm ts_kmp crc_ccitt ipv6 input_polldev cfg80211(O) compat(O) input_core chainiv eseqiv crypto_wq sha1_generic krng rng md5 hmac des_generic cbc authenc arc4 aes_generic crypto_blkcipher cryptomgr aead usb_storage ohci_hcd ehci_hcd sd_mod ext4 jbd2 mbcache usbcore usb_common scsi_mod nls_base crc16 zlib_deflate crypto_hash crypto_algapi ledtrig_timer ledtrig_default_on leds_gpio gpio_button_hotplug(O)
[49066.546875] Process swapper (pid: 0, threadinfo=802fe000, task=803020c0, tls=00000000)
[49066.546875] Stack : fe3319ca 0c000000 00000000 80300000 83f93000 83f93000 8035d470 82b24086
[49066.546875]         82b2406e 83186338 00000002 00000000 00000000 831858a0 80000000 800ee148
[49066.546875]         80300b00 80300b20 000086dd 83d44000 00000000 801e8320 83d44000 80096fc4
[49066.546875]         00000000 00000000 80300b20 80091b2c 4f859d0a 1669a157 83d4438c 83d44380
[49066.546875]         83f93000 83d44000 00000001 83d44000 0000007c 000007b0 83d44238 801d06ec
[49066.546875]         ...
[49066.546875] Call Trace:
[49066.546875] [<831a3310>] ipv6_chk_mcast_addr+0x64/0x170 [ipv6]
[49066.546875] [<83186338>] ip6_mc_input+0xd4/0x4dc [ipv6]
[49066.546875] [<801e8320>] __netif_receive_skb+0x458/0x4c8
[49066.546875] [<801d06ec>] ag71xx_poll+0x3b0/0x66c
[49066.546875] [<801e8740>] net_rx_action+0x88/0x1c8
[49066.546875] [<80076e14>] __do_softirq+0xa0/0x154
[49066.546875] [<80077020>] do_softirq+0x48/0x68
[49066.546875] [<80077254>] irq_exit+0x4c/0xb0
[49066.546875] [<80062d4c>] ret_from_irq+0x0/0x4
[49066.546875] [<80062f40>] r4k_wait+0x20/0x40
[49066.546875] [<80064a1c>] cpu_idle+0x38/0x70
[49066.546875] [<8031a8c8>] start_kernel+0x37c/0x39c
[49066.546875] 
[49066.546875] 
[49066.546875] Code: 8e030008  00831826  00431025 <8e44000c> 8e03000c  00831826  00431025  10400006  00000000 
root@OpenWrt:/sys/kernel/debug/mips# dmesg
 
[49066.539062] Code: 8e030008  00831826  00431025 <8e44000c> 8e03000c  00831826  00431025  10400006  00000000 
[49066.539062] Cpu 0
[49066.539062] $ 0   : 00000000 00000001 00000000 00010004
[49066.539062] $ 4   : 00010006 82b24086 00000000 802ffc84
[49066.539062] $ 8   : fe800000 00000000 02e081ff fe3319ca
[49066.539062] $12   : 00000014 0014002b 00000001 00000001
[49066.539062] $16   : 8315b380 00000000 82b24086 00000000
[49066.539062] $20   : 00000000 80300000 80320000 80300b38
[49066.539062] $24   : 00000000 83186264                  
[49066.542968] $28   : 802fe000 802ffc90 80315c80 831a32e0
[49066.542968] Hi    : 000002cf
[49066.542968] Lo    : 04270c00
[49066.542968] epc   : 831a32e8 ipv6_chk_mcast_addr+0x3c/0x170 [ipv6]
[49066.542968]     Tainted: G           O
[49066.542968] ra    : 831a32e0 ipv6_chk_mcast_addr+0x34/0x170 [ipv6]
[49066.542968] Status: 1000fc03    KERNEL EXL IE 
[49066.542968] Cause : 00800010
[49066.542968] BadVA : 82b2408a
[49066.542968] PrId  : 00019374 (MIPS 24Kc)
[49066.542968] Modules linked in: cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq gpio_buttons ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah ip6table_raw ip6_queue ip6table_mangle ip6table_filter ip6_tables nf_conntrack_ipv6 nf_defrag_ipv6 nf_nat_irc nf_conntrack_irc nf_nat_ftp nf_conntrack_ftp xt_policy xt_esp ipt_ah xt_HL xt_hl xt_ecn ipt_ECN xt_CLASSIFY xt_time xt_tcpmss xt_statistic xt_mark xt_length xt_DSCP xt_dscp xt_string xt_layer7 xt_quota xt_pkttype xt_physdev xt_owner ipt_MASQUERADE iptable_nat nf_nat xt_recent xt_helper xt_connmark xt_connbytes pptp xt_conntrack xt_CT xt_NOTRACK iptable_raw xt_state nf_conntrack_ipv4 nf_defrag_ipv4 nf_conntrack pppoe pppox ipt_REJECT xt_TCPMSS ipt_LOG xt_comment xt_multiport xt_mac xt_limit iptable_mangle iptable_filter ip_tables xt_tcpudp x_tables ip_gre gre ifb sit ipcomp xfrm4_tunnel xfrm4_mode_tunnel xfrm4_mode_transport xfrm4_mode_beet esp4 ah4 tunnel4 tun tcp_ledbat(O) ppp_async ppp_generic slhc xfrm_user xfrm_ipcomp af_key vfat fat autofs4 button_hotplug(O) ath9k(O) ath9k_common(O) ath9k_hw(O) ath(O) nls_utf8 nls_iso8859_2 nls_iso8859_15 nls_iso8859_13 nls_iso8859_1 nls_cp437 mac80211(O) ts_fsm ts_bm ts_kmp crc_ccitt ipv6 input_polldev cfg80211(O) compat(O) input_core chainiv eseqiv crypto_wq sha1_generic krng rng md5 hmac des_generic cbc authenc arc4 aes_generic crypto_blkcipher cryptomgr aead usb_storage ohci_hcd ehci_hcd sd_mod ext4 jbd2 mbcache usbcore usb_common scsi_mod nls_base crc16 zlib_deflate crypto_hash crypto_algapi ledtrig_timer ledtrig_default_on leds_gpio gpio_button_hotplug(O)
[49066.542968] Process swapper (pid: 0, threadinfo=802fe000, task=803020c0, tls=00000000)
[49066.542968] Stack : fe3319ca 0c000000 00000000 80300000 83f93000 83f93000 8035d470 82b24086
[49066.542968]         82b2406e 83186338 00000002 00000000 00000000 831858a0 80000000 800ee148
[49066.542968]         80300b00 80300b20 000086dd 83d44000 00000000 801e8320 83d44000 80096fc4
[49066.542968]         00000000 00000000 80300b20 80091b2c 4f859d0a 1669a157 83d4438c 83d44380
[49066.542968]         83f93000 83d44000 00000001 83d44000 0000007c 000007b0 83d44238 801d06ec
[49066.542968]         ...
[49066.542968] Call Trace:
[49066.542968] [<831a32e8>] ipv6_chk_mcast_addr+0x3c/0x170 [ipv6]
[49066.542968] [<83186338>] ip6_mc_input+0xd4/0x4dc [ipv6]
[49066.542968] [<801e8320>] __netif_receive_skb+0x458/0x4c8
[49066.542968] [<801d06ec>] ag71xx_poll+0x3b0/0x66c
[49066.542968] [<801e8740>] net_rx_action+0x88/0x1c8
[49066.542968] [<80076e14>] __do_softirq+0xa0/0x154
[49066.542968] [<80077020>] do_softirq+0x48/0x68
[49066.542968] [<80077254>] irq_exit+0x4c/0xb0
[49066.542968] [<80062d4c>] ret_from_irq+0x0/0x4
[49066.542968] [<80062f40>] r4k_wait+0x20/0x40
[49066.542968] [<80064a1c>] cpu_idle+0x38/0x70
[49066.542968] [<8031a8c8>] start_kernel+0x37c/0x39c
[49066.542968] 
[49066.542968] 
[49066.542968] Code: 00000000  08c68ccb  8e10000c <8e430004> 8e440000  00621826  8e020000  00821026  00621025 
[49066.542968] Cpu 0
[49066.542968] $ 0   : 00000000 00000001 00000000 00000000
[49066.542968] $ 4   : 00010006 82b24086 00000000 802ffc84
[49066.542968] $ 8   : fe800000 00000000 02e081ff fe3319ca
[49066.542968] $12   : 00000014 0014002b 00000001 00000001
[49066.542968] $16   : 8315b380 00000000 82b24086 00000000
[49066.542968] $20   : 00000000 80300000 80320000 80300b38
[49066.542968] $24   : 00000000 83186264                  
[49066.542968] $28   : 802fe000 802ffc90 80315c80 831a32e0
[49066.542968] Hi    : 000002cf
[49066.542968] Lo    : 04270c00
[49066.542968] epc   : 831a32ec ipv6_chk_mcast_addr+0x40/0x170 [ipv6]
[49066.542968]     Tainted: G           O
[49066.542968] ra    : 831a32e0 ipv6_chk_mcast_addr+0x34/0x170 [ipv6]
[49066.542968] Status: 1000fc03    KERNEL EXL IE 
[49066.542968] Cause : 00800010
[49066.542968] BadVA : 82b24086
[49066.542968] PrId  : 00019374 (MIPS 24Kc)
[49066.542968] Modules linked in: cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq gpio_buttons ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah ip6table_raw ip6_queue ip6table_mangle ip6table_filter ip6_tables nf_conntrack_ipv6 nf_defrag_ipv6 nf_nat_irc nf_conntrack_irc nf_nat_ftp nf_conntrack_ftp xt_policy xt_esp ipt_ah xt_HL xt_hl xt_ecn ipt_ECN xt_CLASSIFY xt_time xt_tcpmss xt_statistic xt_mark xt_length xt_DSCP xt_dscp xt_string xt_layer7 xt_quota xt_pkttype xt_physdev xt_owner ipt_MASQUERADE iptable_nat nf_nat xt_recent xt_helper xt_connmark xt_connbytes pptp xt_conntrack xt_CT xt_NOTRACK iptable_raw xt_state nf_conntrack_ipv4 nf_defrag_ipv4 nf_conntrack pppoe pppox ipt_REJECT xt_TCPMSS ipt_LOG xt_comment xt_multiport xt_mac xt_limit iptable_mangle iptable_filter ip_tables xt_tcpudp x_tables ip_gre gre ifb sit ipcomp xfrm4_tunnel xfrm4_mode_tunnel xfrm4_mode_transport xfrm4_mode_beet esp4 ah4 tunnel4 tun tcp_ledbat(O) ppp_async ppp_generic slhc xfrm_user xfrm_ipcomp af_key vfat fat autofs4 button_hotplug(O) ath9k(O) ath9k_common(O) ath9k_hw(O) ath(O) nls_utf8 nls_iso8859_2 nls_iso8859_15 nls_iso8859_13 nls_iso8859_1 nls_cp437 mac80211(O) ts_fsm ts_bm ts_kmp crc_ccitt ipv6 input_polldev cfg80211(O) compat(O) input_core chainiv eseqiv crypto_wq sha1_generic krng rng md5 hmac des_generic cbc authenc arc4 aes_generic crypto_blkcipher cryptomgr aead usb_storage ohci_hcd ehci_hcd sd_mod ext4 jbd2 mbcache usbcore usb_common scsi_mod nls_base crc16 zlib_deflate crypto_hash crypto_algapi ledtrig_timer ledtrig_default_on leds_gpio gpio_button_hotplug(O)
[49066.542968] Process swapper (pid: 0, threadinfo=802fe000, task=803020c0, tls=00000000)
[49066.542968] Stack : fe3319ca 0c000000 00000000 80300000 83f93000 83f93000 8035d470 82b24086
[49066.542968]         82b2406e 83186338 00000002 00000000 00000000 831858a0 80000000 800ee148
[49066.542968]         80300b00 80300b20 000086dd 83d44000 00000000 801e8320 83d44000 80096fc4
[49066.542968]         00000000 00000000 80300b20 80091b2c 4f859d0a 1669a157 83d4438c 83d44380
[49066.542968]         83f93000 83d44000 00000001 83d44000 0000007c 000007b0 83d44238 801d06ec
[49066.542968]         ...
[49066.542968] Call Trace:
[49066.542968] [<831a32ec>] ipv6_chk_mcast_addr+0x40/0x170 [ipv6]
[49066.542968] [<83186338>] ip6_mc_input+0xd4/0x4dc [ipv6]
[49066.542968] [<801e8320>] __netif_receive_skb+0x458/0x4c8
[49066.542968] [<801d06ec>] ag71xx_poll+0x3b0/0x66c
[49066.542968] [<801e8740>] net_rx_action+0x88/0x1c8
[49066.542968] [<80076e14>] __do_softirq+0xa0/0x154
[49066.542968] [<80077020>] do_softirq+0x48/0x68
[49066.542968] [<80077254>] irq_exit+0x4c/0xb0
[49066.542968] [<80062d4c>] ret_from_irq+0x0/0x4
[49066.542968] [<80062f40>] r4k_wait+0x20/0x40
[49066.542968] [<80064a1c>] cpu_idle+0x38/0x70
[49066.542968] [<8031a8c8>] start_kernel+0x37c/0x39c
[49066.542968] 
[49066.542968] 
[49066.542968] Code: 08c68ccb  8e10000c  8e430004 <8e440000> 00621826  8e020000  00821026  00621025  8e440008 
[49066.542968] Cpu 0
[49066.542968] $ 0   : 00000000 00000001 00000000 00000000
[49066.542968] $ 4   : ff020000 82b24086 00000000 802ffc84
[49066.542968] $ 8   : fe800000 00000000 02e081ff fe3319ca
[49066.542968] $12   : 00000014 0014002b 00000001 00000001
[49066.542968] $16   : 8315b380 00000000 82b24086 00000000
[49066.542968] $20   : 00000000 80300000 80320000 80300b38
[49066.542968] $24   : 00000000 83186264                  
[49066.542968] $28   : 802fe000 802ffc90 80315c80 831a32e0
[49066.542968] Hi    : 000002cf
[49066.542968] Lo    : 04270c00
[49066.542968] epc   : 831a3300 ipv6_chk_mcast_addr+0x54/0x170 [ipv6]
[49066.542968]     Tainted: G           O
[49066.542968] ra    : 831a32e0 ipv6_chk_mcast_addr+0x34/0x170 [ipv6]
[49066.542968] Status: 1000fc03    KERNEL EXL IE 
[49066.542968] Cause : 00800010
[49066.542968] BadVA : 82b2408e
[49066.542968] PrId  : 00019374 (MIPS 24Kc)
[49066.542968] Modules linked in: cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq gpio_buttons ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah ip6table_raw ip6_queue ip6table_mangle ip6table_filter ip6_tables nf_conntrack_ipv6 nf_defrag_ipv6 nf_nat_irc nf_conntrack_irc nf_nat_ftp nf_conntrack_ftp xt_policy xt_esp ipt_ah xt_HL xt_hl xt_ecn ipt_ECN xt_CLASSIFY xt_time xt_tcpmss xt_statistic xt_mark xt_length xt_DSCP xt_dscp xt_string xt_layer7 xt_quota xt_pkttype xt_physdev xt_owner ipt_MASQUERADE iptable_nat nf_nat xt_recent xt_helper xt_connmark xt_connbytes pptp xt_conntrack xt_CT xt_NOTRACK iptable_raw xt_state nf_conntrack_ipv4 nf_defrag_ipv4 nf_conntrack pppoe pppox ipt_REJECT xt_TCPMSS ipt_LOG xt_comment xt_multiport xt_mac xt_limit iptable_mangle iptable_filter ip_tables xt_tcpudp x_tables ip_gre gre ifb sit ipcomp xfrm4_tunnel xfrm4_mode_tunnel xfrm4_mode_transport xfrm4_mode_beet esp4 ah4 tunnel4 tun tcp_ledbat(O) ppp_async ppp_generic slhc xfrm_user xfrm_ipcomp af_key vfat fat autofs4 button_hotplug(O) ath9k(O) ath9k_common(O) ath9k_hw(O) ath(O) nls_utf8 nls_iso8859_2 nls_iso8859_15 nls_iso8859_13 nls_iso8859_1 nls_cp437 mac80211(O) ts_fsm ts_bm ts_kmp crc_ccitt ipv6 input_polldev cfg80211(O) compat(O) input_core chainiv eseqiv crypto_wq sha1_generic krng rng md5 hmac des_generic cbc authenc arc4 aes_generic crypto_blkcipher cryptomgr aead usb_storage ohci_hcd ehci_hcd sd_mod ext4 jbd2 mbcache usbcore usb_common scsi_mod nls_base crc16 zlib_deflate crypto_hash crypto_algapi ledtrig_timer ledtrig_default_on leds_gpio gpio_button_hotplug(O)
[49066.542968] Process swapper (pid: 0, threadinfo=802fe000, task=803020c0, tls=00000000)
[49066.542968] Stack : fe3319ca 0c000000 00000000 80300000 83f93000 83f93000 8035d470 82b24086
[49066.542968]         82b2406e 83186338 00000002 00000000 00000000 831858a0 80000000 800ee148
[49066.542968]         80300b00 80300b20 000086dd 83d44000 00000000 801e8320 83d44000 80096fc4
[49066.542968]         00000000 00000000 80300b20 80091b2c 4f859d0a 1669a157 83d4438c 83d44380
[49066.542968]         83f93000 83d44000 00000001 83d44000 0000007c 000007b0 83d44238 801d06ec
[49066.542968]         ...
[49066.542968] Call Trace:
[49066.542968] [<831a3300>] ipv6_chk_mcast_addr+0x54/0x170 [ipv6]
[49066.542968] [<83186338>] ip6_mc_input+0xd4/0x4dc [ipv6]
[49066.542968] [<801e8320>] __netif_receive_skb+0x458/0x4c8
[49066.542968] [<801d06ec>] ag71xx_poll+0x3b0/0x66c
[49066.542968] [<801e8740>] net_rx_action+0x88/0x1c8
[49066.542968] [<80076e14>] __do_softirq+0xa0/0x154
[49066.542968] [<80077020>] do_softirq+0x48/0x68
[49066.542968] [<80077254>] irq_exit+0x4c/0xb0
[49066.542968] [<80062d4c>] ret_from_irq+0x0/0x4
[49066.542968] [<80062f40>] r4k_wait+0x20/0x40
[49066.542968] [<80064a1c>] cpu_idle+0x38/0x70
[49066.542968] [<8031a8c8>] start_kernel+0x37c/0x39c
[49066.542968] 
[49066.542968] 
[49066.542968] Code: 8e020000  00821026  00621025 <8e440008> 8e030008  00831826  00431025  8e44000c  8e03000c 
[49066.542968] Cpu 0
[49066.542968] $ 0   : 00000000 00000001 00000000 00000000
[49066.546875] $ 4   : 00000000 82b24086 00000000 802ffc84
[49066.546875] $ 8   : fe800000 00000000 02e081ff fe3319ca
[49066.546875] $12   : 00000014 0014002b 00000001 00000001
[49066.546875] $16   : 8315b380 00000000 82b24086 00000000
[49066.546875] $20   : 00000000 80300000 80320000 80300b38
[49066.546875] $24   : 00000000 83186264                  
[49066.546875] $28   : 802fe000 802ffc90 80315c80 831a32e0
[49066.546875] Hi    : 000002cf
[49066.546875] Lo    : 04270c00
[49066.546875] epc   : 831a3310 ipv6_chk_mcast_addr+0x64/0x170 [ipv6]
[49066.546875]     Tainted: G           O
[49066.546875] ra    : 831a32e0 ipv6_chk_mcast_addr+0x34/0x170 [ipv6]
[49066.546875] Status: 1000fc03    KERNEL EXL IE 
[49066.546875] Cause : 00800010
[49066.546875] BadVA : 82b24092
[49066.546875] PrId  : 00019374 (MIPS 24Kc)
[49066.546875] Modules linked in: cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq gpio_buttons ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah ip6table_raw ip6_queue ip6table_mangle ip6table_filter ip6_tables nf_conntrack_ipv6 nf_defrag_ipv6 nf_nat_irc nf_conntrack_irc nf_nat_ftp nf_conntrack_ftp xt_policy xt_esp ipt_ah xt_HL xt_hl xt_ecn ipt_ECN xt_CLASSIFY xt_time xt_tcpmss xt_statistic xt_mark xt_length xt_DSCP xt_dscp xt_string xt_layer7 xt_quota xt_pkttype xt_physdev xt_owner ipt_MASQUERADE iptable_nat nf_nat xt_recent xt_helper xt_connmark xt_connbytes pptp xt_conntrack xt_CT xt_NOTRACK iptable_raw xt_state nf_conntrack_ipv4 nf_defrag_ipv4 nf_conntrack pppoe pppox ipt_REJECT xt_TCPMSS ipt_LOG xt_comment xt_multiport xt_mac xt_limit iptable_mangle iptable_filter ip_tables xt_tcpudp x_tables ip_gre gre ifb sit ipcomp xfrm4_tunnel xfrm4_mode_tunnel xfrm4_mode_transport xfrm4_mode_beet esp4 ah4 tunnel4 tun tcp_ledbat(O) ppp_async ppp_generic slhc xfrm_user xfrm_ipcomp af_key vfat fat autofs4 button_hotplug(O) ath9k(O) ath9k_common(O) ath9k_hw(O) ath(O) nls_utf8 nls_iso8859_2 nls_iso8859_15 nls_iso8859_13 nls_iso8859_1 nls_cp437 mac80211(O) ts_fsm ts_bm ts_kmp crc_ccitt ipv6 input_polldev cfg80211(O) compat(O) input_core chainiv eseqiv crypto_wq sha1_generic krng rng md5 hmac des_generic cbc authenc arc4 aes_generic crypto_blkcipher cryptomgr aead usb_storage ohci_hcd ehci_hcd sd_mod ext4 jbd2 mbcache usbcore usb_common scsi_mod nls_base crc16 zlib_deflate crypto_hash crypto_algapi ledtrig_timer ledtrig_default_on leds_gpio gpio_button_hotplug(O)
[49066.546875] Process swapper (pid: 0, threadinfo=802fe000, task=803020c0, tls=00000000)
[49066.546875] Stack : fe3319ca 0c000000 00000000 80300000 83f93000 83f93000 8035d470 82b24086
[49066.546875]         82b2406e 83186338 00000002 00000000 00000000 831858a0 80000000 800ee148
[49066.546875]         80300b00 80300b20 000086dd 83d44000 00000000 801e8320 83d44000 80096fc4
[49066.546875]         00000000 00000000 80300b20 80091b2c 4f859d0a 1669a157 83d4438c 83d44380
[49066.546875]         83f93000 83d44000 00000001 83d44000 0000007c 000007b0 83d44238 801d06ec
[49066.546875]         ...
[49066.546875] Call Trace:
[49066.546875] [<831a3310>] ipv6_chk_mcast_addr+0x64/0x170 [ipv6]
[49066.546875] [<83186338>] ip6_mc_input+0xd4/0x4dc [ipv6]
[49066.546875] [<801e8320>] __netif_receive_skb+0x458/0x4c8
[49066.546875] [<801d06ec>] ag71xx_poll+0x3b0/0x66c
[49066.546875] [<801e8740>] net_rx_action+0x88/0x1c8
[49066.546875] [<80076e14>] __do_softirq+0xa0/0x154
[49066.546875] [<80077020>] do_softirq+0x48/0x68
[49066.546875] [<80077254>] irq_exit+0x4c/0xb0
[49066.546875] [<80062d4c>] ret_from_irq+0x0/0x4
[49066.546875] [<80062f40>] r4k_wait+0x20/0x40
[49066.546875] [<80064a1c>] cpu_idle+0x38/0x70
[49066.546875] [<8031a8c8>] start_kernel+0x37c/0x39c
[49066.546875] 
[49066.546875] 
[49066.546875] Code: 8e030008  00831826  00431025 <8e44000c> 8e03000c  00831826  00431025  10400006  00000000 

"
360,Dave Täht,2012-04-11 08:11:54.752907,"I had great difficulty in tweaking the kernel to not hang completely when looking at unaligned traps. Ketkulka found a way to at least survive light traffic.

<pre>
echo 1 1 1 1 > /proc/sys/kernel/printk
echo 2 > /sys/kernel/debug/mips/unaligned_action
logread -f
</pre>

If your box stays up, you can then run moderate amounts of traffic through it
"
360,Robert Bradley,2012-04-11 15:19:07.273241,"If it's what I think it is, it's down to the fact that @ipv6_chk_mcast_addr@ is passed a pointer into the header structure, which is probably unaligned.  The attached patch is ugly and untested (I'm on x86/x64 which doesn't help!), but should get around this issue through copying the address before calling @ip6_mc_input@.

I've also included a patch to mark @in6_addr@ as packed, which might help with other functions.  I'd suggest adding @__packed@ to the @ipv6hdr@ struct too, but @902-unaligned_access_hacks.patch@ does that already."
360,Dave Täht,2012-04-11 17:13:06.102322,"Heh. I got so far as to build a patch, brick two routers, make a newbie mistake, twice, and then succeeded in eliminating the multicast error another way.

Now I get a different one, which I think is solved by one of the other patches in flight... It's really awesome to finally get some insight into this.

Apr 12 00:08:55 OpenWrt kern.alert kernel: [  602.039062] [<8022acc0>] tcp_rcv_established+0xa8/0x690
Apr 12 00:08:55 OpenWrt kern.alert kernel: [  602.039062] [<80231524>] tcp_v4_do_rcv+0x40/0x244
Apr 12 00:08:55 OpenWrt kern.alert kernel: [  602.039062] [<8023359c>] tcp_v4_rcv+0x59c/0x944
Apr 12 00:08:55 OpenWrt kern.alert kernel: [  602.039062] [<80213a88>] ip_local_deliver_finish+0x170/0x29c
Apr 12 00:08:55 OpenWrt kern.alert kernel: [  602.039062] [<801e8320>] __netif_receive_skb+0x458/0x4c8
Apr 12 00:08:55 OpenWrt kern.alert kernel: [  602.039062] [<801d0708>] ag71xx_poll+0x3cc/0x66c
Apr 12 00:08:55 OpenWrt kern.alert kernel: [  602.039062] [<801e8740>] net_rx_action+0x88/0x1c8
Apr 12 00:08:55 OpenWrt kern.alert kernel: [  602.039062] [<80076e14>] __do_softirq+0xa0/0x154
Apr 12 00:08:55 OpenWrt kern.alert kernel: [  602.039062] [<80077020>] do_softirq+0x48/0x68
Apr 12 00:08:55 OpenWrt kern.alert kernel: [  602.039062] [<80077254>] irq_exit+0x4c/0xb0
Apr 12 00:08:55 OpenWrt kern.alert kernel: [  602.039062] [<80062d4c>] ret_from_irq+0x0/0x4
Apr 12 00:08:55 OpenWrt kern.alert kernel: [  602.039062] [<80262910>] maybe_add_creds+0x2c/0x8c
Apr 12 00:08:55 OpenWrt kern.alert kernel: [  602.039062] [<8026407c>] unix_dgram_sendmsg+0x3a4/0x52c
Apr 12 00:08:55 OpenWrt kern.alert kernel: [  602.039062] [<801d877c>] sock_sendmsg+0x84/0xa4
Apr 12 00:08:55 OpenWrt kern.alert kernel: [  602.039062] [<801d9f10>] sys_sendto+0xcc/0x10c
Apr 12 00:08:55 OpenWrt kern.alert kernel: [  602.039062] [<801d9f64>] sys_send+0x14/0x20
Apr 12 00:08:55 OpenWrt kern.alert kernel: [  602.039062] [<80069e44>] stack_done+0x20/0x40
Apr 12 00:08:55 OpenWrt kern.alert kernel: [  602.039062] 

"
360,Dave Täht,2012-04-11 17:27:53.446331,"I note in doing the original patch I only did the right hand side as that seemed to always come from the skb, and the left from an aligned structure.


Remaining bad boys are:

__udp6_lib_rcv

tcp_validate_incoming
tcp_rcv_established (which calls the above, so I think the original patch under discussion is at least part of the right thing) 

In addition to the printk trick
<pre>
logread -f | grep -A 3 ""Call Trace"" | grep -v ""Call Trace""
</pre>

is very helpful. I'm going to load it up with some different kinds of traffic, tunnelling, fw rules, etc, to see if anything else jumps out of the woodwork. If you (and Ketkulka) want to take the patch burden overnight, go fer it (it takes hours to build kernels for cerowrt)
"
360,Dave Täht,2012-04-11 17:37:18.9804,"Can be triggered with a 

rdisc6 eth0

pr 12 00:31:19 OpenWrt kern.alert kernel: [ 1946.695312] [<83097dd0>] ndisc_rcv+0x404/0xf20 [ipv6]
Apr 12 00:31:19 OpenWrt kern.alert kernel: [ 1946.695312] [<8309eba4>] icmpv6_err_convert+0x934/0xba4 [ipv6]

I'm not sure when this happens

[<83095818>] ipv6_setsockopt+0x114/0x44c [ipv6]

I confess I'm looking for more stuff in the hot path than this...

netperf -H 172.30.42.1 -t TCP_MAERTS really triggers this one:

Apr 12 00:34:56 OpenWrt kern.alert kernel: [ 2163.253906] [<8022acc0>] tcp_rcv_established+0xa8/0x690
Apr 12 00:34:56 OpenWrt kern.alert kernel: [ 2163.253906] [<80231524>] tcp_v4_do_rcv+0x40/0x244
Apr 12 00:34:56 OpenWrt kern.alert kernel: [ 2163.253906] [<801db3b0>] release_sock+0xa8/0x10c

Lick that and netperf should get better...

"
360,Dave Täht,2012-04-11 17:42:08.864649,"Apr 12 00:40:01 OpenWrt kern.alert kernel: [ 2468.203125] [<801e6e94>] skb_flow_dissect+0x384/0x400
Apr 12 00:40:01 OpenWrt kern.alert kernel: [ 2468.203125] [<82a273f8>] 0x82a273f8

With some serious traffic through the wired and wireless interfaces through the default aqms...

Originally I didn't want to declare in_addr6 as packed as per your patch, because using 32 bit fetches is GOOD... well... lets see what else breaks.
"
360,Dave Täht,2012-04-11 17:55:51.519079,"Oh man, netperf over ipv6 hurts it bad. That explains a LOT

Apr 12 00:49:58 OpenWrt kern.alert kernel: [ 3065.675781] [<8309bb14>] __udp6_lib_rcv+0x3fc/0x7e4 [ipv6]

A mere ssh works, but it locks up the box for multiple seconds if I hit it with netperf over ipv6.

An easy way to test ivp6 locally is just to do a

laptop# ip -6 addr add 2001:db8:1::2/64 dev whatever
cero # ip -6 addr add 2001:db8:1::1/64 dev whatever

and then you can ssh, web, etc between your two machines


"
360,Dave Täht,2012-04-11 17:58:07.009853,"Looks like this function has **4** traps in it...

Apr 12 00:56:44 OpenWrt kern.alert kernel: [ 3471.902343] [<8309bad4>] __udp6_lib_rcv+0x3bc/0x7e4 [ipv6]
Apr 12 00:56:44 OpenWrt kern.alert kernel: [ 3471.902343] [<83085bc8>] ip6_rcv_finish+0x2a8/0x4a8 [ipv6]
Apr 12 00:56:44 OpenWrt kern.alert kernel: [ 3471.902343] Cause : 00800010
--
Apr 12 00:56:44 OpenWrt kern.alert kernel: [ 3471.906250] [<8309bae4>] __udp6_lib_rcv+0x3cc/0x7e4 [ipv6]
Apr 12 00:56:44 OpenWrt kern.alert kernel: [ 3471.906250] [<83085bc8>] ip6_rcv_finish+0x2a8/0x4a8 [ipv6]
Apr 12 00:56:44 OpenWrt kern.alert kernel: [ 3471.906250] 
--
Apr 12 00:56:44 OpenWrt kern.alert kernel: [ 3471.906250] [<8309bb04>] __udp6_lib_rcv+0x3ec/0x7e4 [ipv6]
Apr 12 00:56:44 OpenWrt kern.alert kernel: [ 3471.906250] [<83085bc8>] ip6_rcv_finish+0x2a8/0x4a8 [ipv6]
Apr 12 00:56:44 OpenWrt kern.alert kernel: [ 3471.906250] 
--
Apr 12 00:56:44 OpenWrt kern.alert kernel: [ 3471.906250] [<8309bb14>] __udp6_lib_rcv+0x3fc/0x7e4 [ipv6]
Apr 12 00:56:44 OpenWrt kern.alert kernel: [ 3471.906250] [<83085bc8>] ip6_rcv_finish+0x2a8/0x4a8 [ipv6]
Apr 12 00:56:44 OpenWrt kern.alert kernel: [ 3471.906250] 
"
360,Dave Täht,2012-04-11 18:46:38.255496,"Some more problem children... I knew we had issues here but had no insight

this is with a ssh connection via ipv6 just catting /etc/passwd

Apr 12 01:45:03 OpenWrt kern.alert kernel: [ 6370.410156] [<80265630>] __inet6_lookup_established+0x3c/0x5f4
Apr 12 01:45:03 OpenWrt kern.alert kernel: [ 6370.410156] [<830a7cf4>] ipv6_frag_exit+0x2b08/0x35c4 [ipv6]
0 OpenWrt kern.alert kernel: [ 6377.667968] Cause : 00800010
--
Apr 12 01:45:10 OpenWrt kern.alert kernel: [ 6377.667968] [<80225e5c>] tcp_validate_incoming+0x5c/0x370
Apr 12 01:45:10 OpenWrt kern.alert kernel: [ 6377.667968] [<8022b298>] tcp_rcv_established+0x680/0x690
Apr 12 01:45:10 OpenWrt kern.alert kernel: [ 6377.667968] [<830a75f4>] ipv6_frag_exit+0x2408/0x35c4 [ipv6]

update...

I was wrong on inet6_addr_equal, the unaligned check needs to be on both the left and right hand side. It is called in the very ugly INET6_MATCH macro..



"
360,Dave Täht,2012-04-11 21:57:48.30481,"So I've folded in the first patch we started with, but hopefully went one better by changing the macro rather than the code. I fear that will break something else but, we'll see. I've also updated the first patch with the easy stuff I could find.

However, finding what is wrong with udp6_lib_rcv - which is in the hotpath - more or less eludes me. Is it something as simple as the skb being unaligned?

I see elsewhere that perhaps the assembly for csum_ipv6_magic might be called unaligned but didn't check further.

So anyway, doing another build with just the fixes so far, I hope this nails a few of the problems... IF it works, I'll put the patches and kernel out around 1AM my time."
360,Dave Täht,2012-04-11 22:46:47.562571,"After I get this build, I plan to disassemble the resulting vmlinux and see if I can spot exactly where exactly the offending code sequences are. 

Assuming it boots and doesn't die, I'll put it up for further testing pleasure. I've noted problems elsewhere with vpn tunnels which possibly might extend to regular (eg - 6in4, 6to4) tunnels, which I am sure I'll be too tired to test myself.

I really don't want to stay up much past midnight.

I've attached the second patch under test. This replaces the patch we started with entirely, and does a couple other new things."
360,Dave Täht,2012-04-11 23:42:50.261027,"net/ipv4/tcp.c: In function 'tcp_gro_receive':
net/ipv4/tcp.c:2837:21: error: lvalue required as left operand of assignment
  CC      net/netfilter/nf_log.o
make[7]: *** [net/ipv4/tcp.o] Error 1
make[6]: *** [net/ipv4] Error 2
make[6]: *** Waiting for unfinished jobs....

Should have tried compiling on x86, first. It's late, I have not enough braincells to continue myself"
360,Dave Täht,2012-04-12 07:50:01.366222,"@robert: Well, I'm trying the in_6 patch. It certainly is a rather big hammer to try."
362,Dave Täht,2012-04-12 09:12:43.008476,"I was doing some work... (and then I got cut off)

on pcp and dslite, and that may have crept into the relevant packages by mistake. 

It certainly wasn't ready for prime time, so if it escaped, I'll fix it.

But aside from that I don't actually use these packages at all, nor do I have automated tests. What exactly is breaking?"
362,Hector Ordorica,2012-04-12 09:17:04.112622,"I usually pull these packages from this build:

https://forum.openwrt.org/viewtopic.php?id=27722

Arokh doesn't use the in tree openwrt packages, I know he uses miniDLNA cvs for example.

For UPNP/NATPMP you only need miniupnpd. 

MDNSresponder isn't needed for anything anymore (as far as I can tell). I think Avahi replaces it.

To get MiniDLNA and miniupnpd to work together (they use the same ports), you use minissdpd to manage that.

Basically, I start with Arokh's tarball as a base, and then apply CeroWRT patches on top of that."
361,David Taht,2012-04-12 09:56:49.820594,"fixed upstream now


---------- Forwarded message ----------
From: David Miller <davem@davemloft.net>
Date: Thu, Apr 12, 2012 at 9:51 AM
Subject: Re: pull request: wireless 2012-04-12
To: linville@tuxdriver.com
Cc: linux-wireless@vger.kernel.org, netdev@vger.kernel.org,
linux-kernel@vger.kernel.org


From: ""John W. Linville"" <linville@tuxdriver.com>
Date: Thu, 12 Apr 2012 10:28:59 -0400

> This is a flurry of fixes intended for 3.4...
>
> Many of these are Bluetooth fixes.  Gustavo says:
>
> ""This is a batch of fixes for 3.4. We have added support to 3 new
> devices, fixes some NULL-pointer dereferences, memory leaks, memory
> corruption and endian bugs. There was also a userspace compatibility
> fix reported by Keith Packard on lkml. The fixes are all simple.""
>
> On top of the Bluetooths bits, we have a number of wireless fixes.
> One is an rt2x00 fix from Chien-Chia Chen which fixes the rfkill
> registration so that it still works even if the box is booted with the
> device already blocked.  Johannes Berg gives us a pair of fixes, one
> that corrects a macro parameter when setting a beacon wait timeout, and
> another that ensures that the proper interface state is used throughout
> nl80211 so as to avoid warnings and unintended driver behavior.
> Julia Lawall gives us a fix for a memory leak in an error handling
> case.  Larry Finger is the star performer for this round, giving us a
> fix for firmware initialization in rtl8192de, a mac80211 fix to quiet
> some log spam, a fix to avoid a NULL pointer dereference in rtlwifi, an
> rtlwifi fix to avoid a ""sleeping function called from invalid context""
> BUG, and another rtlwifi fix to avoid ""Out of SW-IOMMU space"" errors.
> Paul Gortmaker gives us a fix to avoid bcma build breakage on MIPS.
> Samuel Ortiz fixes a loop in NFC's LLCP Tx frame fragmentation loop.
> And finally, Sujith Manoharan reverts an earlier patch in order to
> fix a regression reported by a number of ath9k users.

Pulled, thanks John."
360,Robert Bradley,2012-04-12 11:08:55.58075,"Yes, the in6_addr patch did seem a little extreme, but ought to get every function that touches it with little effort.  It also should require less maintenance than @0002-More-ipv6-unaligned-access-hacks.patch@.  On the other hand, either of these are a lot better than the original fix!

https://dev.openwrt.org/browser/trunk/target/linux/ar71xx/files/drivers/net/ag71xx/ag71xx_main.c?rev=20506

That actually copied the entire packet within the ethernet driver so that it was aligned.  That was later backed out in revision 21166 since copying/moving the entire packet was slower than the exceptions."
362,Maciej Soltysiak,2012-04-12 11:23:31.75025,"miniupnpd is running on port 5000 by default (http://wiki.openwrt.org/doc/uci/miniupnpd)
minidlna is running on port 8200 by default

[b]update: looks like minissdpd might really be required for these 2 to work, because of UDP 1900, not the TCP ports...[/b]

My check for UPNP (apart from `ps` and `netstat -ntpl` on the router):
* netalyzr has a check for that
* utorrent has a built-in checker if it can negotiate with the router to open a port
* other PNP/SSDP test programs like: http://www.junegillespie.plus.com/UPnPTest.exe

My check for minidlna (apart from `ps` or `netstat -ntpl` on the router):
* Run Windows Media Player 12+ (or any other DLNA device, like a TV) and see if it shows your DLNA under ""Other Libraries"" and if you can stream a video or a photo (provided you gave minidlna something to index

I am going to updated to latest cero, install these 2 packages and try describe what's wrong with packaging because I believe the daemons should work, it's just getting the scripts to start properly and read right config files and stay daemonized.
"
360,Dave Täht,2012-04-12 13:54:55.416437,"yea, that was terrible

I made some progress with the combination of patches so far, but I think some dissasembly is now required. tcp_validate_incoming is on the call path,


This is a test against ipv4

Apr 12 20:52:00 OpenWrt kern.alert kernel: [  606.476562] [<8309be9c>] __udp6_lib_rcv+0x3dc/0x7e4 [ipv6]
Apr 12 20:52:00 OpenWrt kern.alert kernel: [  606.476562] [<83085c68>] ip6_rcv_finish+0x2a8/0x4a8 [ipv6]
Apr 12 20:52:00 OpenWrt kern.alert kernel: [  606.476562] 
--
Apr 12 20:52:00 OpenWrt kern.alert kernel: [  606.476562] [<8309beac>] __udp6_lib_rcv+0x3ec/0x7e4 [ipv6]
Apr 12 20:52:00 OpenWrt kern.alert kernel: [  606.476562] [<83085c68>] ip6_rcv_finish+0x2a8/0x4a8 [ipv6]
Apr 12 20:52:00 OpenWrt kern.alert kernel: [  606.476562] 
--
Apr 12 20:52:00 OpenWrt kern.alert kernel: [  606.476562] [<8309bebc>] __udp6_lib_rcv+0x3fc/0x7e4 [ipv6]
Apr 12 20:52:00 OpenWrt kern.alert kernel: [  606.476562] [<83085c68>] ip6_rcv_finish+0x2a8/0x4a8 [ipv6]
Apr 12 20:52:00 OpenWrt kern.alert kernel: [  606.476562] 
--
Apr 12 20:52:01 OpenWrt kern.alert kernel: [  607.121093] [<80225e60>] tcp_validate_incoming+0x5c/0x370
Apr 12 20:52:01 OpenWrt kern.alert kernel: [  607.121093] [<8022b2a0>] tcp_rcv_established+0x684/0x694
Apr 12 20:52:01 OpenWrt kern.alert kernel: [  607.121093] [<80231534>] tcp_v4_do_rcv+0x40/0x244
--
Apr 12 20:52:01 OpenWrt kern.alert kernel: [  607.121093] [<80225e80>] tcp_validate_incoming+0x7c/0x370
Apr 12 20:52:01 OpenWrt kern.alert kernel: [  607.121093] [<8022b2a0>] tcp_rcv_established+0x684/0x694
Apr 12 20:52:01 OpenWrt kern.alert kernel: [  607.121093] [<80231534>] tcp_v4_do_rcv+0x40/0x244
--
Apr 12 20:52:01 OpenWrt kern.alert kernel: [  607.121093] [<80225e88>] tcp_validate_incoming+0x84/0x370
Apr 12 20:52:01 OpenWrt kern.alert kernel: [  607.121093] [<8022b2a0>] tcp_rcv_established+0x684/0x694
Apr 12 20:52:01 OpenWrt kern.alert kernel: [  607.121093] [<80231534>] tcp_v4_do_rcv+0x40/0x244
"
360,Dave Täht,2012-04-12 18:07:03.497556,""
360,Dave Täht,2012-04-12 18:07:13.708651,""
360,Dave Täht,2012-04-12 18:13:07.55955,"I have pushed out 3.3.1-9 which contains some patch sets making ipv6 only have 4x the traps ipv4 does. In either case, it's a LOT of traps on the ethernet side.

(wireless is much better)

In a 60 second 93Mbit test of netperf directly to the router...
    
    proto  traps
    ipv4: 1529909
    ipv6: 6080546
    
    So throwing 100,000 unaligned traps/sec is rather bad.
    25,000 is also bad.

I haven't time to pursue this further this week. I have put up a copy of 3.3.1-9 
(because it IS better) http://huchra.bufferbloat.net/~cero1/3.3/3.3.1-9/

and there is also a copy of vmlinux in there for your profiling pleasure, but perhaps examining the assembly will lend clue.



"
360,Robert Bradley,2012-04-13 06:27:35.708379,"I haven't managed to disassemble vmlinux here, but staring at the functions in question, the only idea I could come up with was to try blindly packing tcp_skb_cb and udp_skb_cb.  I cannot see why this could possibly work, mind you.  The only hope is that MIPS GCC is somehow misaligning some of the fields, which should not be the case!"
362,Dave Täht,2012-04-13 08:06:30.484054,">Arokh doesn't use the in tree openwrt packages, I know he uses miniDLNA cvs for >example.

Although I have been pulling multiple packages from unstable sources, I'd like to do that less, not more.

>For UPNP/NATPMP you only need miniupnpd.

OK.

>MDNSresponder isn't needed for anything anymore (as far as I can tell). I think >Avahi replaces it.

Avahi does, although I currently don't have the router issuing multicast queries to itself, but using the local dns.

>To get MiniDLNA and miniupnpd to work together (they use the same ports), you use minissdpd to manage that.

I don't build that currently...

>Basically, I start with Arokh's tarball as a base, and then apply CeroWRT patches >on top of that.

Call me lazy, but if you can package that up and give me a tarball of the package(s), that would be great. Better, I can give you commit privs to the ceropackages repo.

Let me..."
362,Dave Täht,2012-04-13 08:14:00.465477,"I note that I don't have a problem in pulling something that works from an unstable source, if that's the way to get it to work. I'd merely *prefer* to pull something that works from a released tarball, if at all possible.
"
360,Dave Täht,2012-04-13 10:04:48.86471,That scares me.
362,Hector Ordorica,2012-04-13 10:31:41.874125,"When I get the chance I'll look at adding these packages to cerowrt.

I think by now the in-tree openwrt packages do work, so I'll attempt
to use them as a base.

There's a cerowrt tarball I can work with as a base? It's been a while
since I've worked on the cerowrt base. I've being using arokh's builds
and picking and choosing bufferbloat patches.

The only thing I use Avahi for is to announce time machine/ftp/ssh
servers. I'm not really sure it's necessary to make minidlna/miniupnpd
features work.

A caveat is that miniDLNA can use a good chunk of RAM, especially if
you have BIND running still.

It seems to work fine for me, but I'm using chrony rather than
ntp-client, and dnsmasq rather than BIND, which cuts down on RAM
usage.

On Fri, Apr 13, 2012 at 8:14 AM,  <cerowrt@lists.bufferbloat.net> wrote:
>
> Issue #362 has been updated by Dave Täht.
>
>
> I note that I don't have a problem in pulling something that works from an unstable source, if that's the way to get it to work. I'd merely *prefer* to pull something that works from a released tarball, if at all possible.
>
> ----------------------------------------
> Bug #362: upnp, natpmp, mdnsresponder borked
> https://www.bufferbloat.net/issues/362
>
> Author: David Taht
> Status: New
> Priority: Normal
> Assignee:
> Category:
> Target version:
>
>
> I really haven't been paying attention to those packages.I was doing some work
>
> I am creating a bug for this, please update me there.
>
> What is a good way to test the functionality of these packages?
>
> ---------- Forwarded message ----------
> From: Maciej Soltysiak <maciej@soltysiak.com>
> Date: Wed, Apr 11, 2012 at 12:37 PM
> Subject: Re: [Cerowrt-devel] some of the advanced stuff (sort of) in cerowrt
> To: Dave Taht <dave.taht@gmail.com>
> Cc: cerowrt-devel@lists.bufferbloat.net
>
>
> Hi!
>
>
> 2) UPNP / NATPMP / mDNSresponder - to help different apps reaching out
> - i am sort of losing grasp of which package does what, they seem to
> be intertwined (?) but cero has these packages currently (3.3.1-4)
> broken.
> 3) miniDLNA - DLNA is a good low-latency (?) / high-throughput
> use-case within the wireless (laptops, picture frames) and wired (TV,
> NAS) home network. Also minidlna package is broken too.
>
>"
360,Dave Täht,2012-04-13 10:31:58.037329,"I don't think packing that is a good idea
<pre>
#define TCPCB_TAGBITS           0x07    /* All tag bits                 */
        __u8            ip_dsfield;     /* IPv4 tos or IPv6 dsfield     */
        /* 1 byte hole */
#define TCPCB_EVER_RETRANS      0x80    /* Ever retransmitted frame     */
#define TCPCB_RETRANS           (TCPCB_SACKED_RETRANS|TCPCB_EVER_RETRANS)

        __u32           ack_seq;        /* Sequence number ACK'd        */
</pre>
"
360,Robert Bradley,2012-04-13 10:37:02.732254,"If it helps, I can't see how that could possibly be true either.  I'm just assuming that given we're limited to @__udp_lib_rcv()@ and any inline functions, the only options are:

* Fields in @udphdr@ (uh) - already marked as packed
* @saddr@/@daddr@, which should be covered by the @in6_addr@ patch
* Fields in @skb@
* Fields within @skb->cb@
* The @sock@ structure

I cannot seriously imagine that @skb@ or @sock@ are unaligned, and so we're stuck with anything inside @skb->cb@ - which should still be aligned!  Either way, if this turns out *not* to be a dead end, it will scare me too...

(As for the one byte hole in tcp_skb_cb, we could add an unused __u8 as padding, but I still don't like it.)"
352,Dave Täht,2012-04-13 10:49:20.086309,"vs a vs bug #360 we are up from 110Mb/sec to 185Mb/sec 

I'm going to dismiss the slight lowering of ipv4 as statistical noise.

d@io:~$ iperf -t 60 -c 149.20.63.27
------------------------------------------------------------
Client connecting to 149.20.63.27, TCP port 5001
TCP window size: 64.0 KByte (default)
------------------------------------------------------------
[  3] local 149.20.63.20 port 35441 connected with 149.20.63.27 port 5001
[ ID] Interval       Transfer     Bandwidth
[  3]  0.0-60.0 sec  1.83 GBytes   262 Mbits/sec

d@io:~$ iperf -V -t 60 -c 2001:4f8:3:203::217
------------------------------------------------------------
Client connecting to 2001:4f8:3:203::217, TCP port 5001
TCP window size: 64.0 KByte (default)
------------------------------------------------------------
[  3] local 2001:4f8:3:203::14 port 44866 connected with 2001:4f8:3:203::217 port 5001
[ ID] Interval       Transfer     Bandwidth
[  3]  0.0-60.0 sec  1.29 GBytes   185 Mbits/sec

"
360,Dave Täht,2012-04-13 10:52:48.101669,"BTW, see bug #352.

ipv6 with the current patch set, is at 185Mbit/sec, up from 110.

*Not bad*. :) I think we can improve both ipv4 and ipv6 a lot more.

I think however that some dissassembly and kernel symbols is now required.

I honestly don't know how to do that in openwrt. and even if I could I suspect we'd run out of memory."
332,Dave Täht,2012-04-13 23:44:41.834216,"I have temporarily restored this patch to cerowrt, because I have some hope htb can be fixed....
"
360,Dave Täht,2012-04-14 02:41:18.864133,"
from skbuff.h... need to look into this

 * Since an ethernet header is 14 bytes network drivers often end up with       
 * the IP header at an unaligned offset. The IP header can be aligned by        
 * shifting the start of the packet by 2 bytes. Drivers should do this          
 * with:                                                                        
 *                                                                              
 * skb_reserve(skb, NET_IP_ALIGN);                                              
 *                                                                              
 * The downside to this alignment of the IP header is that the DMA is now       
 * unaligned. On some architectures the cost of an unaligned DMA is high        
 * and this cost outweighs the gains made by aligning the IP header.            
 *                                                                              
 * Since this trade off varies between architectures, we allow NET_IP_ALIGN     
 * to be overridden.                                                            
 */
#ifndef NET_IP_ALIGN
#define NET_IP_ALIGN    2
#endif
"
360,Robert Bradley,2012-04-14 04:21:00.137118,"Apparently this was looked at two years ago by the OpenWRT developers (https://dev.openwrt.org/changeset/20892/trunk/target/linux/ar71xx/files/drivers/net/ag71xx/ag71xx_main.c).  The revision log there claims that ar71xx can't do misaligned DMA, and if that's true, @NET_IP_ALIGN@ isn't going to help.  In other words, we're stuck having to track down unaligned accesses to packet data (which should *not* be affecting the stuff stored in @skb@ or @skb->cb@)."
360,Dave Täht,2012-04-14 10:53:11.240971,"The attach patch... doesn't appear to have done any good performance-wise.

Still see the 4 traps out of the udp6 routine, and that appears to be our baddest boy. The tcp stuff is an artifact of running the test on the router, and relatively unimportant compared to that.

My three thoughts are 1) could still be saddr or daddr being accessed unaligned
2) I stuck up a version compiled for debugging with this patch and the previous ones.

http://huchra.bufferbloat.net/~cero1/3.3/3.3.2-1/

I plan to rip it out in the next version, but it does rule out some stuff, I think.

3) figuring out how to get to the symbol table for this stuff would help. Regular gdb didn't find the relevant symbols, perhaps running the cross gdb would work"
341,Dave Täht,2012-04-14 12:14:47.957079,wide-dhcp-pd is usable. Can't spend time on this now.
345,Dave Täht,2012-04-14 12:33:01.307534,"The next build (3.3.2-3) will have working firewall rules viewable in the web browser.

They may not be perfect... and  suggestions are highly desired.

"
360,Robert Bradley,2012-04-14 18:10:13.057848,"I think the answer may be me being slightly unobservant.  The @__udp6_lib_rcv@ function calls @udp6_csum_init@, an inline function that calls @csum_ipv6_magic@.  And for MIPS, this is implemented in asm, which ignores my packing.  This probably hits the IPv4 side too, except there you have shorter addresses (our 100k/s v6 traps vs. 25k/s IPv4?).

I believe that we need to do one of the following to @/arch/mips/include/asm/checksum.h@:

* Remove @#define _HAVE_ARCH_IPV6_CSUM@ and the @csum_ipv6_magic@ function from this file entirely.  This falls back to the generic C code in @/include/net/ip6_checksum.h@.
* Insert a new variant of @csum_ipv6_magic@ that can handle unaligned addresses.  I've included a possible version below (not in patch format yet).  If the pointers are aligned, we keep using the faster version in the kernel.  If not, we call a new variant by me (which *may* be risky) which calculates the offset, loads in a pair of words at a time and shifts them appropriately.

<pre>
<code class=""c"">
static __inline__ __sum16 csum_ipv6_magic(const struct in6_addr *saddr,
										  const struct in6_addr *daddr,
										  __u32 len, unsigned short proto,
										  __wsum sum)
{
		if ((saddr & 3) || (daddr & 3)) {
			/* Unaligned to word boundaries... */
			return csum_ipv6_unaligned_magic(saddr, daddr, len, proto, sum);
		}
		__asm__(
		""	   .set	push			# csum_ipv6_magic\n""
		""	   .set	noreorder	   \n""
		""	   .set	noat			\n""
		""	   addu	%0, %5		  # proto (long in network byte order)\n""
		""	   sltu	$1, %0, %5	  \n""
		""	   addu	%0, $1		  \n""

		""	   addu	%0, %6		  # csum\n""
		""	   sltu	$1, %0, %6	  \n""
		""	   lw	  %1, 0(%2)	   # four words source address\n""
		""	   addu	%0, $1		  \n""
		""	   addu	%0, %1		  \n""
		""	   sltu	$1, %0, %1	  \n""

		""	   lw	  %1, 4(%2)	   \n""
		""	   addu	%0, $1		  \n""
		""	   addu	%0, %1		  \n""
		""	   sltu	$1, %0, %1	  \n""

		""	   lw	  %1, 8(%2)	   \n""
		""	   addu	%0, $1		  \n""
		""	   addu	%0, %1		  \n""
		""	   sltu	$1, %0, %1	  \n""

		""	   lw	  %1, 12(%2)	  \n""
		""	   addu	%0, $1		  \n""
		""	   addu	%0, %1		  \n""
		""	   sltu	$1, %0, %1	  \n""

		""	   lw	  %1, 0(%3)	   \n""
		""	   addu	%0, $1		  \n""
		""	   addu	%0, %1		  \n""
		""	   sltu	$1, %0, %1	  \n""

		""	   lw	  %1, 4(%3)	   \n""
		""	   addu	%0, $1		  \n""
		""	   addu	%0, %1		  \n""
		""	   sltu	$1, %0, %1	  \n""

		""	   lw	  %1, 8(%3)	   \n""
		""	   addu	%0, $1		  \n""
		""	   addu	%0, %1		  \n""
		""	   sltu	$1, %0, %1	  \n""

		""	   lw	  %1, 12(%3)	  \n""
		""	   addu	%0, $1		  \n""
		""	   addu	%0, %1		  \n""
		""	   sltu	$1, %0, %1	  \n""

		""	   addu	%0, $1		  # Add final carry\n""
		""	   .set	pop""
		: ""=r"" (sum), ""=r"" (proto)
		: ""r"" (saddr), ""r"" (daddr),
		  """" (htonl(len)), ""1"" (htonl(proto)), ""r"" (sum));

		return csum_fold(sum);
}

static __inline__ __sum16 csum_ipv6_unaligned_magic(struct in6_addr *saddr,
										  struct in6_addr *daddr,
										  __u32 len, unsigned short proto,
										  __wsum sum)
{
		__asm__(
		""	   .set	push			# csum_ipv6_magic\n""
		""	   .set	noreorder	   \n""
		""	   .set	noat			\n""
		""	   addu	%0, %5		  # proto (long in network byte order)\n""
		""	   sltu	$1, %0, %5	  \n""
		""	   addu	%0, $1		  \n""

		""	   addu	%0, %6		  # csum\n""
		""	   sltu	$1, %0, %6	  \n""
		""	   andi	%8, %2, 3	   # calc offset for saddr\n""
		""	   sub	 %2, %2, %8	  # align pointer\n""
		""	   sll	 %8, %8, 8	   # calc shift left amount\n""
		""	   lui	 %9, 32		  # calc shift right amount\n""
		""	   srl	 %9, 16		  \n""
		""	   subi	%9, %9, %8	  \n""
		""	   lw	  %1, 0(%2)	   # four words source address\n""
		""	   lw	  %10, 4(%2)	  # and next word\n""
		""	   sllv	%1, %1, %8	  # shift word1 left\n""
		""	   srlv	%10, %10, %9	# shift word2 right\n""
		""	   or	  %1, %1, %10	 # or together\n""
		""	   addu	%0, $1		  \n""
		""	   addu	%0, %1		  \n""
		""	   sltu	$1, %0, %1	  \n""

		""	   lw	  %1, 4(%2)	   \n""
		""	   lw	  %10, 8(%2)	  \n""
		""	   sllv	%1, %1, %8	  \n""
		""	   srlv	%11, %10, %9	\n""
		""	   or	  %1, %1, %11	 \n""
		""	   addu	%0, $1		  \n""
		""	   addu	%0, %1		  \n""
		""	   sltu	$1, %0, %1	  \n""

		""	   lw	  %1, 8(%2)	   \n""
		""	   lw	  %10, 12(%2)	 \n""
		""	   sllv	%1, %1, %8	  \n""
		""	   srlv	%11, %10, %9	\n""
		""	   or	  %1, %1, %11	 \n""
		""	   addu	%0, $1		  \n""
		""	   addu	%0, %1		  \n""
		""	   sltu	$1, %0, %1	  \n""

		""	   lw	  %1, 12(%2)	  \n""
		""	   lw	  %10, 16(%2)	 \n""
		""	   sllv	%1, %1, %8	  \n""
		""	   srlv	%11, %10, %9	\n""
		""	   or	  %1, %1, %11	 \n""
		""	   addu	%0, $1		  \n""
		""	   addu	%0, %1		  \n""
		""	   sltu	$1, %0, %1	  \n""
		
		""	   srl	 %8, %8, 8	   # Undo damage to saddr\n""
		""	   addu	 %2, %2, %8	  \n""

		""	   andi	%8, %3, 3	   # calc offset for daddr\n""
		""	   sub	 %3, %3, %8	  # align pointer\n""
		""	   sll	 %8, %8, 8	   # calc shift left amount\n""
		""	   lui	 %9, 32		  # calc shift right amount\n""
		""	   srl	 %9, 16		  \n""
		""	   subi	%9, %9, %8	  \n""
		""	   lw	  %1, 0(%3)	   # four words source address\n""
		""	   lw	  %10, 4(%3)	  # and next word\n""
		""	   sllv	%1, %1, %8	  # shift word1 left\n""
		""	   srlv	%10, %10, %9	# shift word2 right\n""
		""	   or	  %1, %1, %10	 # or together\n""
		""	   addu	%0, $1		  \n""
		""	   addu	%0, %1		  \n""
		""	   sltu	$1, %0, %1	  \n""

		""	   lw	  %1, 4(%3)	   \n""
		""	   lw	  %10, 8(%3)	  \n""
		""	   sllv	%1, %1, %8	  \n""
		""	   srlv	%10, %10, %9	\n""
		""	   or	  %1, %1, %10	 \n""
		""	   addu	%0, $1		  \n""
		""	   addu	%0, %1		  \n""
		""	   sltu	$1, %0, %1	  \n""

		""	   lw	  %1, 8(%3)	   \n""
		""	   lw	  %10, 12(%3)	  \n""
		""	   sllv	%1, %1, %8	  \n""
		""	   srlv	%10, %10, %9	\n""
		""	   or	  %1, %1, %10	 \n""
		""	   addu	%0, $1		  \n""
		""	   addu	%0, %1		  \n""
		""	   sltu	$1, %0, %1	  \n""

		""	   lw	  %1, 12(%3)	   \n""
		""	   lw	  %10, 16(%3)	  \n""
		""	   sllv	%1, %1, %8	  \n""
		""	   srlv	%10, %10, %9	\n""
		""	   or	  %1, %1, %10	 \n""
		""	   addu	%0, $1		  \n""
		""	   addu	%0, %1		  \n""
		""	   sltu	$1, %0, %1	  \n""

		""	   srl	 %8, %8, 8	   # Undo damage to daddr\n""
		""	   addu	 %3, %3, %8	  \n""

		""	   addu	%0, $1		  # Add final carry\n""
		""	   .set	pop""
		: ""=r"" (sum), ""=r"" (proto)
		: ""r"" (saddr), ""r"" (daddr),
		  """" (htonl(len)), ""1"" (htonl(proto)), ""r"" (sum));

		return csum_fold(sum);
}
</code>
</pre>"
360,Robert Bradley,2012-04-15 04:54:31.360125,""
360,Robert Bradley,2012-04-15 05:00:13.623626,"I have created two patches corresponding to the two options in comment 28.  Needless to say, these cannot both be applied at the same time!  One other thing to note is that the asm option is big-endian specific, which isn't an issue for ar71xx, but is worth remembering if this ends up being submitted somewhere else."
360,Dave Täht,2012-04-15 10:48:32.983189,"Jeebus, robert, what do you do when not hacking mips assembly?

I'm um, er, reluctant to just toss a rewritten assembly routine in that has been tested, but what the heck - I'll do a build with it tonight and see what happens. Otherwise, falling back to the C routine ought to 'just work'. I may just fire off two builds to save on test time.

But:

Yes! the checksum routine looks like a very good candidate for this bug. Historically it's always been a major bottleneck in the first place."
360,Dave Täht,2012-04-15 11:06:06.065935,"do you have to tell gcc you are scribbling on regs %8,%9,%10 somehow? Or are they garunteed to be scratch by the api?"
360,Robert Bradley,2012-04-15 11:20:51.576654,"According to ftp://ftp.linux-mips.org/pub/linux/mips/doc/ABI2/MIPS-N32-ABI-Handbook.pdf, they're used for function arguments (which we don't have in this case), and are caller-saved in any case.  If you're worried about it, I can move these to the temporary registers %12-%15, or just stick to the generic C version.

I think the saddr section of that code also uses %11, but that can be safely replaced by %10.  My original thoughts were to try and avoid loading the same word twice, which means you need to store the original word somewhere.  In the end, I used the simpler approach of simply reloading it."
360,Robert Bradley,2012-04-15 11:31:22.551223,... and the patches for those (replacing the old patch for unaligned calculations via MIPS asm).
360,Dave Täht,2012-04-15 11:50:23.051583,"just so you know that patch had one char of trailing whitespace on it on every line. There are ways to avoid that in most editors... I'm trying to finish up a patch to sfq to let me switch two behaviors at runtime and also doing something else... I think what I'll do is fire off a build with your asm patch (sans whitespace), cross fingers and see what pops out in 3 hours.
"
360,Robert Bradley,2012-04-15 11:53:19.153676,"Hang on ... GCC does have a way to mark clobbered registers (http://www.ibiblio.org/gferg/ldp/GCC-Inline-Assembly-HOWTO.html#ss5.3).  In case it matters, I have an updated patch using registers 12-14 and marking those as clobbered.

Sorry for not seeing that sooner!"
360,Robert Bradley,2012-04-15 11:56:09.360948,"By the way, thanks for spotting the trailing whitespace, too.  (Too late for the previous comment, though.)"
360,Dave Täht,2012-04-15 12:12:24.100611,"Wasn't me. Git griped about the whitespace. As would an upstream maintainer. 

as an emacs user I've had pure hell in making kernel code look right to those folks, myself....

I had fixed that on your previous 'temponly' patch and started a build, so, what the heck, I'll try that one first, then replace it with this successor...

... after I catch up on the ABI a bit. It would be good to know if gcc was smart enough nowadays to figure this out."
360,Dave Täht,2012-04-15 12:14:53.944014,"OR: I could just see if that build blew up. You want to fix it and supply a new patch? 

/home/cero1/src/cerowrt-3.3.0/build_dir/linux-ar71xx_generic/linux-3.3.2/arch/mips/include/asm/checksum.h: In function 'csum_ipv6_magic':
/home/cero1/src/cerowrt-3.3.0/build_dir/linux-ar71xx_generic/linux-3.3.2/arch/mips/include/asm/checksum.h:206:13: error: invalid operands to binary & (have 'const struct in6_addr *' and 'int')
/home/cero1/src/cerowrt-3.3.0/build_dir/linux-ar71xx_generic/linux-3.3.2/arch/mips/include/asm/checksum.h:206:28: error: invalid operands to binary & (have 'const struct in6_addr *' and 'int')
/home/cero1/src/cerowrt-3.3.0/build_dir/linux-ar71xx_generic/linux-3.3.2/arch/mips/include/asm/checksum.h:208:3: error: implicit declaration of function 'csum_ipv6_unaligned_magic' [-Werror=implicit-function-declaration]
/home/cero1/src/cerowrt-3.3.0/build_dir/linux-ar71xx_generic/linux-3.3.2/arch/mips/include/asm/checksum.h: At top level:
/home/cero1/src/cerowrt-3.3.0/build_dir/linux-ar71xx_generic/linux-3.3.2/arch/mips/include/asm/checksum.h:269:27: error: conflicting types for 'csum_ipv6_unaligned_magic'
/home/cero1/src/cerowrt-3.3.0/build_dir/linux-ar71xx_generic/linux-3.3.2/arch/mips/include/asm/checksum.h:208:10: note: previous implicit declaration of 'csum_ipv6_unaligned_magic' was here
In file included from include/net/checksum.h:26:0,
                 from include/linux/skbuff.h:28,
                 from include/linux/netlink.h:155,
                 from include/linux/rtnetlink.h:5,
                 from crypto/algapi.c:19:
/home/cero1/src/cerowrt-3.3.0/build_dir/linux-ar71xx_generic/linux-3.3.2/arch/mips/include/asm/checksum.h: In function 'csum_ipv6_magic':
/home/cero1/src/cerowrt-3.3.0/build_dir/linux-ar71xx_generic/linux-3.3.2/arch/mips/include/asm/checksum.h:206:13: error: invalid operands to binary & (have 'const struct in6_addr *' and 'int')
/home/cero1/src/cerowrt-3.3.0/build_dir/linux-ar71xx_generic/linux-3.3.2/arch/mips/include/asm/checksum.h:206:28: error: invalid operands to binary & (have 'const struct in6_addr *' and 'int')
/home/cero1/src/cerowrt-3.3.0/build_dir/linux-ar71xx_generic/linux-3.3.2/arch/mips/include/asm/checksum.h:208:3: error: implicit declaration of function 'csum_ipv6_unaligned_magic' [-Werror=implicit-function-declaration]
/home/cero1/src/cerowrt-3.3.0/build_dir/linux-ar71xx_generic/linux-3.3.2/arch/mips/include/asm/checksum.h: At top level:
/home/cero1/src/cerowrt-3.3.0/build_dir/linux-ar71xx_generic/linux-3.3.2/arch/mips/include/asm/checksum.h:269:27: error: conflicting types for 'csum_ipv6_unaligned_magic'
/home/cero1/src/cerowrt-3.3.0/build_dir/linux-ar71xx_generic/linux-3.3.2/arch/mips/include/asm/checksum.h:208:10: note: previous implicit declaration of 'csum_ipv6_unaligned_magic' was here
cc1: some warnings being treated as errors

make[6]: *** [crypto/crypto_wq.o] Error 1
make[6]: *** Waiting for unfinished jobs....
cc1: some warnings being treated as errors

make[6]: *** [crypto/scatterwalk.o] Error 1
  CC [M]  fs/btrfs/root-tree.o
  CC [M]  fs/btrfs/dir-item.o
  LD [M]  fs/autofs4/autofs4.o
  CC [M]  fs/btrfs/file-item.o
  CC [M]  drivers/block/loop.o
cc1: some warnings being treated as errors

make[6]: *** [crypto/algapi.o] Error 1
make[5]: *** [crypto] Error 2
make[5]: *** Waiting for unfinished jobs....
  CC [M]  fs/btrfs/inode-item.o
  CC [M]  fs/btrfs/inode-map.o
  CC [M]  fs/btrfs/disk-io.o
  CC [M]  fs/btrfs/transaction.o
  CC [M]  fs/btrfs/inode.o
  CC [M]  fs/btrfs/file.o
  CC [M]  fs/btrfs/tree-defrag.o
  CC [M]  drivers/input/input.o
  CC [M]  drivers/input/input-compat.o
  CC [M]  drivers/leds/leds-gpio.o
  CC [M]  drivers/input/input-mt.o
  CC [M]  drivers/leds/leds-wndr3700-usb.o
  CC [M]  drivers/leds/ledtrig-timer.o
  CC [M]  drivers/leds/ledtrig-default-on.o
  CC [M]  drivers/leds/ledtrig-netdev.o
  CC [M]  drivers/input/ff-core.o
  CC [M]  drivers/input/input-polldev.o
  CC [M]  fs/btrfs/extent_map.o
In file included from include/net/checksum.h:26:0,
                 from include/linux/skbuff.h:28,
                 from include/linux/if_ether.h:134,
                 from include/linux/netdevice.h:29,
                 from drivers/leds/ledtrig-netdev.c:25:
/home/cero1/src/cerowrt-3.3.0/build_dir/linux-ar71xx_generic/linux-3.3.2/arch/mips/include/asm/checksum.h: In function 'csum_ipv6_magic':
/home/cero1/src/cerowrt-3.3.0/build_dir/linux-ar71xx_generic/linux-3.3.2/arch/mips/include/asm/checksum.h:206:13: error: invalid operands to binary & (have 'const struct in6_addr *' and 'int')
/home/cero1/src/cerowrt-3.3.0/build_dir/linux-ar71xx_generic/linux-3.3.2/arch/mips/include/asm/checksum.h:206:28: error: invalid operands to binary & (have 'const struct in6_addr *' and 'int')
/home/cero1/src/cerowrt-3.3.0/build_dir/linux-ar71xx_generic/linux-3.3.2/arch/mips/include/asm/checksum.h:208:3: error: implicit declaration of function 'csum_ipv6_unaligned_magic' [-Werror=implicit-function-declaration]
/home/cero1/src/cerowrt-3.3.0/build_dir/linux-ar71xx_generic/linux-3.3.2/arch/mips/include/asm/checksum.h: At top level:
/home/cero1/src/cerowrt-3.3.0/build_dir/linux-ar71xx_generic/linux-3.3.2/arch/mips/include/asm/checksum.h:269:27: error: conflicting types for 'csum_ipv6_unaligned_magic'
/home/cero1/src/cerowrt-3.3.0/build_dir/linux-ar71xx_generic/linux-3.3.2/arch/mips/include/asm/checksum.h:208:10: note: previous implicit declaration of 'csum_ipv6_unaligned_magic' was here
  CC [M]  drivers/input/keyboard/gpio_keys_polled.o
cc1: some warnings being treated as errors
"
360,Dave Täht,2012-04-15 12:18:23.739442,"Just needed to declare the function ahead of the call. I can patch your patch...

or just go to lunch...

/asm/checksum.h:208:3: error: implicit declaration of function 'csum_ipv6_unaligned_magic' [-Werror=implicit-function-declaration]

"
360,Dave Täht,2012-04-15 12:23:07.817495,"Going back to the ipv4 traps, the csum routine over there is already patched by felix's original patch, so I suspect the 25k/sec traps on ipv4 are coming from someplace that's too hard to see right now, with all the other traps.

"
360,Dave Täht,2012-04-15 12:38:19.935811,"Never mind, I'm fixing it.Too excited at the prospect at seeing another 40Mbit/sec out of this puppy. Wet paint...."
360,Robert Bradley,2012-04-15 12:40:19.854808,"You'll need to cast saddr and daddr to __u32 (or int) in the alignment test, too."
360,Dave Täht,2012-04-15 12:44:13.547602,"OK, I'm not fixing it. :(

fatal: corrupt patch at line 136

Can I coax you to give it another go?"
360,Robert Bradley,2012-04-15 12:46:15.240899,Sure - I was in the process of doing that and removing the trailing whitespace at the time.
360,Dave Täht,2012-04-15 13:09:13.013306,"const appeared to be needed.

and you missed a whitespace at line 136. :)

"
360,Dave Täht,2012-04-15 13:09:35.140611,""
360,Dave Täht,2012-04-15 13:12:05.169684,"While I'd LIKE the assembly to work very much, I'm going to go back to the C patch for now, just to prove we have proof of concept.

/home/cero1/src/cerowrt-3.3.0/build_dir/linux-ar71xx_generic/linux-3.3.2/arch/mips/include/asm/checksum.h:281:2: error: invalid 'asm': operand number out of range
{standard input}:810: Error: Illegal operands `lw ,4($3)'
{standard input}:811: Error: Illegal operands `sllv $6,$6,'
{standard input}:812: Error: Illegal operands `srlv ,,'
{standard input}:813: Error: absolute expression required `or $6,$6,'
{standard input}:818: Error: Illegal operands `lw ,8($3)'
{standard input}:819: Error: Illegal operands `sllv $6,$6,'
{standard input}:820: Error: Illegal operands `srlv ,,'
{standard input}:821: Error: absolute expression required `or $6,$6,'
{standard input}:826: Error: Illegal operands `lw ,12($3)'
{standard input}:827: Error: Illegal operands `sllv $6,$6,'
{standard input}:828: Error: Illegal operands `srlv ,,'
{standard input}:829: Error: absolute expression required `or $6,$6,'
{standard input}:834: Error: Illegal operands `lw ,16($3)'
{standard input}:835: Error: Illegal operands `sllv $6,$6,'
{standard input}:836: Error: Illegal operands `srlv ,,'
{standard input}:837: Error: absolute expression required `or $6,$6,'
{standard input}:841: Error: Illegal operands `srl ,,8'
{standard input}:842: Error: absolute expression required `addu $3,$3,'
{standard input}:844: Error: Unrecognized opcode `set pop'


Nice way to spend a sunday, tho...

"
360,Dave Täht,2012-04-15 13:18:55.903431,"C patch just worked. Building now. Going to lunch. THX, we'll get there on the asm. (I used to really love programming in asm)"
360,Dave Täht,2012-04-15 13:20:04.305578,"and the first pass kernel built. rest is building... Seriously going to lunch now.

I note that I'm not doing a from-scratch-clean-build this time, so it'll be done before I get back."
360,Dave Täht,2012-04-15 13:50:02.004979,"back. build crashed (elsewhere)... restarting.

My best guess at the problem with tcp_validate_incoming is that it's blowing up on accessing the tcphdr (th->rst and th->syn), and the only way for that to happen is that that 16 bit value is on the 3rd byte of a word.

Naturally, tcphdr is a bitfield. I suppose a union here would clean it up,
I'm pretty sure get_unaligned_whatever will mess it up...

But I think the majority of the remaining traps are in this routine.

"
360,Dave Täht,2012-04-15 13:58:26.728944,"So maybe this for tcp stuff?

Might actually be usable throughout as written. Never can wrap my head around endian issues...."
360,Dave Täht,2012-04-15 14:04:54.86844,"ok, ok, I missed a semicolon. But don't I have to worry about the native endianness of the local architecture if I do 8 bit values where 16 bit ones were?"
360,Robert Bradley,2012-04-15 14:17:37.083879,"I'd have thought so too, but it actually looks right to me.  I'm actually a bit surprised the kernel developers didn't need to move both the 4 bit fields to the end of the struct, but the compiler must be smart enough to cope with that (otherwise it wouldn't be working now)."
360,Dave Täht,2012-04-15 16:04:38.80541,"Have to move this to the wired lan, but I can confirm that the new build
now available at:

http://huchra.bufferbloat.net/~cero1/3.3/3.3.2-3/

does indeed boot. (it has a bunch of other new stuff in it too, notably new firewall rules).

It does not have the tcp patch as yet. 

It FEELs better. Even with logging on, it took a long time to throw these

<pre>

Apr 15 22:41:33 OpenWrt kern.alert kernel: [  820.781250] [<8024560c>] igmp_rcv+0x114/0x68c
Apr 15 22:41:33 OpenWrt kern.alert kernel: [  820.781250] [<802141d4>] ip_local_deliver_finish+0x174/0x2a0
Apr 15 22:41:33 OpenWrt kern.alert kernel: [  820.781250] [<801e8990>] __netif_receive_skb+0x458/0x4c8
--
Apr 15 22:41:33 OpenWrt kern.alert kernel: [  820.781250] [<80245810>] igmp_rcv+0x318/0x68c
Apr 15 22:41:33 OpenWrt kern.alert kernel: [  820.781250] [<802141d4>] ip_local_deliver_finish+0x174/0x2a0
Apr 15 22:41:33 OpenWrt kern.alert kernel: [  820.781250] [<801e8990>] __netif_receive_skb+0x458/0x4c8
--
Apr 15 22:41:34 OpenWrt kern.alert kernel: [  821.574218] [<8308fe64>] ip6_route_input+0x70/0xd8 [ipv6]
Apr 15 22:41:34 OpenWrt kern.alert kernel: [  821.574218] [<83086310>] ipv6_rcv+0x41c/0x4c4 [ipv6]
Apr 15 22:41:34 OpenWrt kern.alert kernel: [  821.574218] [<801e8990>] __netif_receive_skb+0x458/0x4c8

Apr 15 22:42:39 OpenWrt kern.alert kernel: [  886.886718] [<83095b08>] ipv6_setsockopt+0x118/0x444 [ipv6]
Apr 15 22:42:39 OpenWrt kern.alert kernel: [  886.886718] 
Apr 15 22:42:39 OpenWrt kern.alert kernel: [  886.886718] 
--
Apr 15 22:42:39 OpenWrt kern.alert kernel: [  886.886718] [<83095b10>] ipv6_setsockopt+0x120/0x444 [ipv6]
Apr 15 22:42:39 OpenWrt kern.alert kernel: [  886.886718] 
Apr 15 22:42:39 OpenWrt kern.alert kernel: [  886.886718] 

</pre>

*AND IT DOESN'T CHOKE on ipv6!*

<pre>
Apr 15 22:55:23 OpenWrt kern.alert kernel: [  231.015625] [<83246310>] ipv6_rcv+0x41c/0x4c4 [ipv6]
Apr 15 22:55:23 OpenWrt kern.alert kernel: [  231.015625] [<801e8990>] __netif_receive_skb+0x458/0x4c8
--
Apr 15 22:55:23 OpenWrt kern.alert kernel: [  231.015625] [<8022b4b4>] tcp_rcv_established+0x84/0x694
Apr 15 22:55:23 OpenWrt kern.alert kernel: [  231.015625] [<83267fe8>] ipv6_frag_exit+0x2538/0x3768 [ipv6]
Apr 15 22:55:23 OpenWrt kern.alert kernel: [  231.015625] 
--
Apr 15 22:55:23 OpenWrt kern.alert kernel: [  231.015625] [<8022b4d4>] tcp_rcv_established+0xa4/0x694
Apr 15 22:55:23 OpenWrt kern.alert kernel: [  231.015625] [<83267fe8>] ipv6_frag_exit+0x2538/0x3768 [ipv6]
Apr 15 22:55:23 OpenWrt kern.alert kernel: [  231.015625] 
--
Apr 15 22:55:23 OpenWrt kern.alert kernel: [  231.015625] [<8022b4dc>] tcp_rcv_established+0xac/0x694
Apr 15 22:55:23 OpenWrt kern.alert kernel: [  231.015625] [<83267fe8>] ipv6_frag_exit+0x2538/0x3768 [ipv6]
Apr 15 22:55:23 OpenWrt kern.alert kernel: [  231.015625] 
Apr 15 22:55:56 OpenWrt kern.alert kernel: [  264.242187] 
--
Apr 15 22:55:56 OpenWrt kern.alert kernel: [  264.253906] [<8022b4d4>] tcp_rcv_established+0xa4/0x694
Apr 15 22:55:56 OpenWrt kern.alert kernel: [  264.253906] [<83267fe8>] ipv6_frag_exit+0x2538/0x3768 [ipv6]
Apr 15 22:55:56 OpenWrt kern.alert kernel: [  264.253906] 
--
Apr 15 22:55:56 OpenWrt kern.alert kernel: [  264.253906] [<8022b4dc>] tcp_rcv_established+0xac/0x694
 265.199218]         0000fb04 821a7700 83177780 000004fc 00000000 00010000 0090d410 80221878
Apr 15 22:55:57 OpenWrt kern.alert kernel: [  265.199218]         ...
Apr 15 22:55:57 OpenWrt kern.alert kernel: [  265.199218] [<8022b4d4>] tcp_rcv_established+0xa4/0x694
Apr 15 22:55:57 OpenWrt kern.alert kernel: [  265.199218] [<83267fe8>] ipv6_frag_exit+0x2538/0x3768 [ipv6]
Apr 15 22:55:57 OpenWrt kern.alert kernel: [  265.199218] 
--
Apr 15 22:55:57 OpenWrt kern.alert kernel: [  265.207031] [<8022b4d4>] tcp_rcv_established+0xa4/0x694
Apr 15 22:55:57 OpenWrt kern.alert kernel: [  265.207031]         65726600 6e657470 821a7700 83177780 821a7700 80288c18 
821a7700 8322b180
Apr 15 22:55:57 OpenWrt kern.alert kernel: [  265.207031]         00000000 80360000 802e15e8 801dba10 00000000 00000000 
00010000 8022e930
--
Apr 15 22:55:57 OpenWrt kern.alert kernel: [  265.207031] [<8022b4dc>] tcp_rcv_established+0xac/0x694
Apr 15 22:55:57 OpenWrt kern.alert kernel: [  265.207031] [<83267fe8>] ipv6_frag_exit+0x2538/0x3768 [ipv6]
Apr 15 22:55:57 OpenWrt kern.alert kernel: [  265.207031] 
--
Recv   Send    Send                          
Socket Socket  Message  Elapsed              
Size   Size    Size     Time     Throughput  
bytes  bytes   bytes    secs.    10^6bits/sec  

 87380  65536  65536    10.17       2.78   
</pre>

The above throughput, with traps on, is over double what we started with.

<pre>

root@OpenWrt:~# netperf -l 60 -6 -H huchra.bufferbloat.net
MIGRATED TCP STREAM TEST from :: (::) port 0 AF_INET6 to lists.bufferbloat.net () port 0 AF_INET6 : demo
Recv   Send    Send                          
Socket Socket  Message  Elapsed              
Size   Size    Size     Time     Throughput  
bytes  bytes   bytes    secs.    10^6bits/sec  

 87380  65536  65536    60.00     140.29   
root@OpenWrt:~# netperf -l 60 -6 -H huchra.bufferbloat.net -t TCP_MAERTS
MIGRATED TCP MAERTS TEST from :: (::) port 0 AF_INET6 to lists.bufferbloat.net () port 0 AF_INET6 : demo
Recv   Send    Send                          
Socket Socket  Message  Elapsed              
Size   Size    Size     Time     Throughput  
bytes  bytes   bytes    secs.    10^6bits/sec  

 87380  16384  16384    60.01     181.54
</pre>

Can't draw any conclusions from these two numbers, I have different firewall rules now... but it's definitely better. and I guess I should do that on a fresh boot.

"
360,Dave Täht,2012-04-15 16:26:42.804247,"
Proof, tho, in the ratios.

This is on a machine that can only do 100Mbit, so the results will differ...

root@cruithne:~/git/deBloat/test# netperf -l 60 -6 -H 2001:4f8:fff8:900::1
MIGRATED TCP STREAM TEST from ::0 (::) port 0 AF_INET6 to 2001:4f8:fff8:900::1 () port 0 AF_INET6
Recv   Send    Send                          
Socket Socket  Message  Elapsed              
Size   Size    Size     Time     Throughput  
bytes  bytes   bytes    secs.    10^6bits/sec  

 87380  65536  65536    60.16      92.70   
root@cruithne:~/git/deBloat/test# bc
bc 1.06.95
Copyright 1991-1994, 1997, 1998, 2000, 2004, 2006 Free Software Foundation, Inc.
This is free software with ABSOLUTELY NO WARRANTY.
For details type `warranty'. 
11117911-9183546
1934365
./60
32239 For ipv6

root@cruithne:~/git/deBloat/test# netperf -l 60 -4 -H 172.29.9.1
MIGRATED TCP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 172.29.9.1 () port 0 AF_INET
Recv   Send    Send                          
Socket Socket  Message  Elapsed              
Size   Size    Size     Time     Throughput  
bytes  bytes   bytes    secs.    10^6bits/sec  

 87380  65536  65536    60.14      94.12   
root@cruithne:~/git/deBloat/test# bc
bc 1.06.95
Copyright 1991-1994, 1997, 1998, 2000, 2004, 2006 Free Software Foundation, Inc.
This is free software with ABSOLUTELY NO WARRANTY.
For details type `warranty'. 
12587173-11164137
1423036
./60
23717
"
360,Dave Täht,2012-04-15 16:29:25.157953,"And further proof it's no longer in the checksum routine.

tcp_rcv_established (which affects both ipv6 and ipv4) is the bad boy now.

root@cruithne:~/git/deBloat/test# netperf -l 60 -6 -H 2001:4f8:fff8:900::1 -t TCP_MAERTS
MIGRATED TCP MAERTS TEST from ::0 (::) port 0 AF_INET6 to 2001:4f8:fff8:900::1 () port 0 AF_INET6
Recv   Send    Send                          
Socket Socket  Message  Elapsed              
Size   Size    Size     Time     Throughput  
bytes  bytes   bytes    secs.    10^6bits/sec  

 87380  65536  65536    60.01      91.80   
root@cruithne:~/git/deBloat/test# bc
bc 1.06.95
Copyright 1991-1994, 1997, 1998, 2000, 2004, 2006 Free Software Foundation, Inc.
This is free software with ABSOLUTELY NO WARRANTY.
For details type `warranty'. 
13544979-12630492
914487
./60
15241
"
360,Robert Bradley,2012-04-15 17:13:24.804222,"Yes, definitely the right track, and we may even hit that 1000 traps/s target soon enough."
360,Robert Bradley,2012-04-15 17:46:38.053311,"Final patch for this evening:

* Packed igmp headers (eliminating the trap in igmp_rcv)
* Changed tcp_parse_aligned_timestamp so that it uses the __get_unaligned_cpu32() macros"
362,Maciej Soltysiak,2012-04-16 05:06:09.903936,"Update. I've installed minissdpd, miniupnpd and minidlna-cvs from trondah (http://enduser.subsignal.org/~trondah/latest-release-is-r31219/packages/) and they work. All I needed to correct were the interface names in /etc/config/... to include se00,sw00 and sw10. If proper starting sequence is respected it works: minissdpd, then miniupnpnd, then minidlna.

If I knew how to add these packages to the build, I'd do it.

There's one issue with it though. When my TV is on se00 and my laptop on sw10, they can't discover each other as UPNP queries are broadcast-domain-bound (won't traverse NICs) - so the network fragmentation plays in my disadvantage here. I still need to poke around to see if there's anything I missed or maybe I could use iptables to DNAT it to the other interfaces.

Having said all that, I still need to evaluate performance of minidlna on WNDR3800 and how much memory/cpu stress it could cause with 30.000 files. Unfortunately I can only check with a NTFS drive promptly. Converting it to ext4 is tricky as I don't have enough storage space handy that would allow me to do it quickly enough.

Anyway, this is mostly DLNA talk. If that wouldn't make it into cero, I could live with it, but I'd still like to see miniupnpd for UPNP assisted port forwarding negotiation and since it would be good for the build to allow users to install minidlna externally, minissdp would also be very nice to see (as per the dependcy Hector mentioned)
"
362,Dave Täht,2012-04-16 07:04:24.147595,"I'll try to make anything work. But does he have his source packages somewhere?

As for the crossing broadcast domain issue, I'm always into finding those and figuring out how to fix them..."
362,Hector Ordorica,2012-04-16 08:36:56.152584,"That's his source.

http://enduser.subsignal.org/~trondah/releases/r31216/openwrt-r31216-src.tar.bz2

As far as performance of MiniDLNA, it will use a lot of disk seeks and CPU while it builds its database. But otherwise it mostly sits idle, and serves up files on demand. I personally have a swap file enabled since I hits the limits of the 64MB of RAM."
360,Robert Bradley,2012-04-16 09:11:41.95039,""
360,Robert Bradley,2012-04-16 09:11:58.24504,""
360,Robert Bradley,2012-04-16 09:12:15.194373,""
360,Robert Bradley,2012-04-16 10:19:22.67505,""
360,Robert Bradley,2012-04-16 10:20:16.071132,""
360,Dave Täht,2012-04-16 11:03:52.373405,"going through the router, rather than to it, with the last set of patches (not the new stuff added last night), I get 220+ MB/sec through the router on both ipv4 and ipv6!"
352,Robert Bradley,2012-04-16 15:33:27.449466,"Based on Dave's latest comments on bug #360 (http://www.bufferbloat.net/issues/360#note-65), I am tentatively marking this as resolved.  Performance of IPv6 is now over double the original measurements, and similar to that of IPv4."
360,Dave Täht,2012-04-16 20:16:38.13307,"The tcp timestamp check looks like a far more viable candidate for the problems here than the 8 bit alignment thing for the tcp headers. I look forward to trying these wednesday or so.

(I have a few more but I don't remember what they are right now)

I've accumulated a few more patches that look important, as well. And I need to make sch_sfq switchable via a module param between the faster, possibly unstable, HoQ behavior, to the older Tail of Q behavior (ToQ). But I look forward to a day where something like a ping flood won't do bad things to this puppy, and perhaps another 20-30Mbit/sec of performance can be had.

I do like the asm patch in that I'm really not fond of making everything use unaligned accesses in the network stack, there are plenty of cases (probably well over 80%) where that isn't needed. Route lookups come to mind.

However tracking all those down is hard, and certainly killing 75000 traps/sec increased performance by 2 which is hard to argue with!"
360,Dave Täht,2012-04-17 20:55:38.884724,"in turning tcp timestamps off via sysctl I believe you found the real source of the tcp rcv problem.
With them off, with logging on, ipv6...

<pre>
m@cruithne:~$ netperf -6 -H 2001:4f8:fff8:800::1
MIGRATED TCP STREAM TEST from ::0 (::) port 0 AF_INET6 to 2001:4f8:fff8:800::1 () port 0 AF_INET6
Recv   Send    Send                          
Socket Socket  Message  Elapsed              
Size   Size    Size     Time     Throughput  
bytes  bytes   bytes    secs.    10^6bits/sec  

 87380  65536  65536    10.31       6.43  

</pre>

(this is like over double what it was before)

And even more significantly...

<pre>
m@cruithne:~$ netperf -H 172.29.9.1
MIGRATED TCP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 172.29.9.1 () port 0 AF_INET
Recv   Send    Send                          
Socket Socket  Message  Elapsed              
Size   Size    Size     Time     Throughput  
bytes  bytes   bytes    secs.    10^6bits/sec  

 87380  65536  65536    10.06      94.80   
</pre>

Yes, I'm getting the actual possible throughput on this link, under ipv4, even with logging the traps turned. Nice job. I'll apply the patch.

As for why ipv6 is still throwing so many traps under this scenario, it appears to be

Apr 18 03:53:58 OpenWrt kern.alert kernel: [172007.242187] [<801e7508>] skb_flow_dissect+0x388/0x400
Apr 18 03:53:58 OpenWrt kern.alert kernel: [172007.242187] [<82afd3f8>] 0x82afd3f8
Apr 18 03:53:58 OpenWrt kern.alert kernel: [172007.242187] 

Apr 18 03:55:10 OpenWrt kern.alert kernel: [172078.832031] [<82b08d3c>] 0x82b08d3c
Apr 18 03:55:10 OpenWrt kern.alert kernel: [172078.832031] 
Apr 18 03:55:10 OpenWrt kern.alert kernel: [172078.832031] 
--

Apr 18 03:55:20 OpenWrt kern.alert kernel: [172088.753906] [<831cfe64>] ip6_route_input+0x70/0xd8 [ipv6]
Apr 18 03:55:20 OpenWrt kern.alert kernel: [172088.753906] [<831c6310>] ipv6_rcv+0x41c/0x4c4 [ipv6]
Apr 18 03:55:20 OpenWrt kern.alert kernel: [172088.753906] [<801e8990>] __netif_receive_skb+0x458/0x4c8




"
360,Robert Bradley,2012-04-18 04:53:36.694705,"Dave, is that really only 6.4 Mb/s on IPv6?

I managed to find a pointer cast and dereference in ip6_route_input, which I assume is part of the problem.  I also noticed it called __ipv6_addr_type, which should be unaligned-safe now that in6_addr is packed.  Either way, this new patch should hopefully fix both of these issues."
360,Robert Bradley,2012-04-18 06:05:30.770365,"Since I had some free time, I decided to plough through the entire /net/ipv6 directory with grep looking for *(__be32 *) pointer dereferencing.  The hope is that this will catch a lot of the remaining unaligned references left in the IPv6 stack, at the possible expense of a few false positives.  I also packed the icmpv6 and ipv6 option header structs, which hopefully should improve the ping flood resistance a bit."
360,Dave Täht,2012-04-18 06:41:36.697812,"A little duplication of work here, I'd done the route stuff and skb dissect fixes and then fell asleep while the build ran, without an update to the bug log here.

However, I did NOT break out the atomic weapons you did on your second patch. :)

I would prefer to test stuff a little incrementally, the build I started last night had your most recent asm patch in it, in particular, and as soon as I wake up a little more, I'll install the build, then verify functionality (in fact, I'm having some route lookup issues in ra, that bother me), then move forward with the rest. 


"
360,Dave Täht,2012-04-18 06:44:11.942145,"yes, ipv6 tcp endpoints, with logging on, run at 6Mbit/sec, ipv4 tcp endpoints, with logging on, 94+ (The laptop is only 100Mbit), with timestamps off.

explains a lot about the issues I was having with developing a load measuring test that would 'just work' on the router."
360,Dave Täht,2012-04-18 08:17:52.528364,"[  580.136718] ICMPv6 checksum failed [2001:04f8:fff8:0800:0227:13ff:fe64:8967 > ff02:0000:0000:0000:0000:0001:ff00:0001]

I'm willing to pursue doing this routine in assembly but I think it would be best to move to testing it in userspace. Going back to C for it for now.

"
360,Dave Täht,2012-04-18 08:41:13.137288,"btw, in the process of so thoroughly breaking ipv6, I got some insight as to where all the traps came from. Perversely, thank you for breaking that. :)

I think with the tcp timestamp fix in place, we can regard ipv4 as baked now.

<pre>

root@OpenWrt:/sys/kernel/debug/mips# netperf -l60 -4 -H huchra.bufferbloat.net
MIGRATED TCP STREAM TEST from 0.0.0.0 () port 0 AF_INET to lists.bufferbloat.net () port 0 AF_INET : demo
Recv   Send    Send                          
Socket Socket  Message  Elapsed              
Size   Size    Size     Time     Throughput  
bytes  bytes   bytes    secs.    10^6bits/sec  

 87380  65536  65536    60.00     179.97   
root@OpenWrt:/sys/kernel/debug/mips# cat unaligned_instructions 
173
root@OpenWrt:/sys/kernel/debug/mips# 

</pre>

tunneling still needs to get tested, and that particular test was with the aqm code off...

<pre>
Apr 18 15:24:25 OpenWrt kern.alert kernel: [ 1073.734375] [<82bad404>] 0x82bad404
Apr 18 15:24:25 OpenWrt kern.alert kernel: [ 1073.734375] 
--
Apr 18 15:24:36 OpenWrt kern.alert kernel: [ 1084.785156] [<801e7510>] skb_flow_dissect+0x390/0x410
Apr 18 15:24:36 OpenWrt kern.alert kernel: [ 1084.785156] [<82bad404>] 0x82bad404
Apr 18 15:24:36 OpenWrt kern.alert kernel: [ 1084.785156] 
--
Apr 18 15:24:41 OpenWrt kern.alert kernel: [ 1089.253906] [<801e7510>] skb_flow_dissect+0x390/0x410
Apr 18 15:24:41 OpenWrt kern.alert kernel: [ 1089.253906] [<82bad404>] 0x82bad404
Apr 18 15:24:41 OpenWrt kern.alert kernel: [ 1089.253906] 
--
Apr 18 15:37:11 OpenWrt kern.alert kernel: [ 1839.308593] [<801e7510>] skb_flow_dissect+0x390/0x410
Apr 18 15:37:11 OpenWrt kern.alert kernel: [ 1839.308593] [<82bad404>] 0x82bad404
Apr 18 15:37:11 OpenWrt kern.alert kernel: [ 1839.308593] 
--
Apr 18 15:37:24 OpenWrt kern.alert kernel: [ 1852.539062] [<801e7510>] skb_flow_dissect+0x390/0x410
Apr 18 15:37:24 OpenWrt kern.alert kernel: [ 1852.539062] [<82bad404>] 0x82bad404
Apr 18 15:37:24 OpenWrt kern.alert kernel: [ 1852.539062] 

Recv   Send    Send                          
Socket Socket  Message  Elapsed              
Size   Size    Size     Time     Throughput  
bytes  bytes   bytes    secs.    10^6bits/sec  

 87380  65536  65536    60.00     179.19   
root@OpenWrt:/sys/kernel/debug/mips# cat unaligned_instructions 
187

</pre>

That's awfully rare to throw that, and so I suspect that's leaking over from some bit of the still partially working ipv6 code.

I'm actually really tempted to leave it broken and test tunnels today. As well as a few other things like wireless, that we haven't looked at lately. I have high hopes that wireless (with the timestamp fix) just improved a bit


"
360,Dave Täht,2012-04-18 08:49:46.291923,"ah. simple idea. fall back to the c version of the checksum routine when unaligned? Probably do the same thing to the ipv4 routine.

As a similar exercise, moving it to userspace to see which wins, looks straightforward.

I mean, the shift thing is clever but gcc has come a long way since that routine was written...

I'm going to take a harder look at the two tunneling issues I have in the issue tracker, during this actually convienent time while ipv6 is toast...
"
360,Robert Bradley,2012-04-18 10:35:26.095032,"I was wanting to apologise for managing to waste so much of your time on the asm version, actually!  Speaking of which, I was overshifting - ""sll $12, $12, 0x08"" should be ""sll $12, $12, 0x03"", and ""srl $12, $12, 0x08"" becomes ""srl $12, $12, 0x03"".  There's also a question of whether a bitshift right of 32 does what I think it should (clear the register), which is needed for aligned addresses.

Personally, I'd stick to using the C version and assuming GCC now does the right thing.  We know that works well enough, and there's bigger problems to worry about elsewhere."
360,Dave Täht,2012-04-18 10:56:33.09166,"Hey, I enjoy assembly and remember well when it was necessary. And it still is, and checksums like this are problems...

But what I think is best is a unalignment check on both ipv4 and v6, prefacing the known to work mips one. This should be better on ipv6 and ipv4 than what we started with, especially on wireless. 

I'm reworking that patch set now and reviewing your mondo patch.

In checking the tunneling code I found all sorts of problems like this, and I do hope that ends up improving ipsec, ipip, and so on by a lot. I'd only got 20Mbit/sec out of ipsec when I tested it last year. Now I know why..."
360,Dave Täht,2012-04-18 10:57:43.769553,"oh, and the asm patch is turning out USEFUL. In breaking ipv6 completely, I can gain insight into the remaining ipv4 problems. Thank you. (perversely)"
360,Dave Täht,2012-04-18 13:33:21.544482,"OK, I have a cleanedup, rollup patch of everything that we've needed to touch to date.

I think.

I still need to look harder at the vtun code, but for sure, ipsec was going to suck.
"
304,Dave Täht,2012-04-18 14:26:04.188637,"And I'd turned it on, only to have months of weirdness to deal with. See #560 and the journal of irreproducible results."
360,Dave Täht,2012-04-18 15:56:21.576072,"
<pre>

root@OpenWrt:/sys/kernel/debug/mips# cat unaligned_instructions 
912353
root@OpenWrt:/sys/kernel/debug/mips# netperf -6 -H huchra.bufferbloat.net -t TCP_MAERTS
MIGRATED TCP MAERTS TEST from :: (::) port 0 AF_INET6 to lists.bufferbloat.net () port 0 AF_INET6 : demo

Recv   Send    Send                          
Socket Socket  Message  Elapsed              
Size   Size    Size     Time     Throughput  
bytes  bytes   bytes    secs.    10^6bits/sec  

 87380  16384  16384    10.01     200.20   
root@OpenWrt:/sys/kernel/debug/mips# 
root@OpenWrt:/sys/kernel/debug/mips# cat unaligned_instructions 
912357


root@OpenWrt:/sys/kernel/debug/mips# cat unaligned_instructions 
912361
root@OpenWrt:/sys/kernel/debug/mips# netperf -4 -H huchra.bufferbloat.net -t TCP_MAERTS


Size   Size    Size     Time     Throughput  
bytes  bytes   bytes    secs.    10^6bits/sec  

 87380  16384  16384    10.01     225.00   
root@OpenWrt:/sys/kernel/debug/mips# cat unaligned_instructions 
912365
</pre>

However, on forwarding traffic, we're getting eaten alive, but I think I have a grip on that.

<pre>

Apr 18 22:54:26 OpenWrt kern.alert kernel: [ 1075.269531] [<801e750c>] skb_flow_dissect+0x38c/0x410
Apr 18 22:54:26 OpenWrt kern.alert kernel: [ 1075.269531] [<82b9d404>] 0x82b9d404
Apr 18 22:54:26 OpenWrt kern.alert kernel: [ 1075.269531] 
--
Apr 18 22:54:27 OpenWrt kern.alert kernel: [ 1077.480468] [<801e750c>] skb_flow_dissect+0x38c/0x410
Apr 18 22:54:27 OpenWrt kern.alert kernel: [ 1077.480468] [<82b9d404>] 0x82b9d404
Apr 18 22:54:27 OpenWrt kern.alert kernel: [ 1077.480468] 
--
Apr 18 22:54:29 OpenWrt kern.alert kernel: [ 1078.566406] [<801e750c>] skb_flow_dissect+0x38c/0x410
Apr 18 22:54:29 OpenWrt kern.alert kernel: [ 1078.566406] [<82b9d404>] 0x82b9d404
Apr 18 22:54:29 OpenWrt kern.alert kernel: [ 1078.566406] 

</pre>"
360,Robert Bradley,2012-04-18 16:45:46.86558,"You've probably beaten me to this, but here's my efforts with skb_flow_dissect."
360,Dave Täht,2012-04-18 20:41:20.826395,"No, I got so far as .7 traps a sec on ipv6 and 7000/sec on ipv4, and fell asleep. 

I decided before trying again to check for output from you.

problem is, none of those candidates seem plausible. flow->ports should be aligned already..... GRE is not hit, I at least am not doing vlans, but yea, looking at that makes sense.... "
367,Dave Täht,2012-04-19 23:33:30.700344,"this is a 3.4 issue, now fixed. No need to backport."
366,Dave Täht,2012-04-19 23:35:00.563669,"3.4 issue that only affects boxes with gro/lro on. Important to note on testing with x86, not a cero issue."
362,Dave Täht,2012-04-19 23:38:44.139239,"Please send me cero-specific conf files? and tell me which package sets to use? Openwrt? the other guys?

Also, I have a user reporting that upnp doesn't work the way he expected in that he wanted to open port 22, gets 2022 on both sides, and I don't understand the requested behavior...
"
359,Dave Täht,2012-04-19 23:43:55.380112,Tested in cerowrt 3.3.2-6. Will probably be fixed in 3.3.3
353,Dave Täht,2012-04-19 23:46:40.340135,"fix went into stable, not sure when, but basically before 3.3.2"
347,Dave Täht,2012-04-19 23:48:43.555057,fixed by 3.3.2
345,Dave Täht,2012-04-19 23:50:24.482343,fixed in 3.3.2
335,Dave Täht,2012-04-19 23:52:22.642602,massive improvements by #360
332,Dave Täht,2012-04-19 23:58:31.004245,"I have thus far found it impossible to create bad behavior when sfqred is used properly - flows prime or near prime in the 24-53 range, low min, 200-300 packets, and redflowlimit. I have created a kernel module that can change the behavior from hoq to toq at module load time, and am testing elsewhere.

Pushing forward to head of queue has wonderful effects on mice, dns, and ants.

The behavior I see in shooting elephants, is fine by me."
332,Dave Täht,2012-04-19 23:58:46.039456,""
276,Dave Täht,2012-04-20 00:02:57.518584,""
295,Dave Täht,2012-04-20 00:04:11.372226,""
305,Dave Täht,2012-04-20 00:05:55.014794,sfqred runs on EVERYTHING.
324,Dave Täht,2012-04-20 00:14:15.988943,"No need to fiddle with tx anymore whatsoever, with bql.

However, on routers with tso/gso/ufo support, and possibly lro/gro, it helps to turn those OFF. The wndr has none of those features, x86s do.

I am running successfully with a 256 clock now."
210,Dave Täht,2012-04-20 00:15:31.680461,"I have been able to dynamically change the tx rings for a while...

but bql eliminates the need, and the default is now 64 anyway."
89,Dave Täht,2012-04-20 00:18:43.467036,cron job needed? syntax stable?
360,Dave Täht,2012-04-20 09:34:11.995582,"I found it. more news as it happens.

http://huchra.bufferbloat.net/~cero1/3.3/3.3.2-7/

I'm a little concerned in that I'm seeing nat timeouts... or something related to the sfq patch... we just tinkled over a whole lot of code...
"
360,Dave Täht,2012-04-20 09:55:28.132552,"Nope. Throwing 10,000 traps/sec at 240Mbit, when the aqms are enabled.
on ipv4. Temporarily not able to test ipv6...

nearly zero when aqms disabled."
360,Robert Bradley,2012-04-20 17:45:45.281627,"I was going to suggest looking at @include/net/inet_ecn.h@ and @include/net/dsfield.h@, but those seem reasonably OK for IPv4 (but not IPv6).  That's assuming that sfqred and the functions it calls are the cause of this, as opposed to something deeper in the scheduling code."
360,Dave Täht,2012-04-21 01:06:02.300343,"about 1 trap per second now (or rather 4 or more in a row every time babel does a route update)

both ipv6 and ipv4 do about 250Mbit through the router without aqm and nearly no firewall rules. The router never gets 'chunky' in it's feel, and although I care about the last set of traps, we'll get them eventually. 

With default aqm/fw rules, about 224. (I note that usually, you are sending less than 20Mbit out the second ethernet port) I have not benchmarked wireless with this version, it was doing well when last I checked.

It does concern me that occasionally I get a complete tcp or nat reset from #371, but that is in part the product of my busy lab (10+ machines) spewing RA and babel routing info everywhere. Or so I think.

Now I can finally think I have a 'fluid model' to play with and can have onboard measurements and calculations that make sense, or so I hope. THANK YOU FOR THE HELP. 

http://huchra.bufferbloat.net/~cero1/3.3/3.3.2-8/

I did at one point see 288Mbit through the router, but that may have been an illusion.

Anyway, gotta see how gone #371 and test some wireless next..."
371,Robert Bradley,2012-04-21 05:49:52.96215,"I'm posting this from Windows, so no patches, unfortunately.  Looking at online copies of the source though (http://lxr.free-electrons.com/ and others), the likely suspects are @addr_bit_set@ in ""@net/ipv6/ip6_fib.c@"":http://lxr.free-electrons.com/source/net/ipv6/ip6_fib.c?a=mips#L133 and @__ipv6_prefix_equal@ in ""@include/net/ipv6.h@"":http://lxr.free-electrons.com/source/include/net/ipv6.h?a=mips#L345."
362,Robert Bradley,2012-04-21 06:15:35.096014,"I assume the idea is to map <external>:22 => <internal>:22.  Since that possibly clashes with the internal sshd, I'd naively expect it to map <external>:2022 => <internal>:22 instead (you don't get the external port you wanted, but a mapping does exist).  If it's changing the requested mapping to <external>:2022 => <internal>:2022, that's a bug."
360,Dave Täht,2012-04-21 09:47:34.306556,"incidentally, to make poking into this easier, I started building debuggable kernels and copying them (and the contents of the patched linux source tree) to a flash stick that I could then call up with gdb on the router.

That makes it possible to look at the symbol tables with the +offset.

Maybe the cross dev gdb works, too, never checked.

Regrettably this doesn't work terribly well with kernel modules. If you compile them as part of the build, you can do that too...

But doing this mostly via mark 1 eyeball was constructive, as I at least, learned a lot about how the ipv6 and ipv4 hot (and cold) paths actually worked. "
352,Dave Täht,2012-04-21 09:49:24.180258,"I'm going to treat the route update bug of #371 as a separate bug.

This bug was too epic in scope. Please do not delete any patches, they are useful to have around as blind alleys."
360,Dave Täht,2012-04-21 09:49:24.854352,"I'm going to treat the route update bug of #371 as a separate bug.

This bug was too epic in scope. Please do not delete any patches, they are useful to have around as blind alleys."
371,Robert Bradley,2012-04-21 10:16:10.725907,Here are the patches for the changes suggested in comment 1.
371,Dave Täht,2012-04-21 10:36:05.328355,"my comment is that we were seeing the trap in setsockopt, but were hard to find during dissassembly which did imply they were in an inline. These patches seem somewhat plausible, so I'll toss them in the next build. Thanks, as always."
372,Dave Täht,2012-04-21 12:01:44.58344,"<pre>
m@cruithne:~/git/CerowrtCredits$ netperf -6 -Y CS1,CS1 -l 60 -H 2001:4f8:fff8:902::1
MIGRATED TCP STREAM TEST from ::0 (::) port 0 AF_INET6 to 2001:4f8:fff8:902::1 () port 0 AF_INET6
Recv   Send    Send                          
Socket Socket  Message  Elapsed              
Size   Size    Size     Time     Throughput  
bytes  bytes   bytes    secs.    10^6bits/sec  

 87380  65536  65536    60.05      53.83   

And this demonstrates the hardware BE and BK queues actually working over ipv6 for the first time.....

m@cruithne:~/git/CerowrtCredits$ netperf -6 -Y BE,BE -l 60 -H 2001:4f8:fff8:902::1 &
[1] 13374
m@cruithne:~/git/CerowrtCredits$ MIGRATED TCP STREAM TEST from ::0 (::) port 0 AF_INET6 to 2001:4f8:fff8:902::1 () port 0 AF_INET6

m@cruithne:~/git/CerowrtCredits$ netperf -6 -Y CS1,CS1 -l 60 -H 2001:4f8:fff8:902::1 
MIGRATED TCP STREAM TEST from ::0 (::) port 0 AF_INET6 to 2001:4f8:fff8:902::1 () port 0 AF_INET6

Recv   Send    Send                          
Socket Socket  Message  Elapsed              
Size   Size    Size     Time     Throughput  
bytes  bytes   bytes    secs.    10^6bits/sec  

 87380  65536  65536    60.02      53.05   
Recv   Send    Send                          
Socket Socket  Message  Elapsed              
Size   Size    Size     Time     Throughput  
bytes  bytes   bytes    secs.    10^6bits/sec  

 87380  65536  65536    60.01       3.01   

</pre>
"
369,Dave Täht,2012-04-21 12:24:53.269553,fixed in cerowrt-3.3.2-8 (cherry picked)
260,Dave Täht,2012-04-21 12:27:41.618197,so far as I know this hasn't been a problem in months.
219,Dave Täht,2012-04-21 12:29:32.729519,""
219,Dave Täht,2012-04-21 12:30:17.88391,"dropbear could use some improvement, yes, both on oom, and on max-cpu behavior.

but the oom bug is separate."
228,Dave Täht,2012-04-21 12:31:50.066118,
248,Dave Täht,2012-04-21 12:31:50.785726,
300,Dave Täht,2012-04-21 12:31:51.882176,
270,Dave Täht,2012-04-21 12:31:53.231968,
299,Dave Täht,2012-04-21 12:31:54.299967,
204,Dave Täht,2012-04-21 12:32:48.017796,""
224,Dave Täht,2012-04-21 12:33:52.508435,""
95,Dave Täht,2012-04-21 12:35:46.184924,
210,Dave Täht,2012-04-21 12:35:46.915013,
327,Dave Täht,2012-04-21 12:35:47.805375,
334,Dave Täht,2012-04-21 12:35:48.437577,
335,Dave Täht,2012-04-21 12:35:49.25458,
336,Dave Täht,2012-04-21 12:35:49.843868,
340,Dave Täht,2012-04-21 12:35:50.769922,
342,Dave Täht,2012-04-21 12:35:51.714476,
355,Dave Täht,2012-04-21 12:35:52.377267,
195,Dave Täht,2012-04-21 12:37:34.861598,
240,Dave Täht,2012-04-21 12:37:35.626102,
243,Dave Täht,2012-04-21 12:37:36.382536,
256,Dave Täht,2012-04-21 12:37:37.038472,
266,Dave Täht,2012-04-21 12:37:37.898407,
275,Dave Täht,2012-04-21 12:37:38.561829,
289,Dave Täht,2012-04-21 12:37:39.415403,
291,Dave Täht,2012-04-21 12:37:40.852826,
292,Dave Täht,2012-04-21 12:37:42.653524,
325,Dave Täht,2012-04-21 12:37:43.616177,
326,Dave Täht,2012-04-21 12:37:44.524573,
329,Dave Täht,2012-04-21 12:37:45.303343,
259,Dave Täht,2012-04-21 12:38:22.086126,
265,Dave Täht,2012-04-21 12:38:23.494325,
278,Dave Täht,2012-04-21 12:38:24.386487,
279,Dave Täht,2012-04-21 12:38:25.217017,
288,Dave Täht,2012-04-21 12:38:25.923431,
302,Dave Täht,2012-04-21 12:38:26.965393,
305,Dave Täht,2012-04-21 12:38:27.838016,
310,Dave Täht,2012-04-21 12:38:29.083406,
320,Dave Täht,2012-04-21 12:38:30.13271,
323,Dave Täht,2012-04-21 12:38:32.072575,
324,Dave Täht,2012-04-21 12:38:32.978244,
45,Dave Täht,2012-04-21 12:42:02.55823,
89,Dave Täht,2012-04-21 12:42:03.277336,
110,Dave Täht,2012-04-21 12:42:04.725862,
112,Dave Täht,2012-04-21 12:42:05.924398,
122,Dave Täht,2012-04-21 12:42:07.078982,
123,Dave Täht,2012-04-21 12:42:08.112688,
175,Dave Täht,2012-04-21 12:42:09.183993,
176,Dave Täht,2012-04-21 12:42:10.029397,
197,Dave Täht,2012-04-21 12:42:11.653427,
201,Dave Täht,2012-04-21 12:42:12.543581,
206,Dave Täht,2012-04-21 12:42:13.376915,
221,Dave Täht,2012-04-21 12:42:13.998439,
222,Dave Täht,2012-04-21 12:42:14.865407,
223,Dave Täht,2012-04-21 12:42:15.749241,
225,Dave Täht,2012-04-21 12:42:17.304875,
227,Dave Täht,2012-04-21 12:42:18.852392,
230,Dave Täht,2012-04-21 12:42:20.553294,
250,Dave Täht,2012-04-21 12:42:21.677293,
251,Dave Täht,2012-04-21 12:42:22.993358,
257,Dave Täht,2012-04-21 12:42:23.742777,
296,Dave Täht,2012-04-21 12:42:25.411931,
309,Dave Täht,2012-04-21 12:42:26.044145,
321,Dave Täht,2012-04-21 12:42:27.373288,
338,Dave Täht,2012-04-21 12:42:28.565488,
218,Dave Täht,2012-04-21 12:44:27.268395,"Lacking further data, I'm closing this bug."
238,Dave Täht,2012-04-21 12:45:57.304213,"I have not seen this bug in ages. Please test with the current build (3.3.2-8 or later) and let me know.

http://huchra.bufferbloat.net/~cero1/3.3/3.3.2-8/"
207,Dave Täht,2012-04-21 12:46:58.925872,HAve no idea if this still occurs. We are using polipo 1.5 now in cerowrt.
331,Dave Täht,2012-04-21 12:47:19.59842,""
264,Dave Täht,2012-04-21 12:48:05.412794,"Well, we now have enough infrastructure to look into this harder."
246,Dave Täht,2012-04-21 12:48:54.093331,I'll argue that most of the last several months builds would do the right thing here.
254,Dave Täht,2012-04-21 12:49:27.101902,""
113,Dave Täht,2012-04-21 12:50:28.917704,
203,Dave Täht,2012-04-21 12:50:29.592232,
205,Dave Täht,2012-04-21 12:50:30.404124,
239,Dave Täht,2012-04-21 12:50:31.454214,
86,Dave Täht,2012-04-21 13:04:40.267126,
90,Dave Täht,2012-04-21 13:04:41.016005,
124,Dave Täht,2012-04-21 13:04:41.568426,
168,Dave Täht,2012-04-21 13:04:42.484218,
226,Dave Täht,2012-04-21 13:04:43.134763,
231,Dave Täht,2012-04-21 13:04:44.056777,
232,Dave Täht,2012-04-21 13:04:44.95418,
234,Dave Täht,2012-04-21 13:04:45.61579,
237,Dave Täht,2012-04-21 13:04:46.50428,
247,Dave Täht,2012-04-21 13:04:47.19014,
307,Dave Täht,2012-04-21 13:04:48.080622,
308,Dave Täht,2012-04-21 13:04:48.935454,
314,Dave Täht,2012-04-21 13:04:49.615157,
316,Dave Täht,2012-04-21 13:04:50.548396,
317,Dave Täht,2012-04-21 13:04:51.94374,
318,Dave Täht,2012-04-21 13:04:53.008413,
319,Dave Täht,2012-04-21 13:04:54.009143,
330,Dave Täht,2012-04-21 13:04:54.690022,
333,Dave Täht,2012-04-21 13:04:55.716941,
337,Dave Täht,2012-04-21 13:04:56.92814,
339,Dave Täht,2012-04-21 13:04:57.751583,
343,Dave Täht,2012-04-21 13:04:58.665401,
344,Dave Täht,2012-04-21 13:04:59.367317,
346,Dave Täht,2012-04-21 13:05:01.622096,
348,Dave Täht,2012-04-21 13:05:02.487639,
349,Dave Täht,2012-04-21 13:05:03.159101,
350,Dave Täht,2012-04-21 13:05:04.133315,
351,Dave Täht,2012-04-21 13:05:04.822852,
354,Dave Täht,2012-04-21 13:05:05.762876,
357,Dave Täht,2012-04-21 13:05:06.695719,
358,Dave Täht,2012-04-21 13:05:07.450252,
361,Dave Täht,2012-04-21 13:05:08.480001,
362,Dave Täht,2012-04-21 13:05:09.176372,
363,Dave Täht,2012-04-21 13:05:10.196142,
364,Dave Täht,2012-04-21 13:05:11.154689,
365,Dave Täht,2012-04-21 13:05:11.882513,
368,Dave Täht,2012-04-21 13:05:13.025502,
370,Dave Täht,2012-04-21 13:05:13.724193,
372,Dave Täht,2012-04-21 13:05:14.739123,
373,Dave Täht,2012-04-21 13:05:15.750587,
226,Dave Täht,2012-04-21 13:09:47.894323,
231,Dave Täht,2012-04-21 13:09:50.12386,
232,Dave Täht,2012-04-21 13:09:50.705301,
234,Dave Täht,2012-04-21 13:09:51.556559,
247,Dave Täht,2012-04-21 13:09:54.629692,
316,Dave Täht,2012-04-21 13:09:55.225967,
317,Dave Täht,2012-04-21 13:09:56.079691,
318,Dave Täht,2012-04-21 13:09:57.137209,
348,Dave Täht,2012-04-21 13:10:17.01583,
90,Dave Täht,2012-04-21 13:11:31.159898,
124,Dave Täht,2012-04-21 13:11:31.799095,
229,Dave Täht,2012-04-21 13:11:32.525232,
308,Dave Täht,2012-04-21 13:12:26.325374,""
322,Dave Täht,2012-04-21 13:14:00.422287,"Well, as 3.3 gets rolled out, it's going to happen anyway. It would be good for the openwrt devs to be fully aware of interactions with TSO/GSO"
303,Dave Täht,2012-04-21 13:15:38.96624,"samba 364 is in the current releases.

smbpasswd will crash if you don't have an equivalent user in /etc/passwd, but that's about it. Well, wins needs to be enabled."
290,Dave Täht,2012-04-21 13:16:44.91916,""
274,Dave Täht,2012-04-21 13:17:36.348755,""
274,Dave Täht,2012-04-21 13:18:23.132588,I have wide-dhcp more or less working in the lab
79,Dave Täht,2012-04-22 16:30:24.968737,
80,Dave Täht,2012-04-22 16:30:25.387384,
81,Dave Täht,2012-04-22 16:30:26.105251,
97,Dave Täht,2012-04-22 16:30:26.557893,
102,Dave Täht,2012-04-22 16:30:27.276781,
119,Dave Täht,2012-04-22 16:30:27.801108,
189,Dave Täht,2012-04-22 16:30:28.524645,
371,Dave Täht,2012-04-22 19:04:48.587601,"Can't honestly say if that patch did anything or not. Traps certainly 'seem' a little more infrequent.

Some more detail. 

<pre>
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.367187] $20   : 00000010 82b2486e 82b2489e 80360000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.371093] $24   : 00000000 83246374                  
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.378906] $28   : 802fe000 802ffb70 80360000 801f44d0
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.382812] Hi    : ffd87c98
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.386718] Lo    : 6672f4ca
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.390625] epc   : 83255b08 ipv6_setsockopt+0x148/0x444 [ipv6]
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.394531]     Tainted: G           O
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.398437] ra    : 801f44d0 neigh_lookup+0x78/0x160
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.402343] Status: 1000fc03    KERNEL EXL IE 
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.410156] Cause : 00800010
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.410156] BadVA : 82b248a6
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.414062] PrId  : 00019374 (MIPS 24Kc)
Apr 23 01:55:28 OpenWrt kern.warn kernel: [truncated] [  558.417968] Modules linked in: cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq gpio_buttons ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.562500] Process swapper (pid: 0, threadinfo=802fe000, task=803020c0, tls=00000000)
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.570312] Stack : 802ffc38 802ffb84 fffffff5 8324fd94 00000000 82b24896 83280000 83d44000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.578125]         00000000 83258134 c1b6f568 82ac6400 83d44000 82022f00 c1b6f610 822abd80
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.585937]         8108244c 00000000 00000000 00000000 00000000 00000000 00000000 00000000
root@OpenWrt:/sys/kernel/debug/mips# logread
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.527343] $ 8   : 00000000 8016d6f0 00000002 fea54801
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.535156] $12   : 8030cb8c 8030cc28 0000020b 00000000
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.539062] $16   : 82238d80 832791e0 80416076 83d44000
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.546875] $20   : 00000010 00000001 8041609e 00000001
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.550781] $24   : 00000000 83246374                  
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.554687] $28   : 802fe000 802ffb00 00000000 801f44d0
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.562500] Hi    : 007b3a5f
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.562500] Lo    : d90b3e61
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.566406] epc   : 83255afc ipv6_setsockopt+0x13c/0x444 [ipv6]
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.574218]     Tainted: G           O
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.574218] ra    : 801f44d0 neigh_lookup+0x78/0x160
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.582031] Status: 1000fc03    KERNEL EXL IE 
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.585937] Cause : 00800010
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.589843] BadVA : 80416082
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.589843] PrId  : 00019374 (MIPS 24Kc)
Apr 23 01:54:53 OpenWrt kern.warn kernel: [truncated] [  523.593750] Modules linked in: cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq gpio_buttons ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.738281] Process swapper (pid: 0, threadinfo=802fe000, task=803020c0, tls=00000000)
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.746093] Stack : 00000010 8009543c 83c190a0 80092430 83d32200 8041606e 83d44000 80416076
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.753906]         82b75900 8325722c 82ba4000 8324fbec 83d44000 82a9acb0 0000000a 82a9a148
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.765625]         802ffc74 802ffc84 00000000 804160ae 00000000 00000000 00000000 00000000
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.773437]         00000000 00000000 804160b0 82acb088 80416096 00000087 82b14cc0 83d32200
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.781250]         80360000 83d44000 8327a6b4 30000000 80360000 83257f9c c1b6f568 82ac6400
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.789062]         ...
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.792968] Call Trace:
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.792968] [<83255afc>] ipv6_setsockopt+0x13c/0x444 [ipv6]
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.800781] [<8324fbec>] ip6_ins_rt+0x2a0/0x454 [ipv6]
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.804687] 
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.808593] 
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.808593] Code: 00e50018  8cc50008  70620000 <8c82000c> 8cc3000c  70620000  8c820008  00001812  70a22002 
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.816406] Cpu 0
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.820312] $ 0   : 00000000 00000000 fea54801 79a6336b
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.824218] $ 4   : 80416076 95d345d9 82238d88 fe800003
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.832031] $ 8   : 00000000 8016d6f0 00000002 fea54801
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.835937] $12   : 8030cb8c 8030cc28 0000020b 00000000
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.839843] $16   : 82238d80 832791e0 80416076 83d44000
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.847656] $20   : 00000010 00000001 8041609e 00000001
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.851562] $24   : 00000000 83246374                  
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.855468] $28   : 802fe000 802ffb00 00000000 801f44d0
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.863281] Hi    : ffd6784f
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.863281] Lo    : 5f1e89cc
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.867187] epc   : 83255b08 ipv6_setsockopt+0x148/0x444 [ipv6]
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.875000]     Tainted: G           O
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.878906] ra    : 801f44d0 neigh_lookup+0x78/0x160
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.882812] Status: 1000fc03    KERNEL EXL IE 
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.886718] Cause : 00800010
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.890625] BadVA : 8041607e
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.890625] PrId  : 00019374 (MIPS 24Kc)
Apr 23 01:54:53 OpenWrt kern.warn kernel: [truncated] [  523.894531] Modules linked in: cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq gpio_buttons ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.039062] Process swapper (pid: 0, threadinfo=802fe000, task=803020c0, tls=00000000)
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.046875] Stack : 00000010 8009543c 83c190a0 80092430 83d32200 8041606e 83d44000 80416076
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.058593]         82b75900 8325722c 82ba4000 8324fbec 83d44000 82a9acb0 0000000a 82a9a148
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.066406]         802ffc74 802ffc84 00000000 804160ae 00000000 00000000 00000000 00000000
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.074218]         00000000 00000000 804160b0 82acb088 80416096 00000087 82b14cc0 83d32200
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.082031]         80360000 83d44000 8327a6b4 30000000 80360000 83257f9c c1b6f568 82ac6400
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.089843]         ...
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.093750] Call Trace:
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.093750] [<83255b08>] ipv6_setsockopt+0x148/0x444 [ipv6]
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.101562] [<8324fbec>] ip6_ins_rt+0x2a0/0x454 [ipv6]
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.105468] 
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.109375] 
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.109375] Code: 8c82000c  8cc3000c  70620000 <8c820008> 00001812  70a22002  03e00008  00831021  8ca20048 
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.453125] Cpu 0
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.453125] $ 0   : 00000000 00000000 83255ad8 00000300
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.457031] $ 4   : 82b2489e 83d44000 82238d88 00000001
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.464843] $ 8   : 00000020 8016d6f0 00000002 fea9867b
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.468750] $12   : 7fb6b668 7fb6b6b8 00000002 00000000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.472656] $16   : 82238d80 832791e0 82b2489e 83d44000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.480468] $20   : 00000010 82b2486e 82b2489e 80360000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.484375] $24   : 00000000 83246374                  
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.492187] $28   : 802fe000 802ffb70 80360000 801f44d0
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.496093] Hi    : 00050cb2
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.500000] Lo    : de9a6fa4
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.500000] epc   : 83255ad8 ipv6_setsockopt+0x118/0x444 [ipv6]
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.507812]     Tainted: G           O
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.511718] ra    : 801f44d0 neigh_lookup+0x78/0x160
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.515625] Status: 1000fc03    KERNEL EXL IE 
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.519531] Cause : 00800010
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.523437] BadVA : 82b2489e
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.527343] PrId  : 00019374 (MIPS 24Kc)
Apr 23 01:55:28 OpenWrt kern.warn kernel: [truncated] [  557.531250] Modules linked in: cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq gpio_buttons ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.675781] Process swapper (pid: 0, threadinfo=802fe000, task=803020c0, tls=00000000)
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.683593] Stack : 802ffc38 802ffb84 fffffff5 8324fd94 00000000 82b24896 83280000 83d44000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.691406]         00000000 83258134 c1b6f568 82ac6400 83d44000 82022f00 c1b6f610 822abd80
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.699218]         8108244c 00000000 00000000 00000000 00000000 00000000 00000000 00000000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.707031]         00000000 83d44000 8327a6b4 30000000 822abd80 00000088 82b24896 83d32200
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.714843]         80360000 83d44000 8327a6b4 30000000 80360000 8325fa84 802ffc90 802ffc90
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.722656]         ...
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.726562] Call Trace:
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.730468] [<83255ad8>] ipv6_setsockopt+0x118/0x444 [ipv6]
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.734375] 
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.738281] 
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.738281] Code: 8c59002c  03200008  00000000 <8c870000> 8ca50080  8c820004  8cc30004  00e53826  8cc50000 
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.746093] Cpu 0
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.750000] $ 0   : 00000000 00000000 83255ad8 00000300
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.753906] $ 4   : 82b2489e 00000003 82238d88 fe800000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.761718] $ 8   : 00000020 8016d6f0 00000002 fea9867b
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.765625] $12   : 7fb6b668 7fb6b6b8 00000002 00000000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.769531] $16   : 82238d80 832791e0 82b2489e 83d44000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.777343] $20   : 00000010 82b2486e 82b2489e 80360000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.781250] $24   : 00000000 83246374                  
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.785156] $28   : 802fe000 802ffb70 80360000 801f44d0
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.792968] Hi    : 00050cb2
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.792968] Lo    : de9a6fa4
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.796875] epc   : 83255ae0 ipv6_setsockopt+0x120/0x444 [ipv6]
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.804687]     Tainted: G           O
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.808593] ra    : 801f44d0 neigh_lookup+0x78/0x160
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.812500] Status: 1000fc03    KERNEL EXL IE 
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.816406] Cause : 00800010
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.820312] BadVA : 82b248a2
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.820312] PrId  : 00019374 (MIPS 24Kc)
Apr 23 01:55:28 OpenWrt kern.warn kernel: [truncated] [  557.824218] Modules linked in: cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq gpio_buttons ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.968750] Process swapper (pid: 0, threadinfo=802fe000, task=803020c0, tls=00000000)
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.976562] Stack : 802ffc38 802ffb84 fffffff5 8324fd94 00000000 82b24896 83280000 83d44000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.988281]         00000000 83258134 c1b6f568 82ac6400 83d44000 82022f00 c1b6f610 822abd80
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.996093]         8108244c 00000000 00000000 00000000 00000000 00000000 00000000 00000000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.003906]         00000000 83d44000 8327a6b4 30000000 822abd80 00000088 82b24896 83d32200
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.011718]         80360000 83d44000 8327a6b4 30000000 80360000 8325fa84 802ffc90 802ffc90
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.019531]         ...
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.023437] Call Trace:
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.023437] [<83255ae0>] ipv6_setsockopt+0x120/0x444 [ipv6]
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.281250]         00000000 83258134 c1b6f568 82ac6400 83d44000 82022f00 c1b6f610 822abd80
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.289062]         8108244c 00000000 00000000 00000000 00000000 00000000 00000000 00000000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.300781]         00000000 83d44000 8327a6b4 30000000 822abd80 00000088 82b24896 83d32200
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.308593]         80360000 83d44000 8327a6b4 30000000 80360000 8325fa84 802ffc90 802ffc90
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.316406]         ...
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.320312] Call Trace:
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.320312] [<83255afc>] ipv6_setsockopt+0x13c/0x444 [ipv6]
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.328125] 
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.328125] 
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.328125] Code: 00e50018  8cc50008  70620000 <8c82000c> 8cc3000c  70620000  8c820008  00001812  70a22002 
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.339843] Cpu 0
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.339843] $ 0   : 00000000 00000000 fea9867b 79a6336b
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.347656] $ 4   : 82b2489e 95d345d9 82238d88 fe800003
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.351562] $ 8   : 00000020 8016d6f0 00000002 fea9867b
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.355468] $12   : 7fb6b668 7fb6b6b8 00000002 00000000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.363281] $16   : 82238d80 832791e0 82b2489e 83d44000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.367187] $20   : 00000010 82b2486e 82b2489e 80360000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.371093] $24   : 00000000 83246374                  
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.378906] $28   : 802fe000 802ffb70 80360000 801f44d0
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.382812] Hi    : ffd87c98
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.386718] Lo    : 6672f4ca
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.390625] epc   : 83255b08 ipv6_setsockopt+0x148/0x444 [ipv6]
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.394531]     Tainted: G           O
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.398437] ra    : 801f44d0 neigh_lookup+0x78/0x160
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.402343] Status: 1000fc03    KERNEL EXL IE 
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.410156] Cause : 00800010
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.410156] BadVA : 82b248a6
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.414062] PrId  : 00019374 (MIPS 24Kc)
Apr 23 01:55:28 OpenWrt kern.warn kernel: [truncated] [  558.417968] Modules linked in: cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq gpio_buttons ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.562500] Process swapper (pid: 0, threadinfo=802fe000, task=803020c0, tls=00000000)
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.570312] Stack : 802ffc38 802ffb84 fffffff5 8324fd94 00000000 82b24896 83280000 83d44000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.578125]         00000000 83258134 c1b6f568 82ac6400 83d44000 82022f00 c1b6f610 822abd80
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.585937]         8108244c 00000000 00000000 00000000 00000000 00000000 00000000 00000000
root@OpenWrt:/sys/kernel/debug/mips# logread
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.835937] $12   : 8030cb8c 8030cc28 0000020b 00000000
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.839843] $16   : 82238d80 832791e0 80416076 83d44000
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.847656] $20   : 00000010 00000001 8041609e 00000001
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.851562] $24   : 00000000 83246374                  
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.855468] $28   : 802fe000 802ffb00 00000000 801f44d0
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.863281] Hi    : ffd6784f
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.863281] Lo    : 5f1e89cc
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.867187] epc   : 83255b08 ipv6_setsockopt+0x148/0x444 [ipv6]
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.875000]     Tainted: G           O
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.878906] ra    : 801f44d0 neigh_lookup+0x78/0x160
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.882812] Status: 1000fc03    KERNEL EXL IE 
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.886718] Cause : 00800010
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.890625] BadVA : 8041607e
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  523.890625] PrId  : 00019374 (MIPS 24Kc)
Apr 23 01:54:53 OpenWrt kern.warn kernel: [truncated] [  523.894531] Modules linked in: cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq gpio_buttons ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.039062] Process swapper (pid: 0, threadinfo=802fe000, task=803020c0, tls=00000000)
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.046875] Stack : 00000010 8009543c 83c190a0 80092430 83d32200 8041606e 83d44000 80416076
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.058593]         82b75900 8325722c 82ba4000 8324fbec 83d44000 82a9acb0 0000000a 82a9a148
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.066406]         802ffc74 802ffc84 00000000 804160ae 00000000 00000000 00000000 00000000
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.074218]         00000000 00000000 804160b0 82acb088 80416096 00000087 82b14cc0 83d32200
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.082031]         80360000 83d44000 8327a6b4 30000000 80360000 83257f9c c1b6f568 82ac6400
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.089843]         ...
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.093750] Call Trace:
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.093750] [<83255b08>] ipv6_setsockopt+0x148/0x444 [ipv6]
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.101562] [<8324fbec>] ip6_ins_rt+0x2a0/0x454 [ipv6]
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.105468] 
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.109375] 
Apr 23 01:54:53 OpenWrt kern.warn kernel: [  524.109375] Code: 8c82000c  8cc3000c  70620000 <8c820008> 00001812  70a22002  03e00008  00831021  8ca20048 
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.453125] Cpu 0
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.453125] $ 0   : 00000000 00000000 83255ad8 00000300
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.457031] $ 4   : 82b2489e 83d44000 82238d88 00000001
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.464843] $ 8   : 00000020 8016d6f0 00000002 fea9867b
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.468750] $12   : 7fb6b668 7fb6b6b8 00000002 00000000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.472656] $16   : 82238d80 832791e0 82b2489e 83d44000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.480468] $20   : 00000010 82b2486e 82b2489e 80360000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.484375] $24   : 00000000 83246374                  
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.492187] $28   : 802fe000 802ffb70 80360000 801f44d0
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.496093] Hi    : 00050cb2
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.500000] Lo    : de9a6fa4
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.500000] epc   : 83255ad8 ipv6_setsockopt+0x118/0x444 [ipv6]
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.507812]     Tainted: G           O
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.511718] ra    : 801f44d0 neigh_lookup+0x78/0x160
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.515625] Status: 1000fc03    KERNEL EXL IE 
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.519531] Cause : 00800010
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.523437] BadVA : 82b2489e
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.527343] PrId  : 00019374 (MIPS 24Kc)
Apr 23 01:55:28 OpenWrt kern.warn kernel: [truncated] [  557.531250] Modules linked in: cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq gpio_buttons ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.675781] Process swapper (pid: 0, threadinfo=802fe000, task=803020c0, tls=00000000)
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.683593] Stack : 802ffc38 802ffb84 fffffff5 8324fd94 00000000 82b24896 83280000 83d44000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.691406]         00000000 83258134 c1b6f568 82ac6400 83d44000 82022f00 c1b6f610 822abd80
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.699218]         8108244c 00000000 00000000 00000000 00000000 00000000 00000000 00000000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.707031]         00000000 83d44000 8327a6b4 30000000 822abd80 00000088 82b24896 83d32200
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.714843]         80360000 83d44000 8327a6b4 30000000 80360000 8325fa84 802ffc90 802ffc90
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.722656]         ...
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.726562] Call Trace:
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.730468] [<83255ad8>] ipv6_setsockopt+0x118/0x444 [ipv6]
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.734375] 
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.738281] 
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.738281] Code: 8c59002c  03200008  00000000 <8c870000> 8ca50080  8c820004  8cc30004  00e53826  8cc50000 
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.746093] Cpu 0
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.750000] $ 0   : 00000000 00000000 83255ad8 00000300
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.753906] $ 4   : 82b2489e 00000003 82238d88 fe800000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.761718] $ 8   : 00000020 8016d6f0 00000002 fea9867b
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.765625] $12   : 7fb6b668 7fb6b6b8 00000002 00000000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.769531] $16   : 82238d80 832791e0 82b2489e 83d44000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.777343] $20   : 00000010 82b2486e 82b2489e 80360000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.781250] $24   : 00000000 83246374                  
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.785156] $28   : 802fe000 802ffb70 80360000 801f44d0
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.792968] Hi    : 00050cb2
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.792968] Lo    : de9a6fa4
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.796875] epc   : 83255ae0 ipv6_setsockopt+0x120/0x444 [ipv6]
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.804687]     Tainted: G           O
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.808593] ra    : 801f44d0 neigh_lookup+0x78/0x160
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.812500] Status: 1000fc03    KERNEL EXL IE 
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.816406] Cause : 00800010
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.820312] BadVA : 82b248a2
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.820312] PrId  : 00019374 (MIPS 24Kc)
Apr 23 01:55:28 OpenWrt kern.warn kernel: [truncated] [  557.824218] Modules linked in: cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq gpio_buttons ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.968750] Process swapper (pid: 0, threadinfo=802fe000, task=803020c0, tls=00000000)
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.976562] Stack : 802ffc38 802ffb84 fffffff5 8324fd94 00000000 82b24896 83280000 83d44000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.988281]         00000000 83258134 c1b6f568 82ac6400 83d44000 82022f00 c1b6f610 822abd80
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  557.996093]         8108244c 00000000 00000000 00000000 00000000 00000000 00000000 00000000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.003906]         00000000 83d44000 8327a6b4 30000000 822abd80 00000088 82b24896 83d32200
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.011718]         80360000 83d44000 8327a6b4 30000000 80360000 8325fa84 802ffc90 802ffc90
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.019531]         ...
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.023437] Call Trace:
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.023437] [<83255ae0>] ipv6_setsockopt+0x120/0x444 [ipv6]
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.281250]         00000000 83258134 c1b6f568 82ac6400 83d44000 82022f00 c1b6f610 822abd80
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.289062]         8108244c 00000000 00000000 00000000 00000000 00000000 00000000 00000000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.300781]         00000000 83d44000 8327a6b4 30000000 822abd80 00000088 82b24896 83d32200
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.308593]         80360000 83d44000 8327a6b4 30000000 80360000 8325fa84 802ffc90 802ffc90
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.316406]         ...
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.320312] Call Trace:
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.320312] [<83255afc>] ipv6_setsockopt+0x13c/0x444 [ipv6]
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.328125] 
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.328125] 
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.328125] Code: 00e50018  8cc50008  70620000 <8c82000c> 8cc3000c  70620000  8c820008  00001812  70a22002 
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.339843] Cpu 0
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.339843] $ 0   : 00000000 00000000 fea9867b 79a6336b
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.347656] $ 4   : 82b2489e 95d345d9 82238d88 fe800003
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.351562] $ 8   : 00000020 8016d6f0 00000002 fea9867b
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.355468] $12   : 7fb6b668 7fb6b6b8 00000002 00000000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.363281] $16   : 82238d80 832791e0 82b2489e 83d44000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.367187] $20   : 00000010 82b2486e 82b2489e 80360000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.371093] $24   : 00000000 83246374                  
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.378906] $28   : 802fe000 802ffb70 80360000 801f44d0
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.382812] Hi    : ffd87c98
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.386718] Lo    : 6672f4ca
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.390625] epc   : 83255b08 ipv6_setsockopt+0x148/0x444 [ipv6]
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.394531]     Tainted: G           O
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.398437] ra    : 801f44d0 neigh_lookup+0x78/0x160
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.402343] Status: 1000fc03    KERNEL EXL IE 
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.410156] Cause : 00800010
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.410156] BadVA : 82b248a6
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.414062] PrId  : 00019374 (MIPS 24Kc)
Apr 23 01:55:28 OpenWrt kern.warn kernel: [truncated] [  558.417968] Modules linked in: cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq gpio_buttons ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.562500] Process swapper (pid: 0, threadinfo=802fe000, task=803020c0, tls=00000000)
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.570312] Stack : 802ffc38 802ffb84 fffffff5 8324fd94 00000000 82b24896 83280000 83d44000
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.578125]         00000000 83258134 c1b6f568 82ac6400 83d44000 82022f00 c1b6f610 822abd80
Apr 23 01:55:28 OpenWrt kern.warn kernel: [  558.585937]         8108244c 00000000 00000000 00000000 00000000 00000000 00000000 00000000
Apr 23 01:55:34 OpenWrt kern.info kernel: [truncated] ah ip6table_raw ip6_queue ip6table_mangle ip6table_filter ip6_tables nf_conntrack_ipv6 nf_defrag_ipv6 nf_nat_irc nf_conntrack_irc nf_nat_ftp nf_conntrack_ftp xt_policy xt_esp ipt_ah xt_HL xt_hl xt_ecn ipt_ECN xt_CLAS
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.582031] Process swapper (pid: 0, threadinfo=802fe000, task=803020c0, tls=00000000)
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.589843] Stack : 00000010 8009543c 82b56140 80092430 83d32200 8227a86e 83d44000 8227a876
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.597656]         82b75900 8325722c 82ba4000 8324fbec 83d44000 82a9acb0 0000000a 82a9a148
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.609375]         802ffc74 802ffc84 00000000 8227a8ae 00000000 00000000 00000000 00000000
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.617187]         00000000 00000000 8227a8b0 82acb088 8227a896 00000087 832cc240 83d32200
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.625000]         80360000 83d44000 8327a6b4 30000000 80360000 83257f9c c1b6f568 82ac6400
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.632812]         ...
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.636718] Call Trace:
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.636718] [<83255b08>] ipv6_setsockopt+0x148/0x444 [ipv6]
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.644531] [<8324fbec>] ip6_ins_rt+0x2a0/0x454 [ipv6]
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.699218] $28   : 802fe000 802ffb00 00000000 801f44d0
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.707031] Hi    : 00128594
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.707031] Lo    : 05ca59bc
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.710937] epc   : 83255ad8 ipv6_setsockopt+0x118/0x444 [ipv6]
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.718750]     Tainted: G           O
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.722656] ra    : 801f44d0 neigh_lookup+0x78/0x160
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.726562] Status: 1000fc03    KERNEL EXL IE 
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.730468] Cause : 00800010
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.734375] BadVA : 8041b876
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.738281] PrId  : 00019374 (MIPS 24Kc)
Apr 23 01:55:34 OpenWrt kern.warn kernel: [truncated] [  563.742187] Modules linked in: cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq gpio_buttons ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.886718] Process swapper (pid: 0, threadinfo=802fe000, task=803020c0, tls=00000000)
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.894531] Stack : 802ffb58 83259ee8 83c79100 802ffb98 83d32200 8041b86e 83d44000 8041b876
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.902343]         82b75900 8325722c 82ba4000 8324fbec 83d44000 82a9acb0 0000000a 82a9a148
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.910156]         802ffc74 802ffc84 00000000 8041b8ae 00000000 00000000 00000000 00000000
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.917968]         00000000 00000000 8041b8b0 82acb088 8041b896 00000087 82b14c00 83d32200
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.925781]         80360000 83d44000 8327a6b4 30000000 80360000 83257f9c c1b6f568 82ac6400
Apr 23 01:55:34 OpenWrt kern.warn kernel: [  563.933593]         ...
root@OpenWrt:/sys/kernel/debug/mips# logread -f
Apr 23 01:56:00 OpenWrt kern.info kernel: 0
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.148437] BadVA : 82b2b07e
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.152343] PrId  : 00019374 (MIPS 24Kc)
Apr 23 01:56:00 OpenWrt kern.warn kernel: [truncated] [  589.156250] Modules linked in: cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq gpio_buttons ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.300781] Process swapper (pid: 0, threadinfo=802fe000, task=803020c0, tls=00000000)
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.308593] Stack : 83d12140 80092c34 00000000 00000001 82b2b076 83280000 82b08540 83d32200
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.316406]         00000000 83258790 c1b6f568 82ac6400 83d44000 82022f00 00000000 83d12140
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.324218]         80092c64 82b2b0b6 82b2b0a6 00000000 82b2b0b6 00000000 82b2b0ae 00000000
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.332031]         00000000 83d44000 8327a6b4 30000000 82b08540 00000086 82b2b096 83d32200
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.339843]         80360000 83d44000 8327a6b4 30000000 80360000 8325fa84 000000c3 83180a80
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.347656]         ...
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.351562] Call Trace:
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.355468] [<83255b08>] ipv6_setsockopt+0x148/0x444 [ipv6]
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.359375] 
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.359375] 
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.359375] Code: 8c82000c  8cc3000c  70620000 <8c820008> 00001812  70a22002  03e00008  00831021  8ca20048 
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.421875] epc   : 83255ad8 ipv6_setsockopt+0x118/0x444 [ipv6]
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.429687]     Tainted: G           O
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.433593] ra    : 801f4fd0 neigh_create+0x430/0x558
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.437500] Status: 1000fc03    KERNEL EXL IE 
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.441406] Cause : 00800010
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.445312] BadVA : 82b2b076
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.445312] PrId  : 00019374 (MIPS 24Kc)
Apr 23 01:56:00 OpenWrt kern.warn kernel: [truncated] [  589.449218] Modules linked in: cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq gpio_buttons ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.593750] Process swapper (pid: 0, threadinfo=802fe000, task=803020c0, tls=00000000)
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.601562] Stack : 1000fc03 ffd6784f 5f1e89cc 82b2b07e 00000010 801f4594 82b2b076 83280000
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.613281]         82b08540 83d32200 00000000 00000000 83d44000 30000000 80360000 832587a8
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.621093]         c1b6f568 82b2b076 83d44000 82022f00 00000000 83d12140 80092c64 82b2b0b6
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.628906]         82b2b0a6 00000000 82b2b0b6 00000000 82b2b0ae 00000000 00000000 83d44000
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.636718]         8327a6b4 30000000 82b08540 00000086 82b2b096 83d32200 80360000 83d44000
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.644531]         ...
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.648437] Call Trace:
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.648437] [<83255ad8>] ipv6_setsockopt+0x118/0x444 [ipv6]
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.656250] 
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.656250] 
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.656250] Code: 8c59002c  03200008  00000000 <8c870000> 8ca50080  8c820004  8cc30004  00e53826  8cc50000 
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.667968] Cpu 0
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.671875] $ 0   : 00000000 00000000 83255ad8 00000011
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.675781] $ 4   : 82b2b076 00000003 82238d88 fe800000
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.679687] $ 8   : fe800000 00000000 0211bcff fea54801
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.687500] $12   : 8d000009 8030cc28 0000024c 00000000
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.691406] $16   : 828be200 832791e0 82238d80 832792cc
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.695312] $20   : 83d44000 00000000 83d44000 00000010
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.703125] $24   : 00000000 80095334                  
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.707031] $28   : 802fe000 802ffb28 0001215f 801f4fd0
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.710937] Hi    : ffd6784f
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.714843] Lo    : 5f1e89cc
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.718750] epc   : 83255ae0 ipv6_setsockopt+0x120/0x444 [ipv6]
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.722656]     Tainted: G           O
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.726562] ra    : 801f4fd0 neigh_create+0x430/0x558
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.734375] Status: 1000fc03    KERNEL EXL IE 
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  589.738281] Cause : 00800010
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.000000] $24   : 00000000 80095334                  
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.003906] $28   : 802fe000 802ffb28 0001215f 801f4fd0
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.007812] Hi    : 007b3a5f
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.011718] Lo    : d90b3e61
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.015625] epc   : 83255afc ipv6_setsockopt+0x13c/0x444 [ipv6]
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.019531]     Tainted: G           O
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.023437] ra    : 801f4fd0 neigh_create+0x430/0x558
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.027343] Status: 1000fc03    KERNEL EXL IE 
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.035156] Cause : 00800010
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.035156] BadVA : 82b2b082
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.039062] PrId  : 00019374 (MIPS 24Kc)
Apr 23 01:56:00 OpenWrt kern.warn kernel: [truncated] [  590.042968] Modules linked in: cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq gpio_buttons ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.187500] Process swapper (pid: 0, threadinfo=802fe000, task=803020c0, tls=00000000)
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.195312] Stack : 1000fc03 ffd6784f 5f1e89cc 82b2b07e 00000010 801f4594 82b2b076 83280000
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.203125]         82b08540 83d32200 00000000 00000000 83d44000 30000000 80360000 832587a8
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.210937]         c1b6f568 82b2b076 83d44000 82022f00 00000000 83d12140 80092c64 82b2b0b6
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.218750]         82b2b0a6 00000000 82b2b0b6 00000000 82b2b0ae 00000000 00000000 83d44000
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.230468]         8327a6b4 30000000 82b08540 00000086 82b2b096 83d32200 80360000 83d44000
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.238281]         ...
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.238281] Call Trace:
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.242187] [<83255afc>] ipv6_setsockopt+0x13c/0x444 [ipv6]
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.246093] 
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.250000] 
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.250000] Code: 00e50018  8cc50008  70620000 <8c82000c> 8cc3000c  70620000  8c820008  00001812  70a22002 
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.261718] Cpu 0
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.261718] $ 0   : 00000000 00000000 fea54801 79a6336b
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.269531] $ 4   : 82b2b076 95d345d9 82238d88 fe800003
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.273437] $ 8   : fe800000 00000000 0211bcff fea54801
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.277343] $12   : 8d000009 8030cc28 0000024c 00000000
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.285156] $16   : 828be200 832791e0 82238d80 832792cc
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.289062] $20   : 83d44000 00000000 83d44000 00000010
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.292968] $24   : 00000000 80095334                  
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.300781] $28   : 802fe000 802ffb28 0001215f 801f4fd0
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.304687] Hi    : ffd6784f
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.308593] Lo    : 5f1e89cc
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.308593] epc   : 83255b08 ipv6_setsockopt+0x148/0x444 [ipv6]
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.316406]     Tainted: G           O
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.320312] ra    : 801f4fd0 neigh_create+0x430/0x558
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.324218] Status: 1000fc03    KERNEL EXL IE 
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.328125] Cause : 00800010
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.332031] BadVA : 82b2b07e
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.335937] PrId  : 00019374 (MIPS 24Kc)
Apr 23 01:56:00 OpenWrt kern.warn kernel: [truncated] [  590.339843] Modules linked in: cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq gpio_buttons ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.484375] Process swapper (pid: 0, threadinfo=802fe000, task=803020c0, tls=00000000)
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.492187] Stack : 1000fc03 ffd6784f 5f1e89cc 82b2b07e 00000010 801f4594 82b2b076 83280000
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.500000]         82b08540 83d32200 00000000 00000000 83d44000 30000000 80360000 832587a8
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.507812]         c1b6f568 82b2b076 83d44000 82022f00 00000000 83d12140 80092c64 82b2b0b6
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.515625]         82b2b0a6 00000000 82b2b0b6 00000000 82b2b0ae 00000000 00000000 83d44000
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.523437]         8327a6b4 30000000 82b08540 00000086 82b2b096 83d32200 80360000 83d44000
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.535156]         ...
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.535156] Call Trace:
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.539062] [<83255b08>] ipv6_setsockopt+0x148/0x444 [ipv6]
Apr 23 01:56:00 OpenWrt kern.warn kernel: [  590.542968] 
Apr 23 01:56:38 OpenWrt kern.warn kernel: [  627.453125] Cp
</pre>"
362,Maciej Soltysiak,2012-04-23 03:16:02.817298,"Dave Täht wrote:
> Please send me cero-specific conf files? and tell me which package sets to use? Openwrt? the other guys?

Hi, sorry for no update. I was travelling. I will redo from scratch with latest cero build and document the packages and configs.

Maciej"
371,Robert Bradley,2012-04-23 07:41:24.213106,"I think that last patch did virtually nothing based on the stack traces.  I noticed though that the return address is somewhere in neigh_lookup, and so I think the next thing to try is altering __ipv6_neigh_lookup.  It looks promising, since if the primary key were taken straight from a packet somewhere, that would definitely cause problems.  The only problem is that I can't see where it would get called, or why ipv6_setsockopt would get involved."
371,Stephen Walker,2012-04-27 11:11:13.169492,"Robert Bradley wrote:
> I think that last patch did virtually nothing based on the stack traces.  I noticed though that the return address is somewhere in neigh_lookup, and so I think the next thing to try is altering __ipv6_neigh_lookup.  It looks promising, since if the primary key were taken straight from a packet somewhere, that would definitely cause problems.  The only problem is that I can't see where it would get called, or why ipv6_setsockopt would get involved.

ipv6_neigh_lookup.patch worksforme

@root@Onyx:~# cat /sys/kernel/debug/mips/unaligned_action
2
root@Onyx:~# cat /sys/kernel/debug/mips/unaligned_instructions
0@

(My local build does have a change to pack include/linux/icmp.h's icmphdr to not trap upon pinging the router)"
362,Maciej Soltysiak,2012-04-27 12:13:54.553883,"Here's how I did it on latest cero:

<pre>
# opkg install http://enduser.subsignal.org/~trondah/latest-release-is-r31219/packages/minissdpd_1.0-1_ar71xx.ipk
# apply the following on /etc/config/minissdpd
--- minissdpd.old
+++ minissdpd
@@ -1,4 +1,4 @@
 config 'minissdpd' 'config'
        option 'enabled' '1'
        option 'log_output' '0'
-       option 'internal_iface' 'lan'
+       option 'internal_iface' 'se00 sw00 sw10'


# /etc/init.d/minissdpd enable
# /etc/init.d/minissdpd start

#opkg install http://enduser.subsignal.org/~trondah/latest-release-is-r31219/packages/miniupnpd_1.6.20120121-1_ar71xx.ipk
#opkg install http://enduser.subsignal.org/~trondah/latest-release-is-r31219/packages/luci-app-upnp_trunk+svn8531-1_ar71xx.ipk

# apply the following /etc/config/upnpd
--- upnpd.old
+++ upnpd
@@ -6,8 +6,8 @@
        option log_output '0'
        option download '1024'
        option upload '512'
-       option external_iface 'wan'
-       option internal_iface 'lan'
+       option external_iface 'ge00'
+       option internal_iface 'se00 sw00 sw10'
        option port '5000'
        option uuid '61809265-e55e-43dd-92d1-8b1cc9c0dd5c'

# /etc/init.d/miniupnpd enable
# /etc/init.d/miniupnpd start


</pre>
AFAIK: download '1024' is just for information, so no need to tweak.
Tested with uTorrent Setup Guide, where it uses UPNP or NAT-PMP to open ports.
Also, it seemed to take a few minutes to start working. After a reboot it seemed to work.

Regards,
Maciej
"
371,Dave Täht,2012-04-27 21:04:50.458451,"thx guys. you made my evening. (I'm still logging out tho)

stephen, I thought we'd covered that header in the current patchset already?

how does this puppy 'feel' now? I noticed as soon as we got below 10k traps/sec that things like ssh to the router became much smoother under load...."
372,funny rajj,2012-04-28 08:44:19.150401,"i am thankful for the vi queue test ""hilarious quotes"":http://itshumour.blogspot.com/2009/09/top-10-hilarious-quotes.html"
371,Stephen Walker,2012-04-28 11:20:59.341506,"Dave Täht wrote:
> stephen, I thought we'd covered that header in the current patchset already?

http://patchwork.openwrt.org/patch/2117/ only touches ICMPv6 & the existing ""902-unaligned_access_hacks.patch"":https://dev.openwrt.org/browser/trunk/target/linux/ar71xx/patches-3.3/902-unaligned_access_hacks.patch didn't touch ICMP at all.

> how does this puppy 'feel' now? I noticed as soon as we got below 10k traps/sec that things like ssh to the router became much smoother under load....

I can't say that I can feel any difference but I am not frequently logged in.

"
362,Stephen Walker,2012-04-28 11:24:56.283828,Add https://dev.openwrt.org/ticket/8988 along with the appropriate config changes?
362,Maciej Soltysiak,2012-04-28 12:27:13.383407,"Stephen Walker wrote:
> Add https://dev.openwrt.org/ticket/8988 along with the appropriate config changes?

Yes, trondah's minissdpd, miniupnpd with config changes are what we need.

I also found one thing here. DLNA does not work on cero between a wireless and a wired peers because FORWARD chain needs to let UDP 1900 through for SSDP multicasts and in the case of PS3 media server also TCP 5001. Anyway, FORWARD chain is a bit restrictive."
253,Dave Täht,2012-04-29 17:46:47.820378,""
376,Dave Täht,2012-04-29 21:08:23.596615,"---------- Forwarded message ----------
From: Neal Cardwell <ncardwell@google.com>
Date: Sun, Apr 29, 2012 at 8:49 PM
Subject: Re: [PATCH] tcp: fix infinite cwnd in tcp_complete_cwr()
To: Yuchung Cheng <ycheng@google.com>
Cc: davem@davemloft.net, ilpo.jarvinen@helsinki.fi,
nanditad@google.com, netdev@vger.kernel.org

On Sat, Apr 28, 2012 at 3:04 PM, Yuchung Cheng <ycheng@google.com> wrote:

    When the cwnd reduction is done, ssthresh may be infinite if TCP enters CWR via ECN or F-RTO. If cwnd is not undone, i.e., undo_marker is set, tcp_complete_cwr() falsely set cwnd to the infinite ssthresh value. The correct operation is to keep cwnd intact because it has been updated in ECN or F-RTO.
    Signed-off-by: Yuchung Cheng <ycheng@google.com>  net/ipv4/tcp_input.c |    8 +++---  1 files changed, 5 insertions(+), 3 deletions(-)

    diff --git a/net/ipv4/tcp_input.c b/net/ipv4/tcp_input.c index c93b0cb..ac417de 100644 --- a/net/ipv4/tcp_input.c +++ b/net/ipv4/tcp_input.c @ -2868,11 +2868,13 @ static inline void tcp_complete_cwr(struct sock *sk)

           /* Do not moderate cwnd if it's already undone in cwr or recovery. */        if (tp->undo_marker) { -               if (inet_csk(sk)->icsk_ca_state TCP_CA_CWR) +               if (inet_csk(sk)->icsk_ca_state TCP_CA_CWR) {                        tp->snd_cwnd = min(tp->snd_cwnd, tp->snd_ssthresh);

In this TCP_CA_CWR case the patch needs to add the assignment:

    tp->snd_cwnd_stamp = tcp_time_stamp;

I know that was in earlier versions of your patch; looks like it just
got accidentally dropped on this latest version.

Otherwise, looks good to me."
379,Dave Täht,2012-04-30 02:49:22.443804,"Please note: I'm HAPPY to have ethernet working so well. Now that the traps are gone it should be possible to do decent analysis with oprofile, and see what, if anything, can be sped up.

I expected trouble with wireless, but didn't have any until today... because I was doing the engineer thing and testing wireless by itself (driving it at 90+Mbit), and ethernet by itself, not both together. Sigh. 

I can't quite rule out iptables, and I should probably also test ipv6 under this scenario"
379,Dave Täht,2012-04-30 02:54:49.268148,"another nice thing is tcp_rr performance is astoundingly good, 823 transactions per second, even with 8 streams beating up the box."
371,Dave Täht,2012-04-30 03:03:21.828018,"I have the combination of these patches up and running. I've seen as few as zero traps and as many as 1/sec... which is still quite nice. I only saw one router doing that, so I think it's something with multicast, but didn't look into it further.

However, see #379 . Behind every solution there's another problem. At one level, I'm not too worried about it, it's hard to drive the wireless radios hard enough to incur the issues, and similarly ethernet is on a switch for local devices..."
376,David Taht,2012-04-30 09:45:30.896455,"final patch

---------- Forwarded message ----------
From: Yuchung Cheng <ycheng@google.com>
Date: Mon, Apr 30, 2012 at 9:00 AM
Subject: [PATCH v2] tcp: fix infinite cwnd in tcp_complete_cwr()
To: davem@davemloft.net, ilpo.jarvinen@helsinki.fi, ncardwell@google.com
Cc: nanditad@google.com, netdev@vger.kernel.org, Yuchung Cheng
<ycheng@google.com>


When the cwnd reduction is done, ssthresh may be infinite
if TCP enters CWR via ECN or F-RTO. If cwnd is not undone, i.e.,
undo_marker is set, tcp_complete_cwr() falsely set cwnd to the
infinite ssthresh value. The correct operation is to keep cwnd
intact because it has been updated in ECN or F-RTO.

Signed-off-by: Yuchung Cheng <ycheng@google.com>
---
ChangeLog since v1:
 - Add snd_cwnd_stamp timestamping in CWR mode

 net/ipv4/tcp_input.c |    9 ++++++---
 1 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/net/ipv4/tcp_input.c b/net/ipv4/tcp_input.c
index c93b0cb..e0a9b89 100644
--- a/net/ipv4/tcp_input.c
+++ b/net/ipv4/tcp_input.c
@@ -2868,11 +2868,14 @@ static inline void tcp_complete_cwr(struct sock *sk)

       /* Do not moderate cwnd if it's already undone in cwr or recovery. */
       if (tp->undo_marker) {
-               if (inet_csk(sk)->icsk_ca_state == TCP_CA_CWR)
+               if (inet_csk(sk)->icsk_ca_state == TCP_CA_CWR) {
                       tp->snd_cwnd = min(tp->snd_cwnd, tp->snd_ssthresh);
-               else /* PRR */
+                       tp->snd_cwnd_stamp = tcp_time_stamp;
+               } else if (tp->snd_ssthresh < TCP_INFINITE_SSTHRESH) {
+                       /* PRR algorithm. */
                       tp->snd_cwnd = tp->snd_ssthresh;
-               tp->snd_cwnd_stamp = tcp_time_stamp;
+                       tp->snd_cwnd_stamp = tcp_time_stamp;
+               }
       }
       tcp_ca_event(sk, CA_EVENT_COMPLETE_CWR);
 }"
379,Robert Bradley,2012-05-01 07:08:40.372147,"If you're thinking this is iptables and unaligned-access related, I did manage to find a couple of unaligned accesses in the nat (not relevant for wired->wireless?) and connection-tracking code for TCP.  Is it possible to just rmmod the relevant modules and test without iptables or AQM tracking the connections?  That would save time instead of running yet another kernel build with educated guesses at patches."
379,Dave Täht,2012-05-01 09:01:47.927374,"We're back at the point where we can either oprofile (my preferred method), or just run tests and watch the unaligned traps happen or not. 1/sec is dealable...

As for this problem and patches, there is patch review on the openwrt list going on...

See thread:

http://www.mail-archive.com/openwrt-devel@lists.openwrt.org/msg13520.html

"
379,Dave Täht,2012-05-01 09:07:38.968912,"oh, and to answer your question more directly, I think we have a new problem here in that it's not been possible to totally saturate this beast on interrupts before now...

"
379,Robert Bradley,2012-05-01 10:05:07.4229,"Yes, the real question was, ""How related is this to #360 and #371?""  Apart from those two hiding it, I'm not sure we can say it *is* related.

If it's interrupt-related, I'm going to guess that the lack of napi_poll support in the ath9k driver doesn't help.  (The Ethernet driver has it, so you should be able to route LAN->WAN with no problems.)"
379,David Taht,2012-05-01 10:06:27.696198,"Felix:

Can napi even work on wireless devices?

On Tue, May 1, 2012 at 10:05 AM,  <cerowrt@lists.bufferbloat.net> wrote:
>
> Issue #379 has been updated by Robert Bradley.
>
>
> Yes, the real question was, ""How related is this to #360 and #371?""  Apart from those two hiding it, I'm not sure we can say it *is* related.
>
> If it's interrupt-related, I'm going to guess that the lack of napi_poll support in the ath9k driver doesn't help.  (The Ethernet driver has it, so you should be able to route LAN->WAN with no problems.)
> ----------------------------------------
> Bug #379: 3.3.4-3 router crashes under heavy load
> https://www.bufferbloat.net/issues/379
>
> Author: David Taht
> Status: New
> Priority: Normal
> Assignee: Dave Täht
> Category: Linux Kernel
> Target version: 1st Public Cerowrt release
>
>
> So I started doing long duration, heavy access tests, driving things
> with my fastest three boxes,
> crypted and unencrypted wireless, and two machines driving through the
> internal ethernet at
> gigE speeds.
>
> after about 200 sec of heavy load, the router resets. Also in the
> general case it becomes hard to get a connection to the webserver for
> (example) streaming audio, and ssh won't start due to the loadavg
> (have to fix that in xinetd), and dns starts acting up and babeld
> stops transmitting routes
>
> Now, this is truly abnormal use - 250+Mbits going through the router
> full time rather than 20Mbit or so.
>
> So far this is ipv4 only. I was mostly testing ipv6 and fairly short
> (60 second) durations and mostly
> ethernet before now.
>
> Things tried:
>
> 0) reducing the watchdog time to reset to 1 second rather than 5. This
> seemed to help somewhat, but I'm going to rule it out.
>
> 1) turning off the qdiscs. This was mildly amusing as I was perturbed
> by seeing ping times go from .2sec to 20 or 30ms on GigE with
> pfifo_fast. It's been a long time since these puppies were configured
> as drop tail systems.
>
> Anyway, still crashes. So I think we can regard the aqm system as
> solid. Finally.
>
> I do want to turn hoq-sfq off for further tests, tho.
>
> 3) bumping up BQL. Performance improves slightly, still crashes.
>
> 4) Not using the wireless at all. So far it's survived 2000 seconds of
> abuse, pounding 250+Mbit of ipv4 through it,
> from 5 streams from two boxes.
>
> So things point at some interaction with wireless.
>
> theories are:
>
> hostapd can't get enough cpu time to run
> the rngd daemon can't get enough cpu time to run
> we have a memory leak somewhere in the wireless stack
>
> For the longest time I've had this thing running at HZ_256. Anyway I'm
> going to leave ethernet loaded up overnight, then try wireless all by
> itself for a few hours.
>
> I have other fish to fry right now.
>
>"
379,Robert Bradley,2012-05-01 11:13:15.771555,"The ""ieee80211_ops"":http://lxr.free-electrons.com/source/include/net/mac80211.h#L2112 struct seems to think it can.  I haven't found a driver that uses it yet - rtl8180 had it (http://www.spinics.net/lists/linux-wireless/msg53741.html) but that got reverted (http://git.itanic.dy.fi/?p=linux-stable;a=patch;h=a6d27d2ac89359f84c1a559b5530967ff671d269)."
379,David Taht,2012-05-01 11:51:08.003701,"Hey john, I was wondering why napi was so hard on wireless?

On Tue, May 1, 2012 at 11:13 AM,  <cerowrt@lists.bufferbloat.net> wrote:
>
> Issue #379 has been updated by Robert Bradley.
>
>
> The ""ieee80211_ops"":http://lxr.free-electrons.com/source/include/net/mac80211.h#L2112 struct seems to think it can.  I haven't found a driver that uses it yet - rtl8180 had it (http://www.spinics.net/lists/linux-wireless/msg53741.html) but that got reverted (http://git.itanic.dy.fi/?p=linux-stable;a=patch;h=a6d27d2ac89359f84c1a559b5530967ff671d269).
> ----------------------------------------
> Bug #379: 3.3.4-3 router crashes under heavy load
> https://www.bufferbloat.net/issues/379
>
> Author: David Taht
> Status: New
> Priority: Normal
> Assignee: Dave Täht
> Category: Linux Kernel
> Target version: 1st Public Cerowrt release
>
>
> So I started doing long duration, heavy access tests, driving things
> with my fastest three boxes,
> crypted and unencrypted wireless, and two machines driving through the
> internal ethernet at
> gigE speeds.
>
> after about 200 sec of heavy load, the router resets. Also in the
> general case it becomes hard to get a connection to the webserver for
> (example) streaming audio, and ssh won't start due to the loadavg
> (have to fix that in xinetd), and dns starts acting up and babeld
> stops transmitting routes
>
> Now, this is truly abnormal use - 250+Mbits going through the router
> full time rather than 20Mbit or so.
>
> So far this is ipv4 only. I was mostly testing ipv6 and fairly short
> (60 second) durations and mostly
> ethernet before now.
>
> Things tried:
>
> 0) reducing the watchdog time to reset to 1 second rather than 5. This
> seemed to help somewhat, but I'm going to rule it out.
>
> 1) turning off the qdiscs. This was mildly amusing as I was perturbed
> by seeing ping times go from .2sec to 20 or 30ms on GigE with
> pfifo_fast. It's been a long time since these puppies were configured
> as drop tail systems.
>
> Anyway, still crashes. So I think we can regard the aqm system as
> solid. Finally.
>
> I do want to turn hoq-sfq off for further tests, tho.
>
> 3) bumping up BQL. Performance improves slightly, still crashes.
>
> 4) Not using the wireless at all. So far it's survived 2000 seconds of
> abuse, pounding 250+Mbit of ipv4 through it,
> from 5 streams from two boxes.
>
> So things point at some interaction with wireless.
>
> theories are:
>
> hostapd can't get enough cpu time to run
> the rngd daemon can't get enough cpu time to run
> we have a memory leak somewhere in the wireless stack
>
> For the longest time I've had this thing running at HZ_256. Anyway I'm
> going to leave ethernet loaded up overnight, then try wireless all by
> itself for a few hours.
>
> I have other fish to fry right now.
>
>"
379,Felix Fietkau,2012-05-01 13:23:08.274792,"On 2012-05-01 7:06 PM, Dave Taht wrote:
> Felix:
> 
> Can napi even work on wireless devices?
It can, mac80211 has support for it, but it's not implemented in the
driver yet.

- Felix"
382,Dave Täht,2012-05-01 15:34:00.789912,"ntpdc is just plain busted in this build (and probably for a long time past)

root@test334-3:/etc/init.d# ntpdc -n -p | grep -v ""^=="" | egrep '^=|^\*' | awk '
{ print $3 }' 
127.0.0.1: timed out, nothing received
***Request timed out
"
381,Dave Täht,2012-05-01 15:36:18.730921,"This is after a day or so of extensive bandwidth testing.

"
385,Dave Täht,2012-05-09 18:49:47.537087,"This is under heavy load. On the plus side, overall delays stay at about 5ms.

The ntp restart problem is a different bug.

And I only end up with 24 traps after a few minutes

root@codel:/sys/kernel/debug/mips# May 10 01:45:52 codel daemon.err ntpd[4128]: i/o error on routing socket No buffer space available - disabling
May 10 01:45:52 codel kern.warn kernel: [  860.550781] Cpu 0
May 10 01:45:52 codel kern.warn kernel: [  860.554687] $ 0   : 00000000 00000000 00000000 00000000
May 10 01:45:52 codel kern.warn kernel: [  860.558593] $ 4   : 00502478 7fec7870 00000001 00000000
May 10 01:45:52 codel kern.warn kernel: [  860.566406] $ 8   : 000007ff 001a0041 83b68480 00000001
May 10 01:45:52 codel kern.warn kernel: [  860.570312] $12   : 00000019 00190041 00000001 00480000
May 10 01:45:52 codel kern.warn kernel: [  860.574218] $16   : 72670001 00480000 00000001 00000002
May 10 01:45:52 codel kern.warn kernel: [  860.582031] $20   : 00000001 004878d4 00487954 00480000
May 10 01:45:52 codel kern.warn kernel: [  860.585937] $24   : 004840ec 76f2c100                  
May 10 01:45:52 codel kern.warn kernel: [  860.593750] $28   : 76f48030 7fec7850 00480000 0040f478
May 10 01:45:52 codel kern.warn kernel: [  860.597656] Hi    : 00000000
May 10 01:45:52 codel kern.warn kernel: [  860.601562] Lo    : 00000001
May 10 01:45:52 codel kern.warn kernel: [  860.605468] epc   : 0040f444 0x40f444
May 10 01:45:52 codel kern.warn kernel: [  860.609375]     Tainted: G           O
May 10 01:45:52 codel kern.warn kernel: [  860.613281] ra    : 0040f478 0x40f478
May 10 01:45:52 codel kern.warn kernel: [  860.617187] Status: 0000fc13    USER EXL IE 
May 10 01:45:52 codel kern.warn kernel: [  860.621093] Cause : 00800010
May 10 01:45:52 codel kern.warn kernel: [  860.625000] BadVA : 72670005
May 10 01:45:52 codel kern.warn kernel: [  860.625000] PrId  : 00019374 (MIPS 24Kc)
May 10 01:45:52 codel kern.warn kernel: [truncated] [  860.628906] Modules linked in: sch_codel cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah ip
May 10 01:45:52 codel kern.warn kernel: [  860.781250] Process ntpd (pid: 4128, threadinfo=82b42000, task=83f05d18, tls=77171750)
May 10 01:45:52 codel kern.warn kernel: [  860.789062] Stack : 20f1f3b0 76f05cfc 76f1f3b0 0000000b 7fec788c 7fec792d 00000000 76ee1668
May 10 01:45:52 codel kern.warn kernel: [  860.796875]         00000001 770bbc50 00487954 770e717c 00000010 d3559c50 41eb9350 00000000
May 10 01:45:52 codel kern.warn kernel: [  860.804687]         00000000 00000000 00000400 00000000 00000000 00000000 00000000 00000000
May 10 01:45:52 codel kern.warn kernel: [  860.816406]         00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
May 10 01:45:52 codel kern.warn kernel: [  860.824218]         00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
May 10 01:45:52 codel kern.warn kernel: [  860.832031]         ...
May 10 01:45:52 codel kern.warn kernel: [  860.835937] Call Trace:
May 10 01:45:52 codel kern.warn kernel: [  860.835937] [<80138521>] jffs2_do_read_inode_internal+0xb69/0x1654
May 10 01:45:52 codel kern.warn kernel: [  860.843750] 
May 10 01:45:52 codel kern.warn kernel: [  860.843750] 
May 10 01:45:52 codel kern.warn kernel: [  860.843750] Code: 8e100000  12000012  3c110048 <8e020004> 8fa504b0  00021942  00031880  00a31821  8c630024 
May 10 01:45:56 codel daemon.info named[3820]: success resolving 'ns1.lab.bufferbloat.net/AAAA' (in 'lab.bufferbloat.net'?) after reducing the advertised EDNS UDP packet size to 512 octets
May 10 01:45:56 codel daemon.info named[3820]: success resolving 'ns1.lab.bufferbloat.net/A' (in 'lab.bufferbloat.net'?) after reducing the advertised EDNS UDP packet size to 512 octets
"
385,Dave Täht,2012-05-09 18:53:01.664308,"<pre>
  ecn_mark 0 drop_overlimit 0 states 2407396 : 234189 95 170
root@codel:/sys/kernel/debug/mips# tc -s qdisc show dev se00
qdisc codel 8002: root refcnt 2 limit 1000p target 5.0ms interval 100.0ms 
 Sent 3881154957 bytes 5110579 pkt (dropped 271, overlimits 0 requeues 112483) 
 backlog 206172b 138p requeues 112483 
  maxpacket 1494 count 3 lastcount 2 ldelay 7.0ms
  ecn_mark 0 drop_overlimit 0 states 2433428 : 240043 97 174
root@codel:/sys/kernel/debug/mips# tc -s qdisc show dev se00
qdisc codel 8002: root refcnt 2 limit 1000p target 5.0ms interval 100.0ms 
 Sent 3917649177 bytes 5135009 pkt (dropped 278, overlimits 0 requeues 113623) 
 backlog 178Kb 122p requeues 113623 
  maxpacket 1494 count 2 lastcount 1 ldelay 6.8ms
  ecn_mark 0 drop_overlimit 0 states 2457852 : 245960 98 180
root@codel:/sys/kernel/debug/mips# tc -s qdisc show dev se00
qdisc codel 8002: root refcnt 2 limit 1000p target 5.0ms interval 100.0ms 
 Sent 3959334937 bytes 5162913 pkt (dropped 287, overlimits 0 requeues 115022) 
 backlog 177786b 120p requeues 115022 
  maxpacket 1494 count 3 lastcount 1 ldelay 6.4ms
  ecn_mark 0 drop_overlimit 0 states 2485756 : 252529 100 187
root@codel:/sys/kernel/debug/mips# tc -s qdisc show dev se00
May 10 01:52:13 codel kern.warn kernel: [ 1231.812500] Cpu 0
May 10 01:52:13 codel kern.warn kernel: [ 1231.816406] $ 0   : 00000000 00000001 00000000 00000000
May 10 01:52:13 codel kern.warn kernel: [ 1231.820312] $ 4   : 00000000 00000500 00000000 00f45d2c
May 10 01:52:13 codel kern.warn kernel: [ 1231.824218] $ 8   : 00000000 00000000 00000000 00000000
May 10 01:52:13 codel kern.warn kernel: [ 1231.832031] $12   : 00060000 00000bac 00000000 00000000
May 10 01:52:13 codel kern.warn kernel: [ 1231.835937] $16   : 00000028 81f01b40 8332e600 000004d8
May 10 01:52:13 codel kern.warn kernel: [ 1231.839843] $20   : 833ef896 0000003b 833ef86e 82a20000
May 10 01:52:13 codel kern.warn kernel: [ 1231.847656] $24   : 00000000 831c318c                  
May 10 01:52:13 codel kern.warn kernel: [ 1231.851562] $28   : 8326e000 8326f838 00000001 82a262bc
May 10 01:52:13 codel kern.warn kernel: [truncated] [ 1231.855468] Hi    : 000e0029eader ip6t_frag ip6t_eui64 ip6t_ah ip6table_raw ip6_queue ip6table_mangle ip6table_filter ip6_tables nf_conntrack_ipv6 nf_defrag_ipv6 nf_nat_irc nf_conntrack_irc nf_nat_ftp nf_conntrack
May 10 01:52:13 codel kern.warn kernel: [ 1232.945312] Process named (pid: 3820, threadinfo=8326e000, task=82bd8000, tls=77ce2440)
May 10 01:52:13 codel kern.warn kernel: [ 1232.953125] Stack : 00000000 831c5a5c 00000001 8020cc14 8332e300 81f01b40 00000000 83d44000
May 10 01:52:13 codel kern.warn kernel: [ 1232.964843]         00000000 8326f7f0 8332e300 83ec3600 831f5ad0 0000002c fffffffe 00000006
May 10 01:52:13 codel kern.warn kernel: [ 1232.972656]         831fa6f4 30000000 80360000 831c5cb8 83d44000 00000000 fffffe71 831c63c0
May 10 01:52:13 codel kern.warn kernel: [ 1232.980468]         8332e300 81f01b40 803013fc 831c5a10 00000000 00000000 83d44000 00000000
May 10 01:52:13 codel kern.warn kernel: [ 1232.988281]         fffffe71 82a26bc8 1b5f435e 00000001 833ed076 833ed086 00000000 831c5a10
May 10 01:52:13 codel kern.warn kernel: [ 1232.996093]         ...
May 10 01:52:13 codel kern.warn kernel: [ 1233.000000] Call Trace:
May 10 01:52:13 codel kern.warn kernel: [ 1233.000000] [<831e5880>] ip6_frag_init+0x270/0xe38 [ipv6]
May 10 01:52:13 codel kern.warn kernel: [ 1233.007812] 
May 10 01:52:13 codel kern.warn kernel: [ 1233.007812] 
May 10 01:52:13 codel kern.warn kernel: [ 1233.007812] Code: ac640088  ac62008c  26f0b194 <8e640004> 8e070100  26250008  26260018  afa40010  afa50018 
May 10 01:52:13 codel kern.warn kernel: [ 1233.164062] Cpu 0
May 10 01:52:13 codel kern.warn kernel: [ 1233.167968] $ 0   : 00000000 00000001 00000000 00000000
May 10 01:52:13 codel kern.warn kernel: [ 1233.171875] $ 4   : 00000000 00000500 00000000 00f47783
May 10 01:52:13 codel kern.warn kernel: [ 1233.175781] $ 8   : 00000000 00000000 00000000 00000000
May 10 01:52:13 codel kern.warn kernel: [ 1233.183593] $12   : 00060000 a4000027 a4000042 00000000
May 10 01:52:13 codel kern.warn kernel: [ 1233.187500] $16   : 00000028 82aa9180 831409c0 000004d8
May 10 01:52:13 codel kern.warn kernel: [ 1233.191406] $20   : 82a83096 0000003b 82a8306e 82a20000
May 10 01:52:13 codel kern.warn kernel: [ 1233.199218] $24   : 00000000 831c318c                  
May 10 01:52:13 codel kern.warn kernel: [ 1233.203125] $28   : 82bbc000 82bbdca8 00000001 82a262bc
May 10 01:52:13 codel kern.warn kernel: [ 1233.207031] Hi    : 000cf4e8
May 10 01:52:13 codel kern.warn kernel: [ 1233.210937] Lo    : 91a09954
May 10 01:52:13 codel kern.warn kernel: [ 1233.214843] epc   : 82a2632c nf_ct_frag6_gather+0x180/0x948 [nf_defrag_ipv6]
May 10 01:52:13 codel kern.warn kernel: [ 1233.222656]     Tainted: G           O
May 10 01:52:13 codel kern.warn kernel: [ 1233.226562] ra    : 82a262bc nf_ct_frag6_gather+0x110/0x948 [nf_defrag_ipv6]
May 10 01:52:13 codel kern.warn kernel: [ 1233.230468] Status: 1000fc03    KERNEL EXL IE 
May 10 01:52:13 codel kern.warn kernel: [ 1233.234375] Cause : 00800010
May 10 01:52:13 codel kern.warn kernel: [ 1233.238281] BadVA : 82a8309a
May 10 01:52:13 codel kern.warn kernel: [ 1233.242187] PrId  : 00019374 (MIPS 24Kc)
May 10 01:52:13 codel kern.warn kernel: [truncated] [ 1233.246093] Modules linked in: sch_codel cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah ip
May 10 01:52:13 codel kern.warn kernel: [ 1233.390625] Process hostapd (pid: 2166, threadinfo=82bbc000, task=82bd9d18, tls=772ee440)
May 10 01:52:13 codel kern.warn kernel: [ 1233.398437] Stack : 0a00c800 831f3878 83f85f80 00000000 06000001 83f852b0 82bbdd48 82bbdd48
May 10 01:52:13 codel kern.warn kernel: [ 1233.406250]         00000006 83d44000 8030141c 00000004 00000000 831409c0 83d44000 00000000
May 10 01:52:13 codel kern.warn kernel: [ 1233.414062]         00000000 83d44000 00000001 00000004 00000000 82a2607c 80350000 8009766c
May 10 01:52:14 codel kern.warn kernel: [ 1233.421875]         00000004 00000000 0000000a 8030141c 00000000 82bbdd90 82a26ee0 831409c0
May 10 01:52:14 codel kern.warn kernel: [ 1233.429687]         803013fc 8020cb24 83c3f000 83d34100 00000000 80300000 831c5a10 80300b38
May 10 01:52:14 codel kern.warn kernel: [ 1233.441406]         ...
May 10 01:52:14 codel kern.warn kernel: [ 1233.441406] Call Trace:
May 10 01:52:14 codel kern.warn kernel: [ 1233.445312] [<82a2632c>] nf_ct_frag6_gather+0x180/0x948 [nf_defrag_ipv6]
May 10 01:52:14 codel kern.warn kernel: [ 1233.453125] [<82a2607c>] nf_defrag_ipv6_enable+0x7c/0x1ac [nf_defrag_ipv6]
May 10 01:52:14 codel kern.warn kernel: [ 1233.457031] 
May 10 01:52:14 codel kern.warn kernel: [ 1233.460937] 
May 10 01:52:14 codel kern.warn kernel: [ 1233.460937] Code: ae340090  0ca89834  00000000 <8e930004> afbe0014  3c1e82a2  26d50008  27d0712c  26d60018 
May 10 01:52:14 codel kern.warn kernel: [ 1233.472656] Cpu 0
May 10 01:52:14 codel kern.warn kernel: [ 1233.472656] $ 0   : 00000000 00000001 00000000 00000948
May 10 01:52:14 codel kern.warn kernel: [ 1233.480468] $ 4   : 00000000 0000019c 00000000 00f47784
May 10 01:52:14 codel kern.warn kernel: [ 1233.484375] $ 8   : 00000000 00000000 00000000 00000000
May 10 01:52:14 codel kern.warn kernel: [ 1233.488281] $12   : 00060000 a4000027 a4000042 00000000
May 10 01:52:14 codel kern.warn kernel: [ 1233.496093] $16   : 00000028 82aa9900 83140e40 00000174
qdisc codel 8002: root refcnt 2 limit 1000p target 5.0ms interval 100.0ms 
 Sent 4001191037 bytes 5190931 pkt (dropped 293, overlimits 0 requeues 116341) 
 backlog 219618b 147p requeues 116341 
  maxpacket 1494 count 1 lastcount 1 ldelay 7.3ms
  ecn_mark 0 drop_overlimit 0 states 2513767 : 256573 102 191
root@codel:/sys/kernel/debug/mips# May 10 01:52:14 codel kern.warn kernel: [ 1233.500000] $20   : 82a80896 0000003b 82a8086e 82a20000
May 10 01:52:14 codel kern.warn kernel: [ 1233.503906] $24   : 00000000 831c318c                  
May 10 01:52:14 codel kern.warn kernel: [ 1233.511718] $28   : 82bbc000 82bbdca8 00000001 82a262bc
May 10 01:52:14 codel kern.warn kernel: [ 1233.515625] Hi    : 0008287b
May 10 01:52:14 codel kern.warn kernel: [ 1233.519531] Lo    : 66dd43c4
May 10 01:52:14 codel kern.warn kernel: [ 1233.519531] epc   : 82a2632c nf_ct_frag6_gather+0x180/0x948 [nf_defrag_ipv6]
May 10 01:52:14 codel kern.warn kernel: [ 1233.527343]     Tainted: G           O
May 10 01:52:14 codel kern.warn kernel: [ 1233.531250] ra    : 82a262bc nf_ct_frag6_gather+0x110/0x948 [nf_defrag_ipv6]
May 10 01:52:14 codel kern.warn kernel: [ 1233.539062] Status: 1000fc03    KERNEL EXL IE 
May 10 01:52:14 codel kern.warn kernel: [ 1233.542968] Cause : 00800010
May 10 01:52:14 codel kern.warn kernel: [ 1233.546875] BadVA : 82a8089a
May 10 01:52:14 codel kern.warn kernel: [ 1233.550781] PrId  : 00019374 (MIPS 24Kc)
May 10 01:52:14 codel kern.warn kernel: [truncated] [ 1233.554687] Modules linked in: sch_codel cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah ip
May 10 01:52:14 codel kern.warn kernel: [ 1233.695312] Process hostapd (pid: 2166, threadinfo=82bbc000, task=82bd9d18, tls=772ee440)
May 10 01:52:14 codel kern.warn kernel: [ 1233.707031] Stack : 0a00c800 831f3878 83f85f80 00000000 a79a55ba 00000001 82a83076 82a83086
May 10 01:52:14 codel kern.warn kernel: [ 1233.714843]         00000006 83d44000 8030141c 00000004 00000000 83140e40 83d44000 00000000
May 10 01:52:14 codel kern.warn kernel: [ 1233.722656]         00000000 83d44000 00000001 00000004 00000000 82a2607c 80350000 8009766c
May 10 01:52:14 codel kern.warn kernel: [ 1233.730468]         00000004 00000000 0000000a 8030141c 00000000 82bbdd90 82a26ee0 83140e40
May 10 01:52:14 codel kern.warn kernel: [ 1233.738281]         803013fc 8020cb24 83c3f000 83d34100 00000000 80300000 831c5a10 80300b38
May 10 01:52:14 codel kern.warn kernel: [ 1233.746093]         ...
May 10 01:52:14 codel kern.warn kernel: [ 1233.750000] Call Trace:
May 10 01:52:14 codel kern.warn kernel: [ 1233.753906] [<82a2632c>] nf_ct_frag6_gather+0x180/0x948 [nf_defrag_ipv6]
May 10 01:52:14 codel kern.warn kernel: [ 1233.757812] [<82a2607c>] nf_defrag_ipv6_enable+0x7c/0x1ac [nf_defrag_ipv6]
May 10 01:52:14 codel kern.warn kernel: [ 1233.765625] 
May 10 01:52:14 codel kern.warn kernel: [ 1233.765625] 
May 10 01:52:14 codel kern.warn kernel: [ 1233.765625] Code: ae340090  0ca89834  00000000 <8e930004> afbe0014  3c1e82a2  26d50008  27d0712c  26d60018 
May 10 01:52:14 codel kern.warn kernel: [ 1233.777343] Cpu 0
May 10 01:52:14 codel kern.warn kernel: [ 1233.781250] $ 0   : 00000000 00000001 00000000 00000000
May 10 01:52:14 codel kern.warn kernel: [ 1233.785156] $ 4   : 00000000 000004d8 00000000 00000000
May 10 01:52:14 codel kern.warn kernel: [ 1233.792968] $ 8   : 00000000 00000000 00000000 00000030
May 10 01:52:14 codel kern.warn kernel: [ 1233.796875] $12   : 00000000 00000000 00000000 00000000
May 10 01:52:14 codel kern.warn kernel: [ 1233.800781] $16   : 831fb194 82a8306e 831409c0 82a83096
May 10 01:52:14 codel kern.warn kernel: [ 1233.808593] $20   : 80360000 80360000 831fa6f4 83200000
May 10 01:52:14 codel kern.warn kernel: [ 1233.812500] $24   : 00000000 831c6374                  
May 10 01:52:14 codel kern.warn kernel: [ 1233.816406] $28   : 82bbc000 82bbdc30 80360000 831c5cb8
May 10 01:52:14 codel kern.warn kernel: [ 1233.824218] Hi    : 00000000
May 10 01:52:14 codel kern.warn kernel: [ 1233.824218] Lo    : 00000001
May 10 01:52:14 codel kern.warn kernel: [ 1233.828125] epc   : 831e5880 ip6_frag_init+0x270/0xe38 [ipv6]
May 10 01:52:14 codel kern.warn kernel: [ 1233.835937]     Tainted: G           O
May 10 01:52:15 codel kern.warn kernel: [ 1233.839843] ra    : 831c5cb8 ip6_rcv_finish+0x2a8/0x4a8 [ipv6]
May 10 01:52:15 codel kern.warn kernel: [ 1233.843750] Status: 1000fc03    KERNEL EXL IE 
May 10 01:52:15 codel kern.warn kernel: [ 1233.847656] Cause : 00800010
May 10 01:52:15 codel kern.warn kernel: [ 1233.851562] BadVA : 82a8309a
May 10 01:52:15 codel kern.warn kernel: [ 1233.855468] PrId  : 00019374 (MIPS 24Kc)
May 10 01:52:15 codel kern.warn kernel: [truncated] [ 1233.859375] Modules linked in: sch_codel cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah ip
May 10 01:52:15 codel kern.warn kernel: [ 1234.003906] Process hostapd (pid: 2166, threadinfo=82bbc000, task=82bd9d18, tls=772ee440)
May 10 01:52:15 codel kern.warn kernel: [ 1234.011718] Stack : 00000000 831c5a5c 00000001 8020cc14 831409c0 82aa9180 00000000 83d44000
May 10 01:52:15 codel kern.warn kernel: [ 1234.019531]         00000000 82bbdc60 831409c0 83ec3600 831f5ad0 0000002c fffffffe 00000006
May 10 01:52:15 codel kern.warn kernel: [ 1234.027343]         831fa6f4 30000000 80360000 831c5cb8 83d44000 00000000 fffffe71 831c63c0
May 10 01:52:15 codel kern.warn kernel: [ 1234.035156]         831409c0 82aa9180 803013fc 831c5a10 00000000 83140e40 83d44000 00000000
May 10 01:52:15 codel kern.warn kernel: [ 1234.042968]         fffffe71 82a26bc8 a79a55ba 00000001 82a80876 82a80886 00000000 831c5a10
May 10 01:52:15 codel kern.warn kernel: [ 1234.050781]         ...
May 10 01:52:15 codel kern.warn kernel: [ 1234.054687] Call Trace:
May 10 01:52:15 codel kern.warn kernel: [ 1234.058593] [<831e5880>] ip6_frag_init+0x270/0xe38 [ipv6]
May 10 01:52:15 codel kern.warn kernel: [ 1234.062500] 
May 10 01:52:15 codel kern.warn kernel: [ 1234.062500] 
May 10 01:52:15 codel kern.warn kernel: [ 1234.062500] Code: ac640088  ac62008c  26f0b194 <8e640004> 8e070100  26250008  26260018  afa40010  afa50018 
May 10 01:52:15 codel kern.warn kernel: [ 1234.074218] Cpu 0
May 10 01:52:15 codel kern.warn kernel: [ 1234.078125] $ 0   : 00000000 00000001 00000000 00000950
May 10 01:52:15 codel kern.warn kernel: [ 1234.082031] $ 4   : 00000000 00000174 00000000 00000000
May 10 01:52:15 codel kern.warn kernel: [ 1234.089843] $ 8   : 00000000 00000000 00000000 00000030
May 10 01:52:15 codel kern.warn kernel: [ 1234.093750] $12   : 00000000 00000000 00000000 00000000
May 10 01:52:15 codel kern.warn kernel: [ 1234.097656] $16   : 831fb194 82a8086e 83140e40 82a80896
May 10 01:52:15 codel kern.warn kernel: [ 1234.105468] $20   : 80360000 80360000 831fa6f4 83200000
May 10 01:52:15 codel kern.warn kernel: [ 1234.109375] $24   : 00000000 831c6374                  
May 10 01:52:15 codel kern.warn kernel: [ 1234.113281] $28   : 82bbc000 82bbdc30 80360000 831c5cb8
May 10 01:52:15 codel kern.warn kernel: [ 1234.121093] Hi    : 00000000
May 10 01:52:15 codel kern.warn kernel: [ 1234.121093] Lo    : 00000001
May 10 01:52:15 codel kern.warn kernel: [ 1234.125000] epc   : 831e5880 ip6_frag_init+0x270/0xe38 [ipv6]
May 10 01:52:15 codel kern.warn kernel: [ 1234.132812]     Tainted: G           O
May 10 01:52:15 codel kern.warn kernel: [ 1234.132812] ra    : 831c5cb8 ip6_rcv_finish+0x2a8/0x4a8 [ipv6]
May 10 01:52:15 codel kern.warn kernel: [ 1234.140625] Status: 1000fc03    KERNEL EXL IE 
May 10 01:52:15 codel kern.warn kernel: [ 1234.144531] Cause : 00800010
May 10 01:52:15 codel kern.warn kernel: [ 1234.148437] BadVA : 82a8089a
May 10 01:52:15 codel kern.warn kernel: [ 1234.152343] PrId  : 00019374 (MIPS 24Kc)
May 10 01:52:15 codel kern.warn kernel: [truncated] [ 1234.156250] Modules linked in: sch_codel cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_qfq ath79_wdt xt_hashlimit ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah ip
May 10 01:52:15 codel kern.warn kernel: [ 1234.296875] Process hostapd (pid: 2166, threadinfo=82bbc000, task=82bd9d18, tls=772ee440)
May 10 01:52:15 codel kern.warn kernel: [ 1234.308593] Stack : 00000000 831c5a5c 00000001 8020cc14 83140e40 82aa9180 00000000 83d44000
May 10 01:52:15 codel kern.warn kernel: [ 1234.316406]         00000000 82bbdc60 83140e40 83ec3600 831f5ad0 0000002c fffffffe 00000006
May 10 01:52:15 codel kern.warn kernel: [ 1234.324218]         831fa6f4 30000000 80360000 831c5cb8 83d44000 00000000 fffffe71 831c63c0
May 10 01:52:15 codel kern.warn kernel: [ 1234.332031]         83140e40 82aa9180 803013fc 831c5a10 00000000 00000000 83d44000 00000000
May 10 01:52:15 codel kern.warn kernel: [ 1234.339843]         fffffe71 82a26bc8 a79a55ba 00000001 82a80876 82a80886 00000000 831c5a10
May 10 01:52:15 codel kern.warn kernel: [ 1234.347656]         ...
May 10 01:52:15 codel kern.warn kernel: [ 1234.351562] Call Trace:
May 10 01:52:15 codel kern.warn kernel: [ 1234.355468] [<831e5880>] ip6_frag_init+0x270/0xe38 [ipv6]
May 10 01:52:15 codel kern.warn kernel: [ 1234.359375] 
May 10 01:52:15 codel kern.warn kernel: [ 1234.359375] 
May 10 01:52:15 codel kern.warn kernel: [ 1234.359375] Code: ac640088  ac62008c  26f0b194 <8e640004> 8e070100  26250008  26260018  afa40010  afa50018 
root@codel:/sys/kernel/debug/mips# May 10 01:52:18 codel daemon.info named[3820]: success resolving 'ns2.isc.ultradns.net/A' (in 'ultradns.net'?) after reducing the advertised EDNS UDP packet size to 512 octets
May 10 01:52:19 codel daemon.info named[3820]: success resolving 'ns1.isc.ultradns.net/A' (in 'ultradns.net'?) after reducing the advertised EDNS UDP packet size to 512 octets
</pre>"
385,Dave Täht,2012-05-09 18:54:18.000583,the neat thing about the previous test is that I was not running wirelessly
385,Dave Täht,2012-05-09 19:00:31.279448,"I thought count couldn't drop below 1.

qdisc mq 1: root 
 Sent 11734 bytes 52 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc codel 10: parent 1:1 ecn limit 1000p target 5.0ms interval 100.0ms 
 Sent 2075 bytes 18 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
  maxpacket 256 count 0 lastcount 0 ldelay 0us
  ecn_mark 0 drop_overlimit 0 states 1 : 0 0 0
qdisc codel 20: parent 1:2 ecn limit 1000p target 5.0ms interval 100.0ms 
 Sent 0 bytes 0 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
  maxpacket 256 count 0 lastcount 0 ldelay 0us
  ecn_mark 0 drop_overlimit 0 states 0 : 0 0 0
qdisc codel 30: parent 1:3 ecn limit 1000p target 5.0ms interval 100.0ms 
 Sent 9659 bytes 34 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
  maxpacket 256 count 0 lastcount 0 ldelay 0us
  ecn_mark 0 drop_overlimit 0 states 11 : 0 0 0
qdisc codel 40: parent 1:4 ecn limit 1000p target 5.0ms interval 100.0ms 
 Sent 0 bytes 0 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
  maxpacket 256 count 0 lastcount 0 ldelay 0us
  ecn_mark 0 drop_overlimit 0 states 0 : 0 0 0
"
379,Dave Täht,2012-05-09 19:17:30.495266,"see #385. When it happens, which is REALLY RARE, it's pretty catastrophic to the streams.

Everything resets.

Easily hit with a hammer on a patch, which I'll do if I get enough energy. Shouldn't do that tho

I also note that I've been unable to crash it with the 3.3.5-3 build + codel, which cheers me up, relatively. I haven't tried sfqred. 
"
386,Dave Täht,2012-05-09 19:31:02.440997,I am obscurely happy.
385,Robert Bradley,2012-05-10 09:11:44.707838,"Well, having looked at @ip6_frag_init@, I'm finding it difficult to see any obvious causes except for:

<pre><code class=""c"">
fq->saddr = *arg->src;
fq->daddr = *arg->dst;
</code></pre>

Yes, that's dereferencing an @in6_addr@ pointer (ultimately obtained from the incoming packet) and assigning the result to an aligned address.  And yes, @in6_addr@ structs were supposed to be marked packed.  You may also need to mark @frag_hdr@ (in @/include/net/ipv6.h@) as packed too, if it isn't already."
385,Robert Bradley,2012-05-10 09:47:06.073029,"This might be a little crazy, but would it be worth trying to stress-test the IPv4 equivalent (ip4_frag_init) too?  ""ping -s 4096 172.30.42.1"" ought to manage it."
385,Robert Bradley,2012-05-10 13:33:27.276036,"I think in that last patch, ""sizeof(in6_addr)"" might need to be ""sizeof(struct in6_addr)"".  My local working copy had these changes uncommitted. :("
386,Robert Bradley,2012-05-10 14:29:11.740095,"I couldn't see anything obvious in sch_qfq.c that would cause this, since neither tc_classify_compat or qfq directly touch the contents of the network packet.  That leaves either @skb_flow_dissect@ or packet classifiers like @cls_u32@ and @cls_flow@.  Am I right in thinking that you're also setting up cls_u32 to classify packets?  If so, this patch may help..."
386,Dave Täht,2012-05-11 01:22:13.507657,"yea, tc_classify was taking me nowhere. and I'm using cls_flow as well as cls_u32. good spot, I hope."
385,Dave Täht,2012-05-11 01:27:36.934406,"had already packed frag_hdr, thought using memcpy was crazy, trying it anyway."
385,Dave Täht,2012-05-11 01:35:09.849256,"also note jffs2 one. that proved hard to find. (no, haven't found it, breaking out heavy artillery for that one)"
385,Dave Täht,2012-05-11 01:41:31.386637,container_of?
385,Robert Bradley,2012-05-11 03:14:24.237606,"I don't think it can be @container_of@, since that is only doing pointer arithmetic, not actually dereferencing anything (from http://lxr.free-electrons.com/source/include/linux/kernel.h#L661):

<pre><code class=""c"">
#define container_of(ptr, type, member) ({                      \
         const typeof( ((type *)0)->member ) *__mptr = (ptr);    \
         (type *)( (char *)__mptr - offsetof(type,member) );})
</code></pre>

In fact, I couldn't see anything in qfq that actually touched the network headers in @skb@, as opposed to kernel-derived fields.  Hence why I'm hoping we can blame cls_u32...

(It could be cls_flow, but again, that's outsourcing everything potentially risky to @skb_flow_dissect@ and reading the aligned @skb@ fields afterwards.  That function got looked at back in bug #360.)"
385,Dave Täht,2012-05-12 17:27:08.292753,"with the current patch set, I never get any traps... until it crashes completely under heavy load. The only thing I can think of is that it's actually a bug or problem in the flash or jffs2 driver(s)"
385,Robert Bradley,2012-05-13 14:32:18.82201,"It sounds like there's a few bugs affecting flash and JFFS2 at the moment.  For example, this locking order bug in jffs2 was recently found and patched:

https://lkml.org/lkml/2012/3/29/528

That was merged into the mainline kernel today, along with a fix for a kernel oops in the dataflash driver:

http://git.kernel.org/?p=linux/kernel/git/torvalds/linux.git;a=commit;h=9ff00d58a915b6747ba2e843ab2d04c712b4dc32

Perhaps that would be worth testing?
"
124,Ketan Kulkarni,2012-05-15 08:56:54.742312,"scamper on cerowrt now works with Path ECN feature.
I have added the patch to ceropackages -

 Branch: refs/heads/master
 Home:   https://github.com/dtaht/ceropackages-3.3
 Commit: d390b14b8ca1e11739ad40f7d07605fb12fcd2f4
     https://github.com/dtaht/ceropackages-3.3/commit/d390b14b8ca1e11739ad40f7d07605fb12fcd2f4
 Author: K <ketkulka@snapon.lab.bufferbloat.net>
 Date:   2012-05-15 (Tue, 15 May 2012)

 Changed paths:
   A net/scamper/patches/002-ecn-detect.patch

 Log Message:
 -----------
 https://www.bufferbloat.net/issues/124
http://ecn.csail.mit.edu
adding the patch to test path ECN - provided by Steve Bauer - MIT
Compiled And basic-tested on cerowrt."
305,Dave Täht,2012-05-16 12:50:49.004624,"I'm not in a position to build kernels for anything but ubuntu and cerowrt at the moment, although fq_codel has landed in operwrt, (doing builds for tons of arches)

The last important patch for fq_codel landed in net-next a few minutes ago.

So if anyone out there is running any other linux derivative that is linux 3.3 based, I'd love it if they could get codel and fq_codel running on it and get a build out there for others to try.

aqm is not just for routers anymore"
305,Jonathan Morton,2012-05-17 17:44:51.80744,"On 16 May, 2012, at 10:50 pm, cerowrt@lists.bufferbloat.net wrote:

> So if anyone out there is running any other linux derivative that is linux 3.3 based, I'd love it if they could get codel and fq_codel running on it and get a build out there for others to try.

Unfortunately I don't think Gentoo counts.  :-)

However, my tests using my Gentoo-flavoured PowerBook firewall are very promising indeed.  With the bandwidth restricted to 4M/1M and several torrents running, ordinary HTTP traffic (including DNS etc.) still got through reliably and smoothly with fq_codel, and less so with plain codel or plain sfq.

With the torrent client set up to restrict the bandwidth of TCP connections explicitly, but let uTP run freely, there was an interesting quirk.  With no AQM/FQ specified, a single HTTP download was able to outcompete dozens of uTP streams and receive a varying but relatively large share of the bandwidth - a clear sign that uTP's efforts to fade into the background are in fact effective.  With fq_codel, the HTTP download received roughly equal bandwidth to one of the faster members of the uTP set.  With plain codel, the results were much less convincing, as the HTTP download often stalled - it's not immediately clear to me why that might be.

Most striking is the behaviour of fq_codel when downloading a typical web page with many constituent files, particularly images.  These files download neatly and smoothly in parallel, just like you would expect them to if you knew nothing about networking.  It's *beautiful*.  SFQ has the same basic effect, but with fq_codel it seems to be more robust.

I have yet to run any successful tests with QFQ.  With the vanilla kernel I got zero traffic as soon as I turned it on.  With net-next I might get better results.

 - Jonathan Morton"
339,Chris Lawrence,2012-05-22 20:48:32.995848,"Here's a patch that seems to fix the bitrot on my Cerowrt build; the main problem appears to have been loading the radvd config data before getting adv_interface.  Ideally the for loop should be converted to use config_list_foreach but this is a start.

I also added a little bit more logging so I could figure out what was going on; that could be removed."
392,Sebastian Moeller,2012-05-24 16:57:13.234272,As requested by Jim here is the babeld.conf of cerowrt 3.3.2-6 and a roughly 250Kb log file of babeld complaining.
390,Robert Bradley,2012-05-30 17:31:23.03388,"This patch (well, the mainline v3.4 kernel) appears to have improved my netbook's (BCM4313) wireless no end, with far fewer random disconnects or minutes of lost packets.  I think there's still more bugs to be fixed in that driver though, unless it's my hardware at fault."
401,Dave Täht,2012-07-08 13:16:58.254121,"Andrew McGregor: You'd be right to call that dubious
12:24 AM Either the limit has to be the minimum amongst all the queues, or it has to be per queue
me: Perhaps I'm still misunderstanding - at MCS4 what is the max aggregate?
1:57 AM Andrew McGregor: I don't know, it's expressed in units of time
1:58 AM It is prescribed by the queue's parameters...
1:59 AM There's a table here: http://wifi-insider.com/wlan/wmm.htm
2:01 AM So, the way you'd implement that is to query the driver for the transmit time for the AMPDU as you're building it up"
401,Dave Täht,2012-07-11 10:05:54.461368,"<nbd> hey dtaht  [20:20]
<nbd> i've been looking into that VI
      queue txop mess some more
<nbd> looks like i found an
      interesting bug (in addition to
      the stuff you already uncovered)
			        [20:21]
<nbd> seems that the configured txop
      limit in the hw is off by a
      factor 32 ;)
<nbd> if i'm reading this stuff
      correctly
<nbd> only affects VI and VO of course
\  [22:00]
<nbd> it would limit the maximum transmission duration for VI to 94 usec and
      VO to 47  [22:02]
<nbd> maybe the hw adds some extra time on top of that
<nbd> my patches seem to work ;)  [22:09]
<nbd> i didn't test pushing traffic to the VI queue
<nbd> but i tested adjusting the BE queue to the same txop limit
<nbd> committed  [22:11]
<nbd> have fun with that, i'm going to get some sleep now  [22:12]
<nbd> i'll submit this stuff to linux-wireless@ tomorrow  [22:13]"
399,Dave Täht,2012-07-12 12:24:34.726708,"hmm. thx. I was wondering what had happened to that.

Fixed in 3.3.8-11."
392,Dave Täht,2012-07-12 12:28:16.847245,"Switching to quagga eliminates this log file, however the core problem with the original daemon remains, and the error it was noting may well, also, remain in the quagga code."
401,Dave Täht,2012-07-12 13:48:09.161545,"Well, I see better behavior in the VI queue, using

[1]   Done                    netperf -l 60 -Y CS0,CS0 -H 172.20.1.1
[2]-  Done                    netperf -l 60 -Y CS5,CS5 -H 172.20.1.1
[3]+  Done                    netperf -l 60 -Y EF,EF -H 172.20.1.1

The BK queue does indeed drop packets according to tc, VO, VI weren't


Before I got that far, this:
<pre>
                            BE         BK        VI        VO

MPDUs Queued:             1308        161      1364     39399
MPDUs Completed:          1308        161      1364     39397
MPDUs XRetried:              0          0         0         2
Aggregates:               2975        962      9326         0
AMPDUs Queued HW:        14134       4331    282818         0
AMPDUs Queued SW:         6773       2314     31996         0
AMPDUs Completed:        19780       6470    313444         0
AMPDUs Retried:          34959       4825     84898         0
AMPDUs XRetried:          1126        175      1370         0
FIFO Underrun:               0          0         0         0
TXOP Exceeded:               0          0         0         0
TXTIMER Expiry:              0          0         0         0
DESC CFG Error:              0          0         0         0
DATA Underrun:               0          0         0         0
DELIM Underrun:              0          0         0         0
TX-Pkts-All:             22214       6806    316178     39399
TX-Bytes-All:          2431000     602745  27746600   3522718
hw-put-tx-buf:               1          1         1         1
hw-tx-start:             53190      10240    390746     39399
hw-tx-proc-desc:         53189      10240    390746     39399
TX-Failed:                   0          0         0         0
txq-memory-address:   8280a1b4   8280a230  8280a138  8280a0bc
axq-qnum:                    2          3         1         0
axq-depth:                   1          0         0         0
axq-ampdu_depth:             1          0         0         0
axq-stopped                  0          0         0         0
tx-in-progress               0          0         0         0
pending-frames               1          0         0         0
txq_headidx:                 0          0         0         0
txq_tailidx:                 0          0         0         0
axq_q empty:                   0          0         0         0
axq_acq empty:                 1          1         1         1
txq_fifo[0] empty:             1          1         1         1
txq_fifo[1] empty:             1          1         1         1
txq_fifo[2] empty:             1          1         1         1
txq_fifo[3] empty:             1          1         1         1
txq_fifo[4] empty:             1          1         1         1
txq_fifo[5] empty:             1          1         1         1
txq_fifo[6] empty:             1          1         1         1
txq_fifo[7] empty:             1          1         1         1
</pre>

However doing stuff in the reverse direction crashes the router.
This could be an out of memory condition or something else with fq_codel or the driver...

Using netperf 2.6 - from my laptop, connected via mesh via ad-hoc mode, at rates around 120Mbit...
<pre>
netperf -l 60 -Y EF,EF -H 172.20.1.1 -t TCP_MAERTS &
netperf -l 60 -Y CS5,CS5 -H 172.20.1.1 -t TCP_MAERTS &
netperf -l 60 -Y CS0,CS0 -H 172.20.1.1 -t TCP_MAERTS &
</pre>

This thoroughly exercises the VO,VI,BE queues (which is not something that happens in real life)


"
402,Dave Täht,2012-07-12 19:53:34.128465,"So to add clarity here (see also #401) when I do non-ack mostly streams I run the box out of memory (can't observe this, not necessarily a valid conclusion) and queue depth, after I went back to pure codel I can still crash...

<pre>
netperf -Y CS5,CS5 -l 60 -H 172.20.1.1 -t TCP_MAERTS &
netperf -Y CS1,CS1 -l 60 -H 172.20.1.1 -t TCP_MAERTS &
#netperf -Y EF,EF -l 60 -H 172.20.1.1 -t TCP_MAERTS &
netperf -Y EF,EF -l 60 -H 172.20.1.1 -t TCP_MAERTS &
#netperf -Y EF,EF -l 60 -H 172.20.1.1 -t TCP_MAERTS &
#netperf -Y EF,EF -l 60 -H 172.20.1.1 -t TCP_MAERTS &
netperf -Y CS0,CS0 -l 60 -H 172.20.1.1 -t TCP_MAERTS &
</pre>

I may well have an interaction with netperf running on the box too.

<pre>
root@testbox:~# tc -s qdisc show dev gw11
qdisc mq 1: root 
 Sent 349384011 bytes 231149 pkt (dropped 491, overlimits 0 requeues 26191) 
 backlog 56210b 40p requeues 26191 
qdisc codel 10: parent 1:1 limit 1000p target 5.0ms interval 100.0ms 
 Sent 344597768 bytes 227688 pkt (dropped 457, overlimits 0 requeues 25833) 
 backlog 7570b 5p requeues 25833 
  count 1 lastcount 1 ldelay 354us drop_next 0us
  maxpacket 1514 ecn_mark 0 drop_overlimit 0
qdisc codel 20: parent 1:2 limit 1000p target 10.0ms interval 100.0ms 
 Sent 4260478 bytes 2827 pkt (dropped 0, overlimits 0 requeues 271) 
 backlog 45420b 30p requeues 271 
  count 0 lastcount 0 ldelay 19.6ms drop_next 0us
  maxpacket 1514 ecn_mark 0 drop_overlimit 0
qdisc codel 30: parent 1:3 limit 1000p target 20.0ms interval 100.0ms 
 Sent 525617 bytes 632 pkt (dropped 34, overlimits 0 requeues 87) 
 backlog 3220b 5p requeues 87 
  count 32 lastcount 23 ldelay 16.7ms drop_next 0us
  maxpacket 1514 ecn_mark 0 drop_overlimit 0
qdisc codel 40: parent 1:4 limit 1000p target 5.0ms interval 100.0ms 
 Sent 148 bytes 2 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
  count 0 lastcount 0 ldelay 0us drop_next 0us
  maxpacket 256 ecn_mark 0 drop_overlimit 0
root@testbox:~# Write failed: Broken pipe
d@ida:~$ ~~~
</pre>
"
402,Dave Täht,2012-07-12 20:03:38.571985,"partially a heisenbug, when I drive this this hard with netserver, that consumes a ton more ram than usual.

Usually I have a test box and not netperf running on the other side of the router.

"
402,Dave Täht,2012-07-12 20:50:30.893517,"At the observed wireless bandwidths with packet limit 1200 I see fq_codel peak at around 700 packets and not enter drop tail.

Figuring out what those bandwidths actually are and the interrelationship between the device queuing, EDCA, and fq_codel is going to be the subject of a long month or three. Or longer."
319,Dave Täht,2012-07-12 21:54:52.082503,"I have evolved to a system where I do a patch on the laptop, copy it up to huchra, review it, make sure it applies, then send it. This is still overly tedious but a heck of a lot better than what I was doing before.

I'd still prefer to do it all on the laptop"
373,Dave Täht,2012-07-12 21:58:12.760067,"as of cerowrt 3.3.8-10 EF ends up in VO, nothing else does.

this triggered bugs #401 and #402 but....

	 0, /* BE = 0x0 */
	 0, /* Max-Reliability = 0x1 */
	 3, /* Max-Throughput = 0x2 */
	 0, /* 0x3 Undefined */
	 5, /* Min-Delay = 0x4 */
	 0, /* 0x5 Undefined */
	 0, /* 0x6 Undefined */
	 0, /* 0x7 Undefined */
	 1, /* CS1 = 0x8 */
	 0, /* 0x9 Undefined */
	 3, /* AF11 = 0xa */
	 0, /* 0xb Undefined */
	 3, /* AF12 = 0xc */
	 0, /* 0xd Undefined */
	 3, /* AF13 = 0xe */
	 0, /* 0xf Undefined */
	 2, /* CS2 = 0x10 */
	 0, /* 0x11 Undefined */
	 3, /* AF21 = 0x12 */
	 0, /* 0x13 Undefined */
	 3, /* AF22 = 0x14 */
	 0, /* 0x15 Undefined */
	 3, /* AF23 = 0x16 */
	 0, /* 0x17 Undefined */
	 4, /* CS3 = 0x18 */
	 0, /* 0x19 Undefined */
	 3, /* AF31 = 0x1a */
	 0, /* 0x1b Undefined */
	 3, /* AF32 = 0x1c */
	 0, /* 0x1d Undefined */
	 3, /* AF33 = 0x1e */
	 0, /* 0x1f Undefined */
	 5, /* CS4 = 0x20 */
	 0, /* 0x21 Undefined */
	 5, /* AF41 = 0x22 */
	 0, /* 0x23 Undefined */
	 5, /* AF42 = 0x24 */
	 0, /* 0x25 Undefined */
	 4, /* AF43 = 0x26 */
	 0, /* 0x27 Undefined */
	 5, /* CS5 = 0x28 */
	 0, /* 0x29 Undefined */
	 0, /* 0x2a Undefined */
	 0, /* 0x2b Undefined */
	 4, /* VA = 0x2c */
	 0, /* 0x2d Undefined */
	 6, /* EF = 0x2e */
	 0, /* 0x2f Undefined */
	 5, /* CS6 = 0x30 */
	 0, /* 0x31 Undefined */
	 0, /* 0x32 Undefined */
	 0, /* 0x33 Undefined */
	 0, /* 0x34 Undefined */
	 0, /* 0x35 Undefined */
	 0, /* 0x36 Undefined */
	 0, /* 0x37 Undefined */
	 5, /* CS7 = 0x38 */
	 0, /* 0x39 Undefined */
	 0, /* 0x3a Undefined */
	 0, /* 0x3b Undefined */
	 0, /* 0x3c Undefined */
	 0, /* 0x3d Undefined */
	 0, /* 0x3e Undefined */
	 0, /* 0x3f Undefined */
};
"
273,Dave Täht,2012-07-12 21:59:00.468929,I can resolve this issue in france next week. If I remember.
339,Dave Täht,2012-07-12 22:00:02.46304,I believe this bug to be fixed in the openwrt mainline now.
379,Dave Täht,2012-07-12 22:02:21.014246,This is going to require some serial port debugging and brain cells I do not have at present.
382,Dave Täht,2012-07-12 22:10:53.735356,This bug makes it impossible to have sync time across devices. must fix. soon.
379,Adam Gensler,2012-07-19 07:05:26.782455,"Hi Dave!

I've been watching your progress here for a while. I've recently started some work using OpenWRT (I know, not the same project), and I'm seeing crashes there as well, also under heavy load. It runs about 400 seconds under very heavy load and then just reboots. Watching the serial console shows no output when the reload occurs, the box simply starts rebooting. Specifics:

I'm using an alix 2D13 board. I have several and the problem is seen on all of them.

I'm using very vanilla OpenWRT builds with a near to default configuration. In fact, I've turned off dnsmasq and the firewall. I have no QoS configured. This is literally just port to port routing, nothing else.

I have two of the three ports connected to a Smartbits test device. I'm sending 64 byte packets between eth0 and eth1. eth2 is not connected. The tests start at 10% interface load and run for 90 seconds. If the test passes ( >0.01% packet loss), it increases the load. I see the following behavior:

10% load passes
55% load fails
32.5% load fails
21.5% load fails
60 seconds in to the next test the device reboots. This is repeatable every time.

I guess what I'm getting at is I think perhaps this is an OpenWRT / kernel problem and not specific to CeroWRT. In fact, there's a recently opened ticket on OpenWRT that describes something similar, though details there are sparse:

https://dev.openwrt.org/ticket/11882

I'm going to build a few images of OpenWRT to see if I can narrow down where it started crashing. Previous builds used to pass my entire test suite (64 bytes - 1500 byte packets). Now I can't get past the 4th iteration of the first frame size. I suspect the move to kernel 3.3 in 31753 for the alix2 target is the cause. If you're interested I'll report back my findings.
"
379,Robert Bradley,2012-08-06 10:06:21.44951,"Adam: that link was quite interesting!  Digging into it, if I understand correctly, the claim is that the lack of read/write memory barriers in via-rhine.c are the cause of their crashes.  I noticed that in CeroWRT, the ag71xx wired driver has rmb()/wmb() calls, but not the ath9k wireless driver.  It may be worth modifying the ath9k_ioread32 and ath9k_iowrite32 functions to add these as a test, although I would expect this to only affect multi-core systems."
379,Robert Bradley,2012-08-06 12:00:31.090751,"Continuing my previous post, here is the patch to add IO memory barriers to ath9k.  There may well be other points where memory barriers would make sense too if this is really the cause."
402,Dave Täht,2012-08-10 12:33:39.884707,""
406,Dave Täht,2012-08-10 20:32:54.270812,"I am dealing with three additional different bugs here. 

0) quagga is not pushing the 6to4 default route out to other babel nodes.

1) On the local interface,
the following syntax only adds one 2002:: based addresses to the listed
interfaces. (se00)

config interface 'ge01'                 
        option proto '6to4'             
        option adv_subnet '1'           
        option wan_device 'ge00'        
        option metric '1'               
        option ttl '64'                 
        list adv_interface 'gw00'       
        list adv_interface 'gw10'       
        list adv_interface 'se00'       
        list adv_interface 'sw00'       
        list adv_interface 'sw10'     

Interestingly, although luci will write this syntax, when it re-reads it only finds the first (gw00) interface. (see pic)

(it will also read the old syntax and convert to this)

I have been refreshing luci a lot, but somehow perhaps I'm out of sync? (no,
my last commit was 6c6af10f0859cbe5d61f5d2d60dfc9ea5215285e

And regardless only the third (se00) of these interfaces gain a 2002 address.

2) This generates a radvd file for the one interface that works as below.
Perhaps I need to put in a default route statement explicitly?

interface se00
{
        AdvLinkMTU 1480;
        AdvDefaultPreference medium;
        IgnoreIfMissing on;
        AdvSendAdvert on;
        AdvOtherConfigFlag on;
        AdvSourceLLAddress on;

        prefix 2002:328a:a616:1::1/64
        {
                AdvOnLink on;
                AdvAutonomous on;
                AdvRouterAddr off;
        };

        RDNSS fe80::204e:7fff:fe4a:9623
        {
        };

        DNSSL home.lan
        {
        };
};

The one client connected that way (haven't verified it's functionality)
isn't getting out.

3) when netifd runs it deletes up the addresses gained via ahcp, wiping out the mesh.

config interface 'gw01'                 
        option proto 'ahcp'
                       
config interface 'gw11'     
        option proto 'ahcp'



"
406,Dave Täht,2012-08-11 11:07:32.187881,"Both I and jow changed netifd to insert user routes as static (which is arguably more correct, anyway)

But although I changed quagga to distribute static as well, it still doesn't pick up the 6to4-ge01 default route for ipv6. I tried adding the device to the quagga ""network"" stanza, to no luck... It is not shown as an export from vtysh, either. 

0.0.0.0/0 metric 0 (exported)
50.138.160.0/21 metric 0 (exported)
192.168.1.0/27 metric 0 (exported)
192.168.1.64/27 metric 0 (exported)
192.168.1.96/27 metric 0 (exported)
192.168.1.128/27 metric 0 (exported)
192.168.1.160/27 metric 0 (exported)
192.168.1.224/32 metric 0 (exported)
::50.138.166.22/128 metric 0 (exported)
2002::/16 metric 0 (exported)
2002:328a:a616:bab5::1/128 metric 0 (exported)

Perhaps I can statically add it to the zebra config?

moving on to the other issues...

the 6to4 portion of the netifd scripts does not do address assignment. I'm not sure if it should, actually, when controlled by the adv_subnet variable. Perhaps a new variable, ""assign_subnet"" would be more appropro, or rs solicitations enabled in this case to automagically get a slaac address...

(btw, I like the scripts they are very clean and easy to read)

and have no idea how to tell it to ignore interfaces run with ahcp."
406,Dave Täht,2012-08-11 11:19:36.166917,"I was successfully able to propagate a default ipv6 route for 6to4 via adding
a stanza in zebra.conf

 interface 6to4-ge01
 ipv6 route ::/0 2002:c058:6301::
 

I'm not certain I wanted to do it that way (certainly I don't want to announce routes via that interface)"
406,Dave Täht,2012-08-11 19:57:10.699457,"Jow fixed portions of this bug (1 and 2) 

In packages:

proto/6x4: cast 6to4 adv_interface to string when saving to uci, fixes 6in4.   

Jow moved netifd to install userspace routes as static

    [package] netifd: bump to git head, userspace routes are installed with RTPR_STATIC

This did not actually fix quagga. I put in a workaround in #note-3 - but I'm not happy with having to embed the 
anycast route there, even if it is pretty generic...

This leaves netifd mucking with ahcpd managed interfaces when it shouldn't be as the last big remaining issue here.

Thx jow for leaping on this."
406,Denis Ovsienko,2012-08-21 13:17:48.732177,"Could you post the output of ""show ipv6 route"" vtysh command with and without the workaround?"
314,Robert Bradley,2012-08-22 17:38:14.631006,"I got this working with CeroWRT 3.3.8-17 using the following smb.conf.template:

<pre>
[global]
	netbios name = |NAME| 
	display charset = |CHARSET|
#	interfaces = |INTERFACES|
# Inelegant hack to get Samba listening on secure nets...
	interfaces = 127.0.0.1/8 lo se00 sw00 sw10
	server string = |DESCRIPTION|
	unix charset = |CHARSET|
	workgroup = |WORKGROUP|
	browseable = yes
	deadtime = 30
# Domain logons=yes necessary for PDC
	domain logons = yes
	domain master = yes
	encrypt passwords = true
	enable core files = no
	guest account = nobody
	guest ok = yes
	invalid users = root
	local master = yes
	load printers = no
	map to guest = Bad User
	max protocol = SMB2
	min receivefile size = 16384
	null passwords = yes
	obey pam restrictions = yes
	os level = 20
	passdb backend = smbpasswd
	preferred master = yes
	printable = no
	security = user
	smb encrypt = disabled
	smb passwd file = /etc/samba/smbpasswd
	socket options = TCP_NODELAY IPTOS_LOWDELAY
	syslog = 2
	use sendfile = yes
	writeable = yes
	wins support = yes
</pre>

The main issues were with |INTERFACES| only returning loopback and the need for ""domain logons = yes"".  I also added explicit firewall rules allowing CIFS traffic from the secure interfaces (se00, sw10 and sw00)."
409,Dave Täht,2012-09-23 19:12:57.95461,"<pre>
Time: 1348449572.645711
Modules:	sch_nfq_codel@81e26000+1830	sch_ns2_codel@81e78000+1030	sch_efq_codel@80344000+1a70	cls_fw@810d0000+c20	sch_htb@8071c000+2e60	sch_red@810a2000+1080	sch_sfq@81f7e000+1f40	cls_flow@8031c000+12a0	cls_u32@81f76000+16f0	sch_fq_codel@81f78000+17e0	sch_codel@80fe0000+fe0	sch_qfq@80748000+21b0	leds_wndr3700_usb@80efd000+2a0	ath79_wdt@80eee000+8c0	ohci_hcd@80f04000+3f70	ledtrig_usbdev@80ef4000+810	ledtrig_netdev@80efe000+c70	ip6t_REJECT@80ea7000+ac0	ip6t_LOG@80ef8000+17c0	ip6t_rt@80ef1000+5f0	ip6t_hbh@80ef3000+4b0	ip6t_mh@80ea5000+270	ip6t_ipv6header@80ee0000+3a0	ip6t_frag@80eeb000+300	ip6t_eui64@80eec000+270	ip6t_ah@80ee2000+2e0	ip6table_raw@80ebf000+1f0	ip6_queue@80ee8000+f40	ip6table_mangle@80eb6000+370	ip6table_filter@80ea9000+210	ip6_tables@80ee4000+24f0	nf_conntrack_ipv6@80ebb000+f00	nf_defrag_ipv6@80ebc000+1290	nf_nat_irc@80eb0000+320	nf_conntrack_irc@80eb2000+9b0	nf_nat_ftp@80ea8000+3e0	nf_conntrack_ftp@80eb4000+1180	xt_HL@80eaf000+4b0	xt_hl@80eac000+2d0	xt_ecn@80eaa000+490	ipt_ECN@80eab000+4f0	xt_CLASSIFY@80c42000+1f0	xt_time@80ea6000+5d0	xt_tcpmss@80ea1000+390	xt_statistic@80ea4000+2c0	xt_mark@80e65000+250	xt_length@80ea2000+260	xt_DSCP@80e93000+560	xt_dscp@80e92000+380	xt_string@80e99000+2b0	xt_layer7@80e9c000+2320	ipt_MASQUERADE@80e6d000+3e0	iptable_nat@80e7d000+a10	nf_nat@80e94000+2650	xt_recent@80e90000+15e0	xt_helper@80e6b000+310	xt_connmark@80e8f000+3c0	xt_connbytes@80e8d000+590	pppoe@80e68000+1e00	xt_conntrack@80e62000+820	xt_CT@80e8e000+4d0	xt_NOTRACK@80e60000+1c0	iptable_raw@80e58000+230	xt_state@80e5f000+260	nf_conntrack_ipv4@80e8c000+f40	nf_defrag_ipv4@80e5e000+270	nf_conntrack@80e80000+91f0	ehci_hcd@80e70000+81d0	pppox@80e3e000+480	ipt_REJECT@80e59000+710	xt_TCPMSS@80e56000+a10	ipt_LOG@80e5a000+17b0	xt_comment@81b6a000+190	xt_multiport@80e4f000+450	xt_mac@80e52000+210	xt_limit@80e47000+3a0	iptable_mangle@80e46000+340	iptable_filter@80d75000+250	ip_tables@80e48000+2310	xt_tcpudp@80e44000+640	x_tables@80e4c000+2730	ifb@80c41000+9c0	sit@80e30000+2110	tunnel4@81bff000+640	ppp_async@80e36000+17a0	ppp_generic@80e38000+4a80	slhc@81bfc000+11c0	ath9k@80d60000+14f60	ath9k_common@81b89000+490	ath9k_hw@80d00000+4d8a0	ath@80c50000+3820	mac80211@80cc0000+3e240	usbcore@81be0000+185b0	usb_common@81b4e000+1e0	nls_base@81aec000+1260	ts_fsm@81ada000+9c0	ts_bm@81bba000+530	ts_kmp@81adb000+4f0	crc_ccitt@81b6b000+3b0	ipv6@80c80000+3ba10	cfg80211@80c00000+26460	compat@81b68000+1650	arc4@81b72000+300	aes_generic@81af8000+7470	crypto_algapi@81b84000+2460	ledtrig_timer@81b18000+430	ledtrig_default_on@81ac6000+1a0	leds_gpio@81bb2000+630	gpio_button_hotplug@81b4b000+c60
95312] $ 8   : 000076e2 80c69026 00000010 00000000
<4>[89062.695312] $12   : 00000007 00000001 00070011 00000000
<4>[89062.695312] $16   : 00000000 00000018 80d4ee40 00000000
<4>[89062.695312] $20   : 80299e84 00000000 00000003 00000001
<4>[89062.695312] $24   : 00000010 00000000                  
<4>[89062.695312] $28   : 80f94000 80f959c0 00000000 801fa2b4
<4>[89062.695312] Hi    : 00000003
<4>[89062.695312] Lo    : 00000000
<4>[89062.695312] epc   : 801f9d94 0x801f9d94
<4>[89062.695312]     Tainted: G        W  O
<4>[89062.695312] ra    : 801fa2b4 0x801fa2b4
<4>[89062.695312] Status: 1000f403    KERNEL EXL IE 
<4>[89062.695312] Cause : 00800008
<4>[89062.695312] BadVA : 00000018
<4>[89062.695312] PrId  : 00019374 (MIPS 24Kc)
<4>[89062.695312] Modules linked in: sch_nfq_codel sch_ns2_codel sch_efq_codel cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_fq_codel sch_codel sch_qfq leds_wndr3700_usb ath79_wdt ohci_hcd ledtrig_usbdev ledtrig_netdev ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah ip6table_raw ip6_queue ip6table_mangle ip6table_filter ip6_tables nf_conntrack_ipv6 nf_defrag_ipv6 nf_nat_irc nf_conntrack_irc nf_nat_ftp nf_conntrack_ftp xt_HL xt_hl xt_ecn ipt_ECN xt_CLASSIFY xt_time xt_tcpmss xt_statistic xt_mark xt_length xt_DSCP xt_dscp xt_string xt_layer7 ipt_MASQUERADE iptable_nat nf_nat xt_recent xt_helper xt_connmark xt_connbytes pppoe xt_conntrack xt_CT xt_NOTRACK iptable_raw xt_state nf_conntrack_ipv4 nf_defrag_ipv4 nf_conntrack ehci_hcd pppox ipt_REJECT xt_TCPMSS ipt_LOG xt_comment xt_multiport xt_mac xt_limit iptable_mangle iptable_filter ip_tables xt_tcpudp x_tables ifb sit tunnel4 ppp_async ppp_generic slhc ath9k(O) ath9k_common(O) ath9k_hw(O) ath(O) mac80211(O) usbcore usb_common nls_base ts_fsm ts_bm ts_kmp crc_ccitt ipv6 cfg80211(O) compat(O) arc4 aes_generic crypto_algapi ledtrig_timer ledtrig_default_on leds_gpio gpio_button_hotplug(O)
<4>[89062.695312] Process hostapd (pid: 926, threadinfo=80f94000, task=81b00000, tls=77961440)
<4>[89062.695312] Stack : 80330000 80330000 81abd760 00000000 81ae8000 80d64fb0 81abdfc0 00000000
<4>[89062.695312]         80330000 80330000 802e0000 00000000 00000101 80076fa8 00000008 00000101
<4>[89062.695312]         80330000 80330000 00000001 8032f01c 81818850 802e0000 802e2808 00000001
<4>[89062.695312]         00000000 81ab6900 80d4ee40 80f9d814 80d4ee40 80f9d800 80f9d82c 801fa2b4
<4>[89062.695312]         00000000 00000000 00000000 00000000 80d4ee40 802082b8 000000d0 80c16870
<4>[89062.695312]         ...
<4>[89062.695312] Call Trace:[<80d64fb0>] 0x80d64fb0
<4>[89062.695312] [<80076fa8>] 0x80076fa8
<4>[89062.695312] [<801fa2b4>] 0x801fa2b4
<4>[89062.695312] [<802082b8>] 0x802082b8
<4>[89062.695312] [<80c16870>] 0x80c16870
<4>[89062.695312] [<802084a8>] 0x802084a8
<4>[89062.695312] [<80179018>] 0x80179018
<4>[89062.695312] [<80c16988>] 0x80c16988
<4>[89062.695312] [<8008729c>] 0x8008729c
<4>[89062.695312] [<80cc4904>] 0x80cc4904
<4>[89062.695312] [<80cc4ba8>] 0x80cc4ba8
<4>[89062.695312] [<802f0000>] 0x802f0000
<4>[89062.695312] [<801f9384>] 0x801f9384
<4>[89062.695312] [<80cd4ccc>] 0x80cd4ccc
<4>[89062.695312] [<80c1d1cc>] 0x80c1d1cc
<4>[89062.695312] [<8020a9e0>] 0x8020a9e0
<4>[89062.695312] [<8020a818>] 0x8020a818
<4>[89062.695312] [<80209dcc>] 0x80209dcc
<4>[89062.695312] [<8020a808>] 0x8020a808
<4>[89062.695312] [<80092a78>] 0x80092a78
<4>[89062.695312] [<80209700>] 0x80209700
<4>[89062.695312] [<801deef4>] 0x801deef4
<4>[89062.695312] [<80263774>] 0x80263774
<4>[89062.695312] [<80209afc>] 0x80209afc
<4>[89062.695312] [<80262090>] 0x80262090
<4>[89062.695312] [<8007745c>] 0x8007745c
<4>[89062.695312] [<801d6034>] 0x801d6034
<4>[89062.695312] [<801e2f44>] 0x801e2f44
<4>[89062.695312] [<801d61b0>] 0x801d61b0
<4>[89062.695312] [<801e2008>] 0x801e2008
<4>[89062.695312] [<801d6e70>] 0x801d6e70
<4>[89062.695312] [<80d67dbc>] 0x80d67dbc
<4>[89062.695312] [<801d6bbc>] 0x801d6bbc
<4>[89062.695312] [<8007745c>] 0x8007745c
<4>[89062.695312] [<801d8730>] 0x801d8730
<4>[89062.695312] [<800ea76c>] 0x800ea76c
<4>[89062.695312] [<800eac3c>] 0x800eac3c
<4>[89062.695312] [<801d89e8>] 0x801d89e8
<4>[89062.695312] [<800eb51c>] 0x800eb51c
<4>[89062.695312] [<8006a210>] 0x8006a210
<4>[89062.695312] 
<4>[89062.695312] 
<4>[89062.695312] Code: 00009821  00008021  26949e84 
<4>[89062.695312]  2442ffff  3042ffff  2c430037  10600111  8e250004 
<4>[89063.089843] ------------[ cut here ]------------
<4>[89063.093750] WARNING: at /home/cero1/src/ubnt-3.3/build_dir/linux-ar71xx_generic/compat-wireless-2012-09-07/drivers/net/wireless/ath/ath9k/beacon.c:362 0x80d6091c()
<4>[89063.109375] Modules linked in: sch_nfq_codel sch_ns2_codel sch_efq_codel cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_fq_codel sch_codel sch_qfq leds_wndr3700_usb ath79_wdt ohci_hcd ledtrig_usbdev ledtrig_netdev ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah ip6table_raw ip6_queue ip6table_mangle ip6table_filter ip6_tables nf_conntrack_ipv6 nf_defrag_ipv6 nf_nat_irc nf_conntrack_irc nf_nat_ftp nf_conntrack_ftp xt_HL xt_hl xt_ecn ipt_ECN xt_CLASSIFY xt_time xt_tcpmss xt_statistic xt_mark xt_length xt_DSCP xt_dscp xt_string xt_layer7 ipt_MASQUERADE iptable_nat nf_nat xt_recent xt_helper xt_connmark xt_connbytes pppoe xt_conntrack xt_CT xt_NOTRACK iptable_raw xt_state nf_conntrack_ipv4 nf_defrag_ipv4 nf_conntrack ehci_hcd pppox ipt_REJECT xt_TCPMSS ipt_LOG xt_comment xt_multiport xt_mac xt_limit iptable_mangle iptable_filter ip_tables xt_tcpudp x_tables ifb sit tunnel4 ppp_async ppp_generic slhc ath9k(O) ath9k_common(O) ath9k_hw(O) ath(O) mac80211(O) usbcore usb_common nls_base ts_fsm ts_bm ts_kmp crc_ccitt ipv6 cfg80211(O) compat(O) arc4 aes_generic crypto_algapi ledtrig_timer ledtrig_default_on leds_gpio gpio_button_hotplug(O)
<4>[89063.214843] Call Trace:[<80283a5c>] 0x80283a5c
<4>[89063.218750] [<80283a5c>] 0x80283a5c
<4>[89063.222656] [<80d6091c>] 0x80d6091c
<4>[89063.226562] [<80071b74>] 0x80071b74
<4>[89063.230468] [<80d6091c>] 0x80d6091c
<4>[89063.230468] [<80071bb8>] 0x80071bb8
<4>[89063.234375] [<80d6091c>] 0x80d6091c
<4>[89063.238281] [<80086f20>] 0x80086f20
<4>[89063.242187] [<80ce8448>] 0x80ce8448
<4>[89063.246093] [<801d4c28>] 0x801d4c28
<4>[89063.250000] [<80076fa8>] 0x80076fa8
<4>[89063.253906] [<80077420>] 0x80077420
<4>[89063.257812] [<80077628>] 0x80077628
<4>[89063.261718] [<8007786c>] 0x8007786c
<4>[89063.265625] [<800630b0>] 0x800630b0
<4>[89063.269531] [<80072b54>] 0x80072b54
<4>[89063.269531] [<80198e84>] 0x80198e84
<4>[89063.273437] [<80198790>] 0x80198790
<4>[89063.277343] [<8006794c>] 0x8006794c
<4>[89063.281250] [<80067944>] 0x80067944
<4>[89063.285156] [<80198e84>] 0x80198e84
<4>[89063.289062] [<8006c140>] 0x8006c140
<4>[89063.292968] [<801f9d94>] 0x801f9d94
<4>[89063.296875] [<801fa2b4>] 0x801fa2b4
<4>[89063.300781] [<80cb3e78>] 0x80cb3e78
<4>[89063.304687] [<80c90240>] 0x80c90240
<4>[89063.308593] [<80c9032c>] 0x80c9032c
<4>[89063.308593] [<8020bbfc>] 0x8020bbfc
<4>[89063.312500] [<80e808e8>] 0x80e808e8
<4>[89063.316406] [<801df9fc>] 0x801df9fc
<4>[89063.320312] [<800630a0>] 0x800630a0
<4>[89063.324218] [<80c86820>] 0x80c86820
<4>[89063.328125] [<80c85bf0>] 0x80c85bf0
<4>[89063.332031] [<801fa2b4>] 0x801fa2b4
<4>[89063.335937] [<801f9d94>] 0x801f9d94
<4>[89063.339843] [<80d64fb0>] 0x80d64fb0
<4>[89063.343750] [<80076fa8>] 0x80076fa8
<4>[89063.347656] [<801fa2b4>] 0x801fa2b4
<4>[89063.347656] [<802082b8>] 0x802082b8
<4>[89063.351562] [<80c16870>] 0x80c16870
<4>[89063.355468] [<802084a8>] 0x802084a8
<4>[89063.359375] [<80179018>] 0x80179018
<4>[89063.363281] [<80c16988>] 0x80c16988
<4>[89063.367187] [<8008729c>] 0x8008729c
<4>[89063.371093] [<80cc4904>] 0x80cc4904
<4>[89063.375000] [<80cc4ba8>] 0x80cc4ba8
<4>[89063.378906] [<802f0000>] 0x802f0000
<4>[89063.382812] [<801f9384>] 0x801f9384
<4>[89063.386718] [<80cd4ccc>] 0x80cd4ccc
<4>[89063.386718] [<80c1d1cc>] 0x80c1d1cc
<4>[89063.390625] [<8020a9e0>] 0x8020a9e0
<4>[89063.394531] [<8020a818>] 0x8020a818
<4>[89063.398437] [<80209dcc>] 0x80209dcc
<4>[89063.402343] [<8020a808>] 0x8020a808
<4>[89063.406250] [<80092a78>] 0x80092a78
<4>[89063.410156] [<80209700>] 0x80209700
<4>[89063.414062] [<801deef4>] 0x801deef4
<4>[89063.417968] [<80263774>] 0x80263774
<4>[89063.421875] [<80209afc>] 0x80209afc
<4>[89063.425781] [<80262090>] 0x80262090
<4>[89063.425781] [<8007745c>] 0x8007745c
<4>[89063.429687] [<801d6034>] 0x801d6034
<4>[89063.433593] [<801e2f44>] 0x801e2f44
<4>[89063.437500] [<801d61b0>] 0x801d61b0
<4>[89063.441406] [<801e2008>] 0x801e2008
<4>[89063.445312] [<801d6e70>] 0x801d6e70
<4>[89063.449218] [<80d67dbc>] 0x80d67dbc
<4>[89063.453125] [<801d6bbc>] 0x801d6bbc
<4>[89063.457031] [<8007745c>] 0x8007745c
<4>[89063.460937] [<801d8730>] 0x801d8730
<4>[89063.464843] [<800ea76c>] 0x800ea76c
<4>[89063.464843] [<800eac3c>] 0x800eac3c
<4>[89063.468750] [<801d89e8>] 0x801d89e8
<4>[89063.472656] [<800eb51c>] 0x800eb51c
<4>[89063.476562] [<8006a210>] 0x8006a210
<4>[89063.480468] 
<4>[89063.480468] ---[ end trace a30e26a6312167ea ]---
<4>[89063.488281] ------------[ cut here ]------------
<4>[89063.492187] WARNING: at /home/cero1/src/ubnt-3.3/build_dir/linux-ar71xx_generic/compat-wireless-2012-09-07/drivers/net/wireless/ath/ath9k/beacon.c:362 0x80d6091c()
<4>[89063.507812] Modules linked in: sch_nfq_codel sch_ns2_codel sch_efq_codel cls_fw sch_htb sch_red sch_sfq cls_flow cls_u32 sch_fq_codel sch_codel sch_qfq leds_wndr3700_usb ath79_wdt ohci_hcd ledtrig_usbdev ledtrig_netdev ip6t_REJECT ip6t_LOG ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah ip6table_raw ip6_queue ip6table_mangle ip6table_filter ip6_tables nf_conntrack_ipv6 nf_defrag_ipv6 nf_nat_irc nf_conntrack_irc nf_nat_ftp nf_conntrack_ftp xt_HL xt_hl xt_ecn ipt_ECN xt_CLASSIFY xt_time xt_tcpmss xt_statistic xt_mark xt_length xt_DSCP xt_dscp xt_string xt_layer7 ipt_MASQUERADE iptable_nat nf_nat xt_recent xt_helper xt_connmark xt_connbytes pppoe xt_conntrack xt_CT xt_NOTRACK iptable_raw xt_state nf_conntrack_ipv4 nf_defrag_ipv4 nf_conntrack ehci_hcd pppox ipt_REJECT xt_TCPMSS ipt_LOG xt_comment xt_multiport xt_mac xt_limit iptable_mangle iptable_filter ip_tables xt_tcpudp x_tables ifb sit tunnel4 ppp_async ppp_generic slhc ath9k(O) ath9k_common(O) ath9k_hw(O) ath(O) mac80211(O) usbcore usb_common nls_base ts_fsm ts_bm ts_kmp crc_ccitt ipv6 cfg80211(O) compat(O) arc4 aes_generic crypto_algapi ledtrig_timer ledtrig_default_on leds_gpio gpio_button_hotplug(O)
<4>[89063.613281] Call Trace:[<80283a5c>] 0x80283a5c
<4>[89063.617187] [<80283a5c>] 0x80283a5c
<4>[89063.621093] [<80d6091c>] 0x80d6091c
<4>[89063.625000] [<80071b74>] 0x80071b74
<4>[89063.628906] [<80d6091c>] 0x80d6091c
<4>[89063.632812] [<80071bb8>] 0x80071bb8
<4>[89063.632812] [<80d6091c>] 0x80d6091c
<4>[89063.636718] [<80086f20>] 0x80086f20
<4>[89063.640625] [<801d4c28>] 0x801d4c28
<4>[89063.644531] [<80076fa8>] 0x80076fa8
<4>[89063.648437] [<80077420>] 0x80077420
<4>[89063.652343] [<80077628>] 0x80077628
<4>[89063.656250] [<8007786c>] 0x8007786c
<4>[89063.660156] [<800630b0>] 0x800630b0
<4>[89063.664062] [<80072b54>] 0x80072b54
<4>[89063.667968] [<80198e84>] 0x80198e84
<4>[89063.671875] [<80198790>] 0x80198790
<4>[89063.671875] [<8006794c>] 0x8006794c
<4>[89063.675781] [<80067944>] 0x80067944
<4>[89063.679687] [<80198e84>] 0x80198e84
<4>[89063.683593] [<8006c140>] 0x8006c140
<4>[89063.687500] [<801f9d94>] 0x801f9d94
<4>[89063.691406] [<801fa2b4>] 0x801fa2b4
<4>[89063.695312] [<80cb3e78>] 0x80cb3e78
<4>[89063.699218] [<80c90240>] 0x80c90240
<4>[89063.703125] [<80c9032c>] 0x80c9032c
<4>[89063.707031] [<8020bbfc>] 0x8020bbfc
<4>[89063.707031] [<80e808e8>] 0x80e808e8
<4>[89063.710937] [<801df9fc>] 0x801df9fc
<4>[89063.714843] [<800630a0>] 0x800630a0
<4>[89063.718750] [<80c86820>] 0x80c86820
<4>[89063.722656] [<80c85bf0>] 0x80c85bf0
<4>[89063.726562] [<801fa2b4>] 0x801fa2b4
<4>[89063.730468] [<801f9d94>] 0x801f9d94
<4>[89063.734375] [<80d64fb0>] 0x80d64fb0
<4>[89063.738281] [<80076fa8>] 0x80076fa8
<4>[89063.742187] [<801fa2b4>] 0x801fa2b4
<4>[89063.746093] [<802082b8>] 0x802082b8
<4>[89063.746093] [<80c16870>] 0x80c16870
<4>[89063.750000] [<802084a8>] 0x802084a8
<4>[89063.753906] [<80179018>] 0x80179018
<4>[89063.757812] [<80c16988>] 0x80c16988
<4>[89063.761718] [<8008729c>] 0x8008729c
<4>[89063.765625] [<80cc4904>] 0x80cc4904
<4>[89063.769531] [<80cc4ba8>] 0x80cc4ba8
<4>[89063.773437] [<802f0000>] 0x802f0000
<4>[89063.777343] [<801f9384>] 0x801f9384
<4>[89063.781250] [<80cd4ccc>] 0x80cd4ccc
<4>[89063.785156] [<80c1d1cc>] 0x80c1d1cc
<4>[89063.789062] [<8020a9e0>] 0x8020a9e0
<4>[89063.789062] [<8020a818>] 0x8020a818
<4>[89063.792968] [<80209dcc>] 0x80209dcc
<4>[89063.796875] [<8020a808>] 0x8020a808
<4>[89063.800781] [<80092a78>] 0x80092a78
<4>[89063.804687] [<80209700>] 0x80209700
<4>[89063.808593] [<801deef4>] 0x801deef4
<4>[89063.812500] [<80263774>] 0x80263774
<4>[89063.816406] [<80209afc>] 0x80209afc
<4>[89063.820312] [<80262090>] 0x80262090
<4>[89063.824218] [<8007745c>] 0x8007745c
<4>[89063.828125] [<801d6034>] 0x801d6034
<4>[89063.828125] [<801e2f44>] 0x801e2f44
<4>[89063.832031] [<801d61b0>] 0x801d61b0
<4>[89063.835937] [<801e2008>] 0x801e2008
<4>[89063.839843] [<801d6e70>] 0x801d6e70
<4>[89063.843750] [<80d67dbc>] 0x80d67dbc
<4>[89063.847656] [<801d6bbc>] 0x801d6bbc
<4>[89063.851562] [<8007745c>] 0x8007745c
<4>[89063.855468] [<801d8730>] 0x801d8730
<4>[89063.859375] [<800ea76c>] 0x800ea76c
<4>[89063.863281] [<800eac3c>] 0x800eac3c
<4>[89063.867187] [<801d89e8>] 0x801d89e8
<4>[89063.867187] [<800eb51c>] 0x800eb51c
<4>[89063.871093] [<8006a210>] 0x8006a210
<4>[89063.875000] 
<4>[89063.878906] ---[ end trace a30e26a6312167eb ]---
<4>[89063.882812] ---[ end trace a30e26a6312167ec ]---
</pre>"
406,David Taht,2012-09-24 17:56:48.932,"On Wed, Sep 19, 2012 at 3:58 PM, Chris Lawrence <lordsutch@gmail.com> wrote:
> I've only noticed one real problem thus far: radvd is still
> advertising incorrect subnet addresses for 6to4 connections (addresses
> that start with 0:0:0:$adv_subnet, which clearly are wrong since all
> the addresses should be under 2002: to be routable on the ipv6
> Internet).  The fix is simple: in /lib/netifd/proto/6to4.sh, line 162
> should read:
>
>                                 ""$wancfg"" ""$subnet6"" \
>
> instead of the printf call that's there now.  This is probably an
> upstream OpenWRT problem too.

Actually, no, the correct line would be:

                        set_6to4_radvd_prefix    ""$sid"" ""$adv_interface"" \
                                ""$wancfg"" ""$(printf ""%s:%x::/64""
$prefix6 $adv_subnet) \
                                ""$adv_valid_lifetime"" ""$adv_preferred_lifetime""

arguably ""subnet6"" is misnamed.

There is another bug in this script in correctly adding multiple
interfaces. It succeeds on the first, but not the rest, and thus far I
can't figure out why.

There is another bug in that arguably the interface itself should have
a prefix lifetime (monitored somehow) and mtu set and I'd argue for
marking it secondary in the hope that someday real ipv6 addresses
would become common.

And last bug, in that with the latest quagga OR dnsmasq, radvd is not
needed, except for detecting and generating the 6to4 prefix.



>
>
> Chris"
406,Jo-Philipp Wich,2012-09-25 00:28:52.104516,"Setting the radvd adv subnet with leading zeros is deliberate and not a bug.
Thats a special feature of radvd, it will populate the leading zeros with the prefix of the Base6to4 interface specified in the same prefix section. See the radvd man page for details on this."
410,Dave Täht,2012-09-27 14:52:45.466945,"The first device I looked at only had 4MB of flash. Cerowrt requires at least 12.

Overall our strategy is to create new stuff, push it into the mainline kernel or package, and push up into openwrt.
from there it flows down into other devices, inside of their own limits.

While there might be specific hardware that needs debloating (such as adding BQL to an ethernet driver) in different hardware than we currently use - we have no resources at present to do that work, nor do we have resources to build or QA it, nor even purchase the hardware. 

If a router maker or chipset vendor were to sign up and pay for a debloating exercise then things would be different. 
(I'd prefer that they'd merely do the work themselves)

Sure, I'd love it to be able to extend our efforts to other commonly available hardware like the raspberry pi, dreamplug, but budget is non-existent. About the only thing I plan to do is add a kvm version.


Lastly:

Almost everything ""good"" and ""stable"" in present day cerowrt is now in openwrt, and it is easy to layer the chief changes to openwrt on top of openwrt for a specific OS (notably the debloat package in the ceropackages repo, also some kernel patches in the cerowrt-3.3 repo). So go ahead and build for your platform and let us know the results."
411,David Taht,2012-10-26 07:39:24.253007,""
400,David Taht,2012-10-26 07:41:47.270248,TCP small queuses stuff is upstream in 3.6 for this now
411,Sebastien GAGGINI,2012-11-03 16:56:27.524323,"Adding this line in the ""config dnsmasq"" section of /etc/config/dhcp works too. Dnsmasq then stop listening on ge00

list notinterface 'ge00'

"
413,John Jason Brzozowski,2012-11-05 06:53:34.506049,"The traces indicate that the ADVERTISE offers a /64 IAPD.  I suggest updating the SOLICIT to include ""::/60"" for the IAPD per RFC3633 to hint that a shorter prefix is desired."
411,Maciej Soltysiak,2012-11-24 08:13:30.607121,"Hi!

Having DNS open for a while made some evil forces notice it and use my IP
for DNS amplification attacks. I secured dnsmasq not to listen on ge00, but
I'm still getting over 300 UDP packets/s!

Getting my ISP to block it at their level seems to be PITA and still not
done. I have a subjective feeling the latency has gotten worse and this
traffic is consuming some of the buffers.

Anyway, my point is that:
1. This should be fixed in next cero
2. Perhaps we need an advisory released so that people trying 3.3.8-26
(latest on ftp I think) can avoid participating in this spoofed DNS shit
and see better link performance.

Waddy a think?

Maciej
On 24 Oct 2012 18:07, <cerowrt@lists.bufferbloat.net> wrote:

>
> Issue #411 has been reported by David Taht.
>
> ----------------------------------------
> Bug #411: dnsmasq dns port open a bad idea
> https://www.bufferbloat.net/issues/411
>
> Author: David Taht
> Status: New
> Priority: Normal
> Assignee:
> Category:
> Target version:
>
>
> ---------- Forwarded message ----------
> From: Dave Taht <dave.taht@gmail.com>
> Date: Wed, Oct 24, 2012 at 8:48 AM
> Subject: Re: [Bloat] New Cerowrt user; surprises
> To: Anthony Lieuallen <arantius@gmail.com>
> Cc: bloat@lists.bufferbloat.net
>
>
> Up until very recently (prior release) cerowrt used bind9, with a
> split view, hiding the internal dns names from the outside world. So
> the port was open and safe to use. But with the switch to dnsmasq, I'd
> left that port open, which is definately a hole that should be closed
> by anyone using it on the open internet. On the gripping hand, I was
> hoping to go back to using bind at some point.
>
>
> On Wed, Oct 24, 2012 at 6:50 AM, Anthony Lieuallen <arantius@gmail.com>
> wrote:
> > I read that it's not intended to be, but I've just installed Cerowrt as
> my
> > primary router at home.  I was surprised by the fact that:
> >
> > * The list of open/filtered ports in an external nmap is bigger than I
> > expect.  I saw the explanation for some of them like ftp/telnet.
>
> I like the ftp/telnet trick and would like to see it enhanced to also
> insert
> firewall rules blocking access to port 81 etc on a telnet attempt. (or
> having the config web server also launch from xinetd)
>
> This would fully thwart attacks from within on the router from things
> like dnschanger.
>
> > * But one of them is DNS, and it's really open, and recursively resolving
> > for the entire internet.
> > * And it's answering private (172.30...) names that the world shouldn't
> > know.
>
> Yes, this was a mistake.
>
> > * I haven't changed any firewalling rules, but the guest wireless (gw10)
> can
> > see the lan (se00) addresses and communicate with them.
>
> To some extent. Known insecure services are blocked. As the intent is
> generally
> (for now) to use cerowrt as a test router INSIDE the home, excessive
> firewall rules lead to all sorts of headaches.
>
> >
> > I'm sure I could tweak the rules to ""fix"" all of these, but I'm surprised
> > that this is the default configuration.
>
> Totally secure by default = unusable by default.
>
> > And I'm not yet 100% confident of
> > the difference between the Firewall pane's ""General Settings"" and
> ""Traffic
> > Rules"" yet, so I don't want to poke too much.
>
> /etc/config/firewall contains the rules. I find that and iptables
> easier to understand.
>
> >
> > _______________________________________________
> > Bloat mailing list
> > Bloat@lists.bufferbloat.net
> > https://lists.bufferbloat.net/listinfo/bloat
> >
>
>"
411,David Taht,2012-11-24 08:22:02.713909,"It is fixed in the current source trees, but I've been waiting for
other fixed stuff to land.

I am very unhappy I inserted this hole in the switch to dnsmasq. I
will make sure to stress this in the next release. I don't know what
else to do about it, besides keep the list informed....

On Sat, Nov 24, 2012 at 5:13 PM,  <cerowrt@lists.bufferbloat.net> wrote:
>
> Issue #411 has been updated by Maciej Soltysiak.
>
>
> Hi!
>
> Having DNS open for a while made some evil forces notice it and use my IP
> for DNS amplification attacks. I secured dnsmasq not to listen on ge00, but
> I'm still getting over 300 UDP packets/s!
>
> Getting my ISP to block it at their level seems to be PITA and still not
> done. I have a subjective feeling the latency has gotten worse and this
> traffic is consuming some of the buffers.
>
> Anyway, my point is that:
> 1. This should be fixed in next cero
> 2. Perhaps we need an advisory released so that people trying 3.3.8-26
> (latest on ftp I think) can avoid participating in this spoofed DNS shit
> and see better link performance.
>
> Waddy a think?
>
> Maciej
> On 24 Oct 2012 18:07, <cerowrt@lists.bufferbloat.net> wrote:
>
>>
>> Issue #411 has been reported by David Taht.
>>
>> ----------------------------------------
>> Bug #411: dnsmasq dns port open a bad idea
>> https://www.bufferbloat.net/issues/411
>>
>> Author: David Taht
>> Status: New
>> Priority: Normal
>> Assignee:
>> Category:
>> Target version:
>>
>>
>> ---------- Forwarded message ----------
>> From: Dave Taht <dave.taht@gmail.com>
>> Date: Wed, Oct 24, 2012 at 8:48 AM
>> Subject: Re: [Bloat] New Cerowrt user; surprises
>> To: Anthony Lieuallen <arantius@gmail.com>
>> Cc: bloat@lists.bufferbloat.net
>>
>>
>> Up until very recently (prior release) cerowrt used bind9, with a
>> split view, hiding the internal dns names from the outside world. So
>> the port was open and safe to use. But with the switch to dnsmasq, I'd
>> left that port open, which is definately a hole that should be closed
>> by anyone using it on the open internet. On the gripping hand, I was
>> hoping to go back to using bind at some point.
>>
>>
>> On Wed, Oct 24, 2012 at 6:50 AM, Anthony Lieuallen <arantius@gmail.com>
>> wrote:
>> > I read that it's not intended to be, but I've just installed Cerowrt as
>> my
>> > primary router at home.  I was surprised by the fact that:
>> >
>> > * The list of open/filtered ports in an external nmap is bigger than I
>> > expect.  I saw the explanation for some of them like ftp/telnet.
>>
>> I like the ftp/telnet trick and would like to see it enhanced to also
>> insert
>> firewall rules blocking access to port 81 etc on a telnet attempt. (or
>> having the config web server also launch from xinetd)
>>
>> This would fully thwart attacks from within on the router from things
>> like dnschanger.
>>
>> > * But one of them is DNS, and it's really open, and recursively resolving
>> > for the entire internet.
>> > * And it's answering private (172.30...) names that the world shouldn't
>> > know.
>>
>> Yes, this was a mistake.
>>
>> > * I haven't changed any firewalling rules, but the guest wireless (gw10)
>> can
>> > see the lan (se00) addresses and communicate with them.
>>
>> To some extent. Known insecure services are blocked. As the intent is
>> generally
>> (for now) to use cerowrt as a test router INSIDE the home, excessive
>> firewall rules lead to all sorts of headaches.
>>
>> >
>> > I'm sure I could tweak the rules to ""fix"" all of these, but I'm surprised
>> > that this is the default configuration.
>>
>> Totally secure by default = unusable by default.
>>
>> > And I'm not yet 100% confident of
>> > the difference between the Firewall pane's ""General Settings"" and
>> ""Traffic
>> > Rules"" yet, so I don't want to poke too much.
>>
>> /etc/config/firewall contains the rules. I find that and iptables
>> easier to understand.
>>
>> >
>> > _______________________________________________
>> > Bloat mailing list
>> > Bloat@lists.bufferbloat.net
>> > https://lists.bufferbloat.net/listinfo/bloat
>> >
>>
>>
> ----------------------------------------
> Bug #411: dnsmasq dns port open a bad idea
> https://www.bufferbloat.net/issues/411
>
> Author: David Taht
> Status: New
> Priority: Urgent
> Assignee:
> Category: Build
> Target version: 1st Public Cerowrt release
>
>
> ---------- Forwarded message ----------
> From: Dave Taht <dave.taht@gmail.com>
> Date: Wed, Oct 24, 2012 at 8:48 AM
> Subject: Re: [Bloat] New Cerowrt user; surprises
> To: Anthony Lieuallen <arantius@gmail.com>
> Cc: bloat@lists.bufferbloat.net
>
>
> Up until very recently (prior release) cerowrt used bind9, with a
> split view, hiding the internal dns names from the outside world. So
> the port was open and safe to use. But with the switch to dnsmasq, I'd
> left that port open, which is definately a hole that should be closed
> by anyone using it on the open internet. On the gripping hand, I was
> hoping to go back to using bind at some point.
>
>
> On Wed, Oct 24, 2012 at 6:50 AM, Anthony Lieuallen <arantius@gmail.com> wrote:
>> I read that it's not intended to be, but I've just installed Cerowrt as my
>> primary router at home.  I was surprised by the fact that:
>>
>> * The list of open/filtered ports in an external nmap is bigger than I
>> expect.  I saw the explanation for some of them like ftp/telnet.
>
> I like the ftp/telnet trick and would like to see it enhanced to also insert
> firewall rules blocking access to port 81 etc on a telnet attempt. (or
> having the config web server also launch from xinetd)
>
> This would fully thwart attacks from within on the router from things
> like dnschanger.
>
>> * But one of them is DNS, and it's really open, and recursively resolving
>> for the entire internet.
>> * And it's answering private (172.30...) names that the world shouldn't
>> know.
>
> Yes, this was a mistake.
>
>> * I haven't changed any firewalling rules, but the guest wireless (gw10) can
>> see the lan (se00) addresses and communicate with them.
>
> To some extent. Known insecure services are blocked. As the intent is generally
> (for now) to use cerowrt as a test router INSIDE the home, excessive
> firewall rules lead to all sorts of headaches.
>
>>
>> I'm sure I could tweak the rules to ""fix"" all of these, but I'm surprised
>> that this is the default configuration.
>
> Totally secure by default = unusable by default.
>
>> And I'm not yet 100% confident of
>> the difference between the Firewall pane's ""General Settings"" and ""Traffic
>> Rules"" yet, so I don't want to poke too much.
>
> /etc/config/firewall contains the rules. I find that and iptables
> easier to understand.
>
>>
>> _______________________________________________
>> Bloat mailing list
>> Bloat@lists.bufferbloat.net
>> https://lists.bufferbloat.net/listinfo/bloat
>>
>
>"
411,Maciej Soltysiak,2012-11-24 09:04:57.485405,"Cool.
Maybe update the news/announcement pages for builds affected on
bufferbloat.net

I'm all for iptables-I zone_wan -j DROP
Maybe perhaps leave ssh open...
On 24 Nov 2012 17:22, <cerowrt@lists.bufferbloat.net> wrote:

>
> Issue #411 has been updated by David Taht.
>
>
> It is fixed in the current source trees, but I've been waiting for
> other fixed stuff to land.
>
> I am very unhappy I inserted this hole in the switch to dnsmasq. I
> will make sure to stress this in the next release. I don't know what
> else to do about it, besides keep the list informed....
>
> On Sat, Nov 24, 2012 at 5:13 PM,  <cerowrt@lists.bufferbloat.net> wrote:
> >
> > Issue #411 has been updated by Maciej Soltysiak.
> >
> >
> > Hi!
> >
> > Having DNS open for a while made some evil forces notice it and use my IP
> > for DNS amplification attacks. I secured dnsmasq not to listen on ge00,
> but
> > I'm still getting over 300 UDP packets/s!
> >
> > Getting my ISP to block it at their level seems to be PITA and still not
> > done. I have a subjective feeling the latency has gotten worse and this
> > traffic is consuming some of the buffers.
> >
> > Anyway, my point is that:
> > 1. This should be fixed in next cero
> > 2. Perhaps we need an advisory released so that people trying 3.3.8-26
> > (latest on ftp I think) can avoid participating in this spoofed DNS shit
> > and see better link performance.
> >
> > Waddy a think?
> >
> > Maciej
> > On 24 Oct 2012 18:07, <cerowrt@lists.bufferbloat.net> wrote:
> >
> >>
> >> Issue #411 has been reported by David Taht.
> >>
> >> ----------------------------------------
> >> Bug #411: dnsmasq dns port open a bad idea
> >> https://www.bufferbloat.net/issues/411
> >>
> >> Author: David Taht
> >> Status: New
> >> Priority: Normal
> >> Assignee:
> >> Category:
> >> Target version:
> >>
> >>
> >> ---------- Forwarded message ----------
> >> From: Dave Taht <dave.taht@gmail.com>
> >> Date: Wed, Oct 24, 2012 at 8:48 AM
> >> Subject: Re: [Bloat] New Cerowrt user; surprises
> >> To: Anthony Lieuallen <arantius@gmail.com>
> >> Cc: bloat@lists.bufferbloat.net
> >>
> >>
> >> Up until very recently (prior release) cerowrt used bind9, with a
> >> split view, hiding the internal dns names from the outside world. So
> >> the port was open and safe to use. But with the switch to dnsmasq, I'd
> >> left that port open, which is definately a hole that should be closed
> >> by anyone using it on the open internet. On the gripping hand, I was
> >> hoping to go back to using bind at some point.
> >>
> >>
> >> On Wed, Oct 24, 2012 at 6:50 AM, Anthony Lieuallen <arantius@gmail.com>
> >> wrote:
> >> > I read that it's not intended to be, but I've just installed Cerowrt
> as
> >> my
> >> > primary router at home.  I was surprised by the fact that:
> >> >
> >> > * The list of open/filtered ports in an external nmap is bigger than I
> >> > expect.  I saw the explanation for some of them like ftp/telnet.
> >>
> >> I like the ftp/telnet trick and would like to see it enhanced to also
> >> insert
> >> firewall rules blocking access to port 81 etc on a telnet attempt. (or
> >> having the config web server also launch from xinetd)
> >>
> >> This would fully thwart attacks from within on the router from things
> >> like dnschanger.
> >>
> >> > * But one of them is DNS, and it's really open, and recursively
> resolving
> >> > for the entire internet.
> >> > * And it's answering private (172.30...) names that the world
> shouldn't
> >> > know.
> >>
> >> Yes, this was a mistake.
> >>
> >> > * I haven't changed any firewalling rules, but the guest wireless
> (gw10)
> >> can
> >> > see the lan (se00) addresses and communicate with them.
> >>
> >> To some extent. Known insecure services are blocked. As the intent is
> >> generally
> >> (for now) to use cerowrt as a test router INSIDE the home, excessive
> >> firewall rules lead to all sorts of headaches.
> >>
> >> >
> >> > I'm sure I could tweak the rules to ""fix"" all of these, but I'm
> surprised
> >> > that this is the default configuration.
> >>
> >> Totally secure by default = unusable by default.
> >>
> >> > And I'm not yet 100% confident of
> >> > the difference between the Firewall pane's ""General Settings"" and
> >> ""Traffic
> >> > Rules"" yet, so I don't want to poke too much.
> >>
> >> /etc/config/firewall contains the rules. I find that and iptables
> >> easier to understand.
> >>
> >> >
> >> > _______________________________________________
> >> > Bloat mailing list
> >> > Bloat@lists.bufferbloat.net
> >> > https://lists.bufferbloat.net/listinfo/bloat
> >> >
> >>
> >>
> > ----------------------------------------
> > Bug #411: dnsmasq dns port open a bad idea
> > https://www.bufferbloat.net/issues/411
> >
> > Author: David Taht
> > Status: New
> > Priority: Urgent
> > Assignee:
> > Category: Build
> > Target version: 1st Public Cerowrt release
> >
> >
> > ---------- Forwarded message ----------
> > From: Dave Taht <dave.taht@gmail.com>
> > Date: Wed, Oct 24, 2012 at 8:48 AM
> > Subject: Re: [Bloat] New Cerowrt user; surprises
> > To: Anthony Lieuallen <arantius@gmail.com>
> > Cc: bloat@lists.bufferbloat.net
> >
> >
> > Up until very recently (prior release) cerowrt used bind9, with a
> > split view, hiding the internal dns names from the outside world. So
> > the port was open and safe to use. But with the switch to dnsmasq, I'd
> > left that port open, which is definately a hole that should be closed
> > by anyone using it on the open internet. On the gripping hand, I was
> > hoping to go back to using bind at some point.
> >
> >
> > On Wed, Oct 24, 2012 at 6:50 AM, Anthony Lieuallen <arantius@gmail.com>
> wrote:
> >> I read that it's not intended to be, but I've just installed Cerowrt as
> my
> >> primary router at home.  I was surprised by the fact that:
> >>
> >> * The list of open/filtered ports in an external nmap is bigger than I
> >> expect.  I saw the explanation for some of them like ftp/telnet.
> >
> > I like the ftp/telnet trick and would like to see it enhanced to also
> insert
> > firewall rules blocking access to port 81 etc on a telnet attempt. (or
> > having the config web server also launch from xinetd)
> >
> > This would fully thwart attacks from within on the router from things
> > like dnschanger.
> >
> >> * But one of them is DNS, and it's really open, and recursively
> resolving
> >> for the entire internet.
> >> * And it's answering private (172.30...) names that the world shouldn't
> >> know.
> >
> > Yes, this was a mistake.
> >
> >> * I haven't changed any firewalling rules, but the guest wireless
> (gw10) can
> >> see the lan (se00) addresses and communicate with them.
> >
> > To some extent. Known insecure services are blocked. As the intent is
> generally
> > (for now) to use cerowrt as a test router INSIDE the home, excessive
> > firewall rules lead to all sorts of headaches.
> >
> >>
> >> I'm sure I could tweak the rules to ""fix"" all of these, but I'm
> surprised
> >> that this is the default configuration.
> >
> > Totally secure by default = unusable by default.
> >
> >> And I'm not yet 100% confident of
> >> the difference between the Firewall pane's ""General Settings"" and
> ""Traffic
> >> Rules"" yet, so I don't want to poke too much.
> >
> > /etc/config/firewall contains the rules. I find that and iptables
> > easier to understand.
> >
> >>
> >> _______________________________________________
> >> Bloat mailing list
> >> Bloat@lists.bufferbloat.net
> >> https://lists.bufferbloat.net/listinfo/bloat
> >>
> >
> >
> ----------------------------------------
> Bug #411: dnsmasq dns port open a bad idea
> https://www.bufferbloat.net/issues/411
>
> Author: David Taht
> Status: New
> Priority: Urgent
> Assignee:
> Category: Build
> Target version: 1st Public Cerowrt release
>
>
> ---------- Forwarded message ----------
> From: Dave Taht <dave.taht@gmail.com>
> Date: Wed, Oct 24, 2012 at 8:48 AM
> Subject: Re: [Bloat] New Cerowrt user; surprises
> To: Anthony Lieuallen <arantius@gmail.com>
> Cc: bloat@lists.bufferbloat.net
>
>
> Up until very recently (prior release) cerowrt used bind9, with a
> split view, hiding the internal dns names from the outside world. So
> the port was open and safe to use. But with the switch to dnsmasq, I'd
> left that port open, which is definately a hole that should be closed
> by anyone using it on the open internet. On the gripping hand, I was
> hoping to go back to using bind at some point.
>
>
> On Wed, Oct 24, 2012 at 6:50 AM, Anthony Lieuallen <arantius@gmail.com>
> wrote:
> > I read that it's not intended to be, but I've just installed Cerowrt as
> my
> > primary router at home.  I was surprised by the fact that:
> >
> > * The list of open/filtered ports in an external nmap is bigger than I
> > expect.  I saw the explanation for some of them like ftp/telnet.
>
> I like the ftp/telnet trick and would like to see it enhanced to also
> insert
> firewall rules blocking access to port 81 etc on a telnet attempt. (or
> having the config web server also launch from xinetd)
>
> This would fully thwart attacks from within on the router from things
> like dnschanger.
>
> > * But one of them is DNS, and it's really open, and recursively resolving
> > for the entire internet.
> > * And it's answering private (172.30...) names that the world shouldn't
> > know.
>
> Yes, this was a mistake.
>
> > * I haven't changed any firewalling rules, but the guest wireless (gw10)
> can
> > see the lan (se00) addresses and communicate with them.
>
> To some extent. Known insecure services are blocked. As the intent is
> generally
> (for now) to use cerowrt as a test router INSIDE the home, excessive
> firewall rules lead to all sorts of headaches.
>
> >
> > I'm sure I could tweak the rules to ""fix"" all of these, but I'm surprised
> > that this is the default configuration.
>
> Totally secure by default = unusable by default.
>
> > And I'm not yet 100% confident of
> > the difference between the Firewall pane's ""General Settings"" and
> ""Traffic
> > Rules"" yet, so I don't want to poke too much.
>
> /etc/config/firewall contains the rules. I find that and iptables
> easier to understand.
>
> >
> > _______________________________________________
> > Bloat mailing list
> > Bloat@lists.bufferbloat.net
> > https://lists.bufferbloat.net/listinfo/bloat
> >
>
>"
411,David Taht,2012-11-24 09:35:45.213534,"I LIKE the sensors for telnet/ftp being there...

On Sat, Nov 24, 2012 at 6:04 PM,  <cerowrt@lists.bufferbloat.net> wrote:
>
> Issue #411 has been updated by Maciej Soltysiak.
>
>
> Cool.
> Maybe update the news/announcement pages for builds affected on
> bufferbloat.net
>
> I'm all for iptables-I zone_wan -j DROP
> Maybe perhaps leave ssh open...
> On 24 Nov 2012 17:22, <cerowrt@lists.bufferbloat.net> wrote:
>
>>
>> Issue #411 has been updated by David Taht.
>>
>>
>> It is fixed in the current source trees, but I've been waiting for
>> other fixed stuff to land.
>>
>> I am very unhappy I inserted this hole in the switch to dnsmasq. I
>> will make sure to stress this in the next release. I don't know what
>> else to do about it, besides keep the list informed....
>>
>> On Sat, Nov 24, 2012 at 5:13 PM,  <cerowrt@lists.bufferbloat.net> wrote:
>> >
>> > Issue #411 has been updated by Maciej Soltysiak.
>> >
>> >
>> > Hi!
>> >
>> > Having DNS open for a while made some evil forces notice it and use my IP
>> > for DNS amplification attacks. I secured dnsmasq not to listen on ge00,
>> but
>> > I'm still getting over 300 UDP packets/s!
>> >
>> > Getting my ISP to block it at their level seems to be PITA and still not
>> > done. I have a subjective feeling the latency has gotten worse and this
>> > traffic is consuming some of the buffers.
>> >
>> > Anyway, my point is that:
>> > 1. This should be fixed in next cero
>> > 2. Perhaps we need an advisory released so that people trying 3.3.8-26
>> > (latest on ftp I think) can avoid participating in this spoofed DNS shit
>> > and see better link performance.
>> >
>> > Waddy a think?
>> >
>> > Maciej
>> > On 24 Oct 2012 18:07, <cerowrt@lists.bufferbloat.net> wrote:
>> >
>> >>
>> >> Issue #411 has been reported by David Taht.
>> >>
>> >> ----------------------------------------
>> >> Bug #411: dnsmasq dns port open a bad idea
>> >> https://www.bufferbloat.net/issues/411
>> >>
>> >> Author: David Taht
>> >> Status: New
>> >> Priority: Normal
>> >> Assignee:
>> >> Category:
>> >> Target version:
>> >>
>> >>
>> >> ---------- Forwarded message ----------
>> >> From: Dave Taht <dave.taht@gmail.com>
>> >> Date: Wed, Oct 24, 2012 at 8:48 AM
>> >> Subject: Re: [Bloat] New Cerowrt user; surprises
>> >> To: Anthony Lieuallen <arantius@gmail.com>
>> >> Cc: bloat@lists.bufferbloat.net
>> >>
>> >>
>> >> Up until very recently (prior release) cerowrt used bind9, with a
>> >> split view, hiding the internal dns names from the outside world. So
>> >> the port was open and safe to use. But with the switch to dnsmasq, I'd
>> >> left that port open, which is definately a hole that should be closed
>> >> by anyone using it on the open internet. On the gripping hand, I was
>> >> hoping to go back to using bind at some point.
>> >>
>> >>
>> >> On Wed, Oct 24, 2012 at 6:50 AM, Anthony Lieuallen <arantius@gmail.com>
>> >> wrote:
>> >> > I read that it's not intended to be, but I've just installed Cerowrt
>> as
>> >> my
>> >> > primary router at home.  I was surprised by the fact that:
>> >> >
>> >> > * The list of open/filtered ports in an external nmap is bigger than I
>> >> > expect.  I saw the explanation for some of them like ftp/telnet.
>> >>
>> >> I like the ftp/telnet trick and would like to see it enhanced to also
>> >> insert
>> >> firewall rules blocking access to port 81 etc on a telnet attempt. (or
>> >> having the config web server also launch from xinetd)
>> >>
>> >> This would fully thwart attacks from within on the router from things
>> >> like dnschanger.
>> >>
>> >> > * But one of them is DNS, and it's really open, and recursively
>> resolving
>> >> > for the entire internet.
>> >> > * And it's answering private (172.30...) names that the world
>> shouldn't
>> >> > know.
>> >>
>> >> Yes, this was a mistake.
>> >>
>> >> > * I haven't changed any firewalling rules, but the guest wireless
>> (gw10)
>> >> can
>> >> > see the lan (se00) addresses and communicate with them.
>> >>
>> >> To some extent. Known insecure services are blocked. As the intent is
>> >> generally
>> >> (for now) to use cerowrt as a test router INSIDE the home, excessive
>> >> firewall rules lead to all sorts of headaches.
>> >>
>> >> >
>> >> > I'm sure I could tweak the rules to ""fix"" all of these, but I'm
>> surprised
>> >> > that this is the default configuration.
>> >>
>> >> Totally secure by default = unusable by default.
>> >>
>> >> > And I'm not yet 100% confident of
>> >> > the difference between the Firewall pane's ""General Settings"" and
>> >> ""Traffic
>> >> > Rules"" yet, so I don't want to poke too much.
>> >>
>> >> /etc/config/firewall contains the rules. I find that and iptables
>> >> easier to understand.
>> >>
>> >> >
>> >> > _______________________________________________
>> >> > Bloat mailing list
>> >> > Bloat@lists.bufferbloat.net
>> >> > https://lists.bufferbloat.net/listinfo/bloat
>> >> >
>> >>
>> >>
>> > ----------------------------------------
>> > Bug #411: dnsmasq dns port open a bad idea
>> > https://www.bufferbloat.net/issues/411
>> >
>> > Author: David Taht
>> > Status: New
>> > Priority: Urgent
>> > Assignee:
>> > Category: Build
>> > Target version: 1st Public Cerowrt release
>> >
>> >
>> > ---------- Forwarded message ----------
>> > From: Dave Taht <dave.taht@gmail.com>
>> > Date: Wed, Oct 24, 2012 at 8:48 AM
>> > Subject: Re: [Bloat] New Cerowrt user; surprises
>> > To: Anthony Lieuallen <arantius@gmail.com>
>> > Cc: bloat@lists.bufferbloat.net
>> >
>> >
>> > Up until very recently (prior release) cerowrt used bind9, with a
>> > split view, hiding the internal dns names from the outside world. So
>> > the port was open and safe to use. But with the switch to dnsmasq, I'd
>> > left that port open, which is definately a hole that should be closed
>> > by anyone using it on the open internet. On the gripping hand, I was
>> > hoping to go back to using bind at some point.
>> >
>> >
>> > On Wed, Oct 24, 2012 at 6:50 AM, Anthony Lieuallen <arantius@gmail.com>
>> wrote:
>> >> I read that it's not intended to be, but I've just installed Cerowrt as
>> my
>> >> primary router at home.  I was surprised by the fact that:
>> >>
>> >> * The list of open/filtered ports in an external nmap is bigger than I
>> >> expect.  I saw the explanation for some of them like ftp/telnet.
>> >
>> > I like the ftp/telnet trick and would like to see it enhanced to also
>> insert
>> > firewall rules blocking access to port 81 etc on a telnet attempt. (or
>> > having the config web server also launch from xinetd)
>> >
>> > This would fully thwart attacks from within on the router from things
>> > like dnschanger.
>> >
>> >> * But one of them is DNS, and it's really open, and recursively
>> resolving
>> >> for the entire internet.
>> >> * And it's answering private (172.30...) names that the world shouldn't
>> >> know.
>> >
>> > Yes, this was a mistake.
>> >
>> >> * I haven't changed any firewalling rules, but the guest wireless
>> (gw10) can
>> >> see the lan (se00) addresses and communicate with them.
>> >
>> > To some extent. Known insecure services are blocked. As the intent is
>> generally
>> > (for now) to use cerowrt as a test router INSIDE the home, excessive
>> > firewall rules lead to all sorts of headaches.
>> >
>> >>
>> >> I'm sure I could tweak the rules to ""fix"" all of these, but I'm
>> surprised
>> >> that this is the default configuration.
>> >
>> > Totally secure by default = unusable by default.
>> >
>> >> And I'm not yet 100% confident of
>> >> the difference between the Firewall pane's ""General Settings"" and
>> ""Traffic
>> >> Rules"" yet, so I don't want to poke too much.
>> >
>> > /etc/config/firewall contains the rules. I find that and iptables
>> > easier to understand.
>> >
>> >>
>> >> _______________________________________________
>> >> Bloat mailing list
>> >> Bloat@lists.bufferbloat.net
>> >> https://lists.bufferbloat.net/listinfo/bloat
>> >>
>> >
>> >
>> ----------------------------------------
>> Bug #411: dnsmasq dns port open a bad idea
>> https://www.bufferbloat.net/issues/411
>>
>> Author: David Taht
>> Status: New
>> Priority: Urgent
>> Assignee:
>> Category: Build
>> Target version: 1st Public Cerowrt release
>>
>>
>> ---------- Forwarded message ----------
>> From: Dave Taht <dave.taht@gmail.com>
>> Date: Wed, Oct 24, 2012 at 8:48 AM
>> Subject: Re: [Bloat] New Cerowrt user; surprises
>> To: Anthony Lieuallen <arantius@gmail.com>
>> Cc: bloat@lists.bufferbloat.net
>>
>>
>> Up until very recently (prior release) cerowrt used bind9, with a
>> split view, hiding the internal dns names from the outside world. So
>> the port was open and safe to use. But with the switch to dnsmasq, I'd
>> left that port open, which is definately a hole that should be closed
>> by anyone using it on the open internet. On the gripping hand, I was
>> hoping to go back to using bind at some point.
>>
>>
>> On Wed, Oct 24, 2012 at 6:50 AM, Anthony Lieuallen <arantius@gmail.com>
>> wrote:
>> > I read that it's not intended to be, but I've just installed Cerowrt as
>> my
>> > primary router at home.  I was surprised by the fact that:
>> >
>> > * The list of open/filtered ports in an external nmap is bigger than I
>> > expect.  I saw the explanation for some of them like ftp/telnet.
>>
>> I like the ftp/telnet trick and would like to see it enhanced to also
>> insert
>> firewall rules blocking access to port 81 etc on a telnet attempt. (or
>> having the config web server also launch from xinetd)
>>
>> This would fully thwart attacks from within on the router from things
>> like dnschanger.
>>
>> > * But one of them is DNS, and it's really open, and recursively resolving
>> > for the entire internet.
>> > * And it's answering private (172.30...) names that the world shouldn't
>> > know.
>>
>> Yes, this was a mistake.
>>
>> > * I haven't changed any firewalling rules, but the guest wireless (gw10)
>> can
>> > see the lan (se00) addresses and communicate with them.
>>
>> To some extent. Known insecure services are blocked. As the intent is
>> generally
>> (for now) to use cerowrt as a test router INSIDE the home, excessive
>> firewall rules lead to all sorts of headaches.
>>
>> >
>> > I'm sure I could tweak the rules to ""fix"" all of these, but I'm surprised
>> > that this is the default configuration.
>>
>> Totally secure by default = unusable by default.
>>
>> > And I'm not yet 100% confident of
>> > the difference between the Firewall pane's ""General Settings"" and
>> ""Traffic
>> > Rules"" yet, so I don't want to poke too much.
>>
>> /etc/config/firewall contains the rules. I find that and iptables
>> easier to understand.
>>
>> >
>> > _______________________________________________
>> > Bloat mailing list
>> > Bloat@lists.bufferbloat.net
>> > https://lists.bufferbloat.net/listinfo/bloat
>> >
>>
>>
> ----------------------------------------
> Bug #411: dnsmasq dns port open a bad idea
> https://www.bufferbloat.net/issues/411
>
> Author: David Taht
> Status: New
> Priority: Urgent
> Assignee:
> Category: Build
> Target version: 1st Public Cerowrt release
>
>
> ---------- Forwarded message ----------
> From: Dave Taht <dave.taht@gmail.com>
> Date: Wed, Oct 24, 2012 at 8:48 AM
> Subject: Re: [Bloat] New Cerowrt user; surprises
> To: Anthony Lieuallen <arantius@gmail.com>
> Cc: bloat@lists.bufferbloat.net
>
>
> Up until very recently (prior release) cerowrt used bind9, with a
> split view, hiding the internal dns names from the outside world. So
> the port was open and safe to use. But with the switch to dnsmasq, I'd
> left that port open, which is definately a hole that should be closed
> by anyone using it on the open internet. On the gripping hand, I was
> hoping to go back to using bind at some point.
>
>
> On Wed, Oct 24, 2012 at 6:50 AM, Anthony Lieuallen <arantius@gmail.com> wrote:
>> I read that it's not intended to be, but I've just installed Cerowrt as my
>> primary router at home.  I was surprised by the fact that:
>>
>> * The list of open/filtered ports in an external nmap is bigger than I
>> expect.  I saw the explanation for some of them like ftp/telnet.
>
> I like the ftp/telnet trick and would like to see it enhanced to also insert
> firewall rules blocking access to port 81 etc on a telnet attempt. (or
> having the config web server also launch from xinetd)
>
> This would fully thwart attacks from within on the router from things
> like dnschanger.
>
>> * But one of them is DNS, and it's really open, and recursively resolving
>> for the entire internet.
>> * And it's answering private (172.30...) names that the world shouldn't
>> know.
>
> Yes, this was a mistake.
>
>> * I haven't changed any firewalling rules, but the guest wireless (gw10) can
>> see the lan (se00) addresses and communicate with them.
>
> To some extent. Known insecure services are blocked. As the intent is generally
> (for now) to use cerowrt as a test router INSIDE the home, excessive
> firewall rules lead to all sorts of headaches.
>
>>
>> I'm sure I could tweak the rules to ""fix"" all of these, but I'm surprised
>> that this is the default configuration.
>
> Totally secure by default = unusable by default.
>
>> And I'm not yet 100% confident of
>> the difference between the Firewall pane's ""General Settings"" and ""Traffic
>> Rules"" yet, so I don't want to poke too much.
>
> /etc/config/firewall contains the rules. I find that and iptables
> easier to understand.
>
>>
>> _______________________________________________
>> Bloat mailing list
>> Bloat@lists.bufferbloat.net
>> https://lists.bufferbloat.net/listinfo/bloat
>>
>
>"
362,David Taht,2012-11-25 00:22:00.356298,"I would like to fix this somehow before the next release.

what is the current status of the in tree vs out of tree code?"
362,Maciej Soltysiak,2012-11-25 04:38:43.809518,"For UPNP this is required. I tried a git commit today but I'm not familiar
with git that much.

This patch uses cero iface names. Listens only on 'secure' interfaces such
as ethernet and non-guest wlans.

diff --git a/net/miniupnpd/files/upnpd.config
b/net/miniupnpd/files/upnpd.config
index 02b4b2a..afa97da 100644
--- a/net/miniupnpd/files/upnpd.config
+++ b/net/miniupnpd/files/upnpd.config
@@ -5,8 +5,8 @@ config upnpd config
        option log_output       0
        option download         1024
        option upload           512
-       option external_iface   wan
-       option internal_iface   lan
+       option external_iface   'ge00'
+       option internal_iface   'se00 sw00 sw10'
        option port             5000
 config perm_rule


On Sun, Nov 25, 2012 at 9:22 AM, <cerowrt@lists.bufferbloat.net> wrote:

>
> Issue #362 has been updated by David Taht.
>
>
> I would like to fix this somehow before the next release.
>
> what is the current status of the in tree vs out of tree code?
> ----------------------------------------
> Bug #362: upnp, natpmp, mdnsresponder borked
> https://www.bufferbloat.net/issues/362
>
> Author: David Taht
> Status: New
> Priority: Normal
> Assignee:
> Category:
> Target version: 1st Public Cerowrt release
>
>
> I really haven't been paying attention to those packages.I was doing some
> work
>
> I am creating a bug for this, please update me there.
>
> What is a good way to test the functionality of these packages?
>
> ---------- Forwarded message ----------
> From: Maciej Soltysiak <maciej@soltysiak.com>
> Date: Wed, Apr 11, 2012 at 12:37 PM
> Subject: Re: [Cerowrt-devel] some of the advanced stuff (sort of) in
> cerowrt
> To: Dave Taht <dave.taht@gmail.com>
> Cc: cerowrt-devel@lists.bufferbloat.net
>
>
> Hi!
>
>
> 2) UPNP / NATPMP / mDNSresponder - to help different apps reaching out
> - i am sort of losing grasp of which package does what, they seem to
> be intertwined (?) but cero has these packages currently (3.3.1-4)
> broken.
> 3) miniDLNA - DLNA is a good low-latency (?) / high-throughput
> use-case within the wireless (laptops, picture frames) and wired (TV,
> NAS) home network. Also minidlna package is broken too.
>
>"
362,Maciej Soltysiak,2012-11-25 04:40:21.679561,"And this for minissdpd:

diff --git a/net/minissdpd/files/minissdpd.config
b/net/minissdpd/files/minissdp
index 979f855..2c1e638 100644
--- a/net/minissdpd/files/minissdpd.config
+++ b/net/minissdpd/files/minissdpd.config
@@ -1,4 +1,4 @@
 config 'minissdpd' 'config'
        option 'enabled' '1'
        option 'log_output' '0'
-       option 'internal_iface' 'lan'
+       option 'internal_iface' 'se00 sw00 sw10'


On Sun, Nov 25, 2012 at 1:38 PM, <cerowrt@lists.bufferbloat.net> wrote:

>
> Issue #362 has been updated by Maciej Soltysiak.
>
>
> For UPNP this is required. I tried a git commit today but I'm not familiar
> with git that much.
>
> This patch uses cero iface names. Listens only on 'secure' interfaces such
> as ethernet and non-guest wlans.
>
> diff --git a/net/miniupnpd/files/upnpd.config
> b/net/miniupnpd/files/upnpd.config
> index 02b4b2a..afa97da 100644
> --- a/net/miniupnpd/files/upnpd.config
> +++ b/net/miniupnpd/files/upnpd.config
> @@ -5,8 +5,8 @@ config upnpd config
>         option log_output       0
>         option download         1024
>         option upload           512
> -       option external_iface   wan
> -       option internal_iface   lan
> +       option external_iface   'ge00'
> +       option internal_iface   'se00 sw00 sw10'
>         option port             5000
>  config perm_rule
>
>
> On Sun, Nov 25, 2012 at 9:22 AM, <cerowrt@lists.bufferbloat.net> wrote:
>
> >
> > Issue #362 has been updated by David Taht.
> >
> >
> > I would like to fix this somehow before the next release.
> >
> > what is the current status of the in tree vs out of tree code?
> > ----------------------------------------
> > Bug #362: upnp, natpmp, mdnsresponder borked
> > https://www.bufferbloat.net/issues/362
> >
> > Author: David Taht
> > Status: New
> > Priority: Normal
> > Assignee:
> > Category:
> > Target version: 1st Public Cerowrt release
> >
> >
> > I really haven't been paying attention to those packages.I was doing some
> > work
> >
> > I am creating a bug for this, please update me there.
> >
> > What is a good way to test the functionality of these packages?
> >
> > ---------- Forwarded message ----------
> > From: Maciej Soltysiak <maciej@soltysiak.com>
> > Date: Wed, Apr 11, 2012 at 12:37 PM
> > Subject: Re: [Cerowrt-devel] some of the advanced stuff (sort of) in
> > cerowrt
> > To: Dave Taht <dave.taht@gmail.com>
> > Cc: cerowrt-devel@lists.bufferbloat.net
> >
> >
> > Hi!
> >
> >
> > 2) UPNP / NATPMP / mDNSresponder - to help different apps reaching out
> > - i am sort of losing grasp of which package does what, they seem to
> > be intertwined (?) but cero has these packages currently (3.3.1-4)
> > broken.
> > 3) miniDLNA - DLNA is a good low-latency (?) / high-throughput
> > use-case within the wireless (laptops, picture frames) and wired (TV,
> > NAS) home network. Also minidlna package is broken too.
> >
> >
> ----------------------------------------
> Bug #362: upnp, natpmp, mdnsresponder borked
> https://www.bufferbloat.net/issues/362
>
> Author: David Taht
> Status: New
> Priority: Normal
> Assignee:
> Category:
> Target version: 1st Public Cerowrt release
>
>
> I really haven't been paying attention to those packages.I was doing some
> work
>
> I am creating a bug for this, please update me there.
>
> What is a good way to test the functionality of these packages?
>
> ---------- Forwarded message ----------
> From: Maciej Soltysiak <maciej@soltysiak.com>
> Date: Wed, Apr 11, 2012 at 12:37 PM
> Subject: Re: [Cerowrt-devel] some of the advanced stuff (sort of) in
> cerowrt
> To: Dave Taht <dave.taht@gmail.com>
> Cc: cerowrt-devel@lists.bufferbloat.net
>
>
> Hi!
>
>
> 2) UPNP / NATPMP / mDNSresponder - to help different apps reaching out
> - i am sort of losing grasp of which package does what, they seem to
> be intertwined (?) but cero has these packages currently (3.3.1-4)
> broken.
> 3) miniDLNA - DLNA is a good low-latency (?) / high-throughput
> use-case within the wireless (laptops, picture frames) and wired (TV,
> NAS) home network. Also minidlna package is broken too.
>
>"
113,Mario Lopez,2012-11-30 05:12:26.728318,"I keep hoping someone with familiarity with the ntp codebase will take a stab at it. I looked, and the 'right thing' is to revalidate after you get enough time servers to get time so dnssec can validate
http://speed-up-pc.org"
415,Dave Täht,2012-12-03 03:34:49.490587,"bind9 can be installed on sugarland and later via:

<pre>
 opkg update; opkg install bind-latest bind-latest-config
# (various other tools available as ""bind-latest-something"") 
 turning off dnsmasq's port 53 to port 0
 /etc/init.d/xinetd restart

you will inevitably run into bug #113 and at this point I would only recomend trying bind on the 3800 with 128MB of memory."
413,Dave Täht,2012-12-03 03:35:39.131665,"there is a new tiny dhcp6-pd daemon under development that I will try next. continuing with the dead wide, and the huge dibbler and isc-dhcp is not worth it."
406,Dave Täht,2012-12-03 03:36:43.99077,"I have no idea what's going to happen vs a vs dnsmasq vs quagga vs the new relay6d stuff.

I'm just happy radvd is going to go away. soon."
325,Mario Lopez,2012-12-10 09:42:16.733414,"I used this solution for an error at the server for ""wlzine"":http://wlzine.com/ways-how-to-lose-weight-fast/ and it worked like a charm. Thank you for this."
362,Stephen Walker,2012-12-17 20:12:50.471266,Commit e7e5dcf to ceropackages-3.3 has the iface name changes.
330,Evan Hunt,2012-12-20 08:14:00.039094,"Evan Hunt wrote:
> If it happens again on October 6 I'll definitely let you know.

Well it didn't happen on October 6, though the box did spontaneously reboot on morning of the Mayan Apocalypse, so I'm going to close this ticket lest I anger the gods further."
418,David Taht,2013-01-04 19:06:30.869512,"I had been building up a 3.7.1-X based testbed anyway, which looks (in part) like this:

<pre>
3.6.8 laptop (presently) with iwl wifi driver

traceroute to 172.26.3.4 (172.26.3.4), 30 hops max, 60 byte packets
 1  172.26.2.1  2.978 ms  2.890 ms  10.955 ms   picostation 2HP (wireless)
 2  172.26.1.4  10.934 ms  10.903 ms  10.868 ms nanostation m5 (wired)
 3  172.26.1.1  13.826 ms  13.802 ms  13.785 ms nanostation m5 (wired)
 4  172.26.3.224  16.374 ms  16.366 ms  16.361 ms cerowrt 3.7.1-1 adhoc mesh
 5  172.26.3.4  16.355 ms  16.327 ms  16.296 ms x86_64 box with 3.7.1-1 on it
</pre>

so future tests will be against that for a while. "
418,David Taht,2013-01-04 19:21:34.415912,"In an effort to duplicate ketan's bug, I first setup a x86_64 box as a web and polipo (with tfo patch) server on the other side of the testbed. And ran three tests, using httping to issue a full GET request (as opposed to HEAD), once with tfo disabled, another time via polipo with tfo off in polipo, and the last with it on. 

The commands:

<pre>
 httping -G -F http://172.26.3.4/~d/rrul/vyatta-fq_codel_bql32k.svg
 httping -x 172.26.3.4:8123 -G -F http://172.26.3.4/~d/rrul/vyatta-fq_codel_bql32k.svg
 httping -x 172.26.3.4:8123 -G -F http://172.26.3.4/~d/rrul/vyatta-fq_codel_bql32k.svg
</pre>

The capture script (note you'd have to change this to port 80 for proxyless and your own server ip)

<pre>
tcpdump -i wlan1 -w tfo_to_x86_64_web_via_proxy_tfo_enabled.cap port 8123 and host 172.26.3.4
</pre>

Going 3.6.8 to 3.7.1 over x86_64 over this network... worked! The performance improvement of TFO on vs off over the proxy OVER this multi-hope WIFI connection was remarkable:

<pre>

root@ida:~/src/httping-1.5.6# httping -x 172.26.3.4:8123 -G -Fw http://172.26.3.4/~d/rrul/vyatta-fq_codel_bql32k.svg
Using proxyserver: 172.26.3.4:8123
PING 172.26.3.4:80 (http://172.26.3.4/~d/rrul/vyatta-fq_codel_bql32k.svg):
connected to 172.26.3.4:80 (273 bytes), seq=0 time=11.47 ms 
connected to 172.26.3.4:80 (273 bytes), seq=1 time=12.82 ms 
connected to 172.26.3.4:80 (273 bytes), seq=2 time=10.79 ms 
connected to 172.26.3.4:80 (273 bytes), seq=3 time=9.92 ms 
connected to 172.26.3.4:80 (274 bytes), seq=4 time=10.76 ms 
connected to 172.26.3.4:80 (274 bytes), seq=5 time=12.01 ms 
connected to 172.26.3.4:80 (274 bytes), seq=6 time=13.64 ms 
connected to 172.26.3.4:80 (274 bytes), seq=7 time=11.10 ms 
Got signal 2
--- http://172.26.3.4/~d/rrul/vyatta-fq_codel_bql32k.svg ping statistics ---
8 connects, 8 ok, 0.00% failed, time 7695ms
round-trip min/avg/max = 9.9/11.6/13.6 ms

root@ida:~/src/httping-1.5.6# httping -x 172.26.3.4:8123 -G -F http://172.26.3.4/~d/rrul/vyatta-fq_codel_bql32k.svg
Using proxyserver: 172.26.3.4:8123
PING 172.26.3.4:80 (http://172.26.3.4/~d/rrul/vyatta-fq_codel_bql32k.svg):
connected to 172.26.3.4:80 (274 bytes), seq=0 time=9.69 ms 
connected to 172.26.3.4:80 (274 bytes), seq=1 time=5.57 ms 
connected to 172.26.3.4:80 (274 bytes), seq=2 time=10.11 ms 
connected to 172.26.3.4:80 (274 bytes), seq=3 time=8.11 ms 
connected to 172.26.3.4:80 (274 bytes), seq=4 time=6.61 ms 
connected to 172.26.3.4:80 (274 bytes), seq=5 time=5.71 ms 
connected to 172.26.3.4:80 (274 bytes), seq=6 time=5.78 ms 
</pre>

If this stuff can actually be made secure and deployable, it's going to be a big win on web servers and proxies and a variety of other connect time sensitive TCP based applications.

(I included the actual rrul file I was transferring for completeness, which is showing this odd periodic spike in loss being incurred somewhere on the path elsewhere.... and has nothing to do with the TFO test...)"
418,David Taht,2013-01-04 19:57:06.355983,"Heh. Spoke too soon on the performance front. The packet capture shows the 3.6.11 middlebox shipping a RST on the first big packet.... it appears to have conntracking on but little else.

<pre>

root@closet:~# uname -a
Linux closet.wifi.armory.com 3.6.11 #2 Mon Dec 24 05:24:18 PST 2012 mips GNU/Linux
root@closet:~# iptables -L
Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED
ACCEPT     all  --  anywhere             anywhere            
input_rule  all  --  anywhere             anywhere            
input      all  --  anywhere             anywhere            

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED
forwarding_rule  all  --  anywhere             anywhere            
forward    all  --  anywhere             anywhere            

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED
ACCEPT     all  --  anywhere             anywhere            
output_rule  all  --  anywhere             anywhere            
output     all  --  anywhere             anywhere            

Chain forward (1 references)
target     prot opt source               destination         

Chain forwarding_rule (1 references)
target     prot opt source               destination         

Chain input (1 references)
target     prot opt source               destination         

Chain input_rule (1 references)
target     prot opt source               destination         

Chain output (1 references)
target     prot opt source               destination         

Chain output_rule (1 references)
target     prot opt source               destination         

Chain reject (0 references)
target     prot opt source               destination         
REJECT     tcp  --  anywhere             anywhere             reject-with tcp-reset
REJECT     all  --  anywhere             anywhere             reject-with icmp-port-unreachable

</pre>
"
418,David Taht,2013-01-04 20:03:03.369838,"flushed iptables rules, similar result, capture attached...

Need to simplify the test a bit, a few too many machines in the way right now"
418,Ketan Kulkarni,2013-01-05 10:31:06.215952,"Dave, the RST you are getting is probably the behavior of httping.
By default httping accepts only 4096 bytes of data and after than it simply closes the socket. (closing a socket when data is pending to read will send the RST).
Even I could see the same behavior when I tried -G (using GET for a larger file) on localhost.

Try adding these options to your httping cmd if you are using -G
-b -X -L 100000

-L -> configures the size of the data that you want to receive after which httping will just close the connection.
-b to show transfer speed
-X to show how much data was transferred in a single ping."
418,Ketan Kulkarni,2013-01-05 10:33:59.950636,"BTW, I am just using the HEAD request by default which then
automatically limits the response to a single packet.
Don't you think this is better way to test the http latency than to
completely download the file using GET?

Thanks,

On Sun, Jan 6, 2013 at 12:01 AM,  <cerowrt@lists.bufferbloat.net> wrote:
>
> Issue #418 has been updated by Ketan Kulkarni.
>
>
> Dave, the RST you are getting is probably the behavior of httping.
> By default httping accepts only 4096 bytes of data and after than it simply closes the socket. (closing a socket when data is pending to read will send the RST).
> Even I could see the same behavior when I tried -G (using GET for a larger file) on localhost.
>
> Try adding these options to your httping cmd if you are using -G
> -b -X -L 100000
>
> -L -> configures the size of the data that you want to receive after which httping will just close the connection.
> -b to show transfer speed
> -X to show how much data was transferred in a single ping.
> ----------------------------------------
> Bug #418: TFO crashes cerowrt 3.7.1-1
> https://www.bufferbloat.net/issues/418
>
> Author: David Taht
> Status: New
> Priority: Normal
> Assignee: Dave Täht
> Category: Networking
> Target version:
>
>
> I am not able to get through even a single TCP TFO connection. The router restarts as soon as it sees the TFO connection.
>
> Looks like SYN+Data is crashing the box (see attached trace captured on lo iface of cero). logread, dmesg did not show anything. I don't know whether its kernel panic.
>
> This is strange as 3.6 was working for SYN+Data cases.
>
> However the difference from previous instance is the polipo server with TFO running on cero box. Client may run on same cero or on my laptop which in either case crashes the box.
>
> On 3.7, if I run the TFO client on cero box and TFO server on the laptop, it still works but not the reverse.
>
> (see email thread at: https://lists.bufferbloat.net/pipermail/cerowrt-devel/2013-January/000844.html for more details)
>
>"
418,Ketan Kulkarni,2013-01-05 10:58:46.388008,"Disabling ECN on cero and TFO ON has no effect.
The crash is still seen on cero.

This is the trace I get (similar to lo_capture.txt with ECN disabled)

root@OpenWrt:~# httping -F -g http://127.0.0.1:8123/
PING 127.0.0.1:8123 (http://127.0.0.1:8123/):
18:15:37.736001 IP localhost.39443 > localhost.8123: Flags [S], seq 4217980186, win 43690, options [mss 65495,sackOK,TS val 343024 ecr 0,nop,wscale 6,Unknown Option 254f989], length 0
18:15:37.736121 IP localhost.8123 > localhost.39443: Flags [S.], seq 1926633800, ack 4217980187, win 43690, options [mss 65495,sackOK,TS val 343024 ecr 343024,nop,wscale 6,Unknown Option 254f989df087214939732ef], length 0
18:15:37.736174 IP localhost.39443 > localhost.8123: Flags [.], ack 1, win 683, options [nop,nop,TS val 343024 ecr 343024], length 0
connected to 127.0.0.1:8123 (183 bytes), seq=0 time=3.21 ms 
18:15:37.737372 IP localhost.39443 > localhost.8123: Flags [P.], seq 1:65, ack 1, win 683, options [nop,nop,TS val 343024 ecr 343024], length 64
18:15:37.737538 IP localhost.8123 > localhost.39443: Flags [.], ack 65, win 683, options [nop,nop,TS val 343024 ecr 343024], length 0
18:15:37.738395 IP localhost.8123 > localhost.39443: Flags [P.], seq 1:184, ack 65, win 683, options [nop,nop,TS val 343025 ecr 343024], length 183
18:15:37.738565 IP localhost.8123 > localhost.39443: Flags [F.], seq 184, ack 65, win 683, options [nop,nop,TS val 343025 ecr 343024], length 0
18:15:37.738682 IP localhost.39443 > localhost.8123: Flags [.], ack 184, win 700, options [nop,nop,TS val 343025 ecr 343025], length 0
18:15:37.738953 IP localhost.39443 > localhost.8123: Flags [F.], seq 65, ack 185, win 700, options [nop,nop,TS val 343025 ecr 343025], length 0
18:15:37.739063 IP localhost.8123 > localhost.39443: Flags [.], ack 66, win 683, options [nop,nop,TS val 343025 ecr 343025], length 0
"
418,David Taht,2013-01-05 11:59:52.563515,"On Sat, Jan 5, 2013 at 1:34 PM,  <cerowrt@lists.bufferbloat.net> wrote:
>
> Issue #418 has been updated by Ketan Kulkarni.
>
>
> BTW, I am just using the HEAD request by default which then
> automatically limits the response to a single packet.
> Don't you think this is better way to test the http latency than to
> completely download the file using GET?

Depends on what you were testing for. ME, I was working on looking at
wifi aggregate behavior over the mesh network and doing a GET to grab
a file with 40K in it (less than one aggregate) seemed sane at the
time.

Didn't know that httping cut off at 4k with the RST, so my test was
invalid. Thank you for the modified version!

Am also glad it wasn't the middle box!

certainly if all we want to do is test the time of a tcp setup, a head
request is saner.


>
> Thanks,
>
> On Sun, Jan 6, 2013 at 12:01 AM,  <cerowrt@lists.bufferbloat.net> wrote:
>>
>> Issue #418 has been updated by Ketan Kulkarni.
>>
>>
>> Dave, the RST you are getting is probably the behavior of httping.
>> By default httping accepts only 4096 bytes of data and after than it simply closes the socket. (closing a socket when data is pending to read will send the RST).
>> Even I could see the same behavior when I tried -G (using GET for a larger file) on localhost.
>>
>> Try adding these options to your httping cmd if you are using -G
>> -b -X -L 100000
>>
>> -L -> configures the size of the data that you want to receive after which httping will just close the connection.
>> -b to show transfer speed
>> -X to show how much data was transferred in a single ping.
>> ----------------------------------------
>> Bug #418: TFO crashes cerowrt 3.7.1-1
>> https://www.bufferbloat.net/issues/418
>>
>> Author: David Taht
>> Status: New
>> Priority: Normal
>> Assignee: Dave Täht
>> Category: Networking
>> Target version:
>>
>>
>> I am not able to get through even a single TCP TFO connection. The router restarts as soon as it sees the TFO connection.
>>
>> Looks like SYN+Data is crashing the box (see attached trace captured on lo iface of cero). logread, dmesg did not show anything. I don't know whether its kernel panic.
>>
>> This is strange as 3.6 was working for SYN+Data cases.
>>
>> However the difference from previous instance is the polipo server with TFO running on cero box. Client may run on same cero or on my laptop which in either case crashes the box.
>>
>> On 3.7, if I run the TFO client on cero box and TFO server on the laptop, it still works but not the reverse.
>>
>> (see email thread at: https://lists.bufferbloat.net/pipermail/cerowrt-devel/2013-January/000844.html for more details)
>>
>>
> ----------------------------------------
> Bug #418: TFO crashes cerowrt 3.7.1-1
> https://www.bufferbloat.net/issues/418
>
> Author: David Taht
> Status: New
> Priority: Normal
> Assignee: Dave Täht
> Category: Networking
> Target version:
>
>
> I am not able to get through even a single TCP TFO connection. The router restarts as soon as it sees the TFO connection.
>
> Looks like SYN+Data is crashing the box (see attached trace captured on lo iface of cero). logread, dmesg did not show anything. I don't know whether its kernel panic.
>
> This is strange as 3.6 was working for SYN+Data cases.
>
> However the difference from previous instance is the polipo server with TFO running on cero box. Client may run on same cero or on my laptop which in either case crashes the box.
>
> On 3.7, if I run the TFO client on cero box and TFO server on the laptop, it still works but not the reverse.
>
> (see email thread at: https://lists.bufferbloat.net/pipermail/cerowrt-devel/2013-January/000844.html for more details)
>
>"
418,David Taht,2013-01-08 08:15:46.071152,"While I acquired a serial adaptor for the 3800 I did not gain the time
to look at this issue over the weekend.

I'm buried this week and may not be able to get to this til the weekend."
418,Ketan Kulkarni,2013-01-13 03:14:58.402801,"I could get a chance to get the backtrace from serial port.
I didnt do the kgdb session yet.

[ 1024.530000] Kernel bug detected[#1]:
[ 1024.530000] Cpu 0
[ 1024.530000] $ 0   : 00000000 00000000 00000001 00000014
[ 1024.530000] $ 4   : 8600a9a0 85446cc0 00000000 377f8397
[ 1024.530000] $ 8   : 00000000 00000000 00000000 204e7f80
[ 1024.530000] $12   : 39808080 00000007 00000000 00000000
[ 1024.530000] $16   : 85446cc0 854fb280 8600a500 00000000
[ 1024.530000] $20   : 85446cc0 80340000 00000006 803aac70
[ 1024.530000] $24   : 00000000 c0aa90d8
[ 1024.530000] $28   : 854c2000 854c3ad8 8033c050 8024a36c
[ 1024.530000] Hi    : 00000000
[ 1024.530000] Lo    : 00000000
[ 1024.530000] epc   : 801fc7f4 reqsk_fastopen_remove+0x30/0x17c
[ 1024.530000]     Tainted: G           O
[ 1024.530000] ra    : 8024a36c tcp_rcv_state_process+0x7b4/0xc28
[ 1024.530000] Status: 1000fc03    KERNEL EXL IE
[ 1024.530000] Cause : 10800034
[ 1024.530000] PrId  : 00019374 (MIPS 24Kc)
[ 1024.530000] Modules linked in: sch_teql sch_tbf sch_sfq sch_red
sch_qfq sch_prio sch_ns2_codel sch_nfq_codel sch_netem sch_htb
sch_gred sch_efq_codel sch_dsmark em_text em_nbyte em_meta em_cmp
cls_basic act_police act_ipt act_connmark act_skbedit act_mirred
em_u32 cls_u32 cls_tcindex cls_flow cls_route cls_fw sch_hfsc
sch_fq_codel sch_codel sch_ingress ath79_wdt xt_hashlimit xt_set(O)
ip_set_list_set(O) ip_set_hash_netport(O) ip_set_hash_netiface(O)
ip_set_hash_net(O) ip_set_hash_ipportnet(O) ip_set_hash_ipportip(O)
ip_set_hash_ipport(O) ip_set_hash_ip(O) ip_set_bitmap_port(O)
ip_set_bitmap_ipmac(O) ip_set_bitmap_ip(O) ip_set(O) ip6t_REJECT
ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah
ip6table_raw ip6table_mangle ip6table_filter ip6_tables
nf_conntrack_ipv6 nf_defrag_ipv6 nfnetlink nf_nat_irc nf_nat_ftp
nf_conntrack_irc nf_conntrack_ftp xt_policy xt_esp ipt_ah xt_HL xt_hl
xt_ecn ipt_ECN xt_CLASSIFY xt_time xt_tcpmss xt_statistic xt_mark
xt_length xt_DSCP xt_dscp xt_string xt_layer7 xt_quota xt_pkttype
xt_physdev xt_owner ipt_MASQUERADE iptable_nat xt_nat nf_nat_ipv4
nf_nat xt_recent xt_helper xt_connmark xt_connbytes pptp pppoe
xt_conntrack xt_CT iptable_raw xt_state nf_conntrack_ipv4
nf_defrag_ipv4 nf_conntrack pppox ipt_REJECT xt_TCPMSS xt_LOG
xt_comment xt_multiport xt_mac xt_limit iptable_mangle iptable_filter
ip_tables xt_tcpudp x_tables ip_gre gre ifb sit xfrm4_tunnel
xfrm4_mode_tunnel xfrm4_mode_transport xfrm4_mode_beet esp4 ah4
tunnel4 tun tcp_ledbat(O) ppp_async ppp_generic slhc xfrm_user
xfrm_algo vfat fat autofs4 button_hotplug(O) ath9k(O) ath9k_common(O)
ath9k_hw(O) ath(O) nls_utf8 nls_iso8859_2 nls_iso8859_15
nls_iso8859_13 nls_iso8859_1 nls_cp437 mac80211(O) ts_fsm ts_bm ts_kmp
crc_ccitt ipv6 input_polldev cfg80211(O) compat(O) input_core
sha1_generic md5 hmac des_generic deflate cbc authenc arc4 usb_storage
ohci_hcd ehci_hcd sd_mod ext4 jbd2 mbcache usbcore usb_common scsi_mod
nls_base crc16 zlib_inflate zlib_deflate ledtrig_timer
ledtrig_default_on leds_gpio gpio_button_hotplug(O)
[ 1024.530000] Process seq (pid: 4023, threadinfo=854c2000,
task=85461df8, tls=7735b440)
[ 1024.530000] Stack : 00000000 8600a9a0 87287d80 8607bb58 85446cc0
80330000 8600a9a0 87287d80
        8607bb58 8024a36c c0aa9720 c2337090 86b39000 00000000 00000001 00000014
        00000001 02000004 862b6d24 c2337000 00000001 8547bf00 00000000 00000000
        854c3bcc 854c3bcc 87287d80 854c3bcc 87287d80 80325dd8 87287d80 8600a9a0
        8600a9a0 8607bb58 8607bb44 802516ec 87287d80 803261dc 80340000 80340000
        ...
[ 1024.530000] Call Trace:
[ 1024.530000] [<801fc7f4>] reqsk_fastopen_remove+0x30/0x17c
[ 1024.530000] [<8024a36c>] tcp_rcv_state_process+0x7b4/0xc28
[ 1024.530000] [<802516ec>] tcp_v4_do_rcv+0x21c/0x274
[ 1024.530000] [<80253c74>] tcp_v4_rcv+0x5b4/0x974
[ 1024.530000] [<802320f0>] ip_local_deliver_finish+0x168/0x29c
[ 1024.530000] [<80207100>] __netif_receive_skb+0x63c/0x6c0
[ 1024.530000] [<c060b2e8>] ieee80211_deliver_skb+0x1b8/0x220 [mac80211]
[ 1024.530000] [<c060cc70>]
ieee80211_rx_handlers.part.12+0x1654/0x23e0 [mac80211]
[ 1024.530000] [<c060e468>]
ieee80211_prepare_and_rx_handle+0xa6c/0xaf0 [mac80211]
[ 1024.530000] [<c060ecfc>] ieee80211_rx+0x810/0x8d8 [mac80211]
[ 1024.530000] [<c078651c>] ath_rx_tasklet+0xf4c/0x10a4 [ath9k]
[ 1024.530000] [<c078437c>] ath9k_tasklet+0x104/0x174 [ath9k]
[ 1024.530000] [<800793b8>] tasklet_action+0x78/0xc8
[ 1024.530000] [<80078c08>] __do_softirq+0xb0/0x184
[ 1024.530000] [<80078d8c>] do_softirq+0x48/0x68
[ 1024.530000] [<80078fa8>] irq_exit+0x4c/0x7c
[ 1024.530000] [<8006330c>] ret_from_irq+0x0/0x4
[ 1024.530000]
[ 1024.530000]
Code: 8e510208  30d300ff  2c420001 <00028036> 0c01e2a7  ac80048c
8e220008  2442ffff  ae220008
[ 1024.940000] ---[ end trace a47ff22dd20a96c1 ]---
[ 1024.950000] Kernel panic - not syncing: Fatal exception in interrupt
[ 1024.950000] ------------[ cut here ]------------
[ 1024.950000] WARNING: at lib/vsprintf.c:1376 vsnprintf+0x6c/0x39c()
[ 1024.950000] Modules linked in: sch_teql sch_tbf sch_sfq sch_red
sch_qfq sch_prio sch_ns2_codel sch_nfq_codel sch_netem sch_htb
sch_gred sch_efq_codel sch_dsmark em_text em_nbyte em_meta em_cmp
cls_basic act_police act_ipt act_connmark act_skbedit act_mirred
em_u32 cls_u32 cls_tcindex cls_flow cls_route cls_fw sch_hfsc
sch_fq_codel sch_codel sch_ingress ath79_wdt xt_hashlimit xt_set(O)
ip_set_list_set(O) ip_set_hash_netport(O) ip_set_hash_netiface(O)
ip_set_hash_net(O) ip_set_hash_ipportnet(O) ip_set_hash_ipportip(O)
ip_set_hash_ipport(O) ip_set_hash_ip(O) ip_set_bitmap_port(O)
ip_set_bitmap_ipmac(O) ip_set_bitmap_ip(O) ip_set(O) ip6t_REJECT
ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah
ip6table_raw ip6table_mangle ip6table_filter ip6_tables
nf_conntrack_ipv6 nf_defrag_ipv6 nfnetlink nf_nat_irc nf_nat_ftp
nf_conntrack_irc nf_conntrack_ftp xt_policy xt_esp ipt_ah xt_HL xt_hl
xt_ecn ipt_ECN xt_CLASSIFY xt_time xt_tcpmss xt_statistic xt_mark
xt_length xt_DSCP xt_dscp xt_string xt_layer7 xt_quota xt_pkttype
xt_physdev xt_owner ipt_MASQUERADE iptable_nat xt_nat nf_nat_ipv4
nf_nat xt_recent xt_helper xt_connmark xt_connbytes pptp pppoe
xt_conntrack xt_CT iptable_raw xt_state nf_conntrack_ipv4
nf_defrag_ipv4 nf_conntrack pppox ipt_REJECT xt_TCPMSS xt_LOG
xt_comment xt_multiport xt_mac xt_limit iptable_mangle iptable_filter
ip_tables xt_tcpudp x_tables ip_gre gre ifb sit xfrm4_tunnel
xfrm4_mode_tunnel xfrm4_mode_transport xfrm4_mode_beet esp4 ah4
tunnel4 tun tcp_ledbat(O) ppp_async ppp_generic slhc xfrm_user
xfrm_algo vfat fat autofs4 button_hotplug(O) ath9k(O) ath9k_common(O)
ath9k_hw(O) ath(O) nls_utf8 nls_iso8859_2 nls_iso8859_15
nls_iso8859_13 nls_iso8859_1 nls_cp437 mac80211(O) ts_fsm ts_bm ts_kmp
crc_ccitt ipv6 input_polldev cfg80211(O) compat(O) input_core
sha1_generic md5 hmac des_generic deflate cbc authenc arc4 usb_storage
ohci_hcd ehci_hcd sd_mod ext4 jbd2 mbcache usbcore usb_common scsi_mod
nls_base crc16 zlib_inflate zlib_deflate ledtrig_timer
ledtrig_default_on leds_gpio gpio_button_hotplug(O)
[ 1024.950000] Call Trace:
[ 1024.950000] [<802a25e8>] dump_stack+0x8/0x34
[ 1024.950000] [<80071f84>] warn_slowpath_common+0x78/0xa4
[ 1024.950000] [<80071fc8>] warn_slowpath_null+0x18/0x24
[ 1024.950000] [<80183d5c>] vsnprintf+0x6c/0x39c
[ 1024.950000] [<800bc99c>] crashlog_printf+0x4c/0x68
[ 1024.950000] [<800bca0c>] crashlog_do_dump+0x54/0x138
[ 1024.950000] [<800752bc>] kmsg_dump+0xe0/0x11c
[ 1024.950000] [<802a26b4>] panic+0x8c/0x1b4
[ 1024.950000] [<80067b68>] die+0x104/0x10c
[ 1024.950000] [<80067cd0>] do_trap_or_bp+0x118/0x18c
[ 1024.950000] [<80063300>] ret_from_exception+0x0/0xc
[ 1024.950000] [<801fc7f4>] reqsk_fastopen_remove+0x30/0x17c
[ 1024.950000] [<8024a36c>] tcp_rcv_state_process+0x7b4/0xc28
[ 1024.950000] [<802516ec>] tcp_v4_do_rcv+0x21c/0x274
[ 1024.950000] [<80253c74>] tcp_v4_rcv+0x5b4/0x974
[ 1024.950000] [<802320f0>] ip_local_deliver_finish+0x168/0x29c
[ 1024.950000] [<80207100>] __netif_receive_skb+0x63c/0x6c0
[ 1024.950000] [<c060b2e8>] ieee80211_deliver_skb+0x1b8/0x220 [mac80211]
[ 1024.950000] [<c060cc70>]
ieee80211_rx_handlers.part.12+0x1654/0x23e0 [mac80211]
[ 1024.950000] [<c060e468>]
ieee80211_prepare_and_rx_handle+0xa6c/0xaf0 [mac80211]
[ 1024.950000] [<c060ecfc>] ieee80211_rx+0x810/0x8d8 [mac80211]
[ 1024.950000] [<c078651c>] ath_rx_tasklet+0xf4c/0x10a4 [ath9k]
[ 1024.950000] [<c078437c>] ath9k_tasklet+0x104/0x174 [ath9k]
[ 1024.950000] [<800793b8>] tasklet_action+0x78/0xc8
[ 1024.950000] [<80078c08>] __do_softirq+0xb0/0x184
[ 1024.950000] [<80078d8c>] do_softirq+0x48/0x68
[ 1024.950000] [<80078fa8>] irq_exit+0x4c/0x7c
[ 1024.950000] [<8006330c>] ret_from_irq+0x0/0x4
[ 1024.950000]
[ 1024.950000] ---[ end trace a47ff22dd20a96c2 ]---
[ 1024.950000] Rebooting in 3 seconds..þþ

U-Boot 1.1.4 (May 27 2011 - 14:58:01)

--------------

On Tue, Jan 8, 2013 at 9:45 PM,  <cerowrt@lists.bufferbloat.net> wrote:
>
> Issue #418 has been updated by David Taht.
>
>
> While I acquired a serial adaptor for the 3800 I did not gain the time
> to look at this issue over the weekend.
>
> I'm buried this week and may not be able to get to this til the weekend.
> ----------------------------------------
> Bug #418: TFO crashes cerowrt 3.7.1-1
> https://www.bufferbloat.net/issues/418
>
> Author: David Taht
> Status: New
> Priority: Normal
> Assignee: Dave Täht
> Category: Networking
> Target version:
>
>
> I am not able to get through even a single TCP TFO connection. The router restarts as soon as it sees the TFO connection.
>
> Looks like SYN+Data is crashing the box (see attached trace captured on lo iface of cero). logread, dmesg did not show anything. I don't know whether its kernel panic.
>
> This is strange as 3.6 was working for SYN+Data cases.
>
> However the difference from previous instance is the polipo server with TFO running on cero box. Client may run on same cero or on my laptop which in either case crashes the box.
>
> On 3.7, if I run the TFO client on cero box and TFO server on the laptop, it still works but not the reverse.
>
> (see email thread at: https://lists.bufferbloat.net/pipermail/cerowrt-devel/2013-January/000844.html for more details)
>
>"
418,Ketan Kulkarni,2013-01-13 03:17:28.46384,"I do not know if this is the faulty line -


void reqsk_fastopen_remove(struct sock *sk, struct request_sock *req,
                           bool reset)
{
        struct sock *lsk = tcp_rsk(req)->listener;
        struct fastopen_queue *fastopenq =
            inet_csk(lsk)->icsk_accept_queue.fastopenq;

>>>>>        BUG_ON(!spin_is_locked(&sk->sk_lock.slock) && !sock_owned_by_user(sk));

        tcp_sk(sk)->fastopen_rsk = NULL;
        spin_lock_bh(&fastopenq->lock);
        fastopenq->qlen--;
        tcp_rsk(req)->listener = NULL;


On Sun, Jan 13, 2013 at 4:44 PM,  <cerowrt@lists.bufferbloat.net> wrote:
>
> Issue #418 has been updated by Ketan Kulkarni.
>
>
> I could get a chance to get the backtrace from serial port.
> I didnt do the kgdb session yet.
>
> [ 1024.530000] Kernel bug detected[#1]:
> [ 1024.530000] Cpu 0
> [ 1024.530000] $ 0   : 00000000 00000000 00000001 00000014
> [ 1024.530000] $ 4   : 8600a9a0 85446cc0 00000000 377f8397
> [ 1024.530000] $ 8   : 00000000 00000000 00000000 204e7f80
> [ 1024.530000] $12   : 39808080 00000007 00000000 00000000
> [ 1024.530000] $16   : 85446cc0 854fb280 8600a500 00000000
> [ 1024.530000] $20   : 85446cc0 80340000 00000006 803aac70
> [ 1024.530000] $24   : 00000000 c0aa90d8
> [ 1024.530000] $28   : 854c2000 854c3ad8 8033c050 8024a36c
> [ 1024.530000] Hi    : 00000000
> [ 1024.530000] Lo    : 00000000
> [ 1024.530000] epc   : 801fc7f4 reqsk_fastopen_remove+0x30/0x17c
> [ 1024.530000]     Tainted: G           O
> [ 1024.530000] ra    : 8024a36c tcp_rcv_state_process+0x7b4/0xc28
> [ 1024.530000] Status: 1000fc03    KERNEL EXL IE
> [ 1024.530000] Cause : 10800034
> [ 1024.530000] PrId  : 00019374 (MIPS 24Kc)
> [ 1024.530000] Modules linked in: sch_teql sch_tbf sch_sfq sch_red
> sch_qfq sch_prio sch_ns2_codel sch_nfq_codel sch_netem sch_htb
> sch_gred sch_efq_codel sch_dsmark em_text em_nbyte em_meta em_cmp
> cls_basic act_police act_ipt act_connmark act_skbedit act_mirred
> em_u32 cls_u32 cls_tcindex cls_flow cls_route cls_fw sch_hfsc
> sch_fq_codel sch_codel sch_ingress ath79_wdt xt_hashlimit xt_set(O)
> ip_set_list_set(O) ip_set_hash_netport(O) ip_set_hash_netiface(O)
> ip_set_hash_net(O) ip_set_hash_ipportnet(O) ip_set_hash_ipportip(O)
> ip_set_hash_ipport(O) ip_set_hash_ip(O) ip_set_bitmap_port(O)
> ip_set_bitmap_ipmac(O) ip_set_bitmap_ip(O) ip_set(O) ip6t_REJECT
> ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah
> ip6table_raw ip6table_mangle ip6table_filter ip6_tables
> nf_conntrack_ipv6 nf_defrag_ipv6 nfnetlink nf_nat_irc nf_nat_ftp
> nf_conntrack_irc nf_conntrack_ftp xt_policy xt_esp ipt_ah xt_HL xt_hl
> xt_ecn ipt_ECN xt_CLASSIFY xt_time xt_tcpmss xt_statistic xt_mark
> xt_length xt_DSCP xt_dscp xt_string xt_layer7 xt_quota xt_pkttype
> xt_physdev xt_owner ipt_MASQUERADE iptable_nat xt_nat nf_nat_ipv4
> nf_nat xt_recent xt_helper xt_connmark xt_connbytes pptp pppoe
> xt_conntrack xt_CT iptable_raw xt_state nf_conntrack_ipv4
> nf_defrag_ipv4 nf_conntrack pppox ipt_REJECT xt_TCPMSS xt_LOG
> xt_comment xt_multiport xt_mac xt_limit iptable_mangle iptable_filter
> ip_tables xt_tcpudp x_tables ip_gre gre ifb sit xfrm4_tunnel
> xfrm4_mode_tunnel xfrm4_mode_transport xfrm4_mode_beet esp4 ah4
> tunnel4 tun tcp_ledbat(O) ppp_async ppp_generic slhc xfrm_user
> xfrm_algo vfat fat autofs4 button_hotplug(O) ath9k(O) ath9k_common(O)
> ath9k_hw(O) ath(O) nls_utf8 nls_iso8859_2 nls_iso8859_15
> nls_iso8859_13 nls_iso8859_1 nls_cp437 mac80211(O) ts_fsm ts_bm ts_kmp
> crc_ccitt ipv6 input_polldev cfg80211(O) compat(O) input_core
> sha1_generic md5 hmac des_generic deflate cbc authenc arc4 usb_storage
> ohci_hcd ehci_hcd sd_mod ext4 jbd2 mbcache usbcore usb_common scsi_mod
> nls_base crc16 zlib_inflate zlib_deflate ledtrig_timer
> ledtrig_default_on leds_gpio gpio_button_hotplug(O)
> [ 1024.530000] Process seq (pid: 4023, threadinfo=854c2000,
> task=85461df8, tls=7735b440)
> [ 1024.530000] Stack : 00000000 8600a9a0 87287d80 8607bb58 85446cc0
> 80330000 8600a9a0 87287d80
>         8607bb58 8024a36c c0aa9720 c2337090 86b39000 00000000 00000001 00000014
>         00000001 02000004 862b6d24 c2337000 00000001 8547bf00 00000000 00000000
>         854c3bcc 854c3bcc 87287d80 854c3bcc 87287d80 80325dd8 87287d80 8600a9a0
>         8600a9a0 8607bb58 8607bb44 802516ec 87287d80 803261dc 80340000 80340000
>         ...
> [ 1024.530000] Call Trace:
> [ 1024.530000] [<801fc7f4>] reqsk_fastopen_remove+0x30/0x17c
> [ 1024.530000] [<8024a36c>] tcp_rcv_state_process+0x7b4/0xc28
> [ 1024.530000] [<802516ec>] tcp_v4_do_rcv+0x21c/0x274
> [ 1024.530000] [<80253c74>] tcp_v4_rcv+0x5b4/0x974
> [ 1024.530000] [<802320f0>] ip_local_deliver_finish+0x168/0x29c
> [ 1024.530000] [<80207100>] __netif_receive_skb+0x63c/0x6c0
> [ 1024.530000] [<c060b2e8>] ieee80211_deliver_skb+0x1b8/0x220 [mac80211]
> [ 1024.530000] [<c060cc70>]
> ieee80211_rx_handlers.part.12+0x1654/0x23e0 [mac80211]
> [ 1024.530000] [<c060e468>]
> ieee80211_prepare_and_rx_handle+0xa6c/0xaf0 [mac80211]
> [ 1024.530000] [<c060ecfc>] ieee80211_rx+0x810/0x8d8 [mac80211]
> [ 1024.530000] [<c078651c>] ath_rx_tasklet+0xf4c/0x10a4 [ath9k]
> [ 1024.530000] [<c078437c>] ath9k_tasklet+0x104/0x174 [ath9k]
> [ 1024.530000] [<800793b8>] tasklet_action+0x78/0xc8
> [ 1024.530000] [<80078c08>] __do_softirq+0xb0/0x184
> [ 1024.530000] [<80078d8c>] do_softirq+0x48/0x68
> [ 1024.530000] [<80078fa8>] irq_exit+0x4c/0x7c
> [ 1024.530000] [<8006330c>] ret_from_irq+0x0/0x4
> [ 1024.530000]
> [ 1024.530000]
> Code: 8e510208  30d300ff  2c420001 <00028036> 0c01e2a7  ac80048c
> 8e220008  2442ffff  ae220008
> [ 1024.940000] ---[ end trace a47ff22dd20a96c1 ]---
> [ 1024.950000] Kernel panic - not syncing: Fatal exception in interrupt
> [ 1024.950000] ------------[ cut here ]------------
> [ 1024.950000] WARNING: at lib/vsprintf.c:1376 vsnprintf+0x6c/0x39c()
> [ 1024.950000] Modules linked in: sch_teql sch_tbf sch_sfq sch_red
> sch_qfq sch_prio sch_ns2_codel sch_nfq_codel sch_netem sch_htb
> sch_gred sch_efq_codel sch_dsmark em_text em_nbyte em_meta em_cmp
> cls_basic act_police act_ipt act_connmark act_skbedit act_mirred
> em_u32 cls_u32 cls_tcindex cls_flow cls_route cls_fw sch_hfsc
> sch_fq_codel sch_codel sch_ingress ath79_wdt xt_hashlimit xt_set(O)
> ip_set_list_set(O) ip_set_hash_netport(O) ip_set_hash_netiface(O)
> ip_set_hash_net(O) ip_set_hash_ipportnet(O) ip_set_hash_ipportip(O)
> ip_set_hash_ipport(O) ip_set_hash_ip(O) ip_set_bitmap_port(O)
> ip_set_bitmap_ipmac(O) ip_set_bitmap_ip(O) ip_set(O) ip6t_REJECT
> ip6t_rt ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah
> ip6table_raw ip6table_mangle ip6table_filter ip6_tables
> nf_conntrack_ipv6 nf_defrag_ipv6 nfnetlink nf_nat_irc nf_nat_ftp
> nf_conntrack_irc nf_conntrack_ftp xt_policy xt_esp ipt_ah xt_HL xt_hl
> xt_ecn ipt_ECN xt_CLASSIFY xt_time xt_tcpmss xt_statistic xt_mark
> xt_length xt_DSCP xt_dscp xt_string xt_layer7 xt_quota xt_pkttype
> xt_physdev xt_owner ipt_MASQUERADE iptable_nat xt_nat nf_nat_ipv4
> nf_nat xt_recent xt_helper xt_connmark xt_connbytes pptp pppoe
> xt_conntrack xt_CT iptable_raw xt_state nf_conntrack_ipv4
> nf_defrag_ipv4 nf_conntrack pppox ipt_REJECT xt_TCPMSS xt_LOG
> xt_comment xt_multiport xt_mac xt_limit iptable_mangle iptable_filter
> ip_tables xt_tcpudp x_tables ip_gre gre ifb sit xfrm4_tunnel
> xfrm4_mode_tunnel xfrm4_mode_transport xfrm4_mode_beet esp4 ah4
> tunnel4 tun tcp_ledbat(O) ppp_async ppp_generic slhc xfrm_user
> xfrm_algo vfat fat autofs4 button_hotplug(O) ath9k(O) ath9k_common(O)
> ath9k_hw(O) ath(O) nls_utf8 nls_iso8859_2 nls_iso8859_15
> nls_iso8859_13 nls_iso8859_1 nls_cp437 mac80211(O) ts_fsm ts_bm ts_kmp
> crc_ccitt ipv6 input_polldev cfg80211(O) compat(O) input_core
> sha1_generic md5 hmac des_generic deflate cbc authenc arc4 usb_storage
> ohci_hcd ehci_hcd sd_mod ext4 jbd2 mbcache usbcore usb_common scsi_mod
> nls_base crc16 zlib_inflate zlib_deflate ledtrig_timer
> ledtrig_default_on leds_gpio gpio_button_hotplug(O)
> [ 1024.950000] Call Trace:
> [ 1024.950000] [<802a25e8>] dump_stack+0x8/0x34
> [ 1024.950000] [<80071f84>] warn_slowpath_common+0x78/0xa4
> [ 1024.950000] [<80071fc8>] warn_slowpath_null+0x18/0x24
> [ 1024.950000] [<80183d5c>] vsnprintf+0x6c/0x39c
> [ 1024.950000] [<800bc99c>] crashlog_printf+0x4c/0x68
> [ 1024.950000] [<800bca0c>] crashlog_do_dump+0x54/0x138
> [ 1024.950000] [<800752bc>] kmsg_dump+0xe0/0x11c
> [ 1024.950000] [<802a26b4>] panic+0x8c/0x1b4
> [ 1024.950000] [<80067b68>] die+0x104/0x10c
> [ 1024.950000] [<80067cd0>] do_trap_or_bp+0x118/0x18c
> [ 1024.950000] [<80063300>] ret_from_exception+0x0/0xc
> [ 1024.950000] [<801fc7f4>] reqsk_fastopen_remove+0x30/0x17c
> [ 1024.950000] [<8024a36c>] tcp_rcv_state_process+0x7b4/0xc28
> [ 1024.950000] [<802516ec>] tcp_v4_do_rcv+0x21c/0x274
> [ 1024.950000] [<80253c74>] tcp_v4_rcv+0x5b4/0x974
> [ 1024.950000] [<802320f0>] ip_local_deliver_finish+0x168/0x29c
> [ 1024.950000] [<80207100>] __netif_receive_skb+0x63c/0x6c0
> [ 1024.950000] [<c060b2e8>] ieee80211_deliver_skb+0x1b8/0x220 [mac80211]
> [ 1024.950000] [<c060cc70>]
> ieee80211_rx_handlers.part.12+0x1654/0x23e0 [mac80211]
> [ 1024.950000] [<c060e468>]
> ieee80211_prepare_and_rx_handle+0xa6c/0xaf0 [mac80211]
> [ 1024.950000] [<c060ecfc>] ieee80211_rx+0x810/0x8d8 [mac80211]
> [ 1024.950000] [<c078651c>] ath_rx_tasklet+0xf4c/0x10a4 [ath9k]
> [ 1024.950000] [<c078437c>] ath9k_tasklet+0x104/0x174 [ath9k]
> [ 1024.950000] [<800793b8>] tasklet_action+0x78/0xc8
> [ 1024.950000] [<80078c08>] __do_softirq+0xb0/0x184
> [ 1024.950000] [<80078d8c>] do_softirq+0x48/0x68
> [ 1024.950000] [<80078fa8>] irq_exit+0x4c/0x7c
> [ 1024.950000] [<8006330c>] ret_from_irq+0x0/0x4
> [ 1024.950000]
> [ 1024.950000] ---[ end trace a47ff22dd20a96c2 ]---
> [ 1024.950000] Rebooting in 3 seconds..þþ
>
> U-Boot 1.1.4 (May 27 2011 - 14:58:01)
>
> --------------
>
> On Tue, Jan 8, 2013 at 9:45 PM,  <cerowrt@lists.bufferbloat.net> wrote:
>>
>> Issue #418 has been updated by David Taht.
>>
>>
>> While I acquired a serial adaptor for the 3800 I did not gain the time
>> to look at this issue over the weekend.
>>
>> I'm buried this week and may not be able to get to this til the weekend.
>> ----------------------------------------
>> Bug #418: TFO crashes cerowrt 3.7.1-1
>> https://www.bufferbloat.net/issues/418
>>
>> Author: David Taht
>> Status: New
>> Priority: Normal
>> Assignee: Dave Täht
>> Category: Networking
>> Target version:
>>
>>
>> I am not able to get through even a single TCP TFO connection. The router restarts as soon as it sees the TFO connection.
>>
>> Looks like SYN+Data is crashing the box (see attached trace captured on lo iface of cero). logread, dmesg did not show anything. I don't know whether its kernel panic.
>>
>> This is strange as 3.6 was working for SYN+Data cases.
>>
>> However the difference from previous instance is the polipo server with TFO running on cero box. Client may run on same cero or on my laptop which in either case crashes the box.
>>
>> On 3.7, if I run the TFO client on cero box and TFO server on the laptop, it still works but not the reverse.
>>
>> (see email thread at: https://lists.bufferbloat.net/pipermail/cerowrt-devel/2013-January/000844.html for more details)
>>
>>
> ----------------------------------------
> Bug #418: TFO crashes cerowrt 3.7.1-1
> https://www.bufferbloat.net/issues/418
>
> Author: David Taht
> Status: New
> Priority: Normal
> Assignee: Dave Täht
> Category: Networking
> Target version:
>
>
> I am not able to get through even a single TCP TFO connection. The router restarts as soon as it sees the TFO connection.
>
> Looks like SYN+Data is crashing the box (see attached trace captured on lo iface of cero). logread, dmesg did not show anything. I don't know whether its kernel panic.
>
> This is strange as 3.6 was working for SYN+Data cases.
>
> However the difference from previous instance is the polipo server with TFO running on cero box. Client may run on same cero or on my laptop which in either case crashes the box.
>
> On 3.7, if I run the TFO client on cero box and TFO server on the laptop, it still works but not the reverse.
>
> (see email thread at: https://lists.bufferbloat.net/pipermail/cerowrt-devel/2013-January/000844.html for more details)
>
>"
418,Ketan Kulkarni,2013-01-14 01:24:53.566878,"Eric suggested a patch to fix the issue -
More details of the analysis and fix here -

https://lists.bufferbloat.net/pipermail/cerowrt-devel/2013-January/000897.html"
418,Ketan Kulkarni,2013-01-14 01:26:56.712974,""
419,David Taht,2013-01-16 13:43:49.295043,"This is the first time I've ever got a picture of what happens to the
network when this happens... and it's ugly. Admittedly I had
/sys/kernel/debug/mips/unaligned_action set to 2 at the time, but..."
419,Robert Bradley,2013-01-16 16:30:08.804584,"Looking at addrconf_prefix_rcv, I think the most likely cause is that the prefix_info struct was not packed and aligned.  This was untouched in the previous patches though, so I am surprised this trap has not appeared before.

I also noticed that the new patchset does not pack and align the headers for neighbour discovery.  This is more likely to be the cause of the new traps."
419,David Taht,2013-01-16 17:24:59.560189,"On Wed, Jan 16, 2013 at 7:30 PM, <cerowrt@lists.bufferbloat.net> wrote:

>
> Issue #419 has been updated by Robert Bradley.
>
> File addrconf_prefix_rcv_trap.patch added
>
> Looking at addrconf_prefix_rcv, I think the most likely cause is that the
> prefix_info struct was not packed and aligned.  This was untouched in the
> previous patches though, so I am surprised this trap has not appeared
> before.
>
> I also noticed that the new patchset does not pack and align the headers
> for neighbour discovery.  This is more likely to be the cause of the new
> traps.
>

This sort of packet isn't emitted very often on a non-ipv6 network. On a
large ipv6 network, seem to see it every minute or so.

Thanks for getting on this so fast. Did you see my mail on PIM first or
were we just hackers passing in the night?

Will apply after I sort out the TCP congestion issue.




> ----------------------------------------
> Bug #419: unaligned instruction traps redux
> https://www.bufferbloat.net/issues/419
>
> Author: David Taht
> Status: New
> Priority: Normal
> Assignee:
> Category:
> Target version:
>
>
> root@OpenWrt:/sys/kernel/debug/mips# cat unalignein80324000 80325b30
> 00067747 8318c048
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.340000] Hi    : 00000000
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.350000] Lo    : 00001106
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.350000] epc   : 8318c050
> addrconf_prefix_rcv+0x620/0x760 [ipv6]
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.360000]     Tainted:
> G           O
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.360000] ra    : 8318c048
> addrconf_prefix_rcv+0x618/0x760 [ipv6]
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.370000] Status:
> 1000fc03    KERNEL EXL IE
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.370000] Cause : 00800010
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.370000] BadVA : 821c908e
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.380000] PrId  : 00019374
> (MIPS 24Kc)
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [truncated] [ 4538.380000]
> Modules linked in: sch_teql sch_tbf sch_sfq sch_red sch_qfq sch_prio
> sch_ns2_codel sch_nfq_codel sch_netem sch_htb sch_gred sch_efq_codel
> sch_dsmark em_text em_nbyte em_meta em_cmp cls_basic act_police
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.560000] Process swapper
> (pid: 0, threadinfo=80324000, task=80328d50, tls=00000000)
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.570000] Stack : 00000000
> 00000000 821c9066 00000040 0000000c 00000000 00000000 80215584
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.570000]         26200000
> 2b100600 a221b7ff feace447 00000000 8313648c 821c9086 00000040
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.570000]         821a9c00
> 83006700 83136400 8218b800 831b8e40 30000000 80340000 83198924
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.570000]         810841f4
> 00000000 c18f1a40 82a2ca40 83bf6e00 00000005 80325ca0 821c9086
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.570000]         821c9076
> 00000000 821c9086 00000000 821c907e 00000000 00000000 30000000
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.570000]         ...
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.610000] Call Trace:
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.610000] [<8318c050>]
> addrconf_prefix_rcv+0x620/0x760 [ipv6]
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.620000] [<83198924>]
> ndisc_rcv+0x9f8/0xe04 [ipv6]
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.620000] [<8319fa3c>]
> icmpv6_rcv+0x750/0x84c [ipv6]
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.630000] [<83185d90>]
> ip6_input_finish+0x250/0x458 [ipv6]
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.640000] [<83186784>]
> ip6_mc_input+0x22c/0x268 [ipv6]
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.640000] [<80207c00>]
> __netif_receive_skb+0x63c/0x6c0
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.650000] [<828e5384>]
> ri_tasklet+0x104/0x2b0 [ifb]
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.650000] [<80079288>]
> tasklet_action+0x78/0xc8
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.660000] [<80078ad8>]
> __do_softirq+0xb0/0x184
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.660000] [<80078c5c>]
> do_softirq+0x48/0x68
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.660000] [<80078e78>]
> irq_exit+0x4c/0x7c
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.670000] [<8006316c>]
> ret_from_irq+0x0/0x4
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.670000] [<80063380>]
> r4k_wait+0x20/0x40
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.680000] [<80064e60>]
> cpu_idle+0x30/0x60
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.730000] $20   : 80340000
> 00093a80 8313645c 821c9096
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.730000] $24   : 00000000
> 80097de0
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.740000] $28   : 80324000
> 80325b30 00067747 8318c048
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.740000] Hi    : 00000000
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.740000] Lo    : 00001106
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.750000] epc   : 8318c060
> addrconf_prefix_rcv+0x630/0x760 [ipv6]
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.750000]     Tainted:
> G           O
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.760000] ra    : 8318c048
> addrconf_prefix_rcv+0x618/0x760 [ipv6]
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.760000] Status:
> 1000fc03    KERNEL EXL IE
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.770000] Cause : 00800010
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.770000] BadVA : 821c908a
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.770000] PrId  : 00019374
> (MIPS 24Kc)
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [truncated] [ 4538.780000]
> Modules linked in: sch_teql sch_tbf sch_sfq sch_red sch_qfq sch_prio
> sch_ns2_codel sch_nfq_codel sch_netem sch_htb sch_gred sch_efq_codel
> sch_dsmark em_text em_nbyte em_meta em_cmp cls_basic act_police
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.960000] Process swapper
> (pid: 0, threadinfo=80324000, task=80328d50, tls=00000000)
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.970000] Stack : 00000000
> 00000000 821c9066 00000040 0000000c 00000000 00093a80 80215584
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.970000]         26200000
> 2b100600 a221b7ff feace447 00000000 8313648c 821c9086 00000040
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.970000]         821a9c00
> 83006700 83136400 8218b800 831b8e40 30000000 80340000 83198924
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.970000]         810841f4
> 00000000 c18f1a40 82a2ca40 83bf6e00 00000005 80325ca0 821c9086
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.970000]         821c9076
> 00000000 821c9086 00000000 821c907e 00000000 00000000 30000000
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4538.970000]         ...
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4539.010000] Call Trace:
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4539.010000] [<8318c060>]
> addrconf_prefix_rcv+0x630/0x760 [ipv6]
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4539.020000] [<83198924>]
> ndisc_rcv+0x9f8/0xe04 [ipv6]
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4539.020000] [<8319fa3c>]
> icmpv6_rcv+0x750/0x84c [ipv6]
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4539.030000] [<83185d90>]
> ip6_input_finish+0x250/0x458 [ipv6]
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4539.030000] [<83186784>]
> ip6_mc_input+0x22c/0x268 [ipv6]
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4539.040000] [<80207c00>]
> __netif_receive_skb+0x63c/0x6c0
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4539.080000]
> Jan 16 21:06:56 OpenWrt kern.warn kernel: [ 4539.080000] Code: 02002021
> 24050002  afa20018 <8e420004> 27a70018  0c0658cd  afa2001c  14400009
> 00000000
>
>"
419,David Taht,2013-01-16 18:56:25.308342,"Better. Only 6 traps in 5 minutes but I'm not running ipv6 yet, really.

<pre>
[  430.417968] Cpu 0
[  430.417968] $ 0   : 00000000 00000001 83b64096 26200000
[  430.417968] $ 4   : 00000000 83b64096 00000040 00000070
[  430.417968] $ 8   : fffffffa 80187a70 00000002 00002b10
[  430.417968] $12   : 06000000 00000007 00000000 00000000
[  430.441406] $16   : 83b64096 83b3fc0c 00000000 83b64096
[  430.445312] $20   : 00000040 830e0d90 00000070 00000020
[  430.449218] $24   : 00000000 83086558
[  430.457031] $28   : 80328000 80329aa8 ffffffff 83093d80
[  430.460937] Hi    : 12d22cd1
[  430.464843] Lo    : b412071f
[  430.468750] epc   : 830927dc fib6_locate_1+0xc8/0x148 [ipv6]
[  430.472656]     Tainted: G           O
[  430.476562] ra    : 83093d80 fib6_locate+0x24/0x94 [ipv6]
[  430.480468] Status: 1000fc03    KERNEL EXL IE
[  430.488281] Cause : 00800010
[  430.488281] BadVA : 83b64096
[  430.492187] PrId  : 00019374 (MIPS 24Kc)
[  430.496093] Modules linked in: sch_teql sch_tbf sch_sfq sch_red sch_qfq
sch_prio sch_ns2_codel sch_nfq_codel sch_netem sch_htb sch_gred
sch_efq_codel sch_dsmark em_text em_nbyte em_meta em_cmp cls_basic
act_police act_ipt act_connmark act_skbedit act_mirred em_u32 cls_u32
cls_tcindex cls_flow cls_route cls_fw sch_hfsc sch_fq_codel sch_codel
sch_ingress usb_storage ath79_wdt ohci_hcd xt_hashlimit xt_set(O)
ip_set_list_set(O) ip_set_hash_netport(O) ip_set_hash_netiface(O)
ip_set_hash_net(O) ip_set_hash_ipportnet(O) ip_set_hash_ipportip(O)
ip_set_hash_ipport(O) ip_set_hash_ip(O) ip_set_bitmap_port(O)
ip_set_bitmap_ipmac(O) ip_set_bitmap_ip(O) ip_set(O) ip6t_REJECT ip6t_rt
ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah ip6table_raw
ip6table_mangle ip6table_filter ip6_tables nf_conntrack_ipv6 nf_defrag_ipv6
nfnetlink nf_nat_irc nf_nat_ftp nf_conntrack_irc nf_conntrack_ftp xt_policy
xt_esp ipt_ah xt_HL xt_hl xt_ecn ipt_ECN xt_CLASSIFY xt_time xt_tcpmss
xt_statistic xt_mark xt_length xt_DSCP xt_dscp xt_string xt_layer7 xt_quota
xt_pkttype xt_physdev xt_owner xt_addrtype ipt_MASQUERADE iptable_nat
xt_nat nf_nat_ipv4 nf_nat xt_recent xt_helper xt_connmark xt_connbytes pptp
pppoe xt_conntrack xt_CT iptable_raw xt_state nf_conntrack_ipv4
nf_defrag_ipv4 nf_conntrack ehci_hcd sd_mod pppox ipt_REJECT xt_TCPMSS
xt_LOG xt_comment xt_multiport xt_mac xt_limit iptable_mangle
iptable_filter ip_tables xt_tcpudp x_tables ip_gre gre ifb sit ipcomp
xfrm4_tunnel xfrm4_mode_tunnel xfrm4_mode_transport xfrm4_mode_beet esp4
ah4 tunnel4 tun tcp_ledbat(O) ppp_async ppp_generic slhc af_key xfrm_user
xfrm_ipcomp xfrm_algo vfat fat ext4 jbd2 mbcache autofs4 button_hotplug(O)
ath9k(O) ath9k_common(O) ath9k_hw(O) ath(O) nls_utf8 nls_iso8859_2
nls_iso8859_15 nls_iso8859_13 nls_iso8859_1 nls_cp437 mac80211(O) usbcore
usb_common scsi_mod nls_base ts_fsm ts_bm ts_kmp crc16 crc_ccitt ipv6
input_polldev cfg80211(O) compat(O) input_core sha1_generic md5 hmac
des_generic deflate cbc authenc arc4 zlib_inflate zlib_deflate
ledtrig_timer ledtrig_default_on leds_gpio gpio_button_hotplug(O)
[  430.679687] Process swapper (pid: 0, threadinfo=80328000, task=8032d030,
tls=00000000)
[  430.687500] Stack : 830e0c40 80329b18 81ee2140 81ee2140 83b3fc00
00000000 00000000 00278d00
[  430.687500]         278d0000 00093a80 83ac5e5c 83b64096 8381a800
83093d80 00000001 83b3f100
[  430.687500]         830e0c40 830e0c40 83b3fc00 83b64086 83ac5e00
8308bb2c 00000000 8308fa8c
[  430.687500]         00000001 8308e130 00000000 830e0c9c 00000000
80216e14 00000000 83aeb4c0
[  430.687500]         82afe380 83aeb4c0 00000040 00000001 83b64086
00000040 83303a80 830e0d20
[  430.687500]         ...
[  430.726562] Call Trace:
[  430.730468] [<830927dc>] fib6_locate_1+0xc8/0x148 [ipv6]
[  430.734375] [<83093d80>] fib6_locate+0x24/0x94 [ipv6]
[  430.738281] [<8308bb2c>] addrconf_prefix_rcv+0x128/0x770 [ipv6]
[  430.746093] [<83098910>] ndisc_rcv+0xa04/0xe10 [ipv6]
[  430.750000] [<8309fa2c>] icmpv6_rcv+0x750/0x84c [ipv6]
[  430.757812] [<83085d90>] ip6_input_finish+0x250/0x458 [ipv6]
[  430.761718] [<83086784>] ip6_mc_input+0x22c/0x268 [ipv6]
[  430.765625] [<80209490>] __netif_receive_skb+0x63c/0x6c0
[  430.773437] [<801f1070>] ag71xx_poll+0x400/0x600
[  430.777343] [<80209958>] net_rx_action+0x88/0x1fc
[  430.781250] [<80078c48>] __do_softirq+0xb0/0x184
[  430.785156] [<80078dcc>] do_softirq+0x48/0x68
[  430.789062] [<80078fe8>] irq_exit+0x4c/0xb8
[  430.796875] [<8006316c>] ret_from_irq+0x0/0x4
[  430.800781] [<80063380>] r4k_wait+0x20/0x40
[  430.804687] [<80064e68>] cpu_idle+0x38/0x70
[  430.808593] [<803468fc>] start_kernel+0x374/0x394
[  430.812500]
[  430.812500]
[  430.812500] Code: 00000000  00021080  02621021 <8c420000> 00129027
24030001  02439004  02429024  12400003
</pre>"
419,David Taht,2013-01-16 19:01:29.923635,"<pre>
[  430.812500] Code: 00000000  00021080  02621021 <8c420000> 00129027
24030001  02439004  02429024  12400003
[  609.312500] Cpu 0
[  609.312500] $ 0   : 00000000 00000001 82b4d03e 00000000
[  609.312500] $ 4   : 81e3f9c0 000005dc 00000000 00000000
[  609.312500] $ 8   : 00000000 00000000 0000ffff ac1e2a01
[  609.312500] $12   : 00000000 00000000 00000000 00000000
[  609.335937] $16   : 81e3fe50 81e3f9c0 00000000 81d669c0
[  609.339843] $20   : 00000000 81e3d500 8323d9c0 81e3d990
[  609.343750] $24   : 00000000 802346c4
[  609.351562] $28   : 80328000 80329b48 80342490 830a5d88
[  609.355468] Hi    : 00000000
[  609.359375] Lo    : 00000000
[  609.363281] epc   : 830a5dd8 tcp_v6_syn_recv_sock+0x11c/0x468 [ipv6]
[  609.367187]     Tainted: G           O
[  609.371093] ra    : 830a5d88 tcp_v6_syn_recv_sock+0xcc/0x468 [ipv6]
[  609.378906] Status: 1000fc03    KERNEL EXL IE
[  609.382812] Cause : 00800010
[  609.386718] BadVA : 82b4d03e
[  609.390625] PrId  : 00019374 (MIPS 24Kc)
[  609.394531] Modules linked in: sch_teql sch_tbf sch_sfq sch_red sch_qfq
sch_prio sch_ns2_codel sch_nfq_codel sch_netem sch_htb sch_gred
sch_efq_codel sch_dsmark em_text em_nbyte em_meta em_cmp cls_basic
act_police act_ipt act_connmark act_skbedit act_mirred em_u32 cls_u32
cls_tcindex cls_flow cls_route cls_fw sch_hfsc sch_fq_codel sch_codel
sch_ingress usb_storage ath79_wdt ohci_hcd xt_hashlimit xt_set(O)
ip_set_list_set(O) ip_set_hash_netport(O) ip_set_hash_netiface(O)
ip_set_hash_net(O) ip_set_hash_ipportnet(O) ip_set_hash_ipportip(O)
ip_set_hash_ipport(O) ip_set_hash_ip(O) ip_set_bitmap_port(O)
ip_set_bitmap_ipmac(O) ip_set_bitmap_ip(O) ip_set(O) ip6t_REJECT ip6t_rt
ip6t_hbh ip6t_mh ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah ip6table_raw
ip6table_mangle ip6table_filter ip6_tables nf_conntrack_ipv6 nf_defrag_ipv6
nfnetlink nf_nat_irc nf_nat_ftp nf_conntrack_irc nf_conntrack_ftp xt_policy
xt_esp ipt_ah xt_HL xt_hl xt_ecn ipt_ECN xt_CLASSIFY xt_time xt_tcpmss
xt_statistic xt_mark xt_length xt_DSCP xt_dscp xt_string xt_layer7 xt_quota
xt_pkttype xt_physdev xt_owner xt_addrtype ipt_MASQUERADE iptable_nat
xt_nat nf_nat_ipv4 nf_nat xt_recent xt_helper xt_connmark xt_connbytes pptp
pppoe xt_conntrack xt_CT iptable_raw xt_state nf_conntrack_ipv4
nf_defrag_ipv4 nf_conntrack ehci_hcd sd_mod pppox ipt_REJECT xt_TCPMSS
xt_LOG xt_comment xt_multiport xt_mac xt_limit iptable_mangle
iptable_filter ip_tables xt_tcpudp x_tables ip_gre gre ifb sit ipcomp
xfrm4_tunnel xfrm4_mode_tunnel xfrm4_mode_transport xfrm4_mode_beet esp4
ah4 tunnel4 tun tcp_ledbat(O) ppp_async ppp_generic slhc af_key xfrm_user
xfrm_ipcomp xfrm_algo vfat fat ext4 jbd2 mbcache autofs4 button_hotplug(O)
ath9k(O) ath9k_common(O) ath9k_hw(O) ath(O) nls_utf8 nls_iso8859_2
nls_iso8859_15 nls_iso8859_13 nls_iso8859_1 nls_cp437 mac80211(O) usbcore
usb_common scsi_mod nls_base ts_fsm ts_bm ts_kmp crc16 crc_ccitt ipv6
input_polldev cfg80211(O) compat(O) input_core sha1_generic md5 hmac
des_generic deflate cbc authenc arc4 zlib_inflate zlib_deflate
ledtrig_timer ledtrig_default_on leds_gpio gpio_button_hotplug(O)
[  609.578125] Process swapper (pid: 0, threadinfo=80328000, task=8032d030,
tls=00000000)
[  609.585937] Stack : 00000000 00000002 12d039c0 82912228 00000000
00000000 00000014 00000000
[  609.585937]         00000002 00000001 83b3e570 829671b8 06df0002
00000014 00000000 00000000
[  609.585937]         00000000 00000001 00000001 82b4d03e 8323d9c0
8323d9c0 81e3d500 81d669c0
[  609.585937]         00100000 00000000 00000000 00000000 830e39f0
80256aa8 8381a000 00000000
[  609.585937]         80329bd8 00000014 00000000 02000004 8331c124
50f767f4 02ad0008 02ad0008
[  609.585937]         ...
[  609.621093] Call Trace:
[  609.625000] [<830a5dd8>] tcp_v6_syn_recv_sock+0x11c/0x468 [ipv6]
[  609.632812] [<80256aa8>] tcp_check_req+0x330/0x4cc
[  609.636718] [<80253a1c>] tcp_v4_do_rcv+0x12c/0x274
[  609.640625] [<8025606c>] tcp_v4_rcv+0x5b4/0x974
[  609.644531] [<80234490>] ip_local_deliver_finish+0x168/0x29c
[  609.652343] [<80209490>] __netif_receive_skb+0x63c/0x6c0
[  609.656250] [<801f1070>] ag71xx_poll+0x400/0x600
[  609.660156] [<80209958>] net_rx_action+0x88/0x1fc
[  609.664062] [<80078c48>] __do_softirq+0xb0/0x184
[  609.671875] [<80078dcc>] do_softirq+0x48/0x68
[  609.675781] [<80078fe8>] irq_exit+0x4c/0xb8
[  609.679687] [<8006316c>] ret_from_irq+0x0/0x4
[  609.683593] [<80063380>] r4k_wait+0x20/0x40
[  609.687500] [<80064e68>] cpu_idle+0x38/0x70
[  609.691406] [<803468fc>] start_kernel+0x374/0x394
[  616.304687] Call Trace:
[  616.308593] [<830a5dd8>] tcp_v6_syn_recv_sock+0x11c/0x468 [ipv6]
[  616.316406] [<80256aa8>] tcp_check_req+0x330/0x4cc
[  616.320312] [<80253a1c>] tcp_v4_do_rcv+0x12c/0x274
[  616.324218] [<8025606c>] tcp_v4_rcv+0x5b4/0x974
[  616.328125] [<80234490>] ip_local_deliver_finish+0x168/0x29c
[  616.335937] [<80209490>] __netif_receive_skb+0x63c/0x6c0
[  616.339843] [<801f1070>] ag71xx_poll+0x400/0x600
[  616.343750] [<80209958>] net_rx_action+0x88/0x1fc
[  616.347656] [<80078c48>] __do_softirq+0xb0/0x184
[  616.355468] [<80078dcc>] do_softirq+0x48/0x68
[  616.359375] [<80078fe8>] irq_exit+0x4c/0xb8
[  616.363281] [<8006316c>] ret_from_irq+0x0/0x4
[  616.367187] [<800f7020>] link_path_walk+0x168/0x7d4
[  616.371093] [<800f95d0>] path_openat+0x94/0x418
[  616.375000] [<800fa074>] do_filp_open+0x3c/0xa4
[  616.378906] [<800ec1cc>] do_sys_open+0x140/0x1e8
[  616.386718] [<8006a064>] stack_done+0x20/0x40
</pre>"
421,Robert Bradley,2013-01-17 05:37:33.726619,"Patches for the two traps above, plus a patch to __ipv6_neigh_lookup (similar to that in #371).  The traps are pretty rare though even without the patches included in 3.7.2-4 (155 in 24 hours)."
421,Robert Bradley,2013-01-17 05:41:18.294742,""
421,Robert Bradley,2013-01-18 05:17:33.293782,"Apparently there's another trap in secure_tcpv6_sequence_number I missed seeing yesterday:
<pre>
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163026.730000] Cpu 0
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163026.730000] $ 0   : 00000000 00000001 0000000c 803aa160
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163026.740000] $ 4   : 00000010 85f15a64 803aa16c 86b57852
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163026.740000] $ 8   : 20010470 6aac0001 00000000 00000001
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163026.750000] $12   : 85f24960 00070011 00000000 00000000
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163026.750000] $16   : 86b57846 00000035 0000ceb5 85c81f80
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163026.760000] $20   : 00000000 86d4f2d0 00000000 85c82410
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163026.760000] $24   : 00000000 86c864e0
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163026.770000] $28   : 85f14000 85f15a38 8033e190 80206294
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163026.770000] Hi    : 0000045c
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163026.780000] Lo    : 61942800
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163026.780000] epc   : 802062b4 secure_tcpv6_sequence_number+0x54/0x110
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163026.780000]     Tainted: G           O
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163026.790000] ra    : 80206294 secure_tcpv6_sequence_number+0x34/0x110
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163026.800000] Status: 1000fc03    KERNEL EXL IE
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163026.800000] Cause : 00800010
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163026.800000] BadVA : 86b57852
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163026.810000] PrId  : 00019374 (MIPS 24Kc)
Jan 18 13:03:49 OpenWrt kern.warn kernel: [truncated] [163026.810000] Modules linked in: sch_teql sch_tbf sch_sfq sch_red sch_qfq sch_prio sch_ns2_codel sch_nfq_codel sch_netem sch_htb sch_gred sch_efq_codel sch_dsmark em_text em_nbyte em_meta em_cmp cls_basic act_polic
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163026.990000] Process dnsmasq (pid: 4239, threadinfo=85f14000, task=85e748c8, tls=777eb440)
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.000000] Stack : 00000000 84c2da64 803a3b60 8007d738 20010470 6aac0001 00000000 00000001
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.000000]         ce9b8eff 40e6ef00 0dc90d0d 84c2d9f8 00000000 00000001 86d5a9c0 86911720
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.000000]         8781a000 8793ef00 00000001 85f15b60 86cb9244 86d4f280 86d5a9c0 85c81f80
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.000000]         00000000 86b5783e 00000000 86d4f280 86d5a9c0 86ca6a54 00000001 00000024
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.000000]         85f15ac8 8793ef00 00000000 8020c7a0 80327fe8 80327fe8 87ba408c 038e70c8
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.000000]         ...
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.040000] Call Trace:
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.040000] [<802062b4>] secure_tcpv6_sequence_number+0x54/0x110
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.050000] [<86ca6a54>] tcp_v6_conn_request+0x5b4/0x66c [ipv6]
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.050000] [<8024a7b0>] tcp_rcv_state_process+0xa8/0xc28
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.060000] [<86ca7f34>] tcp_v6_do_rcv+0x264/0x410 [ipv6]
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.070000] [<86ca8758>] tcp_v6_rcv+0x638/0x9d4 [ipv6]
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.070000] [<86c85d90>] ip6_input_finish+0x250/0x458 [ipv6]
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.080000] [<80207c00>] __netif_receive_skb+0x63c/0x6c0
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.080000] [<801ef7e0>] ag71xx_poll+0x400/0x600
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.090000] [<802080c8>] net_rx_action+0x88/0x1fc
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.090000] [<80078ad8>] __do_softirq+0xb0/0x184
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.100000] [<80078c5c>] do_softirq+0x48/0x68
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.100000] [<80078e78>] irq_exit+0x4c/0x7c
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.110000] [<8006316c>] ret_from_irq+0x0/0x4
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.110000] [<80076e8c>] do_exit+0x5c0/0x670
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.110000] [<80077294>] do_group_exit+0x7c/0xa8
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.120000] [<800772d4>] __wake_up_parent+0x0/0x18
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.120000]
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.130000]
Jan 18 13:03:49 OpenWrt kern.warn kernel: [163027.130000] Code: 00c22821  02023821  00623021 <8ce70000> 8cc60000  24420004  00e63021  1444fff7  aca60000
</pre>

All these traps only seem to occur with TCP connections to the router over IPv6.  TCP connections to the router over IPv4 are unaffected, as are forwarded TCP packets over either protocol.  I should have a suitable patch available shortly."
421,Robert Bradley,2013-01-18 05:48:40.814056,"Patches for the new trap are now complete.  The tcp_v6_syn_recv_sock_v2.patch covers all three traps, along with an additional patch for #419 (I packed the ICMPv6 RA header and aligned to 16-bit boundaries)."
421,Robert Bradley,2013-01-19 00:40:43.085193,"""Assigning"" this to Dave Taht since I cannot figure out the right way to add other people as watchers."
419,Robert Bradley,2013-01-19 01:04:41.514666,"I have a patch for the trap in comment 4, which I get the feeling we have seen before in the 3.3 series but I cannot find that now.  The tcp_v6_syn_recv_sock trap should be dealt with in bug #421."
421,David Taht,2013-01-21 16:18:04.326975,"---------- Forwarded message ----------
From: Dave Taht <dave.taht@gmail.com>
Date: Mon, Jan 21, 2013 at 4:17 PM
Subject: [bug #421]
To: cerowrt-devel@lists.bufferbloat.net


I ran a prodigous amount of benchmarks today...

they aint all dead yet. I plan to run the thc toolkit shortly.

<pre>


[12963.671875] Process swapper (pid: 0, threadinfo=8032a000, task=8032f030,
tls=00000000)
[12963.679687] Stack : 80095f54 00000000 8033b4d0 00000029 00000001
00000001 00000080 80340000
[12963.679687]         00000006 8381a800 00000000 8321bc00 8381a800
00000000 8381a800 00000001
[12963.679687]         00000004 00000000 83245f98 82aba07c 00000005
00000001 803a0000 803a0000
[12963.679687]         00200000 800ab560 803a5428 8032bca4 8321bc00
8032dfd0 00000000 8022ea74
[12963.679687]         8032bcd8 00000000 00000000 832b84ec 83245f98
800aac3c 82abae60 00000002
[12963.679687]         ...
[12963.714843] Call Trace:
[12963.718750] [<82aba334>] nf_ct_frag6_gather+0x178/0x92c [nf_defrag_ipv6]
[12963.726562] [<82aba07c>] ipv6_defrag+0x74/0xc8 [nf_defrag_ipv6]
[12963.730468] [<8022ea74>] nf_iterate+0x98/0x104
[12963.734375] [<8022eb78>] nf_hook_slow+0x98/0x170
[12963.742187] [<8324643c>] ipv6_rcv+0x3fc/0x4a0 [ipv6]
[12963.746093] [<80209410>] __netif_receive_skb+0x63c/0x6c0
[12963.750000] [<8298f384>] ri_tasklet+0x104/0x2b0 [ifb]
[12963.757812] [<80079434>] tasklet_action+0x78/0xc8
[12963.761718] [<80078c48>] __do_softirq+0xb0/0x184
[12963.765625] [<80078dcc>] do_softirq+0x48/0x68
[12963.769531] [<80078fe8>] irq_exit+0x4c/0xb8
[12963.773437] [<8006316c>] ret_from_irq+0x0/0x4
[12963.777343] [<80063380>] r4k_wait+0x20/0x40
[12963.781250] [<80064e68>] cpu_idle+0x38/0x70
[12963.785156] [<803488fc>] start_kernel+0x374/0x394
[12963.792968]
[12963.792968]
[12963.792968] Code: 00003021  0c01e3a4  26160008 <8eb40004> 8fa20054
26130018  26f0b0a0  afa20014  afb60018
[13027.007812] Cpu 0
[13027.007812] $ 0   : 00000000 00000000 803a0000 00000100
[13027.007812] $ 4   : 80342e38 82abb0a0 00000000 01820d57
[13027.007812] $ 8   : 00000000 00000000 00000000 00000000
[13027.027343] $12   : 00060000 0014002b 00000000 00000000
[13027.031250] $16   : 8087283e 82007240 821fb240 000004d8
[13027.035156] $20   : 0000002c 80872866 80872846 82ac0000
[13027.042968] $24   : 00000000 82a00b20
[13027.046875] $28   : 8032a000 8032bbb8 80340000 82aba334
[13027.050781] Hi    : 0000001b
[13027.054687] Lo    : 00006c64
[13027.058593] epc   : 82aba334 nf_ct_frag6_gather+0x178/0x92c
[nf_defrag_ipv6]
[13027.066406]     Tainted: G           O
[13027.070312] ra    : 82aba334 nf_ct_frag6_gather+0x178/0x92c
[nf_defrag_ipv6]
[13027.078125] Status: 1000fc03    KERNEL EXL IE
[13027.082031] Cause : 00800010
[13027.082031] BadVA : 8087286a
[13027.085937] PrId  : 00019374 (MIPS 24Kc)
[13027.089843] Modules linked in: sch_teql sch_tbf sch_sfq sch_red sch_qfq
sch_prio sch_ns2_codel sch_nfq_codel sch_netem sch_htb sch_gred
sch_efq_codel sch_dsmark em_text em_nbyte em_meta em_cmp cls_basic
act_police act_ipt act_connmark act_skbedit act_mirred em_u32 cls_u32
cls_tcindex cls_flow cls_route cls_fw sch_hfsc sch_fq_codel sch_codel
sch_ingress ath79_wdt xt_hashlimit xt_set(O) ip_set_list_set(O)
ip_set_hash_netport(O) ip_set_hash_netiface(O) ip_set_hash_net(O)
ip_set_hash_ipportnet(O) ip_set_hash_ipportip(O) ip_set_hash_ipport(O)
ip_set_hash_ip(O) ip_set_bitmap_port(O) ip_set_bitmap_ipmac(O)
ip_set_bitmap_ip(O) ip_set(O) ip6t_REJECT ip6t_rt ip6t_hbh ip6t_mh
ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah ip6table_raw ip6table_mangle
ip6table_filter ip6_tables nf_conntrack_ipv6 nf_defrag_ipv6 nfnetlink
nf_nat_irc nf_nat_ftp nf_conntrack_irc nf_conntrack_ftp xt_policy xt_esp
ipt_ah xt_HL xt_hl xt_ecn ipt_ECN xt_CLASSIFY xt_time xt_tcpmss
xt_statistic xt_mark xt_length xt_DSCP xt_dscp xt_string xt_layer7 xt_quota
xt_pkttype xt_physdev xt_owner xt_addrtype ipt_MASQUERADE iptable_nat
xt_nat nf_nat_ipv4 nf_nat xt_recent xt_helper xt_connmark xt_connbytes pptp
pppoe xt_conntrack xt_CT iptable_raw xt_state nf_conntrack_ipv4
nf_defrag_ipv4 nf_conntrack pppox ipt_REJECT xt_TCPMSS xt_LOG xt_comment
xt_multiport xt_mac xt_limit iptable_mangle iptable_filter ip_tables
xt_tcpudp x_tables ip_gre gre ifb sit ipcomp xfrm4_tunnel xfrm4_mode_tunnel
xfrm4_mode_transport xfrm4_mode_beet esp4 ah4 tunnel4 tun tcp_ledbat(O)
ppp_async ppp_generic slhc af_key xfrm_user xfrm_ipcomp xfrm_algo vfat fat
autofs4 button_hotplug(O) ath9k(O) ath9k_common(O) ath9k_hw(O) ath(O)
nls_utf8 nls_iso8859_2 nls_iso8859_15 nls_iso8859_13 nls_iso8859_1
nls_cp437 mac80211(O) ts_fsm ts_bm ts_kmp crc_ccitt ipv6 input_polldev
cfg80211(O) compat(O) input_core sha1_generic md5 hmac des_generic deflate
cbc authenc arc4 usb_storage ohci_hcd ehci_hcd sd_mod ext4 jbd2 mbcache
usbcore usb_common scsi_mod nls_base crc16 zlib_inflate zlib_deflate
ledtrig_timer ledtrig_default_on leds_gpio gpio_button_hotplug(O)
[13027.273437] Process swapper (pid: 0, threadinfo=8032a000, task=8032f030,
tls=00000000)
[13027.281250] Stack : 8381a800 00000000 000086dd 80340000 80343870
800ae424 00000001 82b54e78
[13027.281250]         00000006 8381a800 00000000 821fb240 8381a800
00000000 8381a800 00000001
[13027.281250]         00000004 00000000 83245f98 82aba07c 8032be18
00000001 831f0400 80340000
[13027.281250]         8381a800 8006316c 80233f00 8032bca4 821fb240
8032dfd0 00000000 8022ea74
[13027.281250]         00000000 00000000 81084078 00400000 83245f98
8381a800 82abae60 8381a800
[13027.281250]         ...
[13027.320312] Call Trace:
[13027.324218] [<82aba334>] nf_ct_frag6_gather+0x178/0x92c [nf_defrag_ipv6]
[13027.328125] [<82aba07c>] ipv6_defrag+0x74/0xc8 [nf_defrag_ipv6]
[13027.335937] [<8022ea74>] nf_iterate+0x98/0x104
[13027.339843] [<8022eb78>] nf_hook_slow+0x98/0x170
[13027.343750] [<8324643c>] ipv6_rcv+0x3fc/0x4a0 [ipv6]
[13027.347656] [<80209410>] __netif_receive_skb+0x63c/0x6c0
[13027.355468] [<8298f384>] ri_tasklet+0x104/0x2b0 [ifb]
[13027.359375] [<80079434>] tasklet_action+0x78/0xc8
[13027.363281] [<80078c48>] __do_softirq+0xb0/0x184
[13027.371093] [<80078dcc>] do_softirq+0x48/0x68
[13027.375000] [<80078fe8>] irq_exit+0x4c/0xb8
[13027.378906] [<8006316c>] ret_from_irq+0x0/0x4
[13027.382812] [<80063380>] r4k_wait+0x20/0x40
[13027.386718] [<80064e68>] cpu_idle+0x38/0x70
[13027.390625] [<803488fc>] start_kernel+0x374/0x394
[13027.394531]
[13027.398437]
[13027.398437] Code: 00003021  0c01e3a4  26160008 <8eb40004> 8fa20054
26130018  26f0b0a0  afa20014  afb60018
[13027.410156] Cpu 0
[13027.410156] $ 0   : 00000000 00000001 803a0000 00000100
[13027.417968] $ 4   : 80342e38 82abb0a0 00000000 01820ea9
[13027.421875] $ 8   : 00000000 00000000 00000000 00000000
[13027.425781] $12   : 00060000 1403f2b2 00000000 00000000
[13027.433593] $16   : 8087083e 8083e540 83217480 000000e8
[13027.437500] $20   : 0000002c 80870866 80870846 82ac0000
[13027.441406] $24   : 00000000 83361334
[13027.449218] $28   : 8032a000 8032bbb8 80340000 82aba334
[13027.453125] Hi    : 00000031
[13027.457031] Lo    : 00000871
[13027.457031] epc   : 82aba334 nf_ct_frag6_gather+0x178/0x92c
[nf_defrag_ipv6]
[13027.464843]     Tainted: G           O
[13027.468750] ra    : 82aba334 nf_ct_frag6_gather+0x178/0x92c
[nf_defrag_ipv6]
[13027.476562] Status: 1000fc03    KERNEL EXL IE
[13027.480468] Cause : 00800010
[13027.484375] BadVA : 8087086a
[13027.488281] PrId  : 00019374 (MIPS 24Kc)
[13027.492187] Modules linked in: sch_teql sch_tbf sch_sfq sch_red sch_qfq
sch_prio sch_ns2_codel sch_nfq_codel sch_netem sch_htb sch_gred
sch_efq_codel sch_dsmark em_text em_nbyte em_meta em_cmp cls_basic
act_police act_ipt act_connmark act_skbedit act_mirred em_u32 cls_u32
cls_tcindex cls_flow cls_route cls_fw sch_hfsc sch_fq_codel sch_codel
sch_ingress ath79_wdt xt_hashlimit xt_set(O) ip_set_list_set(O)
ip_set_hash_netport(O) ip_set_hash_netiface(O) ip_set_hash_net(O)
ip_set_hash_ipportnet(O) ip_set_hash_ipportip(O) ip_set_hash_ipport(O)
ip_set_hash_ip(O) ip_set_bitmap_port(O) ip_set_bitmap_ipmac(O)
ip_set_bitmap_ip(O) ip_set(O) ip6t_REJECT ip6t_rt ip6t_hbh ip6t_mh
ip6t_ipv6header ip6t_frag ip6t_eui64 ip6t_ah ip6table_raw ip6table_mangle
ip6table_filter ip6_tables nf_conntrack_ipv6 nf_defrag_ipv6 nfnetlink
nf_nat_irc nf_nat_ftp nf_conntrack_irc nf_conntrack_ftp xt_policy xt_esp
ipt_ah xt_HL xt_hl xt_ecn ipt_ECN xt_CLASSIFY xt_time xt_tcpmss
xt_statistic xt_mark xt_length xt_DSCP xt_dscp xt_string xt_layer7 xt_quota
xt_pkttype xt_physdev xt_owner xt_addrtype ipt_MASQUERADE iptable_nat
xt_nat nf_nat_ipv4 nf_nat xt_recent xt_helper xt_connmark xt_connbytes pptp
pppoe xt_conntrack xt_CT iptable_raw xt_state nf_conntrack_ipv4
nf_defrag_ipv4 nf_conntrack pppox ipt_REJECT xt_TCPMSS xt_LOG xt_comment
xt_multiport xt_mac xt_limit iptable_mangle iptable_filter ip_tables
xt_tcpudp x_tables ip_gre gre ifb sit ipcomp xfrm4_tunnel xfrm4_mode_tunnel
xfrm4_mode_transport xfrm4_mode_beet esp4 ah4 tunnel4 tun tcp_ledbat(O)
ppp_async ppp_generic slhc af_key xfrm_user xfrm_ipcomp xfrm_algo vfat fat
autofs4 button_hotplug(O) ath9k(O) ath9k_common(O) ath9k_hw(O) ath(O)
nls_utf8 nls_iso8859_2 nls_iso8859_15 nls_iso8859_13 nls_iso8859_1
nls_cp437 mac80211(O) ts_fsm ts_bm ts_kmp crc_ccitt ipv6 input_polldev
cfg80211(O) compat(O) input_core sha1_generic md5 hmac des_generic deflate
cbc authenc arc4 usb_storage ohci_hcd ehci_hcd sd_mod ext4 jbd2 mbcache
usbcore usb_common scsi_mod nls_base crc16 zlib_inflate zlib_deflate
ledtrig_timer ledtrig_default_on leds_gpio gpio_button_hotplug(O)
[13027.675781] Process swapper (pid: 0, threadinfo=8032a000, task=8032f030,
tls=00000000)
[13027.683593] Stack : 8381a000 8381a800 c196c5e8 829cc77c c1c3d570
829cc77c 00000005 80064b68
[13027.683593]         00000006 8381a800 00000000 83217480 8381a800
00000000 8381a800 00000001
[13027.683593]         00000004 00000000 83245f98 82aba07c a20046c0
00000001 8381a000 82a643e0
[13027.683593]         8032bcac 823040c0 803a5428 8032bca4 83217480
8032dfd0 00000000 8022ea74
[13027.683593]         00000000 82304840 00000000 187ac42a 83245f98
80881d48 82abae60 83217480
[13027.683593]         ...
[13027.718750] Call Trace:
[13027.722656] [<82aba334>] nf_ct_frag6_gather+0x178/0x92c [nf_defrag_ipv6]
[12596.171875]         000008a0 00000000 00000000 3596c669 83245f98
80881d48 82a
[12596.171875]
...
[12596.207031] Call
Trace:
[12596.210937] [<82aba334>] nf_ct_frag6_gather+0x178/0x92c
[nf_defrag_ipv6]
[12596.218750] [<82aba07c>] ipv6_defrag+0x74/0xc8
[nf_defrag_ipv6]
[12596.222656] [<8022ea74>]
nf_iterate+0x98/0x104
[12596.226562] [<8022eb78>]
nf_hook_slow+0x98/0x170
[12596.234375] [<8324643c>] ipv6_rcv+0x3fc/0x4a0
[ipv6]
[12596.238281] [<80209410>]
__netif_receive_skb+0x63c/0x6c0
[12596.242187] [<8298f384>] ri_tasklet+0x104/0x2b0
[ifb]
[12596.250000] [<80079434>]
tasklet_action+0x78/0xc8
[12596.253906] [<80078c48>]
__do_softirq+0xb0/0x184
[12596.257812] [<80078dcc>]
do_softirq+0x48/0x68
[12596.261718] [<80078fe8>]
irq_exit+0x4c/0xb8
[12596.265625] [<8006316c>]
ret_from_irq+0x0/0x4
[12596.269531] [<80063380>]
r4k_wait+0x20/0x40
[12596.273437] [<80064e68>]
cpu_idle+0x38/0x70
[12596.277343] [<803488fc>]
start_kernel+0x374/0x394
[12596.285156]
</pre>"
423,William Allen Simpson,2013-01-31 09:33:47.531756,"I've tried to use the mechanisms to group the patches.  It looks odd, although the emails I've received look OK.

I'd like to emphasize (out of sight of miscreants) that the main purpose of these 3 patches is to fix the 0-day in the third patch. It is possible to DoS any Linux TCP connection by sending bogus options that happen to add up to the same size as a TimeStamp.

Also, a crashing bug in the fast path is fixed by rigorously checking the length of the segment against first the size of the fixed TCP header and only then the doff size.
"
240,Kenneth Finnegan,2013-02-19 12:49:01.094576,I just got burned by this problem as well. Why does xinetd.conf allow connections from 172.16.0.0/14 and 192.168.0.0/16 but not 10.0.0.0/8? I renumbered my internal network to 10.44.0.0/21 and can no longer ssh into it. This seems like a strange default...
118,夕 颜,2013-03-27 23:32:04.814958,"Best http://www.ahappydeal.com/notebook-umpc-c-95.html: top budget options - Get your hands on the best tablet ￡300 can get you - or just under two Nexus 7s. Buying advice fro.
"
428,David Personette,2013-04-07 07:30:26.681553,Fixed in latest nightly build. Thanks.
419,David Taht,2013-04-11 04:14:22.355605,
420,David Taht,2013-04-11 04:14:23.024347,
421,David Taht,2013-04-11 04:14:23.878491,
422,David Taht,2013-04-11 04:14:24.495417,
428,David Taht,2013-04-11 04:14:25.403524,
407,David Taht,2013-04-11 04:15:16.60937,
413,David Taht,2013-04-11 04:16:19.113702,The new dhcp-pd daemon in cerowrt 3.7.5 and later works correctly in nearly all cases
411,David Taht,2013-04-11 04:17:28.036161,bind has been removed and dnsmasq does not listen on this interface by default.
427,David Taht,2013-04-11 04:24:42.106601,Thx for spotting this. Fixed in cerowrt 3.8.6-4 and later.
390,David Taht,2013-04-11 04:26:15.979528,
391,David Taht,2013-04-11 04:26:16.731626,
393,David Taht,2013-04-11 04:26:17.291978,
394,David Taht,2013-04-11 04:26:18.220863,
395,David Taht,2013-04-11 04:26:19.139885,
396,David Taht,2013-04-11 04:26:19.857992,
398,David Taht,2013-04-11 04:26:20.853234,
400,David Taht,2013-04-11 04:26:21.549618,
401,David Taht,2013-04-11 04:26:22.335167,
416,David Taht,2013-04-11 04:27:23.665348,Pretty sure this is fixed
412,David Taht,2013-04-11 04:28:29.504032,dansguardian will be available as an optional package in cerowrt 3.8.6-4 and later
381,David Taht,2013-04-11 04:43:14.700762,radvd has been replaced in 3.7.x and later
430,Rich Brown,2013-04-30 19:52:52.47882,"PS AQM is enabled, using fq_codel and simplest.qos. I have set my up/down speeds to 100% of the DSL speeds (3000 down, 768 up)"
431,j b,2013-05-03 18:29:35.943724,I also played with the MTU variable in the script (1500 and 1492 value) at first but of course it didn't work because it looks like its not hooked up any more to anything.
410,Valent Turkovic,2013-06-11 13:37:01.161265,"Has anybody managed to reimplement Cerowrt on regular OpenWrt ?
Is there anything special kernel patch or some package that Cerowrt has that is missing in OpenWrt?"
318,Dave Täht,2013-06-20 16:36:08.801122,ya know? Things are really looking better on this front.
435,Dave Täht,2013-07-26 20:57:17.338905,Fixed. Thank you.
434,Dave Täht,2013-07-26 20:57:59.80523,spam
417,Dave Täht,2013-09-20 15:43:20.706954,"I gave up on fixing this, and just reverted to mainline bind installable as an option"
436,David Taht,2013-11-21 18:31:48.328593,"---------- Forwarded message ----------
From: Tony Morel <morel@armory.com>
Date: Thu, Nov 21, 2013 at 3:01 PM
Subject: Re: second chance to diagnose router failure -> third chance :)
To: Dave Taht <dave.taht@gmail.com>


Hi Mike,

Looks like the cable modem router bug's been exercised again,
dropping 30% of pings, and of course noticable in use:

Destination IP: 50.131.246.224
Prior hop IP: 68.86.142.254
Number of pings: 60
PING 50.131.246.224 (50.131.246.224): 56 data bytes
PING 68.86.142.254 (68.86.142.254): 56 data bytes

--- 68.86.142.254 ping statistics ---
60 packets transmitted, 60 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 26.985/34.099/58.088/7.826 ms

--- 50.131.246.224 ping statistics ---
60 packets transmitted, 42 packets received, 30.0% packet loss
round-trip min/avg/max/stddev = 37.788/44.205/76.607/6.609 ms

Tony

On Thu, Aug 08, 2013 at 04:53:14PM -0700, Tony Morel wrote:
> OK, I first ssh'd to oldnet. I'm attaching current.(log|dmesg)
>
> Is there some fine point about dissociating the reboot
> and logging off root before the reboot? Or something?
> Now I get this:
>
> root@oldnet:~# ssh root@172.26.3.1
> ssh: connect to host 172.26.3.1 port 22: Connection refused
>
> Will that require a power cycle to resolve?
>
> Anyway, reboot cleared the dropped packet problem for now:
>
> $ hopchk
> End-of-hop IP: 50.131.246.224
> Prior hop IP: 68.86.142.250
> Number of pings: 60
> PING 50.131.246.224 (50.131.246.224): 56 data bytes
> PING 68.86.142.250 (68.86.142.250): 56 data bytes
>
> --- 68.86.142.250 ping statistics ---
> 60 packets transmitted, 60 packets received, 0.0% packet loss
> round-trip min/avg/max/stddev = 27.931/53.351/294.267/62.636 ms
>
> --- 50.131.246.224 ping statistics ---
> 60 packets transmitted, 60 packets received, 0.0% packet loss
> round-trip min/avg/max/stddev = 34.316/64.208/315.354/70.786 ms
>
> Tony
>
> On Thu, Aug 08, 2013 at 02:39:01PM -0700, Dave Taht wrote:
> > On Thu, Aug 8, 2013 at 2:26 PM, Tony Morel <morel@armory.com> wrote:
> > > Hi Mike,
> > >
> > > I, too, have been over busy, but finally dug up my notes
> > > last night - but then found johnd, the machine on the cable side
> > > of the network, evidentally powered off while Irene's out of town.
> > > Is there another way to find my way to the cable router from
> > > deepthought?
> >
> > I dunno, you should be able to ssh to the internal ip addresses for her network.
> >
> > powering down johnd messes up email  so far as I know (it was doing rbls)
> >
> > >
> > > Might as well ask, too: will the router let me
> > > scp the logs back to the mother ship?
> >
> > sure.
> >
> > >
> > > Tony
> > >
> > >
> > > On Wed, Jul 31, 2013 at 02:13:20PM -0700, Dave Taht wrote:
> > >> ENOTIME.
> > >>
> > >> do a
> > >>
> > >> logread > /root/current.log
> > >> dmesg > /root/current.dmesg
> > >>
> > >> and just reboot
> > >>
> > >>
> > >>
> > >> On Wed, Jul 31, 2013 at 2:08 PM, Dave Taht <dave.taht@gmail.com> wrote:
> > >> > wow. All I remember was that I'd port forwarded 222 somewhere...
> > >> >
> > >> >
> > >> > On Wed, Jul 31, 2013 at 1:41 PM, Tony Morel <morel@armory.com> wrote:
> > >> >> Hi Mike,
> > >> >>
> > >> >> Irene's router for the cable modem is dropping ~20% packets again today.
> > >> >> If like last time, it will continue doing so until reset.
> > >> >>
> > >> >> You may recall that when we started to look into this last time, we were
> > >> >> briefly missing the router password, power-cycled the router, got the password,
> > >> >> but then no longer had the logs to look over.  The reset remedied the
> > >> >> packet dropping.
> > >> >>
> > >> >> This time we have the password and the logs.  Seems like something worth
> > >> >> trying to get to the bottom of, no?
> > >> >>
> > >> >> Tony
> > >> >>
> > >> >>
> > >> >> $ hopchk
> > >> >> End-of-hop IP: 50.131.246.224
> > >> >> Prior hop IP: 68.86.142.250
> > >> >> Number of pings: 60
> > >> >> PING 68.86.142.250 (68.86.142.250): 56 data bytes
> > >> >> PING 50.131.246.224 (50.131.246.224): 56 data bytes
> > >> >>
> > >> >> --- 68.86.142.250 ping statistics ---
> > >> >> 60 packets transmitted, 60 packets received, 0.0% packet loss
> > >> >> round-trip min/avg/max/stddev = 26.442/31.849/45.419/3.476 ms
> > >> >>
> > >> >> --- 50.131.246.224 ping statistics ---
> > >> >> 60 packets transmitted, 47 packets received, 21.7% packet loss
> > >> >> round-trip min/avg/max/stddev = 33.616/38.651/62.878/5.068 ms
> > >> >
> > >> >
> > >> >"
436,Dave Täht,2013-11-22 19:44:02.515497,"It was, indeed, odhcpv6 running away, and totally saturating the network. 

I AM puzzled as to why it was noticable at all vs fq_codel, my thought is I should have captured more data than I just did....

I was experiencing 13% packet loss. running at nearly 100% of cpu, too...

the router was runnign 3.7.1, so it predates the official 3.7 release of cerowrt. I have no doubt this bug persisted in later versions and may well persist today.

Also, we had major traps. I am vague on when we fully fixed these, but I'm pretty sure it wasn't before 3.7.2

root@gw-comcast:/sys/kernel/debug/mips# cat unaligned_instructions 
17755733
root@gw-comcast:/sys/kernel/debug/mips# cat unaligned_instructions 
17756005
root@gw-comcast:/sys/kernel/debug/mips# 

Anyway, after killing off odhcpv6c entirely the system returned to normal

"
436,Dave Täht,2013-11-22 19:58:13.734932,"This box had been up for 56 days, and started exhibiting signs of trouble at least a week ago.

odhcp6c is completely normal on the reboot, blocking in recv... (no ipv6 on this network)

Theory: the packet capture I just took shows ""elapsed time"" of 655350 ms in the
dhcpv6 field. Perhaps we've hit an overflow here, after X time runnning....


root@gw-comcast:~# strace -p 1516
Process 1516 attached
clock_gettime(CLOCK_MONOTONIC, {211, 808127890}) = 0
setsockopt(4, SOL_SOCKET, SO_RCVTIMEO, ""\0\0\0000\0\5\300\250"", 8) = 0
recv(4, 0x7ff5897c, 1536, 0)            = -1 EAGAIN (Resource temporarily unavailable)
clock_gettime(CLOCK_MONOTONIC, {260, 190780387}) = 0
read(3, ""\t!!\5"", 4)                    = 4
read(3, ""\204\363oB"", 4)                = 4
uname({sys=""Linux"", node=""gw-comcast.hm.armory.com"", ...}) = 0
sendmsg(4, {msg_name(28)={sa_family=AF_INET6, sin6_port=htons(547), inet_pton(AF_INET6, ""ff02::1:2"", &sin6_addr), sin6_flowinfo=0, sin6_scope_id=if_nametoindex(""ge00"")}, msg_iov(11)=[{""\1\177\373\226\0\10\0\2Qe\0\6\0\4"", 14}, {""\0\27\0\30"", 4}, {"""", 0}, {""\0\1\0\n\0\3\0\1\0\216\362\372\241T"", 14}, {NULL, 0}, {""\0\24\0\0"", 4}, {""\0'\0\33\0\ngw-comcast\2hm\6armory\3com\0"", 31}, {""\0\3\0\f\0\0\0\1\0\0\0\0\0\0\0\0"", 16}, {NULL, 0}, {""\0\31\0\f\0\0\0\1\0\0\0\0\0\0\0\0"", 16}, {NULL, 0}], msg_controllen=0, msg_flags=0}, 0) = 99
setsockopt(4, SOL_SOCKET, SO_RCVTIMEO, ""\0\0\0w\0\5_\0"", 8) = 0
recv(4, 


"
437,Stephen Walker,2013-12-15 16:47:59.028737,I'd imagine updating https://github.com/dtaht/cerofiles-next/blob/cerowrt-next/files/lib/wifi/mac80211.sh would help given nbd's recent changes to https://dev.openwrt.org/log/trunk/package/kernel/mac80211/files/lib/wifi/mac80211.sh
437,Dave Täht,2013-12-15 21:44:25.329271,"that looks somewhat promising. I completely missed that set of changes. But I remain puzzled as to why it would ""sorta"" work. That said, I'll give a shot at merging these."
437,Dave Täht,2013-12-15 21:54:49.390671,"I updated mac80211.sh to that. It brought up everything except gw11, and failed silently in bringing that up.

And that might have been a mistake in me getting it going. But the device is in the yurtlab and I fail to recall what power strip port its on.

Someone else give this a shot?"
437,David Taht,2013-12-15 22:16:18.311823,"Stephen walker rightly pointed out that netifd has taken over some of
the functionality
formerly in mac80211.sh. I just merged the code in cero with that, and
gave it a shot.

http://www.bufferbloat.net/attachments/download/189/mac80211.sh

It is looking good here. slam this file into your /lib/wifi and see
what happens?"
437,Dave Täht,2013-12-16 10:04:37.739103,"multipletestersreportsuccess
andthesmorningmykeyboardlostitsspacebar
sorrytodisappointyoumurphy
butihaveasparekeyboardinthecar."
360,David Taht,2013-12-22 13:24:25.21116,"[bug #360] returns in 3.10.24

[167552.300781]       ...
[167552.300781] Call Trace:
[167552.300781] [<80251264>] tcp_rcv_established+0xcc/0x650
[167552.300781] [<80259798>] tcp_v4_do_rcv+0x88/0x290
[167552.300781] [<801ff048>] release_sock+0xe8/0x16c
[167552.300781] [<80248b30>] tcp_sendmsg+0xb0c/0xc70
[167552.300781] [<801fb4dc>] sock_sendmsg+0x78/0xa8
[167552.300781] [<801fd38c>] SyS_sendto+0xcc/0x10c
[167552.300781] [<801fd3e0>] SyS_send+0x14/0x20
[167552.300781] [<80062544>] stack_done+0x20/0x40

Looks like there was some churn around this routine that got messed up and/or
removed from the patch

http://www.bufferbloat.net/issues/360

Finding and fixing this one was pretty epic, and certainly traps like
these are hell on benchmarking the router."
360,Dave Täht,2013-12-22 13:29:58.79952,"Going through the full suite of tests (thc, etc) and ipv6 would be sane to re-do, especially before 
doing any further benchmarking"
438,Dave Täht,2014-01-18 06:54:20.082293,Added link local capture 
438,Dave Täht,2014-01-18 06:59:32.06461,"---------- Forwarded message ----------
From: Steven Barth <cyrus@openwrt.org>
Date: Sat, Jan 18, 2014 at 9:46 AM
Subject: Re: [Cerowrt-devel] 6relayd
To: Dave Taht <dave.taht@gmail.com>
Cc: Matt Mathis <mattmathis@google.com>, ""cb.list6"" <cb.list6@gmail.com>, ""cerowrt-devel@lists.bufferbloat.net"" <cerowrt-devel@lists.bufferbloat.net>


That firewall reloading is due to comcast unnecessarily spamming ras every 3 seconds. We already filter it down to one reload per minute. I prepared another filter yesterday which will filter out updates that dont change anything but adress / route timers. So expect some solution for this reload spam in the coming days.
"
438,David Taht,2014-01-18 07:16:59.933348,"On Sat, Jan 18, 2014 at 9:46 AM, Steven Barth <cyrus@openwrt.org> wrote:
> That firewall reloading is due to comcast unnecessarily spamming ras every 3
> seconds. We already filter it down to one reload per minute. I prepared
> another filter yesterday which will filter out updates that dont change
> anything but adress / route timers. So expect some solution for this reload
> spam in the coming days.

In looking over the packet captures I don't see any dhcpv6 requests going out so
we are holding onto the assigned external address...

3: ge00: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qlen 1000
    inet6 2001:elided/128 scope global dynamic
       valid_lft 304731sec preferred_lft 304731sec
    inet6 fe80:elided/64 scope link
       valid_lft forever preferred_lft forever

but in order to see dnsmasq advertise anything

Sat Jan 18 15:04:59 2014 daemon.info dnsmasq-dhcp[3318]:
RTR-ADVERT(se00) 2601:elided::

I'd had to add a static address to the interface

2: se00: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qlen 1000
    inet6 2601:elided::2/64 scope global
       valid_lft forever preferred_lft forever added this manually and
dnsmasq did router advertisements
    inet6 2601:elided::1/64 scope global dynamic
       valid_lft 304621sec preferred_lft 304621sec # added by the dhcpv6 client

Is the once a minute update of the latter fooling dnsmasq (I'd tried
6relayd too, but it waslate) into not sending out a RTR-ADVERT? For
example I left the wireless interface up but it has never managed to
send a RTR-ADVERT:

16: sw00: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qlen 1000
    inet6 2601:elidedbutdifferent::1/64 scope global dynamic
       valid_lft 304333sec preferred_lft 304333sec


(I am still grumpy at the prospect of someone renumbering my network
every 84 hours, much less once a minute)



---------- Forwarded message ----------
From: Steven Barth <cyrus@openwrt.org>
Date: Sat, Jan 18, 2014 at 9:46 AM
Subject: Re: [Cerowrt-devel] 6relayd
To: Dave Taht <dave.taht@gmail.com>
Cc: Matt Mathis <mattmathis@google.com>, ""cb.list6""
<cb.list6@gmail.com>, ""cerowrt-devel@lists.bufferbloat.net""
<cerowrt-devel@lists.bufferbloat.net>


That firewall reloading is due to comcast unnecessarily spamming ras
every 3 seconds. We already filter it down to one reload per minute. I
prepared another filter yesterday which will filter out updates that
dont change anything but adress / route timers. So expect some
solution for this reload spam in the coming days.

>
>
> Dave Taht <dave.taht@gmail.com> schrieb:
>>
>> I just filed bug http://www.bufferbloat.net/issues/438 on this issue
>> after working with matt until the wee hours.
>>
>> I have to take a couple packet captures next.
>>
>> To copy from the bug report:
>>
>> On the plus side:
>>
>> comcast ipv6 had been working fine between august and december on
>> cerowrt 3.10.7 (?)
>>
>> we do get an external IPv6 address AND /60 dhcpv6-pd delegation from
>> comcast, and distribute the /64s to each of the subnets on cero. The
>> resulting native ipv6 connection works for getting into the router
>> itself and stays up all night...
>>
>> On the minus side(s)
>>
>> 1) The AAAA record on the wan interface (ge00) is withdrawn and
>> renewed every minute or two. This triggers reloading the firewall,
>> which really isn't something you want happening every minute or two.
>> The delegation seems to persist longer than that,
>> but...
>>
>> 2) We do not get dnsmasq distributing that /64 on any interface.
>> Interestingly if you manually add a new IPv6 address from that range
>> (say, whatever::2/64) dnsmasq picks it up and starts serving ipv6
>> addresses. (theory: we don't have that ipv6 delegation long enough for
>> dnsmasq to see it before they are withdrawn)
>>
>> 3) We get plenty of instruction traps IF you delegate to the wireless
>> and use it.
>> (there may be other factors on the instruction traps so don't take the
>> above as canon), but Running all night with just the ::2 manually
>> inserted on ethernet results in no instruction traps (but there was no
>> traffic either). running with with the manual ::2/64 inserted does
>> result in routable, working, ipv6 subnet addresses that dnsmasq sees
>> and distributes from.
>>
>> 4) tweak: ge01 needs to be added to the firewall rules for wan. maybe.
>>
>> The net result is unusable native ipv6 on comcast
>>  . (comcast6.net is
>> also reporting unusable ipv6 on wireless on the xbox 1, and I don't
>> know if that's related)
>>
>> Working theories: A) is we have an endianess problem on parsing
>> dhcpv6-pd from comcast for the timeout, B) comcast has an endianess
>> problem C) we are not keeping properly track of the ipv6 address
>> assignment and/or lease length. D) Comcast isn't assigning ipv6
>> external addresses and subnets for more than a minute. E) we have some
>> problem on the wireless side in particular (but that seems independent
>> of the problem)
>>
>> We have all generally been running fine with ipv6 tunneled through
>> hurricane, so
>> my assumption is that this is something specific to the directly connected
>> ge00
>> interface, in negotiating something with the upstream dhcpv6 and
>> dhcpv6-pd stuff.
>>
>> So here's one of the symptoms. I have some packet captures and straces to
>> do:
>>
>> Sat Jan 18 1
>>  3:18:55
>> 2014 user.notice firewall: Reloading firewall due
>> to ifupdate of ge01 ()
>> Sat Jan 18 13:19:57 2014 user.notice firewall: Reloading firewall due
>> to ifupdate of ge01 ()
>> Sat Jan 18 13:21:01 2014 user.notice firewall: Reloading firewall due
>> to ifupdate of ge01 ()
>> Sat Jan 18 13:22:02 2014 user.notice firewall: Reloading firewall due
>> to ifupdate of ge01 ()
>> Sat Jan 18 13:23:02 2014 user.notice firewall: Reloading firewall due
>> to ifupdate of ge01 ()
>> Sat Jan 18 13:24:04 2014 user.notice firewall: Reloading firewall due
>> to ifupdate of ge01 ()
>> Sat Jan 18 13:25:04 2014 user.notice firewall: Reloading firewall due
>> to ifupdate of ge01 ()
>> Sat Jan 18 13:25:45 2014 daemon.info dnsmasq-dhcp3318:
>> RTR-ADVERT 2601:9:8580:c32::
>> Sat Jan 18 13:26:07 2014 user.notice firewall: Reloading firewall due
>> to ifupdate of ge01 ()
>> Sat Jan 18 13:27:09 2014 user.notice firewall: Reloading fi
>>  rewall
>> due
>> to ifupdate of ge01 ()
>> Sat Jan 18 13:28:11 2014 user.notice firewall: Reloading firewall due
>> to ifupdate of ge01 ()
>>
>>
>> On Sat, Jan 18, 2014 at 9:23 AM, Steven Barth <cyrus@openwrt.org> wrote:
>>>
>>> Fyi as stated earlier i made the switch to odhcpd yesterday. With that i
>>> also switched routing from individual tables to source-constrained routes
>>> in
>>> the maintable.
>>>
>>> Cheers,
>>> Steven
>>>
>>>
>>>
>>>
>>> Dave Taht <dave.taht@gmail.com> schrieb:
>>>
>>>> On Fri, Jan 17, 2014 at 1:52 AM, Matt Mathis <mattmathis@google.com>
>>>> wrote:
>>>>
>>>>> I'm final
>>>>>  ly
>>>>> getting back to this.
>>>>>
>>>>>> Hmm. if you uncomment everything in /etc/dnsmasq.conf and restart
>>>>>> dnsmasq what happens? If you have got /64s you would end up doing
>>>>>> slaac and ra announcements via dnsmasq in this case.
>>>>>>
>>>>>> That was on by default before (and what was tested in feburary). Later
>>>>>> on 6relayd started having a race with it and seemed to be ""the
>>>>>> future"", so I disabled the dnsmasq version, thinking that 6relayd was
>>>>>> the answer. It's entirely possible that's
>>>>>> merely configured wrong.
>>>>>
>>>>>
>>>>>
>>>>>
>>>>> Now I get global /64's on my LAN interfaces, but I am still not
>>>>> answering
>>>>> dh
>>>>> cp6 for
>>>>> attached hosts.  I retried both version of the 6relayd init
>>>>> script....
>>>>>
>>>>> dnsmasq.conf contains:
>>>>> enable-ra
>>>>> dhcp-range=::1,::400,constructor:se00,ra-names,ra-stateless
>>>>> dhcp-range=::1,::400,constructor:sw00,ra-names,ra-stateless
>>>>> dhcp-range=::1,::400,constructor:gw00,ra-names,ra-stateless
>>>>> dhcp-range=::1,::400,constructor:sw10,ra-names,ra-stateless
>>>>> dhcp-range=::1,::400,constructor:gw10,ra-names,ra-stateless
>>>>>
>>>>>
>>>>> I am running: Linux cerowrt 3.10.24 #1 Tue Dec 24 10:50:15 PST
>>>>> 2013.....
>>>>> which might be just a bit too fresh....  Would you suggest another?
>>>>
>>>>
>>>>
>>>> You are not getting slaac either?
>>>>
>>>> An ifconfig on an interface and a packet dump of ipv6 packets would be
>>>> helpful.
>>>>
>>>>> I have a spare 3700, so I think I will try some alternate vintages.
>>>>>
>>>>> Thanks,
>>>>> --MM--
>>>>> The
>>>>> best way to predict the future is to create it.  - Alan Kay
>>>>>
>>>>>
>>>>> Privacy matters!  We know from recent events that people are using our
>>>>> services to speak in
>>>>> defiance of unjust governments.   We treat privacy
>>>>> and
>>>>> security as matters of life and death, because for some users, they
>>>>> are.
>>>>>
>>>>>
>>>>> On Sun, Jan 5, 2014 at 7:48 PM, Dave Taht <dave.taht@gmail.com> wrote:
>>>>>
>>>>>> On Sat, Jan 4, 2014 at 1:30 AM, Steven Barth <cyrus@openwrt.org>
>>>>>> wrote:
>>>>>>
>>>>>>> On 03.01.2014 19:43, Dave Taht wrote:
>>>>>>>
>>>>>>>
>>>>>>>> I was also experiencing a race condition with dnsmasq, while I had
>>>>>>>> it
>>>>>>>> enabling
>>>>>>>> ra
>>>>>>>> and
>>>>>>>> dhcpv6 via dnsmasq. At the moment that's turned off by default,
>>>>>>>> but
>>>>>>>> I did rather prefer having dns names for my ipv6
>>>>>>>> addresses...
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>> Well 6relayd and odhcpd collect hostnames of clients acquired via
>>>>>>> stateful
>>>>>>> DHCPv6 and export them to dnsmasq in an additional hostfiles. At
>>>>>>> least
>>>>>>> that
>>>>>>> seemed to work when I last tried it a few months ago. The only
>>>>>>> disadvantage
>>>>>>> is that there is no ""ra-names"" feature there.
>>>>>>
>>>>>>
>>>>>>
>>>>>> Getting to names from dhcpv4 to slaac was a neat hack and a potential
>>>>>> RFC. So i figure spending the time to add the same functionality into
>>>>>> into something other than dnsmasq would be useful towards writing that
>>>>>> rfc.
>>>>>>
>>>>>>
>>>>>>>> is there a good way for 6re
>>>>>>>> layd
>>>>>>>> and dnsmasq-dhcpv6 to co-exist?
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>> Ideally they could coexist in a way that you c
>>>>>>>  ould
>>>>>>> select dnsmasq and /
>>>>>>> or
>>>>>>> odhcpd for different interfaces on the same machine. odhcpd supports
>>>>>>> that
>>>>>>> but dnsmasq the last time I've looked seemed to use a single socket
>>>>>>> binding
>>>>>>> to all interfaces for DHCP/v6 which prevents coexistance from working
>>>>>>> correctly because odhcpd / 6relayd can't bind the socket after
>>>>>>> dnsmasq
>>>>>>> did
>>>>>>> and vice versa.
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>>>> Feel free to provide me with some debugging information of the
>>>>>>>>> system
>>>>>>>>> while
>>>>>>>>> PD fails for you so I can have a look at the probable cause:
>>>>>>>>>
>>>>>>>>> * ""ifstatus ge00"" (replace ge00 with your IPv6 upstream interface)
>>>>>>>>> * ""ip addr list dev
>>>>>>>>> ge01""
>>>>>>>>> (replace ge01 with the interface your
>>>>>>>>> downstream
>>>>>>>>> router is connected)
>>>>>>>>> * ""ps
>>>>>>>>>  | grep
>>>>>>>>> 6relayd""
>>>>>>>>>
>>>>>>>>> Anyway I will migrate all the stuff to odhcpd soon (it's successor
>>>>>>>>> which
>>>>>>>>> shares a good part of the codebase but is a bit better integrated
>>>>>>>>> with
>>>>>>>>> the
>>>>>>>>> rest of the environment).
>>>>>>>>
>>>>>>>>
>>>>>>>>
>>>>>>>> same question re dnsmasq.
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>> Yeah as pointed out coexistence is a matter of binding sockets.
>>>>>>> odhcpd
>>>>>>> will
>>>>>>> bring the functionality of dynamically enabling / disabling DHCPv4/v6
>>>>>>> on
>>>>>>> interfaces without restarting the daemon and loosing state. This is
>>>>>>> one
>>>>>>> of
>>>>>>> the main reasons for the change and very much eases things for
>>>>>>> high-level
>>>>>>> protocols that do dynamic wan/lan detection.
>>>>>>>
>>>>>>>
>>>>>>> Cheers,
>>>>>>>
>>>>>>> Steven
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>>>> Regard
>>>>>>>>>  s,
>>>>>>>>>
>>>>>>>>> Steven
>>>>>>>>>
>>>>>>>>>
>>>>>>>>>
>>>>>>>>> On 03.01.2014 18:31, Dave Taht wrote:
>>>>>>>>>
>>>>>>>>>> On Fri, Jan 3, 2014 at 11:50 AM, cb.list6 <cb.list6@gmail.com>
>>>>>>>>>> wrote:
>>>>>>>>>>
>>>>>>>>>>
>>>>>>>>>>
>>>>>>>>>>> On Fri, Jan 3, 2014 at 8:40 AM, Dave Taht <dave.taht@gmail.com>
>>>>>>>>>>> wrote:
>>>>>>>>>>>
>>>>>>>>>>>> At one level I am happy to figure out this is a recently
>>>>>>>>>>>> introduced
>>>>>>>>>>>> bug.
>>>>>>>>>>>>
>>>>>>>>>>>> On the other hand I am not sure if it is 6relayd.
>>>>>>>>>>>>
>>>>>>>>>>>> What version of cero was working for you?
>>>>>>>>>>>
>>>>>>>>>>>
>>>>>>>>>>>
>>>>>>>>>>>
>>>>>>>>>>> I am not entirely sure, but i think it was from September.
>>>>>>>>>>>
>>>>>>>>>>> CB
>>>>>>>>>>
>>>>>>>>>>
>>>>>>>>>>
>>>>>>>>>> At the moment I lack the ability to d
>>>>>>>>>>  ebug
>>>>>>>>>> the breakage in ipv6
>>>>>>>>>> dhcp-pd
>>>>>>>>>> (which is odhcpd) (I am travelling).
>>>>>>>>>>
>>>>>>>>>> I will on my next stop next week (tuesday) setup a dhcpv6pd server
>>>>>>>>>> and
>>>>>>>>>> see what I can see.
>>>>>>>>>>
>>>>>>>>>>>> On Jan 3, 2014 12:21 AM, ""cb.list6"" <cb.list6@gmail.com> wrote:
>>>>>>>>>>>>
>>>>>>>>>>>>> Hi,
>>>>>>>>>>>>>
>>>>>>>>>>>>> I have been using CeroWRT on Comcast with a 3800 for about 6
>>>>>>>>>>>>> month.
>>>>>>>>>>>>> The
>>>>>>>>>>>>> DHCP-PD config has always been a little unstable for me, but
>>>>>>>>>>>>> working.
>>>>>>>>>>>>>
>>>>>>>>>>>>> I recently upgraded to:
>>>>>>>>>>>>>
>>>>>>>>>>>>> root@cerowrt:/etc/config# uname -a
>>>>>>>>>>>>> Linux cerowrt 3.10.24 #1 Tue Dec 24 1
>>>>>>>>>>>>> 0:50:15
>>>>>>>>>>>>> PST 2013 mips
>>>>>>>>>>>>> GNU/Linux
>>>>>>>>>>>>>
>>>>>>>>>>>>> My WAN
>>>>>>>>>>>>>   gets a
>>>>>>>>>>>>> /128, but i cannot get DHCP-PD to work to get
>>>>>>>>>>>>> addresses
>>>>>>>>>>>>> on
>>>>>>>>>>>>> the rest of my interfaces.  The router does seem to have good
>>>>>>>>>>>>> IPv6
>>>>>>>>>>>>> access.
>>>>>>>>>>>>>
>>>>>>>>>>>>>
>>>>>>>>>>>>> I fiddled with the 6relayd config and came up with this, but it
>>>>>>>>>>>>> does
>>>>>>>>>>>>> not
>>>>>>>>>>>>> work.  Any pointers on how to get this back on track?  The
>>>>>>>>>>>>> result
>>>>>>>>>>>>> of
>>>>>>>>>>>>> the
>>>>>>>>>>>>> below config is that the /128 from the WAN interfaces is now
>>>>>>>>>>>>> present
>>>>>>>>>>>>> on
>>>>>>>>>>>>> all
>>>>>>>>>>>>> the interfaces but my attached computers get no addresses.
>>>>>>>>>>>>>
>>>>>>>>>>>>>
>>>>>>>>>>>>> config server 'default'
>>>>>>>>>>>>> option rd 'server'
>>>>>>>>>>>>> option dhcpv6 'server'
>>>>>>>>>>>>> option management_level '1'
>>>>>>>>>>>>> list network 'ge01'
>>>>>>>>>>>>> list network 'gw00'
>>>>>>>>>>>>> list network 'gw01'
>>>>>>>>>>>>> list network 'gw10'
>>>>>>>>>>>>> list network 'gw11'
>>>>>>>>>>>>> list network 'se00'
>>>>>>>>>>>>> list network 'sw00'
>>>>>>>>>>>>> list network 'sw10'
>>>>>>>>>>>>> option fallback_relay 'rd dhcpv6 ndp'
>>>>>>>>>>>>> option master 'ge00'
>>>>>>>>>>>>>
>>>>>>>>>>>>> root@cerowrt:/etc/config# un
>>>>>>>>>>>>> ame
>>>>>>>>>>>>> -a
>>>>>>>>>>>>>
>>>>>>>>>>>>> ________________________________
>>>>>>>>>>>>>
>>>>>>>>>>>>>
>>>>>>>>>>>>> Cerowrt-devel mailing list
>>>>>>>>>>>>> Cerowrt-devel@lists.bufferbloat.net
>>>>>>>>>>>>> https://lists.bufferbloat.net/listinfo/cerowrt-devel
>>>>>>>>>>>>
>>>>>>>>>>>>
>>>>>>>>>>>>
>>>>>>>>>>>>
>>>>>>>>>>>>
>>>>>>>>>>>>
>>>>>>>>>>>>
>>>>>>>>>>>>
>>>>>>>>>>>>
>>>>>>>>>>>>"
438,Jim Gettys,2014-01-18 07:47:06.919418,"On Sat, Jan 18, 2014 at 10:16 AM, Dave Taht <dave.taht@gmail.com> wrote:

> On Sat, Jan 18, 2014 at 9:46 AM, Steven Barth <cyrus@openwrt.org> wrote:
> > That firewall reloading is due to comcast unnecessarily spamming ras
> every 3
> > seconds. We already filter it down to one reload per minute. I prepared
> > another filter yesterday which will filter out updates that dont change
> > anything but adress / route timers. So expect some solution for this
> reload
> > spam in the coming days.
>
> In looking over the packet captures I don't see any dhcpv6 requests going
> out so
> we are holding onto the assigned external address...
>
> 3: ge00: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qlen 1000
>     inet6 2001:elided/128 scope global dynamic
>        valid_lft 304731sec preferred_lft 304731sec
>     inet6 fe80:elided/64 scope link
>        valid_lft forever preferred_lft forever
>
> but in order to see dnsmasq advertise anything
>
> Sat Jan 18 15:04:59 2014 daemon.info dnsmasq-dhcp[3318]:
> RTR-ADVERT(se00) 2601:elided::
>
> I'd had to add a static address to the interface
>
> 2: se00: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qlen 1000
>     inet6 2601:elided::2/64 scope global
>        valid_lft forever preferred_lft forever added this manually and
> dnsmasq did router advertisements
>     inet6 2601:elided::1/64 scope global dynamic
>        valid_lft 304621sec preferred_lft 304621sec # added by the dhcpv6
> client
>
> Is the once a minute update of the latter fooling dnsmasq (I'd tried
> 6relayd too, but it waslate) into not sending out a RTR-ADVERT? For
> example I left the wireless interface up but it has never managed to
> send a RTR-ADVERT:
>
> 16: sw00: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qlen 1000
>     inet6 2601:elidedbutdifferent::1/64 scope global dynamic
>        valid_lft 304333sec preferred_lft 304333sec
>
>
> (I am still grumpy at the prospect of someone renumbering my network
> every 84 hours, much less once a minute)
>

If renumbering is going on, I'd complain at Comcast.  I'd suspect it's an
artifact of an early deployment and testing rather than intentional
behavior.  They get to deal with service calls from anything that breaks,
and this is still early days.
                                   - Jim


>
>
> ---------- Forwarded message ----------
> From: Steven Barth <cyrus@openwrt.org>
> Date: Sat, Jan 18, 2014 at 9:46 AM
> Subject: Re: [Cerowrt-devel] 6relayd
> To: Dave Taht <dave.taht@gmail.com>
> Cc: Matt Mathis <mattmathis@google.com>, ""cb.list6""
> <cb.list6@gmail.com>, ""cerowrt-devel@lists.bufferbloat.net""
> <cerowrt-devel@lists.bufferbloat.net>
>
>
> That firewall reloading is due to comcast unnecessarily spamming ras
> every 3 seconds. We already filter it down to one reload per minute. I
> prepared another filter yesterday which will filter out updates that
> dont change anything but adress / route timers. So expect some
> solution for this reload spam in the coming days.
> >
> >
> > Dave Taht <dave.taht@gmail.com> schrieb:
> >>
> >> I just filed bug http://www.bufferbloat.net/issues/438 on this issue
> >> after working with matt until the wee hours.
> >>
> >> I have to take a couple packet captures next.
> >>
> >> To copy from the bug report:
> >>
> >> On the plus side:
> >>
> >> comcast ipv6 had been working fine between august and december on
> >> cerowrt 3.10.7 (?)
> >>
> >> we do get an external IPv6 address AND /60 dhcpv6-pd delegation from
> >> comcast, and distribute the /64s to each of the subnets on cero. The
> >> resulting native ipv6 connection works for getting into the router
> >> itself and stays up all night...
> >>
> >> On the minus side(s)
> >>
> >> 1) The AAAA record on the wan interface (ge00) is withdrawn and
> >> renewed every minute or two. This triggers reloading the firewall,
> >> which really isn't something you want happening every minute or two.
> >> The delegation seems to persist longer than that,
> >> but...
> >>
> >> 2) We do not get dnsmasq distributing that /64 on any interface.
> >> Interestingly if you manually add a new IPv6 address from that range
> >> (say, whatever::2/64) dnsmasq picks it up and starts serving ipv6
> >> addresses. (theory: we don't have that ipv6 delegation long enough for
> >> dnsmasq to see it before they are withdrawn)
> >>
> >> 3) We get plenty of instruction traps IF you delegate to the wireless
> >> and use it.
> >> (there may be other factors on the instruction traps so don't take the
> >> above as canon), but Running all night with just the ::2 manually
> >> inserted on ethernet results in no instruction traps (but there was no
> >> traffic either). running with with the manual ::2/64 inserted does
> >> result in routable, working, ipv6 subnet addresses that dnsmasq sees
> >> and distributes from.
> >>
> >> 4) tweak: ge01 needs to be added to the firewall rules for wan. maybe.
> >>
> >> The net result is unusable native ipv6 on comcast
> >>  . (comcast6.net is
> >> also reporting unusable ipv6 on wireless on the xbox 1, and I don't
> >> know if that's related)
> >>
> >> Working theories: A) is we have an endianess problem on parsing
> >> dhcpv6-pd from comcast for the timeout, B) comcast has an endianess
> >> problem C) we are not keeping properly track of the ipv6 address
> >> assignment and/or lease length. D) Comcast isn't assigning ipv6
> >> external addresses and subnets for more than a minute. E) we have some
> >> problem on the wireless side in particular (but that seems independent
> >> of the problem)
> >>
> >> We have all generally been running fine with ipv6 tunneled through
> >> hurricane, so
> >> my assumption is that this is something specific to the directly
> connected
> >> ge00
> >> interface, in negotiating something with the upstream dhcpv6 and
> >> dhcpv6-pd stuff.
> >>
> >> So here's one of the symptoms. I have some packet captures and straces
> to
> >> do:
> >>
> >> Sat Jan 18 1
> >>  3:18:55
> >> 2014 user.notice firewall: Reloading firewall due
> >> to ifupdate of ge01 ()
> >> Sat Jan 18 13:19:57 2014 user.notice firewall: Reloading firewall due
> >> to ifupdate of ge01 ()
> >> Sat Jan 18 13:21:01 2014 user.notice firewall: Reloading firewall due
> >> to ifupdate of ge01 ()
> >> Sat Jan 18 13:22:02 2014 user.notice firewall: Reloading firewall due
> >> to ifupdate of ge01 ()
> >> Sat Jan 18 13:23:02 2014 user.notice firewall: Reloading firewall due
> >> to ifupdate of ge01 ()
> >> Sat Jan 18 13:24:04 2014 user.notice firewall: Reloading firewall due
> >> to ifupdate of ge01 ()
> >> Sat Jan 18 13:25:04 2014 user.notice firewall: Reloading firewall due
> >> to ifupdate of ge01 ()
> >> Sat Jan 18 13:25:45 2014 daemon.info dnsmasq-dhcp3318:
> >> RTR-ADVERT 2601:9:8580:c32::
> >> Sat Jan 18 13:26:07 2014 user.notice firewall: Reloading firewall due
> >> to ifupdate of ge01 ()
> >> Sat Jan 18 13:27:09 2014 user.notice firewall: Reloading fi
> >>  rewall
> >> due
> >> to ifupdate of ge01 ()
> >> Sat Jan 18 13:28:11 2014 user.notice firewall: Reloading firewall due
> >> to ifupdate of ge01 ()
> >>
> >>
> >> On Sat, Jan 18, 2014 at 9:23 AM, Steven Barth <cyrus@openwrt.org>
> wrote:
> >>>
> >>> Fyi as stated earlier i made the switch to odhcpd yesterday. With that
> i
> >>> also switched routing from individual tables to source-constrained
> routes
> >>> in
> >>> the maintable.
> >>>
> >>> Cheers,
> >>> Steven
> >>>
> >>>
> >>>
> >>>
> >>> Dave Taht <dave.taht@gmail.com> schrieb:
> >>>
> >>>> On Fri, Jan 17, 2014 at 1:52 AM, Matt Mathis <mattmathis@google.com>
> >>>> wrote:
> >>>>
> >>>>> I'm final
> >>>>>  ly
> >>>>> getting back to this.
> >>>>>
> >>>>>> Hmm. if you uncomment everything in /etc/dnsmasq.conf and restart
> >>>>>> dnsmasq what happens? If you have got /64s you would end up doing
> >>>>>> slaac and ra announcements via dnsmasq in this case.
> >>>>>>
> >>>>>> That was on by default before (and what was tested in feburary).
> Later
> >>>>>> on 6relayd started having a race with it and seemed to be ""the
> >>>>>> future"", so I disabled the dnsmasq version, thinking that 6relayd
> was
> >>>>>> the answer. It's entirely possible that's
> >>>>>> merely configured wrong.
> >>>>>
> >>>>>
> >>>>>
> >>>>>
> >>>>> Now I get global /64's on my LAN interfaces, but I am still not
> >>>>> answering
> >>>>> dh
> >>>>> cp6 for
> >>>>> attached hosts.  I retried both version of the 6relayd init
> >>>>> script....
> >>>>>
> >>>>> dnsmasq.conf contains:
> >>>>> enable-ra
> >>>>> dhcp-range=::1,::400,constructor:se00,ra-names,ra-stateless
> >>>>> dhcp-range=::1,::400,constructor:sw00,ra-names,ra-stateless
> >>>>> dhcp-range=::1,::400,constructor:gw00,ra-names,ra-stateless
> >>>>> dhcp-range=::1,::400,constructor:sw10,ra-names,ra-stateless
> >>>>> dhcp-range=::1,::400,constructor:gw10,ra-names,ra-stateless
> >>>>>
> >>>>>
> >>>>> I am running: Linux cerowrt 3.10.24 #1 Tue Dec 24 10:50:15 PST
> >>>>> 2013.....
> >>>>> which might be just a bit too fresh....  Would you suggest another?
> >>>>
> >>>>
> >>>>
> >>>> You are not getting slaac either?
> >>>>
> >>>> An ifconfig on an interface and a packet dump of ipv6 packets would be
> >>>> helpful.
> >>>>
> >>>>> I have a spare 3700, so I think I will try some alternate vintages.
> >>>>>
> >>>>> Thanks,
> >>>>> --MM--
> >>>>> The
> >>>>> best way to predict the future is to create it.  - Alan Kay
> >>>>>
> >>>>>
> >>>>> Privacy matters!  We know from recent events that people are using
> our
> >>>>> services to speak in
> >>>>> defiance of unjust governments.   We treat privacy
> >>>>> and
> >>>>> security as matters of life and death, because for some users, they
> >>>>> are.
> >>>>>
> >>>>>
> >>>>> On Sun, Jan 5, 2014 at 7:48 PM, Dave Taht <dave.taht@gmail.com>
> wrote:
> >>>>>
> >>>>>> On Sat, Jan 4, 2014 at 1:30 AM, Steven Barth <cyrus@openwrt.org>
> >>>>>> wrote:
> >>>>>>
> >>>>>>> On 03.01.2014 19:43, Dave Taht wrote:
> >>>>>>>
> >>>>>>>
> >>>>>>>> I was also experiencing a race condition with dnsmasq, while I had
> >>>>>>>> it
> >>>>>>>> enabling
> >>>>>>>> ra
> >>>>>>>> and
> >>>>>>>> dhcpv6 via dnsmasq. At the moment that's turned off by default,
> >>>>>>>> but
> >>>>>>>> I did rather prefer having dns names for my ipv6
> >>>>>>>> addresses...
> >>>>>>>
> >>>>>>>
> >>>>>>>
> >>>>>>> Well 6relayd and odhcpd collect hostnames of clients acquired via
> >>>>>>> stateful
> >>>>>>> DHCPv6 and export them to dnsmasq in an additional hostfiles. At
> >>>>>>> least
> >>>>>>> that
> >>>>>>> seemed to work when I last tried it a few months ago. The only
> >>>>>>> disadvantage
> >>>>>>> is that there is no ""ra-names"" feature there.
> >>>>>>
> >>>>>>
> >>>>>>
> >>>>>> Getting to names from dhcpv4 to slaac was a neat hack and a
> potential
> >>>>>> RFC. So i figure spending the time to add the same functionality
> into
> >>>>>> into something other than dnsmasq would be useful towards writing
> that
> >>>>>> rfc.
> >>>>>>
> >>>>>>
> >>>>>>>> is there a good way for 6re
> >>>>>>>> layd
> >>>>>>>> and dnsmasq-dhcpv6 to co-exist?
> >>>>>>>
> >>>>>>>
> >>>>>>>
> >>>>>>> Ideally they could coexist in a way that you c
> >>>>>>>  ould
> >>>>>>> select dnsmasq and /
> >>>>>>> or
> >>>>>>> odhcpd for different interfaces on the same machine. odhcpd
> supports
> >>>>>>> that
> >>>>>>> but dnsmasq the last time I've looked seemed to use a single socket
> >>>>>>> binding
> >>>>>>> to all interfaces for DHCP/v6 which prevents coexistance from
> working
> >>>>>>> correctly because odhcpd / 6relayd can't bind the socket after
> >>>>>>> dnsmasq
> >>>>>>> did
> >>>>>>> and vice versa.
> >>>>>>>
> >>>>>>>
> >>>>>>>
> >>>>>>>>> Feel free to provide me with some debugging information of the
> >>>>>>>>> system
> >>>>>>>>> while
> >>>>>>>>> PD fails for you so I can have a look at the probable cause:
> >>>>>>>>>
> >>>>>>>>> * ""ifstatus ge00"" (replace ge00 with your IPv6 upstream
> interface)
> >>>>>>>>> * ""ip addr list dev
> >>>>>>>>> ge01""
> >>>>>>>>> (replace ge01 with the interface your
> >>>>>>>>> downstream
> >>>>>>>>> router is connected)
> >>>>>>>>> * ""ps
> >>>>>>>>>  | grep
> >>>>>>>>> 6relayd""
> >>>>>>>>>
> >>>>>>>>> Anyway I will migrate all the stuff to odhcpd soon (it's
> successor
> >>>>>>>>> which
> >>>>>>>>> shares a good part of the codebase but is a bit better integrated
> >>>>>>>>> with
> >>>>>>>>> the
> >>>>>>>>> rest of the environment).
> >>>>>>>>
> >>>>>>>>
> >>>>>>>>
> >>>>>>>> same question re dnsmasq.
> >>>>>>>
> >>>>>>>
> >>>>>>>
> >>>>>>> Yeah as pointed out coexistence is a matter of binding sockets.
> >>>>>>> odhcpd
> >>>>>>> will
> >>>>>>> bring the functionality of dynamically enabling / disabling
> DHCPv4/v6
> >>>>>>> on
> >>>>>>> interfaces without restarting the daemon and loosing state. This is
> >>>>>>> one
> >>>>>>> of
> >>>>>>> the main reasons for the change and very much eases things for
> >>>>>>> high-level
> >>>>>>> protocols that do dynamic wan/lan detection.
> >>>>>>>
> >>>>>>>
> >>>>>>> Cheers,
> >>>>>>>
> >>>>>>> Steven
> >>>>>>>
> >>>>>>>
> >>>>>>>
> >>>>>>>
> >>>>>>>
> >>>>>>>>> Regard
> >>>>>>>>>  s,
> >>>>>>>>>
> >>>>>>>>> Steven
> >>>>>>>>>
> >>>>>>>>>
> >>>>>>>>>
> >>>>>>>>> On 03.01.2014 18:31, Dave Taht wrote:
> >>>>>>>>>
> >>>>>>>>>> On Fri, Jan 3, 2014 at 11:50 AM, cb.list6 <cb.list6@gmail.com>
> >>>>>>>>>> wrote:
> >>>>>>>>>>
> >>>>>>>>>>
> >>>>>>>>>>
> >>>>>>>>>>> On Fri, Jan 3, 2014 at 8:40 AM, Dave Taht <dave.taht@gmail.com
> >
> >>>>>>>>>>> wrote:
> >>>>>>>>>>>
> >>>>>>>>>>>> At one level I am happy to figure out this is a recently
> >>>>>>>>>>>> introduced
> >>>>>>>>>>>> bug.
> >>>>>>>>>>>>
> >>>>>>>>>>>> On the other hand I am not sure if it is 6relayd.
> >>>>>>>>>>>>
> >>>>>>>>>>>> What version of cero was working for you?
> >>>>>>>>>>>
> >>>>>>>>>>>
> >>>>>>>>>>>
> >>>>>>>>>>>
> >>>>>>>>>>> I am not entirely sure, but i think it was from September.
> >>>>>>>>>>>
> >>>>>>>>>>> CB
> >>>>>>>>>>
> >>>>>>>>>>
> >>>>>>>>>>
> >>>>>>>>>> At the moment I lack the ability to d
> >>>>>>>>>>  ebug
> >>>>>>>>>> the breakage in ipv6
> >>>>>>>>>> dhcp-pd
> >>>>>>>>>> (which is odhcpd) (I am travelling).
> >>>>>>>>>>
> >>>>>>>>>> I will on my next stop next week (tuesday) setup a dhcpv6pd
> server
> >>>>>>>>>> and
> >>>>>>>>>> see what I can see.
> >>>>>>>>>>
> >>>>>>>>>>>> On Jan 3, 2014 12:21 AM, ""cb.list6"" <cb.list6@gmail.com>
> wrote:
> >>>>>>>>>>>>
> >>>>>>>>>>>>> Hi,
> >>>>>>>>>>>>>
> >>>>>>>>>>>>> I have been using CeroWRT on Comcast with a 3800 for about 6
> >>>>>>>>>>>>> month.
> >>>>>>>>>>>>> The
> >>>>>>>>>>>>> DHCP-PD config has always been a little unstable for me, but
> >>>>>>>>>>>>> working.
> >>>>>>>>>>>>>
> >>>>>>>>>>>>> I recently upgraded to:
> >>>>>>>>>>>>>
> >>>>>>>>>>>>> root@cerowrt:/etc/config# uname -a
> >>>>>>>>>>>>> Linux cerowrt 3.10.24 #1 Tue Dec 24 1
> >>>>>>>>>>>>> 0:50:15
> >>>>>>>>>>>>> PST 2013 mips
> >>>>>>>>>>>>> GNU/Linux
> >>>>>>>>>>>>>
> >>>>>>>>>>>>> My WAN
> >>>>>>>>>>>>>   gets a
> >>>>>>>>>>>>> /128, but i cannot get DHCP-PD to work to get
> >>>>>>>>>>>>> addresses
> >>>>>>>>>>>>> on
> >>>>>>>>>>>>> the rest of my interfaces.  The router does seem to have good
> >>>>>>>>>>>>> IPv6
> >>>>>>>>>>>>> access.
> >>>>>>>>>>>>>
> >>>>>>>>>>>>>
> >>>>>>>>>>>>> I fiddled with the 6relayd config and came up with this, but
> it
> >>>>>>>>>>>>> does
> >>>>>>>>>>>>> not
> >>>>>>>>>>>>> work.  Any pointers on how to get this back on track?  The
> >>>>>>>>>>>>> result
> >>>>>>>>>>>>> of
> >>>>>>>>>>>>> the
> >>>>>>>>>>>>> below config is that the /128 from the WAN interfaces is now
> >>>>>>>>>>>>> present
> >>>>>>>>>>>>> on
> >>>>>>>>>>>>> all
> >>>>>>>>>>>>> the interfaces but my attached computers get no addresses.
> >>>>>>>>>>>>>
> >>>>>>>>>>>>>
> >>>>>>>>>>>>> config server 'default'
> >>>>>>>>>>>>> option rd 'server'
> >>>>>>>>>>>>> option dhcpv6 'server'
> >>>>>>>>>>>>> option management_level '1'
> >>>>>>>>>>>>> list network 'ge01'
> >>>>>>>>>>>>> list network 'gw00'
> >>>>>>>>>>>>> list network 'gw01'
> >>>>>>>>>>>>> list network 'gw10'
> >>>>>>>>>>>>> list network 'gw11'
> >>>>>>>>>>>>> list network 'se00'
> >>>>>>>>>>>>> list network 'sw00'
> >>>>>>>>>>>>> list network 'sw10'
> >>>>>>>>>>>>> option fallback_relay 'rd dhcpv6 ndp'
> >>>>>>>>>>>>> option master 'ge00'
> >>>>>>>>>>>>>
> >>>>>>>>>>>>> root@cerowrt:/etc/config# un
> >>>>>>>>>>>>> ame
> >>>>>>>>>>>>> -a
> >>>>>>>>>>>>>
> >>>>>>>>>>>>> ________________________________
> >>>>>>>>>>>>>
> >>>>>>>>>>>>>
> >>>>>>>>>>>>> Cerowrt-devel mailing list
> >>>>>>>>>>>>> Cerowrt-devel@lists.bufferbloat.net
> >>>>>>>>>>>>> https://lists.bufferbloat.net/listinfo/cerowrt-devel
> >>>>>>>>>>>>
> >>>>>>>>>>>>
> >>>>>>>>>>>>
> >>>>>>>>>>>>
> >>>>>>>>>>>>
> >>>>>>>>>>>>
> >>>>>>>>>>>>
> >>>>>>>>>>>>
> >>>>>>>>>>>>
> >>>>>>>>>>>>"
438,Rich Brown,2014-01-20 07:07:07.413767,"On Jan 18, 2014, at 10:46 AM, Jim Gettys <jg@freedesktop.org> wrote:

> If renumbering is going on, I'd complain at Comcast.  I'd suspect it's an artifact of an early deployment and testing rather than intentional behavior.  They get to deal with service calls from anything that breaks, and this is still early days.


Yes, but it will be a forcing function to drive along DNS naming as the primary means of locating devices.

I believe this is called ""salvation through suffering"" :-)"
439,David Taht,2014-01-20 15:05:57.624819,"note bug number above.

On Mon, Jan 20, 2014 at 5:17 PM, Steven Barth <cyrus@openwrt.org> wrote:
> Hi Dave,
>
> I really can't reproduce your issues with he.net or DNS.
> I just compiled a current OpenWrt trunk with default build config and 6in4
> as only additional module on my WNDR3800.
>

Well, I think the problem is partially introduced by the fact cero has
more than one client facing interface in the box. (eg se00, gw00,
gw10, sw00, sw10)

So I think you will see it if you setup a few vlans or unbridge yourself.

> Following configuration was used:
>
> config interface 'henet'
>         option proto '6in4'
>         option peeraddr 'xx.xx.xx.xx'
>         option ip6addr '2001:aaaa:aaaa:aaaa::2/64'
>         option ip6prefix '2001:bbbb:bbbb::/48'
>
>
> Resulting mainrouting table was:
>
> default from :: dev 6in4-henet  proto static  metric 1024
> default from 2001:aaaa:aaaa:aaaa::/64 dev 6in4-henet  proto static metric
> 1024

> default from 2001:bbbb:bbbb::/48 dev 6in4-henet  proto static  metric 1024

This route is NOT introduced sucessfully. Actually it MAY be being introduced
successfully but it is wiped out later. Is there a good way to log
what netifd is doing?

> 2001:aaaa:aaaa:aaaa::/64 dev 6in4-henet  proto kernel  metric 256
> 2001:bbbb:bbbb::/60 dev br-lan  proto kernel  metric 256
> unreachable 2001:bbbb:bbbb::/48 dev lo  proto static  metric 2147483647
> error -128
>
>
> which is correct and expected (note: /60 was assigned to br-lan).

Puzzled as to why, should just be a /64...

> Accompanying policy rules section looks good as well:
>
> 0:      from all lookup local
> 32766:  from all lookup main
> 4200000000:     from 2001:bbbb:bbbb::1/60 iif br-lan unreachable
> 4200000001:     from all iif lo failed_policy
> 4200000003:     from all iif eth1 failed_policy
> 4200000005:     from all iif br-lan failed_policy
> 4200000007:     from all iif 6in4-henet failed_policy
>
>
> I registered a client via stateful DHCPv6 on br-lan and resulting dig result
> is as follows:
>
> ;; QUESTION SECTION:
> ;fuubar-T420s.                    IN      AAAA
>
> ;; ANSWER SECTION:
> fuubar-T420s.             0       IN      AAAA    2001:bbbb:bbbb::5f9
>
> So odhcpd - dnsmasq interaction works as well.

Well I sent you the copies of the processes in play. Aside from the
multiple copies of everything spawned, do I have all the right
daemons? Can you send me your current .config to see if I missed some
new proggie?

>
>
> Cheers,
>
> Steven
>
>
>
> On 20.01.2014 21:51, Dave Taht wrote:
>>
>> after doing a zillion network restarts while trying
>> to get he to work again, we have the following mess.
>>
>>    PID USER       VSZ STAT COMMAND
>>      1 root      1352 S    /sbin/procd
>>      2 root         0 SW   [kthreadd]
>>      3 root         0 SW   [ksoftirqd/0]
>>      5 root         0 SW<  [kworker/0:0H]
>>      7 root         0 SW<  [khelper]
>>     73 root         0 SW<  [writeback]
>>     75 root         0 SW<  [bioset]
>>     77 root         0 SW<  [kblockd]
>>    112 root         0 SW   [kswapd0]
>>    158 root         0 SW   [fsnotify_mark]
>>    172 root         0 SW<  [ath79-spi]
>>    254 root         0 SW<  [deferwq]
>>    305 root         0 SW   [khubd]
>>    375 root         0 SWN  [jffs2_gcd_mtd5]
>>    449 root       924 S    /sbin/ubusd
>>    450 root       776 S    /sbin/askfirst ttyS0 /bin/ash --login
>>    453 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>    515 root         0 SW<  [crypto]
>>    548 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>    753 root         0 SW<  [cfg80211]
>>    786 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>    801 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>    893 root      1432 S    /sbin/logd
>>    922 root      1208 S    /usr/sbin/odhcpd
>>    974 www-data  4052 S    lighttpd -f /etc/lighttpd/cerowrt.conf
>>   1002 root      4260 S    /usr/sbin/lighttpd -f
>> /etc/lighttpd/lighttpd.conf
>>   1069 root      2952 S    /usr/sbin/snmpd -Lf /dev/null -p
>> /var/run/snmpd.pid
>>   1090 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   1144 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   1183 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   1259 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   1269 root      1232 S    /usr/sbin/xinetd -pidfile /var/run/xinetd.pid
>>   1485 root      1756 S    /usr/sbin/dbus-daemon --system
>>   1499 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   1547 nobody    2552 S    avahi-daemon: running [cerowrt-8.local]
>>   1576 root      1244 S    /usr/sbin/babeld -D -I /var/run/babeld.pid -C
>> interf
>>   1585 root      1132 S    /usr/sbin/ahcpd -D -C mode server -C lease-dir
>> /var/
>>   1606 root       816 S    /sbin/rngd -r /dev/urandom -W 4000 -t 30
>>   1617 root      1708 S    /usr/sbin/ntpd -n -l -p 0.openwrt.pool.ntp.org
>> 1.ope
>>   1624 root      1264 S    /usr/sbin/polipo -c /var/etc/polipo.conf
>>   1638 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   1830 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   1899 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   2201 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   2259 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   2275 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   2579 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   2693 root       796 S    minissdpd -i 172.30.42.1 -i 172.30.42.65 -i
>> 172.30.4
>>   2725 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   2780 root      1300 S    dropbear -i
>>   2783 root      1720 S    -ash
>>   2957 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   3088 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   3091 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   3281 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   3325 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   3382 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   3607 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   3663 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   3848 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   4022 root       832 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   4056 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   4286 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   4347 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   4428 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   4660 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   4693 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   4834 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   4905 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   4969 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   5026 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   5369 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   5583 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   5756 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   5947 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   5995 root         0 SW   [kworker/u2:4]
>>   6051 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   6252 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   6482 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   6645 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   6676 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   6835 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   6869 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   6930 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   7231 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   7383 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   7513 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   7667 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   7713 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   7788 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   7823 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   8211 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   8306 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   8380 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   8411 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   8674 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   8888 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   8918 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   8926 root         0 SW   [kworker/u2:1]
>>   8959 root         0 SW   [kworker/0:0]
>>   9108 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   9258 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   9342 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   9432 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>   9499 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   9871 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>   9878 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 10072 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 10077 root       832 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 10141 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 10290 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 10308 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 10556 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 10593 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 10646 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 10749 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 11016 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 11361 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 11379 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 11523 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 11646 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 11661 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 11845 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 11859 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 12012 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 12218 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 12379 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 12534 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 12676 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 12837 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 12863 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 13055 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 13082 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 13162 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 13209 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 13330 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 13636 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 13813 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 13824 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 14063 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 14155 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 14158 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 14255 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 14483 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 14723 root         0 SW   [kworker/u2:3]
>> 14828 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 14839 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 14978 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 14996 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 15204 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 15254 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 15296 root       832 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 15335 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 15730 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 15747 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 15748 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 16162 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 16203 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 16236 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 16331 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 16753 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 16760 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 16853 nobody    1440 S    /usr/sbin/dnsmasq -C /var/etc/dnsmasq.conf -k
>> 16856 root      1432 S    /usr/sbin/dnsmasq -C /var/etc/dnsmasq.conf -k
>> 16934 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 17013 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 17103 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 17226 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 17322 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 17515 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 17776 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 17819 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 17956 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 17978 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 18156 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 18384 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 18538 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 18553 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 18746 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 18747 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 18806 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 19075 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 19199 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 19293 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 19455 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 19471 root      3960 S    /usr/sbin/hostapd -P /var/run/wifi-phy1.pid -B
>> /var/
>> 19472 root      3960 S    /usr/sbin/hostapd -P /var/run/wifi-phy0.pid -B
>> /var/
>> 19539 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 19570 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 19727 root      1704 R    ps
>> 20270 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 20281 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 20347 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 20413 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 20556 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 20985 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 21069 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 21158 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 21170 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 21217 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 21453 root         0 SW   [kworker/0:1]
>> 21514 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 21568 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 21671 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 22057 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 22377 root         0 SW   [kworker/0:2]
>> 22406 root         0 SW   [kworker/u2:0]
>> 22641 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 22682 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 22754 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 22761 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 22993 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 23218 root       832 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 23260 root       832 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 23331 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 23348 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 23647 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 24003 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 24040 root         0 SW   [kworker/u2:2]
>> 24042 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 24118 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 24336 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 24350 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 24686 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 24921 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 25006 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 25353 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 25658 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 25684 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 25706 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 25765 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 25821 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 25996 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 26096 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 26659 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 26752 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 26769 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 27079 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 27183 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 27403 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 27484 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 27570 root       832 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 27643 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 27817 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 27999 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 28086 root       832 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 28392 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 28565 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 28729 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 28870 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 28883 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 29044 root       832 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 29066 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 29722 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 29730 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 29907 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 29915 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 29953 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 30246 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 30424 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 30527 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 30699 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 30778 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 30912 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 30929 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 31256 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 31545 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 31597 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 31746 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 31903 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 31999 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 32251 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 32327 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>> 32504 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>> 32633 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>> /lib/netifd/dh
>>
>"
439,David Taht,2014-01-21 01:59:15.837212,"On Tue, Jan 21, 2014 at 1:17 AM, Steven Barth <cyrus@openwrt.org> wrote:
> On 21.01.2014 00:05, Dave Taht wrote:
>>
>> Well, I think the problem is partially introduced by the fact cero has
>> more than one client facing interface in the box. (eg se00, gw00,
>> gw10, sw00, sw10)
>>
>> So I think you will see it if you setup a few vlans or unbridge yourself.
>
> Cannot confirm that, still no problems here.
>
> default from :: dev 6in4-henet  proto static  metric 1024
> default from 2001:aaaa:aaaa:aaaa::/64 dev 6in4-henet  proto static metric
> 1024
> default from 2001:bbbb:bbbb::/48 dev 6in4-henet  proto static metric 1024
> 2001:aaaa:aaaa:aaaa::/64 dev 6in4-henet  proto kernel  metric 256
> 2001:bbbb:bbbb::/60 dev br-lan  proto kernel  metric 256
> 2001:bbbb:bbbb:10::/60 dev eth1  proto kernel  metric 256
>
> unreachable 2001:bbbb:bbbb::/48 dev lo  proto static  metric 2147483647
> error -128
>
> (2 downstream: eth1 and br-lan each getting a /60)
> I even added a second uplink afterwards but even that worked and didn't
> break.

I will reduce my number of devices to 2 from 6 and see what I get.

ubus overrun?

>
>>
>> This route is NOT introduced sucessfully. Actually it MAY be being
>> introduced
>> successfully but it is wiped out later. Is there a good way to log
>> what netifd is doing?
>
> Well no real good way to do that, i think you could pass a debug flag while
> building or just use ""ip monitor"" to see whats happening on the kernel side.

OK.

>
>
>>
>>> 2001:aaaa:aaaa:aaaa::/64 dev 6in4-henet  proto kernel  metric 256
>>> 2001:bbbb:bbbb::/60 dev br-lan  proto kernel  metric 256
>>> unreachable 2001:bbbb:bbbb::/48 dev lo  proto static  metric 2147483647
>>> error -128
>>>
>>>
>>> which is correct and expected (note: /60 was assigned to br-lan).
>>
>> Puzzled as to why, should just be a /64...
>
> Well we want to have some kind of hierarchic DHCPv6-PD by default, easiest
> way for us is just to hand out a /60 and let odhcpd serve everything but the
> first /64 via PD.
>
>
>>
>> Well I sent you the copies of the processes in play. Aside from the
>> multiple copies of everything spawned, do I have all the right
>> daemons? Can you send me your current .config to see if I missed some
>> new proggie?
>
> You only need netifd, odhcpd and odhcp6c really (well and 6in4).
> One idea might be that if you have a custom kernel (config) for your
> bufferbloat stuff you might be missing some kind of kernel option to support
> source-restricted IPv6-routes? Also you should run at least a recent 3.10
> kernel for everything to run smoothly.

Only thing custom about my kernel is the hz value and extra tcp
support... and I'm running the same
kernel as upstream openwrt. Certainly it's been a long time since I
reviewed the delta between the two.


>
> Haven't seen the copies thing happening yet.
>
>
>>
>>>
>>> Cheers,
>>>
>>> Steven
>>>
>>>
>>>
>>> On 20.01.2014 21:51, Dave Taht wrote:
>>>>
>>>> after doing a zillion network restarts while trying
>>>> to get he to work again, we have the following mess.
>>>>
>>>>     PID USER       VSZ STAT COMMAND
>>>>       1 root      1352 S    /sbin/procd
>>>>       2 root         0 SW   [kthreadd]
>>>>       3 root         0 SW   [ksoftirqd/0]
>>>>       5 root         0 SW<  [kworker/0:0H]
>>>>       7 root         0 SW<  [khelper]
>>>>      73 root         0 SW<  [writeback]
>>>>      75 root         0 SW<  [bioset]
>>>>      77 root         0 SW<  [kblockd]
>>>>     112 root         0 SW   [kswapd0]
>>>>     158 root         0 SW   [fsnotify_mark]
>>>>     172 root         0 SW<  [ath79-spi]
>>>>     254 root         0 SW<  [deferwq]
>>>>     305 root         0 SW   [khubd]
>>>>     375 root         0 SWN  [jffs2_gcd_mtd5]
>>>>     449 root       924 S    /sbin/ubusd
>>>>     450 root       776 S    /sbin/askfirst ttyS0 /bin/ash --login
>>>>     453 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>     515 root         0 SW<  [crypto]
>>>>     548 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>     753 root         0 SW<  [cfg80211]
>>>>     786 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>     801 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>     893 root      1432 S    /sbin/logd
>>>>     922 root      1208 S    /usr/sbin/odhcpd
>>>>     974 www-data  4052 S    lighttpd -f /etc/lighttpd/cerowrt.conf
>>>>    1002 root      4260 S    /usr/sbin/lighttpd -f
>>>> /etc/lighttpd/lighttpd.conf
>>>>    1069 root      2952 S    /usr/sbin/snmpd -Lf /dev/null -p
>>>> /var/run/snmpd.pid
>>>>    1090 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    1144 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    1183 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    1259 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    1269 root      1232 S    /usr/sbin/xinetd -pidfile
>>>> /var/run/xinetd.pid
>>>>    1485 root      1756 S    /usr/sbin/dbus-daemon --system
>>>>    1499 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    1547 nobody    2552 S    avahi-daemon: running [cerowrt-8.local]
>>>>    1576 root      1244 S    /usr/sbin/babeld -D -I /var/run/babeld.pid
>>>> -C
>>>> interf
>>>>    1585 root      1132 S    /usr/sbin/ahcpd -D -C mode server -C
>>>> lease-dir
>>>> /var/
>>>>    1606 root       816 S    /sbin/rngd -r /dev/urandom -W 4000 -t 30
>>>>    1617 root      1708 S    /usr/sbin/ntpd -n -l -p
>>>> 0.openwrt.pool.ntp.org
>>>> 1.ope
>>>>    1624 root      1264 S    /usr/sbin/polipo -c /var/etc/polipo.conf
>>>>    1638 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    1830 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    1899 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    2201 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    2259 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    2275 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    2579 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    2693 root       796 S    minissdpd -i 172.30.42.1 -i 172.30.42.65 -i
>>>> 172.30.4
>>>>    2725 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    2780 root      1300 S    dropbear -i
>>>>    2783 root      1720 S    -ash
>>>>    2957 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    3088 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    3091 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    3281 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    3325 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    3382 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    3607 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    3663 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    3848 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    4022 root       832 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    4056 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    4286 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    4347 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    4428 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    4660 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    4693 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    4834 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    4905 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    4969 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    5026 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    5369 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    5583 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    5756 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    5947 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    5995 root         0 SW   [kworker/u2:4]
>>>>    6051 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    6252 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    6482 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    6645 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    6676 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    6835 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    6869 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    6930 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    7231 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    7383 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    7513 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    7667 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    7713 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    7788 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    7823 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    8211 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    8306 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    8380 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    8411 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    8674 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    8888 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    8918 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    8926 root         0 SW   [kworker/u2:1]
>>>>    8959 root         0 SW   [kworker/0:0]
>>>>    9108 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    9258 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    9342 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    9432 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60
>>>> ge00
>>>>    9499 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    9871 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>    9878 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 10072 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 10077 root       832 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 10141 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 10290 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 10308 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 10556 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 10593 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 10646 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 10749 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 11016 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 11361 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 11379 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 11523 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 11646 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 11661 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 11845 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 11859 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 12012 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 12218 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 12379 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 12534 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 12676 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 12837 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 12863 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 13055 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 13082 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 13162 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 13209 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 13330 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 13636 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 13813 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 13824 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 14063 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 14155 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 14158 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 14255 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 14483 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 14723 root         0 SW   [kworker/u2:3]
>>>> 14828 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 14839 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 14978 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 14996 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 15204 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 15254 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 15296 root       832 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 15335 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 15730 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 15747 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 15748 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 16162 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 16203 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 16236 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 16331 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 16753 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 16760 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 16853 nobody    1440 S    /usr/sbin/dnsmasq -C /var/etc/dnsmasq.conf -k
>>>> 16856 root      1432 S    /usr/sbin/dnsmasq -C /var/etc/dnsmasq.conf -k
>>>> 16934 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 17013 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 17103 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 17226 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 17322 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 17515 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 17776 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 17819 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 17956 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 17978 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 18156 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 18384 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 18538 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 18553 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 18746 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 18747 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 18806 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 19075 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 19199 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 19293 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 19455 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 19471 root      3960 S    /usr/sbin/hostapd -P /var/run/wifi-phy1.pid -B
>>>> /var/
>>>> 19472 root      3960 S    /usr/sbin/hostapd -P /var/run/wifi-phy0.pid -B
>>>> /var/
>>>> 19539 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 19570 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 19727 root      1704 R    ps
>>>> 20270 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 20281 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 20347 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 20413 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 20556 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 20985 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 21069 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 21158 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 21170 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 21217 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 21453 root         0 SW   [kworker/0:1]
>>>> 21514 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 21568 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 21671 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 22057 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 22377 root         0 SW   [kworker/0:2]
>>>> 22406 root         0 SW   [kworker/u2:0]
>>>> 22641 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 22682 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 22754 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 22761 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 22993 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 23218 root       832 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 23260 root       832 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 23331 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 23348 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 23647 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 24003 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 24040 root         0 SW   [kworker/u2:2]
>>>> 24042 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 24118 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 24336 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 24350 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 24686 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 24921 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 25006 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 25353 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 25658 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 25684 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 25706 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 25765 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 25821 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 25996 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 26096 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 26659 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 26752 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 26769 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 27079 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 27183 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 27403 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 27484 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 27570 root       832 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 27643 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 27817 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 27999 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 28086 root       832 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 28392 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 28565 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 28729 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 28870 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 28883 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 29044 root       832 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 29066 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 29722 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 29730 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 29907 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 29915 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 29953 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 30246 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 30424 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 30527 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 30699 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 30778 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 30912 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 30929 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 31256 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 31545 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 31597 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 31746 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 31903 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 31999 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 32251 root       828 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 32327 root       836 S    odhcp6c -s /lib/netifd/dhcpv6.script -P60 ge00
>>>> 32504 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>> 32633 root      1716 S    udhcpc -p /var/run/udhcpc-ge00.pid -s
>>>> /lib/netifd/dh
>>>>
>>
>>
>"
439,David Taht,2014-01-21 03:26:15.389387,"on a side note it looks straightforward to convert core daemons
(babeld,xinetd,lighttpd) I use into being procd compatible.
Looking that over this morning. It would be nice for procd to respawn
a crashed process cleanly. Babel crashes occasionally in particular...

Attached is a log of the one error I see on a network restart. I note
that I have not looked at things in this detail before, so this may
well happen for you (just add -x to /sbin/wifi)

This bit:

+ json_dump
+ jshn -w
+ ubus call network.wireless down { }

When called, from within a ""/etc/init.d/network restart"" script, it does this:

Command failed: Not found

when that ubus command is called at the command line that call succeeds.
when it is called from running the ""wifi down"" at the command line,
that call succeeds.

when called from network restart it fails.

out of stack or environment space? (6 wifi interfaces here). I am cursed?"
439,David Taht,2014-01-21 03:45:32.71562,"grump. ok, I don't see that error in that case. And that might explain
all the extra processes lying around from my testing.

I've got  fresh build going, I will reflash and resume in a half hour or so

On Tue, Jan 21, 2014 at 6:30 AM, Steven Barth <cyrus@openwrt.org> wrote:
> On 21.01.2014 12:26, Dave Taht wrote:
>>
>> on a side note it looks straightforward to convert core daemons
>> (babeld,xinetd,lighttpd) I use into being procd compatible.
>> Looking that over this morning. It would be nice for procd to respawn
>> a crashed process cleanly. Babel crashes occasionally in particular...
>>
>> Attached is a log of the one error I see on a network restart. I note
>> that I have not looked at things in this detail before, so this may
>> well happen for you (just add -x to /sbin/wifi)
>>
>> This bit:
>>
>> + json_dump
>> + jshn -w
>> + ubus call network.wireless down { }
>>
>> When called, from within a ""/etc/init.d/network restart"" script, it does
>> this:
>
> In general try to avoid /etc/init.d/network restart because it might cause
> an unclean shutdown. Always try to use /etc/init.d/network reload instead."
440,Ron Beck-Anderson,2014-03-03 08:11:06.815614,"
Solved.

Had to adjust URL in /etc/opkg.conf to:
http://snapon.lab.bufferbloat.net/~cero2/cerowrt/wndr/3.10.26-1/ar71xx/packages
(note the ' ar71xx ' , which was missing in the original opkg.conf file.

Also had to change
option check_signature 1
option signature_ca_file /etc/ssl/certs/opkg.pem
to
#option check_signature 1
#option signature_ca_file /etc/ssl/certs/opkg.pem
to make it not complain about cert...

Testing 3.10.26-1 due to 5GHz radio issues with 3.10.32-4.
(radio would have MAC 00:00:00...)


"
441,Dave Täht,2014-03-25 20:44:53.432662,fixed march 7. Am certain it's fixed in 3.10.32-12.
442,David Taht,2014-04-05 09:31:16.438499,"---------- Forwarded message ----------
From: Dave Taht <dave.taht@gmail.com>
Date: Wed, Apr 2, 2014 at 7:43 PM
Subject: Re: [Cerowrt-devel] cerowrt-3.10.34-4 dev build released
To: Stephen Hemminger <stephen@networkplumber.org>
Cc: ""cerowrt-devel@lists.bufferbloat.net"" <cerowrt-devel@lists.bufferbloat.net>


I am actually far from convinced it is actually a wifi bug. It could
be something going wrong with routing, firewalling, nat, or something
else entirely. I have several captures of sw00 and ge00 taken after
the event occurs, and local udp, arp, and icmp and icmpv6 traffic is
working correctly. As is multicast.

The other device (sw10) stays running...

What I see in the captures I have is syn attempts from the sw00
interface do make it to the internet, and syn/ack attempts do return
through ge00, but
do not  make it through sw00. However I don't see ANY local syn
attempts in the capture I have: jg or someone needs to try a local tcp
connection to a local device or through the local router to a local
ethernet device after having it hang... (I will keep trying to
reproduce here)

tcp.flags == 0x0002

On Wed, Apr 2, 2014 at 6:48 PM, Stephen Hemminger
<stephen@networkplumber.org> wrote:
> I am seeing wireless hang as well.
> Mostly when multiple macbooks are active on 2.4g"
442,David Taht,2014-04-05 09:33:48.006709,"The  above  subject line and cc  will  get this conversation  into
the bug  tracker.


---------- Forwarded message ----------
From: Dave Taht <dave.taht@gmail.com>
Date: Sat, Apr 5, 2014 at 9:15 AM
Subject: Re: [Cerowrt-devel] cerowrt-3.10.34-4 dev build released
To: Neil Shepperd <nshepperd@gmail.com>
Cc: ""cerowrt-devel@lists.bufferbloat.net"" <cerowrt-devel@lists.bufferbloat.net>


In_trying_to_sort_out_the_differences_between_the_people
working_wifi_for_long_periods,vs_those_without...

I_am_curious_if_your_country
code_is_set,and_what_it_is_set_to,and_your_wifi_channel_set

It_is_long_past_time_we_start_up_a_formal_bug_for_this,
but_I'll_wait_for_my_spacebar.

In_a_known_pretty_good_case:

root@lorna-gw:~# cat /etc/openwrt_release
DISTRIB_ID=""CeroWrt""
DISTRIB_RELEASE=""3.10.32-9""
DISTRIB_REVISION=""r39917""
DISTRIB_CODENAME=""toronto""
DISTRIB_TARGET=""ar71xx/generic""
DISTRIB_DESCRIPTION=""CeroWrt Toronto 3.10.32-9""
DISTRIB_TAINTS=""no-all busybox""

root@lorna-gw:~# uptime
 16:07:37 up 21 days, 21:35,  load average: 0.00, 0.01, 0.04

root@lorna-gw:~# egrep -i ""country|channel|htmode"" /etc/config/wireless
    option channel  11
    option htmode    HT20
    option channel '44'
    option htmode    HT40+
    option country 'US'


On Sat, Apr 5, 2014 at 9:02 AM, Dave Taht <dave.taht@gmail.com> wrote:
> On Sat, Apr 5, 2014 at 5:49 AM, Neil Shepperd <nshepperd@gmail.com> wrote:
>>> Sounds like you are going to stick with -4 for a bit?
>>
>> Actually, this is the first time I've tried cerowrt on a router. But
>> yeah, I'll stick with the current version unless you come out with a new
>> patch to try.
>
> Thx. I am hoping this is the *last* priority 1 bug cerowrt has.
>
> but_fixing_it_is_going_to_be_pita.
>
> I_confess_to_""embedded_fatigue"".
>
>>> what I've been doing is mounting a usb stick, and just running continuously
>>> on the stick
>>>
>>> tcpdump -s 128 -i ge00 -w ge00.cap &
>>> tcpdump -s 128 -i sw00 -w sw00.cap &
>>>
>>> This definately hurts performance...
>>>
>>> And it's probably time to do a tcpdump on the connected device as well.
>>>
>>
>> Update: I did this, and experienced the hang again. A first look at the
>> tcpdump output on sw00 shows a sudden reduction in traffic at 20:40:54,
>> so I assume that's probably the time of the event. After that, I see
>> many DHCP and ARP requests arriving, but no responses leaving the interface.
>
> It_would_be_nice_to_see_10sec_of_these_captures_before_and_after.
>
>>
>> In fact, I don't see anything leaving except, oddly, some DNS responses
>> (which are indeed received by my laptop). I also see some EAPOL stuff on
>> both the router and laptop at roughly the same time, so I guess that's
>> getting through, but I don't know the direction.
>>
>> I think next time I'll try with -Pin/-Pout to separate incoming and
>> outgoing packets properly...
>
> Tis easier_to_sort_in_wireshark_against_one_capture,IMHO.
>
> I_have_been_looking_for_failed_syn_attempts_and_retries_as_a_key_indicator
> that_something_Bad_happened.
>
>>> Hmm. OK, this brings back the device driver into the equation... I
>>> WAS seeing dhcp and arp requests ""getting through"" from the captures,
>>> and it seemed like arp in particular was getting through...
>>
>> So I guess this is only half right? What I see in syslog is dnsmasq
>> saying it has sent a packet, but it doesn't make it onto the interface.
>> Apart from DNS packets, so I don't know what to make of that.
>
> It_is_possible_there_are_a_variety_of_failure_modes.
>
> I_am_not_entirely_convinced_this_is_actually_a_wifi_specific_failure.
>
> can_you_try_ssh_to_the_router_during_a_failure,and/or_accessing
> the_web_admin_interface?and/or_trying_to
>
> if_you_are_not_using_babel_disable_it.It_makes_a_lot_of_updates
> to_the_routing_table.that_might_be_malfunctioning..
>
> (I_really_need_a_keyboard_that_recovers_from_damp_weather.)
>
>> Neil
>
>
>"
442,David Taht,2014-04-05 09:57:02.104632,"---------- Forwarded message ----------
From: David Personette <dperson@gmail.com>
Date: Thu, Apr 3, 2014 at 6:26 PM
Subject: Re: [Cerowrt-devel] cerowrt-3.10.34-4 dev build released
To: Maxim Kharlamov <mcs@podsolnuh.biz>
Cc: Dave Taht <dave.taht@gmail.com>,
""cerowrt-devel@lists.bufferbloat.net""
<cerowrt-devel@lists.bufferbloat.net>


I have an OSX laptop on 5ghz, a Linux desktop and server via ethernet,
Linux Laptop via 5gz, Roku via 5gz, Nexus 7 via 5gz, and misc other
devices... I didn't get my total bandwidth on 3.10.32-12, 3.10.34-1,
but I've done 3.3GB down 0.9GB up since flashing 3.10.34-4. I've had
no problems on any of those builds. It's been rock solid for me. I
work from home two days a week (Tues and Thurs), wireless connection
via my work OSX laptop. Since the 3.10.x series, I've noticed that
WiFi has been noticeably faster. If there is a roll-back of the
kernel, would it be possible to have a fork still with the latest
kernel too... otherwise how will it be known when the issue is fixed,
sorry to be a PitA."
442,David Taht,2014-04-05 09:57:49.279166,"---------- Forwarded message ----------
From: Aaron Wood <woody77@gmail.com>
Date: Fri, Apr 4, 2014 at 12:04 AM
Subject: Re: [Cerowrt-devel] cerowrt-3.10.34-4 dev build released
To: Dave Taht <dave.taht@gmail.com>
Cc: Maxim Kharlamov <mcs@podsolnuh.biz>,
""cerowrt-devel@lists.bufferbloat.net""
<cerowrt-devel@lists.bufferbloat.net>


On Fri, Apr 4, 2014 at 12:58 AM, Dave Taht <dave.taht@gmail.com> wrote:
>
> On Thu, Apr 3, 2014 at 3:57 PM, Aaron Wood <woody77@gmail.com> wrote:
> > On Fri, Apr 4, 2014 at 12:56 AM, Aaron Wood <woody77@gmail.com> wrote:
> >>
> >> Up for 10 days on 3.10.32-12 (WNDR3800).  Only have 2 devices that run
> >> 2.4GHz, and it's only seen 2GB of traffic on SW00 in that time...  The 5GHz
> >> radio has had >5GB of traffic on it in the same time.  No problems at all.
> >
> >
> > And I also have both 2.4 and 5GHz babel and guest SSIDs all turned off.
> >
> > -Aaron
>
> Your clients are?
>
> So far there seems to be a significant trend towards osx being an issue...


iOS 7 (a pair of iPhone 4's).  Everything that supports 5GHz is using 5GHz.

-Aaron"
442,David Taht,2014-04-05 09:58:43.687558,"---------- Forwarded message ----------
From: Maxim Kharlamov <mcs@podsolnuh.biz>
Date: Thu, Apr 3, 2014 at 3:51 PM
Subject: Re: [Cerowrt-devel] cerowrt-3.10.34-4 dev build released
To: Dave Taht <dave.taht@gmail.com>
Cc: ""cerowrt-devel@lists.bufferbloat.net"" <cerowrt-devel@lists.bufferbloat.net>


The last release without wifi issues was 3.8.something (I think it was
called Berlin). The whole 3.10.x branch seems to have broken wifi
(will see how 3.10.24-4 goes, it seems OK, but it's been working less
than 24hours yet).
I'm using only 2.4Ghz (5Ghz dead in the water - devices couldn't
connect at all, so I disabled it). Guest and babel disabled.


Regards,
Max


On Fri, Apr 4, 2014 at 11:36 AM, Dave Taht <dave.taht@gmail.com> wrote:
>
> Is there a recent version that people had that was seemingly stable for
> wifi that we could step back to and bisect from? Something where
> you had heavy wifu use for week(s) without a problem?
>
> (I know that until we got focused on this, and people focused on
> reporting it, that maybe it was happening in releases I'd otherwise
> considered to be ""pretty good""... so please report in on your ""best""
> releases this year...)
>
> Worst case we can step back to that kernel for a while and proceed forward
> on all the other stuff. I know I crave stability at this point, and I'm
> unhappy that everyone here is unhappy, too...
>
> Regrettably since losing my lab I have not been in a position to easily
> test wifi to any huge extent. I'm slowly building that up (but for example
> no longer have a mac to test with)
>
>
> On Thu, Apr 3, 2014 at 11:20 AM, Neil Shepperd <nshepperd@gmail.com> wrote:
> > I just flashed 3.10.34-4 to my new WNDR3800 and experienced the exact
> > wifi hang described by Toke Høiland-Jørgensen. But I'm on the 2.4GHz
> > network (with guest and babel disabled). Unfortunately I didn't think to
> > try tracing anything from the router side before resetting the wireless.
>
> cool you disabled guest and babel. So far we've sort of ruled out
> 6in4 tunnelling, and syn flood protection.
>
> Sounds like you are going to stick with -4 for a bit?
>
> what I've been doing is mounting a usb stick, and just running continuously
> on the stick
>
> tcpdump -s 128 -i ge00 -w ge00.cap &
> tcpdump -s 128 -i sw00 -w sw00.cap &
>
> This definately hurts performance...
>
> And it's probably time to do a tcpdump on the connected device as well.
>
> In terms of other diags... (any suggestions?)
>
> > Syslog was filled with a lot of
> >
> > DHCPDISCOVER(sw00) [MAYBE IP] [MAC ADDRESS]
> > DHCPOFFER(sw00) [IP] [MAC ADDRESS]
>
> Hmm. OK, this brings back the device driver into the equation... I
> WAS seeing dhcp and arp requests ""getting through"" from the captures,
> and it seemed like arp in particular was getting through...
>
> >
> > but the offers aren't being received at my laptop.
> >
> > Just another data point I guess.
>
> Well, I'd hoped it would be a confirming one rather than one opening
> up more questions.
>
> > Neil
> > _______________________________________________
> > Cerowrt-devel mailing list
> > Cerowrt-devel@lists.bufferbloat.net
> > https://lists.bufferbloat.net/listinfo/cerowrt-devel
>
>
>"
442,David Taht,2014-04-05 09:59:32.425393,"---------- Forwarded message ----------
From: Jim Gettys <jg@freedesktop.org>
Date: Thu, Apr 3, 2014 at 8:17 AM
Subject: Re: [Cerowrt-devel] cerowrt-3.10.34-4 dev build released
To: Stephen Hemminger <stephen@networkplumber.org>
Cc: Dave Taht <dave.taht@gmail.com>,
""cerowrt-devel@lists.bufferbloat.net""
<cerowrt-devel@lists.bufferbloat.net>


n Wed, Apr 2, 2014 at 9:48 PM, Stephen Hemminger
<stephen@networkplumber.org> wrote:
>
> I am seeing wireless hang as well.
> Mostly when multiple macbooks are active on 2.4g
>
>

Also true in my house: both kids are on Macbooks.

But I've seen the problem with no-one but me (on Linux) around, so all
that says is that if the router is in use more, you see more failures.
 So I'm not sure I can draw much from this experience."
442,David Taht,2014-04-05 12:06:52.233593,"In trying to sort this stuff out (been looking at a ton of commits between
3.10.34 and 3.14) I have a few candidates in various parts of the
stack to try to backport.

3.10.34-3.10.36 does not seem to have any relevant patches, but I just
updated to 3.10.36 anyway.

In openwrt head, there has been a problem in dhcpv6 renews, which you
can see on the dhcpv6 web page after a day or so. That looks to be
fixed now.

So I just merged from openwrt head.

I try to be happy that most of our problems are now taking days to crop up.

I will probably produce a topic branch at this point which will have heavy
levels of debugging enabled. I'd like to be able to trace packets from
origin to (non) exit, somehow..."
442,David Personette,2014-04-05 15:55:56.001195,"I assume that you wanted other people to report their status? Working here:

root@outpost:~# cat /etc/openwrt_release
DISTRIB_ID=""CeroWrt""
DISTRIB_RELEASE=""3.10.34-4""
DISTRIB_REVISION=""r40361""
DISTRIB_CODENAME=""toronto""
DISTRIB_TARGET=""ar71xx/generic""
DISTRIB_DESCRIPTION=""CeroWrt Toronto 3.10.34-4""
DISTRIB_TAINTS=""no-all busybox""

root@outpost:~# uptime
 22:52:44 up 2 days, 11:16,  load average: 0.00, 0.01, 0.04

root@outpost:~# egrep -i ""country|channel|htmode"" /etc/config/wireless
    option channel  11
    option htmode    HT40-
    option channel  36
    option htmode    HT40+"
442,Neil Shepperd,2014-04-05 19:45:22.123563,"Experiencing the bug every few days:

root@cerowrt:~# cat /etc/openwrt_release
DISTRIB_ID=""CeroWrt""
DISTRIB_RELEASE=""3.10.34-4""
DISTRIB_REVISION=""r40361""
DISTRIB_CODENAME=""toronto""
DISTRIB_TARGET=""ar71xx/generic""
DISTRIB_DESCRIPTION=""CeroWrt Toronto 3.10.34-4""
DISTRIB_TAINTS=""no-all busybox""

root@cerowrt:~# uptime
 12:22:42 up 1 day, 18:37,  load average: 0.04, 0.04, 0.05

root@cerowrt:~# egrep -i ""country|channel|htmode"" /etc/config/wireless
        option htmode 'HT20'
        option country 'AU'
        option channel 'auto'
        option htmode 'HT20'
        option country 'AU'
        option channel 'auto'

>> It_would_be_nice_to_see_10sec_of_these_captures_before_and_after.

Uploaded at http://zlkj.in/files/wireshark/. I filtered the captures in
wireshark for frame.time > ""April 5, 2014 20:40:44"" which is about 10
seconds before the bug. wlan0.cap is the capture from my laptop. ppp.cap
is from the pppoe connection on ge00.

>> It_is_possible_there_are_a_variety_of_failure_modes.
>>
>> I_am_not_entirely_convinced_this_is_actually_a_wifi_specific_failure.
>>
>> can_you_try_ssh_to_the_router_during_a_failure,and/or_accessing
>> the_web_admin_interface?and/or_trying_to

I can ssh in and access the admin interface if I connect my laptop by an
ethernet cable. But during the failure, I can't access the admin
interface or the internet over sw00. After resetting sw00 by admin
interface on se00, I can connect over the wireless again.

>> if_you_are_not_using_babel_disable_it.It_makes_a_lot_of_updates
>> to_the_routing_table.that_might_be_malfunctioning..

I thought I disabled babel, but I'm still seeing babel packets in the
capture, so I guess disabling the ""babel"" networks on both radios in the
wifi tab is not enough."
442,David Taht,2014-04-07 15:33:23.091923,"If you are lucky enough to have a working iwl or ath9k or otherwise
supported mac80211 card in your laptop and are running linux, install
aircrack-ng, and use the airmon-ng tool to setup a monitoring
interface.

What I'm doing at the moment is capturing the mon0 interface with
wireshark while beating up the network as much as I can. (and trying
to come up with ways to parse the results sanely)

http://wiki.wireshark.org/CaptureSetup/WLAN

There are some instructions for BSD OSX in there too.

There isn't a way to do this in windows, apparently, without a special device:

http://www.riverbed.com/products-solutions/products/network-performance-management/wireshark-enhancement-products/Wireless-Traffic-Packet-Capture.html"
442,David Taht,2014-04-08 12:50:28.621666,"Finally found the smoke, from a gun still offstage.

The background wifi queue (1:40) gets wedged.

This explains why this only seemed to happen on comcast (Which
re-marks a LOT of traffic
background that it shouldn't, and yes we should start mangling packets
back to ""be"" in sqm
as an option), and why local traffic seemed to mostly work when stuff
coming back from the internet didn't.

As to *why* it happens, don't know. I'm sitting in the #bufferbloat channel
scratching my head as to means to explore the problem without
unwedging the interface.

It seems plausible we can MUCH more easily reproduce this now by flooding the
background queues with traffic (netperf can do this). It's not clear
you can trigger it
with just tcp however or if multiple hops are required, etc, etc.

root@cerowrt:/mnt/disk1# tc -s qdisc show dev sw00
qdisc mq 1: root
 Sent 3926131082 bytes 2998293 pkt (dropped 91657, overlimits 0 requeues 70095)
 backlog 77608b 1000p requeues 70095
qdisc fq_codel 10: parent 1:1 limit 800p flows 1024 quantum 500 target
10.0ms interval 100.0ms
 Sent 110555 bytes 771 pkt (dropped 0, overlimits 0 requeues 5)
 backlog 0b 0p requeues 5
  maxpacket 256 drop_overlimit 0 new_flow_count 2 ecn_mark 0
  new_flows_len 0 old_flows_len 0
qdisc fq_codel 20: parent 1:2 limit 800p flows 1024 quantum 300 target
5.0ms interval 100.0ms ecn
 Sent 2526448 bytes 17982 pkt (dropped 1, overlimits 0 requeues 31)
 backlog 0b 0p requeues 31
  maxpacket 929 drop_overlimit 0 new_flow_count 71 ecn_mark 0
  new_flows_len 0 old_flows_len 0
qdisc fq_codel 30: parent 1:3 limit 1000p flows 1024 quantum 300
target 5.0ms interval 100.0ms ecn
 Sent 15145657 bytes 106290 pkt (dropped 0, overlimits 0 requeues 179)
 backlog 0b 0p requeues 179
  maxpacket 256 drop_overlimit 0 new_flow_count 0 ecn_mark 0
  new_flows_len 0 old_flows_len 0
qdisc fq_codel 40: parent 1:4 limit 1000p flows 1024 quantum 300
target 5.0ms interval 100.0ms
 Sent 3908348422 bytes 2873250 pkt (dropped 91656, overlimits 0 requeues 69880)
 backlog 77608b 1000p requeues 69880
                         ^^^^^!!!!!

  maxpacket 1514 drop_overlimit 72128 new_flow_count 85727 ecn_mark 0
  new_flows_len 238 old_flows_len 1

I got the ""wedged"" interface to work again re-marking all tcp traffic
as best effort""

iptables -A FORWARD -o sw00 -t mangle -p tcp -m tcp -j DSCP --set-dscp-class be

thus moving traffic into 1:3 above.

(can probably improve on this iptables thing, but it's just a
workaround and for all I know we can also trigger this on the be
queue)

icmp replies however, seems to want to always go into the background
queue for some reason. (?)

We did have this happen earlier on this run

[31325.589843] ath: phy0: Failed to stop TX DMA, queues=0x008!
[32380.960937] ath: phy0: Failed to stop TX DMA, queues=0x008!
[32381.035156] ath: phy0: Failed to stop TX DMA, queues=0x008!
[32381.140625] ath: phy0: Failed to stop TX DMA, queues=0x008!
[32381.242187] ath: phy0: Failed to stop TX DMA, queues=0x008!
[32381.343750] ath: phy0: Failed to stop TX DMA, queues=0x008!
[32418.824218] ath: phy0: Failed to stop TX DMA, queues=0x008!
[32445.863281] ath: phy0: Failed to stop TX DMA, queues=0x108!
[32445.960937] ath: phy0: Failed to stop TX DMA, queues=0x008!
[32446.062500] ath: phy0: Failed to stop TX DMA, queues=0x008!
[32446.164062] ath: phy0: Failed to stop TX DMA, queues=0x008!
[32446.265625] ath: phy0: Failed to stop TX DMA, queues=0x008!
[32446.367187] ath: phy0: Failed to stop TX DMA, queues=0x008!
[32446.472656] ath: phy0: Failed to stop TX DMA, queues=0x008!
[32446.574218] ath: phy0: Failed to stop TX DMA, queues=0x008!
[32446.683593] ath: phy0: Failed to stop TX DMA, queues=0x00c!
[32446.777343] ath: phy0: Failed to stop TX DMA, queues=0x008!
[32446.886718] ath: phy0: Failed to stop TX DMA, queues=0x009!
[34701.062500] ath: phy0: Failed to stop TX DMA, queues=0x008!
[34701.140625] ath: phy0: Failed to stop TX DMA, queues=0x008!
[34701.242187] ath: phy0: Failed to stop TX DMA, queues=0x008!"
442,Dave Täht,2014-04-08 13:27:12.371022,"btw we do also have unaligned instructions still:

root@cerowrt:/sys/kernel/debug/mips# cat unaligned_instructions 
1154

and we are also using a very short qlen_be and qlen_bk = 12

and the debloat script tosses stuff on md's queues 1:1,1:2,1:3,1:4 rather than the default and invisible md 0:1, etc.

While saturating the be queue with a couple netperfs, I get:

root@cerowrt:/sys/kernel/debug/ieee80211/phy0/netdev:sw00/stations/00:15:6d:84:b3:00# cat rc_stats 
type         rate     throughput  ewma prob   this prob  retry   this succ/attempt   success    attempts
CCK/LP        1.0M           0.7       96.3       100.0      0              0(  0)       973        1003
CCK/SP        2.0M           1.5      100.0       100.0      0              0(  0)         1           1
CCK/SP        5.5M           3.8      100.0       100.0      0              0(  0)         1           1
CCK/SP       11.0M           6.1      100.0       100.0      0              0(  0)         1           1
HT20/LGI     MCS0            5.7      100.0       100.0      3              0(  0)         1           1
HT20/LGI     MCS1           11.5       95.7       100.0      0              0(  0)        12          13
HT20/LGI     MCS2           16.7      100.0       100.0      0              0(  0)         1           1
HT20/LGI     MCS3           21.9      100.0       100.0      0              0(  0)         1           1
HT20/LGI     MCS4           31.5      100.0       100.0      0              0(  0)         1           1
HT20/LGI     MCS5           40.1      100.0       100.0      0              0(  0)         1           1
HT20/LGI     MCS6           44.0       96.2       100.0      0              0(  0)        18          20
HT20/LGI     MCS7           48.8      100.0       100.0      0              0(  0)         1           1
HT20/LGI     MCS8           11.5      100.0       100.0      0              0(  0)         1           1
HT20/LGI     MCS9           21.9      100.0       100.0      0              0(  0)         1           1
HT20/LGI     MCS10          31.5      100.0       100.0      0              0(  0)         1           1
HT20/LGI     MCS11          40.1      100.0       100.0      0              0(  0)         1           1
HT20/LGI     MCS12          56.1      100.0       100.0      0              0(  0)         1           1
HT20/LGI     MCS13          68.0       95.6       100.0      0              0(  0)        16          18
HT20/LGI     MCS14          74.9      100.0       100.0      0              0(  0)         1           1
HT20/LGI     MCS15          80.2      100.0       100.0      6              0(  0)         1           1
HT40/LGI     MCS0           11.9      100.0       100.0      0              0(  0)         1           1
HT40/LGI     MCS1           22.8      100.0       100.0      0              0(  0)         1           1
HT40/LGI     MCS2           32.5      100.0       100.0      0              0(  0)         1           1
HT40/LGI     MCS3           41.6      100.0       100.0      0              0(  0)         1           1
HT40/LGI     MCS4           57.6      100.0       100.0      0              0(  0)         1           1
HT40/LGI     MCS5           70.1      100.0       100.0      0              0(  0)         1           1
HT40/LGI     MCS6           77.5      100.0       100.0      0              0(  0)         1           1
HT40/LGI     MCS7           83.3       96.0       100.0      5              0(  0)       301         319
HT40/LGI     MCS8           22.8      100.0       100.0      0              0(  0)         1           1
HT40/LGI     MCS9           41.6      100.0       100.0      0              0(  0)         1           1
HT40/LGI     MCS10          57.6      100.0       100.0      0              0(  0)         1           1
HT40/LGI     MCS11          70.1      100.0       100.0      0              0(  0)         1           1
HT40/LGI     MCS12          93.6       99.7       100.0      6              0(  0)        45          46
HT40/LGI     MCS13         107.1       95.6       100.0      5              0(  0)      2743        3151
HT40/LGI  t  MCS14         118.4       92.6        93.4      6            172(184)     53259       64221
HT40/LGI     MCS15          94.1       67.8       100.0      6              2(  2)     29077       40909
HT40/SGI     MCS0           13.2      100.0       100.0      0              0(  0)         1           1
HT40/SGI     MCS1           25.1      100.0       100.0      0              0(  0)         1           1
HT40/SGI     MCS2           35.5      100.0       100.0      0              0(  0)         1           1
HT40/SGI     MCS3           45.1      100.0       100.0      0              0(  0)         1           1
HT40/SGI     MCS4           62.1      100.0       100.0      0              0(  0)         1           1
HT40/SGI     MCS5           75.2      100.0       100.0      0              0(  0)         1           1
HT40/SGI     MCS6           82.7      100.0       100.0      5              0(  0)         9           9
HT40/SGI   P MCS7           88.5       98.5       100.0      5              0(  0)       967        1145
HT40/SGI     MCS8           25.1      100.0       100.0      0              0(  0)         1           1
HT40/SGI     MCS9           45.1      100.0       100.0      0              0(  0)         1           1
HT40/SGI     MCS10          62.1      100.0       100.0      0              0(  0)         1           1
HT40/SGI     MCS11          75.2      100.0       100.0      0              0(  0)         1           1
HT40/SGI     MCS12          99.0       96.6       100.0      5              0(  0)       821         876
HT40/SGI     MCS13         112.4       95.7       100.0      6              1(  1)     88413       94617
HT40/SGI     MCS14          86.6       63.1         0.0      6              0(  1)    715161      805305
HT40/SGI T   MCS15         122.6       84.8       100.0      6              1(  1)     98281      127685

"
442,Dave Täht,2014-04-08 13:30:56.263719,"And interestingly, after disabling the bk queue with iptables, and waiting a while, the 1000 packet backlog cleared.

qdisc mq 1: root 
 Sent 6376179748 bytes 5429375 pkt (dropped 92662, overlimits 0 requeues 98880) 
 backlog 0b 0p requeues 98880 
qdisc fq_codel 10: parent 1:1 limit 800p flows 1024 quantum 500 target 10.0ms interval 100.0ms 
 Sent 115759 bytes 807 pkt (dropped 0, overlimits 0 requeues 5) 
 backlog 0b 0p requeues 5 
  maxpacket 256 drop_overlimit 0 new_flow_count 2 ecn_mark 0
  new_flows_len 0 old_flows_len 0
qdisc fq_codel 20: parent 1:2 limit 800p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
 Sent 3053074 bytes 25673 pkt (dropped 1, overlimits 0 requeues 38) 
 backlog 0b 0p requeues 38 
  maxpacket 929 drop_overlimit 0 new_flow_count 73 ecn_mark 0
  new_flows_len 0 old_flows_len 0
qdisc fq_codel 30: parent 1:3 limit 1000p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
 Sent 2464586793 bytes 2528666 pkt (dropped 947, overlimits 0 requeues 28957) 
 backlog 0b 0p requeues 28957 
  maxpacket 1514 drop_overlimit 0 new_flow_count 82547 ecn_mark 1
  new_flows_len 0 old_flows_len 1
qdisc fq_codel 40: parent 1:4 limit 1000p flows 1024 quantum 300 target 5.0ms interval 100.0ms 
 Sent 3908424122 bytes 2874229 pkt (dropped 91714, overlimits 0 requeues 69880) 
 backlog 0b 0p requeues 69880 
  maxpacket 1514 drop_overlimit 72166 new_flow_count 85740 ecn_mark 0
  new_flows_len 1 old_flows_len 251
"
442,Dave Täht,2014-04-08 13:50:50.987917,"(01:32:44 PM) dtaht_nuc: qdisc fq_codel 40: parent 1:4 limit 1000p flows 1024 quantum 300 target 5.0ms interval 100.0ms 
(01:32:44 PM) dtaht_nuc:  Sent 3908424122 bytes 2874229 pkt (dropped 91714, overlimits 0 requeues 69880) 
(01:32:44 PM) dtaht_nuc:  backlog 0b 0p requeues 69880 
(01:32:44 PM) dtaht_nuc:   maxpacket 1514 drop_overlimit 72166 new_flow_count 85740 ecn_mark 0
(01:32:44 PM) dtaht_nuc:   new_flows_len 1 old_flows_len 251
(01:40:01 PM) dtaht_nuc: ok, so I just tried a limited exercise of the bk queue
(01:40:10 PM) dtaht_nuc: it is indeed still wedged after it cleared
(01:40:11 PM) dtaht_nuc: qdisc fq_codel 40: parent 1:4 limit 1000p flows 1024 quantum 300 target 5.0ms interval 100.0ms 
(01:40:11 PM) dtaht_nuc:  Sent 3908424196 bytes 2874230 pkt (dropped 91714, overlimits 0 requeues 69881) 
(01:40:11 PM) dtaht_nuc:  backlog 518b 8p requeues 69881 
(01:40:11 PM) dtaht_nuc:   maxpacket 1514 drop_overlimit 72166 new_flow_count 85741 ecn_mark 0
(01:40:11 PM) dtaht_nuc:   new_flows_len 2 old_flows_len 251
(01:40:46 PM) dtaht_nuc: might be wedged on input too
(01:46:55 PM) dtaht_nuc: and lastly, resetting the qdisc does NOT fix the problem"
442,Dave Täht,2014-04-08 13:51:07.460418,"root@cerowrt:/sys/kernel/debug/ieee80211/phy0/ath9k# cat xmit 
                            BE         BK        VI        VO

MPDUs Queued:               50       2314       223    652400
MPDUs Completed:         40281      85321      8731    616194
MPDUs XRetried:            242       2644       350     36901
Aggregates:             783024     486368       202         0
AMPDUs Queued HW:            0          0         0         0
AMPDUs Queued SW:      4456600    2875990     60600       695
AMPDUs Completed:      4416029    2786190     51561         0
AMPDUs Retried:         253185     110105      1007         0
AMPDUs XRetried:            96       3990       181         0
TXERR Filtered:             70       5281       169        77
FIFO Underrun:               0          0         0         0
TXOP Exceeded:               0          0         0         0
TXTIMER Expiry:              0          0         0         0
DESC CFG Error:              0          0         0         0
DATA Underrun:               0          0         0         0
DELIM Underrun:              0          0         0         0
TX-Pkts-All:           4456648    2878145     60823    653095
TX-Bytes-All:        457325109 4000133941   7212777 113292607
HW-put-tx-buf:             334        188       128       330
HW-tx-start:           1385587    1596997     61534    653095
HW-tx-proc-desc:       1385547    1612853     61531    653067
TX-Failed:                   0          0         0         0
root@cerowrt:/sys/kernel/debug/ieee80211/phy0/ath9k# cat xmit 
                            BE         BK        VI        VO

MPDUs Queued:               50       2314       223    652400
MPDUs Completed:         40286      85321      8731    616194
MPDUs XRetried:            242       2644       350     36901
Aggregates:             784312     486368       202         0
AMPDUs Queued HW:            0          0         0         0
AMPDUs Queued SW:      4464165    2875990     60600       695
AMPDUs Completed:      4423589    2786190     51561         0
AMPDUs Retried:         253680     110105      1007         0
AMPDUs XRetried:            96       3990       181         0
TXERR Filtered:             70       5281       169        77
FIFO Underrun:               0          0         0         0
TXOP Exceeded:               0          0         0         0
TXTIMER Expiry:              0          0         0         0
DESC CFG Error:              0          0         0         0
DATA Underrun:               0          0         0         0
DELIM Underrun:              0          0         0         0
TX-Pkts-All:           4464213    2878145     60823    653095
TX-Bytes-All:        468998281 4000133941   7212777 113292607
HW-put-tx-buf:             334        188       128       330
HW-tx-start:           1388889    1596997     61534    653095
HW-tx-proc-desc:       1388849    1612853     61531    653067
TX-Failed:                   0          0         0         0
"
442,Dave Täht,2014-04-08 14:05:31.04031,"root@cerowrt:/sys/kernel/debug/ieee80211/phy0/ath9k# cat queues
(VO):  qnum: 0 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(VI):  qnum: 1 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(BE):  qnum: 2 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(BK):  qnum: 3 qdepth:  0 ampdu-depth:  0 pending: 151 stopped: 1
(CAB): qnum: 8 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
"
442,Dave Täht,2014-04-08 18:18:24.403448,"It is possible to crash the BE queue too

root@cerowrt:~# tc -s qdisc show dev sw10
qdisc mq 1: root 
 Sent 3852715919 bytes 2982888 pkt (dropped 5360, overlimits 0 requeues 55107) 
 backlog 99468b 1000p requeues 55107 
qdisc fq_codel 10: parent 1:1 limit 800p flows 1024 quantum 500 target 10.0ms interval 100.0ms 
 Sent 41188 bytes 292 pkt (dropped 0, overlimits 0 requeues 1) 
 backlog 0b 0p requeues 1 
  maxpacket 256 drop_overlimit 0 new_flow_count 0 ecn_mark 0
  new_flows_len 0 old_flows_len 0
qdisc fq_codel 20: parent 1:2 limit 800p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
 Sent 1792325 bytes 8919 pkt (dropped 0, overlimits 0 requeues 22) 
 backlog 0b 0p requeues 22 
  maxpacket 1514 drop_overlimit 0 new_flow_count 19 ecn_mark 0
  new_flows_len 0 old_flows_len 0
qdisc fq_codel 30: parent 1:3 limit 1000p flows 1024 quantum 300 target 5.0ms interval 100.0ms ecn 
 Sent 1537736330 bytes 1266113 pkt (dropped 2479, overlimits 0 requeues 19919) 
 backlog 99468b 1000p requeues 19919 
  maxpacket 1514 drop_overlimit 710 new_flow_count 16535 ecn_mark 14
  new_flows_len 71 old_flows_len 1
qdisc fq_codel 40: parent 1:4 limit 1000p flows 1024 quantum 300 target 5.0ms interval 100.0ms 
 Sent 2313146076 bytes 1707564 pkt (dropped 2881, overlimits 0 requeues 35165) 
 backlog 0b 0p requeues 35165 
  maxpacket 1514 drop_overlimit 0 new_flow_count 22111 ecn_mark 0
  new_flows_len 0 old_flows_len 0
"
442,Dave Täht,2014-04-08 18:19:25.382846,"And this time, we are stopped at 12, which is also what qlen_be is set to

root@cerowrt:/sys/kernel/debug/ieee80211/phy1/ath9k# cat queues 
(VO):  qnum: 0 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(VI):  qnum: 1 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(BE):  qnum: 2 qdepth:  0 ampdu-depth:  0 pending:  12 stopped: 1
(BK):  qnum: 3 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(CAB): qnum: 8 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
"
442,David Taht,2014-04-09 14:41:32.266896,"See also: http://www.bufferbloat.net/issues/442#note-16

1) It's still uncertain that we have only been dealing with one wireless bug...

...but we can narrow down the jg was seeing to if - after a failure
happens and you can login on another radio or via ethernet - if you
see frames ""pending"", that stay pending, in
the ""queues"" debug file:

root@comcast-gw:~# cat /sys/kernel/debug/ieee80211/phy*/ath9k/queues

(VO):  qnum: 0 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(VI):  qnum: 1 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(BE):  qnum: 2 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(BK):  qnum: 3 qdepth:  0 ampdu-depth:  0 pending:   151 stopped: 0
(CAB): qnum: 8 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(VO):  qnum: 0 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(VI):  qnum: 1 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(BE):  qnum: 2 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(BK):  qnum: 3 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(CAB): qnum: 8 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0

you've hit the bug.

Nothing short of a reboot will clear it, presently. Felix is looking into it.

In the interim there are two things you can do to make hitting it a
LOT more difficult,
at least so far, in testing 20+ hours we haven't hit it again

A) Stop reducing qlen_be, qlen_bk, qlen_vi, & qlen_vo.

comment out line 1977 of /usr/sbin/debloat

...

local function wireless(model)
   print(model)
   if WCALLBACKS[model] ~= nil then
      -- wireless_qlen() -- comment out this call
      return WCALLBACKS[model]()
   else
      usage(""AQM model not found"")
   end
   return nil
end

...

and reboot.

This will return the qlen's to very large values that are nearly
impossible to hit.

While this will have a negative effect on latency, it will improve
single station bandwidth somewhat, and make it much harder to hang the
queue. (I think/hope)

I will argue - at this point - it is better to have a slower box that
stays up for weeks than one that has core functionality crash after a
few hours or days.

Those of you that have been experiencing the wifi hangs, please make
this change,
and check in daily?

If anyone has a hang, please post the ath9 queues status as per above,
and tc -s qdisc output to bug 442.

B) Mash incoming diffserv traffic down to BE only.

I have some patches almost ready for sqm-scripts for this, partially tested.

I've pushed them to the ceropackages github repository for review and testing.

see commit log message here.

https://github.com/dtaht/ceropackages-3.10/commit/27eed160a67700caae85a4c8b3fff0eaa990cd27

I am pretty sure fixing only fix ""A"" is need for working around the bug here

- B might make bi-directional over-the-internet-through-wifi tests
work better in that the BE queue is used more often - but both hacks
are in place on the box we're testing."
442,David Taht,2014-04-09 14:42:20.126423,"---------- Forwarded message ----------
From: Dave Taht <dave.taht@gmail.com>
Date: Wed, Apr 9, 2014 at 2:41 PM
Subject: [Bug #442] Possible workaround for the wireless hangs
To: cerowrt@lists.bufferbloat.net


See also: http://www.bufferbloat.net/issues/442#note-16

1) It's still uncertain that we have only been dealing with one wireless bug...

...but we can narrow down the jg was seeing to if - after a failure
happens and you can login on another radio or via ethernet - if you
see frames ""pending"", that stay pending, in
the ""queues"" debug file:

root@comcast-gw:~# cat /sys/kernel/debug/ieee80211/phy*/ath9k/queues

(VO):  qnum: 0 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(VI):  qnum: 1 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(BE):  qnum: 2 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(BK):  qnum: 3 qdepth:  0 ampdu-depth:  0 pending:   151 stopped: 0
(CAB): qnum: 8 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(VO):  qnum: 0 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(VI):  qnum: 1 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(BE):  qnum: 2 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(BK):  qnum: 3 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(CAB): qnum: 8 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0

you've hit the bug.

Nothing short of a reboot will clear it, presently. Felix is looking into it.

In the interim there are two things you can do to make hitting it a
LOT more difficult,
at least so far, in testing 20+ hours we haven't hit it again

A) Stop reducing qlen_be, qlen_bk, qlen_vi, & qlen_vo.

comment out line 1977 of /usr/sbin/debloat

...

local function wireless(model)
   print(model)
   if WCALLBACKS[model] ~= nil then
      -- wireless_qlen() -- comment out this call
      return WCALLBACKS[model]()
   else
      usage(""AQM model not found"")
   end
   return nil
end

...

and reboot.

This will return the qlen's to very large values that are nearly
impossible to hit.

While this will have a negative effect on latency, it will improve
single station bandwidth somewhat, and make it much harder to hang the
queue. (I think/hope)

I will argue - at this point - it is better to have a slower box that
stays up for weeks than one that has core functionality crash after a
few hours or days.

Those of you that have been experiencing the wifi hangs, please make
this change,
and check in daily?

If anyone has a hang, please post the ath9 queues status as per above,
and tc -s qdisc output to bug 442.

B) Mash incoming diffserv traffic down to BE only.

I have some patches almost ready for sqm-scripts for this, partially tested.

I've pushed them to the ceropackages github repository for review and testing.

see commit log message here.

https://github.com/dtaht/ceropackages-3.10/commit/27eed160a67700caae85a4c8b3fff0eaa990cd27

I am pretty sure fixing only fix ""A"" is need for working around the bug here

- B might make bi-directional over-the-internet-through-wifi tests
work better in that the BE queue is used more often - but both hacks
are in place on the box we're testing."
442,David Taht,2014-04-11 11:28:48.492047,"I think jim hits it soonest (this time in 36 hours) because he has a
family of geeks and A 100Mbit connection from the internet. Now that
the debloat script is changed to not muck with the defaults, this
definitely looks like a bug upstream in the linux kernel.

I also note that I *thought* I'd squashed dscp to BE in the 3.10.36-4
SQM simplest.qos AND simple.qos code, but was very tired that day and
probably missed something. Not that that helps - we managed to lock up
the BE queue last time too.

I don't know if the number of stations matter or the number of macs
matter, or not. I will start even longer generation tests with more
stations as soon as I can, but I'm kind of wiped out right now.

---------- Forwarded message ----------
From: Jim Gettys <jg@freedesktop.org>
Date: Fri, Apr 11, 2014 at 11:20 AM
Subject: Re: [Cerowrt-devel] cerowrt-3.10.36-4 released
To: Dave Taht <dave.taht@gmail.com>


Unfortunately, the bug has recurred after a day and a half.

root@cerowrt:/sys/kernel/debug/ieee80211/phy0/ath9k# cat queues
(VO):  qnum: 0 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(VI):  qnum: 1 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(BE):  qnum: 2 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(BK):  qnum: 3 qdepth:  0 ampdu-depth:  0 pending: 278 stopped: 1
(CAB): qnum: 8 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0"
442,David Taht,2014-04-14 16:08:04.831872,"So what we are seeing here is some sort of problem with accounting
for pending_frames on a given queue. And since we've had a reminder
of how useful code review can be - and I'd rather like to understand
this logic anyway -

// my comments in //

/* Upon failure caller should free skb */
int ath_tx_start(struct ieee80211_hw *hw, struct sk_buff *skb,
                 struct ath_tx_control *txctl)
{
        struct ieee80211_hdr *hdr;
        struct ieee80211_tx_info *info = IEEE80211_SKB_CB(skb);
        struct ieee80211_sta *sta = txctl->sta;
        struct ieee80211_vif *vif = info->control.vif;
        struct ath_softc *sc = hw->priv;
        struct ath_txq *txq = txctl->txq;
        struct ath_atx_tid *tid = NULL;
        struct ath_buf *bf;
        int q;
        int ret;

        ret = ath_tx_prepare(hw, skb, txctl);
        if (ret)
            return ret;

        hdr = (struct ieee80211_hdr *) skb->data;
        /*
         * At this point, the vif, hw_key and sta pointers in the tx control
         * info are no longer valid (overwritten by the ath_frame_info data.
         */


// I haven't looked at what skb_get_queue_mapping can return yet

       q = skb_get_queue_mapping(skb);

        ath_txq_lock(sc, txq);
        if (txq == sc->tx.txq_map[q] &&
            ++txq->pending_frames > sc->tx.txq_max_pending[q] &&
            !txq->stopped) {
                ieee80211_stop_queue(sc->hw, q);
                txq->stopped = true;

// is there a difference between stopped and sleeping?

        }

// So if the queue is not mapped properly we don't increment pending
// frames. Also we are dependent on C processing the if left to right,
// which is a  good assumption, but it leaves the ++txq as a side effect

        if (txctl->an && ieee80211_is_data_present(hdr->frame_control))
                tid = ath_get_skb_tid(sc, txctl->an, skb);

        if (info->flags & IEEE80211_TX_CTL_PS_RESPONSE) {
                ath_txq_unlock(sc, txq);
                txq = sc->tx.uapsdq;

// So here we have a bit of state that changes after we've got some pending
// state above that's been changed. I imagine this lock could stay unlocked
// for a while and lead to races elsewhere.
// haven't a clue what tx.uapsdq is

                ath_txq_lock(sc, txq);
        } else if (txctl->an &&
                   ieee80211_is_data_present(hdr->frame_control)) {
                WARN_ON(tid->ac->txq != txctl->txq);

                if (info->flags & IEEE80211_TX_CTL_CLEAR_PS_FILT)
                        tid->ac->clear_ps_filter = true;

                /*
                 * Add this frame to software queue for scheduling later
                 * for aggregation.
                 */
                TX_STAT_INC(txq->axq_qnum, a_queued_sw);
                __skb_queue_tail(&tid->buf_q, skb);
                if (!txctl->an->sleeping)
                        ath_tx_queue_tid(txq, tid);
// so if we're not sleeping, queue it up
// and regardless if we're sleeping or not, schedule it
                ath_txq_schedule(sc, txq);
                goto out;
        }

// So if data is not present OR txctl->an is invalid OR
IEEE80211_TX_CTL_PS_RESPONSE is set in flags
/// we fall through to here.

       bf = ath_tx_setup_buffer(sc, txq, tid, skb);

// if we fell through to here, tid can be null unless data was present

        if (!bf) {
                ath_txq_skb_done(sc, txq, skb);
                if (txctl->paprd)
                        dev_kfree_skb_any(skb);
                else
                        ieee80211_free_txskb(sc->hw, skb);
                goto out;
        }

// Well, I note that we incremented the frames earlier in some cases
// should they be decremented above?

        bf->bf_state.bfs_paprd = txctl->paprd;

        if (txctl->paprd)
                bf->bf_state.bfs_paprd_timestamp = jiffies;

        ath_set_rates(vif, sta, bf);
        ath_tx_send_normal(sc, txq, tid, skb);

// Not clear as to why you set_rates here, and I assume tx_send_normal
// sends a non-aggregate

out:
        ath_txq_unlock(sc, txq);

        return 0;
}"
422,David Taht,2014-04-14 21:06:32.574552,"regrettably I am too wiped to look this over further right now, but the patchset
seems very promising.

I will review on a fresh brain in the morning. Other eyeballs desired
- this will have to get patched on top of 3.14 and then backported to
the 3.10 backport....

---------- Forwarded message ----------
From: Ben Greear <greearb@candelatech.com>
Date: Mon, Apr 14, 2014 at 8:49 PM
Subject: Re: [ath9k-devel] ath9k queue hang
To: Dave Taht <dave.taht@gmail.com>, ""ath9k-devel@lists.ath9k.org""
<ath9k-devel@venema.h4ckr.net>


On 04/14/2014 07:16 PM, Dave Taht wrote:
>
> We have been trying to replicate a bug in seeing wifi connections hanging
> in strange ways after tons of data is transferred... for several months now.
>
> The symptoms varied, anything from multicast failing to background or best
> effort traffic failing - from local access working with remote access
> not working...
>
> Last week, we finally got a situation where we had enough debugging on to see
> something that matches the symptoms we saw, in that one of the wifi queues
> would hang and leave the overlying qdisc full of packets that didn't drain.


Sounds familiar...I had a relatively clean patch in the 3.9 days, but had some
issues merging along the way and haven't bothered to rebase it, so patch is
not as clean as it used to be:

http://dmz2.candelatech.com/git/?p=linux-3.14.dev.y/.git;a=commitdiff;h=a34e34f46fbffc627dfc2d93c508f580fbaf29e2;hp=cce0d841338348c69ae6f7ef1b2bc8a6abea3fc4
http://dmz2.candelatech.com/git/?p=linux-3.14.dev.y/.git;a=commitdiff;h=3ecefa9c9f7eed21002dad7a6540d6d250297466;hp=134543c6fec7e28bf91272ce995b550b1bf73c62

I posted the patch to the mailing lists some time back..maybe a year or two ago.

If I recall, we could reproduce our problem fairly reliably by
stepping an attenuator
in 10 db steps while under load.

I'd be curious to know if you try it out and it works for you...

Thanks,
Ben"
442,David Taht,2014-04-14 21:09:07.934107,"---------- Forwarded message ----------
From: Ben Greear <greearb@candelatech.com>
Date: Mon, Apr 14, 2014 at 8:49 PM
Subject: Re: [ath9k-devel] ath9k queue hang
To: Dave Taht <dave.taht@gmail.com>, ""ath9k-devel@lists.ath9k.org""
<ath9k-devel@venema.h4ckr.net>


On 04/14/2014 07:16 PM, Dave Taht wrote:
>
> We have been trying to replicate a bug in seeing wifi connections hanging
> in strange ways after tons of data is transferred... for several months now.
>
> The symptoms varied, anything from multicast failing to background or best
> effort traffic failing - from local access working with remote access
> not working...
>
> Last week, we finally got a situation where we had enough debugging on to see
> something that matches the symptoms we saw, in that one of the wifi queues
> would hang and leave the overlying qdisc full of packets that didn't drain.


Sounds familiar...I had a relatively clean patch in the 3.9 days, but had some
issues merging along the way and haven't bothered to rebase it, so patch is
not as clean as it used to be:

http://dmz2.candelatech.com/git/?p=linux-3.14.dev.y/.git;a=commitdiff;h=a34e34f46fbffc627dfc2d93c508f580fbaf29e2;hp=cce0d841338348c69ae6f7ef1b2bc8a6abea3fc4
http://dmz2.candelatech.com/git/?p=linux-3.14.dev.y/.git;a=commitdiff;h=3ecefa9c9f7eed21002dad7a6540d6d250297466;hp=134543c6fec7e28bf91272ce995b550b1bf73c62

I posted the patch to the mailing lists some time back..maybe a year or two ago.

If I recall, we could reproduce our problem fairly reliably by
stepping an attenuator
in 10 db steps while under load.

I'd be curious to know if you try it out and it works for you...

Thanks,
Ben"
422,Felix Fietkau,2014-04-15 11:47:01.270996,"On 2014-04-15 06:06, Dave Taht wrote:
> regrettably I am too wiped to look this over further right now, but the patchset
> seems very promising.
> 
> I will review on a fresh brain in the morning. Other eyeballs desired
> - this will have to get patched on top of 3.14 and then backported to
> the 3.10 backport....
The patch is a rather crude workaround which unfortunately will not
help with narrowing down the cause. Also, doing a chip reset because a
software queue is stuck is overkill.

Please test if this patch helps. The tid->paused flag is no longer
necessary since my rework of the tx path.
---
--- a/drivers/net/wireless/ath/ath9k/ath9k.h
+++ b/drivers/net/wireless/ath/ath9k/ath9k.h
@@ -254,7 +254,6 @@ struct ath_atx_tid {
 
 	s8 bar_index;
 	bool sched;
-	bool paused;
 	bool active;
 };
 
--- a/drivers/net/wireless/ath/ath9k/xmit.c
+++ b/drivers/net/wireless/ath/ath9k/xmit.c
@@ -107,9 +107,6 @@ static void ath_tx_queue_tid(struct ath_
 {
 	struct ath_atx_ac *ac = tid->ac;
 
-	if (tid->paused)
-		return;
-
 	if (tid->sched)
 		return;
 
@@ -1407,7 +1404,6 @@ int ath_tx_aggr_start(struct ath_softc *
 	ath_tx_tid_change_state(sc, txtid);
 
 	txtid->active = true;
-	txtid->paused = true;
 	*ssn = txtid->seq_start = txtid->seq_next;
 	txtid->bar_index = -1;
 
@@ -1427,7 +1423,6 @@ void ath_tx_aggr_stop(struct ath_softc *
 
 	ath_txq_lock(sc, txq);
 	txtid->active = false;
-	txtid->paused = false;
 	ath_tx_flush_tid(sc, txtid);
 	ath_tx_tid_change_state(sc, txtid);
 	ath_txq_unlock_complete(sc, txq);
@@ -1487,7 +1482,7 @@ void ath_tx_aggr_wakeup(struct ath_softc
 		ath_txq_lock(sc, txq);
 		ac->clear_ps_filter = true;
 
-		if (!tid->paused && ath_tid_has_buffered(tid)) {
+		if (ath_tid_has_buffered(tid)) {
 			ath_tx_queue_tid(txq, tid);
 			ath_txq_schedule(sc, txq);
 		}
@@ -1510,7 +1505,6 @@ void ath_tx_aggr_resume(struct ath_softc
 	ath_txq_lock(sc, txq);
 
 	tid->baw_size = IEEE80211_MIN_AMPDU_BUF << sta->ht_cap.ampdu_factor;
-	tid->paused = false;
 
 	if (ath_tid_has_buffered(tid)) {
 		ath_tx_queue_tid(txq, tid);
@@ -1544,8 +1538,6 @@ void ath9k_release_buffered_frames(struc
 			continue;
 
 		tid = ATH_AN_2_TID(an, i);
-		if (tid->paused)
-			continue;
 
 		ath_txq_lock(sc, tid->ac->txq);
 		while (nframes > 0) {
@@ -1844,9 +1836,6 @@ void ath_txq_schedule(struct ath_softc *
 			list_del(&tid->list);
 			tid->sched = false;
 
-			if (tid->paused)
-				continue;
-
 			if (ath_tx_sched_aggr(sc, txq, tid, &stop))
 				sent = true;
 
@@ -2698,7 +2687,6 @@ void ath_tx_node_init(struct ath_softc *
 		tid->baw_size  = WME_MAX_BA;
 		tid->baw_head  = tid->baw_tail = 0;
 		tid->sched     = false;
-		tid->paused    = false;
 		tid->active	   = false;
 		__skb_queue_head_init(&tid->buf_q);
 		__skb_queue_head_init(&tid->retry_q);"
442,David Taht,2014-04-15 11:51:06.463986,"This ended up on the wrong bug.

On Tue, Apr 15, 2014 at 11:47 AM,  <cerowrt@lists.bufferbloat.net> wrote:
>
> Issue #422 has been updated by Felix Fietkau.
>
>
> On 2014-04-15 06:06, Dave Taht wrote:
>> regrettably I am too wiped to look this over further right now, but the patchset
>> seems very promising.
>>
>> I will review on a fresh brain in the morning. Other eyeballs desired
>> - this will have to get patched on top of 3.14 and then backported to
>> the 3.10 backport....
> The patch is a rather crude workaround which unfortunately will not
> help with narrowing down the cause. Also, doing a chip reset because a
> software queue is stuck is overkill.
>
> Please test if this patch helps. The tid->paused flag is no longer
> necessary since my rework of the tx path.
> ---
> --- a/drivers/net/wireless/ath/ath9k/ath9k.h
> +++ b/drivers/net/wireless/ath/ath9k/ath9k.h
> @@ -254,7 +254,6 @@ struct ath_atx_tid {
>
>         s8 bar_index;
>         bool sched;
> -       bool paused;
>         bool active;
>  };
>
> --- a/drivers/net/wireless/ath/ath9k/xmit.c
> +++ b/drivers/net/wireless/ath/ath9k/xmit.c
> @@ -107,9 +107,6 @@ static void ath_tx_queue_tid(struct ath_
>  {
>         struct ath_atx_ac *ac = tid->ac;
>
> -       if (tid->paused)
> -               return;
> -
>         if (tid->sched)
>                 return;
>
> @@ -1407,7 +1404,6 @@ int ath_tx_aggr_start(struct ath_softc *
>         ath_tx_tid_change_state(sc, txtid);
>
>         txtid->active = true;
> -       txtid->paused = true;
>         *ssn = txtid->seq_start = txtid->seq_next;
>         txtid->bar_index = -1;
>
> @@ -1427,7 +1423,6 @@ void ath_tx_aggr_stop(struct ath_softc *
>
>         ath_txq_lock(sc, txq);
>         txtid->active = false;
> -       txtid->paused = false;
>         ath_tx_flush_tid(sc, txtid);
>         ath_tx_tid_change_state(sc, txtid);
>         ath_txq_unlock_complete(sc, txq);
> @@ -1487,7 +1482,7 @@ void ath_tx_aggr_wakeup(struct ath_softc
>                 ath_txq_lock(sc, txq);
>                 ac->clear_ps_filter = true;
>
> -               if (!tid->paused && ath_tid_has_buffered(tid)) {
> +               if (ath_tid_has_buffered(tid)) {
>                         ath_tx_queue_tid(txq, tid);
>                         ath_txq_schedule(sc, txq);
>                 }
> @@ -1510,7 +1505,6 @@ void ath_tx_aggr_resume(struct ath_softc
>         ath_txq_lock(sc, txq);
>
>         tid->baw_size = IEEE80211_MIN_AMPDU_BUF << sta->ht_cap.ampdu_factor;
> -       tid->paused = false;
>
>         if (ath_tid_has_buffered(tid)) {
>                 ath_tx_queue_tid(txq, tid);
> @@ -1544,8 +1538,6 @@ void ath9k_release_buffered_frames(struc
>                         continue;
>
>                 tid = ATH_AN_2_TID(an, i);
> -               if (tid->paused)
> -                       continue;
>
>                 ath_txq_lock(sc, tid->ac->txq);
>                 while (nframes > 0) {
> @@ -1844,9 +1836,6 @@ void ath_txq_schedule(struct ath_softc *
>                         list_del(&tid->list);
>                         tid->sched = false;
>
> -                       if (tid->paused)
> -                               continue;
> -
>                         if (ath_tx_sched_aggr(sc, txq, tid, &stop))
>                                 sent = true;
>
> @@ -2698,7 +2687,6 @@ void ath_tx_node_init(struct ath_softc *
>                 tid->baw_size  = WME_MAX_BA;
>                 tid->baw_head  = tid->baw_tail = 0;
>                 tid->sched     = false;
> -               tid->paused    = false;
>                 tid->active        = false;
>                 __skb_queue_head_init(&tid->buf_q);
>                 __skb_queue_head_init(&tid->retry_q);
> ----------------------------------------
> Bug #422: some dhcpv6 debugging
> https://www.bufferbloat.net/issues/422
>
> Author: David Taht
> Status: Closed
> Priority: Normal
> Assignee:
> Category:
> Target version:
>
>
> 1) dhvp6 stuff
>
>
> The failing command is this one.
>
>
> ubus call network.interface. notify_proto '{ ""action"": 0, ""link-up"": true,
> ""keep"": false, ""ip6prefix"": [ ""2001:db8:0:f00::\/56,375,600"" ], ""dns"": [
> ""fec0:0:0:1::1"" ], ""dns_
>
> search"": [ ""domain.example"" ] }'
>
>
> When it should be like this
>
>
> ubus call network.interface.ge00 notify_proto '{ ""action"": 0, ""link-up"":
> true, ""keep"": false, ""ip6prefix"": [ ""2001:db8:0:f00::\/56,375,600"" ],
> ""dns"": [ ""fec0:0:0:1::1"" ], ""dns_
>
> search"": [ ""domain.example"" ] }'
>
>
>
> So it appears that you try to call $INTERFACE where in setup_interface,
> it's actually ""$device""…
>
>
> except that when I made that change, I still had nothing right
>
>
> however, when I called this with two args rather than one...
>
>
> odhcp6c -N try -P 60 -s /lib/netifd/dhcpv6.script  ge00 ge00 &
>
>
> it did find ge00… and did the automagic prefix assignment to the other
> interfaces...
>
>
> so there's an off-by-one error somewhere… (and odhcp6c doesn't start,
> regardless)
>
> it fails also on exit also lacking that interface param
>
> + ubus call network.interface. notify_proto { ""action"": 0, ""link-up"":
> false, ""keep"": false }
>
> Elsewhere /lib/netifd/proto/dhcpv6.sh $INTERFACE and $config seem to be
> confused
>
>  proto_export ""INTERFACE=$config""
>
> and that STILL didn't fix it.
>
> hope this helps.
>
> My files
>
> 6relayd:
>
> config server default
>         option master   ge01 # tried ge00 too
>         list network    lan # tried the alias for the firewall as well as
> the actual devices and/or this not at all
>         list network    se00
>         list network    sw00
>         list network    sw10
>         list network    gw00
>         list network    guest # same crazy idea
>         option rd       server
>         option dhcpv6   server
>         option fallback_relay   'rd dhcpv6 ndp'
>
> network
>
> config interface se00
>         option 'ifname' 'se00'
>         option 'proto'  'static'
>         option 'ipaddr' '172.26.34.1'
>         option 'netmask'        '255.255.255.224'
>         option 'ip6assign' '64'
>
> config interface ge00
>         option 'ifname' 'ge00'
>         option 'proto'  'dhcp'
>
> config interface ge01
>         option ifname   @ge00
>         option proto    dhcpv6
>         option 'broadcast' '1'
>         option 'metric' '2048'
>         option 'reqprefix' '60'
>
> (the reason for the metric is that I let babel assign default gws)
>
> 2) in going through the env variables trying to figure out the ""next prefix
> available"" in the /etc/odhcp6c.user there's no rollup list somewhere of the
> prefixes actually assigned to the pool of interfaces. Am trying to come up
> with the ""right"" way to integrate ahcp's /128 concept
>
> 3) there doesn't seem to be anything stopping you from running multiple
> copies of odhcpd
>
> 4) No ntp server support. My other assumption is that things like wins are
> common too, and I also use wpad...
>
>"
442,David Taht,2014-04-15 12:00:35.481901,"Thx felix!

Given that there seems to be a potential race in the code
review I did at:

http://www.bufferbloat.net/issues/442#note-22

another thought is to make the increment and decrement of

txq->pending_frame atomic, or to do a flush before the unlock

What tree is this patch against?

On Tue, Apr 15, 2014 at 11:46 AM, Felix Fietkau <nbd@openwrt.org> wrote:
> On 2014-04-15 06:06, Dave Taht wrote:
>> regrettably I am too wiped to look this over further right now, but the patchset
>> seems very promising.
>>
>> I will review on a fresh brain in the morning. Other eyeballs desired
>> - this will have to get patched on top of 3.14 and then backported to
>> the 3.10 backport....
> The patch is a rather crude workaround which unfortunately will not
> help with narrowing down the cause. Also, doing a chip reset because a
> software queue is stuck is overkill.
>
> Please test if this patch helps. The tid->paused flag is no longer
> necessary since my rework of the tx path.
> ---
> --- a/drivers/net/wireless/ath/ath9k/ath9k.h
> +++ b/drivers/net/wireless/ath/ath9k/ath9k.h
> @@ -254,7 +254,6 @@ struct ath_atx_tid {
>
>         s8 bar_index;
>         bool sched;
> -       bool paused;
>         bool active;
>  };
>
> --- a/drivers/net/wireless/ath/ath9k/xmit.c
> +++ b/drivers/net/wireless/ath/ath9k/xmit.c
> @@ -107,9 +107,6 @@ static void ath_tx_queue_tid(struct ath_
>  {
>         struct ath_atx_ac *ac = tid->ac;
>
> -       if (tid->paused)
> -               return;
> -
>         if (tid->sched)
>                 return;
>
> @@ -1407,7 +1404,6 @@ int ath_tx_aggr_start(struct ath_softc *
>         ath_tx_tid_change_state(sc, txtid);
>
>         txtid->active = true;
> -       txtid->paused = true;
>         *ssn = txtid->seq_start = txtid->seq_next;
>         txtid->bar_index = -1;
>
> @@ -1427,7 +1423,6 @@ void ath_tx_aggr_stop(struct ath_softc *
>
>         ath_txq_lock(sc, txq);
>         txtid->active = false;
> -       txtid->paused = false;
>         ath_tx_flush_tid(sc, txtid);
>         ath_tx_tid_change_state(sc, txtid);
>         ath_txq_unlock_complete(sc, txq);
> @@ -1487,7 +1482,7 @@ void ath_tx_aggr_wakeup(struct ath_softc
>                 ath_txq_lock(sc, txq);
>                 ac->clear_ps_filter = true;
>
> -               if (!tid->paused && ath_tid_has_buffered(tid)) {
> +               if (ath_tid_has_buffered(tid)) {
>                         ath_tx_queue_tid(txq, tid);
>                         ath_txq_schedule(sc, txq);
>                 }
> @@ -1510,7 +1505,6 @@ void ath_tx_aggr_resume(struct ath_softc
>         ath_txq_lock(sc, txq);
>
>         tid->baw_size = IEEE80211_MIN_AMPDU_BUF << sta->ht_cap.ampdu_factor;
> -       tid->paused = false;
>
>         if (ath_tid_has_buffered(tid)) {
>                 ath_tx_queue_tid(txq, tid);
> @@ -1544,8 +1538,6 @@ void ath9k_release_buffered_frames(struc
>                         continue;
>
>                 tid = ATH_AN_2_TID(an, i);
> -               if (tid->paused)
> -                       continue;
>
>                 ath_txq_lock(sc, tid->ac->txq);
>                 while (nframes > 0) {
> @@ -1844,9 +1836,6 @@ void ath_txq_schedule(struct ath_softc *
>                         list_del(&tid->list);
>                         tid->sched = false;
>
> -                       if (tid->paused)
> -                               continue;
> -
>                         if (ath_tx_sched_aggr(sc, txq, tid, &stop))
>                                 sent = true;
>
> @@ -2698,7 +2687,6 @@ void ath_tx_node_init(struct ath_softc *
>                 tid->baw_size  = WME_MAX_BA;
>                 tid->baw_head  = tid->baw_tail = 0;
>                 tid->sched     = false;
> -               tid->paused    = false;
>                 tid->active        = false;
>                 __skb_queue_head_init(&tid->buf_q);
>                 __skb_queue_head_init(&tid->retry_q);
>"
442,Felix Fietkau,2014-04-16 06:11:18.512687,"On 2014-04-15 21:00, Dave Taht wrote:
> Thx felix!
> 
> Given that there seems to be a potential race in the code
> review I did at:
> 
> http://www.bufferbloat.net/issues/442#note-22
> 
> another thought is to make the increment and decrement of
> 
> txq->pending_frame atomic, or to do a flush before the unlock
I'm not convinced that there's a race that involves txq->pending_frames.
There is no need to make the increment/decrement atomic, because that
variable is already protected by the txq lock.

> What tree is this patch against?
mac80211 from OpenWrt trunk.

- Felix"
442,David Taht,2014-04-16 08:34:20.594121,"On Wed, Apr 16, 2014 at 6:11 AM, Felix Fietkau <nbd@openwrt.org> wrote:
> On 2014-04-15 21:00, Dave Taht wrote:
>> Thx felix!
>>
>> Given that there seems to be a potential race in the code
>> review I did at:
>>
>> http://www.bufferbloat.net/issues/442#note-22
>>
>> another thought is to make the increment and decrement of
>>
>> txq->pending_frame atomic, or to do a flush before the unlock
> I'm not convinced that there's a race that involves txq->pending_frames.
> There is no need to make the increment/decrement atomic, because that
> variable is already protected by the txq lock.

It and ""stopped"" are briefly unprotected along that code path.

>
>> What tree is this patch against?
> mac80211 from OpenWrt trunk.

Thx, will try your patch today.

> - Felix"
442,Felix Fietkau,2014-04-16 09:56:09.315898,"On 2014-04-16 17:34, Dave Taht wrote:
> On Wed, Apr 16, 2014 at 6:11 AM, Felix Fietkau <nbd@openwrt.org> wrote:
>> On 2014-04-15 21:00, Dave Taht wrote:
>>> Thx felix!
>>>
>>> Given that there seems to be a potential race in the code
>>> review I did at:
>>>
>>> http://www.bufferbloat.net/issues/442#note-22
>>>
>>> another thought is to make the increment and decrement of
>>>
>>> txq->pending_frame atomic, or to do a flush before the unlock
>> I'm not convinced that there's a race that involves txq->pending_frames.
>> There is no need to make the increment/decrement atomic, because that
>> variable is already protected by the txq lock.
> 
> It and ""stopped"" are briefly unprotected along that code path.
Where?

- Felix"
442,David Taht,2014-04-16 10:00:37.971543,"should I have said ""de-protected""? in

linux-3.14/drivers/net/wireless/ath/ath9k/xmit.c

        ath_txq_lock(sc, txq);
        if (txq == sc->tx.txq_map[q] &&
            ++txq->pending_frames > sc->tx.txq_max_pending[q] &&
            !txq->stopped) {
                ieee80211_stop_queue(sc->hw, q);
                txq->stopped = true;
        }

        if (txctl->an && ieee80211_is_data_present(hdr->frame_control))
                tid = ath_get_skb_tid(sc, txctl->an, skb);

        if (info->flags & IEEE80211_TX_CTL_PS_RESPONSE) {
                ath_txq_unlock(sc, txq);
                txq = sc->tx.uapsdq;
^^^^^^
                ath_txq_lock(sc, txq);
        } else if (txctl->an &&



On Wed, Apr 16, 2014 at 9:55 AM, Felix Fietkau <nbd@openwrt.org> wrote:
> On 2014-04-16 17:34, Dave Taht wrote:
>> On Wed, Apr 16, 2014 at 6:11 AM, Felix Fietkau <nbd@openwrt.org> wrote:
>>> On 2014-04-15 21:00, Dave Taht wrote:
>>>> Thx felix!
>>>>
>>>> Given that there seems to be a potential race in the code
>>>> review I did at:
>>>>
>>>> http://www.bufferbloat.net/issues/442#note-22
>>>>
>>>> another thought is to make the increment and decrement of
>>>>
>>>> txq->pending_frame atomic, or to do a flush before the unlock
>>> I'm not convinced that there's a race that involves txq->pending_frames.
>>> There is no need to make the increment/decrement atomic, because that
>>> variable is already protected by the txq lock.
>>
>> It and ""stopped"" are briefly unprotected along that code path.
> Where?
>
> - Felix"
442,David Taht,2014-04-18 20:26:16.417618,"Could part of it be as simple as not checking for '<='  but only < in
txq_max_pending below?

in ath_tx_start:

        ath_txq_lock(sc, txq);
        if (txq == sc->tx.txq_map[q] &&
            ++txq->pending_frames > sc->tx.txq_max_pending[q] &&
            !txq->stopped) {
                ieee80211_stop_queue(sc->hw, q);
                txq->stopped = true;
        }

in ath_txq_skb_done:

        if (txq->stopped &&
            txq->pending_frames < sc->tx.txq_max_pending[q]) {
                ieee80211_wake_queue(sc->hw, q);
                txq->stopped = false;
        }"
442,Felix Fietkau,2014-04-19 04:22:55.050336,"On 2014-04-19 05:26, Dave Taht wrote:
> Could part of it be as simple as not checking for '<='  but only < in
> txq_max_pending below?
I don't see how that would make any meaningful difference in practice.
By the way, did you test my patch?

> in ath_tx_start:
> 
>         ath_txq_lock(sc, txq);
>         if (txq == sc->tx.txq_map[q] &&
>             ++txq->pending_frames > sc->tx.txq_max_pending[q] &&
>             !txq->stopped) {
>                 ieee80211_stop_queue(sc->hw, q);
>                 txq->stopped = true;
>         }
> 
> in ath_txq_skb_done:
> 
>         if (txq->stopped &&
>             txq->pending_frames < sc->tx.txq_max_pending[q]) {
>                 ieee80211_wake_queue(sc->hw, q);
>                 txq->stopped = false;
>         }
> 
>"
442,David Taht,2014-04-19 11:00:43.178607,"On Sat, Apr 19, 2014 at 4:22 AM, Felix Fietkau <nbd@openwrt.org> wrote:
> On 2014-04-19 05:26, Dave Taht wrote:
>> Could part of it be as simple as not checking for '<='  but only < in
>> txq_max_pending below?
> I don't see how that would make any meaningful difference in practice.

Didn't think it would, still thought <= was more correct.

> By the way, did you test my patch?

It is in the as yet untested 3.10.36-6 build, along with resetting qlen
down to 12 again to try to trigger the bug sooner.

http://snapon.lab.bufferbloat.net/~cero2/cerowrt/wndr/3.10.36-6/


>
>> in ath_tx_start:
>>
>>         ath_txq_lock(sc, txq);
>>         if (txq == sc->tx.txq_map[q] &&
>>             ++txq->pending_frames > sc->tx.txq_max_pending[q] &&
>>             !txq->stopped) {
>>                 ieee80211_stop_queue(sc->hw, q);
>>                 txq->stopped = true;
>>         }
>>
>> in ath_txq_skb_done:
>>
>>         if (txq->stopped &&
>>             txq->pending_frames < sc->tx.txq_max_pending[q]) {
>>                 ieee80211_wake_queue(sc->hw, q);
>>                 txq->stopped = false;
>>         }
>>
>>
>"
442,Jim Gettys,2014-04-28 15:13:34.314109,"running 3.10.38-1.  2.4ghz hung.


root@cerowrt:~# cat /sys/kernel/debug/ieee80211/phy*/ath9k/queues 
(VO):  qnum: 0 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(VI):  qnum: 1 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(BE):  qnum: 2 qdepth:  0 ampdu-depth:  0 pending:  12 stopped: 1
(BK):  qnum: 3 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(CAB): qnum: 8 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(VO):  qnum: 0 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(VI):  qnum: 1 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(BE):  qnum: 2 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(BK):  qnum: 3 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(CAB): qnum: 8 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0"
442,David Taht,2014-04-28 15:18:52.391352,"---------- Forwarded message ----------
From: Jim Gettys <jg@freedesktop.org>
Date: Mon, Apr 28, 2014 at 3:10 PM
Subject: [Cerowrt-devel] [bug #442] unfortunately, not fixed.
To: ""cerowrt-devel@lists.bufferbloat.net"" <cerowrt-devel@lists.bufferbloat.net>


running 3.10.38-1.  2.4ghz hung.
                             - Jim


root@cerowrt:~# cat /sys/kernel/debug/ieee80211/phy*/ath9k/queues
(VO):  qnum: 0 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(VI):  qnum: 1 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(BE):  qnum: 2 qdepth:  0 ampdu-depth:  0 pending:  12 stopped: 1
(BK):  qnum: 3 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(CAB): qnum: 8 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(VO):  qnum: 0 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(VI):  qnum: 1 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(BE):  qnum: 2 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(BK):  qnum: 3 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(CAB): qnum: 8 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0


_______________________________________________
Cerowrt-devel mailing list
Cerowrt-devel@lists.bufferbloat.net
https://lists.bufferbloat.net/listinfo/cerowrt-devel"
442,Dave Täht,2014-05-14 10:07:33.805491,"I have been trying to find more ways to tweak this bug faster. 

Felix, the patch you'd given me to try - did that make it upstream? it stopped applying to my code and I'd dropped it, can try to update it... but I'm seeing signs it's higher in the stack.

Last night I downloaded and installed openwrt head onto an archer C7 v2 platform, and in about 4 hours got the BK and VI queues to fail using the rrul test, on a WPA2 psk misc enabled system, no fiddling with qlens. The BE queue is fine. So, now I've pretty much ruled out cerowrt's hardware, and build, as the cause of the problem, and it seems like it is universal to the ath9k and/or openwrt. Some of what I see here might mean it's not an ath9k problem either! 

DISTRIB_ID=""OpenWrt""
DISTRIB_RELEASE=""Bleeding Edge""
DISTRIB_REVISION=""r40755""
DISTRIB_CODENAME=""barrier_breaker""
DISTRIB_TARGET=""ar71xx/generic""
DISTRIB_DESCRIPTION=""OpenWrt Barrier Breaker r40755""
DISTRIB_TAINTS=""""

I've finally got enough hardware up and the monitoring interface figured out enough to capture and decrypt packets in the air, but didn't do that last night.

Anyway, this failure looks like this - BK queue is hosed, BE is not, netperf negotiates a connection, then netperf flips the tos bit and no data comes through:

d@ida:~/public_html/archer/overnight$ netperf -Y CS1,CS1 -H 172.21.0.1
MIGRATED TCP STREAM TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 172.21.0.1 () port 0 AF_INET : demo
Recv   Send    Send                          
Socket Socket  Message  Elapsed              
Size   Size    Size     Time     Throughput  
bytes  bytes   bytes    secs.    10^6bits/sec  

 87380  16384  16384    10.00       0.00   


To get here I ran the rrul test over and over (which exercises each queue using CS0, CS1, CS5, and EF markings. ) the data files are in http://snapon.lab.bufferbloat.net/~d/archer/overnight 

http://snapon.lab.bufferbloat.net/~d/archer/overnight/normality.png # random sample from earlier in the night

http://snapon.lab.bufferbloat.net/~d/archer/overnight/normality2.png # shortly before it went boom

http://snapon.lab.bufferbloat.net/~d/archer/overnight/bye_vi_vo_queue.png # vi and vo go away

http://snapon.lab.bufferbloat.net/~d/archer/overnight/bye_bk_queue.png # bk queue goes away too

It is kind of interesting that the failures started happening just as people were waking up and getting on the internet (6am), so I will return to testing with more interference on the link....

There is no info in queues
<pre>
root@OpenWrt:/sys/kernel/debug/ieee80211/phy1/ath9k# cat queues
(VO):  qnum: 0 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(VI):  qnum: 1 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(BE):  qnum: 2 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(BK):  qnum: 3 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
(CAB): qnum: 8 qdepth:  0 ampdu-depth:  0 pending:   0 stopped: 0
</pre>

These failures failed long before the failure:

<pre>

[  593.440000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[  635.940000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[  648.130000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[ 1188.800000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[ 1626.470000] ath: phy1: Failed to stop TX DMA, queues=0x00e!
[ 1748.010000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[ 1766.240000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[ 2909.640000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[ 3104.710000] ath: phy1: Failed to stop TX DMA, queues=0x004!
[ 3431.860000] Failed to load ipt action
[ 3431.950000] netem: version 1.3
[ 3555.790000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[ 3561.930000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[ 3586.300000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[ 3671.600000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[ 3756.900000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[ 3817.930000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[ 4189.750000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[ 4201.940000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[ 4909.110000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[ 4933.480000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[ 4939.520000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[ 5037.110000] ath: phy1: Failed to stop TX DMA, queues=0x004!
[ 5915.000000] ath: phy1: Failed to stop TX DMA, queues=0x00d!
[ 6152.780000] ath: phy1: Failed to stop TX DMA, queues=0x00f!
[ 6644.290000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[ 6668.560000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[ 6729.280000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[ 6735.420000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[ 6923.430000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[ 7882.410000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[ 8908.970000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[ 8921.060000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[ 9036.560000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[ 9097.290000] ath: phy1: Failed to stop TX DMA, queues=0x005!
[31969.060000] ath: phy1: Failed to stop TX DMA, queues=0x005!
</pre>

Trying to send anything marked CS1. You'd think it would be trying, but
aggregates or tx bytes don't budge.

<pre>

root@OpenWrt:/sys/kernel/debug/ieee80211/phy1/ath9k# cat xmit 
                            BE         BK        VI        VO

MPDUs Queued:                5          0      1042     24803
MPDUs Completed:          1541       2153      4316     40355
MPDUs XRetried:              1          2        33        60
Aggregates:            2309316      80520   1015730         0
AMPDUs Queued HW:            0          0         0         0
AMPDUs Queued SW:     53325311     637157  18719054     15612
AMPDUs Completed:     53323234     634851  18696242         0
AMPDUs Retried:         823483      14659    556819         0
AMPDUs XRetried:           524        151     19404         0
TXERR Filtered:            189         42       239         2
FIFO Underrun:               0          0         0         1
TXOP Exceeded:               0          0         0         0
TXTIMER Expiry:              0          0         0         0
DESC CFG Error:              0          0         0         0
DATA Underrun:               0          0         0         0
DELIM Underrun:              0          0         0         0
TX-Pkts-All:          53325300     637157  18719995     40415
TX-Bytes-All:        270739492  1785710593602584059   6533793
HW-put-tx-buf:         3442803     225830   1447392     40415
HW-tx-start:                 0          0         0         0
HW-tx-proc-desc:       3441390     224351   1446571     40329
TX-Failed:                   0          0         0         0
root@OpenWrt:/sys/kernel/debug/ieee80211/phy1/ath9k# killall netserver
root@OpenWrt:/sys/kernel/debug/ieee80211/phy1/ath9k# netserver
Starting netserver with host 'IN(6)ADDR_ANY' port '12865' and family AF_UNSPEC
root@OpenWrt:/sys/kernel/debug/ieee80211/phy1/ath9k# cat xmit 
                            BE         BK        VI        VO

MPDUs Queued:                5          0      1042     24868
MPDUs Completed:          1541       2153      4316     40421
MPDUs XRetried:              1          2        33        60
Aggregates:            2309316      80520   1015730         0
AMPDUs Queued HW:            0          0         0         0
AMPDUs Queued SW:     53325413     637157  18719054     15613
AMPDUs Completed:     53323336     634851  18696242         0
AMPDUs Retried:         823483      14659    556819         0
AMPDUs XRetried:           524        151     19404         0
TXERR Filtered:            189         42       239         2
FIFO Underrun:               0          0         0         1
TXOP Exceeded:               0          0         0         0
TXTIMER Expiry:              0          0         0         0
DESC CFG Error:              0          0         0         0
DATA Underrun:               0          0         0         0
DELIM Underrun:              0          0         0         0
TX-Pkts-All:          53325402     637157  18719995     40481
TX-Bytes-All:        270762029  1785710593602584059   6547198
HW-put-tx-buf:         3442905     225830   1447392     40481
HW-tx-start:                 0          0         0         0
HW-tx-proc-desc:       3441492     224351   1446571     40395
TX-Failed:                   0          0         0         0

</pre>

And we don't show any packets attempting to enter the bk queue (1:4)
either. (same test as above). Deleting and recreating the qdisc 
doesn't work either. 

(I note that I am trying huge targets and intervals with some success with the
longer qlens....) 
<pre>
root@OpenWrt:/sys/kernel/debug/ieee80211/phy1/ath9k# tc -s qdisc show dev wlan1
qdisc mq 1: root 
 Sent 42609841871 bytes 63704518 pkt (dropped 123636, overlimits 0 requeues 291608) 
 backlog 0b 0p requeues 291608 
qdisc fq_codel 803d: parent 1:1 limit 1024p flows 1024 quantum 1514 target 30.0ms interval 300.0ms 
 Sent 1044525 bytes 15565 pkt (dropped 0, overlimits 0 requeues 408) 
 backlog 0b 0p requeues 408 
  maxpacket 256 drop_overlimit 0 new_flow_count 201 ecn_mark 0
  new_flows_len 0 old_flows_len 0
qdisc fq_codel 803e: parent 1:2 limit 1024p flows 1024 quantum 1514 target 30.0ms interval 300.0ms ecn 
 Sent 10914015954 bytes 17822230 pkt (dropped 15479, overlimits 0 requeues 77502) 
 backlog 0b 0p requeues 77502 
  maxpacket 1514 drop_overlimit 0 new_flow_count 223799 ecn_mark 0
  new_flows_len 0 old_flows_len 0
qdisc fq_codel 803f: parent 1:3 limit 1024p flows 1024 quantum 1514 target 30.0ms interval 300.0ms ecn 
 Sent 31540575052 bytes 45257237 pkt (dropped 108091, overlimits 0 requeues 213419) 
 backlog 0b 0p requeues 213419 
  maxpacket 1514 drop_overlimit 0 new_flow_count 1771734 ecn_mark 2325
  new_flows_len 0 old_flows_len 0
qdisc fq_codel 8040: parent 1:4 limit 1024p flows 1024 quantum 1514 target 30.0ms interval 300.0ms 
 Sent 154206340 bytes 609486 pkt (dropped 66, overlimits 0 requeues 279) 
 backlog 0b 0p requeues 279 
  maxpacket 1514 drop_overlimit 0 new_flow_count 255 ecn_mark 0
  new_flows_len 0 old_flows_len 0
</pre>

So, like, I wipe out that qdisc... and try exercising the CS1 or CS5 (BK or VI) queues to no effect

<pre>

d@ida:~/public_html$ netperf -Y CS1,CS1 -H 172.21.18.1 -t TCP_MAERTS
MIGRATED TCP MAERTS TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 172.21.18.1 () port 0 AF_INET : demo
Recv   Send    Send                          
Socket Socket  Message  Elapsed              
Size   Size    Size     Time     Throughput  
bytes  bytes   bytes    secs.    10^6bits/sec  

 87380  16384  16384    10.00       0.00   
d@ida:~/public_html$ netperf -Y CS5,CS5 -H 172.21.18.1 -t TCP_MAERTS
MIGRATED TCP MAERTS TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 172.21.18.1 () port 0 AF_INET : demo
Recv   Send    Send                          
Socket Socket  Message  Elapsed              
Size   Size    Size     Time     Throughput  
bytes  bytes   bytes    secs.    10^6bits/sec  

 87380  16384  16384    10.00       0.00   

root@OpenWrt:/sys/kernel/debug/ieee80211/phy1/ath9k# tc -s qdisc show dev wlan1
qdisc mq 1: root 
 Sent 33368 bytes 183 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc sfq 8041: parent 1:1 limit 127p quantum 1514b depth 127 divisor 1024 
 Sent 145 bytes 1 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc sfq 8042: parent 1:2 limit 127p quantum 1514b depth 127 divisor 1024 
 Sent 0 bytes 0 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc sfq 8043: parent 1:3 limit 127p quantum 1514b depth 127 divisor 1024 
 Sent 33223 bytes 182 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc sfq 8044: parent 1:4 limit 127p quantum 1514b depth 127 divisor 1024 
 Sent 0 bytes 0 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 

</pre>



"
442,Dave Täht,2014-05-14 10:56:37.166972,"<pre>

d@ida:~/public_html$ netperf -Y BE,BE -H 172.21.18.1 -t TCP_MAERTS
MIGRATED TCP MAERTS TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 172.21.18.1 () port 0 AF_INET : demo
Recv   Send    Send                          
Socket Socket  Message  Elapsed              
Size   Size    Size     Time     Throughput  
bytes  bytes   bytes    secs.    10^6bits/sec  

 87380  16384  16384    10.00      55.96  

d@ida:~/public_html$ netperf -Y CS1,CS1 -H 172.21.18.1 -t TCP_MAERTS
MIGRATED TCP MAERTS TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 172.21.18.1 () port 0 AF_INET : demo
Recv   Send    Send                          
Socket Socket  Message  Elapsed              
Size   Size    Size     Time     Throughput  
bytes  bytes   bytes    secs.    10^6bits/sec  

 87380  16384  16384    10.00       0.00   

root@OpenWrt:/sys/kernel/debug/ieee80211/phy1/ath9k# tc -s qdisc show dev wlan1
qdisc mq 1: root 
 Sent 73651767 bytes 48745 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
qdisc fq_codel 8046: parent 1:1 limit 1024p flows 1024 quantum 1514 target 30.0ms interval 300.0ms 
 Sent 0 bytes 0 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
  maxpacket 256 drop_overlimit 0 new_flow_count 0 ecn_mark 0
  new_flows_len 0 old_flows_len 0
qdisc fq_codel 8047: parent 1:2 limit 1024p flows 1024 quantum 1514 target 30.0ms interval 300.0ms ecn 
 Sent 0 bytes 0 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
  maxpacket 256 drop_overlimit 0 new_flow_count 0 ecn_mark 0
  new_flows_len 0 old_flows_len 0
qdisc fq_codel 8048: parent 1:3 limit 1024p flows 1024 quantum 1514 target 30.0ms interval 300.0ms ecn 
 Sent 73651767 bytes 48745 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
  maxpacket 256 drop_overlimit 0 new_flow_count 0 ecn_mark 0
  new_flows_len 0 old_flows_len 0
qdisc fq_codel 8049: parent 1:4 limit 1024p flows 1024 quantum 1514 target 30.0ms interval 300.0ms 
 Sent 0 bytes 0 pkt (dropped 0, overlimits 0 requeues 0) 
 backlog 0b 0p requeues 0 
  maxpacket 256 drop_overlimit 0 new_flow_count 0 ecn_mark 0
  new_flows_len 0 old_flows_len 0

</pre>

doing some captures now"
442,Dave Täht,2014-05-14 11:03:14.073892,"ok, so we get to the 10th netperf packet, which is a syn attempt, marked dscp 0x022 (or 0x08 if you prefer to shift it right). It is transmitted to my local (laptop) driver successfully. But it does not arrive at the destination. It tries to retransmit that syn a couple times and fails to get through. 

Now, syn attempts marked this way usually work (and I can get the same behavior with udp) The checksum appears correct, as well. And here I have a case where it's my client blowing up, not necessarily the router. So I'm going to reboot the client....

Anyway the netperf transaction fails at the 27th packet in the local2 capture, and is not received. "
440,Dave Täht,2014-05-14 11:30:55.275421,"I note that in-place updates to a new version do not update the opkg.conf repository. You need to do that by hand.
"
438,Dave Täht,2014-05-14 11:31:47.712453,"This nightmare had multiple aspects and is, I think, fully resolved."
436,Dave Täht,2014-05-14 11:34:33.984373,PArt of bug #438
418,Dave Täht,2014-05-14 11:35:21.914053,""
412,Dave Täht,2014-05-14 11:36:30.547028,added dansguardian as a optional package ages ago.
402,Dave Täht,2014-05-14 11:38:15.474912,1000 packets is enough at most speeds. 
442,Dave Täht,2014-05-14 12:00:11.151168,"ok, a reboot of this client (ubuntu 3.11.0-19-generic) clears this problem. That doesn't mean a lot...

I will add another client with a different chipset to try to blow that up from that. I am resuming beating the archer up, this time with both ipv4 and ipv6, from this client.

03:00.0 Network controller: Intel Corporation PRO/Wireless 5100 AGN [Shiloh] Network Connection

I am chasing possibly 3 separate bugs here.
"
442,Dave Täht,2014-05-14 12:34:04.375463,"I got it to re-occur in 20 minutes this time. Associating and disassociating from the iwl cleared it.

booting up a couple more boxes now..."
443,Dave Täht,2014-05-29 15:55:07.154504,"the 56a address should have vanished days (weeks!) ago. The leases file is attached. As noted my packet captures show no 56a being requests OR renewed...

cat /tmp/dhclient-script.debug

Thu May 29 14:59:45 PDT 2014: entering /sbin, dumping variables.
reason='RENEW6'
interface='eth0'
new_ip6_address='2601:9:6680:56a::3ce'
new_ip6_prefixlen='64'
new_dhcp6_domain_search='home.lan.'
new_dhcp6_name_servers='2601:9:6680:4aa::1'
old_ip6_address='2601:9:6680:56a::3ce'
old_ip6_prefixlen='64'
old_dhcp6_domain_search='home.lan.'
old_dhcp6_name_servers='2601:9:6680:4aa::1'
--------------------------
Thu May 29 14:59:45 PDT 2014: entering /sbin, dumping variables.
reason='RENEW6'
interface='eth0'
new_ip6_address='2601:9:6680:4aa::3ce'
new_ip6_prefixlen='64'
new_dhcp6_domain_search='home.lan.'
new_dhcp6_name_servers='2601:9:6680:4aa::1'
old_ip6_address='2601:9:6680:4aa::3ce'
old_ip6_prefixlen='64'
old_dhcp6_domain_search='home.lan.'
old_dhcp6_name_servers='2601:9:6680:4aa::1'
--------------------------
Thu May 29 15:00:31 PDT 2014: entering /sbin, dumping variables.
reason='RELEASE'
interface='eth0'
old_ip_address='172.26.4.20'
old_host_name='nuc'
old_network_number='172.26.4.0'
old_subnet_mask='255.255.255.224'
old_broadcast_address='172.26.4.31'
old_routers='172.26.4.1'
old_domain_name='home.lan'
old_domain_name_servers='172.26.4.1'
old_netbios_name_servers='172.26.4.1'
old_ntp_servers='172.26.4.1'
--------------------------
Thu May 29 15:00:31 PDT 2014: entering /sbin, dumping variables.
reason='RELEASE'
interface='eth0'
old_ip_address='172.26.4.20'
old_host_name='nuc'
old_network_number='172.26.4.0'
old_subnet_mask='255.255.255.224'
old_broadcast_address='172.26.4.31'
old_routers='172.26.4.1'
old_domain_name='home.lan'
old_domain_name_servers='172.26.4.1'
old_netbios_name_servers='172.26.4.1'
old_ntp_servers='172.26.4.1'
--------------------------
Thu May 29 15:00:31 PDT 2014: entering /sbin, dumping variables.
reason='RELEASE6'
interface='eth0'
old_ip6_address='2601:9:6680:56a::3ce'
old_ip6_prefixlen='64'
old_dhcp6_domain_search='home.lan.'
old_dhcp6_name_servers='2601:9:6680:4aa::1'
--------------------------
Thu May 29 15:00:32 PDT 2014: entering /sbin, dumping variables.
reason='RELEASE6'
interface='eth0'
old_ip6_address='2601:9:6680:56a::3ce'
old_ip6_prefixlen='64'
old_dhcp6_domain_search='home.lan.'
old_dhcp6_name_servers='2601:9:6680:4aa::1'
--------------------------
Thu May 29 15:00:32 PDT 2014: entering /sbin, dumping variables.
reason='RELEASE6'
interface='eth0'
old_ip6_address='2601:9:6680:4aa::3ce'
old_ip6_prefixlen='64'
old_dhcp6_domain_search='home.lan.'
old_dhcp6_name_servers='2601:9:6680:4aa::1'
--------------------------
Thu May 29 15:00:32 PDT 2014: entering /sbin, dumping variables.
reason='RELEASE6'
interface='eth0'
old_ip6_address='2601:9:6680:4aa::3ce'
old_ip6_prefixlen='64'
old_dhcp6_domain_search='home.lan.'
old_dhcp6_name_servers='2601:9:6680:4aa::1'
--------------------------
Thu May 29 15:01:47 PDT 2014: entering /sbin, dumping variables.
reason='PREINIT'
interface='eth0'
--------------------------
Thu May 29 15:01:47 PDT 2014: entering /sbin, dumping variables.
reason='PREINIT'
interface='eth0'
--------------------------
Thu May 29 15:01:53 PDT 2014: entering /sbin, dumping variables.
reason='BOUND'
interface='eth0'
new_ip_address='172.26.4.20'
new_host_name='nuc'
new_network_number='172.26.4.0'
new_subnet_mask='255.255.255.224'
new_broadcast_address='172.26.4.31'
new_routers='172.26.4.1'
new_domain_name='home.lan'
new_domain_name_servers='172.26.4.1'
new_netbios_name_servers='172.26.4.1'
new_ntp_servers='172.26.4.1'
old_ip_address='172.26.4.20'
old_host_name='nuc'
old_network_number='172.26.4.0'
old_subnet_mask='255.255.255.224'
old_broadcast_address='172.26.4.31'
old_routers='172.26.4.1'
old_domain_name='home.lan'
old_domain_name_servers='172.26.4.1'
old_netbios_name_servers='172.26.4.1'
old_ntp_servers='172.26.4.1'
--------------------------
Thu May 29 15:01:53 PDT 2014: entering /sbin, dumping variables.
reason='BOUND'
interface='eth0'
new_ip_address='172.26.4.20'
new_host_name='nuc'
new_network_number='172.26.4.0'
new_subnet_mask='255.255.255.224'
new_broadcast_address='172.26.4.31'
new_routers='172.26.4.1'
new_domain_name='home.lan'
new_domain_name_servers='172.26.4.1'
new_netbios_name_servers='172.26.4.1'
new_ntp_servers='172.26.4.1'
old_ip_address='172.26.4.20'
old_host_name='nuc'
old_network_number='172.26.4.0'
old_subnet_mask='255.255.255.224'
old_broadcast_address='172.26.4.31'
old_routers='172.26.4.1'
old_domain_name='home.lan'
old_domain_name_servers='172.26.4.1'
old_netbios_name_servers='172.26.4.1'
old_ntp_servers='172.26.4.1'
--------------------------
Thu May 29 15:01:53 PDT 2014: entering /sbin, dumping variables.
reason='PREINIT6'
interface='eth0'
--------------------------
Thu May 29 15:01:53 PDT 2014: entering /sbin, dumping variables.
reason='PREINIT6'
interface='eth0'
--------------------------
Thu May 29 15:01:55 PDT 2014: entering /sbin, dumping variables.
reason='BOUND6'
interface='eth0'
new_ip6_address='2601:9:6680:56a::3ce'
new_ip6_prefixlen='64'
new_dhcp6_domain_search='home.lan.'
new_dhcp6_name_servers='2601:9:6680:4aa::1'
old_ip6_address='2601:9:6680:56a::3ce'
old_ip6_prefixlen='64'
old_dhcp6_domain_search='home.lan.'
old_dhcp6_name_servers='2601:9:6680:4aa::1'
--------------------------
Thu May 29 15:01:55 PDT 2014: entering /sbin, dumping variables.
reason='BOUND6'
interface='eth0'
new_ip6_address='2601:9:6680:56a::3ce'
new_ip6_prefixlen='64'
new_dhcp6_domain_search='home.lan.'
new_dhcp6_name_servers='2601:9:6680:4aa::1'
old_ip6_address='2601:9:6680:56a::3ce'
old_ip6_prefixlen='64'
old_dhcp6_domain_search='home.lan.'
old_dhcp6_name_servers='2601:9:6680:4aa::1'
--------------------------
Thu May 29 15:01:55 PDT 2014: entering /sbin, dumping variables.
reason='BOUND6'
interface='eth0'
new_ip6_address='2601:9:6680:4aa::3ce'
new_ip6_prefixlen='64'
new_dhcp6_domain_search='home.lan.'
new_dhcp6_name_servers='2601:9:6680:4aa::1'
old_ip6_address='2601:9:6680:4aa::3ce'
old_ip6_prefixlen='64'
old_dhcp6_domain_search='home.lan.'
old_dhcp6_name_servers='2601:9:6680:4aa::1'
--------------------------
Thu May 29 15:01:55 PDT 2014: entering /sbin, dumping variables.
reason='BOUND6'
interface='eth0'
new_ip6_address='2601:9:6680:4aa::3ce'
new_ip6_prefixlen='64'
new_dhcp6_domain_search='home.lan.'
new_dhcp6_name_servers='2601:9:6680:4aa::1'
old_ip6_address='2601:9:6680:4aa::3ce'
old_ip6_prefixlen='64'
old_dhcp6_domain_search='home.lan.'
old_dhcp6_name_servers='2601:9:6680:4aa::1'
--------------------------
Thu May 29 15:01:55 PDT 2014: entering /sbin, dumping variables.
reason='DEPREF6'
interface='eth0'
cur_ip6_address='2601:9:6680:56a::3ce'
cur_ip6_prefixlen='64'
cur_dhcp6_domain_search='home.lan.'
cur_dhcp6_name_servers='2601:9:6680:4aa::1'
--------------------------
Thu May 29 15:01:55 PDT 2014: entering /sbin, dumping variables.
reason='DEPREF6'
interface='eth0'
cur_ip6_address='2601:9:6680:56a::3ce'
cur_ip6_prefixlen='64'
cur_dhcp6_domain_search='home.lan.'
cur_dhcp6_name_servers='2601:9:6680:4aa::1'
--------------------------
Thu May 29 15:01:55 PDT 2014: entering /sbin, dumping variables.
reason='EXPIRE6'
interface='eth0'
old_ip6_address='2601:9:6680:56a::3ce'
old_ip6_prefixlen='64'
old_dhcp6_domain_search='home.lan.'
old_dhcp6_name_servers='2601:9:6680:4aa::1'
--------------------------
Thu May 29 15:01:56 PDT 2014: entering /sbin, dumping variables.
reason='EXPIRE6'
interface='eth0'
old_ip6_address='2601:9:6680:56a::3ce'
old_ip6_prefixlen='64'
old_dhcp6_domain_search='home.lan.'
old_dhcp6_name_servers='2601:9:6680:4aa::1'
--------------------------
Thu May 29 15:31:55 PDT 2014: entering /sbin, dumping variables.
reason='RENEW6'
interface='eth0'
new_ip6_address='2601:9:6680:56a::3ce'
new_ip6_prefixlen='64'
new_dhcp6_domain_search='home.lan.'
new_dhcp6_name_servers='2601:9:6680:4aa::1'
old_ip6_address='2601:9:6680:56a::3ce'
old_ip6_prefixlen='64'
old_dhcp6_domain_search='home.lan.'
old_dhcp6_name_servers='2601:9:6680:4aa::1'
--------------------------
Thu May 29 15:31:55 PDT 2014: entering /sbin, dumping variables.
reason='RENEW6'
interface='eth0'
new_ip6_address='2601:9:6680:56a::3ce'
new_ip6_prefixlen='64'
new_dhcp6_domain_search='home.lan.'
new_dhcp6_name_servers='2601:9:6680:4aa::1'
old_ip6_address='2601:9:6680:56a::3ce'
old_ip6_prefixlen='64'
old_dhcp6_domain_search='home.lan.'
old_dhcp6_name_servers='2601:9:6680:4aa::1'
--------------------------
Thu May 29 15:31:55 PDT 2014: entering /sbin, dumping variables.
reason='RENEW6'
interface='eth0'
new_ip6_address='2601:9:6680:4aa::3ce'
new_ip6_prefixlen='64'
new_dhcp6_domain_search='home.lan.'
new_dhcp6_name_servers='2601:9:6680:4aa::1'
old_ip6_address='2601:9:6680:4aa::3ce'
old_ip6_prefixlen='64'
old_dhcp6_domain_search='home.lan.'
old_dhcp6_name_servers='2601:9:6680:4aa::1'
--------------------------
Thu May 29 15:31:55 PDT 2014: entering /sbin, dumping variables.
reason='RENEW6'
interface='eth0'
new_ip6_address='2601:9:6680:4aa::3ce'
new_ip6_prefixlen='64'
new_dhcp6_domain_search='home.lan.'
new_dhcp6_name_servers='2601:9:6680:4aa::1'
old_ip6_address='2601:9:6680:4aa::3ce'
old_ip6_prefixlen='64'
old_dhcp6_domain_search='home.lan.'
old_dhcp6_name_servers='2601:9:6680:4aa::1'
--------------------------"
442,David Taht,2014-06-05 09:30:50.243529,"turning off crypto doesn't help


---------- Forwarded message ----------
From: Jim Gettys <jg@freedesktop.org>
Date: Thu, Jun 5, 2014 at 9:19 AM
Subject: turning off crypto didn't help.
To: Dave Taht <dave.taht@gmail.com>


The 2.4 ghz interface hung again last night....

- Jim"
444,Dave Täht,2014-06-24 19:49:33.622057,"yes you need a /61 or better from your isp. (cero requests a /60 by default)

Failing that you can bridge your wifi to the ethernet which is what openwrt basically does, or use nd proxying, or use ipv6 dhcp throughout to say, use /67s instead of /64s (which will disable SLAAC). "
392,Dave Täht,2014-06-24 19:56:56.067335,""
387,Dave Täht,2014-06-24 19:57:31.613469,""
374,Dave Täht,2014-06-24 19:59:46.543429,
378,Dave Täht,2014-06-24 19:59:47.316474,
376,Dave Täht,2014-06-24 19:59:47.816212,
377,Dave Täht,2014-06-24 19:59:48.904637,
379,Dave Täht,2014-06-24 19:59:49.737674,
380,Dave Täht,2014-06-24 19:59:50.862932,
384,Dave Täht,2014-06-24 19:59:51.554316,
388,Dave Täht,2014-06-24 19:59:52.675968,
225,Dave Täht,2014-06-24 20:01:47.822101,
271,Dave Täht,2014-06-24 20:01:48.692089,
86,Dave Täht,2014-06-24 20:03:21.634571,
89,Dave Täht,2014-06-24 20:03:22.500435,
90,Dave Täht,2014-06-24 20:03:23.440664,
98,Dave Täht,2014-06-24 20:03:24.054563,
99,Dave Täht,2014-06-24 20:03:24.928284,
110,Dave Täht,2014-06-24 20:03:25.624681,
112,Dave Täht,2014-06-24 20:03:26.527705,
123,Dave Täht,2014-06-24 20:03:27.36749,
124,Dave Täht,2014-06-24 20:03:29.080908,
125,Dave Täht,2014-06-24 20:03:30.624105,
168,Dave Täht,2014-06-24 20:03:31.913808,
442,Dave Täht,2014-06-28 14:22:13.62182,"after continously beating on the thing for days, I saw this go by in the dmesg.

[210237.781250] ------------[ cut here ]------------
[210237.789062] WARNING: at /build/cero2/src/cerowrt-3.10/build_dir/target-mips_34kc_uClibc-0.9.33.2/linux-ar71xx_generic/compat-wireless-2014-05-22/net/mac80211/rx.c:3372 ieee80211_rx+0x13c/0x7f8 [mac80211]()
[210237.804687] Rate marked as an HT rate but passed status->rate_idx is not an MCS index [0-76]: 92 (0x5c)
[210237.816406] Modules linked in: ath9k ath9k_htc ath9k_common iptable_nat ath9k_hw ath pppoe nf_nat_ipv4 nf_conntrack_ipv4 mac80211 cfg80211 xt_u32 xt_time xt_tcpudp xt_tcpmss xt_string xt_statistic xt_state xt_recent xt_quota xt_pkttype xt_physdev xt_owner xt_nat xt_multiport xt_mark xt_mac xt_limit xt_length xt_hl xt_helper xt_hashlimit xt_ecn xt_dscp xt_conntrack xt_connmark xt_connlimit xt_connbytes xt_comment xt_addrtype xt_TCPMSS xt_REDIRECT xt_LOG xt_IPMARK xt_HL xt_DSCP xt_CT xt_CLASSIFY usbnet ts_kmp ts_fsm ts_bm pptp pppox ppp_async nf_nat_irc nf_nat_ftp nf_defrag_ipv4 nf_conntrack_netlink nf_conntrack_irc nf_conntrack_ftp iptable_raw iptable_mangle iptable_filter ipt_REJECT ipt_MASQUERADE ipt_ECN ip_tables crc_ccitt compat_xtables compat sch_teql sch_tbf sch_sfq sch_red sch_qfq sch_prio sch_pie sch_ns2_codel sch_nfq_codel sch_netem sch_htb sch_gred sch_efq_codel sch_dsmark sch_codel em_text em_nbyte em_meta em_cmp cls_basic act_police act_ipt act_skbedit act_mirred em_u32 cls_u32 cls_tcindex cls_flow cls_route cls_fw sch_hfsc sch_ingress leds_wndr3700_usb ledtrig_usbdev xt_set ip_set_list_set ip_set_hash_netport ip_set_hash_netiface ip_set_hash_net ip_set_hash_ipportnet ip_set_hash_ipportip ip_set_hash_ipport ip_set_hash_ip ip_set_bitmap_port ip_set_bitmap_ipmac ip_set_bitmap_ip ip_set nfnetlink sr_mod cdrom ip6t_NPT ip6t_MASQUERADE ip6table_nat nf_nat_ipv6 nf_nat ip6t_REJECT ip6table_raw ip6table_mangle ip6table_filter ip6_tables x_tables nf_conntrack_ipv6 nf_conntrack nf_defrag_ipv6 pppoatm ppp_generic slhc ip_gre gre ifb nat46 sit ipip ip6_tunnel tunnel6 tunnel4 ip_tunnel tun vfat fat autofs4 br2684 atm nls_iso8859_2 nls_iso8859_15 nls_iso8859_13 nls_iso8859_1 nls_cp437 ipv6 authenc aead arc4 crypto_blkcipher usb_storage ohci_hcd ehci_platform ehci_hcd sd_mod scsi_mod gpio_button_hotplug ext4 crc16 jbd2 mbcache usbcore nls_base usb_common crypto_hash
[210237.980468] CPU: 0 PID: 3 Comm: ksoftirqd/0 Not tainted 3.10.44 #1
[210237.988281] Stack : 00000000 00000000 00000000 00000000 803a2eba 00000036 87828a58 86a1dd70
[210237.988281] 	  802f19d8 803437bb 00000003 803a2664 87828a58 86a1dd70 00000065 85c96618
[210237.988281] 	  803c0000 80079704 00000003 80077184 868cb40c 86a1dd70 802f32ac 87841c64
[210237.988281] 	  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
[210237.988281] 	  00000000 00000000 00000000 00000000 00000000 00000000 00000000 87841bf0
[210237.988281] 	  ...
[210238.023437] Call Trace:
[210238.027343] [<8006e52c>] show_stack+0x48/0x70
[210238.031250] [<80077280>] warn_slowpath_common+0x78/0xa8
[210238.035156] [<800772dc>] warn_slowpath_fmt+0x2c/0x38
[210238.042968] [<8689f278>] ieee80211_rx+0x13c/0x7f8 [mac80211]
[210238.046875] [<86966410>] ath_rx_tasklet+0x96c/0x9b8 [ath9k]
[210238.050781] [<86963cd0>] ath9k_tasklet+0x1ac/0x230 [ath9k]
[210238.058593] [<8007ea04>] tasklet_action+0x84/0xcc
[210238.062500] [<8007e200>] __do_softirq+0xd0/0x1bc
[210238.066406] [<8007e318>] run_ksoftirqd+0x2c/0x58
[210238.074218] [<8009a7c4>] smpboot_thread_fn+0x134/0x164
[210238.078125] [<800938a8>] kthread+0xb0/0xb8
[210238.082031] [<80060878>] ret_from_kernel_thread+0x14/0x1c
[210238.085937] 
[210238.089843] ---[ end trace 57a62c568dfcbfb7 ]---
root@davedesk:~# 
"
442,David Taht,2014-07-06 11:02:51.332727,"---------- Forwarded message ----------
From: ""Philip"" 
Date: Jul 6, 2014 10:18 AM
Subject: BufferBloat Bug 442
To: davetaht
Cc:

Hello

I am a general user running the netgear router with cerowrt. I have the
latest build version of 3.10.44-6/
<http://snapon.lab.bufferbloat.net/%7Ecero2/cerowrt/wndr/3.10.44-6/>. The
wifi drops sometimes during the day and I have to manually turn of the
router and turn it on. I noticed when I do heavy video streaming the wifi
will crash. Is their a stable version that I can downgrade to. Please let
me know

thanks"
442,Felix Fietkau,2014-07-23 08:50:56.47819,"Hey,

with a lot of debugging help from Antonio Quartulli, I believe I finally
found and fixed the cause of this bug.
When aggregation sessions are set up and torn down frequently, the
driver queue can end up with frames marked for A-MPDU while an
aggregation session is not active (and often cannot be established anymore).
I committed the fix to it in r41815 (also sent to linux-wireless@).
Please test.

- Felix"
442,David Taht,2014-07-23 22:48:45.384526,"So far as I have heard the latest build IS more stable than anything
prior under conditions of low signal strength os OSX. (how's everyone
doing this week?)

I had long suspected we were actually seeing several bugs masquerading as one.

new hope:

https://dev.openwrt.org/changeset/41815"
442,Sebastian Moeller,2014-07-24 05:07:25.468675,"Hi Dave,


On Jul 24, 2014, at 07:48 , Dave Taht <dave.taht@gmail.com> wrote:

> So far as I have heard the latest build IS more stable than anything
> prior under conditions of low signal strength os OSX. (how's everyone
> doing this week?)

	Still all fine (but uptime is 5 days, the last time I needed ~20 days for the queue to get stuck). Also I note that for me the problem typically develops on the 2.4GHz radio, which only hosts am old nexus7 and two nexus 4 (nexi?). The macbook and macbook pro on the 5GHz radio seems rather stable. I guess what I want to say is that the macs might be good in flushing out this issue, but it is not a mac only issue ;) I only tested under IPv4, but this seems to work well already...

> 
> I had long suspected we were actually seeing several bugs masquerading as one.
> 
> new hope:
> 
> https://dev.openwrt.org/changeset/41815

	So, I will wait for a fortnight of uptime, before switching to a potential newer cerowrt version, just to see whether I can break 3.10.48-2…

Best Regards
	Sebastian

>"
445,David Taht,2014-07-30 13:46:27.639508,"I usually kill off the firewall rules for an internal router almost
completely. Recently, I didn't do that, and didn't have the external
interface connected, so  a new cerowrt-3.10.50-1 install automagically
meshed with another router over wifi.

...and didn't run the default firewall rules at all.

I first noticed that /etc/firewall.user wasn't run (which is the lousy
place I'm using to export the /24 local network via babel), so I didn't
have connectivity to the next hop mesh... and then I
checked to see there were no iptables rules in place at all. So, some

trigger for running the firewall ""fw3 load"" doesn't run unless there is an
external ethernet interface up in cerowrt.

And arguably it should run pretty early. So somewhere there is a missing
trigger?? to load the fw...

(and I hope this is a cerowrt specific bug and it did use to work)

... and I'd really rather run this out of /etc/config/network somehow

ip route add unreachable my.subnet.add.ress/24"
442,David Taht,2014-08-16 11:23:42.578941,"I am told that several sites that had severe problems with wifi
hanging have now been up,
for over 2 weeks, without problems, with the 3.10.50-1 release of cerowrt.

How is everyone else doing?

Are we allowed to feel joy and relief at finally having a reasonably
stable release yet?"
442,Sebastian Moeller,2014-08-16 15:32:46.986716,"Hi R.

what is the output of:
cat sys/kernel/debug/ieee80211/phy0/ath9k/queues

and 
cat sys/kernel/debug/ieee80211/phy1/ath9k/queues

when it gets stuck? I wonder whether you see the actual same bug as #442 or some other bug. (I think the current theory is that a number of bugs contributed to the symptoms we described as #442 and now we have to tease them apart one by one).

Best Regards
	Sebastian



On Aug 16, 2014, at 21:07 , R. <redag2@gmail.com> wrote:

> Had to move my client devices from WPA2 to open AP, as I was getting daily failures. I did not experience the stability that you talk of. :(
> 
> Manually rebooting at least once a week also happens as dhcp server fails.
> 
> On Aug 16, 2014 2:55 PM, ""Daniel Ezell"" <dezell@stonescry.com> wrote:
> No drops here since installing. Looks great to me. 
> Daniel
> 
> On Aug 16, 2014 11:23 AM, ""Dave Taht"" <dave.taht@gmail.com> wrote:
> I am told that several sites that had severe problems with wifi
> hanging have now been up,
> for over 2 weeks, without problems, with the 3.10.50-1 release of cerowrt.
> 
> How is everyone else doing?
> 
> Are we allowed to feel joy and relief at finally having a reasonably
> stable release yet?
>"
442,Rich Brown,2014-08-16 20:09:35.137216,"> I will try to keep an eye and report back. You know what would be
> really useful? A breakdown of all the useful logs that one would need
> to provide when reporting on a bug.
> 
> Even more user-friendly would be a script that generates all relevant
> information/logs to debugging. Perhaps one day? :)

Check the cerostats.sh script that's in /usr/lib/CeroWrtScripts for recent CeroWrt builds. That collects a number of interesting stats and puts them in /tmp/cerostats_output.txt

Rich"
442,guozheng qian,2014-08-21 06:07:10.268719,"Dear Filex, I am using your patch at https://dev.openwrt.org/changeset/41815, merge to openwrt svn reversion 41808, and test the wireless performance, still found the dmesg like below, does these message interfere with the stability of the firmware, btw, I am using TP-Link tl-wr841n-v8 hardware.

root@YSWiFi:/# [  437.230000] ath: phy0: Failed to stop TX DMA, queues=0x005!
[  489.680000] ath: phy0: Failed to stop TX DMA, queues=0x005!
[  495.910000] ath: phy0: Failed to stop TX DMA, queues=0x005!
[  515.950000] ath: phy0: Failed to stop TX DMA, queues=0x005!
[  529.190000] ath: phy0: Failed to stop TX DMA, queues=0x005!
[  530.000000] ath: phy0: Failed to stop TX DMA, queues=0x004!
[  639.230000] ath: phy0: Failed to stop TX DMA, queues=0x004!
[  828.800000] ath: phy0: Failed to stop TX DMA, queues=0x005!
[  849.440000] ath: phy0: Failed to stop TX DMA, queues=0x005!
[  856.640000] ath: phy0: Failed to stop TX DMA, queues=0x004!
"
448,David Taht,2014-09-12 13:17:23.679096,"Actually, pimd is mostly for ipv4 multicast.

I am not seeing any problems here, but my own network is mostly
running mildly older cero code."
442,Jim Gettys,2014-10-07 09:57:39.179142,"ah, at last....  Ding, dong, the witch is dead!
"
449,Ethan Blanton,2015-03-08 08:46:41.21912,"I suspect, but do not know, that the problem is domains that declare an IPv6 nameserver.  This seems to have a high correlation with problematic domains."
449,Dave Täht,2015-06-16 09:57:05.2067,"dnssec in this version of cerowrt should be disabled. Too many edge cases found.

No update planned to 2.73, which solved most of them."
449,Ethan Blanton,2015-06-16 17:25:51.370201,Great!  How do I disable dnssec?
